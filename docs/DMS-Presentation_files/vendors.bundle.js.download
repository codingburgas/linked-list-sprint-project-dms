(window.webpackJsonpSscore=window.webpackJsonpSscore||[]).push([[0],Array(45).concat([function(e,t,n){"use strict";n.d(t,"s",(function(){return i})),n.d(t,"D",(function(){return r})),n.d(t,"m",(function(){return s})),n.d(t,"q",(function(){return a})),n.d(t,"H",(function(){return o})),n.d(t,"w",(function(){return l})),n.d(t,"e",(function(){return c})),n.d(t,"t",(function(){return d})),n.d(t,"z",(function(){return h})),n.d(t,"x",(function(){return u})),n.d(t,"U",(function(){return f})),n.d(t,"G",(function(){return m})),n.d(t,"o",(function(){return p})),n.d(t,"a",(function(){return g})),n.d(t,"I",(function(){return _})),n.d(t,"Q",(function(){return v})),n.d(t,"F",(function(){return E})),n.d(t,"n",(function(){return T})),n.d(t,"j",(function(){return S})),n.d(t,"db",(function(){return A})),n.d(t,"O",(function(){return b})),n.d(t,"T",(function(){return I})),n.d(t,"C",(function(){return R})),n.d(t,"B",(function(){return C})),n.d(t,"u",(function(){return y})),n.d(t,"cb",(function(){return M})),n.d(t,"Z",(function(){return O})),n.d(t,"l",(function(){return x})),n.d(t,"h",(function(){return D})),n.d(t,"M",(function(){return P})),n.d(t,"g",(function(){return L})),n.d(t,"f",(function(){return N})),n.d(t,"r",(function(){return F})),n.d(t,"S",(function(){return w})),n.d(t,"ab",(function(){return U})),n.d(t,"P",(function(){return B})),n.d(t,"L",(function(){return k})),n.d(t,"R",(function(){return V})),n.d(t,"E",(function(){return G})),n.d(t,"b",(function(){return H})),n.d(t,"J",(function(){return W})),n.d(t,"i",(function(){return X})),n.d(t,"A",(function(){return j})),n.d(t,"V",(function(){return z})),n.d(t,"c",(function(){return K})),n.d(t,"Y",(function(){return Y})),n.d(t,"p",(function(){return q})),n.d(t,"y",(function(){return Q})),n.d(t,"v",(function(){return Z})),n.d(t,"k",(function(){return $})),n.d(t,"K",(function(){return J})),n.d(t,"d",(function(){return ee})),n.d(t,"X",(function(){return te})),n.d(t,"N",(function(){return ne})),n.d(t,"W",(function(){return ie})),n.d(t,"bb",(function(){return re}));var i="initialize",r="name",s="getNotifyMgr",a="identifier",o="push",l="isInitialized",c="config",d="instrumentationKey",h="logger",u="length",f="time",m="processNext",p="getProcessTelContext",g="addNotificationListener",_="removeNotificationListener",v="stopPollingInternalLogs",E="onComplete",T="getPlugin",S="flush",A="_extensions",b="splice",I="teardown",R="messageId",C="message",y="isAsync",M="_doTeardown",O="update",x="getNext",D="diagLog",P="setNextPlugin",L="createNew",N="cookieCfg",F="indexOf",w="substring",U="userAgent",B="split",k="setEnabled",V="substr",G="nodeType",H="apply",W="replace",X="enableDebugExceptions",j="logInternalMessage",z="toLowerCase",K="call",Y="type",q="handler",Q="listeners",Z="isChildEvt",$="getCtx",J="setCtx",ee="complete",te="traceId",ne="spanId",ie="traceFlags",re="version"},,,,,,,,function(e,t,n){"use strict";n.d(t,"h",(function(){return i})),n.d(t,"j",(function(){return r})),n.d(t,"l",(function(){return s})),n.d(t,"k",(function(){return a})),n.d(t,"i",(function(){return o})),n.d(t,"g",(function(){return l})),n.d(t,"b",(function(){return c})),n.d(t,"f",(function(){return d})),n.d(t,"a",(function(){return h})),n.d(t,"c",(function(){return u})),n.d(t,"d",(function(){return f})),n.d(t,"e",(function(){return m}));var i="function",r="object",s="undefined",a="prototype",o="hasOwnProperty",l="default",c=Object,d=c[a],h=c.assign,u=c.create,f=c.defineProperty,m=d[o]},,,,,,function(e,t,n){"use strict";function i(e,t,n){return o(e,1,t,n)}function r(e,t,n){return o(e,2,t,n)}function s(e,t,n){return o(e,3,t,n)}function a(e,t,n){return o(e,0,t,n)}function o(e,t,n,i){return{name:e,dataType:t,value:n,classification:i||4}}n.d(t,"a",(function(){return i})),n.d(t,"c",(function(){return r})),n.d(t,"b",(function(){return s})),n.d(t,"d",(function(){return a}))},,,,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return s})),n.d(t,"d",(function(){return a}));const i="Office.System.PrivacyConcern",r="cd836626611c4caaa8fc5b2e728ee81d-3b6d6c45-6377-4bf5-9792-dbf8e1881088-7521";function s(){return"undefined"==typeof performance||void 0===performance.now?0:performance.now()}function a(e){if(null!==e)return e}},,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"f",(function(){return l})),n.d(t,"d",(function(){return c})),n.d(t,"a",(function(){return d})),n.d(t,"e",(function(){return h})),n.d(t,"p",(function(){return u})),n.d(t,"i",(function(){return f})),n.d(t,"k",(function(){return m})),n.d(t,"j",(function(){return p})),n.d(t,"o",(function(){return g})),n.d(t,"m",(function(){return _})),n.d(t,"n",(function(){return v})),n.d(t,"q",(function(){return E})),n.d(t,"b",(function(){return T})),n.d(t,"r",(function(){return S})),n.d(t,"c",(function(){return A})),n.d(t,"s",(function(){return b})),n.d(t,"h",(function(){return I})),n.d(t,"t",(function(){return R})),n.d(t,"g",(function(){return C})),n.d(t,"l",(function(){return M}));let i,r,s=!1,a=[],o=0;function l(e,t,n,i,r,s,a){E({name:null,actionName:e,commandSurface:r,parentName:n,triggerMethod:i,durationMs:s,succeeded:t,dataFields:a})}function c(e,t=!0,n=0,i=[]){f({name:e,succeeded:t,durationMs:n,dataFields:i})}var d;function h(e,t,n=d.Count,i=!0,r=0,s=[],a=!1){if(null==e||""===e)return;let o=t;if(null==t){if(n!==d.Count)return;o=1}s.push({name:"WAC_Experiment",string:n.toString()}),s.push({name:"WAC_Experiment_Value",double:o}),s.push({name:"WAC_Experiment_EventName",string:"WAC_Exp_"+e+"_"+n.toString()}),s.push({name:"WAC_Experiment_AggregateOnlySucceeded",bool:a}),f({name:e,succeeded:i,durationMs:r,dataFields:s})}function u(e){y({kind:"event",event:e,timestamp:(new Date).getTime()})}function f(e){y({kind:"activity",event:e,timestamp:(new Date).getTime()})}function m(e){y({kind:"dnm",event:e,timestamp:(new Date).getTime()})}function p(e){y({kind:"cc",event:e,timestamp:(new Date).getTime()})}function g(e){y({kind:"otel",event:e})}function _(e){y({kind:"otelcc",event:e})}function v(e){y({kind:"oteldnm",event:e})}function E(e){y({kind:"action",event:e,timestamp:(new Date).getTime()})}function T(e,t){y({kind:"addNamespaceMapping",namespace:e,ariaTenantToken:t})}function S(e,t){y({kind:"setDNMToken",namespace:e,ariaTenantToken:t})}function A(){y({kind:"flush"})}function b(e){s=e,s||(a=[])}function I(e){r=e}function R(){return r&&r(),y({kind:"shutdown"}),a.length+o}function C(e){i=e,a.forEach(e=>y(e)),a=[]}function y(e){s&&(i?i(e):a.length<=2e4?a.push(e):o+=1)}function M(e){i&&i(e)}!function(e){e.Count="Count",e.Avg="Avg",e.Sum="Sum"}(d||(d={}))},function(e,t,n){"use strict";n.d(t,"e",(function(){return i})),n.d(t,"a",(function(){return r})),n.d(t,"d",(function(){return s})),n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return o})),n.d(t,"g",(function(){return l})),n.d(t,"f",(function(){return d}));var i,r,s,a,o,l,c=n(223);!function(e){e[e.Unspecified=0]="Unspecified",e[e.Sampled=1]="Sampled",e[e.Complete=2]="Complete"}(i||(i={})),function(e){e[e.None=0]="None",e[e.Always=1]="Always",e[e.OnSuccess=2]="OnSuccess"}(r||(r={})),function(e){e[e.Hourly=1]="Hourly",e[e.Daily=2]="Daily"}(s||(s={})),function(e){e[e.ReleaseAudienceGroup=1]="ReleaseAudienceGroup",e[e.WacRing=2]="WacRing",e[e.AppName=3]="AppName",e[e.AppPlatform=4]="AppPlatform",e[e.AppVersion=5]="AppVersion"}(a||(a={})),function(e){e[e.None=0]="None",e[e.MocaAddin=1]="MocaAddin"}(o||(o={})),function(e){e[e.Unspecified=0]="Unspecified",e[e.Boolean=1]="Boolean",e[e.String=2]="String",e[e.Int64=3]="Int64",e[e.Double=4]="Double",e[e.Date=5]="Date",e[e.Contract=6]="Contract"}(l||(l={}));const d=new c.a},,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return o}));var i,r=(i=[],{fireEvent:function(e){i.forEach((function(t){return t(e)}))},addListener:function(e){e&&i.push(e)}});function s(){return r}function a(e,t,n){r.fireEvent({level:e,category:t,message:n})}function o(e,t,n){a(0,e,(function(){var e=n instanceof Error?n.message:"";return"".concat(t,": ").concat(e)}))}},,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"e",(function(){return h})),n.d(t,"c",(function(){return u})),n.d(t,"b",(function(){return f})),n.d(t,"a",(function(){return m})),n.d(t,"g",(function(){return p})),n.d(t,"f",(function(){return g})),n.d(t,"d",(function(){return v})),n.d(t,"h",(function(){return E}));var i=n(79),r=n(137),s=n(133),a=n(59),o=n(9),l=n(3),c=n(7),d=n(65);function h(e){if(!e.name)throw new Error("Event is missing a name");const t=g(e.dataFields),n={eventName:e.name,dataFields:t,eventFlags:{}};return e.samplingPolicy===i.e.Sampled&&(n.eventFlags={samplingPolicy:r.a.SamplingPolicy.Measure}),n}function u(e){if(!e.name)throw new Error("Event is missing a name");const t=g(e.dataFields),n={eventName:e.name,dataFields:t,eventFlags:{},telemetryProperties:{dnmInterval:e.dnmInterval,dnmAllowedPartA:[]}};return e.dnmAllowedPartA&&e.dnmAllowedPartA.forEach(e=>{if(e){const t=e;t&&n.telemetryProperties.dnmAllowedPartA.push(t)}}),n}function f(e){if(!e.name)throw new Error("Event is missing a name");const t=g(e.dataFields),n={eventName:e.name,dataFields:t,eventFlags:{},telemetryProperties:{customerContentVersion:e.customerContentVersion,customerContentType:e.customerContentType}};return e.samplingPolicy===i.e.Sampled&&(n.eventFlags={samplingPolicy:r.a.SamplingPolicy.Measure}),n}function m(e){if(!e.name)throw new Error("Event is missing a name");null==e.succeeded&&(e.succeeded=void 0),(null==e.durationMs||isNaN(e.durationMs))&&(e.durationMs=0),(null==e.count||isNaN(e.count))&&(e.count=1),null==e.aggMode&&(e.aggMode=i.a.None);const t=Math.floor(1e3*e.durationMs),n=g(e.dataFields),r=s.a.getFields({cV:e.CV||void 0,duration:t,count:e.count,aggMode:e.aggMode,success:e.succeeded});return{eventName:e.name,eventContract:{name:s.a.contractName,dataFields:r},dataFields:n,eventFlags:{}}}function p(e){if(!e.name)throw new Error("Event is missing a name");null==e.succeeded&&(e.succeeded=void 0),(null==e.durationMs||isNaN(e.durationMs))&&(e.durationMs=0);const t=Math.floor(1e3*e.durationMs);null==e.dataFields&&(e.dataFields=[]);const n=g(e.dataFields),i=s.h.getFields({id:Object(d.d)(e.actionId),name:Object(d.d)(e.actionName),commandSurface:Object(d.d)(e.commandSurface),parentName:Object(d.d)(e.parentName),triggerMethod:Object(d.d)(e.triggerMethod),timeOffsetMs:Object(d.d)(e.timeOffsetMs)});n.push(...i);const r=s.a.getFields({duration:t,count:1,aggMode:0,success:e.succeeded});return{eventName:e.name,eventContract:{name:s.a.contractName,dataFields:r},dataFields:n,eventFlags:{}}}function g(e){const t=[];if(e)for(let n=0;n<e.length;n+=1)t.push(..._(e[n]));return t}function _(e,t){if(!e){const e=Error().stack;return o.a.sendTraceTag(508904220,l.a.msoulscat_Wac_Telemetry,c.a.Warning,`Data field is null, namespace: ${t}, stackTrace: ${e}`),[]}e.name||(e.name="DataFieldNameIsMissing");const n=function(e){return null!=e.string?i.g.String:null!=e.bool?i.g.Boolean:null==e.int64||isNaN(e.int64)?null==e.double||isNaN(e.double)?null!=e.contract?i.g.Contract:null==e.date||isNaN(e.date)?i.g.Unspecified:i.g.Date:i.g.Double:i.g.Int64}(e),r=t?t+"."+e.name:e.name;switch(n){case i.g.Unspecified:return[];case i.g.Boolean:return[a.a(r,e.bool)];case i.g.String:return[a.d(r,e.string)];case i.g.Int64:return[a.c(r,Math.floor(e.int64))];case i.g.Double:return[a.b(r,e.double)];case i.g.Date:return[a.d(r,new Date(e.date).toISOString())];case i.g.Contract:return function(e,t){const n=[];if(t.dataFields)for(let i=0;i<t.dataFields.length;i+=1)n.push(..._(t.dataFields[i],e));return n}(r,e.contract);default:throw new Error(n)}}function v(e){switch(e){case r.a.LogLevel.Verbose:return c.a.Verbose;case r.a.LogLevel.Info:return c.a.Info;case r.a.LogLevel.Warning:return c.a.Warning;case r.a.LogLevel.Error:return c.a.Error;default:throw new Error(e)}}function E(e){const t=e.otelEvent;if(!t||!t.dataFields)throw new Error("Invalid Otel event");if(e.additionalDataFields){const n=g(e.additionalDataFields);t.dataFields.push(...n)}return t}},,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"g",(function(){return d})),n.d(t,"h",(function(){return h})),n.d(t,"d",(function(){return l})),n.d(t,"b",(function(){return f})),n.d(t,"f",(function(){return m})),n.d(t,"c",(function(){return u})),n.d(t,"e",(function(){return _}));var i=n(59);function r(e,t){return e?e+"."+t:t}function s(e,t,n,s,a){void 0===a&&(a=4),s&&e.push(Object(i.d)("".concat(r(t,n)),s,a))}function a(e,t,n,s){"boolean"==typeof s&&e.push(Object(i.a)("".concat(r(t,n)),s))}function o(e,t,n,s){"number"==typeof s&&e.push(Object(i.c)("".concat(r(t,n)),s))}var l,c={contractName:"Office.System.Activity",getFields:function(e){var t=[];return s(t,"Activity","CV",e.cV),o(t,"Activity","Duration",e.duration),o(t,"Activity","Count",e.count),o(t,"Activity","AggMode",e.aggMode),a(t,"Activity","Success",e.success),e.result&&t.push.apply(t,function(e){var t=[];return o(t,"Activity.Result","Code",e.code),s(t,"Activity.Result","Type",e.type),o(t,"Activity.Result","Tag",e.tag),a(t,"Activity.Result","IsExpected",e.isExpected),t.push(Object(i.d)("zC.Activity.Result","Office.System.Result")),t}(e.result)),t.push(Object(i.d)("zC.Activity",this.contractName)),t}},d={getFields:function(e){var t=[];return s(t,"User","PrimaryIdentityHash",e.primaryIdentityHash),s(t,"User","PrimaryIdentitySpace",e.primaryIdentitySpace),s(t,"User","TenantId",e.tenantId,1),s(t,"User","TenantGroup",e.tenantGroup,1),a(t,"User","IsAnonymous",e.isAnonymous),a(t,"User","IsSignedIn",e.isSignedIn),t}},h={getFields:function(e){var t=[];return o(t,"UserAction","Id",e.id),s(t,"UserAction","Name",e.name),s(t,"UserAction","CommandSurface",e.commandSurface),s(t,"UserAction","ParentName",e.parentName),s(t,"UserAction","TriggerMethod",e.triggerMethod),o(t,"UserAction","TimeOffsetMs",e.timeOffsetMs),t}};!function(e){e.Web="Web",e.Desktop="Desktop",e.Universal="Universal",e.Mobile="Mobile",e.Win32="Win32",e.iOS="iOS",e.Android="Android"}(l||(l={}));var u,f={getFields:function(e){var t=[];return s(t,"App","Name",e.name,1),s(t,"App","Platform",e.platform,1),s(t,"App","Version",e.version,1),t}},m={getFields:function(e){var t=[];return s(t,"Session","Id",e.id,1),s(t,"Session","EcsETag",e.ecsETag,1),t}};!function(e){e.Automation="Automation",e.Dogfood="Dogfood",e.Microsoft="Microsoft",e.Insiders="Insiders",e.Production="Production"}(u||(u={}));var p,g,_={getFields:function(e){var t=[];return s(t,"Release","AudienceGroup",e.audienceGroup,1),t}};!function(e){var t,n,r,o;(o=e.FeatureActionType||(e.FeatureActionType={})).IsEnabled="IsEnabled",o.IsSeen="IsSeen",o.IsTried="IsTried",o.IsKept="IsKept",o.IsRejected="IsRejected",(r=e.Capability||(e.Capability={})).ContentGeneration="Content Generation",r.Commanding="Commanding",r.QAandSummaries="QA and Summaries",r.Collaboration="Collaboration",r.Suggestions="Suggestions",(n=e.EntryPoint||(e.EntryPoint={})).Chat="Chat",n.Canvas="Canvas",(t=e.Verb||(e.Verb={})).Create="Create",t.Command="Command",t.Ask="Ask",t.Summarize="Summarize",t.Share="Share",t.Analyze="Analyze",e.getFields=function(e){var t=[];return s(t,"Copilot","FeatureActionType",e.featureActionType),a(t,"Copilot","IsUserInitiated",e.isUserInitiated),s(t,"Copilot","FeatureName",e.featureName),s(t,"Copilot","SubFeatureName",e.subFeatureName),s(t,"Copilot","Capability",e.capability),a(t,"Copilot","IsThumbsUp",e.isThumbsUp),s(t,"Copilot","EntryPoint",e.entryPoint),s(t,"Copilot","Verb",e.verb),s(t,"Copilot","InteractionId",e.interactionId),s(t,"Copilot","ConversationId",e.conversationId),t.push(Object(i.d)("zC.".concat("Copilot"),"Office.System.Copilot")),t}}(p||(p={})),function(e){var t;(t=e.EventType||(e.EventType={})).Pillar="Pillar",t.Error="Error",e.getFields=function(e){var t=[];return s(t,"Asha","EventType",e.eventType),s(t,"Asha","Pillar",e.pillar),s(t,"Asha","Scenario",e.scenario),s(t,"Asha","Veto",e.veto),s(t,"Asha","Error",e.error),a(t,"Asha","InStaging",e.inStaging),a(t,"Asha","IsSessionEndingError",e.isSessionEndingError),a(t,"Asha","IsIntentional",e.isIntentional),a(t,"Asha","IsInternal",e.isInternal),t.push(Object(i.d)("zC.".concat("Asha"),"Office.System.Asha")),t}}(g||(g={}))},,,function(e,t,n){"use strict";n.d(t,"b",(function(){return j})),n.d(t,"c",(function(){return Z})),n.d(t,"e",(function(){return J})),n.d(t,"f",(function(){return ee})),n.d(t,"a",(function(){return ie})),n.d(t,"d",(function(){return re}));var i=n(107),r=n(92),s=n(276),a=n(137),o=n(59),l=function(e){return"number"==typeof e},c=function(){return Date.now()};"object"==typeof window&&"object"==typeof window.performance&&"function"==typeof window.performance.now&&(c=function(){return window.performance.now()});var d=n(38);function h(e){return"object"==typeof e}function u(e,t,n){for(var i="",r="",s=0,a=e;s<a.length;s++){var o=a[s],l=i+r+JSON.stringify(o);if(l.length>t)break;i=l,n.sp+=1,r="\n"}return i}function f(e,t,n,i){m(["Event","Source"],"OTelJS",0,e,t),m(["Event","Name"],n,0,e,t),m(["Event","Time"],i,"dt",e,t),m(["baseData","properties","version"],"OTelJSMin=4.19.5",0,e,t)}function m(e,t,n,i,r){var s,a=t,o=0;if(void 0!==a&&""!==a){switch(l(t)&&(o=6),n){case 3:o=6;break;case 2:o=4;break;case 4:o=8;break;case"dt":o=9;break;case 0:a="string"==typeof a?a.substr(0,25e3):a}if(r){for(var c=i.data,u=i.ext.metadata,f=0;f<e.length-1;){var m=e[f];if(!m)return;if(c[m]){if(!h(c))return}else c[m]={};if(c=c[m],o){var p=u.f||{};p[m]||(p[m]={}),u.f=p,u=p[m]}f++}var g=e[f];h(c)&&!h(c[g])&&(c[g]=a,o&&(u.f=Object(d.a)(Object(d.a)({},u.f),((s={})[g]={t:o},s))))}else{var _=e.join(".");i.data[_]=t,o&&(i.ext.metadata.f[_]={t:o})}}}function p(e,t,n,i){if(0!==e.length&&0!==t.length){var r=n+"?cors=true&w=2&content-type=application/x-json-stream&apikey="+t.join();i.useSendBeacon?function(e,t,n){var i=t.length;if(Boolean(null===navigator||void 0===navigator?void 0:navigator.sendBeacon)){var r=function(e,t){return navigator.sendBeacon(e,t)};if(r(e,u(t,65536,n)))n.ss=n.ss+n.sp;else{for(var s=0;s<i&&r(e,JSON.stringify(t[s]));)s++;n.ss+=s,n.sd=n.sp-s}}else n.sd+=i}(r,e,i.stats):function(e,t,n){var i=u(t,4194304,n),r=new XMLHttpRequest;r.onload=function(){var e=r.responseText;if(e){var t=JSON.parse(e);t.acc&&(n.ss+=parseInt(t.acc,10)),t.rej&&(n.sd+=parseInt(t.rej,10))}},r.onerror=function(){n.sd=n.sp},r.open("POST",e),r.send(i)}(r,e,i.stats)}}var g=function(){var e,t,n,i=[];function r(t,n,i){t&&t.forEach((function(t){var r=t.classification;if(4===r||1===r){var s=t.name.split(".");"zC"!==s[0]&&(n&&s.unshift("Data"),m(s,t.value,t.dataType,i,e))}}))}this.init=function(i,r){var s,a;e=!0===(null===(a=null===(s=r.extensionConfig)||void 0===s?void 0:s.PostChannel)||void 0===a?void 0:a.enableCompoundKey),t=r,n=i},this.enqueue=function(e){return 1===e.t&&(i.push(e),!0)},this.processQueue=function(){var s=[],a={},o=n.uuid(),l=n.stats.pw+1;i.forEach((function(n){var i=n.event.telemetryProperties.ariaTenantToken,c=function(n,i,s,a){var o=n.event,l=o.timestamp,c=(l?new Date(l):new Date).toISOString(),d=o.eventFlags.diagnosticLevel;if(t.enableOptionalEvents||10===d||110===d||120===d){var h=o.eventName,u={name:h,time:c,ver:"4.0",iKey:"o:"+i.substr(0,32),ext:{sdk:{seq:s},metadata:{f:{}}},data:{}};f(u,e,h,c),r(t.persistentDataFields,!1,u),m(["Event","Sequence"],s,2,u,e),m(["Event","Id"],a+"."+s,0,u,e);var p="custom",g=o.eventContract;if(g){var _=g.name;m(["Event","Contract"],_,0,u,e),p+="."+_.toLowerCase().replace(/\./g,"_"),r(g.dataFields,!1,u)}return u.data.baseType=p,r(o.dataFields,!0,u),u}}(n,i,l,o);c&&(s.push(c),a[i]=!0,l+=1)})),p(s,Object.keys(a),t.endpointUrl,n)}},_=!1;function v(e){E(1,e)}function E(e,t){Object(r.b)(e,1,(function(){return"WebSink:"+t}))}var T,S,A,b=function(){function e(e){var t;this.preprocessors=[],this.stats=((t={}).md=0,t.mm=0,t.mn=0,t.q=0,t.po={},t.pw=0,t.wa=0,t.wp=0,t.wd=0,t.wr={},t.ws=0,t.pm=0,t.sp=0,t.ss=0,t.sd=0,t.wh=0,t.pd={},t.d=0,t.b=0,t.s=0,t),this._batchInterval=1e3,this._initialQueueSize=500,this._batchSize=100,this._queue=[],this.enabled=!0,e&&e.queueSize&&(this._initialQueueSize=e.queueSize)}return e.prototype.init=function(e,t){return e.endpointUrl&&t.uuid&&t.getWorker?(e.uploadFrequency&&(this._batchInterval=e.uploadFrequency),e.batchSize&&(this._batchSize=e.batchSize),this._props=e,this._utils=t,!0):(this.enabled=!1,E(0,2),!1)},e.prototype.isInitialized=function(){if(this.enabled){if(this._props)return!0;v(1)}return!1},e.prototype.mergeStats=function(e){var t=this;Object.keys(e).forEach((function(n){l(t.stats[n])?l(e[n])?t.stats[n]+=e[n]:t.stats[n]=e[n]:"wr"===n?Object.keys(e.wr).forEach((function(n){t.stats.wr[n]=t.stats.wr[n]+e.wr||e.wr[n]})):"pd"===n&&Object.keys(e.pd).forEach((function(n){t.stats.pd[n]=t.stats.pd[n]||0+e.pd[n]}))}))},e.prototype.startWorker=function(){var e=this;if(this.isInitialized()){this.stats.s=1;try{this._worker=this._utils.getWorker(),this._worker.addEventListener("message",(function(t){var n=t.data;switch(n.t){case 1:e.handleLoadedMessage();break;case 4:e.mergeStats(n.d);break;case 5:v(n.d);break;default:v(14)}})),this._worker.addEventListener("error",(function(t){v(12),1===e.stats.s&&e.failToStartWorker()})),this._worker.addEventListener("errormessage",(function(e){v(13)}))}catch(e){v(10),this.failToStartWorker()}}},e.prototype.handleLoadedMessage=function(){if(this.isInitialized()){this.stats.s=2,Object(r.b)(2,1,(function(){return"WebSink:Loaded"}));var e={t:2,d:this._props};this._worker.postMessage(e),this.flushQueue()}},e.prototype.failToStartWorker=function(){this.stats.s=4,this.shutdown(!1)},e.prototype.flushQueue=function(){var e=c(),t=this.stats,n=this._queue.slice(0,this._batchSize),i=n.length;this._queue=this._queue.slice(this._batchSize);try{if(i){t.pw+=i;var r={t:3,d:n};this._worker.postMessage(r)}}catch(e){v(11)}finally{var s=c()-e;t.md+=s,s>=t.mm&&(t.mm=s,t.mn=i),this._queueTimeout&&clearTimeout(this._queueTimeout),this._queueTimeout=setTimeout(this.flushQueue.bind(this),this._batchInterval)}},e.prototype.preprocessAndQueueEvent=function(e,t){if(this.enabled){var n=Object(s.c)(e);n.timestamp=n.timestamp||(new Date).getTime();for(var i=0;i<this.preprocessors.length;i++){var r=this.preprocessors[i],a=r.name,l=!1;if(3!==t||"EventThrottler"===a){var d=c();try{l=r.processEvent(n)}catch(e){}var h=c()-d;if(this.stats.pd[a]=this.stats.pd[a]+h||h,!l)return void(this.stats.po[a]=this.stats.po[a]+1||1)}}n.dataFields.push(Object(o.d)("OTelJS.Sink","WebSink")),2===this.stats.s||this._queue.length<this._initialQueueSize?(this.stats.q+=1,this._queue.push({event:n,t:t})):(v(3),this.stats.s=3,this.shutdown(!1))}},e.prototype.sendTelemetryEvent=function(e){this.preprocessAndQueueEvent(e,1)},e.prototype.sendCustomerContent=function(e){this.preprocessAndQueueEvent(e,2)},e.prototype.sendNonStandardEvent=function(e,t){this.preprocessAndQueueEvent(e,t)},e.prototype.shutdown=function(e){if(this.isInitialized())try{this.stats.pm=this._queue.length,function(e,t,n){if(_)Object(r.b)(0,1,(function(){return"OTelJSMin:20"}));else{var i=e.minSinkLimit;i=l(i)?i:500;var s=n.slice(0,i),a=t.minSinkHandlers||[];a.unshift(new g),a.forEach((function(n){n.init(t,e)}));var o=0;try{s.forEach((function(e){var t=!1;a.forEach((function(n){n.enqueue(e)&&(t=!0)})),t||o++})),t.stats.sd+=o,a.forEach((function(e){e.processQueue()})),_=!0}catch(e){Object(r.b)(0,1,(function(){return"OTelJSMin:22"}))}}}(this._props,{uuid:this._utils.uuid,useSendBeacon:e,minSinkHandlers:this._utils.minSinkHandlers,stats:this.stats},this._queue),this._queue=[]}catch(e){v(30)}this.enabled=!1,this._queueTimeout&&clearTimeout(this._queueTimeout)},e}(),I=n(222),R=((T={})[3]="App.Name",T[4]="App.Platform",T[5]="App.Version",T[2]="WAC.Ring",T[1]="Release.AudienceGroup",T),C=function(e){var t,n,i,r=[];function s(e,n,i){var r=!0;if(e)for(var s=0,a=e;s<a.length;s++){var o=a[s],l=o.classification,c=o.dataType,d=o.name;if(l&&4!==l&&1!==l&&2048!==l){r=!1;break}if(n&&3!==c&&1!==c&&2!==c&&"OTelJS.Version"!==d&&"OTelJS.Sink"!==d){r=!1;break}var h=o.name.split(".");"zC"!==h[0]&&(n&&h.unshift("Data"),m(h,o.value,o.dataType,i,t))}return r}this.init=function(e,r){var s,a;t=!0===(null===(a=null===(s=r.extensionConfig)||void 0===s?void 0:s.PostChannel)||void 0===a?void 0:a.enableCompoundKey),n=r,i=e},this.enqueue=function(e){return 3===e.t&&(r.push(e),!0)},this.processQueue=function(){var a=[],o={};r.forEach((function(e){var i=e.event.telemetryProperties.dnmToken;o[i]=!0;var r=function(e,i){var r,a=e.event,o=Object(I.j)(e.event).toISOString(),l=a.eventFlags.diagnosticLevel;if(n.enableOptionalEvents||10===l||110===l||120===l){var c,d,h,u=a.eventName,m={name:u,time:o,ver:"4.0",iKey:"o:"+i.substr(0,32),ext:{sdk:{seq:0},metadata:{f:{}},utc:{eventFlags:2097152}},data:{}};if(f(m,t,u,o),s((c=n.persistentDataFields,d=null===(r=a.telemetryProperties)||void 0===r?void 0:r.dnmAllowedPartA,h=[],d&&d.forEach((function(e){var t=R[e];c.forEach((function(e){t===e.name&&h.push(e)}))})),h),!1,m),m.data.baseType="custom",s(a.dataFields,!0,m))return m}}(e,i);r&&a.push(r)})),p(a,Object.keys(o),e.endpointUrl,i)}},y=n(181),M=n(224),O=n(65);!function(e){e[e.msoulscat_MSOSP_OTelJSInWebWoker=226]="msoulscat_MSOSP_OTelJSInWebWoker"}(S||(S={})),function(e){e[e.Error=10]="Error",e[e.Warning=15]="Warning",e[e.Important=20]="Important",e[e.Info=50]="Info",e[e.Verbose=100]="Verbose"}(A||(A={}));var x,D=n(78),P=n(271),L=n(272);function N(e){let t=void 0;const n=e.alwaysOnMetadata;if(!n)return t;const i=n.loggableUserId,r=n.sessionId,s=e.sampleRate;return"number"==typeof s&&(t=new L.a,t.setSampleRate(s),i&&t.enableWithIdentifier("PrimaryIdentityHash",i)||r&&t.enableWithIdentifier("SessionId",r))?t:void 0}function F(e,t){return t(526513555,S.msoulscat_MSOSP_OTelJSInWebWoker,A.Warning,"Failed to initialize worker because "+e),{succeeded:!1,failureReason:e}}!function(e){e.WebSinkStat={Bytes:"b",WebWorkerProcessingDuration:"d",MessagingDuration:"md",MaxMessagingDuration:"mm",MaxMessagingDurationNumEvents:"mn",PreprocessingDuration:"pd",PassedToMinSink:"pm",PreprocessedOut:"po",PassedToWebWorker:"pw",Queued:"q",WebWorkerStatus:"s",MinSinkDropped:"sd",MinSinkProcessed:"sp",MinSinkSent:"ss",WebWorkerAccepted:"wa",WebWorkerDropped:"wd",WebWorkerHandlingDuration:"wh",WebWorkerProcessed:"wp",WebWorkerDroppedReason:"wr",WebWorkerSent:"ws"},e.WebWorkerStatus={Uninitialized:0,Initializing:1,Initialized:2,QueueFull:3,Error:4},e.WebSinkError={Uninitialized:1,Initialization:2,QueueFull:3,WorkerInitialization:10,WorkerPostTelemetryEvent:11,WorkerError:12,WorkerErrorMessage:13,WorkerUnhandledMessage:14,WorkerUninitialized:15,MinSinkReused:20,EndpointUrl:21,MinSinkThrows:22,Shutdown:30},e.WebWorkerMessageType={Loaded:1,Initialize:2,TelemetryEvents:3,Stats:4,Error:5}}(x||(x={}));var w=n(270),U=n(273),B=n(274);let k,V,G=!1,H=!1,W=!0,X=void 0;function j(){W=!1}const z={processed:0,conversionDurationMs:0,logDurationMs:0,webSinkBatchSize:0};let K,Y="Office.Online.UserAction",q="Office.Online.Data.Activity";const Q=new Promise(e=>{K=e});function Z(){return Boolean(k)}function $(){var e,t;if(!G||!V)return{succeeded:!1,failureReason:"NotEnabled"};Object(D.h)(()=>{});const n=V();if(!n)return{succeeded:!1,failureReason:"NoSettings"};if(!n.ulsLoggingMethods||!n.ulsLoggingMethods.sendTraceTag)return{succeeded:!1,failureReason:"ULSLoggingMethods"};const l=n.ulsLoggingMethods.sendTraceTag;if(Z())return F("WebSinkAlreadyInitialized",l);const c=n.workerUrl;if(!c)return F("WorkerUrl",l);const d=n.telemetryLoggerSettings;if(!d)return F("TelemetrySettings",l);const h=d.ariaEndpointUrl;if(!d.ariaEndpointUrl)return F("AriaUrl",l);const u=d.alwaysOnMetadata;if(!u)return F("AlwaysOnMetadata",l);if(!n.uuid)return F("Uuid",l);n.batchSize&&(z.webSinkBatchSize=n.batchSize),Object(r.c)().addListener(ne),d.enableCustomerContent&&(H=!0),function(e,t){e.name?(Y=`Office.${e.name}.Online.UserAction.`,q=`Office.${e.name}.Online.Data.Activity.`):t(541411084,S.msoulscat_MSOSP_OTelJSInWebWoker,A.Verbose,"Cannot determine the App for UserActionEvent, using generic UserAction event name.")}(u,l);const f=Object(i.f)(Object(M.a)(u)),m=new s.a(void 0,void 0,{disableValidation:!0});for(const e of y.a)m.setTenantToken(e.namespace,e.ariaTenant);for(const e of y.b)m.setDNMToken(e.namespace,e.ariaTenant);let p="",g="";var _,v;null!==(e=n.pgContext)&&void 0!==e&&e.userName&&(p=null===(_=n.pgContext)||void 0===_?void 0:_.userName),null!==(t=n.pgContext)&&void 0!==t&&t.userAlias&&(g=null===(v=n.pgContext)||void 0===v?void 0:v.userAlias);const E={context:{UserName:p,UserAlias:g},notificationEventName:O.b,iKey:O.a},T=new b;return T.init({endpointUrl:h,persistentDataFields:f,enableOptionalEvents:!0,extensionConfig:{PostChannel:{enableCompoundKey:!0},PrivacyGuardPlugin:E},minSinkLimit:n.minSinkLimit,batchSize:Object(O.d)(n.batchSize),uploadFrequency:Object(O.d)(n.batchFrequencyMs),custom:{enableDNM:Object(O.d)(d.enableDNM),enableCustomerContent:Object(O.d)(d.enableCustomerContent),enablePG:Object(O.d)(d.enablePG)}},{uuid:n.uuid,getWorker:()=>{const e=new Blob([`try{importScripts('${encodeURI(c)}');}catch(e){self.postMessage("Error loading Worker script")}`],{type:"application/javascript"});if(!n.TrustedTypesPolicy)return new Worker(URL.createObjectURL(e));try{return new Worker(U.a.createScriptURL(URL.createObjectURL(e)))}catch{return new Worker(B.a.createScriptURL(""))}},minSinkHandlers:Object(O.d)(n.enableMinSinkDNM)?[new C({endpointUrl:w.a.PUBLIC})]:[]}),d.samplingIsEnabled&&(function(e,t){const n=N(t);return n&&e.preprocessors.push(n),n}(T,d)||l(541411083,S.msoulscat_MSOSP_OTelJSInWebWoker,A.Warning,"Could not enable sampler")),m.addSink(T),K(m),k={getLogger:()=>m,getWebSink:()=>T,getSettings:()=>n,sendTraceTag:l},Object(D.g)(e=>{!function(e){if(!Z())return;k.sendTraceTag(541411082,S.msoulscat_MSOSP_OTelJSInWebWoker,A.Info,"SendToWorkerApi with "+e.kind);const t=Object(O.c)();let n=void 0;const r=k.getLogger();let s=r.sendTelemetryEvent.bind(r);switch(e.kind){case"addNamespaceMapping":return void r.setTenantToken(e.namespace,e.ariaTenantToken);case"setDNMToken":return void r.setDNMToken(e.namespace,e.ariaTenantToken);case"flush":return;case"shutdown":return void function(){const e=k.getWebSink().stats;W&&function(e,t,n){const i={eventName:"Office.Online.Telemetry.OTelJS.WebSink.Session.Stats",dataFields:[Object(o.c)("Queued",e[x.WebSinkStat.Queued]),Object(o.c)("PassedToWebWorker",e[x.WebSinkStat.PassedToWebWorker]),Object(o.c)("WebWorkerAccepted",e[x.WebSinkStat.WebWorkerAccepted]),Object(o.c)("WebWorkerProcessed",e[x.WebSinkStat.WebWorkerProcessed]),Object(o.c)("WebWorkerDropped",e[x.WebSinkStat.WebWorkerDropped]),Object(o.c)("WebWorkerSent",e[x.WebSinkStat.WebWorkerSent]),Object(o.b)("MessagingDurationMs",e[x.WebSinkStat.MessagingDuration]),Object(o.b)("MaxMessagingDurationMs",e[x.WebSinkStat.MaxMessagingDuration]),Object(o.c)("MaxMessagingDurationNumEvents",e[x.WebSinkStat.MaxMessagingDurationNumEvents]),Object(o.c)("WebSinkBatchSize",t.webSinkBatchSize),Object(o.b)("WebWorkerProcessingDurationMs",e[x.WebSinkStat.WebWorkerProcessingDuration]),Object(o.b)("WebWorkerHandlingDurationMs",e[x.WebSinkStat.WebWorkerHandlingDuration]),Object(o.b)("ConversionDurationMs",t.conversionDurationMs),Object(o.b)("LogDurationMs",t.logDurationMs),Object(o.c)("Bytes",e[x.WebSinkStat.Bytes]),Object(o.c)("WebWorkerStatus",e[x.WebSinkStat.WebWorkerStatus])],eventFlags:{samplingPolicy:a.a.SamplingPolicy.CriticalBusinessImpact,diagnosticLevel:a.a.DiagnosticLevel.RequiredServiceData}};if(e[x.WebSinkStat.PreprocessedOut])for(const t in e[x.WebSinkStat.PreprocessedOut])"EventThrottler"!==t&&"Sampler"!==t&&"DiagnosticLevel"!==t||i.dataFields.push(Object(o.c)("PreprocessedOut."+t,e[x.WebSinkStat.PreprocessedOut][t]));n.sendTelemetryEvent(i)}(e,z,k.getLogger()),k.getWebSink().shutdown(!0),W&&function(e,t,n){const i=JSON.stringify({...t,...e});n(526513554,S.msoulscat_MSOSP_OTelJSInWebWoker,A.Info,i)}(e,z,k.sendTraceTag)}();case"event":n=te(Object(i.e)(e.event),e);break;case"dnm":n=te(Object(i.c)(e.event),e),s=r.sendDirectNumericEvent.bind(r);break;case"cc":n=te(Object(i.b)(e.event),e),s=r.sendCustomerContent.bind(r);break;case"action":n=te(function(e){return null==e.name&&(e.name=Y,null!=e.actionName&&(e.name+=e.actionName)),Object(i.g)(e)}(e.event),e);break;case"activity":n=te(function(e){return null!=e&&null!=e.name&&(e.name.indexOf("Office.")>=0||(e.name=q+e.name)),Object(i.a)(e)}(e.event),e);break;case"otel":n=Object(i.h)(e.event);break;case"otelcc":H&&(n=Object(i.h)(e.event),s=r.sendCustomerContent.bind(r));break;case"oteldnm":n=Object(i.h)(e.event),s=r.sendDirectNumericEvent.bind(r)}if(n){const e=Object(O.c)()-t,i=Object(O.c)();s(n);const r=Object(O.c)()-i;z.conversionDurationMs+=e,z.logDurationMs+=r,z.processed+=1}}(e)}),{succeeded:!0}}function J(e,t){e&&t?(G=!0,V=t,Object(D.h)(()=>$())):(G=!1,V=void 0)}function ee(){const e=$();if(!e.succeeded)return e;const t=k.getWebSink();return t.startWorker(),function(e,t){if(t.wacAriaThrottlingIsEnabled){const n=new P.a("WebSink",e);n.setSingleEventThrottle(Object(O.d)(t.wacAriaSingleEventThrottlePerSec)),n.setTotalEventThrottle(Object(O.d)(t.wacAriaTotalEventsThrottlePerSec));const i=t.otelEventNamesToBeSuppressedCommaSeparated;i&&i.split(",").forEach(e=>{n.setNamedEventThrottle(e,0)}),e.preprocessors.push(n)}}(t,k.getSettings().telemetryLoggerSettings),e}function te(e,t){return e.timestamp=t.timestamp,e}function ne(e){if(!Z())return;const t=e.message();let n=A.Info;const i=e.level;i===a.a.LogLevel.Error?n=A.Error:i===a.a.LogLevel.Warning&&(n=A.Warning),e.category===a.a.Category.Sink&&"WebSink"===t.substring(0,7)&&k.sendTraceTag(540657436,S.msoulscat_MSOSP_OTelJSInWebWoker,n,t)}function ie(e){e&&Q.then(t=>{t.addSink(e)})}function re(){if(X)return X.isMeasuresEnabled();if(!G||!V)return!1;const e=V();if(!e)return!1;const t=e.telemetryLoggerSettings;return!!t&&(!t.samplingIsEnabled||(X=N(t),!!X&&X.isMeasuresEnabled()))}},function(e,t,n){"use strict";var i;n.d(t,"a",(function(){return i})),function(e){e.DataClassification={EssentialServiceMetadata:1,AccountData:2,SystemMetadata:4,OrganizationIdentifiableInformation:8,EndUserIdentifiableInformation:16,CustomerContent:32,AccessControl:64,PublicNonPersonalData:128,EndUserPseudonymousInformation:256,PublicPersonalData:512,SupportData:1024,DirectMeasurementData:2048,Everything:65535},e.DataFieldType={String:0,Boolean:1,Int64:2,Double:3,Guid:4},e.SamplingPolicy={NotSet:0,Measure:1,Diagnostics:2,CriticalBusinessImpact:191,CriticalCensus:192,CriticalExperimentation:193,CriticalUsage:194},e.PersistencePriority={NotSet:0,Normal:1,High:2},e.CostPriority={NotSet:0,Normal:1,High:2},e.DataCategories={NotSet:0,SoftwareSetup:1,ProductServiceUsage:2,ProductServicePerformance:4,DeviceConfiguration:8,InkingTypingSpeech:16},e.DiagnosticLevel={ReservedDoNotUse:0,Required:10,BasicEvent:10,Optional:100,FullEvent:100,RequiredServiceData:110,NecessaryServiceDataEvent:110,RequiredServiceDataForEssentialServices:120,AlwaysOnNecessaryServiceDataEvent:120},e.DnmInterval={Hourly:1,Daily:2},e.AllowedPartA={ReleaseAudienceGroup:1,WacRing:2,AppName:3,AppPlatform:4,AppVersion:5},e.CustomerContentType={None:0,MocaAddIn:1},e.LogLevel={Error:0,Warning:1,Info:2,Verbose:3},e.Category={Core:0,Sink:1,Transport:2},e.PrimaryIdentitySpace={UserObjectId:"UserObjectId",MSACID:"MSACID",OrgIdPuid:"OrgIdPuid",OrgIdPUID:"OrgIdPUID",OrgIdCID:"OrgIdCID",MsaPuid:"MsaPuid",MSAPUID:"MSAPUID",WopiAuth:"WopiAuth",ThirdParty:"ThirdParty",Other:"Other"},e.AudienceGroup={Automation:"Automation",Dogfood:"Dogfood",Microsoft:"Microsoft",Insiders:"Insiders",Production:"Production"}}(i||(i={}))},,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"v",(function(){return b})),n.d(t,"w",(function(){return I})),n.d(t,"q",(function(){return R})),n.d(t,"p",(function(){return C})),n.d(t,"j",(function(){return y})),n.d(t,"s",(function(){return M})),n.d(t,"o",(function(){return O})),n.d(t,"x",(function(){return x})),n.d(t,"A",(function(){return D})),n.d(t,"I",(function(){return P})),n.d(t,"J",(function(){return L})),n.d(t,"H",(function(){return N})),n.d(t,"m",(function(){return F})),n.d(t,"k",(function(){return w})),n.d(t,"n",(function(){return U})),n.d(t,"t",(function(){return B})),n.d(t,"r",(function(){return k})),n.d(t,"l",(function(){return V})),n.d(t,"M",(function(){return H})),n.d(t,"a",(function(){return W})),n.d(t,"b",(function(){return X})),n.d(t,"c",(function(){return j})),n.d(t,"d",(function(){return z})),n.d(t,"K",(function(){return K})),n.d(t,"C",(function(){return Q})),n.d(t,"y",(function(){return Z})),n.d(t,"f",(function(){return $})),n.d(t,"B",(function(){return J})),n.d(t,"e",(function(){return ee})),n.d(t,"h",(function(){return te})),n.d(t,"G",(function(){return ne})),n.d(t,"i",(function(){return ie})),n.d(t,"g",(function(){return re})),n.d(t,"u",(function(){return se})),n.d(t,"L",(function(){return ae})),n.d(t,"E",(function(){return oe})),n.d(t,"F",(function(){return le})),n.d(t,"D",(function(){return ce})),n.d(t,"z",(function(){return de}));var i=n(53),r=n(245),s=n(45),a=n(179),o=i.d,l=i.b.freeze,c=(i.b.seal,i.b.keys),d=String[i.k],h=d.trim,u=d.endsWith,f=d.startsWith,m=Date[i.k].toISOString,p=Array.isArray,g=i.f.toString,_=i.e.toString,v=_[s.c](i.b),E=/-([a-z])/g,T=/([^\w\d_$])/g,S=/^(\d+[\w\d_$])/,A=Object.getPrototypeOf;function b(e,t){return typeof e===t}function I(e){return void 0===e||typeof e===i.l}function R(e){return null===e||I(e)}function C(e){return!R(e)}function y(e,t){return!(!e||!i.e[s.c](e,t))}function M(e){return!(!e||typeof e!==i.j)}function O(e){return!(!e||typeof e!==i.h)}function x(e){var t=e;return t&&B(t)&&(t=(t=(t=t[s.J](E,(function(e,t){return t.toUpperCase()})))[s.J](T,"_"))[s.J](S,(function(e,t){return"_"+t}))),t}function D(e,t){if(e)for(var n in e)i.e[s.c](e,n)&&t[s.c](e,n,e[n])}function P(e,t){var n=!1;return e&&t&&!(n=e===t)&&(n=u?e.endsWith(t):function(e,t){var n=!1,i=t?t[s.x]:0,r=e?e[s.x]:0;if(i&&r&&r>=i&&!(n=e===t)){for(var a=r-1,o=i-1;o>=0;o--){if(e[a]!=t[o])return!1;a--}n=!0}return n}(e,t)),n}function L(e,t){var n=!1;return e&&t&&!(n=e===t)&&(n=f?e.startsWith(t):function(e,t){var n=!1,i=t?t[s.x]:0;if(e&&i&&e[s.x]>=i&&!(n=e===t)){for(var r=0;r<i;r++)if(e[r]!==t[r])return!1;n=!0}return n}(e,t)),n}function N(e,t){return!(!e||!t)&&-1!==e[s.r](t)}function F(e){return!(!e||"[object Date]"!==g[s.c](e))}var w=p||function(e){return!(!e||"[object Array]"!==g[s.c](e))};function U(e){return!(!e||"[object Error]"!==g[s.c](e))}function B(e){return"string"==typeof e}function k(e){return"number"==typeof e}function V(e){return"boolean"==typeof e}function G(e){var t=!1;if(e&&"object"==typeof e){var n=A?A(e):function(e){if(e){if(A)return A(e);var t=e.__proto__||e[i.k]||e.constructor;if(t)return t}return null}(e);n?(n.constructor&&i.e[s.c](n,"constructor")&&(n=n.constructor),t=typeof n===i.h&&_[s.c](n)===v):t=!0}return t}function H(e){if(e)return m?e.toISOString():function(e){if(e&&e.getUTCFullYear){var t=function(e){var t=String(e);return 1===t[s.x]&&(t="0"+t),t};return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+String((e.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}}(e)}function W(e,t,n){var i=e[s.x];try{for(var r=0;r<i&&(!(r in e)||-1!==t[s.c](n||e,e[r],r,e));r++);}catch(e){}}function X(e,t,n){if(e){if(e.indexOf)return e.indexOf(t,n);var i=e[s.x],r=n||0;try{for(var a=Math.max(r>=0?r:i-Math.abs(r),0);a<i;a++)if(a in e&&e[a]===t)return a}catch(e){}}return-1}function j(e,t,n){var i;if(e){if(e.map)return e.map(t,n);var r=e[s.x],a=n||e;i=new Array(r);try{for(var o=0;o<r;o++)o in e&&(i[o]=t[s.c](a,e[o],e))}catch(e){}}return i}function z(e,t,n){var i;if(e){if(e.reduce)return e.reduce(t,n);var r=e[s.x],a=0;if(arguments[s.x]>=3)i=arguments[2];else{for(;a<r&&!(a in e);)a++;i=e[a++]}for(;a<r;)a in e&&(i=t(i,e[a],a,e)),a++}return i}function K(e){return e&&(e=h&&e.trim?e.trim():e[s.J]?e[s.J](/^\s+|(?=\s)\s+$/g,a.e):e),e}var Y=!{toString:null}.propertyIsEnumerable("toString"),q=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];function Q(e){var t=typeof e;if(t===i.h||t===i.j&&null!==e||Object(r.c)("objKeys called on non-object"),!Y&&c)return c(e);var n=[];for(var a in e)e&&i.e[s.c](e,a)&&n[s.H](a);if(Y)for(var o=q[s.x],l=0;l<o;l++)e&&i.e[s.c](e,q[l])&&n[s.H](q[l]);return n}function Z(e,t,n,i){if(o)try{var r={enumerable:!0,configurable:!0};return n&&(r.get=n),i&&(r.set=i),o(e,t,r),!0}catch(e){}return!1}function $(e){return l&&D(e,(function(e,t){(w(t)||M(t))&&l(t)})),J(e)}var J=l||function(e){return e};function ee(){var e=Date;return e.now?e.now():(new e).getTime()}function te(e){return U(e)?e[s.D]:a.e}function ne(e,t,n,i,r){var s=n;return e&&((s=e[t])===n||r&&!r(s)||i&&!i(n)||(s=n,e[t]=s)),s}function ie(e,t,n){var i;return e?!(i=e[t])&&R(i)&&(i=I(n)?{}:n,e[t]=i):i=I(n)?{}:n,i}function re(e,t){return R(e)?t:e}function se(e){return!!e}function ae(e){throw new Error(e)}function oe(e,t,n,i,r){e&&t&&n&&(!1!==r||I(e[t]))&&(e[t]=function(e,t){var n=null,i=null;return O(e)?n=e:i=e,function(){var e=arguments;if(n&&(i=n()),i)return i[t][s.b](i,e)}}(n,i))}function le(e,t,n,i){return e&&t&&M(e)&&w(n)&&W(n,(function(n){B(n)&&oe(e,n,t,n,i)})),e}function ce(e){return e&&i.a&&(e=Object(i.b)(Object(i.a)({},e))),e}function de(e,t,n,r,a,o){var l=arguments,c=l[0]||{},d=l[s.x],h=!1,u=1;for(d>0&&V(c)&&(h=c,c=l[u]||{},u++),M(c)||(c={});u<d;u++){var f=l[u],m=w(f),p=M(f);for(var g in f){var _=m&&g in f||p&&i.e[s.c](f,g);if(_){var v=f[g],E=void 0;if(h&&v&&((E=w(v))||G(v))){var T=c[g];E?w(T)||(T=[]):G(T)||(T={}),v=de(h,T,v)}void 0!==v&&(c[g]=v)}}}return c}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));const i={},r="undefined"!=typeof self&&self.trustedTypes?self.trustedTypes:{createPolicy:(e,t)=>t},s=(e,t,n=r)=>{try{i[e]||(i[e]=n.createPolicy(e,{createHTML:t.createHTML,createScript:t.createScript,createScriptURL:t.createScriptURL}))}catch{console.info("Skipped duplicate policy creation: "+e)}return i[e]}},,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"e",(function(){return i})),n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return a})),n.d(t,"d",(function(){return o})),n.d(t,"k",(function(){return l})),n.d(t,"j",(function(){return c})),n.d(t,"o",(function(){return d})),n.d(t,"n",(function(){return h})),n.d(t,"i",(function(){return u})),n.d(t,"g",(function(){return f})),n.d(t,"h",(function(){return m})),n.d(t,"m",(function(){return p})),n.d(t,"f",(function(){return g})),n.d(t,"p",(function(){return _})),n.d(t,"l",(function(){return v}));var i="",r="channels",s="core",a="createPerfMgr",o="disabled",l="extensionConfig",c="extensions",d="processTelemetry",h="priority",u="eventsSent",f="eventsDiscarded",m="eventsSendRequest",p="perfEvent",g="errorToConsole",_="warnToConsole",v="getPerfMgr"},,function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return r}));const i=[{namespace:"Office.Online",ariaTenant:"79b56d2f6f2444f1a3d7f7c7f12bcc0c-f47f5fe6-ed89-42f6-8a43-cea0f5930b17-7407"},{namespace:"Office.Word.Online.Data",ariaTenant:"7e7959aac92e41d6892c69a87259ed58-de5c63ef-10f5-45e1-bef2-d23e9cac2fab-6830"},{namespace:"Office.Excel.Online.Data",ariaTenant:"011776870b754a649aedc9456ac07a97-6bd8247c-11d3-4599-b599-ec9ef6d401f6-6722"},{namespace:"Office.PowerPoint.Online.Data",ariaTenant:"35612b11d234460da5c673d7b172fd93-f8762c6b-96cb-4e60-87fa-015aac0c2ff1-7212"},{namespace:"Office.OneNote.Online.Data",ariaTenant:"86258c80efed47d9b34bf77fc663b381-af82a060-b49f-448b-baf0-956ba7709592-7634"},{namespace:"Office.Visio.Online.Data",ariaTenant:"77fd25a525d24b7f9b924307de0cc70f-5f2b6ec0-f1d2-40dd-b875-e6bd2849e1eb-7539"},{namespace:"Office.Shared.Online.Data",ariaTenant:"4ad8b2b2029e481fb82edb7aac29de59-94494dd8-b684-4f92-ab7f-6b414eb77798-7917"},{namespace:"Office.PowerPoint",ariaTenant:"e97859101370486fbcb67f5a023da3fc-29b89831-2d28-4841-8fa6-338080fae3a4-7206"},{namespace:"Office.Word.Online",ariaTenant:"ff7e2f12a4be407096fc01eeb760eda3-eeeb63cf-35d9-4734-ab45-66a873412359-7045"},{namespace:"Office.Excel.Online",ariaTenant:"fad3bd1d8e4b4c06894bd7bac80e4f02-67df67b4-f1fd-4ecd-9d55-4d41540b1757-7724"},{namespace:"Office.Excel.Client",ariaTenant:"19eb5e37de684ce38ce5cf3d5842d3f7-e8722941-bde5-4b98-9cd5-2775ec51482c-6873"},{namespace:"Office.PowerPoint.Online",ariaTenant:"b664cab4b3f24a739be75b93b026749e-65c206a3-a985-48b4-8b50-36c56c3ce309-7201"},{namespace:"Office.OneNote.Online",ariaTenant:"1705ef36a51840648341da866d62baf8-ddbcd60b-4ce4-48da-96be-ad5f28b48954-8035"},{namespace:"Office.Visio.Online",ariaTenant:"a9b6cb604fe942a89c8671aab85364f6-af0f81b1-c5ce-419a-82d5-af38c33ebea3-7250"},{namespace:"Office.Shared.Online",ariaTenant:"d034371e26194a76a187c7108b3837ca-731725e8-1dc7-4eca-a754-b09c9d2b8dd5-6502"},{namespace:"Office.Telemetry",ariaTenant:"f998cc5ba4d448d6a1e8e913ff18be94-dd122e0a-fcf8-4dc5-9dbb-6afac5325183-7405"},{namespace:"Office.System",ariaTenant:"cd836626611c4caaa8fc5b2e728ee81d-3b6d6c45-6377-4bf5-9792-dbf8e1881088-7521"},{namespace:"Office.TellMe",ariaTenant:"31d9dd3e4c7046a696537586281d7ed1-06d11dd6-a946-4281-8ac3-a7c2ab4776f5-7063"},{namespace:"Office.Voice",ariaTenant:"9783945ebc2b468fbb8a2890cdab903b-787355a5-74c8-4a89-b06a-9c82635d75fa-7162"},{namespace:"Office.Insights",ariaTenant:"250a372c4a854d8fb120ef0366f9410c-dd39bcd8-3b38-4c6c-9f8d-3821e5c28b47-7487"},{namespace:"Office.Graphics",ariaTenant:"cfcfdb91c68c4329bb8b7cb7babb3cf7-e082c2f2-ef1d-427a-ac4d-b0b700afe7a7-7655"},{namespace:"Office.AugLoop",ariaTenant:"3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770"},{namespace:"Office.FileIO",ariaTenant:"d2b065c5ae634beb9cec4813140e22da-eda42ada-ffd9-4e26-92a1-e3b440eaf8bf-7717"},{namespace:"Office.Sandbox",ariaTenant:"1cd66059dc1d41f1887e3770ea8ba967-f1d0108c-8535-4cf9-bf23-ec8227f6afa7-6999"},{namespace:"Office.UX",ariaTenant:"c4388c977297413bb054bad1acf0ade1-cc58e53e-f5a4-4f37-b0d2-9a8079e34420-6879"},{namespace:"Office.Extensibility",ariaTenant:"db334b301e7b474db5e0f02f07c51a47-a1b5bc36-1bbe-482f-a64a-c2d9cb606706-7439"}],r=[{namespace:"Office.DNM.Word.Online",ariaTenant:"541f81cf685f4bccb9e5395b0add4d41-2c1afbab-72ae-471a-a985-efea62ea9e83-7130"},{namespace:"Office.DNM.Visio.Online",ariaTenant:"feba3d98f7c0481c8b63754573a80618-7311e9e0-365d-4a1b-b0fb-a238e0bc7528-6955"},{namespace:"Office.DNM.Sandbox",ariaTenant:"b0aae8a3009047b9bf4d3b17439319b6-e96e56cc-5657-463a-a2f2-dc8c0fb9d41b-7136"},{namespace:"Office.DNM.Excel",ariaTenant:"58fd209df5254081ba538f7f4bc34ef5-7b3b52dc-fdf5-4d95-917e-a356694c1ebc-7071"}]},,,,,,function(e,t,n){"use strict";n.r(t);var i=n(207);n.d(t,"p_0",(function(){return i.a}));var r=n(208);n.d(t,"p_1",(function(){return r.a}));var s=n(209);n.d(t,"p_2",(function(){return s.a}));var a=n(210);n.d(t,"p_3",(function(){return a.a}));var o=n(211);n.d(t,"p_4",(function(){return o.a}));var l=n(212);n.d(t,"p_5",(function(){return l.a}));var c=n(213);n.d(t,"p_6",(function(){return c.a}));var d=n(214);n.d(t,"p_7",(function(){return d.a}));var h=n(215);n.d(t,"p_8",(function(){return h.a}));var u=n(216);n.d(t,"p_9",(function(){return u.a}));var f=n(217);n.d(t,"p_10",(function(){return f.a}));var m=n(218);n.d(t,"p_11",(function(){return m.a}))},function(e,t,n){"use strict";n.r(t),n.d(t,"_KTXTextureLoader",(function(){return f}));var i=n(36);class r{uploadLevels(e,t){switch(this.loadType){case r.COMPRESSED_2D:this._upload2DCompressedLevels(e,t);break;case r.TEX_2D:case r.COMPRESSED_3D:case r.TEX_3D:}}_upload2DCompressedLevels(e,t){let n=r.HEADER_LEN+this.bytesOfKeyValueData,i=this.pixelWidth,s=this.pixelHeight;const a=t?this.numberOfMipmapLevels:1;for(let t=0;t<a;t++){const r=new Int32Array(this.data.buffer,this.data.byteOffset+n,1)[0];n+=4;for(let a=0;a<this.numberOfFaces;a++){const o=new Uint8Array(this.data.buffer,this.data.byteOffset+n,r);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,i,s,o,a,t),n+=r,n+=3-(r+3)%4}i=Math.max(1,.5*i),s=Math.max(1,.5*s)}}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}constructor(e,t){if(this.data=e,this.isInvalid=!1,!r.IsValid(e))return this.isInvalid=!0,void i.a.Error("texture missing KTX identifier");const n=Uint32Array.BYTES_PER_ELEMENT,s=new DataView(this.data.buffer,this.data.byteOffset+12,13*n),a=67305985===s.getUint32(0,!0);return this.glType=s.getUint32(1*n,a),this.glTypeSize=s.getUint32(2*n,a),this.glFormat=s.getUint32(3*n,a),this.glInternalFormat=s.getUint32(4*n,a),this.glBaseInternalFormat=s.getUint32(5*n,a),this.pixelWidth=s.getUint32(6*n,a),this.pixelHeight=s.getUint32(7*n,a),this.pixelDepth=s.getUint32(8*n,a),this.numberOfArrayElements=s.getUint32(9*n,a),this.numberOfFaces=s.getUint32(10*n,a),this.numberOfMipmapLevels=s.getUint32(11*n,a),this.bytesOfKeyValueData=s.getUint32(12*n,a),0!==this.glType?(i.a.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(i.a.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(i.a.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==t?(i.a.Error("number of faces expected"+t+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=r.COMPRESSED_2D))}}r.HEADER_LEN=64,r.COMPRESSED_2D=0,r.COMPRESSED_3D=1,r.TEX_2D=2,r.TEX_3D=3;var s,a,o,l=n(403),c=n(312);function d(e,t){const n=(null==t?void 0:t.jsDecoderModule)||KTX2DECODER;e&&(e.wasmUASTCToASTC&&(n.LiteTranscoder_UASTC_ASTC.WasmModuleURL=e.wasmUASTCToASTC),e.wasmUASTCToBC7&&(n.LiteTranscoder_UASTC_BC7.WasmModuleURL=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM&&(n.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB&&(n.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=e.wasmUASTCToRGBA_SRGB),e.wasmUASTCToR8_UNORM&&(n.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=e.wasmUASTCToR8_UNORM),e.wasmUASTCToRG8_UNORM&&(n.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=e.wasmUASTCToRG8_UNORM),e.jsMSCTranscoder&&(n.MSCTranscoder.JSModuleURL=e.jsMSCTranscoder),e.wasmMSCTranscoder&&(n.MSCTranscoder.WasmModuleURL=e.wasmMSCTranscoder),e.wasmZSTDDecoder&&(n.ZSTDDecoder.WasmModuleURL=e.wasmZSTDDecoder)),t&&(t.wasmUASTCToASTC&&(n.LiteTranscoder_UASTC_ASTC.WasmBinary=t.wasmUASTCToASTC),t.wasmUASTCToBC7&&(n.LiteTranscoder_UASTC_BC7.WasmBinary=t.wasmUASTCToBC7),t.wasmUASTCToRGBA_UNORM&&(n.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=t.wasmUASTCToRGBA_UNORM),t.wasmUASTCToRGBA_SRGB&&(n.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=t.wasmUASTCToRGBA_SRGB),t.wasmUASTCToR8_UNORM&&(n.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=t.wasmUASTCToR8_UNORM),t.wasmUASTCToRG8_UNORM&&(n.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=t.wasmUASTCToRG8_UNORM),t.jsMSCTranscoder&&(n.MSCTranscoder.JSModule=t.jsMSCTranscoder),t.wasmMSCTranscoder&&(n.MSCTranscoder.WasmBinary=t.wasmMSCTranscoder),t.wasmZSTDDecoder&&(n.ZSTDDecoder.WasmBinary=t.wasmZSTDDecoder))}function h(e){let t;void 0===e&&"undefined"!=typeof KTX2DECODER&&(e=KTX2DECODER),onmessage=n=>{if(n.data)switch(n.data.action){case"init":{const i=n.data.urls;i&&(i.jsDecoderModule&&void 0===e&&(importScripts(i.jsDecoderModule),e=KTX2DECODER),d(i)),n.data.wasmBinaries&&d(void 0,{...n.data.wasmBinaries,jsDecoderModule:e}),t=new e.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":e.KTX2Decoder.DefaultDecoderOptions=n.data.options;break;case"decode":t.decode(n.data.data,n.data.caps,n.data.options).then(e=>{const t=[];for(let n=0;n<e.mipmaps.length;++n){const i=e.mipmaps[n];i&&i.data&&t.push(i.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:e},t)}).catch(e=>{postMessage({action:"decoded",success:!1,msg:e})})}}}!function(e){e[e.ETC1S=0]="ETC1S",e[e.UASTC4x4=1]="UASTC4x4"}(s||(s={})),function(e){e[e.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",e[e.BC7_RGBA=1]="BC7_RGBA",e[e.BC3_RGBA=2]="BC3_RGBA",e[e.BC1_RGB=3]="BC1_RGB",e[e.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",e[e.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",e[e.ETC2_RGBA=6]="ETC2_RGBA",e[e.ETC1_RGB=7]="ETC1_RGB",e[e.RGBA32=8]="RGBA32",e[e.R8=9]="R8",e[e.RG8=10]="RG8"}(a||(a={})),function(e){e[e.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",e[e.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.RGBA8Format=32856]="RGBA8Format",e[e.R8Format=33321]="R8Format",e[e.RG8Format=33323]="RG8Format"}(o||(o={}));class u{static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(e){if(u._WorkerPoolPromise||u._DecoderModulePromise)return;const t={jsDecoderModule:c.b.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:c.b.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:c.b.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:c.b.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:c.b.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:c.b.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:c.b.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:c.b.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:c.b.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:c.b.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};e&&"function"==typeof Worker&&"undefined"!=typeof URL?u._WorkerPoolPromise=new Promise(n=>{const i=`${d}(${h})()`,r=URL.createObjectURL(new Blob([i],{type:"application/javascript"}));n(new l.a(e,()=>function(e,t,n){return new Promise((t,i)=>{const r=t=>{e.removeEventListener("error",r),e.removeEventListener("message",s),i(t)},s=n=>{"init"===n.data.action&&(e.removeEventListener("error",r),e.removeEventListener("message",s),t(e))};e.addEventListener("error",r),e.addEventListener("message",s),e.postMessage({action:"init",urls:n,wasmBinaries:void 0})})}(new Worker(r),0,t)))}):void 0===u._KTX2DecoderModule?u._DecoderModulePromise=c.b.LoadBabylonScriptAsync(t.jsDecoderModule).then(()=>(u._KTX2DecoderModule=KTX2DECODER,u._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,u._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,d(t,u._KTX2DecoderModule),new u._KTX2DecoderModule.KTX2Decoder)):(u._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,u._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,u._DecoderModulePromise=Promise.resolve(new u._KTX2DecoderModule.KTX2Decoder))}_uploadAsync(e,t,n){const i=this._engine.getCaps(),r={astc:!!i.astc,bptc:!!i.bptc,s3tc:!!i.s3tc,pvrtc:!!i.pvrtc,etc2:!!i.etc2,etc1:!!i.etc1};if(u._WorkerPoolPromise)return u._WorkerPoolPromise.then(i=>new Promise((s,a)=>{i.push((i,o)=>{const l=e=>{i.removeEventListener("error",l),i.removeEventListener("message",c),a(e),o()},c=e=>{if("decoded"===e.data.action){if(i.removeEventListener("error",l),i.removeEventListener("message",c),e.data.success)try{this._createTexture(e.data.decodedData,t,n),s()}catch(e){a({message:e})}else a({message:e.data.msg});o()}};i.addEventListener("error",l),i.addEventListener("message",c),i.postMessage({action:"setDefaultDecoderOptions",options:u.DefaultDecoderOptions._getKTX2DecoderOptions()});const d=new Uint8Array(e.byteLength);d.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),i.postMessage({action:"decode",data:d,caps:r,options:n},[d.buffer])})}));if(u._DecoderModulePromise)return u._DecoderModulePromise.then(n=>(u.DefaultDecoderOptions.isDirty&&(u._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=u.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise((r,s)=>{n.decode(e,i).then(e=>{this._createTexture(e,t),r()}).catch(e=>{s({message:e})})})));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,n){this._engine._bindTextureDirectly(3553,t),n&&(n.transcodedFormat=e.transcodedFormat,n.isInGammaSpace=e.isInGammaSpace,n.hasAlpha=e.hasAlpha,n.transcoderName=e.transcoderName);let i=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,i=!1}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let n=0;n<e.mipmaps.length;++n){const r=e.mipmaps[n];if(!r||!r.data)throw new Error("KTX2 container - could not transcode one of the image");i?(t.width=r.width,t.height=r.height,this._engine._uploadDataToTextureDirectly(t,r.data,0,n,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,r.width,r.height,r.data,0,n)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}constructor(e,t=u.DefaultNumWorkers){this._engine=e;const n="object"==typeof t&&t.workerPool||u.WorkerPool;if(n)u._WorkerPoolPromise=Promise.resolve(n);else{var i,r;"object"==typeof t?u._KTX2DecoderModule=null==t||null===(r=t.binariesAndModulesContainer)||void 0===r?void 0:r.jsDecoderModule:"undefined"!=typeof KTX2DECODER&&(u._KTX2DecoderModule=KTX2DECODER);const e="number"==typeof t?t:null!==(i=t.numWorkers)&&void 0!==i?i:u.DefaultNumWorkers;u._Initialize(e)}}}u.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},u.DefaultNumWorkers=u.GetDefaultNumWorkers(),u.DefaultDecoderOptions=new class{get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[a.BC1_RGB,a.BC3_RGBA],yes:{transcodeFormat:a.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}};class f{loadCubeData(e,t,n,i){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const s=t.getEngine(),a=new r(e,6),o=a.numberOfMipmapLevels>1&&t.generateMipMaps;s._unpackFlipY(!0),a.uploadLevels(t,t.generateMipMaps),t.width=a.pixelWidth,t.height=a.pixelHeight,s._setCubeMapTextureParams(t,o,a.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),i&&i()}loadData(e,t,n,s){if(r.IsValid(e)){t._invertVScale=!t.invertY;const i=new r(e,1),s=function(e){switch(e){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(i.glInternalFormat);s?(t.format=s,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=i.glInternalFormat,n(i.pixelWidth,i.pixelHeight,t.generateMipMaps,!0,()=>{i.uploadLevels(t,t.generateMipMaps)},i.isInvalid)}else u.IsValid(e)?new u(t.getEngine())._uploadAsync(e,t,s).then(()=>{n(t.width,t.height,t.generateMipMaps,!0,()=>{},!1)},e=>{i.a.Warn("Failed to load KTX2 texture data: "+e.message),n(0,0,!1,!1,()=>{},!0)}):(i.a.Error("texture missing KTX identifier"),n(0,0,!1,!1,()=>{},!0))}constructor(){this.supportCascades=!1}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"f",(function(){return a})),n.d(t,"g",(function(){return o})),n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return c})),n.d(t,"c",(function(){return d})),n.d(t,"d",(function(){return h})),n.d(t,"e",(function(){return u})),n.d(t,"n",(function(){return f})),n.d(t,"h",(function(){return m})),n.d(t,"m",(function(){return p})),n.d(t,"l",(function(){return g})),n.d(t,"i",(function(){return I})),n.d(t,"k",(function(){return R})),n.d(t,"j",(function(){return C}));var i=n(151),r=n(92),s=n(133),a="Release.AudienceGroup",o="WAC.Ring",l="App.Name",c="App.Platform",d="App.Version",h="f998cc5ba4d448d6a1e8e913ff18be94-dd122e0a-fcf8-4dc5-9dbb-6afac5325183-7405",u="b22a201c3f1d41d28ccc399ba6cc9ca2-1972c77f-1f79-4283-a0f9-b4ddc4646f55-7121",f=void 0;function m(e,t,n,i){var s=!0;if(t)for(var a=function(t){var a=t.classification,o=t.dataType,l=t.name;if(a&&!(4===a||1===a||2===i&&32===a||3===i&&2048===a))return s=!1,"break";if(3===i&&n&&3!==o&&1!==o&&2!==o&&"OTelJS.Version"!==l&&"OTelJS.Sink"!==l)return Object(r.b)(0,1,(function(){return"DNM: Invalid field type "+l})),s=!1,"break";var c;c=n?"zC."===l.substr(0,3)?"zC.Data."+l.substr(3):"Data."+l:l;var d=void 0;switch(o){case 3:d=6;break;case 2:d=4;break;case 4:d=8;break;case 0:return e[c]="string"==typeof t.value?t.value.substr(0,25e3):t.value,"continue";case 1:default:return e[c]=t.value,"continue"}var h={value:t.value,propertyType:d};e[c]=h},o=0,l=t;o<l.length&&"break"!==a(l[o]);o++);return s}function p(e,t){try{return e()}catch(e){return Object(r.a)(1,"1DS Sink",e),t}}function g(e,t){for(var n=function(n){var i=t[n];if(!i.processEvent(e))return Object(r.b)(2,1,(function(){return"".concat(e.eventName," suppressed by ").concat(i.name)})),{value:!1}},i=0;i<t.length;i++){var s=n(i);if("object"==typeof s)return s.value}return!0}function _(e){Object(r.b)(0,1,(function(){return"Invalid "+e}))}function v(e){return Object(i.t)(e)&&""!==e}function E(e,t){return Object.values(t).includes(e)}function T(e){return E(e,s.d)}function S(e){return E(e,s.c)}function A(e){return["MSACID","MSAPUID","OrgIdCID","OrgIdPUID","UserObjectId","Other"].includes(e)}function b(e){return!e||"Other"===e}function I(e,t){var n=!0;function r(t,i){i(e[t])||(_(t),n=!1)}function s(e){return new RegExp("^[0-9a-f]{8}-([0-9a-f]{4}-){3}[0-9a-f]{12}$",t?"":"i").test(e)}return r(l,v),r(c,t?T:v),r(d,v),r("Session.Id",s),t?(r(a,S),r("User.IsSignedIn",i.l),e["User.IsSignedIn"]?(r("User.PrimaryIdentityHash",v),r("User.PrimaryIdentitySpace",A),["OrgIdCID","OrgIdPUID","UserObjectId"].includes(e["User.PrimaryIdentitySpace"])?r("User.TenantId",s):r("User.TenantId",i.q)):(r("User.PrimaryIdentitySpace",b),r("User.TenantId",i.q))):e["User.IsAnonymous"]||!1===e["User.IsSignedIn"]||(r("User.PrimaryIdentityHash",v),r("User.PrimaryIdentitySpace",v),e["User.TenantId"]&&r("User.TenantId",s)),Object(i.q)(e["User.IsAnonymous"])||e["User.IsSignedIn"]!==e["User.IsAnonymous"]||(_("User.IsAnonymous"),n=!1),n}function R(e){return e.timestamp?new Date(e.timestamp):new Date}function C(e){var t=R(e);return t.setMilliseconds(0),t.setSeconds(0),t.setMinutes(0),2===e.telemetryProperties.dnmInterval&&t.setHours(0),t}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(78),r=n(136),s=n(65);class a{sendTelemetryEvent(e){e&&Object(i.p)(e)}sendDirectNumericEvent(e){e&&Object(i.k)(e)}sendCustomerContentEvent(e){e&&Object(i.j)(e)}sendActivityEvent(e){e&&Object(i.i)(e)}sendUserActionEvent(e){e&&Object(i.q)(e)}addNamespaceMapping(e,t){e&&t&&Object(i.b)(e,t)}setDNMToken(e,t){e&&t&&Object(i.r)(e,t)}sendOtelEvent(e){e&&Object(i.o)(e)}sendOtelCustomerContent(e){e&&Object(i.m)(e)}sendOtelDirectNumeric(e){e&&Object(i.n)(e)}setEnabledState(e){Object(i.s)(e)}registerEventHandler(e){e&&Object(i.g)(e)}shutdown(){return Object(i.t)()}setOtelWorkerEnabledState(e,t){return Object(r.e)(e,Object(s.d)(t))}startOtelWorker(){return Object(r.f)()}addSink(e){Object(r.a)(Object(s.d)(e))}hasValidLogger(){return Object(r.c)()}isMeasuresEnabled(){return Object(r.d)()}}class o{createInstance(){return new a}}},function(e,t,n){"use strict";function i(e){return e?[r,s,a,o,l,d,c].map(t=>t(e)):[]}function r(e){return{name:"App",contract:{name:"App",dataFields:[h("Name",e.name),h("Platform",e.platform),h("Version",e.version)]}}}function s(e){return{name:"Session",contract:{name:"Session",dataFields:[h("Id",e.sessionId),h("EcsETag",e.flightsImpressionId)]}}}function a(e){return{name:"Release",contract:{name:"Release",dataFields:[h("AudienceGroup",e.audienceGroup)]}}}function o(e){return{name:"Browser",contract:{name:"Browser",dataFields:[h("Name",e.browserName),h("Version",e.browserVersion)]}}}function l(e){return{name:"Culture",contract:{name:"Culture",dataFields:[h("UiLanguage",e.appLanguage)]}}}function c(e){return{name:"User",contract:{name:"User",dataFields:[h("PrimaryIdentityHash",e.loggableUserId),h("PrimaryIdentitySpace",e.loggableUserIdSpace),h("TenantId",e.omsTenantId),u("IsAnonymous",e.isAnonymousUser)]}}}function d(e){return{name:"WAC",contract:{name:"WAC",dataFields:[h("Host",e.host),h("ServerDocId",e.serverDocId),h("Datacenter",e.datacenter),u("IsSynthetic",e.isSynthetic),u("IsBusinessUser",e.isBusinessUser),u("IsEdu",e.isEduUser),h("ApplicationMode",e.applicationMode),h("ApplicationModeExtended",e.applicationModeExtended),h("BrowserLanguage",e.browserLanguage),h("ContentLanguage",e.contentLanguage),h("OsVersion",e.osVersion),h("Ring",e.ring),h("UiHost",e.uiHost),h("SessionOrigin",e.sessionOrigin),h("UiHostIntegrationType",e.uiHostIntegrationType),f("NetworkDownlink",e.networkDownlink),f("NetworkDownlinkMax",e.networkDownlinkMax),h("NetworkEffectiveType",e.networkEffectiveType),(t="NetworkRTT",n=e.networkRTT,null==n?{name:t,int64:0}:{name:t,int64:n}),u("NetworkSaveData",e.networkSaveData),h("NetworkType",e.networkType)]}};var t,n}function h(e,t){return null==t?{name:e,string:""}:{name:e,string:t}}function u(e,t){return null==t?{name:e,bool:!1}:{name:e,bool:t}}function f(e,t){return null==t?{name:e,double:0}:{name:e,double:t}}n.d(t,"a",(function(){return i}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var i="4.20.30"},,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return a})),n.d(t,"b",(function(){return o}));var i=n(53),r=null;function s(t){void 0===t&&(t=!0);var n=!1===t?null:r;return n||(typeof globalThis!==i.l&&(n=globalThis),n||typeof self===i.l||(n=self),n||typeof window===i.l||(n=window),n||typeof e===i.l||(n=e),r=n),n}function a(e){throw new TypeError(e)}function o(e){var t=i.c;if(t)return t(e);if(null==e)return{};var n=typeof e;function r(){}return n!==i.j&&n!==i.h&&a("Object prototype may only be an Object:"+e),r[i.k]=e,new r}}).call(this,n(96))},,,function(e,t,n){"use strict";n.r(t),n.d(t,"_ENVTextureLoader",(function(){return r}));var i=n(398);class r{loadCubeData(e,t,n,r,s){if(Array.isArray(e))return;const a=Object(i.a)(e);if(a){t.width=a.width,t.height=a.width;try{Object(i.c)(t,a),Object(i.b)(t,e,a).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()},e=>{null==s||s("Can not upload environment levels",e)})}catch(e){null==s||s("Can not upload environment file",e)}}else s&&s("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}constructor(){this.supportCascades=!1}}},function(e,t,n){"use strict";n.r(t),n.d(t,"_DDSTextureLoader",(function(){return s}));var i=n(331),r=n(390);class s{loadCubeData(e,t,n,s){const a=t.getEngine();let o,l=!1,c=1e3;if(Array.isArray(e))for(let n=0;n<e.length;n++){const i=e[n];o=r.DDSTools.GetDDSInfo(i),t.width=o.width,t.height=o.height,l=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,a._unpackFlipY(o.isCompressed),r.DDSTools.UploadDDSLevels(a,t,i,o,l,6,-1,n),o.isFourCC||1!==o.mipmapCount?c=o.mipmapCount-1:a.generateMipMapsForCubemap(t)}else{const s=e;o=r.DDSTools.GetDDSInfo(s),t.width=o.width,t.height=o.height,n&&(o.sphericalPolynomial=new i.b),l=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,a._unpackFlipY(o.isCompressed),r.DDSTools.UploadDDSLevels(a,t,s,o,l,6),o.isFourCC||1!==o.mipmapCount?c=o.mipmapCount-1:a.generateMipMapsForCubemap(t,!1)}a._setCubeMapTextureParams(t,l,c),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s({isDDS:!0,width:t.width,info:o,data:e,texture:t})}loadData(e,t,n){const i=r.DDSTools.GetDDSInfo(e),s=(i.isRGB||i.isLuminance||i.mipmapCount>1)&&t.generateMipMaps&&Math.max(i.width,i.height)>>i.mipmapCount-1==1;n(i.width,i.height,s,i.isFourCC,()=>{r.DDSTools.UploadDDSLevels(t.getEngine(),t,e,i,s,1)})}constructor(){this.supportCascades=!0}}},function(e,t,n){/*! @license DOMPurify 2.5.7 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/2.5.7/LICENSE */e.exports=function(){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,n){return(t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,n)}function n(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function i(e,r,s){return(i=n()?Reflect.construct:function(e,n,i){var r=[null];r.push.apply(r,n);var s=new(Function.bind.apply(e,r));return i&&t(s,i.prototype),s}).apply(null,arguments)}function r(e){return function(e){if(Array.isArray(e))return s(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return s(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?s(e,void 0):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var a=Object.hasOwnProperty,o=Object.setPrototypeOf,l=Object.isFrozen,c=Object.getPrototypeOf,d=Object.getOwnPropertyDescriptor,h=Object.freeze,u=Object.seal,f=Object.create,m="undefined"!=typeof Reflect&&Reflect,p=m.apply,g=m.construct;p||(p=function(e,t,n){return e.apply(t,n)}),h||(h=function(e){return e}),u||(u=function(e){return e}),g||(g=function(e,t){return i(e,r(t))});var _,v=O(Array.prototype.forEach),E=O(Array.prototype.pop),T=O(Array.prototype.push),S=O(String.prototype.toLowerCase),A=O(String.prototype.toString),b=O(String.prototype.match),I=O(String.prototype.replace),R=O(String.prototype.indexOf),C=O(String.prototype.trim),y=O(RegExp.prototype.test),M=(_=TypeError,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return g(_,t)});function O(e){return function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return p(e,t,i)}}function x(e,t,n){var i;n=null!==(i=n)&&void 0!==i?i:S,o&&o(e,null);for(var r=t.length;r--;){var s=t[r];if("string"==typeof s){var a=n(s);a!==s&&(l(t)||(t[r]=a),s=a)}e[s]=!0}return e}function D(e){var t,n=f(null);for(t in e)!0===p(a,e,[t])&&(n[t]=e[t]);return n}function P(e,t){for(;null!==e;){var n=d(e,t);if(n){if(n.get)return O(n.get);if("function"==typeof n.value)return O(n.value)}e=c(e)}return function(e){return console.warn("fallback value for",e),null}}var L=h(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),N=h(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),F=h(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),w=h(["animate","color-profile","cursor","discard","fedropshadow","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),U=h(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"]),B=h(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),k=h(["#text"]),V=h(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","xmlns","slot"]),G=h(["accent-height","accumulate","additive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),H=h(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),W=h(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),X=u(/\{\{[\w\W]*|[\w\W]*\}\}/gm),j=u(/<%[\w\W]*|[\w\W]*%>/gm),z=u(/\${[\w\W]*}/gm),K=u(/^data-[\-\w.\u00B7-\uFFFF]/),Y=u(/^aria-[\-\w]+$/),q=u(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Q=u(/^(?:\w+script|data):/i),Z=u(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),$=u(/^html$/i),J=u(/^[a-z][.\w]*(-[.\w]+)+$/i),ee=function(){return"undefined"==typeof window?null:window},te=function(t,n){if("object"!==e(t)||"function"!=typeof t.createPolicy)return null;var i=null;n.currentScript&&n.currentScript.hasAttribute("data-tt-policy-suffix")&&(i=n.currentScript.getAttribute("data-tt-policy-suffix"));var r="dompurify"+(i?"#"+i:"");try{return t.createPolicy(r,{createHTML:function(e){return e},createScriptURL:function(e){return e}})}catch(e){return console.warn("TrustedTypes policy "+r+" could not be created."),null}};return function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ee(),i=function(e){return t(e)};if(i.version="2.5.7",i.removed=[],!n||!n.document||9!==n.document.nodeType)return i.isSupported=!1,i;var s=n.document,a=n.document,o=n.DocumentFragment,l=n.HTMLTemplateElement,c=n.Node,d=n.Element,u=n.NodeFilter,f=n.NamedNodeMap,m=void 0===f?n.NamedNodeMap||n.MozNamedAttrMap:f,p=n.HTMLFormElement,g=n.DOMParser,_=n.trustedTypes,O=d.prototype,ne=P(O,"cloneNode"),ie=P(O,"nextSibling"),re=P(O,"childNodes"),se=P(O,"parentNode");if("function"==typeof l){var ae=a.createElement("template");ae.content&&ae.content.ownerDocument&&(a=ae.content.ownerDocument)}var oe=te(_,s),le=oe?oe.createHTML(""):"",ce=a,de=ce.implementation,he=ce.createNodeIterator,ue=ce.createDocumentFragment,fe=ce.getElementsByTagName,me=s.importNode,pe={};try{pe=D(a).documentMode?a.documentMode:{}}catch(e){}var ge={};i.isSupported="function"==typeof se&&de&&void 0!==de.createHTMLDocument&&9!==pe;var _e,ve,Ee=X,Te=j,Se=z,Ae=K,be=Y,Ie=Q,Re=Z,Ce=J,ye=q,Me=null,Oe=x({},[].concat(r(L),r(N),r(F),r(U),r(k))),xe=null,De=x({},[].concat(r(V),r(G),r(H),r(W))),Pe=Object.seal(Object.create(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Le=null,Ne=null,Fe=!0,we=!0,Ue=!1,Be=!0,ke=!1,Ve=!0,Ge=!1,He=!1,We=!1,Xe=!1,je=!1,ze=!1,Ke=!0,Ye=!1,qe="user-content-",Qe=!0,Ze=!1,$e={},Je=null,et=x({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),tt=null,nt=x({},["audio","video","img","source","image","track"]),it=null,rt=x({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),st="http://www.w3.org/1998/Math/MathML",at="http://www.w3.org/2000/svg",ot="http://www.w3.org/1999/xhtml",lt=ot,ct=!1,dt=null,ht=x({},[st,at,ot],A),ut=["application/xhtml+xml","text/html"],ft="text/html",mt=null,pt=a.createElement("form"),gt=function(e){return e instanceof RegExp||e instanceof Function},_t=function(t){mt&&mt===t||(t&&"object"===e(t)||(t={}),t=D(t),_e=_e=-1===ut.indexOf(t.PARSER_MEDIA_TYPE)?ft:t.PARSER_MEDIA_TYPE,ve="application/xhtml+xml"===_e?A:S,Me="ALLOWED_TAGS"in t?x({},t.ALLOWED_TAGS,ve):Oe,xe="ALLOWED_ATTR"in t?x({},t.ALLOWED_ATTR,ve):De,dt="ALLOWED_NAMESPACES"in t?x({},t.ALLOWED_NAMESPACES,A):ht,it="ADD_URI_SAFE_ATTR"in t?x(D(rt),t.ADD_URI_SAFE_ATTR,ve):rt,tt="ADD_DATA_URI_TAGS"in t?x(D(nt),t.ADD_DATA_URI_TAGS,ve):nt,Je="FORBID_CONTENTS"in t?x({},t.FORBID_CONTENTS,ve):et,Le="FORBID_TAGS"in t?x({},t.FORBID_TAGS,ve):{},Ne="FORBID_ATTR"in t?x({},t.FORBID_ATTR,ve):{},$e="USE_PROFILES"in t&&t.USE_PROFILES,Fe=!1!==t.ALLOW_ARIA_ATTR,we=!1!==t.ALLOW_DATA_ATTR,Ue=t.ALLOW_UNKNOWN_PROTOCOLS||!1,Be=!1!==t.ALLOW_SELF_CLOSE_IN_ATTR,ke=t.SAFE_FOR_TEMPLATES||!1,Ve=!1!==t.SAFE_FOR_XML,Ge=t.WHOLE_DOCUMENT||!1,Xe=t.RETURN_DOM||!1,je=t.RETURN_DOM_FRAGMENT||!1,ze=t.RETURN_TRUSTED_TYPE||!1,We=t.FORCE_BODY||!1,Ke=!1!==t.SANITIZE_DOM,Ye=t.SANITIZE_NAMED_PROPS||!1,Qe=!1!==t.KEEP_CONTENT,Ze=t.IN_PLACE||!1,ye=t.ALLOWED_URI_REGEXP||ye,lt=t.NAMESPACE||ot,Pe=t.CUSTOM_ELEMENT_HANDLING||{},t.CUSTOM_ELEMENT_HANDLING&&gt(t.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(Pe.tagNameCheck=t.CUSTOM_ELEMENT_HANDLING.tagNameCheck),t.CUSTOM_ELEMENT_HANDLING&&gt(t.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(Pe.attributeNameCheck=t.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),t.CUSTOM_ELEMENT_HANDLING&&"boolean"==typeof t.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements&&(Pe.allowCustomizedBuiltInElements=t.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),ke&&(we=!1),je&&(Xe=!0),$e&&(Me=x({},r(k)),xe=[],!0===$e.html&&(x(Me,L),x(xe,V)),!0===$e.svg&&(x(Me,N),x(xe,G),x(xe,W)),!0===$e.svgFilters&&(x(Me,F),x(xe,G),x(xe,W)),!0===$e.mathMl&&(x(Me,U),x(xe,H),x(xe,W))),t.ADD_TAGS&&(Me===Oe&&(Me=D(Me)),x(Me,t.ADD_TAGS,ve)),t.ADD_ATTR&&(xe===De&&(xe=D(xe)),x(xe,t.ADD_ATTR,ve)),t.ADD_URI_SAFE_ATTR&&x(it,t.ADD_URI_SAFE_ATTR,ve),t.FORBID_CONTENTS&&(Je===et&&(Je=D(Je)),x(Je,t.FORBID_CONTENTS,ve)),Qe&&(Me["#text"]=!0),Ge&&x(Me,["html","head","body"]),Me.table&&(x(Me,["tbody"]),delete Le.tbody),h&&h(t),mt=t)},vt=x({},["mi","mo","mn","ms","mtext"]),Et=x({},["annotation-xml"]),Tt=x({},["title","style","font","a","script"]),St=x({},N);x(St,F),x(St,w);var At=x({},U);x(At,B);var bt=function(e){var t=se(e);t&&t.tagName||(t={namespaceURI:lt,tagName:"template"});var n=S(e.tagName),i=S(t.tagName);return!!dt[e.namespaceURI]&&(e.namespaceURI===at?t.namespaceURI===ot?"svg"===n:t.namespaceURI===st?"svg"===n&&("annotation-xml"===i||vt[i]):Boolean(St[n]):e.namespaceURI===st?t.namespaceURI===ot?"math"===n:t.namespaceURI===at?"math"===n&&Et[i]:Boolean(At[n]):e.namespaceURI===ot?!(t.namespaceURI===at&&!Et[i])&&!(t.namespaceURI===st&&!vt[i])&&!At[n]&&(Tt[n]||!St[n]):!("application/xhtml+xml"!==_e||!dt[e.namespaceURI]))},It=function(e){T(i.removed,{element:e});try{e.parentNode.removeChild(e)}catch(t){try{e.outerHTML=le}catch(t){e.remove()}}},Rt=function(e,t){try{T(i.removed,{attribute:t.getAttributeNode(e),from:t})}catch(e){T(i.removed,{attribute:null,from:t})}if(t.removeAttribute(e),"is"===e&&!xe[e])if(Xe||je)try{It(t)}catch(e){}else try{t.setAttribute(e,"")}catch(e){}},Ct=function(e){var t,n;if(We)e="<remove></remove>"+e;else{var i=b(e,/^[\r\n\t ]+/);n=i&&i[0]}"application/xhtml+xml"===_e&&lt===ot&&(e='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+e+"</body></html>");var r=oe?oe.createHTML(e):e;if(lt===ot)try{t=(new g).parseFromString(r,_e)}catch(e){}if(!t||!t.documentElement){t=de.createDocument(lt,"template",null);try{t.documentElement.innerHTML=ct?le:r}catch(e){}}var s=t.body||t.documentElement;return e&&n&&s.insertBefore(a.createTextNode(n),s.childNodes[0]||null),lt===ot?fe.call(t,Ge?"html":"body")[0]:Ge?t.documentElement:s},yt=function(e){return he.call(e.ownerDocument||e,e,u.SHOW_ELEMENT|u.SHOW_COMMENT|u.SHOW_TEXT|u.SHOW_PROCESSING_INSTRUCTION|u.SHOW_CDATA_SECTION,null,!1)},Mt=function(e){return e instanceof p&&("string"!=typeof e.nodeName||"string"!=typeof e.textContent||"function"!=typeof e.removeChild||!(e.attributes instanceof m)||"function"!=typeof e.removeAttribute||"function"!=typeof e.setAttribute||"string"!=typeof e.namespaceURI||"function"!=typeof e.insertBefore||"function"!=typeof e.hasChildNodes)},Ot=function(t){return"object"===e(c)?t instanceof c:t&&"object"===e(t)&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName},xt=function(e,t,n){ge[e]&&v(ge[e],(function(e){e.call(i,t,n,mt)}))},Dt=function(e){var t;if(xt("beforeSanitizeElements",e,null),Mt(e))return It(e),!0;if(y(/[\u0080-\uFFFF]/,e.nodeName))return It(e),!0;var n=ve(e.nodeName);if(xt("uponSanitizeElement",e,{tagName:n,allowedTags:Me}),e.hasChildNodes()&&!Ot(e.firstElementChild)&&(!Ot(e.content)||!Ot(e.content.firstElementChild))&&y(/<[/\w]/g,e.innerHTML)&&y(/<[/\w]/g,e.textContent))return It(e),!0;if("select"===n&&y(/<template/i,e.innerHTML))return It(e),!0;if(7===e.nodeType)return It(e),!0;if(Ve&&8===e.nodeType&&y(/<[/\w]/g,e.data))return It(e),!0;if(!Me[n]||Le[n]){if(!Le[n]&&Lt(n)){if(Pe.tagNameCheck instanceof RegExp&&y(Pe.tagNameCheck,n))return!1;if(Pe.tagNameCheck instanceof Function&&Pe.tagNameCheck(n))return!1}if(Qe&&!Je[n]){var r=se(e)||e.parentNode,s=re(e)||e.childNodes;if(s&&r)for(var a=s.length-1;a>=0;--a){var o=ne(s[a],!0);o.__removalCount=(e.__removalCount||0)+1,r.insertBefore(o,ie(e))}}return It(e),!0}return e instanceof d&&!bt(e)?(It(e),!0):"noscript"!==n&&"noembed"!==n&&"noframes"!==n||!y(/<\/no(script|embed|frames)/i,e.innerHTML)?(ke&&3===e.nodeType&&(t=e.textContent,t=I(t,Ee," "),t=I(t,Te," "),t=I(t,Se," "),e.textContent!==t&&(T(i.removed,{element:e.cloneNode()}),e.textContent=t)),xt("afterSanitizeElements",e,null),!1):(It(e),!0)},Pt=function(e,t,n){if(Ke&&("id"===t||"name"===t)&&(n in a||n in pt))return!1;if(we&&!Ne[t]&&y(Ae,t));else if(Fe&&y(be,t));else if(!xe[t]||Ne[t]){if(!(Lt(e)&&(Pe.tagNameCheck instanceof RegExp&&y(Pe.tagNameCheck,e)||Pe.tagNameCheck instanceof Function&&Pe.tagNameCheck(e))&&(Pe.attributeNameCheck instanceof RegExp&&y(Pe.attributeNameCheck,t)||Pe.attributeNameCheck instanceof Function&&Pe.attributeNameCheck(t))||"is"===t&&Pe.allowCustomizedBuiltInElements&&(Pe.tagNameCheck instanceof RegExp&&y(Pe.tagNameCheck,n)||Pe.tagNameCheck instanceof Function&&Pe.tagNameCheck(n))))return!1}else if(it[t]);else if(y(ye,I(n,Re,"")));else if("src"!==t&&"xlink:href"!==t&&"href"!==t||"script"===e||0!==R(n,"data:")||!tt[e])if(Ue&&!y(Ie,I(n,Re,"")));else if(n)return!1;return!0},Lt=function(e){return"annotation-xml"!==e&&b(e,Ce)},Nt=function(t){var n,r,s,a;xt("beforeSanitizeAttributes",t,null);var o=t.attributes;if(o){var l={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:xe};for(a=o.length;a--;){var c=n=o[a],d=c.name,h=c.namespaceURI;if(r="value"===d?n.value:C(n.value),s=ve(d),l.attrName=s,l.attrValue=r,l.keepAttr=!0,l.forceKeepAttr=void 0,xt("uponSanitizeAttribute",t,l),r=l.attrValue,!l.forceKeepAttr&&(Rt(d,t),l.keepAttr))if(Be||!y(/\/>/i,r)){ke&&(r=I(r,Ee," "),r=I(r,Te," "),r=I(r,Se," "));var u=ve(t.nodeName);if(Pt(u,s,r))if(!Ye||"id"!==s&&"name"!==s||(Rt(d,t),r=qe+r),Ve&&y(/((--!?|])>)|<\/(style|title)/i,r))Rt(d,t);else{if(oe&&"object"===e(_)&&"function"==typeof _.getAttributeType)if(h);else switch(_.getAttributeType(u,s)){case"TrustedHTML":r=oe.createHTML(r);break;case"TrustedScriptURL":r=oe.createScriptURL(r)}try{h?t.setAttributeNS(h,d,r):t.setAttribute(d,r),Mt(t)?It(t):E(i.removed)}catch(e){}}}else Rt(d,t)}xt("afterSanitizeAttributes",t,null)}},Ft=function e(t){var n,i=yt(t);for(xt("beforeSanitizeShadowDOM",t,null);n=i.nextNode();)xt("uponSanitizeShadowNode",n,null),Dt(n)||(n.content instanceof o&&e(n.content),Nt(n));xt("afterSanitizeShadowDOM",t,null)};return i.sanitize=function(t){var r,a,l,d,h,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if((ct=!t)&&(t="\x3c!--\x3e"),"string"!=typeof t&&!Ot(t)){if("function"!=typeof t.toString)throw M("toString is not a function");if("string"!=typeof(t=t.toString()))throw M("dirty is not a string, aborting")}if(!i.isSupported){if("object"===e(n.toStaticHTML)||"function"==typeof n.toStaticHTML){if("string"==typeof t)return n.toStaticHTML(t);if(Ot(t))return n.toStaticHTML(t.outerHTML)}return t}if(He||_t(u),i.removed=[],"string"==typeof t&&(Ze=!1),Ze){if(t.nodeName){var f=ve(t.nodeName);if(!Me[f]||Le[f])throw M("root node is forbidden and cannot be sanitized in-place")}}else if(t instanceof c)1===(a=(r=Ct("\x3c!----\x3e")).ownerDocument.importNode(t,!0)).nodeType&&"BODY"===a.nodeName||"HTML"===a.nodeName?r=a:r.appendChild(a);else{if(!Xe&&!ke&&!Ge&&-1===t.indexOf("<"))return oe&&ze?oe.createHTML(t):t;if(!(r=Ct(t)))return Xe?null:ze?le:""}r&&We&&It(r.firstChild);for(var m=yt(Ze?t:r);l=m.nextNode();)3===l.nodeType&&l===d||Dt(l)||(l.content instanceof o&&Ft(l.content),Nt(l),d=l);if(d=null,Ze)return t;if(Xe){if(je)for(h=ue.call(r.ownerDocument);r.firstChild;)h.appendChild(r.firstChild);else h=r;return(xe.shadowroot||xe.shadowrootmod)&&(h=me.call(s,h,!0)),h}var p=Ge?r.outerHTML:r.innerHTML;return Ge&&Me["!doctype"]&&r.ownerDocument&&r.ownerDocument.doctype&&r.ownerDocument.doctype.name&&y($,r.ownerDocument.doctype.name)&&(p="<!DOCTYPE "+r.ownerDocument.doctype.name+">\n"+p),ke&&(p=I(p,Ee," "),p=I(p,Te," "),p=I(p,Se," ")),oe&&ze?oe.createHTML(p):p},i.setConfig=function(e){_t(e),He=!0},i.clearConfig=function(){mt=null,He=!1},i.isValidAttribute=function(e,t,n){mt||_t({});var i=ve(e),r=ve(t);return Pt(i,r,n)},i.addHook=function(e,t){"function"==typeof t&&(ge[e]=ge[e]||[],T(ge[e],t))},i.removeHook=function(e){if(ge[e])return E(ge[e])},i.removeHooks=function(e){ge[e]&&(ge[e]=[])},i.removeAllHooks=function(){ge={}},i}()}()},function(e,t,n){"use strict";n.r(t),n.d(t,"_ExrTextureLoader",(function(){return G}));var i,r,s=n(36),a=n(26);!function(e){e[e.NO_COMPRESSION=0]="NO_COMPRESSION",e[e.RLE_COMPRESSION=1]="RLE_COMPRESSION",e[e.ZIPS_COMPRESSION=2]="ZIPS_COMPRESSION",e[e.ZIP_COMPRESSION=3]="ZIP_COMPRESSION",e[e.PIZ_COMPRESSION=4]="PIZ_COMPRESSION",e[e.PXR24_COMPRESSION=5]="PXR24_COMPRESSION"}(i||(i={})),function(e){e[e.INCREASING_Y=0]="INCREASING_Y",e[e.DECREASING_Y=1]="DECREASING_Y"}(r||(r={}));const o=function(){const e=new ArrayBuffer(4),t=new Float32Array(e),n=new Uint32Array(e),i=new Uint32Array(512),r=new Uint32Array(512);for(let e=0;e<256;++e){const t=e-127;t<-27?(i[e]=0,i[256|e]=32768,r[e]=24,r[256|e]=24):t<-14?(i[e]=1024>>-t-14,i[256|e]=1024>>-t-14|32768,r[e]=-t-1,r[256|e]=-t-1):t<=15?(i[e]=t+15<<10,i[256|e]=t+15<<10|32768,r[e]=13,r[256|e]=13):t<128?(i[e]=31744,i[256|e]=64512,r[e]=24,r[256|e]=24):(i[e]=31744,i[256|e]=64512,r[e]=13,r[256|e]=13)}const s=new Uint32Array(2048),a=new Uint32Array(64),o=new Uint32Array(64);for(let e=1;e<1024;++e){let t=e<<13,n=0;for(;0==(8388608&t);)t<<=1,n-=8388608;t&=-8388609,n+=947912704,s[e]=t|n}for(let e=1024;e<2048;++e)s[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)a[e]=e<<23;a[31]=1199570944,a[32]=2147483648;for(let e=33;e<63;++e)a[e]=2147483648+(e-32<<23);a[63]=3347054592;for(let e=1;e<64;++e)32!==e&&(o[e]=1024);return{floatView:t,uint32View:n,baseTable:i,shiftTable:r,mantissaTable:s,exponentTable:a,offsetTable:o}}();function l(e,t){const n=new Uint8Array(e);let i=0;for(;0!=n[t.value+i];)i+=1;const r=(new TextDecoder).decode(n.slice(t.value,t.value+i));return t.value=t.value+i+1,r}function c(e,t){const n=e.getInt32(t.value,!0);return t.value+=4,n}function d(e,t){const n=e.getUint32(t.value,!0);return t.value+=4,n}function h(e,t){const n=e.getUint8(t.value);return t.value+=1,n}function u(e,t){const n=e.getUint16(t.value,!0);return t.value+=2,n}function f(e,t){const n=e[t.value];return t.value+=1,n}function m(e,t){let n;return n="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,n}function p(e,t){const n=e.getFloat32(t.value,!0);return t.value+=4,n}function g(e,t){return function(e){const t=(31744&e)>>10,n=1023&e;return(e>>15?-1:1)*(t?31===t?n?NaN:1/0:Math.pow(2,t-15)*(1+n/1024):n/1024*6103515625e-14)}(u(e,t))}function _(e,t){return function(e){if(Math.abs(e)>65504)throw new Error("Value out of range.Consider using float instead of half-float.");e=Object(a.a)(e,-65504,65504),o.floatView[0]=e;const t=o.uint32View[0],n=t>>23&511;return o.baseTable[n]+((8388607&t)>>o.shiftTable[n])}(p(e,t))}function v(e,t,n,i){switch(n){case"string":case"stringvector":case"iccProfile":return function(e,t,n){const i=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+n));return t.value=t.value+n,i}(e.buffer,t,i);case"chlist":return function(e,t,n){const i=t.value,r=[];for(;t.value<i+n-1;){const n=l(e.buffer,t),i=c(e,t),s=h(e,t);t.value+=3;const a=c(e,t),o=c(e,t);r.push({name:n,pixelType:i,pLinear:s,xSampling:a,ySampling:o})}return t.value+=1,r}(e,t,i);case"chromaticities":return function(e,t){return{redX:p(e,t),redY:p(e,t),greenX:p(e,t),greenY:p(e,t),blueX:p(e,t),blueY:p(e,t),whiteX:p(e,t),whiteY:p(e,t)}}(e,t);case"compression":return function(e,t){return h(e,t)}(e,t);case"box2i":return function(e,t){return{xMin:c(e,t),yMin:c(e,t),xMax:c(e,t),yMax:c(e,t)}}(e,t);case"lineOrder":return function(e,t){const n=h(e,t);return r[n]}(e,t);case"float":return p(e,t);case"v2f":return function(e,t){return[p(e,t),p(e,t)]}(e,t);case"v3f":return function(e,t){return[p(e,t),p(e,t),p(e,t)]}(e,t);case"int":return c(e,t);case"rational":return function(e,t){return[c(e,t),d(e,t)]}(e,t);case"timecode":return function(e,t){return[d(e,t),d(e,t)]}(e,t);case"preview":return t.value+=i,"skipped";default:return void(t.value+=i)}}function E(e){for(let t=1;t<e.length;t++){const n=e[t-1]+e[t]-128;e[t]=n}}function T(e,t){let n=0,i=Math.floor((e.length+1)/2),r=0;const s=e.length-1;for(;!(r>s||(t[r++]=e[n++],r>s));)t[r++]=e[i++]}function S(e,t,n,i,r){for(;n<e;)t=t<<8|f(i,r),n+=8;return{l:t>>(n-=e)&(1<<e)-1,c:t,lc:n}}function A(e,t,n,i){return{c:e=e<<8|f(n,i),lc:t+=8}}function b(e,t,n,i,r,s,a,o,l){if(e==t){if(i<8){const e=A(n,i,r,s);n=e.c,i=e.lc}let e=n>>(i-=8);if(e=new Uint8Array([e])[0],o.value+e>l)return null;const t=a[o.value-1];for(;e-- >0;)a[o.value++]=t}else{if(!(o.value<l))return null;a[o.value++]=e}return{c:n,lc:i}}const I=new Array(59);function R(e){return 63&e}function C(e){return e>>6}function y(e,t,n,i,r,s){const a=n.value,o=d(t,n),l=d(t,n);n.value+=4;const c=d(t,n);if(n.value+=4,o<0||o>=65537||l<0||l>=65537)throw new Error("Wrong HUF_ENCSIZE");const h=new Array(65537),u=new Array(16384);if(function(e){for(let t=0;t<16384;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}(u),function(e,t,n,i,r,s){const a=t;let o=0,l=0;for(;i<=r;i++){if(a.value-t.value>n)return;let c=S(6,o,l,e,a);const d=c.l;if(o=c.c,l=c.lc,s[i]=d,63==d){if(a.value-t.value>n)throw new Error("Error in HufUnpackEncTable");c=S(8,o,l,e,a);let d=c.l+6;if(o=c.c,l=c.lc,i+d>r+1)throw new Error("Error in HufUnpackEncTable");for(;d--;)s[i++]=0;i--}else if(d>=59){let e=d-59+2;if(i+e>r+1)throw new Error("Error in HufUnpackEncTable");for(;e--;)s[i++]=0;i--}}!function(e){for(let e=0;e<=58;++e)I[e]=0;for(let t=0;t<65537;++t)I[e[t]]+=1;let t=0;for(let e=58;e>0;--e){const n=t+I[e]>>1;I[e]=t,t=n}for(let t=0;t<65537;++t){const n=e[t];n>0&&(e[t]=n|I[n]++<<6)}}(s)}(e,n,i-(n.value-a),o,l,h),c>8*(i-(n.value-a)))throw new Error("Wrong hufUncompress");!function(e,t,n,i){for(;t<=n;t++){const n=C(e[t]),r=R(e[t]);if(n>>r)throw new Error("Invalid table entry");if(r>14){const e=i[n>>r-14];if(e.len)throw new Error("Invalid table entry");if(e.lit++,e.p){const t=e.p;e.p=new Array(e.lit);for(let n=0;n<e.lit-1;++n)e.p[n]=t[n]}else e.p=new Array(1);e.p[e.lit-1]=t}else if(r){let e=0;for(let s=1<<14-r;s>0;s--){const s=i[(n<<14-r)+e];if(s.len||s.p)throw new Error("Invalid table entry");s.len=r,s.lit=t,e++}}}}(h,o,l,u),function(e,t,n,i,r,s,a,o,l){let c=0,d=0;const h=a,u=Math.trunc(i.value+(r+7)/8);for(;i.value<u;){let r=A(c,d,n,i);for(c=r.c,d=r.lc;d>=14;){const a=t[c>>d-14&16383];if(a.len){d-=a.len;const e=b(a.lit,s,c,d,n,i,o,l,h);e&&(c=e.c,d=e.lc)}else{if(!a.p)throw new Error("hufDecode issues");let t;for(t=0;t<a.lit;t++){const f=R(e[a.p[t]]);for(;d<f&&i.value<u;)r=A(c,d,n,i),c=r.c,d=r.lc;if(d>=f&&C(e[a.p[t]])==(c>>d-f&(1<<f)-1)){d-=f;const e=b(a.p[t],s,c,d,n,i,o,l,h);e&&(c=e.c,d=e.lc);break}}if(t==a.lit)throw new Error("HufDecode issues")}}}const f=8-r&7;for(c>>=f,d-=f;d>0;){const e=t[c<<14-d&16383];if(!e.len)throw new Error("HufDecode issues");{d-=e.len;const t=b(e.lit,s,c,d,n,i,o,l,h);t&&(c=t.c,d=t.lc)}}}(h,u,e,n,c,l,s,r,{value:0})}function M(e){return 65535&e}function O(e){const t=M(e);return t>32767?t-65536:t}function x(e,t){const n=O(e),i=O(t),r=n+(1&i)+(i>>1);return{a:r,b:r-i}}function D(e,t){const n=M(e),i=M(t),r=n-(i>>1)&65535;return{a:i+r-32768&65535,b:r}}function P(e,t,n,i,r,s,a){const o=a<16384,l=n>r?r:n;let c,d,h=1;for(;h<=l;)h<<=1;for(h>>=1,c=h,h>>=1;h>=1;){d=0;const a=d+s*(r-c),l=s*h,u=s*c,f=i*h,m=i*c;let p,g,_,v;for(;d<=a;d+=u){let r=d;const s=d+i*(n-c);for(;r<=s;r+=m){const n=r+f,i=r+l,s=i+f;if(o){let a=x(e[r+t],e[i+t]);p=a.a,_=a.b,a=x(e[n+t],e[s+t]),g=a.a,v=a.b,a=x(p,g),e[r+t]=a.a,e[n+t]=a.b,a=x(_,v),e[i+t]=a.a,e[s+t]=a.b}else{let a=D(e[r+t],e[i+t]);p=a.a,_=a.b,a=D(e[n+t],e[s+t]),g=a.a,v=a.b,a=D(p,g),e[r+t]=a.a,e[n+t]=a.b,a=D(_,v),e[i+t]=a.a,e[s+t]=a.b}}if(n&h){const n=r+l;let i;i=o?x(e[r+t],e[n+t]):D(e[r+t],e[n+t]),p=i.a,e[n+t]=i.b,e[r+t]=p}}if(r&h){let r=d;const s=d+i*(n-c);for(;r<=s;r+=m){const n=r+f;let i;i=o?x(e[r+t],e[n+t]):D(e[r+t],e[n+t]),p=i.a,e[n+t]=i.b,e[r+t]=p}}c=h,h>>=1}return d}function L(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function N(e){const t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),n=new Uint8Array(function(e){let t=e.byteLength;const n=new Array;let i=0;const r=new DataView(e);for(;t>0;){const e=r.getInt8(i++);if(e<0){const s=-e;t-=s+1;for(let e=0;e<s;e++)n.push(r.getUint8(i++))}else{const s=e;t-=2;const a=r.getUint8(i++);for(let e=0;e<s+1;e++)n.push(a)}}return n}(t)),i=new Uint8Array(n.length);return E(n),T(n,i),new DataView(i.buffer)}function F(e){const t=e.array.slice(e.offset.value,e.offset.value+e.size),n=fflate.unzlibSync(t),i=new Uint8Array(n.length);return E(n),T(n,i),new DataView(i.buffer)}function w(e){const t=e.array.slice(e.offset.value,e.offset.value+e.size),n=fflate.unzlibSync(t),i=e.lines*e.channels*e.width,r=1==e.type?new Uint16Array(i):new Uint32Array(i);let s=0,a=0;const o=new Array(4);for(let t=0;t<e.lines;t++)for(let t=0;t<e.channels;t++){let t=0;switch(e.type){case 1:o[0]=s,o[1]=o[0]+e.width,s=o[1]+e.width;for(let i=0;i<e.width;++i)t+=n[o[0]++]<<8|n[o[1]++],r[a]=t,a++;break;case 2:o[0]=s,o[1]=o[0]+e.width,o[2]=o[1]+e.width,s=o[2]+e.width;for(let i=0;i<e.width;++i)t+=n[o[0]++]<<24|n[o[1]++]<<16|n[o[2]++]<<8,r[a]=t,a++}}return new DataView(r.buffer)}function U(e){const t=e.viewer,n={value:e.offset.value},i=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),r=new Uint8Array(8192);let s=0;const a=new Array(e.channels);for(let t=0;t<e.channels;t++)a[t]={},a[t].start=s,a[t].end=a[t].start,a[t].nx=e.width,a[t].ny=e.lines,a[t].size=e.type,s+=a[t].nx*a[t].ny*a[t].size;const o=u(t,n),l=u(t,n);if(l>=8192)throw new Error("Wrong PIZ_COMPRESSION BITMAP_SIZE");if(o<=l)for(let e=0;e<l-o+1;e++)r[e+o]=h(t,n);const c=new Uint16Array(65536),f=function(e,t){let n=0;for(let i=0;i<65536;++i)(0==i||e[i>>3]&1<<(7&i))&&(t[n++]=i);const i=n-1;for(;n<65536;)t[n++]=0;return i}(r,c),m=d(t,n);y(e.array,t,n,m,i,s);for(let t=0;t<e.channels;++t){const e=a[t];for(let n=0;n<a[t].size;++n)P(i,e.start+n,e.nx,e.size,e.ny,e.nx*e.size,f)}!function(e,t,n){for(let i=0;i<n;++i)t[i]=e[t[i]]}(c,i,s);let p=0;const g=new Uint8Array(i.buffer.byteLength);for(let t=0;t<e.lines;t++)for(let t=0;t<e.channels;t++){const e=a[t],n=e.nx*e.size,r=new Uint8Array(i.buffer,2*e.end,2*n);g.set(r,p),p+=2*n,e.end+=n}return new DataView(g.buffer)}var B,k=n(312);!function(e){e[e.Float=0]="Float",e[e.HalfFloat=1]="HalfFloat"}(B||(B={}));class V{}V.DefaultOutputType=B.HalfFloat,V.FFLATEUrl="https://unpkg.com/fflate@0.8.2";class G{loadCubeData(e,t,n,i,r){throw".exr not supported in Cube."}async loadData(e,t,n){const r=new DataView(e.buffer),a={value:0},o=function(e,t){if(20000630!=e.getUint32(0,!0))throw new Error("Incorrect OpenEXR format");const n=e.getUint8(4),i=e.getUint8(5),r={singleTile:!!(2&i),longName:!!(4&i),deepFormat:!!(8&i),multiPart:!!(16&i)};t.value=8;const a={};let o=!0;for(;o;){const n=l(e.buffer,t);if(n){const i=l(e.buffer,t),r=v(e,t,i,d(e,t));void 0===r?s.a.Warn(`Unknown header attribute type ${i}'.`):a[n]=r}else o=!1}if(0!=(-5&i))throw new Error("Unsupported file format");return{version:n,spec:r,...a}}(r,a),h=await async function(e,t,n,r){const s={size:0,viewer:t,array:new Uint8Array(t.buffer),offset:n,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,channelLineOffsets:{},scanOrder:()=>0,bytesPerLine:0,outLineWidth:0,lines:0,scanlineBlockSize:0,inputSize:null,type:0,uncompress:null,getter:()=>0,format:5,outputChannels:0,decodeChannels:{},blockCount:null,byteArray:null,linearSpace:!1,textureType:0};switch(e.compression){case i.NO_COMPRESSION:s.lines=1,s.uncompress=L;break;case i.RLE_COMPRESSION:s.lines=1,s.uncompress=N;break;case i.ZIPS_COMPRESSION:s.lines=1,s.uncompress=F,await k.b.LoadScriptAsync(V.FFLATEUrl);break;case i.ZIP_COMPRESSION:s.lines=16,s.uncompress=F,await k.b.LoadScriptAsync(V.FFLATEUrl);break;case i.PIZ_COMPRESSION:s.lines=32,s.uncompress=U;break;case i.PXR24_COMPRESSION:s.lines=16,s.uncompress=w,await k.b.LoadScriptAsync(V.FFLATEUrl);break;default:throw new Error(i[e.compression]+" is unsupported")}s.scanlineBlockSize=s.lines;const a={};for(const t of e.channels)switch(t.name){case"Y":case"R":case"G":case"B":case"A":a[t.name]=!0,s.type=t.pixelType}let o=!1;if(a.R&&a.G&&a.B)o=!a.A,s.outputChannels=4,s.decodeChannels={R:0,G:1,B:2,A:3};else{if(!a.Y)throw new Error("EXRLoader.parse: file contains unsupported data channels.");s.outputChannels=1,s.decodeChannels={Y:0}}if(1===s.type)switch(r){case B.Float:s.getter=g,s.inputSize=2;break;case B.HalfFloat:s.getter=u,s.inputSize=2}else{if(2!==s.type)throw new Error("Unsupported pixelType "+s.type+" for "+e.compression);switch(r){case B.Float:s.getter=p,s.inputSize=4;break;case B.HalfFloat:s.getter=_,s.inputSize=4}}s.blockCount=s.height/s.scanlineBlockSize;for(let e=0;e<s.blockCount;e++)m(t,n);const l=s.width*s.height*s.outputChannels;switch(r){case B.Float:s.byteArray=new Float32Array(l),s.textureType=1,o&&s.byteArray.fill(1,0,l);break;case B.HalfFloat:s.byteArray=new Uint16Array(l),s.textureType=2,o&&s.byteArray.fill(15360,0,l);break;default:throw new Error("Unsupported type: "+r)}let c=0;for(const t of e.channels)void 0!==s.decodeChannels[t.name]&&(s.channelLineOffsets[t.name]=c*s.width),c+=2*t.pixelType;return s.bytesPerLine=s.width*c,s.outLineWidth=s.width*s.outputChannels,"INCREASING_Y"===e.lineOrder?s.scanOrder=e=>e:s.scanOrder=e=>s.height-1-e,4==s.outputChannels?(s.format=5,s.linearSpace=!0):(s.format=6,s.linearSpace=!1),s}(o,r,a,V.DefaultOutputType);!function(e,t,n,i){const r={value:0};for(let s=0;s<e.height/e.scanlineBlockSize;s++){const a=c(n,i)-t.dataWindow.yMin;e.size=d(n,i),e.lines=a+e.scanlineBlockSize>e.height?e.height-a:e.scanlineBlockSize;const o=e.size<e.lines*e.bytesPerLine&&e.uncompress?e.uncompress(e):L(e);i.value+=e.size;for(let n=0;n<e.scanlineBlockSize;n++){const i=s*e.scanlineBlockSize,a=n+e.scanOrder(i);if(a>=e.height)continue;const l=n*e.bytesPerLine,c=(e.height-1-a)*e.outLineWidth;for(let n=0;n<e.channels;n++){const i=t.channels[n].name,s=e.channelLineOffsets[i],a=e.decodeChannels[i];if(void 0!==a){r.value=l+s;for(let t=0;t<e.width;t++){const n=c+t*e.outputChannels+a;e.byteArray&&(e.byteArray[n]=e.getter(o,r))}}}}}}(h,o,r,a),n(o.dataWindow.xMax-o.dataWindow.xMin+1,o.dataWindow.yMax-o.dataWindow.yMin+1,t.generateMipMaps,!1,()=>{const e=t.getEngine();t.format=o.format,t.type=h.textureType,t.invertY=!1,t._gammaSpace=!o.linearSpace,h.byteArray&&e._uploadDataToTextureDirectly(t,h.byteArray,0,0,void 0,!0)})}constructor(){this.supportCascades=!1}}},function(e,t,n){"use strict";n.r(t),n.d(t,"_BasisTextureLoader",(function(){return g}));var i,r=n(312),s=n(314),a=n(52);function o(){let e=null;function t(e,t,n,i,r){const s=e.getImageTranscodedSizeInBytes(t,n,i);let a=new Uint8Array(s);return e.transcodeImage(a,t,n,i,1,0)?(r&&(a=function(e,t,n,i){const r=new Uint16Array(4),s=new Uint16Array(n*i),a=n/4,o=i/4;for(let t=0;t<o;t++)for(let i=0;i<a;i++){const o=0+8*(t*a+i);r[0]=e[o]|e[o+1]<<8,r[1]=e[o+2]|e[o+3]<<8,r[2]=(2*(31&r[0])+1*(31&r[1]))/3|(2*(2016&r[0])+1*(2016&r[1]))/3&2016|(2*(63488&r[0])+1*(63488&r[1]))/3&63488,r[3]=(2*(31&r[1])+1*(31&r[0]))/3|(2*(2016&r[1])+1*(2016&r[0]))/3&2016|(2*(63488&r[1])+1*(63488&r[0]))/3&63488;for(let a=0;a<4;a++){const l=e[o+4+a];let c=(4*t+a)*n+4*i;s[c++]=r[3&l],s[c++]=r[l>>2&3],s[c++]=r[l>>4&3],s[c++]=r[l>>6&3]}}return s}(a,0,e.getImageWidth(t,n)+3&-4,e.getImageHeight(t,n)+3&-4)),a):null}onmessage=n=>{if("init"===n.data.action){if(n.data.url)try{importScripts(n.data.url)}catch(e){postMessage({action:"error",error:e})}e||(e=BASIS({wasmBinary:n.data.wasmBinary})),null!==e&&e.then(e=>{BASIS=e,e.initializeBasis(),postMessage({action:"init"})})}else if("transcode"===n.data.action){const e=n.data.config,i=n.data.imageData,r=new BASIS.BasisFile(i),s=function(e){const t=e.getHasAlpha(),n=e.getNumImages(),i=[];for(let t=0;t<n;t++){const n={levels:[]},r=e.getNumLevels(t);for(let i=0;i<r;i++){const r={width:e.getImageWidth(t,i),height:e.getImageHeight(t,i)};n.levels.push(r)}i.push(n)}return{hasAlpha:t,images:i}}(r);let a=n.data.ignoreSupportedFormats?null:function(e,t){let n=null;return e.supportedCompressionFormats&&(n=e.supportedCompressionFormats.astc?10:e.supportedCompressionFormats.bc7?6:e.supportedCompressionFormats.s3tc?t.hasAlpha?3:2:e.supportedCompressionFormats.pvrtc?t.hasAlpha?9:8:e.supportedCompressionFormats.etc2?1:e.supportedCompressionFormats.etc1?0:14),n}(n.data.config,s),o=!1;null===a&&(o=!0,a=s.hasAlpha?3:2);let l=!0;r.startTranscoding()||(l=!1);const c=[];for(let n=0;n<s.images.length&&l;n++){const i=s.images[n];if(void 0===e.loadSingleImage||e.loadSingleImage===n){let s=i.levels.length;!1===e.loadMipmapLevels&&(s=1);for(let e=0;e<s;e++){const s=i.levels[e],d=t(r,n,e,a,o);if(!d){l=!1;break}s.transcodedPixels=d,c.push(s.transcodedPixels.buffer)}}}r.close(),r.delete(),o&&(a=-1),l?postMessage({action:"transcode",success:l,id:n.data.id,fileInfo:s,format:a},c):postMessage({action:"transcode",success:l,id:n.data.id})}}}!function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(i||(i={}));const l={JSModuleURL:r.b._DefaultCdnUrl+"/basisTranscoder/1/basis_transcoder.js",WasmModuleURL:r.b._DefaultCdnUrl+"/basisTranscoder/1/basis_transcoder.wasm"};let c=null,d=null,h=0;const u=(e,t)=>{const n=e instanceof ArrayBuffer?new Uint8Array(e):e;return new Promise((e,i)=>{(c||(c=new Promise((e,t)=>{d?e(d):r.b.LoadFileAsync(r.b.GetBabylonScriptURL(l.WasmModuleURL)).then(n=>{if("function"!=typeof URL)return t("Basis transcoder requires an environment with a URL constructor");const i=URL.createObjectURL(new Blob([`(${o})()`],{type:"application/javascript"}));d=new Worker(i),function(e,t,n){return new Promise((i,s)=>{const a=t=>{"init"===t.data.action?(e.removeEventListener("message",a),i(e)):"error"===t.data.action&&s(t.data.error||"error initializing worker")};e.addEventListener("message",a),e.postMessage({action:"init",url:n?r.b.GetBabylonScriptURL(n):void 0,wasmBinary:t},[t])})}(d,n,l.JSModuleURL).then(e,t)}).catch(t)})),c).then(()=>{const r=h++,s=t=>{"transcode"===t.data.action&&t.data.id===r&&(d.removeEventListener("message",s),t.data.success?e(t.data):i("Transcode is not supported on this device"))};d.addEventListener("message",s);const a=new Uint8Array(n.byteLength);a.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength)),d.postMessage({action:"transcode",id:r,imageData:a,config:t,ignoreSupportedFormats:!1},[a.buffer])},e=>{i(e)})})},f=(e,t)=>{var n;let i=null===(n=t._gl)||void 0===n?void 0:n.TEXTURE_2D;var r;e.isCube&&(i=null===(r=t._gl)||void 0===r?void 0:r.TEXTURE_CUBE_MAP),t._bindTextureDirectly(i,e,!0)},m=(e,t)=>{const n=e.getEngine();for(let o=0;o<t.fileInfo.images.length;o++){const l=t.fileInfo.images[o].levels[0];if(e._invertVScale=e.invertY,-1===t.format||t.format===i.cTFRGB565)if(e.type=10,e.format=4,!n._features.basisNeedsPOT||Math.log2(l.width)%1==0&&Math.log2(l.height)%1==0)e._invertVScale=!e.invertY,e.width=l.width+3&-4,e.height=l.height+3&-4,e.samplingMode=2,f(e,n),n._uploadDataToTextureDirectly(e,new Uint16Array(l.transcodedPixels.buffer),o,0,4,!0);else{const t=new a.a(n,2);e._invertVScale=e.invertY,t.type=10,t.format=4,t.width=l.width+3&-4,t.height=l.height+3&-4,f(t,n),n._uploadDataToTextureDirectly(t,new Uint16Array(l.transcodedPixels.buffer),o,0,4,!0),n._rescaleTexture(t,e,n.scenes[0],n._getInternalFormat(4),()=>{n._releaseTexture(t),f(e,n)})}else{e.width=l.width,e.height=l.height,e.generateMipMaps=t.fileInfo.images[o].levels.length>1;const i=p.GetInternalFormatFromBasisFormat(t.format,n);e.format=i,f(e,n),t.fileInfo.images[o].levels.forEach((t,r)=>{n._uploadCompressedDataToTextureDirectly(e,i,t.width,t.height,t.transcodedPixels,o,r)}),!n._features.basisNeedsPOT||Math.log2(e.width)%1==0&&Math.log2(e.height)%1==0||(r.b.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=s.a.CLAMP_ADDRESSMODE,e._cachedWrapV=s.a.CLAMP_ADDRESSMODE)}}},p={JSModuleURL:l.JSModuleURL,WasmModuleURL:l.WasmModuleURL,GetInternalFormatFromBasisFormat:(e,t)=>{let n;switch(e){case i.cTFETC1:n=36196;break;case i.cTFBC1:n=33776;break;case i.cTFBC4:n=33779;break;case i.cTFASTC_4x4:n=37808;break;case i.cTFETC2:n=37496;break;case i.cTFBC7:n=36492}if(void 0===n)throw"The chosen Basis transcoder format is not currently supported";return n},TranscodeAsync:u,LoadTextureFromTranscodeResult:m};Object.defineProperty(p,"JSModuleURL",{get:function(){return l.JSModuleURL},set:function(e){l.JSModuleURL=e}}),Object.defineProperty(p,"WasmModuleURL",{get:function(){return l.WasmModuleURL},set:function(e){l.WasmModuleURL=e}});class g{loadCubeData(e,t,n,i,s){if(Array.isArray(e))return;const a=t.getEngine().getCaps(),o={supportedCompressionFormats:{etc1:!!a.etc1,s3tc:!!a.s3tc,pvrtc:!!a.pvrtc,etc2:!!a.etc2,astc:!!a.astc,bc7:!!a.bptc}};u(e,o).then(e=>{const n=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;m(t,e),t.getEngine()._setCubeMapTextureParams(t,n),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),i&&i()}).catch(e=>{r.b.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,s&&s(e)})}loadData(e,t,n){const i=t.getEngine().getCaps(),s={supportedCompressionFormats:{etc1:!!i.etc1,s3tc:!!i.s3tc,pvrtc:!!i.pvrtc,etc2:!!i.etc2,astc:!!i.astc,bc7:!!i.bptc}};u(e,s).then(e=>{const i=e.fileInfo.images[0].levels[0],r=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;n(i.width,i.height,r,-1!==e.format,()=>{m(t,e)})}).catch(e=>{r.b.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),r.b.Warn("Failed to transcode Basis file: "+e),n(0,0,!1,!1,()=>{},!0)})}constructor(){this.supportCascades=!1}}},function(e,t,n){"use strict";n.r(t),n.d(t,"_HDRTextureLoader",(function(){return l}));var i=n(84);class r{static ConvertPanoramaToCubemap(e,t,n,i,r=!1){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*n*3)throw"ConvertPanoramaToCubemap: input size is wrong";return{front:this.CreateCubemapTexture(i,this.FACE_FRONT,e,t,n,r),back:this.CreateCubemapTexture(i,this.FACE_BACK,e,t,n,r),left:this.CreateCubemapTexture(i,this.FACE_LEFT,e,t,n,r),right:this.CreateCubemapTexture(i,this.FACE_RIGHT,e,t,n,r),up:this.CreateCubemapTexture(i,this.FACE_UP,e,t,n,r),down:this.CreateCubemapTexture(i,this.FACE_DOWN,e,t,n,r),size:i,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,n,i,r,s=!1){const a=new ArrayBuffer(e*e*4*3),o=new Float32Array(a),l=s?Math.max(1,Math.round(i/4/e)):1,c=1/l,d=c*c,h=t[1].subtract(t[0]).scale(c/e),u=t[3].subtract(t[2]).scale(c/e),f=1/e;let m=0;for(let s=0;s<e;s++)for(let a=0;a<l;a++){let a=t[0],p=t[2];for(let t=0;t<e;t++)for(let c=0;c<l;c++){const l=p.subtract(a).scale(m).add(a);l.normalize();const c=this.CalcProjectionSpherical(l,n,i,r);o[s*e*3+3*t+0]+=c.r*d,o[s*e*3+3*t+1]+=c.g*d,o[s*e*3+3*t+2]+=c.b*d,a=a.add(h),p=p.add(u)}m+=f*c}return o}static CalcProjectionSpherical(e,t,n,i){let r=Math.atan2(e.z,e.x);const s=Math.acos(e.y);for(;r<-Math.PI;)r+=2*Math.PI;for(;r>Math.PI;)r-=2*Math.PI;let a=r/Math.PI;const o=s/Math.PI;a=.5*a+.5;let l=Math.round(a*n);l<0?l=0:l>=n&&(l=n-1);let c=Math.round(o*i);c<0?c=0:c>=i&&(c=i-1);const d=i-c-1;return{r:t[d*n*3+3*l+0],g:t[d*n*3+3*l+1],b:t[d*n*3+3*l+2]}}}function s(e,t,n,i,r,s){r>0?(r=function(e,t){return t>1023?1*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?1*Math.pow(2,-1074)*Math.pow(2,t+1074):1*Math.pow(2,t)}(0,r-136),e[s+0]=t*r,e[s+1]=n*r,e[s+2]=i*r):(e[s+0]=0,e[s+1]=0,e[s+2]=0)}function a(e,t){let n="",i="";for(let r=t;r<e.length-t&&(i=String.fromCharCode(e[r]),"\n"!=i);r++)n+=i;return n}function o(e,t){let n=t.height;const i=t.width;let r,a,o,l,c,d=t.dataPosition;const h=new ArrayBuffer(t.width*t.height*4*3),u=new Float32Array(h);for(;n>0;){for(c=0;c<t.width;c++)r=e[d++],a=e[d++],o=e[d++],l=e[d++],s(u,r,a,o,l,(t.height-n)*i*3+3*c);n--}return u}r.FACE_LEFT=[new i.e(-1,-1,-1),new i.e(1,-1,-1),new i.e(-1,1,-1),new i.e(1,1,-1)],r.FACE_RIGHT=[new i.e(1,-1,1),new i.e(-1,-1,1),new i.e(1,1,1),new i.e(-1,1,1)],r.FACE_FRONT=[new i.e(1,-1,-1),new i.e(1,-1,1),new i.e(1,1,-1),new i.e(1,1,1)],r.FACE_BACK=[new i.e(-1,-1,1),new i.e(-1,-1,-1),new i.e(-1,1,1),new i.e(-1,1,-1)],r.FACE_DOWN=[new i.e(1,1,-1),new i.e(1,1,1),new i.e(-1,1,-1),new i.e(-1,1,1)],r.FACE_UP=[new i.e(-1,-1,-1),new i.e(-1,-1,1),new i.e(1,-1,-1),new i.e(1,-1,1)];class l{loadCubeData(){throw".hdr not supported in Cube."}loadData(e,t,n){const i=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=function(e){let t=0,n=0,i=a(e,0);if("#"!=i[0]||"?"!=i[1])throw"Bad HDR Format.";let r=!1,s=!1,o=0;do{o+=i.length+1,i=a(e,o),"FORMAT=32-bit_rle_rgbe"==i?s=!0:0==i.length&&(r=!0)}while(!r);if(!s)throw"HDR Bad header format, unsupported FORMAT";o+=i.length+1,i=a(e,o);const l=/^-Y (.*) \+X (.*)$/g.exec(i);if(!l||l.length<3)throw"HDR Bad header format, no size";if(n=parseInt(l[2]),t=parseInt(l[1]),n<8||n>32767)throw"HDR Bad header format, unsupported size";return o+=i.length+1,{height:t,width:n,dataPosition:o}}(i),l=function(e,t){return function(e,t){let n=t.height;const i=t.width;let r,a,l,c,d,h=t.dataPosition,u=0,f=0,m=0;const p=new ArrayBuffer(4*i),g=new Uint8Array(p),_=new ArrayBuffer(t.width*t.height*4*3),v=new Float32Array(_);for(;n>0;){if(r=e[h++],a=e[h++],l=e[h++],c=e[h++],2!=r||2!=a||128&l||t.width<8||t.width>32767)return o(e,t);if((l<<8|c)!=i)throw"HDR Bad header format, wrong scan line width";for(u=0,m=0;m<4;m++)for(f=(m+1)*i;u<f;)if(r=e[h++],a=e[h++],r>128){if(d=r-128,0==d||d>f-u)throw"HDR Bad Format, bad scanline data (run)";for(;d-- >0;)g[u++]=a}else{if(d=r,0==d||d>f-u)throw"HDR Bad Format, bad scanline data (non-run)";if(g[u++]=a,--d>0)for(let t=0;t<d;t++)g[u++]=e[h++]}for(m=0;m<i;m++)r=g[m],a=g[m+i],l=g[m+2*i],c=g[m+3*i],s(v,r,a,l,c,(t.height-n)*i*3+3*m);n--}return v}(e,t)}(i,r),c=r.width*r.height,d=new Float32Array(4*c);for(let e=0;e<c;e+=1)d[4*e]=l[3*e],d[4*e+1]=l[3*e+1],d[4*e+2]=l[3*e+2],d[4*e+3]=1;n(r.width,r.height,t.generateMipMaps,!1,()=>{const e=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,e._uploadDataToTextureDirectly(t,d)})}constructor(){this.supportCascades=!1}}},function(e,t,n){"use strict";n.r(t),n.d(t,"_IESTextureLoader",(function(){return o}));var i=n(26);function r(e){return e.split(" ").filter(e=>""!==e).map(e=>parseFloat(e))}function s(e,t,n){for(;n.length!==t;){const t=r(e.lines[e.index++]);n.push(...t)}}function a(e,t,n){let r=0,s=0,a=0,o=0,l=0,c=0;for(let t=0;t<e.numberOfHorizontalAngles-1;t++)if(n<e.horizontalAngles[t+1]||t===e.numberOfHorizontalAngles-2){s=t,a=e.horizontalAngles[t],o=e.horizontalAngles[t+1];break}for(let n=0;n<e.numberOfVerticalAngles-1;n++)if(t<e.verticalAngles[n+1]||n===e.numberOfVerticalAngles-2){r=n,l=e.verticalAngles[n],c=e.verticalAngles[n+1];break}const d=o-a,h=c-l;if(0===h)return 0;const u=0===d?0:(n-a)/d,f=(t-l)/h,m=0===d?s:s+1,p=Object(i.d)(e.candelaValues[s][r],e.candelaValues[m][r],u),g=Object(i.d)(e.candelaValues[s][r+1],e.candelaValues[m][r+1],u);return Object(i.d)(p,g,f)}class o{loadCubeData(){throw".ies not supported in Cube."}loadData(e,t,n){const i=function(e){const t={lines:new TextDecoder("utf-8").decode(e).split("\n"),index:0},n={version:t.lines[0],candelaValues:[],horizontalAngles:[],verticalAngles:[],numberOfHorizontalAngles:0,numberOfVerticalAngles:0};for(t.index=1;t.lines.length>0&&!t.lines[t.index].includes("TILT=");)t.index++;t.lines[t.index].includes("INCLUDE"),t.index++;const i=r(t.lines[t.index++]);n.numberOfLights=i[0],n.lumensPerLamp=i[1],n.candelaMultiplier=i[2],n.numberOfVerticalAngles=i[3],n.numberOfHorizontalAngles=i[4],n.photometricType=i[5],n.unitsType=i[6],n.width=i[7],n.length=i[8],n.height=i[9];const o=r(t.lines[t.index++]);n.ballastFactor=o[0],n.fileGenerationType=o[1],n.inputWatts=o[2];for(let e=0;e<n.numberOfHorizontalAngles;e++)n.candelaValues[e]=[];s(t,n.numberOfVerticalAngles,n.verticalAngles),s(t,n.numberOfHorizontalAngles,n.horizontalAngles);for(let e=0;e<n.numberOfHorizontalAngles;e++)s(t,n.numberOfVerticalAngles,n.candelaValues[e]);let l=-1;for(let e=0;e<n.numberOfHorizontalAngles;e++)for(let t=0;t<n.numberOfVerticalAngles;t++)n.candelaValues[e][t]*=n.candelaValues[e][t]*n.candelaMultiplier*n.ballastFactor*n.fileGenerationType,l=Math.max(l,n.candelaValues[e][t]);if(l>0)for(let e=0;e<n.numberOfHorizontalAngles;e++)for(let t=0;t<n.numberOfVerticalAngles;t++)n.candelaValues[e][t]/=l;const c=new Float32Array(64800),d=n.horizontalAngles[0],h=n.horizontalAngles[n.numberOfHorizontalAngles-1];for(let e=0;e<64800;e++){let t=e%360;const i=Math.floor(e/360);h-d!=0&&(t<d||t>=h)&&(t%=2*h,t>h&&(t=2*h-t)),c[i+180*t]=a(n,i,t)}return{width:180,height:1,data:c}}(new Uint8Array(e.buffer,e.byteOffset,e.byteLength));n(i.width,i.height,!1,!1,()=>{const e=t.getEngine();t.type=1,t.format=6,t._gammaSpace=!1,e._uploadDataToTextureDirectly(t,i.data)})}constructor(){this.supportCascades=!1}}},function(e,t,n){"use strict";n.r(t),n.d(t,"_TGATextureLoader",(function(){return o}));var i=n(36);function r(e){let t=0;return{id_length:e[t++],colormap_type:e[t++],image_type:e[t++],colormap_index:e[t++]|e[t++]<<8,colormap_length:e[t++]|e[t++]<<8,colormap_size:e[t++],origin:[e[t++]|e[t++]<<8,e[t++]|e[t++]<<8],width:e[t++]|e[t++]<<8,height:e[t++]|e[t++]<<8,pixel_size:e[t++],flags:e[t++]}}function s(e,t){if(t.length<19)return void i.a.Error("Unable to load TGA file - Not enough data to contain header");let n=18;const s=r(t);if(s.id_length+n>t.length)return void i.a.Error("Unable to load TGA file - Not enough data");n+=s.id_length;let o,l=!1,c=!1,d=!1;switch(s.image_type){case 9:l=!0;case 1:c=!0;break;case 10:l=!0;case 2:break;case 11:l=!0;case 3:d=!0}const h=s.pixel_size>>3,u=s.width*s.height*h;let f,m,p,g,_,v,E;if(c&&(f=t.subarray(n,n+=s.colormap_length*(s.colormap_size>>3))),l){let e,i,r;o=new Uint8Array(u);let s=0;const a=new Uint8Array(h);for(;n<u&&s<u;)if(e=t[n++],i=1+(127&e),128&e){for(r=0;r<h;++r)a[r]=t[n++];for(r=0;r<i;++r)o.set(a,s+r*h);s+=h*i}else{for(i*=h,r=0;r<i;++r)o[s+r]=t[n++];s+=i}}else o=t.subarray(n,n+=c?s.width*s.height:u);switch((48&s.flags)>>4){default:case 2:m=0,g=1,E=s.width,p=0,_=1,v=s.height;break;case 0:m=0,g=1,E=s.width,p=s.height-1,_=-1,v=-1;break;case 3:m=s.width-1,g=-1,E=-1,p=0,_=1,v=s.height;break;case 1:m=s.width-1,g=-1,E=-1,p=s.height-1,_=-1,v=-1}const T="_getImageData"+(d?"Grey":"")+s.pixel_size+"bits",S=a[T](s,f,o,p,_,v,m,g,E);e.getEngine()._uploadDataToTextureDirectly(e,S)}const a={GetTGAHeader:r,UploadContent:s,_getImageData8bits:function(e,t,n,i,r,s,a,o,l){const c=n,d=t,h=e.width,u=e.height;let f,m,p,g=0;const _=new Uint8Array(h*u*4);for(p=i;p!==s;p+=r)for(m=a;m!==l;m+=o,g++)f=c[g],_[4*(m+h*p)+3]=255,_[4*(m+h*p)+2]=d[3*f+0],_[4*(m+h*p)+1]=d[3*f+1],_[4*(m+h*p)+0]=d[3*f+2];return _},_getImageData16bits:function(e,t,n,i,r,s,a,o,l){const c=n,d=e.width,h=e.height;let u,f,m,p=0;const g=new Uint8Array(d*h*4);for(m=i;m!==s;m+=r)for(f=a;f!==l;f+=o,p+=2){u=c[p+0]+(c[p+1]<<8);const e=255*((31744&u)>>10)/31|0,t=255*((992&u)>>5)/31|0,n=255*(31&u)/31|0;g[4*(f+d*m)+0]=e,g[4*(f+d*m)+1]=t,g[4*(f+d*m)+2]=n,g[4*(f+d*m)+3]=32768&u?0:255}return g},_getImageData24bits:function(e,t,n,i,r,s,a,o,l){const c=n,d=e.width,h=e.height;let u,f,m=0;const p=new Uint8Array(d*h*4);for(f=i;f!==s;f+=r)for(u=a;u!==l;u+=o,m+=3)p[4*(u+d*f)+3]=255,p[4*(u+d*f)+2]=c[m+0],p[4*(u+d*f)+1]=c[m+1],p[4*(u+d*f)+0]=c[m+2];return p},_getImageData32bits:function(e,t,n,i,r,s,a,o,l){const c=n,d=e.width,h=e.height;let u,f,m=0;const p=new Uint8Array(d*h*4);for(f=i;f!==s;f+=r)for(u=a;u!==l;u+=o,m+=4)p[4*(u+d*f)+2]=c[m+0],p[4*(u+d*f)+1]=c[m+1],p[4*(u+d*f)+0]=c[m+2],p[4*(u+d*f)+3]=c[m+3];return p},_getImageDataGrey8bits:function(e,t,n,i,r,s,a,o,l){const c=n,d=e.width,h=e.height;let u,f,m,p=0;const g=new Uint8Array(d*h*4);for(m=i;m!==s;m+=r)for(f=a;f!==l;f+=o,p++)u=c[p],g[4*(f+d*m)+0]=u,g[4*(f+d*m)+1]=u,g[4*(f+d*m)+2]=u,g[4*(f+d*m)+3]=255;return g},_getImageDataGrey16bits:function(e,t,n,i,r,s,a,o,l){const c=n,d=e.width,h=e.height;let u,f,m=0;const p=new Uint8Array(d*h*4);for(f=i;f!==s;f+=r)for(u=a;u!==l;u+=o,m+=2)p[4*(u+d*f)+0]=c[m+0],p[4*(u+d*f)+1]=c[m+0],p[4*(u+d*f)+2]=c[m+0],p[4*(u+d*f)+3]=c[m+1];return p}};class o{loadCubeData(){throw".env not supported in Cube."}loadData(e,t,n){const i=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),a=r(i);n(a.width,a.height,t.generateMipMaps,!1,()=>{s(t,i)})}constructor(){this.supportCascades=!1}}},,,,,,,,,,,,,,,function(e,t,n){"use strict";var i;n.d(t,"a",(function(){return i})),function(e){e.USGOV_DOD="https://pf.events.data.microsoft.com/OneCollector/1.0/",e.USGOV_DOJ="https://tb.events.data.microsoft.com/OneCollector/1.0/",e.PUBLIC="https://browser.events.data.microsoft.com/OneCollector/1.0/",e.CUSTOMER_CONTENT="",e.EUDB="https://eu-office.events.data.microsoft.com/OneCollector/1.0/"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(59),r=n(92),s=n(222);function a(e){return"number"==typeof e}var o=function(){function e(e,t){this._sinkName=e,this._telemetrySink=t,this.name="EventThrottler",this._totalEventsInLastInterval=0,this._singleEventInLastInterval={},this._eventThrottleReported={},this._lastIntervalStart=Date.now(),this._maxNamedEventsPerSecond={}}return e.prototype.setSingleEventThrottle=function(e){this._maxSingleEventPerSecond=e},e.prototype.setTotalEventThrottle=function(e){this._maxTotalEventsPerSecond=e},e.prototype.setNamedEventThrottle=function(e,t){this._maxNamedEventsPerSecond[e]=t},e.prototype.processEvent=function(e){var t=e.eventName;if("Office.Telemetry.OTelJS.EventThrottled"===t)return!0;var n=!0;return Date.now()-this._lastIntervalStart>1e3&&(this._lastIntervalStart=Date.now(),this._totalEventsInLastInterval=0,this._singleEventInLastInterval={}),this._singleEventInLastInterval[t]=this._singleEventInLastInterval[t]+1||1,t in this._maxNamedEventsPerSecond?n=this.applyThrottle(this._singleEventInLastInterval[t],this._maxNamedEventsPerSecond[t],"MaxNamedEventsPerSecond",t):a(this._maxSingleEventPerSecond)&&(n=this.applyThrottle(this._singleEventInLastInterval[t],this._maxSingleEventPerSecond,"MaxSingleEventsPerSecond",t)),a(this._maxTotalEventsPerSecond)&&(this._totalEventsInLastInterval++,n&&(n=this.applyThrottle(this._totalEventsInLastInterval,this._maxTotalEventsPerSecond,"MaxTotalEventsPerSecond",t))),n},e.prototype.applyThrottle=function(e,t,n,a){return!(e>t&&(e===t+1&&this._telemetrySink&&!this._eventThrottleReported[a]&&(this._eventThrottleReported[a]=!0,this._telemetrySink.sendTelemetryEvent({eventName:"Office.Telemetry.OTelJS.EventThrottled",telemetryProperties:{ariaTenantToken:s.d,nexusTenantToken:1723},eventFlags:{diagnosticLevel:110},dataFields:[Object(i.d)("SinkName",this._sinkName||""),Object(i.d)("ThrottledEvent.Name",a),Object(i.c)(n,t)]})),Object(r.b)(2,1,(function(){return"1DS Sink Event Throttle: Exceeded ".concat(t," ").concat(n,": ").concat(a)})),1))},e}()},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(59),r=function(){function e(){this.name="Sampler",this.sampleRate=.02}return e.prototype.enableWithIdentifier=function(e,t){return!("string"!=typeof t||t.length<4||(this.samplingValue=function(e){return function(e){for(var t=5381,n=0;n<e.length;n++)t=(t<<5)+t+e.charCodeAt(n);return t>>>0}(e)%1e3/1e3}(t),this.samplingKey=e,0))},e.prototype.enableWithSamplingValue=function(e,t){return!(isNaN(t)||t<0||t>=1||(this.samplingValue=t,this.samplingKey=e,0))},e.prototype.enableWithRandomValue=function(){var e=new Uint32Array(1);return!("object"!=typeof window||!window.crypto||(window.crypto.getRandomValues(e),this.samplingValue=e[0]%1e3/1e3,this.samplingKey="Random",0))},e.prototype.setSampleRate=function(e){return e>=0&&e<=1&&(this.sampleRate=e,!0)},e.prototype.getSamplingValue=function(){return this.samplingValue},e.prototype.isMeasuresEnabled=function(){return void 0===this.samplingValue||this.samplingValue<this.sampleRate},e.prototype.processEvent=function(e){var t=e.eventFlags.samplingPolicy;return void 0===this.samplingValue||void 0===t||(1===t?!!this.isMeasuresEnabled()&&(this.addSampleRateField(e,this.sampleRate,this.samplingValue),!0):2!==t&&(this.addSampleRateField(e,1,this.samplingValue),!0))},e.prototype.addSampleRateField=function(e,t,n){e.eventContract||(e.eventContract={name:"",dataFields:[]});var r=e.eventContract.dataFields;r.push(Object(i.b)("Event.SampleRate",t)),r.push(Object(i.b)("Session.SamplingValue",n)),this.samplingKey&&r.push(Object(i.d)("Session.SamplingKey",this.samplingKey)),r.push(Object(i.a)("Session.MeasuresEnabled",this.isMeasuresEnabled()))},e}()},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(152);const r=["https://res.cdn.office.net","https://res-sdf.cdn.office.net","https://res-dod.cdn.office.net","https://res-gcch.cdn.office.net","https://res-v-sdf.cdn.office.net","https://res-1.cdn.office.net","https://res-1.cdn.partner.office365.cn","https://res-h1.cdn.office.net","https://res-2.cdn.office.net","https://res-2-sdf.cdn.office.net","https://res-2-dev.cdn.officeppe.net","https://outlook-1-cdn.azureedge.eaglex.ic.gov","https://outlook-1-cdn.azureedge.microsoft.scloud","https://content.lifecycle.officeppe.net/","https://word-edit.officeapps.live.com","https://ppc-word-edit.officeapps.live.com","https://ffc-word-edit.officeapps.live.com","https://fus1-word-edit.officeapps.live.com","https://fil1-word-edit.officeapps.live.com","https://fin1-word-edit.officeapps.live.com","https://eurppc-word-edit.officeapps.live.com","https://ffc-word-view.officeapps.live.com","https://ppc-word-view.officeapps.live.com","https://wordwebclientbuilds.blob.core.windows.net"],s=new RegExp("https?://(localhost|local\\.teams\\.(office|live)\\.com)(:|/|$)"),a=("urlOriginPolicy",Object(i.a)("urlOriginPolicy",{createScriptURL:e=>{const{origin:t}=new URL(e,document.baseURI);if((e=>r.includes(e)||s.test(e))(t))return e;throw new Error("TrustedTypes policy does not allow loading URL: "+e)}},void 0))},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(152);Object(i.a)("emptyStringPolicyHTML",{createHTML:e=>""},void 0);const r=Object(i.a)("emptyStringPolicyURL",{createScriptURL:e=>""},void 0)},function(e,t,n){"use strict";n.r(t),n.d(t,"SamplingPolicy",(function(){return i.e})),n.d(t,"ActivityAggregationMode",(function(){return i.a})),n.d(t,"DnmInterval",(function(){return i.d})),n.d(t,"AllowedPartA",(function(){return i.b})),n.d(t,"CustomerContentType",(function(){return i.c})),n.d(t,"ValueType",(function(){return i.g})),n.d(t,"TelemetryFactoryGlobal",(function(){return i.f})),n.d(t,"logUserAction",(function(){return r.f})),n.d(t,"logActivity",(function(){return r.d})),n.d(t,"ScorecardAggregateMethod",(function(){return r.a})),n.d(t,"logActivityForExperiment",(function(){return r.e})),n.d(t,"sendTelemetryEvent",(function(){return r.p})),n.d(t,"sendActivityEvent",(function(){return r.i})),n.d(t,"sendDirectNumericEvent",(function(){return r.k})),n.d(t,"sendCustomerContentEvent",(function(){return r.j})),n.d(t,"sendOtelEvent",(function(){return r.o})),n.d(t,"sendOtelCustomerContent",(function(){return r.m})),n.d(t,"sendOtelDirectNumeric",(function(){return r.n})),n.d(t,"sendUserActionEvent",(function(){return r.q})),n.d(t,"addNamespaceMapping",(function(){return r.b})),n.d(t,"setDNMToken",(function(){return r.r})),n.d(t,"flushAsync",(function(){return r.c})),n.d(t,"setEnabledState",(function(){return r.s})),n.d(t,"registerShutdownHook",(function(){return r.h})),n.d(t,"shutdown",(function(){return r.t})),n.d(t,"registerEventHandler",(function(){return r.g})),n.d(t,"sendEventDirectlyToHandler",(function(){return r.l})),n.d(t,"disableSessionLevelTelemetry",(function(){return s.b})),n.d(t,"hasValidLogger",(function(){return s.c})),n.d(t,"setWorkerEnabledState",(function(){return s.e})),n.d(t,"startOtelWorker",(function(){return s.f})),n.d(t,"addSink",(function(){return s.a})),n.d(t,"isMeasuresEnabled",(function(){return s.d})),n.d(t,"TelemetryFactory",(function(){return a.a})),n.d(t,"convertTelemetryEventToOtelTelemetryEvent",(function(){return o.e})),n.d(t,"AriaTenantDefinitions",(function(){return l.a})),n.d(t,"DnmAriaTenantDefinitions",(function(){return l.b})),n.d(t,"TelemetryFullGlobal",(function(){return ti})),n.d(t,"initializeEventProcessor",(function(){return Yn})),n.d(t,"processEvent",(function(){return Jn}));var i=n(79),r=n(78),s=n(136),a=n(223),o=n(107),l=n(181);class c{fireEvent(e){this._listeners.forEach(t=>t(e))}addListener(e){e&&this._listeners.push(e)}removeListener(e){this._listeners=this._listeners.filter(t=>t!==e)}getListenerCount(){return this._listeners.length}constructor(){this._listeners=[]}}var d=n(9),h=n(7),u=n(276),f=n(38),m=n(92),p=n(222),g=n(133),_=n(53),v=n(245),E=n(45),T=n(315),S=n(151),A=n(179),b=null,I=null,R=null,C=null;function y(e,t){var n=!1;if(e){try{if(!(n=t in e)){var i=e[_.k];i&&(n=t in i)}}catch(e){}if(!n)try{var r=new e;n=!Object(S.w)(r[t])}catch(e){}}return n}function M(e){var t=Object(v.a)();return t&&t[e]?t[e]:"window"===e&&O()?window:null}function O(){return Boolean(typeof window===_.j&&window)}function x(){return O()?window:M("window")}function D(){return Boolean(typeof document===_.j&&document)?document:M("document")}function P(){return Boolean(typeof navigator===_.j&&navigator)}function L(){return P()?navigator:M("navigator")}function N(e){return typeof location===_.j&&location?location:M("location")}function F(){return Boolean(typeof JSON===_.j&&JSON||null!==M("JSON"))}function w(){return F()?JSON||M("JSON"):null}function U(){var e=L();return!(!e||!e.product)&&"ReactNative"===e.product}function B(){var e=L();if(e&&(e[E.ab]!==I||null===b)){var t=((I=e[E.ab])||A.e)[E.V]();b=Object(S.H)(t,"msie")||Object(S.H)(t,"trident/")}return b}function k(e){var t=Object[_.k].toString[E.c](e),n=A.e;return"[object Error]"===t?n="{ stack: '"+e.stack+"', message: '"+e.message+"', name: '"+e[E.D]+"'":F()&&(n=w().stringify(e)),t+n}function V(){return null===C&&(C=P()&&Boolean(L().sendBeacon)),C}function G(e){var t=!1;try{t=!!M("fetch");var n=M("Request");t&&e&&n&&(t=y(n,"keepalive"))}catch(e){}return t}function H(){var e=!1;try{e=!!M("XMLHttpRequest")}catch(e){}return e}var W,X=["eventsSent","eventsDiscarded","eventsSendRequest","perfEvent"],j=null;function z(e,t){return function(){var n=arguments,i=K(t);if(i){var r=i.listener;r&&r[e]&&r[e][E.b](r,n)}}}function K(e){var t,n=j;return n||!0===e.disableDbgExt||(n=j||((t=M("Microsoft"))&&(j=t.ApplicationInsights),j)),n?n.ChromeDbgExt:null}function Y(e){return e?'"'+e[E.J](/\"/g,A.e)+'"':A.e}function q(e,t){var n=typeof console!==_.l?console:M("console");if(n){var i="log";n[e]&&(i=e),Object(S.o)(n[i])&&n[i](t)}}var Q=function(){function e(e,t,n,i){void 0===n&&(n=!1),this[E.C]=e,this[E.B]=(n?"AI: ":"AI (Internal): ")+e;var r=A.e;F()&&(r=w().stringify(i));var s=(t?" message:"+Y(t):A.e)+(i?" props:"+Y(r):A.e);this[E.B]+=s}return e.dataType="MessageData",e}(),Z=function(){function e(t){this.identifier="DiagnosticLogger",this.queue=[];var n,i,r,s,a=0,o={};Object(T.a)(e,this,(function(e){function l(t,n){if(!(a>=r)){var s=!0,l="AITR_"+n[E.C];if(o[l]?s=!1:o[l]=!0,s&&(t<=i&&(e.queue[E.H](n),a++,c(1===t?"error":"warn",n)),a===r)){var d="Internal events throttle limit per PageView reached for this app.",h=new Q(23,d,!1);e.queue[E.H](h),1===t?e[A.f](d):e[A.p](d)}}}function c(e,n){var i=K(t||{});i&&i[E.h]&&i[E.h](e,n)}!function(e){n=Object(S.g)(e.loggingLevelConsole,0),i=Object(S.g)(e.loggingLevelTelemetry,1),r=Object(S.g)(e.maxMessageLimit,25),s=Object(S.g)(e.enableDebug,Object(S.g)(e[E.i],!1))}(t||{}),e.consoleLoggingLevel=function(){return n},e.telemetryLoggingLevel=function(){return i},e.maxInternalMessageLimit=function(){return r},e[E.i]=function(){return s},e.throwInternal=function(t,i,r,a,d){void 0===d&&(d=!1);var h=new Q(i,r,d,a);if(s)throw k(h);var u=1===t?A.f:A.p;if(Object(S.w)(h[E.B]))c("throw"+(1===t?"Critical":"Warning"),h);else{if(d){var f=+h[E.C];!o[f]&&n>=t&&(e[u](h[E.B]),o[f]=!0)}else n>=t&&e[u](h[E.B]);l(t,h)}},e[A.p]=function(e){q("warn",e),c("warning",e)},e[A.f]=function(e){q("error",e),c("error",e)},e.resetInternalMessageCount=function(){a=0,o={}},e[E.A]=l}))}return e.__ieDyn=1,e}();function $(e){return e||new Z}function J(e,t,n,i,r,s){void 0===s&&(s=!1),$(e).throwInternal(t,n,i,r,s)}function ee(e,t){$(e)[A.p](t)}var te=null,ne=null,ie=null,re=D(),se={},ae={};function oe(e){return!e||e.isEnabled()}function le(e,t){return!!(t&&e&&Object(S.k)(e.ignoreCookies))&&-1!==e.ignoreCookies[E.r](t)}function ce(e,t){var n,i=function(e){var t=e[E.f]=e[E.f]||{};if(Object(S.G)(t,"domain",e.cookieDomain,S.p,S.q),Object(S.G)(t,"path",e.cookiePath||"/",null,S.q),Object(S.q)(t.enabled)){var n=void 0;Object(S.w)(e.isCookieUseDisabled)||(n=!e.isCookieUseDisabled),Object(S.w)(e.disableCookiesUsage)||(n=!e.disableCookiesUsage),t.enabled=n}return t}(e||ae),r=i.path||"/",s=i.domain,a=!1!==i.enabled,o=((n={isEnabled:function(){var e=a&&de(t),n=ae._ckMgr;return e&&n&&o!==n&&(e=oe(n)),e}})[E.L]=function(e){a=!1!==e},n.set=function(e,t,n,a,l){var c,d=!1;if(oe(o)&&!function(e,t){return!!(t&&e&&Object(S.k)(e.blockedCookies)&&-1!==e.blockedCookies[E.r](t))||le(e,t)}(i,e)){var h={},u=Object(S.K)(t||A.e),f=u[E.r](";");if(-1!==f&&(u=Object(S.K)(t[E.S](0,f)),h=he(t[E.S](f+1))),Object(S.G)(h,"domain",a||s,S.u,S.w),!Object(S.q)(n)){var m=B();if(Object(S.w)(h.expires)){var p=Object(S.e)()+1e3*n;if(p>0){var g=new Date;g.setTime(p),Object(S.G)(h,"expires",ue(g,m?"toGMTString":"toUTCString")||ue(g,m?"toGMTString":"toUTCString")||A.e,S.u)}}m||Object(S.G)(h,"max-age",A.e+n,null,S.w)}var _=N();_&&"https:"===_.protocol&&(Object(S.G)(h,"secure",null,null,S.w),null===ne&&(c=(L()||{})[E.ab],ne=!(Object(S.t)(c)&&(Object(S.H)(c,"CPU iPhone OS 12")||Object(S.H)(c,"iPad; CPU OS 12")||Object(S.H)(c,"Macintosh; Intel Mac OS X 10_14")&&Object(S.H)(c,"Version/")&&Object(S.H)(c,"Safari")||Object(S.H)(c,"Macintosh; Intel Mac OS X 10_14")&&Object(S.I)(c,"AppleWebKit/605.1.15 (KHTML, like Gecko)")||Object(S.H)(c,"Chrome/5")||Object(S.H)(c,"Chrome/6")||Object(S.H)(c,"UnrealEngine")&&!Object(S.H)(c,"Chrome")||Object(S.H)(c,"UCBrowser/12")||Object(S.H)(c,"UCBrowser/11")))),ne&&Object(S.G)(h,"SameSite","None",null,S.w)),Object(S.G)(h,"path",l||r,null,S.w),(i.setCookie||pe)(e,fe(u,h)),d=!0}return d},n.get=function(e){var t=A.e;return oe(o)&&!le(i,e)&&(t=(i.getCookie||me)(e)),t},n.del=function(e,t){var n=!1;return oe(o)&&(n=o.purge(e,t)),n},n.purge=function(e,n){var r,s=!1;if(de(t)){var a=((r={}).path=n||"/",r.expires="Thu, 01 Jan 1970 00:00:01 GMT",r);B()||(a["max-age"]="0"),(i.delCookie||pe)(e,fe(A.e,a)),s=!0}return s},n);return o._ckMgr=o,o}function de(e){if(null===te){te=!1;try{te=void 0!==(re||{}).cookie}catch(t){J(e,2,68,"Cannot access document.cookie - "+Object(S.h)(t),{exception:k(t)})}}return te}function he(e){var t={};if(e&&e[E.x]){var n=Object(S.K)(e)[E.P](";");Object(S.a)(n,(function(e){if(e=Object(S.K)(e||A.e)){var n=e[E.r]("=");-1===n?t[e]=null:t[Object(S.K)(e[E.S](0,n))]=Object(S.K)(e[E.S](n+1))}}))}return t}function ue(e,t){return Object(S.o)(e[t])?e[t]():null}function fe(e,t){var n=e||A.e;return Object(S.A)(t,(function(e,t){n+="; "+e+(Object(S.q)(t)?A.e:"="+t)})),n}function me(e){var t=A.e;if(re){var n=re.cookie||A.e;ie!==n&&(se=he(n),ie=n),t=Object(S.K)(se[e]||A.e)}return t}function pe(e,t){re&&(re.cookie=e+"="+t)}var ge=!1,_e=123456789,ve=987654321;function Ee(e){e<0&&(e>>>=0),_e=123456789+e&4294967295,ve=987654321-e&4294967295,ge=!0}function Te(){try{var e=2147483647&Object(S.e)();Ee((4294967296*Math.random()^e)+e)}catch(e){}}function Se(e){var t=0,n=M("crypto")||M("msCrypto");return n&&n.getRandomValues&&(t=4294967295&n.getRandomValues(new Uint32Array(1))[0]),0===t&&B()&&(ge||Te(),t=4294967295&Ae()),0===t&&(t=Math.floor(4294967296*Math.random()|0)),e||(t>>>=0),t}function Ae(e){var t=((ve=36969*(65535&ve)+(ve>>16)&4294967295)<<16)+(65535&(_e=18e3*(65535&_e)+(_e>>16)&4294967295))>>>0&4294967295|0;return e||(t>>>=0),t}function be(e){void 0===e&&(e=22);for(var t=Se()>>>0,n=0,i=A.e;i[E.x]<e;)n++,i+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(63&t),t>>>=6,5===n&&(t=(Se()<<2&4294967295|3&t)>>>0,n=0);return i}var Ie=_.d,Re="."+be(6),Ce=0;function ye(e){return 1===e[E.E]||9===e[E.E]||!+e[E.E]}function Me(e,t){return void 0===t&&(t=!1),Object(S.x)(e+Ce+++(t?".2.8.16":A.e)+Re)}function Oe(e){var t={id:Me("_aiData-"+(e||A.e)+".2.8.16"),accept:function(e){return ye(e)},get:function(e,n,i,r){var s=e[t.id];return s?s[Object(S.x)(n)]:(r&&((s=function(e,t){var n=t[e.id];if(!n){n={};try{ye(t)&&(function(e,t,n){if(Ie)try{return Ie(e,t,{value:n,enumerable:!1,configurable:!0}),!0}catch(e){}return!1}(t,e.id,n)||(t[e.id]=n))}catch(e){}}return n}(t,e))[Object(S.x)(n)]=i),i)},kill:function(e,t){if(e&&e[t])try{delete e[t]}catch(e){}}};return t}var xe=Me("aiEvtPageHide"),De=Me("aiEvtPageShow"),Pe=/\.[\.]+/g,Le=/[\.]+$/,Ne=1,Fe=Oe("events"),we=/^([^.]*)(?:\.(.+)|)/;function Ue(e){return e&&e[E.J]?e[E.J](/^[\s\.]+|(?=[\s\.])[\.\s]+$/g,A.e):e}function Be(e,t){var n;if(t){var i=A.e;Object(S.k)(t)?(i=A.e,Object(S.a)(t,(function(e){(e=Ue(e))&&("."!==e[0]&&(e="."+e),i+=e)}))):i=Ue(t),i&&("."!==i[0]&&(i="."+i),e=(e||A.e)+i)}var r=we.exec(e||A.e)||[];return(n={})[E.Y]=r[1],n.ns=(r[2]||A.e).replace(Pe,".").replace(Le,A.e)[E.P](".").sort().join("."),n}function ke(e,t,n){void 0===n&&(n=!0);var i=Fe.get(e,"events",{},n),r=i[t];return r||(r=i[t]=[]),r}function Ve(e,t,n,i){e&&t&&t[E.Y]&&(e.removeEventListener?e.removeEventListener(t[E.Y],n,i):e.detachEvent&&e.detachEvent("on"+t[E.Y],n))}function Ge(e,t,n,i){for(var r=t[E.x];r--;){var s=t[r];s&&(n.ns&&n.ns!==s.evtName.ns||i&&!i(s)||(Ve(e,s.evtName,s[E.p],s.capture),t[E.O](r,1)))}}function He(e,t){return t?Be("xx",Object(S.k)(t)?[e].concat(t):[e,t]).ns[E.P]("."):e}function We(e,t,n,i,r){var s;void 0===r&&(r=!1);var a=!1;if(e)try{var o=Be(t,i);if((a=function(e,t,n,i){var r=!1;return e&&t&&t[E.Y]&&n&&(e.addEventListener?(e.addEventListener(t[E.Y],n,i),r=!0):e.attachEvent&&(e.attachEvent("on"+t[E.Y],n),r=!0)),r}(e,o,n,r))&&Fe.accept(e)){var l=((s={guid:Ne++,evtName:o})[E.p]=n,s.capture=r,s);ke(e,o.type)[E.H](l)}}catch(e){}return a}function Xe(e,t,n,i,r){if(void 0===r&&(r=!1),e)try{var s=Be(t,i),a=!1;!function(e,t,n){if(t[E.Y])Ge(e,ke(e,t[E.Y]),t,n);else{var i=Fe.get(e,"events",{});Object(S.A)(i,(function(i,r){Ge(e,r,t,n)})),0===Object(S.C)(i)[E.x]&&Fe.kill(e,"events")}}(e,s,(function(e){return!((!s.ns||n)&&e[E.p]!==n||(a=!0,0))})),a||Ve(e,s,n,r)}catch(e){}}function je(e,t,n){var i=!1,r=x();r&&(i=We(r,e,t,n),i=We(r.body,e,t,n)||i);var s=D();return s&&(i=We(s,e,t,n)||i),i}function ze(e,t,n,i){var r=!1;return t&&e&&e[E.x]>0&&Object(S.a)(e,(function(e){e&&(n&&-1!==Object(S.b)(n,e)||(r=je(e,t,i)||r))})),r}function Ke(e,t,n){e&&Object(S.k)(e)&&Object(S.a)(e,(function(e){e&&function(e,t,n){var i=x();i&&(Xe(i,e,t,n),Xe(i.body,e,t,n));var r=D();r&&Xe(r,e,t,n)}(e,t,n)}))}var Ye,qe=null;function Qe(){var e=$e();return e[E.S](0,8)+"-"+e[E.S](8,12)+"-"+e[E.S](12,16)+"-"+e[E.S](16,20)+"-"+e[E.S](20)}function Ze(){var e=M("performance");return e&&e.now?e.now():Object(S.e)()}function $e(){for(var e,t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],n=A.e,i=0;i<4;i++)n+=t[15&(e=Se())]+t[e>>4&15]+t[e>>8&15]+t[e>>12&15]+t[e>>16&15]+t[e>>20&15]+t[e>>24&15]+t[e>>28&15];var r=t[8+(3&Se())|0];return n[E.R](0,8)+n[E.R](9,4)+"4"+n[E.R](13,3)+r+n[E.R](16,3)+n[E.R](19,12)}_.l;var Je={_canUseCookies:void 0,isTypeof:S.v,isUndefined:S.w,isNullOrUndefined:S.q,hasOwnProperty:S.j,isFunction:S.o,isObject:S.s,isDate:S.m,isArray:S.k,isError:S.n,isString:S.t,isNumber:S.r,isBoolean:S.l,toISOString:S.M,arrForEach:S.a,arrIndexOf:S.b,arrMap:S.c,arrReduce:S.d,strTrim:S.K,objCreate:v.b,objKeys:S.C,objDefineAccessors:S.y,addEventHandler:je,dateNow:S.e,isIE:B,disableCookies:function(){var e,t,n,i;(n=function(e,t){var n=ce._ckMgr||ae._ckMgr;return n||(n=ce._ckMgr=ce(e,t),ae._ckMgr=n),n}(e,t),i=Je._canUseCookies,null===qe&&(qe=[],Ye=i,Object(S.y)(Je,"_canUseCookies",(function(){return Ye}),(function(e){Ye=e,Object(S.a)(qe,(function(t){t[E.L](e)}))}))),-1===Object(S.b)(qe,n)&&qe[E.H](n),Object(S.l)(i)&&n[E.L](i),Object(S.l)(Ye)&&n[E.L](Ye),n)[E.L](!1)},newGuid:Qe,perfNow:Ze,newId:be,randomValue:function(e){return e>0?Math.floor(Se()/4294967295*(e+1))>>>0:0},random32:Se,mwcRandomSeed:function(e){e?Ee(e):Te()},mwcRandom32:Ae,generateW3CId:$e};var et=n(270),tt=n(497),nt=function(){function e(t,n,i){var r,s=this,a=!1;s.start=Object(S.e)(),s[E.D]=t,s[E.u]=i,s[E.v]=function(){return!1},Object(S.o)(n)&&(a=Object(S.y)(s,"payload",(function(){return!r&&Object(S.o)(n)&&(r=n(),n=null),r}))),s[E.k]=function(t){return t?t===e.ParentContextKey||t===e.ChildrenContextKey?s[t]:(s.ctx||{})[t]:null},s[E.K]=function(t,n){t&&(t===e.ParentContextKey?(s[t]||(s[E.v]=function(){return!0}),s[t]=n):t===e.ChildrenContextKey?s[t]=n:(s.ctx=s.ctx||{})[t]=n)},s[E.d]=function(){var t=0,i=s[E.k](e.ChildrenContextKey);if(Object(S.k)(i))for(var r=0;r<i[E.x];r++){var o=i[r];o&&(t+=o[E.U])}s[E.U]=Object(S.e)()-s.start,s.exTime=s[E.U]-t,s[E.d]=function(){},!a&&Object(S.o)(n)&&(s.payload=n())}}return e.ParentContextKey="parent",e.ChildrenContextKey="childEvts",e}(),it=function(){function e(t){this.ctx={},Object(T.a)(e,this,(function(e){e.create=function(e,t,n){return new nt(e,t,n)},e.fire=function(e){e&&(e[E.d](),t&&Object(S.o)(t[A.m])&&t[A.m](e))},e[E.K]=function(t,n){t&&((e.ctx=e.ctx||{})[t]=n)},e[E.k]=function(t){return(e.ctx||{})[t]}}))}return e.__ieDyn=1,e}();function rt(e,t,n,i,r){if(e){var s=e;if(s[A.l]&&(s=s[A.l]()),s){var a=void 0,o=s[E.k]("CoreUtils.doPerf");try{if(a=s.create(t(),i,r)){if(o&&a[E.K]&&(a[E.K](nt.ParentContextKey,o),o[E.k]&&o[E.K])){var l=o[E.k](nt.ChildrenContextKey);l||(l=[],o[E.K](nt.ChildrenContextKey,l)),l[E.H](a)}return s[E.K]("CoreUtils.doPerf",a),n(a)}}catch(e){a&&a[E.K]&&a[E.K]("exception",e)}finally{a&&s.fire(a),s[E.K]("CoreUtils.doPerf",o)}}}return n()}function st(e,t,n){return!(!e||e[E.x]!==t||e===n||!e.match(/^[\da-f]*$/i))}var at=Oe("plugin");function ot(e){return at.get(e,"state",{},!0)}function lt(e,t){for(var n,i=[],r=null,s=e[E.l]();s;){var a=s[E.n]();a&&(r&&Object(S.o)(r[E.M])&&Object(S.o)(a[A.o])&&r[E.M](a),(Object(S.o)(a[E.w])?a[E.w]():(n=ot(a))[E.w])||i[E.H](a),r=a,s=s[E.l]())}Object(S.a)(i,(function(i){var r=e[A.b]();i[E.s](e.getCfg(),r,t,e[E.l]()),n=ot(i),i[A.b]||n[A.b]||(n[A.b]=r),n[E.w]=!0,delete n[E.T]}))}function ct(e){return e.sort((function(e,t){var n=0;if(t){var i=Object(S.o)(t[A.o]);Object(S.o)(e[A.o])?n=i?e[A.n]-t[A.n]:1:i&&(n=-1)}else n=e?1:-1;return n}))}var dt=0;function ht(e,t,n,i){var r=null,s=[];null!==i&&(r=i?function(e,t,n){for(;e;){if(e[E.n]()===n)return e;e=e[E.l]()}return pt([n],t[E.e]||{},t)}(e,n,i):e);var a={_next:function(){var e=r;if(r=e?e[E.l]():null,!e){var t=s;t&&t[E.x]>0&&(Object(S.a)(t,(function(e){try{e.func[E.c](e.self,e.args)}catch(e){J(n[E.z],2,73,"Unexpected Exception during onComplete - "+k(e))}})),s=[])}return e},ctx:{core:function(){return n},diagLog:function(){return function(e,t){return(e||{})[E.z]||new Z(t)}(n,t)},getCfg:function(){return t},getExtCfg:o,getConfig:function(e,n,i){void 0===i&&(i=!1);var r,s=o(e,null);return s&&!Object(S.q)(s[n])?r=s[n]:t&&!Object(S.q)(t[n])&&(r=t[n]),Object(S.q)(r)?i:r},hasNext:function(){return!!r},getNext:function(){return r},setNext:function(e){r=e},iterate:function(e){for(var t;t=a._next();){var n=t[E.n]();n&&e(n)}},onComplete:function(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];e&&s[E.H]({func:e,self:Object(S.w)(t)?a.ctx:t,args:n})}}};function o(e,n,i){var r;if(void 0===n&&(n={}),void 0===i&&(i=0),t){var s=t[A.k];s&&e&&(r=s[e])}if(r){if(Object(S.s)(n)&&0!==i){var a=Object(S.z)(!0,n,r);t&&2===i&&Object(S.A)(n,(function(e){if(Object(S.q)(a[e])){var n=t[e];Object(S.q)(n)||(a[e]=n)}})),r=a}}else r=n;return r}return a}function ut(e,t,n,i){var r=ht(e,t,n,i),s=r.ctx;return s[E.G]=function(e){var t=r._next();return t&&t[A.o](e,s),!t},s[E.g]=function(e,i){return void 0===e&&(e=null),Object(S.k)(e)&&(e=pt(e,t,n,i)),ut(e||s[E.l](),t,n,i)},s}function ft(e,t,n){var i=t[E.e]||{},r=ht(e,i,t,n),s=r.ctx;return s[E.G]=function(e){var t=r._next();return t&&t.unload(s,e),!t},s[E.g]=function(e,n){return void 0===e&&(e=null),Object(S.k)(e)&&(e=pt(e,i,t,n)),ft(e||s[E.l](),t,n)},s}function mt(e,t,n){var i=t[E.e]||{},r=ht(e,i,t,n).ctx;return r[E.G]=function(e){return r.iterate((function(t){Object(S.o)(t[E.Z])&&t[E.Z](r,e)}))},r[E.g]=function(e,n){return void 0===e&&(e=null),Object(S.k)(e)&&(e=pt(e,i,t,n)),mt(e||r[E.l](),t,n)},r}function pt(e,t,n,i){var r=null,s=!i;if(Object(S.k)(e)&&e[E.x]>0){var a=null;Object(S.a)(e,(function(e){if(s||i!==e||(s=!0),s&&e&&Object(S.o)(e[A.o])){var o=function(e,t,n){var i,r=null,s=Object(S.o)(e[A.o]),a=Object(S.o)(e[E.M]),o={getPlugin:function(){return e},getNext:function(){return r},processTelemetry:function(i,c){l(c=c||function(){var i;return e&&Object(S.o)(e._getTelCtx)&&(i=e._getTelCtx()),i||(i=ut(o,t,n)),i}(),(function(t){if(!e||!s)return!1;var n=ot(e);return!n[E.T]&&!n[A.d]&&(a&&e[E.M](r),e[A.o](i,t),!0)}),"processTelemetry",(function(){return{item:i}}),!i.sync)||c[E.G](i)},unload:function(t,n){l(t,(function(){var i=!1;if(e){var r=ot(e),s=e[A.b]||r[A.b];!e||s&&s!==t.core()||r[E.T]||(r[A.b]=null,r[E.T]=!0,r[E.w]=!1,e[E.T]&&!0===e[E.T](t,n)&&(i=!0))}return i}),"unload",(function(){}),n[E.u])||t[E.G](n)},update:function(t,n){l(t,(function(){var i=!1;if(e){var r=ot(e),s=e[A.b]||r[A.b];!e||s&&s!==t.core()||r[E.T]||e[E.Z]&&!0===e[E.Z](t,n)&&(i=!0)}return i}),"update",(function(){}),!1)||t[E.G](n)},_id:i=e?e[E.q]+"-"+e[A.n]+"-"+dt++:"Unknown-0-"+dt++,_setNext:function(e){r=e}};function l(t,n,s,a,o){var l=!1,c=e?e[E.q]:"TelemetryPluginChain",d=t._hasRun;return d||(d=t._hasRun={}),t.setNext(r),e&&rt(t[A.b](),(function(){return c+":"+s}),(function(){d[i]=!0;try{var e=r?r._id:A.e;e&&(d[e]=!1),l=n(t)}catch(e){var a=!r||d[r._id];a&&(l=!0),r&&a||J(t[E.h](),1,73,"Plugin ["+c+"] failed during "+s+" - "+k(e)+", run flags: "+k(d))}}),a,o),l}return Object(S.B)(o)}(e,t,n);r||(r=o),a&&a._setNext(o),a=o}}))}return i&&!r?pt([i],t,n):r}function gt(e,t,n){t&&Object(S.k)(t)&&t[E.x]>0&&(t=t.sort((function(e,t){return e[A.n]-t[A.n]})),Object(S.a)(t,(function(e){e[A.n]<500&&Object(S.L)("Channel has invalid priority - "+e[E.q])})),e[E.H]({queue:Object(S.B)(t),chain:pt(t,n[E.e],n)}))}function _t(){var e=[];return{add:function(t){t&&e[E.H](t)},run:function(t,n){Object(S.a)(e,(function(e){try{e(t,n)}catch(e){J(t[E.h](),2,73,"Unexpected error calling unload handler - "+k(e))}})),e=[]}}}var vt=function(){function e(){var t,n,i,r,s,a=this;function o(e){void 0===e&&(e=null);var t=e;if(!t){var r=n||ut(null,{},a[A.b]);t=i&&i.getPlugin?r[E.g](null,i.getPlugin):r[E.g](null,i)}return t}function l(e,t,r){e&&Object(S.G)(e,A.k,[],null,S.q),!r&&t&&(r=t[E.o]()[E.l]());var s=i;i&&i.getPlugin&&(s=i.getPlugin()),a[A.b]=t,n=ut(r,e,t,s)}function c(){t=!1,a[A.b]=null,n=null,i=null,s=[],r=_t()}c(),Object(T.a)(e,a,(function(e){e[E.s]=function(e,n,i,r){l(e,n,r),t=!0},e[E.T]=function(t,n){var a,o=e[A.b];if(o&&(!t||o===t[A.b]())){var l,d=!1,h=t||ft(null,o,i&&i.getPlugin?i.getPlugin():i),u=n||((a={reason:0})[E.u]=!1,a);return e[E.cb]&&!0===e[E.cb](h,u,f)?l=!0:f(),l}function f(){if(!d){d=!0,r.run(h,n);var e=s;s=[],Object(S.a)(e,(function(e){e.rm()})),!0===l&&h[E.G](u),c()}}},e[E.Z]=function(t,n){var r=e[A.b];if(r&&(!t||r===t[A.b]())){var s,a=!1,o=t||mt(null,r,i&&i.getPlugin?i.getPlugin():i),c=n||{reason:0};return e._doUpdate&&!0===e._doUpdate(o,c,d)?s=!0:d(),s}function d(){a||(a=!0,l(o.getCfg(),o.core(),o[E.l]()))}},e._addHook=function(e){e&&(Object(S.k)(e)?s=s.concat(e):s[E.H](e))},Object(S.E)(e,"_addUnloadCb",(function(){return r}),"add")})),a[E.h]=function(e){return o(e)[E.h]()},a[E.w]=function(){return t},a.setInitialized=function(e){t=e},a[E.M]=function(e){i=e},a[E.G]=function(e,t){t?t[E.G](e):i&&Object(S.o)(i[A.o])&&i[A.o](e,null)},a._getTelCtx=o}return e.__ieDyn=1,e}(),Et=function(e){function t(){var n,i,r=e.call(this)||this;function s(){n=0,i=[]}return r.identifier="TelemetryInitializerPlugin",r.priority=199,s(),Object(T.a)(t,r,(function(e,t){e.addTelemetryInitializer=function(e){var t={id:n++,fn:e};return i[E.H](t),{remove:function(){Object(S.a)(i,(function(e,n){if(e.id===t.id)return i[E.O](n,1),-1}))}}},e[A.o]=function(t,n){for(var r=!1,s=i[E.x],a=0;a<s;++a){var o=i[a];if(o)try{if(!1===o.fn[E.b](null,[t])){r=!0;break}}catch(e){J(n[E.h](),1,64,"One of telemetry initializers failed, telemetry item will not be sent: "+Object(S.h)(e),{exception:k(e)},!0)}}r||e[E.G](t,n)},e[E.cb]=function(){s()}})),r}return Object(tt.a)(t,e),t.__ieDyn=1,t}(vt),Tt={loggingLevelConsole:1};function St(e,t){return new it(t)}function At(e,t){var n=!1;return Object(S.a)(t,(function(t){if(t===e)return n=!0,-1})),n}var bt=function(){function e(){var t,n,i,r,s,a,o,l,c,d,h,u,f,m,p,g,_,b,I,R,C=0,y=!1;Object(T.a)(e,this,(function(e){function T(n){if(!C&&!y&&(n||e[E.z]&&e[E.z].queue[E.x]>0)){var i=Object(S.g)(t.diagnosticLogInterval);i&&i>0||(i=1e4),C=setInterval((function(){clearInterval(C),C=0,N()}),i)}return C}function M(){n=!1,t=Object(S.z)(!0,{},Tt),e[E.e]=t,e[E.z]=new Z(t),e[E.db]=[],p=new Et,i=[],r=null,s=null,a=null,o=null,l=null,d=null,c=[],h=null,u=null,f=null,m=!1,g=null,_=Me("AIBaseCore",!0),b=_t(),R=null}function O(){var n=ut(P(),t,e);return n[E.F](T),n}function x(n){var i=function(e,t,n){var i,r=[],s={};return Object(S.a)(n,(function(t){(Object(S.q)(t)||Object(S.q)(t[E.s]))&&Object(S.L)("Plugins must provide initialize method");var n=t[A.n],i=t[E.q];t&&n&&(Object(S.q)(s[n])?s[n]=i:ee(e,"Two extensions have same priority #"+n+" - "+s[n]+", "+i)),(!n||n<500)&&r[E.H](t)})),(i={all:n})[A.b]=r,i}(e[E.z],0,c);d=i[A.b],l=null;var r=i.all;if(f=Object(S.B)(function(e,t,n){var i=[];if(e&&Object(S.a)(e,(function(e){return gt(i,e,n)})),t){var r=[];Object(S.a)(t,(function(e){e[A.n]>500&&r[E.H](e)})),gt(i,r,n)}return i}(u,r,e)),h){var s=Object(S.b)(r,h);-1!==s&&r[E.O](s,1),-1!==(s=Object(S.b)(d,h))&&d[E.O](s,1),h._setQueue(f)}else h=function(e,t){function n(){return ut(null,t[E.e],t,null)}function i(e,t,n,i){var r=e?e[E.x]+1:1;function s(){0==--r&&(i&&i(),i=null)}r>0&&Object(S.a)(e,(function(e){if(e&&e.queue[E.x]>0){var i=e.chain,a=t[E.g](i);a[E.F](s),n(a)}else r--})),s()}var r=!1;return{identifier:"ChannelControllerPlugin",priority:500,initialize:function(t,n,i,s){r=!0,Object(S.a)(e,(function(e){e&&e.queue[E.x]>0&&lt(ut(e.chain,t,n),i)}))},isInitialized:function(){return r},processTelemetry:function(t,r){i(e,r||n(),(function(e){e[E.G](t)}),(function(){r[E.G](t)}))},update:function(t,n){var r=n||{reason:0};return i(e,t,(function(e){e[E.G](r)}),(function(){t[E.G](r)})),!0},pause:function(){i(e,n(),(function(e){e.iterate((function(e){e.pause&&e.pause()}))}),null)},resume:function(){i(e,n(),(function(e){e.iterate((function(e){e.resume&&e.resume()}))}),null)},teardown:function(t,n){var s=n||{reason:0,isAsync:!1};return i(e,t,(function(e){e[E.G](s)}),(function(){t[E.G](s),r=!1})),!0},getChannel:function(t){var n=null;return e&&e[E.x]>0&&Object(S.a)(e,(function(e){if(e&&e.queue[E.x]>0&&(Object(S.a)(e.queue,(function(e){if(e[E.q]===t)return n=e,-1})),n))return-1})),n},flush:function(t,r,s,a){var o=1,l=!1,c=null;function d(){o--,l&&0===o&&(c&&(clearTimeout(c),c=null),r&&r(l),r=null)}return a=a||5e3,i(e,n(),(function(e){e.iterate((function(e){if(e[E.j]){o++;var n=!1;e[E.j](t,(function(){n=!0,d()}),s)||n||(t&&null==c?c=setTimeout((function(){c=null,d()}),a):d())}}))}),(function(){l=!0,d()})),!0},_setQueue:function(t){e=t}}}(f,e);r[E.H](h),d[E.H](h),e[E.db]=ct(r),h[E.s](t,e,r),lt(O(),r),e[E.db]=Object(S.B)(ct(d||[])).slice(),n&&function(t){var n=mt(P(),e);n[E.F](T),e._updateHook&&!0===e._updateHook(n,t)||n[E.G](t)}(n)}function D(t){var n,i=null,r=null;return Object(S.a)(e[E.db],(function(e){if(e[E.q]===t&&e!==h&&e!==p)return r=e,-1})),!r&&h&&(r=h.getChannel(t)),r&&((n={plugin:r})[E.L]=function(e){ot(r)[A.d]=!e},n.isEnabled=function(){var e=ot(r);return!e[E.T]&&!e[A.d]},n.remove=function(e,t){var n;void 0===e&&(e=!0);var i=[r],s=((n={reason:1})[E.u]=e,n);L(i,s,(function(e){e&&x({reason:32,removed:i}),t&&t(e)}))},i=n),i}function P(){if(!l){var n=(d||[]).slice();-1===Object(S.b)(n,p)&&n[E.H](p),l=pt(ct(n),t,e)}return l}function L(n,i,r){if(n&&n[E.x]>0){var s=ft(pt(n,t,e),e);s[E.F]((function(){var e=!1,t=[];Object(S.a)(c,(function(i,r){At(i,n)?e=!0:t[E.H](i)})),c=t;var i=[];u&&(Object(S.a)(u,(function(t,r){var s=[];Object(S.a)(t,(function(t){At(t,n)?e=!0:s[E.H](t)})),i[E.H](s)})),u=i),r&&r(e),T()})),s[E.G](i)}else r(!1)}function N(){if(e[E.z]&&e[E.z].queue){var n=e[E.z].queue.slice(0);e[E.z].queue[E.x]=0,Object(S.a)(n,(function(n){var i,r=((i={})[E.D]=g||"InternalMessageId: "+n[E.C],i.iKey=Object(S.g)(t[E.t]),i.time=Object(S.M)(new Date),i.baseType=Q.dataType,i.baseData={message:n[E.B]},i);e.track(r)}))}}function F(e,t,n,i){return h?h[E.j](e,t,n||6,i):(t&&t(!1),!0)}function w(t){var n=e[E.z];n?(J(n,2,73,t),T()):Object(S.L)(t)}M(),e[E.w]=function(){return n},e[E.s]=function(i,s,o,l){var d,h;m&&Object(S.L)("SDK is still unloading..."),e[E.w]()&&Object(S.L)("Core should not be initialized more than once"),t=i||{},e[E.e]=t,Object(S.q)(i[E.t])&&Object(S.L)("Please provide instrumentation key"),r=l,e._notificationManager=l,!0===(h=Object(S.g)(t.disableDbgExt))&&I&&(r[E.I](I),I=null),r&&!I&&!0!==h&&(I=function(e){if(!W){W={};for(var t=0;t<X[E.x];t++)W[X[t]]=z(X[t],e)}return W}(t),r[E.a](I)),!(d=Object(S.g)(t.enablePerfMgr))&&a&&(a=null),d&&Object(S.i)(t,A.c,St),Object(S.i)(t,A.k,{}).NotificationManager=r,o&&(e[E.z]=o);var p=Object(S.i)(t,A.j,[]);(c=[])[E.H].apply(c,Object(tt.b)(Object(tt.b)([],s,!1),p,!1)),u=Object(S.i)(t,A.a,[]),x(null),f&&0!==f[E.x]||Object(S.L)("No "+A.a+" available"),n=!0,e.releaseQueue()},e.getTransmissionControls=function(){var e=[];return f&&Object(S.a)(f,(function(t){e[E.H](t.queue)})),Object(S.B)(e)},e.track=function(n){n.iKey=n.iKey||t[E.t],n[E.U]=n[E.U]||Object(S.M)(new Date),n.ver=n.ver||"4.0",!m&&e[E.w]()?O()[E.G](n):i[E.H](n)},e[E.o]=O,e[E.m]=function(){var t;return r||(r=Object(v.b)(((t={})[E.a]=function(e){},t[E.I]=function(e){},t[A.i]=function(e){},t[A.g]=function(e,t){},t[A.h]=function(e,t){},t)),e._notificationManager=r),r},e[E.a]=function(e){r&&r[E.a](e)},e[E.I]=function(e){r&&r[E.I](e)},e.getCookieMgr=function(){return o||(o=ce(t,e[E.z])),o},e.setCookieMgr=function(e){o=e},e[A.l]=function(){if(!s&&!a&&Object(S.g)(t.enablePerfMgr)){var n=Object(S.g)(t[A.c]);Object(S.o)(n)&&(a=n(e,e[E.m]()))}return s||a||null},e.setPerfMgr=function(e){s=e},e.eventCnt=function(){return i[E.x]},e.releaseQueue=function(){if(n&&i[E.x]>0){var e=i;i=[],Object(S.a)(e,(function(e){O()[E.G](e)}))}},e.pollInternalLogs=function(e){return g=e||null,y=!1,C&&(clearInterval(C),C=null),T(!0)},e[E.Q]=function(){y=!0,C&&(clearInterval(C),C=0,N())},Object(S.F)(e,(function(){return p}),["addTelemetryInitializer"]),e.unload=function(t,i,r){var s;void 0===t&&(t=!0),n||Object(S.L)("SDK is not initialized"),m&&Object(S.L)("SDK is still unloading...");var a=((s={reason:50})[E.u]=t,s.flushComplete=!1,s),o=ft(P(),e);function l(t){a.flushComplete=t,m=!0,b.run(o,a),e[E.Q](),o[E.G](a)}o[E.F]((function(){M(),i&&i(a)}),e),N(),F(t,l,6,r)||l(!1)},e[E.n]=D,e.addPlugin=function(e,t,n,i){if(!e)return i&&i(!1),void w("Plugins must provide initialize method");var r=D(e[E.q]);if(r&&!t)return i&&i(!1),void w("Plugin ["+e[E.q]+"] is already loaded!");var s={reason:16};function a(t){c[E.H](e),s.added=[e],x(s),i&&i(!0)}if(r){var o=[r.plugin];L(o,{reason:2,isAsync:!!n},(function(e){e?(s.removed=o,s.reason|=32,a()):i&&i(!1)}))}else a()},e.evtNamespace=function(){return _},e[E.j]=F,e.getTraceCtx=function(e){var t;return R||(t={},R={getName:function(){return t[E.D]},setName:function(e){t[E.D]=e},getTraceId:function(){return t[E.X]},setTraceId:function(e){st(e,32,"00000000000000000000000000000000")&&(t[E.X]=e)},getSpanId:function(){return t[E.N]},setSpanId:function(e){st(e,16,"0000000000000000")&&(t[E.N]=e)},getTraceFlags:function(){return t[E.W]},setTraceFlags:function(e){t[E.W]=e}}),R},e.setTraceCtx=function(e){R=e||null},Object(S.E)(e,"addUnloadCb",(function(){return b}),"add")}))}return e.__ieDyn=1,e}();function It(e,t,n,i){Object(S.a)(e,(function(e){if(e&&e[t])if(n)setTimeout((function(){return i(e)}),0);else try{i(e)}catch(e){}}))}var Rt,Ct=function(){function e(t){this.listeners=[];var n=!!(t||{}).perfEvtsSendAll;Object(T.a)(e,this,(function(e){e[E.a]=function(t){e.listeners[E.H](t)},e[E.I]=function(t){for(var n=Object(S.b)(e[E.y],t);n>-1;)e.listeners[E.O](n,1),n=Object(S.b)(e[E.y],t)},e[A.i]=function(t){It(e[E.y],A.i,!0,(function(e){e[A.i](t)}))},e[A.g]=function(t,n){It(e[E.y],A.g,!0,(function(e){e[A.g](t,n)}))},e[A.h]=function(t,n){It(e[E.y],A.h,n,(function(e){e[A.h](t,n)}))},e[A.m]=function(t){t&&(!n&&t[E.v]()||It(e[E.y],A.m,!1,(function(e){t[E.u]?setTimeout((function(){return e[A.m](t)}),0):e[A.m](t)})))}}))}return e.__ieDyn=1,e}(),yt=function(e){function t(){var n=e.call(this)||this;return Object(T.a)(t,n,(function(e,t){function n(t){var n=e[E.m]();n&&n[A.g]([t],2)}e[E.s]=function(e,n,i,r){t[E.s](e,n,i||new Z(e),r||new Ct(e))},e.track=function(i){rt(e[A.l](),(function(){return"AppInsightsCore:track"}),(function(){null===i&&(n(i),Object(S.L)("Invalid telemetry item")),function(e){Object(S.q)(e[E.D])&&(n(e),Object(S.L)("telemetry name required"))}(i),t.track(i)}),(function(){return{item:i}}),!i.sync)}})),n}return Object(tt.a)(t,e),t.__ieDyn=1,t}(bt),Mt=((Rt={})[0]=0,Rt[2]=6,Rt[1]=1,Rt[3]=7,Rt[4098]=6,Rt[4097]=1,Rt[4099]=7,Rt);function Ot(e){return!(""===e||Object(S.q)(e))}function xt(e,t,n){var i=-1;if(!Object(S.w)(e))if(t>0&&(32===t?i=8192:t<=13&&(i=t<<5)),function(e){return e>=0&&e<=9}(n))-1===i&&(i=0),i|=n;else{var r=Mt[function e(t){var n=0;if(null!=t){var i=typeof t;"string"===i?n=1:"number"===i?n=2:"boolean"===i?n=3:i===_.j&&(n=4,Object(S.k)(t)?(n=4096,t.length>0&&(n|=e(t[0]))):_.e.call(t,"value")&&(n=8192|e(t.value)))}return n}(e)]||-1;-1!==i&&-1!==r?i|=r:6===r&&(i=r)}return i}function Dt(e,t,n,i,r){var s={},a=!1,o=0,l=arguments.length,c=Object[_.k],d=arguments;for("[object Boolean]"===c.toString.call(d[0])&&(a=d[0],o++);o<l;o++)e=d[o],Object(S.A)(e,(function(e,t){a&&t&&Object(S.s)(t)?Object(S.k)(t)?(s[e]=s[e]||[],Object(S.a)(t,(function(t,n){t&&Object(S.s)(t)?s[e][n]=Dt(!0,s[e][n],t):s[e][n]=t}))):s[e]=Dt(!0,s[e],t):s[e]=t}));return s}Boolean(D()),Boolean(x());var Pt=Ze;function Lt(e,t){var n=e;n.timings=n.timings||{},n.timings.processTelemetryStart=n.timings.processTelemetryStart||{},n.timings.processTelemetryStart[t]=Pt()}_.l,_.j,_.l,S.a,S.b,S.c,S.d,S.C,S.M,S.t,S.r,S.l,S.o,S.k,S.s,S.K,S.M,S.y,S.I,S.A,S.v,S.w,S.q,S.j,S.o,S.s,S.m,S.k,S.n,S.t,S.r,S.l,S.M,S.a,S.b,S.c,S.d,S.K,v.b,S.C,S.y,S.e;var Nt,Ft,wt=function(e){function t(){var n=e.call(this)||this;return n.pluginVersionStringArr=[],Object(T.a)(t,n,(function(e,t){e.logger&&e.logger.queue||(e.logger=new Z({loggingLevelConsole:1})),e.initialize=function(n,i,r,s){rt(e,(function(){return"AppInsightsCore.initialize"}),(function(){var a=e.pluginVersionStringArr;if(n){n.endpointUrl||(n.endpointUrl="https://browser.events.data.microsoft.com/OneCollector/1.0/");var o=n.propertyStorageOverride;!o||o.getProperty&&o.setProperty||Object(S.L)("Invalid property storage override passed."),n.channels&&Object(S.a)(n.channels,(function(e){e&&Object(S.a)(e,(function(e){if(e.identifier&&e.version){var t=e.identifier+"="+e.version;a.push(t)}}))}))}e.getWParam=function(){return"undefined"!=typeof document||n.enableWParam?0:-1},i&&Object(S.a)(i,(function(e){if(e&&e.identifier&&e.version){var t=e.identifier+"="+e.version;a.push(t)}})),e.pluginVersionString=a.join(";"),e.pluginVersionStringArr=a;try{t.initialize(n,i,r,s),e.pollInternalLogs("InternalLog")}catch(t){var l=e.logger,c=k(t);-1!==c.indexOf("channels")&&(c+="\n - Channels must be provided through config.channels only!"),J(l,1,514,"SDK Initialization Failed - no telemetry will be sent: "+c)}}),(function(){return{config:n,extensions:i,logger:r,notificationManager:s}}))},e.track=function(n){rt(e,(function(){return"AppInsightsCore.track"}),(function(){var i,r=n;if(r){r.timings=r.timings||{},r.timings.trackStart=Pt(),(i=r.latency)&&Object(S.r)(i)&&i>=1&&i<=4||(r.latency=1);var s=r.ext=r.ext||{};s.sdk=s.sdk||{},s.sdk.ver="1DS-Web-JS-3.2.14";var a=r.baseData=r.baseData||{};a.properties=a.properties||{};var o=a.properties;o.version=o.version||e.pluginVersionString||""}t.track(r)}),(function(){return{item:n}}),!n.sync)}})),n}return Object(tt.a)(t,e),t.__ieDyn=1,t}(yt),Ut=(Nt={Unknown:0,NonRetryableStatus:1,InvalidEvent:2,SizeLimitExceeded:3,KillSwitch:4,QueueFull:5},Ft={},Object(S.A)(Nt,(function(e,t){Ft[e]=t,Ft[t]=e})),Object(S.f)(Ft));function Bt(e){var t=(e.ext||{}).intweb;return t&&Ot(t.msfpc)?t.msfpc:null}function kt(e){for(var t=null,n=0;null===t&&n<e.length;n++)t=Bt(e[n]);return t}var Vt=function(){function e(t,n){var i=n?[].concat(n):[],r=kt(i);this.iKey=function(){return t},this.Msfpc=function(){return r||""},this.count=function(){return i.length},this.events=function(){return i},this.addEvent=function(e){return!!e&&(i.push(e),r||(r=Bt(e)),!0)},this.split=function(n,s){var a;if(n<i.length){var o=i.length-n;Object(S.q)(s)||(o=s<o?s:o),a=i.splice(n,o),r=kt(i)}return new e(t,a)}}return e.create=function(t,n){return new e(t,n)},e}(),Gt=function(){function e(){var t=!0,n=!0,i=!0,r="use-collector-delta",s=!1;Object(T.a)(e,this,(function(e){e.allowRequestSending=function(){return t},e.firstRequestSent=function(){i&&(i=!1,s||(t=!1))},e.shouldAddClockSkewHeaders=function(){return n},e.getClockSkewHeaderValue=function(){return r},e.setClockSkew=function(e){s||(e?(r=e,n=!0,s=!0):n=!1,t=!0)}}))}return e.__ieDyn=1,e}(),Ht=function(){function e(){var t={};Object(T.a)(e,this,(function(e){e.setKillSwitchTenants=function(e,n){if(e&&n)try{var i=function(e){var t=[];return e&&Object(S.a)(e,(function(e){t.push(Object(S.K)(e))})),t}(e.split(","));if("this-request-only"===n)return i;for(var r=1e3*parseInt(n,10),s=0;s<i.length;++s)t[i[s]]=Object(S.e)()+r}catch(e){return[]}return[]},e.isTenantKilled=function(e){var n=t,i=Object(S.K)(e);return void 0!==n[i]&&n[i]>Object(S.e)()||(delete n[i],!1)}}))}return e.__ieDyn=1,e}();function Wt(e){var t,n=Math.floor(1200*Math.random())+2400;return t=Math.pow(2,e)*n,Math.min(t,6e5)}var Xt,jt=Math.min(2e6,65e3),zt=/\./,Kt=function(){function e(t,n,i,r){var s=!!r,a=n,o={};Object(T.a)(e,this,(function(e){function n(e,t,r,l,c,d,h){Object(S.A)(e,(function(e,u){var f=null;if(u||Ot(u)){var m=r,p=e,g=c,v=t;if(s&&!l&&zt.test(e)){var E=e.split("."),T=E.length;if(T>1){g&&(g=g.slice());for(var A=0;A<T-1;A++){var b=E[A];v=v[b]=v[b]||{},m+="."+b,g&&g.push(b)}p=E[T-1]}}if(f=l&&function(e,t){var n=o[e];return void 0===n&&(e.length>=7&&(n=Object(S.J)(e,"ext.metadata")||Object(S.J)(e,"ext.web")),o[e]=n),n}(m)||!a||!a.handleField(m,p)?function(e,t,n){if(!t&&!Ot(t)||"string"!=typeof e)return null;var i=typeof t;if("string"===i||"number"===i||"boolean"===i||Object(S.k)(t))t={value:t};else if("object"!==i||_.e.call(t,"value")){if(Object(S.q)(t.value)||""===t.value||!Object(S.t)(t.value)&&!Object(S.r)(t.value)&&!Object(S.l)(t.value)&&!Object(S.k)(t.value))return null}else t={value:n?JSON.stringify(t):t};if(Object(S.k)(t.value)&&!(t.value.length>0))return null;if(!Object(S.q)(t.kind)){if(Object(S.k)(t.value)||!function(e){return 0===e||e>0&&e<=13||32===e}(t.kind))return null;t.value=t.value.toString()}return t}(p,u,i):a.value(m,p,u,i)){var I=f.value;if(v[p]=I,d&&d(g,p,f),h&&"object"==typeof I&&!Object(S.k)(I)){var R=g;R&&(R=R.slice()).push(p),n(u,I,m+"."+p,l,R,d,h)}}}}))}e.createPayload=function(e,t,n,i,r,s){return{apiKeys:[],payloadBlob:"",overflow:null,sizeExceed:[],failedEvts:[],batches:[],numEvents:0,retryCnt:e,isTeardown:t,isSync:n,isBeacon:i,sendType:s,sendReason:r}},e.appendPayload=function(n,i,r){var s=n&&i&&!n.overflow;return s&&rt(t,(function(){return"Serializer:appendPayload"}),(function(){for(var t=i.events(),s=n.payloadBlob,a=n.numEvents,o=!1,l=[],c=[],d=n.isBeacon,h=d?65e3:3984588,u=d?jt:2e6,f=0,m=0;f<t.length;){var p=t[f];if(p){if(a>=r){n.overflow=i.split(f);break}var g=e.getEventBlob(p);if(g&&g.length<=u){var _=g.length;if(s.length+_>h){n.overflow=i.split(f);break}s&&(s+="\n"),s+=g,++m>20&&(s.substr(0,1),m=0),o=!0,a++}else g?l.push(p):c.push(p),t.splice(f,1),f--}f++}if(l&&l.length>0&&n.sizeExceed.push(Vt.create(i.iKey(),l)),c&&c.length>0&&n.failedEvts.push(Vt.create(i.iKey(),c)),o){n.batches.push(i),n.payloadBlob=s,n.numEvents=a;var v=i.iKey();-1===Object(S.b)(n.apiKeys,v)&&n.apiKeys.push(v)}}),(function(){return{payload:n,theBatch:{iKey:i.iKey(),evts:i.events()},max:r}})),s},e.getEventBlob=function(e){try{return rt(t,(function(){return"Serializer.getEventBlob"}),(function(){var t={};t.name=e.name,t.time=e.time,t.ver=e.ver,t.iKey="o:"+function(e){if(e){var t=e.indexOf("-");if(t>-1)return e.substring(0,t)}return""}(e.iKey);var i={},r=e.ext;r&&(t.ext=i,Object(S.A)(r,(function(e,t){n(t,i[e]={},"ext."+e,!0,null,null,!0)})));var s=t.data={};s.baseType=e.baseType;var a=s.baseData={};return n(e.baseData,a,"baseData",!1,["baseData"],(function(e,t,n){Yt(i,e,t,n)}),!0),n(e.data,s,"data",!1,[],(function(e,t,n){Yt(i,e,t,n)}),!0),JSON.stringify(t)}),(function(){return{item:e}}))}catch(e){return null}}}))}return e.__ieDyn=1,e}();function Yt(e,t,n,i){if(i&&e){var r=xt(i.value,i.kind,i.propertyType);if(r>-1){var s=e.metadata;s||(s=e.metadata={f:{}});var a=s.f;if(a||(a=s.f={}),t)for(var o=0;o<t.length;o++){var l=t[o];a[l]||(a[l]={f:{}});var c=a[l].f;c||(c=a[l].f={}),a=c}a=a[n]={},Object(S.k)(i.value)?a.a={t:r}:a.t=r}}}var qt=((Xt={})[1]="requeue",Xt[100]="requeue",Xt[200]="sent",Xt[8004]="drop",Xt[8003]="drop",Xt),Qt={},Zt={};function $t(e,t,n){Qt[e]=t,!1!==n&&(Zt[t]=e)}function Jt(e){try{return e.responseText}catch(e){}return""}function en(e,t){var n=!1;if(e&&t){var i=Object(S.C)(e);if(i&&i.length>0)for(var r=t.toLowerCase(),s=0;s<i.length;s++){var a=i[s];if(a&&Object(S.j)(t,a)&&a.toLowerCase()===r){n=!0;break}}}return n}function tn(e,t,n,i){t&&n&&n.length>0&&(i&&Qt[t]?(e.hdrs[Qt[t]]=n,e.useHdrs=!0):e.url+="&"+t+"="+n)}function nn(e,t){return t&&(Object(S.r)(t)?e=[t].concat(e):Object(S.k)(t)&&(e=t.concat(e))),e}$t("AuthMsaDeviceTicket","AuthMsaDeviceTicket",!1),$t("client-version","client-version"),$t("client-id","Client-Id"),$t("apikey","apikey"),$t("time-delta-to-apply-millis","time-delta-to-apply-millis"),$t("upload-time","upload-time"),$t("AuthXToken","AuthXToken");var rn=function(){function e(t,n,i,r,s){this._responseHandlers=[];var a,o,l,c,d,h,u,f,m,p,g="?cors=true&"+"content-type".toLowerCase()+"=application/x-json-stream",v=new Ht,E=!1,A=new Gt,b=!1,I=0,C=!0,O=[],x={},D=[],P=null,F=!1,w=!1,B=!1;Object(T.a)(e,this,(function(e){var T=!0;function W(e,t){for(var n=0,i=null,r=0;null==i&&r<e.length;)1===(n=e[r])?(null===R&&(R=typeof XDomainRequest!==_.l)&&H()&&(R=R&&!y(M("XMLHttpRequest"),"withCredentials")),R?i=X:H()&&(i=z)):2===n&&G(t)&&(!t||t&&!f)?i=j:b&&3===n&&V()&&(i=Y),r++;return i?{_transport:n,_isSync:t,sendPOST:i}:null}function X(e,t,n){var i=new XDomainRequest;i.open("POST",e.urlString),e.timeout&&(i.timeout=e.timeout),i.onload=function(){var e=Jt(i);K(t,200,{},e),oe(e)},i.onerror=function(){K(t,400,{})},i.ontimeout=function(){K(t,500,{})},i.onprogress=function(){},n?i.send(e.data):s.set((function(){i.send(e.data)}),0)}function j(e,t,n){var i,r=e.urlString,a=!1,o=!1,l=((i={body:e.data,method:"POST"}).Microsoft_ApplicationInsights_BypassAjaxInstrumentation=!0,i);n&&(l.keepalive=!0,2===e._sendReason&&(a=!0,p&&(r+="&NoResponseBody=true"))),T&&(l.credentials="include"),e.headers&&Object(S.C)(e.headers).length>0&&(l.headers=e.headers),fetch(r,l).then((function(e){var n={},i="",r=e.headers;r&&r.forEach((function(e,t){n[t]=e})),e.body&&e.text().then((function(e){i=e})),o||(o=!0,K(t,e.status,n,i),oe(i))})).catch((function(e){o||(o=!0,K(t,0,{}))})),a&&!o&&(o=!0,K(t,200,{})),!o&&e.timeout>0&&s.set((function(){o||(o=!0,K(t,500,{}))}),e.timeout)}function z(e,t,n){var i=e.urlString;function r(e,t,n){if(!e[n]&&t&&t.getResponseHeader){var i=t.getResponseHeader(n);i&&(e[n]=Object(S.K)(i))}return e}function s(e,n){K(t,e.status,function(e){var t={};return e.getAllResponseHeaders?t=function(e){var t={};if(Object(S.t)(e)){var n=Object(S.K)(e).split(/[\r\n]+/);Object(S.a)(n,(function(e){if(e){var n=e.indexOf(": ");if(-1!==n){var i=Object(S.K)(e.substring(0,n)).toLowerCase(),r=Object(S.K)(e.substring(n+1));t[i]=r}else t[Object(S.K)(e)]=1}}))}return t}(e.getAllResponseHeaders()):(t=r(t,e,"time-delta-millis"),t=r(t,e,"kill-duration"),t=r(t,e,"kill-duration-seconds")),t}(e),n)}n&&e.disableXhrSync&&(n=!1);var a=function(e,t,n,i,r,s){function a(e,t,n){try{e[t]=n}catch(e){}}void 0===i&&(i=!1),void 0===r&&(r=!1);var o=new XMLHttpRequest;return i&&a(o,"Microsoft_ApplicationInsights_BypassAjaxInstrumentation",i),n&&a(o,"withCredentials",n),o.open("POST",t,!r),n&&a(o,"withCredentials",n),!r&&s&&a(o,"timeout",s),o}(0,i,T,!0,n,e.timeout);Object(S.A)(e.headers,(function(e,t){a.setRequestHeader(e,t)})),a.onload=function(){var e=Jt(a);s(a,e),oe(e)},a.onerror=function(){s(a)},a.ontimeout=function(){s(a)},a.send(e.data)}function K(e,t,n,i){try{e(t,n,i)}catch(e){J(o,2,518,k(e))}}function Y(e,t,n){var i=200,r=e._thePayload,s=e.urlString+(p?"&NoResponseBody=true":"");try{var a=L();if(!a.sendBeacon(s,e.data))if(r){var l=[];Object(S.a)(r.batches,(function(e){if(l&&e&&e.count()>0){for(var t=e.events(),n=0;n<t.length;n++)if(!a.sendBeacon(s,P.getEventBlob(t[n]))){l.push(e.split(n));break}}else l.push(e.split(0))})),le(l,8003,r.sendType,!0)}else i=0}catch(e){ee(o,"Failed to send telemetry using sendBeacon API. Ex:"+k(e)),i=0}finally{K(t,i,{},"")}}function q(e){return 2===e||3===e}function Q(e){return w&&q(e)&&(e=2),e}function Z(){return!E&&I<n}function $(){var e=D;return D=[],e}function te(e,t,n){var i=!1;return e&&e.length>0&&!E&&l[t]&&P&&(i=0!==t||Z()&&(n>0||A.allowRequestSending())),i}function ne(e){var t={};return e&&Object(S.a)(e,(function(e,n){t[n]={iKey:e.iKey(),evts:e.events()}})),t}function ie(e,n,i,r,s){if(e&&0!==e.length)if(E)le(e,1,r);else{r=Q(r);try{var a=e,d=0!==r;rt(c,(function(){return"HttpManager:_sendBatches"}),(function(a){a&&(e=e.slice(0));for(var o=[],c=null,h=Pt(),u=l[r]||(d?l[1]:l[0]),f=u&&u._transport,p=m&&(w||q(r)||3===f||u._isSync&&2===f);te(e,r,n);){var g=e.shift();g&&g.count()>0&&(v.isTenantKilled(g.iKey())?o.push(g):(c=c||P.createPayload(n,i,d,p,s,r),P.appendPayload(c,g,t)?null!==c.overflow&&(e=[c.overflow].concat(e),c.overflow=null,se(c,h,Pt(),s),h=Pt(),c=null):(se(c,h,Pt(),s),h=Pt(),e=[g].concat(e),c=null)))}c&&se(c,h,Pt(),s),e.length>0&&(D=e.concat(D)),le(o,8004,r)}),(function(){return{batches:ne(a),retryCount:n,isTeardown:i,isSynchronous:d,sendReason:s,useSendBeacon:q(r),sendType:r}}),!d)}catch(e){J(o,2,48,"Unexpected Exception sending batch: "+k(e))}}}function re(e,t,n){e[t]=e[t]||{},e[t][a.identifier]=n}function se(t,n,r,s){if(t&&t.payloadBlob&&t.payloadBlob.length>0){var d=!!e.sendHook,m=l[t.sendType];!q(t.sendType)&&t.isBeacon&&2===t.sendReason&&(m=l[2]||l[3]||m);var p=B;(t.isBeacon||3===m._transport)&&(p=!1);var E=function(e,t){var n={url:g,hdrs:{},useHdrs:!1};t?(n.hdrs=Dt(n.hdrs,x),n.useHdrs=Object(S.C)(n.hdrs).length>0):Object(S.A)(x,(function(e,t){Zt[e]?tn(n,Zt[e],t,!1):(n.hdrs[e]=t,n.useHdrs=!0)})),tn(n,"client-id","NO_AUTH",t),tn(n,"client-version","1DS-Web-JS-3.2.14",t);var i="";Object(S.a)(e.apiKeys,(function(e){i.length>0&&(i+=","),i+=e})),tn(n,"apikey",i,t),tn(n,"upload-time",Object(S.e)().toString(),t);var r=function(e){for(var t=0;t<e.batches.length;t++){var n=e.batches[t].Msfpc();if(n)return encodeURIComponent(n)}return""}(e);if(Ot(r)&&(n.url+="&ext.intweb.msfpc="+r),A.shouldAddClockSkewHeaders()&&tn(n,"time-delta-to-apply-millis",A.getClockSkewHeaderValue(),t),c.getWParam){var s=c.getWParam();s>=0&&(n.url+="&w="+s)}for(var a=0;a<O.length;a++)n.url+="&"+O[a].name+"="+O[a].value;return n}(t,p);p=p||E.useHdrs;var T=Pt();rt(c,(function(){return"HttpManager:_doPayloadSend"}),(function(){for(var l=0;l<t.batches.length;l++)for(var g=t.batches[l].events(),b=0;b<g.length;b++){var R=g[b];if(F){var y=R.timings=R.timings||{};re(y,"sendEventStart",T),re(y,"serializationStart",n),re(y,"serializationCompleted",r)}R.sendAttempt>0?R.sendAttempt++:R.sendAttempt=1}le(t.batches,1e3+(s||0),t.sendType,!0);var M={data:t.payloadBlob,urlString:E.url,headers:E.hdrs,_thePayload:t,_sendReason:s,timeout:h,disableXhrSync:u,disableFetchKeepAlive:f};p&&(en(M.headers,"cache-control")||(M.headers["cache-control"]="no-cache, no-store"),en(M.headers,"content-type")||(M.headers["content-type"]="application/x-json-stream"));var O=null;m&&(O=function(n){A.firstRequestSent();var r=function(n,r){!function(t,n,r,s){var o,l=9e3,c=null,d=!1,h=!1;try{var u=!0;if(typeof t!==_.l){if(n){A.setClockSkew(n["time-delta-millis"]);var f=n["kill-duration"]||n["kill-duration-seconds"];Object(S.a)(v.setKillSwitchTenants(n["kill-tokens"],f),(function(e){Object(S.a)(r.batches,(function(t){if(t.iKey()===e){c=c||[];var n=t.split(0);r.numEvents-=n.count(),c.push(n)}}))}))}if(200==t||204==t)return void(l=200);((o=t)>=300&&o<500&&408!=o&&429!=o||501==o||505==o||r.numEvents<=0)&&(u=!1),l=9e3+t%1e3}if(u){l=100;var m=r.retryCnt;0===r.sendType&&(m<i?(d=!0,ae((function(){0===r.sendType&&I--,ie(r.batches,m+1,r.isTeardown,w?2:r.sendType,5)}),w,Wt(m))):(h=!0,w&&(l=8001)))}}finally{d||(A.setClockSkew(),function(t,n,i,r){try{r&&a._backOffTransmission(),200===n&&(r||t.isSync||a._clearBackOff(),function(e){if(F){var t=Pt();Object(S.a)(e,(function(e){var n,i;e&&e.count()>0&&(n=e.events(),i=t,F&&Object(S.a)(n,(function(e){re(e.timings=e.timings||{},"sendEventCompleted",i)})))}))}}(t.batches)),le(t.batches,n,t.sendType,!0)}finally{0===t.sendType&&(I--,5!==i&&e.sendQueuedRequests(t.sendType,i))}}(r,l,s,h)),le(c,8004,r.sendType)}}(n,r,t,s)},l=t.isTeardown||t.isSync;try{m.sendPOST(n,r,l),e.sendListener&&e.sendListener(M,n,l,t.isBeacon)}catch(e){ee(o,"Unexpected exception sending payload. Ex:"+k(e)),K(r,0,{})}}),rt(c,(function(){return"HttpManager:_doPayloadSend.sender"}),(function(){if(O)if(0===t.sendType&&I++,d&&!t.isBeacon&&3!==m._transport){var n={data:M.data,urlString:M.urlString,headers:Dt({},M.headers),timeout:M.timeout,disableXhrSync:M.disableXhrSync,disableFetchKeepAlive:M.disableFetchKeepAlive},i=!1;rt(c,(function(){return"HttpManager:_doPayloadSend.sendHook"}),(function(){try{e.sendHook(n,(function(e){i=!0,C||e._thePayload||(e._thePayload=e._thePayload||M._thePayload,e._sendReason=e._sendReason||M._sendReason),O(e)}),t.isSync||t.isTeardown)}catch(e){i||O(M)}}))}else O(M)}))}),(function(){return{thePayload:t,serializationStart:n,serializationCompleted:r,sendReason:s}}),t.isSync)}t.sizeExceed&&t.sizeExceed.length>0&&le(t.sizeExceed,8003,t.sendType),t.failedEvts&&t.failedEvts.length>0&&le(t.failedEvts,8002,t.sendType)}function ae(e,t,n){t?e():s.set(e,n)}function oe(t){var n=e._responseHandlers;try{for(var i=0;i<n.length;i++)try{n[i](t)}catch(e){J(o,1,519,"Response handler failed: "+e)}if(t){var r=JSON.parse(t);Ot(r.webResult)&&Ot(r.webResult.msfpc)&&d.set("MSFPC",r.webResult.msfpc,31536e3)}}catch(e){}}function le(e,t,n,i){if(e&&e.length>0&&r){var s=r[(l=t,d=qt[l],Ot(d)||(d="oth",l>=9e3&&l<=9999?d="rspFail":l>=8e3&&l<=8999?d="drop":l>=1e3&&l<=1999&&(d="send")),d)];if(s){var a=0!==n;rt(c,(function(){return"HttpManager:_sendBatchesNotification"}),(function(){ae((function(){try{s.call(r,e,t,a,n)}catch(e){J(o,1,74,"send request notification failed: "+e)}}),i||a,0)}),(function(){return{batches:ne(e),reason:t,isSync:a,sendSync:i,sendType:n}}),!a)}}var l,d}e.initialize=function(e,t,n,i,r){var s;r||(r={}),g=e+g,B=!!Object(S.w)(r.avoidOptions)||!r.avoidOptions,c=t,d=t.getCookieMgr(),F=!c.config.disableEventTimings;var _=!!c.config.enableCompoundKey;o=(a=n).diagLog();var v=r.valueSanitizer,E=r.stringifyObjects;Object(S.w)(r.enableCompoundKey)||(_=!!r.enableCompoundKey),h=r.xhrTimeout,u=!!r.disableXhrSync,f=!!r.disableFetchKeepAlive,p=!1!==r.addNoResponse,b=!U(),P=new Kt(c,v,E,_),Object(S.q)(r.useSendBeacon)||(b=!!r.useSendBeacon);var A=i,I=r.alwaysUseXhrOverride?i:null,R=r.alwaysUseXhrOverride?i:null,y=[3,2];if(!i){C=!1;var M=N();M&&M.protocol&&"file:"===M.protocol.toLowerCase()&&(T=!1);var O=[];U()?(O=[2,1],y=[2,1,3]):O=[1,2,3],(i=W(O=nn(O,r.transports),!1))||ee(o,"No available transport to send events"),A=W(O,!0)}I||(I=W(y=nn(y,r.unloadTransports),!0)),m=!C&&(b&&V()||!f&&G(!0)),(s={})[0]=i,s[1]=A||W([1,2,3],!0),s[2]=I||A||W([1],!0),s[3]=R||W([2,3],!0)||A||W([1],!0),l=s},e._getDbgPlgTargets=function(){return[l[0],v,P,l]},e.addQueryStringParameter=function(e,t){for(var n=0;n<O.length;n++)if(O[n].name===e)return void(O[n].value=t);O.push({name:e,value:t})},e.addHeader=function(e,t){x[e]=t},e.canSendRequest=function(){return Z()&&A.allowRequestSending()},e.sendQueuedRequests=function(e,t){Object(S.w)(e)&&(e=0),w&&(e=Q(e),t=2),te(D,e,0)&&ie($(),0,!1,e,t||0)},e.isCompletelyIdle=function(){return!E&&0===I&&0===D.length},e.setUnloading=function(e){w=e},e.addBatch=function(e){if(e&&e.count()>0){if(v.isTenantKilled(e.iKey()))return!1;D.push(e)}return!0},e.teardown=function(){D.length>0&&ie($(),0,!0,2,2)},e.pause=function(){E=!0},e.resume=function(){E=!1,e.sendQueuedRequests(0,4)},e.sendSynchronousBatch=function(e,t,n){e&&e.count()>0&&(Object(S.q)(t)&&(t=1),w&&(t=Q(t),n=2),ie([e],0,!1,t,n||0))}}))}return e.__ieDyn=1,e}();function sn(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return setTimeout(e,t,n)}function an(e){clearTimeout(e)}function on(e,t){return{set:e||sn,clear:t||an}}var ln=function(e){function t(){var n,i=e.call(this)||this;i.identifier="PostChannel",i.priority=1011,i.version="3.2.14";var r,s,a,o,l,c,d,h=!1,u=[],f=null,m=!1,p=0,g=500,_=0,v=1e4,A={},b="REAL_TIME",I=null,R=null,C=0,y=0,O={},P=-1,L=!0,N=!1,F=6,w=2;return Object(T.a)(t,i,(function(e,t){function i(e){"beforeunload"!==(e||x().event).type&&(N=!0,s.setUnloading(N)),X(2,2)}function T(e){N=!1,s.setUnloading(N)}function U(e,t){if(e.sendAttempt||(e.sendAttempt=0),e.latency||(e.latency=1),e.ext&&e.ext.trace&&delete e.ext.trace,e.ext&&e.ext.user&&e.ext.user.id&&delete e.ext.user.id,L&&(e.ext=Object(S.D)(e.ext),e.baseData&&(e.baseData=Object(S.D)(e.baseData)),e.data&&(e.data=Object(S.D)(e.data))),e.sync)if(C||m)e.latency=3,e.sync=!1;else if(s)return L&&(e=Object(S.D)(e)),void s.sendSynchronousBatch(Vt.create(e.iKey,[e]),!0===e.sync?1:e.sync,3);var n=e.latency,i=_,r=v;4===n&&(i=p,r=g);var a=!1;if(i<r)a=!K(e,t);else{var o=1,l=20;4===n&&(o=4,l=1),a=!0,function(e,t,n,i){for(;n<=t;){var r=j(e,t,!0);if(r&&r.count()>0){var s=r.split(0,i),a=s.count();if(a>0)return 4===n?p-=a:_-=a,te("eventsDiscarded",[s],Ut.QueueFull),!0}n++}return Y(),!1}(e.iKey,e.latency,o,l)&&(a=!K(e,t))}a&&ee("eventsDiscarded",[e],Ut.QueueFull)}function B(e,t,n){var i=q(e,t,n);return s.sendQueuedRequests(t,n),i}function k(){return _>0}function V(){if(P>=0&&q(P,0,l)&&s.sendQueuedRequests(0,l),p>0&&!R&&!m){var e=A[b][2];e>=0&&(R=H((function(){R=null,B(4,0,1),V()}),e))}var t=A[b][1];!I&&!f&&t>=0&&!m&&(k()?I=H((function(){I=null,B(0===y?3:1,0,1),y++,y%=2,V()}),t):y=0)}function G(){n=null,h=!1,u=[],f=null,m=!1,p=0,g=500,_=0,v=1e4,A={},b="REAL_TIME",I=null,R=null,C=0,y=0,r=null,O={},a=void 0,o=0,P=-1,l=null,L=!0,N=!1,F=6,w=2,c=null,d=on(),s=new rn(500,2,1,{requeue:Z,send:ne,sent:ie,drop:re,rspFail:se,oth:ae},d),Q(),O[4]={batches:[],iKeyMap:{}},O[3]={batches:[],iKeyMap:{}},O[2]={batches:[],iKeyMap:{}},O[1]={batches:[],iKeyMap:{}},oe()}function H(e,t){0===t&&C&&(t=1);var n=1e3;return C&&(n=Wt(C-1)),d.set(e,t*n)}function W(){return null!==I&&(d.clear(I),I=null,y=0,!0)}function X(e,t){W(),f&&(d.clear(f),f=null),m||B(1,e,t)}function j(e,t,n){var i=O[t];i||(i=O[t=1]);var r=i.iKeyMap[e];return!r&&n&&(r=Vt.create(e),i.batches.push(r),i.iKeyMap[e]=r),r}function z(t,n){s.canSendRequest()&&!C&&(a>0&&_>a&&(n=!0),n&&null==f&&e.flush(t,null,20))}function K(e,t){L&&(e=Object(S.D)(e));var n=e.latency,i=j(e.iKey,n,!0);return!!i.addEvent(e)&&(4!==n?(_++,t&&0===e.sendAttempt&&z(!e.sync,o>0&&i.count()>=o)):p++,!0)}function Y(){for(var e=0,t=0,n=function(n){var i=O[n];i&&i.batches&&Object(S.a)(i.batches,(function(i){4===n?e+=i.count():t+=i.count()}))},i=1;i<=4;i++)n(i);_=t,p=e}function q(t,n,i){var r=!1,a=0===n;return!a||s.canSendRequest()?rt(e.core,(function(){return"PostChannel._queueBatches"}),(function(){for(var e=[],n=4;n>=t;){var i=O[n];i&&i.batches&&i.batches.length>0&&(Object(S.a)(i.batches,(function(t){s.addBatch(t)?r=r||t&&t.count()>0:e=e.concat(t.events()),4===n?p-=t.count():_-=t.count()})),i.batches=[],i.iKeyMap={}),n--}e.length>0&&ee("eventsDiscarded",e,Ut.KillSwitch),r&&P>=t&&(P=-1,l=0)}),(function(){return{latency:t,sendType:n,sendReason:i}}),!a):(P=P>=0?Math.min(P,t):t,l=Math.max(l,i)),r}function Q(){(A={}).REAL_TIME=[2,1,0],A.NEAR_REAL_TIME=[6,3,0],A.BEST_EFFORT=[18,9,0]}function Z(t,n){var i=[],r=F;N&&(r=w),Object(S.a)(t,(function(t){t&&t.count()>0&&Object(S.a)(t.events(),(function(t){t&&(t.sync&&(t.latency=4,t.sync=!1),t.sendAttempt<r?(Lt(t,e.identifier),U(t,!1)):i.push(t))}))})),i.length>0&&ee("eventsDiscarded",i,Ut.NonRetryableStatus),N&&X(2,2)}function $(t,n){var i=e._notificationManager||{},r=i[t];if(r)try{r.apply(i,n)}catch(n){J(e.diagLog(),1,74,t+" notification failed: "+n)}}function ee(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];t&&t.length>0&&$(e,[t].concat(n))}function te(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];t&&t.length>0&&Object(S.a)(t,(function(t){t&&t.count()>0&&$(e,[t.events()].concat(n))}))}function ne(e,t,n){e&&e.length>0&&$("eventsSendRequest",[t>=1e3&&t<=1999?t-1e3:0,!0!==n])}function ie(e,t){te("eventsSent",e,t),V()}function re(e,t){te("eventsDiscarded",e,t>=8e3&&t<=8999?t-8e3:Ut.Unknown)}function se(e){te("eventsDiscarded",e,Ut.NonRetryableStatus),V()}function ae(e,t){te("eventsDiscarded",e,Ut.Unknown),V()}function oe(){o=n&&n.disableAutoBatchFlushLimit?0:Math.max(1500,v/6)}G(),e._getDbgPlgTargets=function(){return[s]},e.initialize=function(o,l,h){rt(l,(function(){return"PostChannel:initialize"}),(function(){var u=l;t.initialize(o,l,h);try{l.addUnloadCb,c=He(Me(e.identifier),l.evtNamespace&&l.evtNamespace());var f=e._getTelCtx();o.extensionConfig[e.identifier]=o.extensionConfig[e.identifier]||{},n=f.getExtCfg(e.identifier),d=on(n.setTimeoutOverride,n.clearTimeoutOverride),L=!n.disableOptimizeObj&&!!M("chrome"),function(e){var t=e.getWParam;e.getWParam=function(){var e=0;return n.ignoreMc1Ms0CookieProcessing&&(e|=2),e|t()}}(u),n.eventsLimitInMem>0&&(v=n.eventsLimitInMem),n.immediateEventLimit>0&&(g=n.immediateEventLimit),n.autoFlushEventsLimit>0&&(a=n.autoFlushEventsLimit),Object(S.r)(n.maxEventRetryAttempts)&&(F=n.maxEventRetryAttempts),Object(S.r)(n.maxUnloadEventRetryAttempts)&&(w=n.maxUnloadEventRetryAttempts),oe(),n.httpXHROverride&&n.httpXHROverride.sendPOST&&(r=n.httpXHROverride),Ot(o.anonCookieName)&&s.addQueryStringParameter("anoncknm",o.anonCookieName),s.sendHook=n.payloadPreprocessor,s.sendListener=n.payloadListener;var m=n.overrideEndpointUrl?n.overrideEndpointUrl:o.endpointUrl;e._notificationManager=l.getNotifyMgr(),s.initialize(m,e.core,e,r,n);var p=o.disablePageUnloadEvents||[];(function(e,t,n,i){var r=!1;t&&e&&Object(S.k)(e)&&!(r=ze(e,t,n,i))&&n&&n[E.x]>0&&(r=ze(e,t,null,i))})(["beforeunload","unload","pagehide"],i,p,c),function e(t,n,i){var r=He(xe,i),s=ze(["pagehide"],t,n,r);return n&&-1!==Object(S.b)(n,"visibilitychange")||(s=ze(["visibilitychange"],(function(e){var n=D();t&&n&&"hidden"===n.visibilityState&&t(e)}),n,r)||s),!s&&n&&(s=e(t,null,i)),s}(i,p,c),function e(t,n,i){var r=He(De,i),s=ze(["pageshow"],t,n,r);return!(s=ze(["visibilitychange"],(function(e){var n=D();t&&n&&"visible"===n.visibilityState&&t(e)}),n,r)||s)&&n&&(s=e(t,null,i)),s}(T,o.disablePageShowEvents,c)}catch(t){throw e.setInitialized(!1),t}}),(function(){return{coreConfig:o,core:l,extensions:h}}))},e.processTelemetry=function(t,i){Lt(t,e.identifier);var r=(i=e._getTelCtx(i)).getExtCfg(e.identifier),s=!!n.disableTelemetry;r&&(s=s||!!r.disableTelemetry);var a=t;s||h||(n.overrideInstrumentationKey&&(a.iKey=n.overrideInstrumentationKey),r&&r.overrideInstrumentationKey&&(a.iKey=r.overrideInstrumentationKey),U(a,!0),N?X(2,2):V()),e.processNext(a,i)},e._doTeardown=function(e,t){X(2,2),h=!0,s.teardown(),Ke(["beforeunload","unload","pagehide"],null,c),function(e,t){var n=He(xe,t);Ke(["pagehide"],null,n),Ke(["visibilitychange"],null,n)}(0,c),function(e,t){var n=He(De,t);Ke(["pageshow"],null,n),Ke(["visibilitychange"],null,n)}(0,c),G()},e.setEventQueueLimits=function(e,t){v=e>0?e:1e4,a=t>0?t:0,oe();var n=_>e;if(!n&&o>0)for(var i=1;!n&&i<=3;i++){var r=O[i];r&&r.batches&&Object(S.a)(r.batches,(function(e){e&&e.count()>=o&&(n=!0)}))}z(!0,n)},e.pause=function(){W(),m=!0,s.pause()},e.resume=function(){m=!1,s.resume(),V()},e.addResponseHandler=function(e){s._responseHandlers.push(e)},e._loadTransmitProfiles=function(e){W(),Q(),b="REAL_TIME",V(),Object(S.A)(e,(function(e,t){var n=t.length;if(n>=2){var i=n>2?t[2]:0;if(t.splice(0,n-2),t[1]<0&&(t[0]=-1),t[1]>0&&t[0]>0){var r=t[0]/t[1];t[0]=Math.ceil(r)*t[1]}i>=0&&t[1]>=0&&i>t[1]&&(i=t[1]),t.push(i),A[e]=t}}))},e.flush=function(e,t,n){if(void 0===e&&(e=!0),!m)if(n=n||1,e)null==f?(W(),q(1,0,n),f=H((function(){f=null,function e(t,n){B(1,0,n),Y(),function e(t){s.isCompletelyIdle()?t():f=H((function(){f=null,e(t)}),.25)}((function(){t&&t(),u.length>0?f=H((function(){f=null,e(u.shift(),n)}),0):(f=null,V())}))}(t,n)}),0)):u.push(t);else{var i=W();B(1,1,n),null!=t&&t(),i&&V()}},e.setMsaAuthTicket=function(e){s.addHeader("AuthMsaDeviceTicket",e)},e.hasEvents=k,e._setTransmitProfile=function(e){b!==e&&void 0!==A[e]&&(W(),b=e,V())},e._backOffTransmission=function(){C<4&&(C++,W(),V())},e._clearBackOff=function(){C&&(C=0,W(),V())},Object(S.y)(e,"_setTimeoutOverride",(function(){return d.set}),(function(e){d=on(e,d.clear)})),Object(S.y)(e,"_clearTimeoutOverride",(function(){return d.clear}),(function(e){d=on(d.set,e)}))})),i}return Object(tt.a)(t,e),t.__ieDyn=1,t}(vt),cn=function(){function e(e,t,n){this.start=Date.now(),this.name=e,this.isAsync=!0===n,this.payload=t}return e.prototype.isChildEvt=function(){return!1},e.prototype.complete=function(){this.time=Date.now()-this.start,this.exTime=this.time},e}(),dn=function(){function e(e){this._callbacks=e}return e.prototype.create=function(e,t,n){return"HttpManager:_sendBatches"===e||"PrivacyGuard:_processTelemetry"===e?new cn(e,t,n):null},e.prototype.fire=function(e){if(e&&e.complete(),this._callbacks)switch(e.name){case"HttpManager:_sendBatches":this.handleSendBatches(e);break;case"PrivacyGuard:_processTelemetry":this.handlePrivacyGuardNotification(e)}},e.prototype.setCtx=function(e,t){},e.prototype.getCtx=function(e){},e.prototype.handleSendBatches=function(e){if(this._callbacks.requestProcessingStats){var t=0;if(e.payload){var n=e.payload();if(n.batches)for(var i in n.batches)t+=n.batches[i].evts.length}this._callbacks.requestProcessingStats(e.time||0,t)}},e.prototype.handlePrivacyGuardNotification=function(e){this._callbacks.privacyGuardStats&&e.time&&e.time>0&&this._callbacks.privacyGuardStats(e.time)},e}();function hn(e,t){var n=e.httpXHROverride,i={instrumentationKey:t,endpointUrl:e.endpointUrl,channelConfiguration:{eventsLimitInMem:e.eventsLimitInMem,httpXHROverride:n,setTimeoutOverride:e.setTimeoutOverride,clearTimeoutOverride:e.clearTimeoutOverride,ignoreMc1Ms0CookieProcessing:!0,disableOptimizeObj:!0},enableWParam:!n,disableCookiesUsage:!0,extensionConfig:Object(f.a)({},e.extensionConfig)};e.stats&&e.stats.networkStats&&i.channelConfiguration&&(i.channelConfiguration.payloadListener=function(t,n){var i,r=n||t;r.data&&(null===(i=e.stats)||void 0===i||i.networkStats(r.data.length))});var r=new fn;return r.initialize(i,e.plugins),r.setUploadFrequency(e.uploadFrequency),e.notificationListener&&r.addNotificationListener(e.notificationListener),e.stats&&r.setPerfMgr(new dn(e.stats)),r}var un=function(e,t){t&&t.addNotificationListener({eventsSent:function(t){Object(m.b)(2,2,(function(){return"Successfully sent ".concat(t.length," event(s)")})),Object(m.b)(3,2,(function(){return"Sent event(s) details : ".concat(JSON.stringify(t,null,2))})),e.eventsSent+=t.length},eventsDiscarded:function(t,n){Object(m.b)(0,2,(function(){return"Discarded ".concat(t.length," event(s) because ").concat(n)})),Object(m.b)(3,2,(function(){return"Discarded event(s) details : ".concat(JSON.stringify(t,null,2))})),e.eventsDiscarded+=t.length}})},fn=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Object(f.c)(t,e),t.prototype.initialize=function(t,n){this._postChannel=new ln;var i=null!=n?n:[];t.channels=[[this._postChannel]],t.extensionConfig=t.extensionConfig||[],t.extensionConfig[this._postChannel.identifier]=Object(f.a)(Object(f.a)({},t.channelConfiguration),t.extensionConfig[this._postChannel.identifier]);try{e.prototype.initialize.call(this,t,i)}catch(e){this.logger.warnToConsole("Failed to initialize SDK."+e)}},t.prototype.setUploadFrequency=function(e){if(this._postChannel&&e){var t=e/1e3,n=t/2,i={};i.OTelCustomTransmissionProfile=[t,n],this._postChannel._loadTransmitProfiles(i),this._postChannel._setTransmitProfile("OTelCustomTransmissionProfile")}},t.prototype.flush=function(e){this._postChannel&&this._postChannel.flush(e)},t.prototype.shutdown=function(){this._postChannel&&this._postChannel.teardown()},t}(wt),mn=function(e){function t(t,n){var i,r=e.call(this,t,n)||this;r.sendTelemetryEvent=function(e){return Object(p.m)((function(){var t=r.getOneDSTelemetryEvent(e);t&&i&&i.track(t)}),p.n)},r.sendCustomerContent=function(e){},r.sendNonStandardEvent=function(e,t){var n=!1;s.forEach((function(i){i.canHandle(t)&&(i.processEvent(e),n=!0)})),n||Object(m.b)(0,1,(function(){return"Missing Handler for "+t+"to process"+e.eventName}))},r.flush=function(e){null==i||i.flush(e),s.forEach((function(t){t.flush(e)}))},r.shutdown=function(){try{null==i||i.shutdown(),s.forEach((function(e){e.shutdown()}))}catch(e){Object(m.b)(0,2,(function(){return"An error occurred on shutdown"}))}};var s=n.nonStandardEventHandlers||[];if(i=hn(n,p.d),s.forEach((function(e){e.initialize(r,n)})),!n.endpointUrl)throw new Error("Missing Endpoint Url");return n.disableStatsTracking||un(r,i),r}return Object(f.c)(t,e),t}((function(e,t){var n=this;this.eventsProcessed=0,this.eventsSent=0,this.eventsDiscarded=0;var i=[],r=!1,s=!0,a={name:"DiagnosticLevel",processEvent:function(e){var t=e.eventFlags.diagnosticLevel;return r||10===t||110===t||120===t}},o={},l=Qe();this.init=function(e){return Object(p.i)(o,!1)},this.begin=function(){return s=s&&Object(p.i)(o,!0)},this.getOneDSTelemetryEvent=function(e){return c(e,{eventType:1})},this.getOneDSCustomerContent=function(e){var t=e.telemetryProperties.customerContentVersion;if(t&&Math.floor(t)<=2&&1===e.telemetryProperties.customerContentType)return c(e,{eventType:2})};var c=function(e,t){if(s){var r=Object(u.c)(e);if(Object(p.l)(r,i)){var a=Object(p.k)(r).toISOString(),c={"Event.Name":r.eventName,"Event.Source":"OTelJS","Event.Time":{value:a,propertyType:9}};for(var d in n.eventsProcessed++,c["Event.Sequence"]={value:n.eventsProcessed,propertyType:4},c["Event.Id"]=l+"."+n.eventsProcessed,o)c[d]=o[d];if(!Object(p.h)(c,r.dataFields,!0,t.eventType))return void Object(m.b)(0,1,(function(){return"Dropping Event: "+r.eventName}));var h="custom";r.eventContract&&(r.eventContract.name&&(c["Event.Contract"]=r.eventContract.name,h+="."+r.eventContract.name.toLowerCase().replace(/\./g,"_")),Object(p.h)(c,r.eventContract.dataFields,!1,t.eventType));var f=function(e,t){return 2===t?p.e:e.telemetryProperties&&(1!==t||e.telemetryProperties.ariaTenantToken)?1===t?e.telemetryProperties.ariaTenantToken:void 0:void Object(m.b)(0,1,(function(){return"Missing Aria Token"}))}(r,t.eventType);if(!f)return;return{iKey:f,name:r.eventName,data:c,time:a,baseType:h,ext:{sdk:{seq:n.eventsProcessed}}}}}};this.addPreprocessor=function(e){i.push(e)},this.getOneDSPersistentDataFields=function(){return o},this.getPreprocessors=function(){return i};var d=function(e){Object(p.h)(o,e,!1,1)};this.addPersistentDataFields=d,this.setOptionalEventsEnabled=function(e){r=e},this.setFullEventsEnabled=this.setOptionalEventsEnabled,t.enableOptionalEvents&&(r=!0),d(e);var h=t.coreFields;if(h){d(g.b.getFields(h.app)),d(g.g.getFields(h.user)),d(g.f.getFields(h.session));var f=h.release;f&&d(g.e.getFields(f))}this.addPreprocessor(a)})),pn=n(224);let gn=n(3).a.msoulscat_MSOSP_OTelJS;const _n=void 0,vn=!0,En=!1,Tn={enabled:!0,collectorEndpointEnum:"PUBLIC",collectorEndpointUrl:"",eventUploadFrequency:2e3,cacheMemorySizeLimitInNumberOfEvents:1e4,enableCustomerContent:!1,enableDNM:!1,enablePG:!1},Sn={enabled:!0,totalEventsThrottlePerSec:100,singleEventThrottlePerSec:20,eventNamesToBeSuppressedCommaSeparated:""},An={taskDurationLogFrequency:20,durationThreshold:100,reportTaskDetails:!1,sessionDurationCutoff:1e4},bn={enabled:!1,sampleRate:.02};function In(e,t){return null==e?t:e}function Rn(e,t){return null==e?t:e}function Cn(e,t){return null==e?t:e}var yn,Mn=n(272),On=n(271),xn=n(225),Dn=n(137);class Pn{setLogOtelTelemetryEventFunc(e){this.logOtelEvent=e}resetStats(){this.stats={processed:0,sent:0,throttled:0,sampledNotSent:0,dropped:0,droppedDetails:{},eventsProcessingTime:0,taskExecutionTime:0,taskExecutionCount:0,bytesOverWire:0,eventSerializationTime:0,eventTransmissionTime:0,oteljsVersion:xn.a},this.taskStats={taskExecutionTimes:[],taskExecutionTimesDetails:[]}}logSessionStatsViaUls(){this.computeSessionAverages(),d.a.sendTraceTag(this.config.tags.sessionStats,gn,h.a.Info,JSON.stringify(this.stats))}logSessionStatsViaOTel(){if(this.computeSessionAverages(),this.logOtelEvent){const e={eventName:this.config.tags.sessionStatsEventName,dataFields:[{name:"Processed",value:this.stats.processed,dataType:Dn.a.DataFieldType.Double},{name:"Sent",value:this.stats.sent,dataType:Dn.a.DataFieldType.Double},{name:"Throttled",value:this.stats.throttled,dataType:Dn.a.DataFieldType.Double},{name:"SampledNotSent",value:this.stats.sampledNotSent,dataType:Dn.a.DataFieldType.Double},{name:"Dropped",value:this.stats.dropped,dataType:Dn.a.DataFieldType.Double},{name:"EventsProcessingTime",value:this.stats.eventsProcessingTime,dataType:Dn.a.DataFieldType.Double},{name:"TaskExecutionTime",value:this.stats.taskExecutionTime,dataType:Dn.a.DataFieldType.Double},{name:"TaskExecutionCount",value:this.stats.taskExecutionCount,dataType:Dn.a.DataFieldType.Double},{name:"BytesOverWire",value:this.stats.bytesOverWire,dataType:Dn.a.DataFieldType.Double},{name:"AverageProcessingTimeCostPerEvent",value:this.stats.averageProcessingTimeCostPerEvent||0,dataType:Dn.a.DataFieldType.Double}],eventFlags:{}};this.logOtelEvent(e)}}computeSessionAverages(){this.stats.processed>0&&(this.stats.averageTimeCostPerEvent=+((this.stats.eventsProcessingTime+this.stats.taskExecutionTime)/this.stats.processed).toFixed(3),this.stats.averageProcessingTimeCostPerEvent=+(this.stats.eventsProcessingTime/this.stats.processed).toFixed(4),this.stats.averageTaskTimeCostPerEvent=+(this.stats.taskExecutionTime/this.stats.processed).toFixed(4),this.stats.averageNetworkCostPerEvent=+(this.stats.bytesOverWire/this.stats.processed).toFixed(0))}logAndClearTaskStats(){this.taskStats.taskExecutionTimes.length<=0||(d.a.sendTraceTag(this.config.tags.taskStats,gn,h.a.Info,this.taskStats.taskExecutionTimes.join(",")),this.config.settings.reportTaskDetails&&d.a.sendTraceTag(this.config.tags.taskDetailsStats,gn,h.a.Info,JSON.stringify(this.taskStats.taskExecutionTimesDetails)),this.taskStats={taskExecutionTimes:[],taskExecutionTimesDetails:[]})}recordUploadTaskDuration(e,t,n,i){if(e>this.config.settings.durationThreshold&&d.a.sendTraceTag(this.config.tags.taskDurationThresholdExceeded,gn,h.a.Info,`Task took ${e} ms`),this.stats.taskExecutionTime+=e,t>0){const r=+e.toFixed(3);this.stats.taskExecutionCount+=1,this.taskStats.taskExecutionTimes.push(r),this.stats.eventSerializationTime+=n||0,this.stats.eventTransmissionTime+=i||0,this.taskStats.taskExecutionTimesDetails.push({x:Date.now(),e:t,c:r,s:n,t:i}),this.taskStats.taskExecutionTimes.length>=this.config.settings.taskDurationLogFrequency&&this.logAndClearTaskStats()}}checkAndLogPipelineHealth(){const e=Date.now()-this.config.sdkInitializationTime;this.stats.processed>0&&0===this.stats.sent&&(this.stats.dropped>0||e>this.config.settings.sessionDurationCutoff)&&d.a.sendTraceTag(this.config.tags.sdkHealth,gn,h.a.Warning,`Telemetry pipeline might be malfunctioning: Processed=${this.stats.processed}, Sent=${this.stats.sent}, Dropped=${this.stats.dropped}, SessionDuration=${e} ms`)}constructor(e){this.stats=void 0,this.taskStats=void 0,this.config=e,this.logOtelEvent=void 0,this.resetStats()}}var Ln,Nn=((yn={})[3]=p.a,yn[4]=p.b,yn[5]=p.c,yn[2]=p.g,yn[1]=p.f,yn),Fn=function(e){var t,n,i=this;this.eventsProcessed=0;this.initialize=function(i,r){var s=Object(f.a)(Object(f.a)({},r),{endpointUrl:e.endpointUrl,extensionConfig:Object(f.a)(Object(f.a)({},r.extensionConfig),{PrivacyGuardPlugin:{}}),plugins:[],nonStandardEventHandlers:[]});t=hn(s,"67074e509c164bcaaf85b53c0ad0cde2-13c1c869-7901-4e72-b536-9e754e3b7413-6518"),s.disableStatsTracking||un(i,t),n=i},this.shutdown=function(){null==t||t.shutdown()},this.flush=function(e){null==t||t.flush(e)},this.canHandle=function(e){return 3===e},this.processEvent=function(e){return i.eventsProcessed++,Object(p.m)((function(){var i=function(e){var t,i=Object(u.c)(e),r=[];if(n.getPreprocessors().forEach((function(e){"EventThrottler"===e.name&&r.push(e)})),Object(p.l)(i,r)){var s=Object(p.j)(i),a={"Event.Name":i.eventName,"Event.Source":"OTelJS","Event.Time":{value:s.toISOString(),propertyType:9}},o=function(e,t){var n={};return t&&t.forEach((function(t){var i=Nn[t];n[i]=e[i]})),n}(n.getOneDSPersistentDataFields(),null===(t=null==e?void 0:e.telemetryProperties)||void 0===t?void 0:t.dnmAllowedPartA);for(var l in o)a[l]=o[l];if(!Object(p.h)(a,i.dataFields,!0,3))return void Object(m.b)(0,1,(function(){return"Dropping Event: "+i.eventName}));var c=function(e){if(e.telemetryProperties&&e.telemetryProperties.dnmToken)return e.telemetryProperties.dnmToken;Object(m.b)(0,1,(function(){return"Missing DNM Token"}))}(i);if(!c)return;return{iKey:c,name:i.eventName,data:a,time:s.toISOString(),baseType:"custom",ext:{sdk:{seq:0},utc:{eventFlags:2097152}}}}}(e);i&&t&&(null==t||t.track(i))}),p.n)}},wn=function(){var e,t,n=this;this.eventsProcessed=0,this.initialize=function(n,i){var r=function(e){switch(e){case et.a.PUBLIC:return"https://office-c.events.data.microsoft.com/OneCollector/1.0/";case et.a.EUDB:return"https://eu-office-c.events.data.microsoft.com/OneCollector/1.0/";default:return}}(i.endpointUrl);if(r){var s=Object(f.a)(Object(f.a)({},i),{endpointUrl:r,extensionConfig:Object(f.a)(Object(f.a)({},i.extensionConfig),{PrivacyGuardPlugin:{}}),nonStandardEventHandlers:[],plugins:[]});e=hn(s,p.e),i.disableStatsTracking||un(n,e),t=n}else Object(m.b)(0,1,(function(){return"Missing 1DS CCCO Endpoint"}))},this.shutdown=function(){null==e||e.shutdown()},this.flush=function(t){null==e||e.flush(t)},this.canHandle=function(e){return t&&2===e},this.processEvent=function(i){return n.eventsProcessed++,Object(p.m)((function(){var n=t.getOneDSCustomerContent(i);n&&e&&(null==e||e.track(n))}),p.n)}};function Un(e,t,n){const i=function(e,t){let n;n=e.collectorEndpointUrl?e.collectorEndpointUrl:function(e){let t=et.a[e];return void 0===t&&(d.a.sendTraceTag(593597411,gn,h.a.Error,`Unknown 1DS endpoint ${e} - defaulting to Public one`),t=et.a.PUBLIC),t}(e.collectorEndpointEnum);const i={endpointUrl:n,notificationListener:new Vn(t),uploadFrequency:e.eventUploadFrequency,eventsLimitInMem:e.cacheMemorySizeLimitInNumberOfEvents,stats:{requestProcessingStats:(e,n)=>{t.recordUploadTaskDuration(e,n)},networkStats:e=>{t.stats.bytesOverWire+=e}},disableStatsTracking:!0,extensionConfig:{PostChannel:{enableCompoundKey:!0}},enableOptionalEvents:!0,nonStandardEventHandlers:[]};var r,s;return e.enableDNM&&(null===(r=i.nonStandardEventHandlers)||void 0===r||r.push(new Fn({endpointUrl:et.a.PUBLIC}))),e.enableCustomerContent&&(null===(s=i.nonStandardEventHandlers)||void 0===s||s.push(new wn)),i}(e,n);return new mn(t||[],i)}function Bn(e,t,n){const i=new Mn.a;return"number"==typeof n&&i.setSampleRate(n),e&&i.enableWithIdentifier("PrimaryIdentityHash",e)||t&&i.enableWithIdentifier("SessionId",t)?i:void 0}function kn(e){return new On.a("WACAriaSink",e)}!function(e){e[e.Unknown=0]="Unknown",e[e.NonRetryableStatus=1]="NonRetryableStatus",e[e.InvalidEvent=2]="InvalidEvent",e[e.SizeLimitExceeded=3]="SizeLimitExceeded",e[e.KillSwitch=4]="KillSwitch",e[e.QueueFull=5]="QueueFull"}(Ln||(Ln={}));class Vn{eventsSent(e){this.reporter.stats.sent+=e.length}eventsDiscarded(e,t){const n=Ln[t]||t.toString();this.reporter.stats.droppedDetails[n]=this.reporter.stats.droppedDetails[n]+e.length||e.length,this.reporter.stats.dropped+=e.length}constructor(e){this.reporter=e}}var Gn=n(65);class Hn{setupSampler(e,t,n){this._eventSampler=e(t.loggableUserId,t.sessionId,n),this._eventSampler&&d.a.sendTraceTag(577275598,gn,h.a.Info,"Sampler added. Measures enabled: "+this._eventSampler.isMeasuresEnabled())}pingCollectorPingUrl(){!function(e){try{const t=new XMLHttpRequest;t.open("GET",e,!0),t.onreadystatechange=function(){4===t.readyState&&(200===t.status?t.responseText.toLowerCase().indexOf("ok")>-1?d.a.sendTraceTag(593597389,gn,h.a.Info,"Collector ping 200 OK."):d.a.sendTraceTag(593597390,gn,h.a.Warning,"Collector ping 200 OK but with invalid response."):d.a.sendTraceTag(593597391,gn,h.a.Warning,"Collector ping returned with HTTP "+t.status.toString()))},t.send()}catch(e){d.a.sendTraceTag(593597392,gn,h.a.Warning,"Collector ping failed with error: "+e.toString())}}(this._collectorPingUrl)}pingCollectorEndpoint(){}setTenantToken(e,t){t&&this._logger.setTenantToken(e,t,u.b)}setDNMToken(e,t){t&&this._logger.setDNMToken(e,t)}processEvent(e,t){let n=!1,i=!1;const r=Object(Gn.c)(),s=u.c(e);this._throttlingEnabled&&!this._eventThrottler.processEvent(s)?n=!0:this._enabled&&(this._eventSampler&&!this._eventSampler.processEvent(s)?i=!0:t(s)),this._reporter.stats.eventsProcessingTime+=Object(Gn.c)()-r,n?(this._reporter.stats.throttled+=1,this._throttledEvent.fireEvent(e)):i?this._reporter.stats.sampledNotSent+=1:(this._reporter.stats.processed+=1,this._processedEvent.fireEvent(e))}sendOtelCustomerContent(e,t){this._enableCustomerContent&&this._logger.sendCustomerContent&&this.processEvent(e,e=>{e.timestamp=t,this._logger.sendCustomerContent(e)})}sendOtelDirectNumeric(e,t){this.processEvent(e,e=>{e.timestamp=t,this._logger.sendDirectNumericEvent&&this._logger.sendDirectNumericEvent(e)})}sendOtelTelemetryEvent(e,t){this.processEvent(e,e=>{e.timestamp=t,this._logger.sendTelemetryEvent(e)})}flush(e){this._sink instanceof mn&&this._sink.flush(e)}shutdown(){this._enabled&&(this._reporter.logSessionStatsViaOTel(),this._sink.shutdown()),this._reporter.logSessionStatsViaUls(),this._reporter.logAndClearTaskStats(),this._reporter.checkAndLogPipelineHealth()}getStats(){return this._reporter}onProcessedEvent(){return this._processedEvent}onThrottledEvent(){return this._throttledEvent}constructor(e){this._processedEvent=new c,this._throttledEvent=new c,this._logger=new u.a(void 0,void 0,{disableValidation:!0}),this._enabled=e.transportSettings.enabled,this._throttlingEnabled=e.throttlingSettings.enabled,this._reporter=e.stats,this._collectorPingUrl=e.collectorPingUrl,this._enableCustomerContent=e.transportSettings.enableCustomerContent;const t=Object(pn.a)(e.alwaysOnMetadata),n=Object(o.f)(t);this._sink=e.createSinkFunc(e.transportSettings,n,this._reporter),this._logger.addSink(this._sink),this._eventThrottler=e.createThrottlerFunc(this._sink),function(e,t){if(e.setSingleEventThrottle(t.singleEventThrottlePerSec),e.setTotalEventThrottle(t.totalEventsThrottlePerSec),t.eventNamesToBeSuppressedCommaSeparated){let n;n=t.eventNamesToBeSuppressedCommaSeparated.split(","),n.forEach(t=>{e.setNamedEventThrottle(t,0)})}}(this._eventThrottler,e.throttlingSettings),this._eventSampler=void 0,e.samplingSettings.enabled&&e.alwaysOnMetadata&&this.setupSampler(e.createSamplerFunc,e.alwaysOnMetadata,e.samplingSettings.sampleRate)}}let Wn,Xn=!1,jn="",zn="",Kn="unknown";function Yn(e){if(Xn)throw new Error("Telemetry is already initialized!");if(!e.ulsLogger)throw new Error("Must provide a ULS logger!");var t;Object(d.b)(e.ulsLogger),e.loggingCategory&&(t=e.loggingCategory,gn=t),e.alwaysOnMetadata&&(Kn=e.alwaysOnMetadata.name+", "+e.alwaysOnMetadata.applicationMode+", "+e.alwaysOnMetadata.applicationModeExtended),d.a.sendTraceTag(595947925,gn,h.a.Info,`Initializing Otel library [${Kn}] with settings ${function(e){return JSON.stringify(e,(function(e,t){if("alwaysOnMetadata"!==e)return t}))}(e)}`),function(e){e.alwaysOnMetadata&&(null==e.alwaysOnMetadata.name||""===e.alwaysOnMetadata.name?(jn="Office.Online.UserAction",zn="Office.Online.Data.Activity",d.a.sendTraceTag(595900060,gn,h.a.Info,"Cannot determine the App for UserActionEvent, using generic UserAction event name.")):(jn=`Office.${e.alwaysOnMetadata.name}.Online.UserAction.`,zn=`Office.${e.alwaysOnMetadata.name}.Online.Data.Activity.`))}(e);const n=function(e){return function(e){const t=function(e){const t={settings:e,tags:{sessionStatsEventName:"Office.Online.Telemetry.OTelJS.OneDS.Session.Stats",sessionStats:593597406,taskStats:593597407,taskDetailsStats:593597408,taskDurationThresholdExceeded:593597409,sdkHealth:593597410},sdkInitializationTime:Date.now()};return new Pn(t)}(e.statsSettings),n=new Hn({alwaysOnMetadata:e.alwaysOnMetadata,transportSettings:e.transportSettings,throttlingSettings:e.throttlingSettings,samplingSettings:e.samplingSetings,stats:t,createSinkFunc:Un,createSamplerFunc:Bn,createThrottlerFunc:kn,collectorPingUrl:"https://browser.events.data.microsoft.com/ping"});return t.setLogOtelTelemetryEventFunc(n.sendOtelTelemetryEvent.bind(n)),n}({alwaysOnMetadata:e.alwaysOnMetadata,transportSettings:e.oneDsTransportSettings,throttlingSettings:e.throttlingSettings,statsSettings:e.statsSettings,samplingSetings:e.samplingSettings})}(function(e){return{alwaysOnMetadata:e.alwaysOnMetadata||_n,useOneDsLogger:In(e.otelUseOneDsSink,vn),logToUls:In(e.sendToUls,En),oneDsTransportSettings:{enabled:In(e.sendToAria,Tn.enabled),collectorEndpointEnum:Cn(e.ariaEndpointTarget,Tn.collectorEndpointEnum),collectorEndpointUrl:Cn(e.ariaEndpointUrl,Tn.collectorEndpointUrl),eventUploadFrequency:Rn(e.eventUploadFrequency,Tn.eventUploadFrequency),cacheMemorySizeLimitInNumberOfEvents:Rn(e.cacheMemorySizeLimitInNumberOfEvents,Tn.cacheMemorySizeLimitInNumberOfEvents),enableCustomerContent:In(e.enableCustomerContent,Tn.enableCustomerContent),enableDNM:In(e.enableDNM,Tn.enableDNM),enablePG:In(e.enablePG,Tn.enablePG)},throttlingSettings:{enabled:In(e.wacAriaThrottlingIsEnabled,Sn.enabled),totalEventsThrottlePerSec:Rn(e.wacAriaTotalEventsThrottlePerSec,Sn.totalEventsThrottlePerSec),singleEventThrottlePerSec:Rn(e.wacAriaSingleEventThrottlePerSec,Sn.singleEventThrottlePerSec),eventNamesToBeSuppressedCommaSeparated:Cn(e.otelEventNamesToBeSuppressedCommaSeparated,Sn.eventNamesToBeSuppressedCommaSeparated)},statsSettings:{taskDurationLogFrequency:Rn(e.taskDurationLogFrequency,An.taskDurationLogFrequency),durationThreshold:Rn(e.taskDurationLogThreshold,An.durationThreshold),reportTaskDetails:In(e.reportTaskDetails,An.reportTaskDetails),sessionDurationCutoff:An.sessionDurationCutoff},samplingSettings:{enabled:In(e.samplingIsEnabled,bn.enabled),sampleRate:Rn(e.sampleRate,bn.sampleRate)}}}(e));e.sendToUls&&(n.onProcessedEvent().addListener(Qn),n.onThrottledEvent().addListener(Zn)),m.c().addListener(t=>{!function(e,t){(e.category!==Dn.a.Category.Transport||t)&&d.a.sendTraceTag(595947933,gn,Object(o.d)(e.level),e.message())}(t,e.enableAdditionalDiagnosticTracing||!1)}),l.a.forEach(e=>{n.setTenantToken(e.namespace,e.ariaTenant)}),l.b.forEach(e=>{n.setDNMToken(e.namespace,e.ariaTenant)}),e.pingCollectorPingUrl&&n.pingCollectorPingUrl(),e.pingCollectorEndpoint&&n.pingCollectorEndpoint(),Wn=n,Xn=!0,d.a.sendTraceTag(595947926,gn,h.a.Info,"Successfully initialized Otel library")}function qn(e){const t=e.otelEvent;if(!t||!t.dataFields)throw new Error("Invalid Otel event");if(e.additionalDataFields){const n=Object(o.f)(e.additionalDataFields);t.dataFields.push(...n)}return t}function Qn(e){d.a.sendTraceTag(595947932,gn,h.a.Info,"Processed TelemetryEvent "+e.eventName+" :"+JSON.stringify(e))}function Zn(e){d.a.sendTraceTag(593597440,gn,h.a.Warning,"Throttled TelemetryEvent "+e.eventName+" :"+JSON.stringify(e))}function $n(){if(!Xn)throw new Error("Telemetry is not initialized!")}function Jn(e){switch(e.kind){case"event":try{!function(e,t){$n();const n=Object(o.e)(e);Wn.sendOtelTelemetryEvent(n,void 0)}(e.event)}catch(t){d.a.sendTraceTag(595947920,gn,h.a.Error,`Error while processing TelemetryEvent ${e.event.name} : ${ei(t)}`)}break;case"dnm":try{!function(e,t){$n();const n=Object(o.c)(e);Wn.sendOtelDirectNumeric(n,void 0)}(e.event)}catch(t){d.a.sendTraceTag(512324692,gn,h.a.Error,`Error while processing TelemetryEvent ${e.event.name} : ${ei(t)}`)}break;case"cc":try{Object(r.j)(e.event)}catch(t){d.a.sendTraceTag(512267720,gn,h.a.Error,`Error while processing TelemetryEvent ${e.event.name} : ${ei(t)}`)}break;case"activity":try{!function(e,t){$n(),null!=e&&null!=e.name&&(e.name.indexOf("Office.")>=0||(e.name=zn+e.name));const n=Object(o.a)(e);Wn.sendOtelTelemetryEvent(n,void 0)}(e.event)}catch(t){d.a.sendTraceTag(595947921,gn,h.a.Error,`Error while processing ActivityEvent ${e.event.name} : ${ei(t)}`)}break;case"action":try{!function(e,t){$n(),null==e.name&&(e.name=jn,null!=e.actionName&&(e.name+=e.actionName));const n=Object(o.g)(e);Wn.sendOtelTelemetryEvent(n,void 0)}(e.event)}catch(t){d.a.sendTraceTag(595928211,gn,h.a.Error,`Error while processing UserActionEvent ${e.event.name} : ${ei(t)}`)}break;case"otel":try{!function(e){$n(),Wn.sendOtelTelemetryEvent(qn(e))}(e.event)}catch(t){let n="";const i=e.event;i&&(n=i.eventName),d.a.sendTraceTag(595947922,gn,h.a.Error,`Error while processing OtelEvent ${n} : ${ei(t)}`)}break;case"otelcc":try{!function(e){$n(),Wn.sendOtelCustomerContent(qn(e))}(e.event)}catch(t){let n="";const i=e.event;i&&(n=i.eventName),d.a.sendTraceTag(572298211,gn,h.a.Error,`Error while processing OTel CustomerContent ${n} : ${ei(t)}`)}break;case"oteldnm":try{!function(e){$n(),Wn.sendOtelDirectNumeric(qn(e))}(e.event)}catch(t){let n="";const i=e.event;i&&(n=i.eventName),d.a.sendTraceTag(512566404,gn,h.a.Error,`Error while processing OTel DNM ${n} : ${ei(t)}`)}break;case"addNamespaceMapping":try{t=e.namespace,n=e.ariaTenantToken,$n(),Wn.setTenantToken(t,n)}catch(t){d.a.sendTraceTag(595947923,gn,h.a.Error,`Error while adding namespace mapping for ${e.namespace} : ${ei(t)}`)}break;case"setDNMToken":try{!function(e,t){$n(),Wn.setDNMToken(e,t)}(e.namespace,e.ariaTenantToken)}catch(t){d.a.sendTraceTag(512566403,gn,h.a.Error,`Error while adding DNM namespace mapping for ${e.namespace} : ${ei(t)}`)}break;case"shutdown":try{$n(),d.a.sendTraceTag(595947931,gn,h.a.Info,`Otel library shutdown triggered [${Kn}]`),Wn.shutdown()}catch(e){d.a.sendTraceTag(595947924,gn,h.a.Error,"Error while processing shutdown event : "+ei(e))}break;case"flush":try{$n(),Wn.flush(!0)}catch(e){d.a.sendTraceTag(559810652,gn,h.a.Error,"Error while processing flush event : "+ei(e))}break;default:throw new Error(e)}var t,n}function ei(e){return e instanceof Error?e.message?e.message:"":null!=e.message?e.message:JSON.stringify(e)}const ti=new class{initialize(e){if(!e)throw new Error("Must supplied valid telemetry settings!");Yn(e)}processTelemetryEvent(e){Jn(e)}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return m})),n.d(t,"c",(function(){return p})),n.d(t,"a",(function(){return g}));var i=n(38),r=n(92),s={};function a(e,t){"Office."===e.substring(0,7)&&"."!==e[e.length-1]?s[e]?(t.ariaTenantToken&&(s[e].ariaTenantToken=t.ariaTenantToken),t.dnmToken&&(s[e].dnmToken=t.dnmToken)):s[e]=t:Object(r.b)(0,0,(function(){return"Namespace: ".concat(e)}))}function o(e,t){for(var n=e.length;n>0;){var i=e.substr(0,n);if(s[i]){var r=s[i];return t.ariaTenantToken=r.ariaTenantToken,t.dnmToken=r.dnmToken,!0}n=e.lastIndexOf(".",n-1)}return!1}var l=/^Office(\.[A-Z][a-zA-Z0-9]*){2,}$/,c=/^[a-zA-Z0-9_\.]{1,95}$/;function d(e){return c.test(e)}function h(e){e&&e.forEach((function(e){if("string"!=typeof e.name||!d(e.name))throw new Error("Invalid dataField name");2===e.dataType&&function(e){if("number"!=typeof e||!isFinite(e)||Math.floor(e)!==e||e<-9007199254740991||e>9007199254740991)throw new Error("Invalid integer ".concat(JSON.stringify(e)))}(e.value)}))}var u=n(225),f=n(59),m=-1;function p(e){var t={eventName:e.eventName,eventFlags:e.eventFlags||{},telemetryProperties:e.telemetryProperties?Object(i.a)({},e.telemetryProperties):{},dataFields:e.dataFields?e.dataFields.slice():[],timestamp:e.timestamp||(new Date).getTime()};return e.eventContract&&(t.eventContract={name:e.eventContract.name,dataFields:e.eventContract.dataFields.slice()}),t}var g=function(){function e(e,t,n){var r,s,a;this.telemetrySinks=[],this.persistentDataFields=[],this.partAFields=[],this.eventQueue=[],this.config=n||{},e&&(this.telemetrySinks=e.telemetrySinks,(r=this.persistentDataFields).push.apply(r,e.persistentDataFields),this.config=Object(i.a)(Object(i.a)({},e.getConfig()),this.config),(s=this.partAFields).push.apply(s,e.partAFields)),t&&(a=this.persistentDataFields).push.apply(a,t)}return e.prototype.addEventContentType=function(e,t){e.push(Object(f.c)("EventContent.Type",t))},e.prototype.sendTelemetryEvent=function(e){var t=p(e),n=t.telemetryProperties;n.nexusTenantToken=m;var i=n.ariaTenantToken;i||o(t.eventName,n)||i?this.sendTelemetryEventInternal(t,1):Object(r.b)(0,0,(function(){return"No tenant token: "+e.eventName}))},e.prototype.sendNonStandardEvent=function(e,t){var n=p(e);this.sendTelemetryEventInternal(n,t)},e.prototype.sendCustomerContent=function(e){var t=p(e),n=t.telemetryProperties,i=n.customerContentVersion;return(!i||i>2)&&(n.customerContentVersion=2),n.ariaTenantToken=void 0,n.nexusTenantToken=void 0,n.dnmToken=void 0,this.addEventContentType(t.dataFields,2),this.sendTelemetryEventInternal(t,2)},e.prototype.sendDirectNumericEvent=function(e){var t=p(e),n=t.telemetryProperties;n.dnmToken||o(t.eventName,n)||n.dnmToken?(this.addEventContentType(t.dataFields,1),this.sendTelemetryEventInternal(t,3)):Object(r.b)(0,0,(function(){return"No dnm token: "+t.eventName}))},e.prototype.sendTelemetryEventInternal=function(e,t){if(2===t||!e.telemetryProperties.customerContentVersion&&!e.telemetryProperties.customerContentType){try{if(0===this.telemetrySinks.length)return void(this.config.enableQueue&&this.eventQueue.length<1e3?this.eventQueue.push([e,t]):Object(r.b)(1,0,(function(){return"No telemetry sinks are attached."})));this.processTelemetryEvent(e,t)}catch(e){return void Object(r.a)(0,"SendTelemetryEvent",e)}this.telemetrySinks.forEach((function(n){try{3===t||2===t?n.sendNonStandardEvent&&n.sendNonStandardEvent(e,t):n.sendTelemetryEvent(e)}catch(e){}}))}else Object(r.b)(0,0,(function(){return"Customer content"}))},e.prototype.processTelemetryEvent=function(e,t){var n,i,r;if(e.dataFields&&(null===(r=e.dataFields)||void 0===r||r.unshift(Object(f.d)("OTelJS.Version",u.a)),3!==t&&this.persistentDataFields&&(n=e.dataFields).unshift.apply(n,this.persistentDataFields)),this.partAFields.length>0){var s=e.eventContract||{name:"",dataFields:[]};(i=s.dataFields).push.apply(i,this.partAFields),e.eventContract=s}this.config.disableValidation||function(e){if(!(t=e.eventName)||t.length>98||!l.test(t))throw new Error("Invalid eventName");var t,n=e.eventContract;if(n){if(n.name&&!d(n.name))throw new Error("Invalid eventContract");h(n.dataFields)}h(e.dataFields)}(e)},e.prototype.addSink=function(e){this.telemetrySinks.push(e),this.flushQueue()},e.prototype.flushQueue=function(){var e=this.eventQueue;if(this.eventQueue=[],this.telemetrySinks.length>0)for(var t=0,n=e;t<n.length;t++){var i=n[t],r=i[0],s=i[1];this.sendTelemetryEventInternal(r,s)}},e.prototype.setTenantToken=function(e,t,n){a(e,{ariaTenantToken:t,nexusTenantToken:n})},e.prototype.setDNMToken=function(e,t){a(e,{dnmToken:t})},e.prototype.cloneEvent=function(e){return p(e)},e.prototype.getConfig=function(){return this.config},e}()},,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";var i;n.r(t),n.d(t,"default",(function(){return p})),function(e){e.SlideShowUIRootContainer="SlideShowUIRootContainer",e.NotesPane="NotesPane",e.SlideShowToolbar="SlideShowToolbar",e.GridView="GridView"}(i||(i={}));class r{}r.PrevButton="prevButton",r.SlideLabel="slideLabel",r.NextButton="nextButton",r.GridButton="gridButton",r.MoreButton="moreButton",r.OpenButton="openButton",r.FullscreenButton="fullscreenButton";var s=n(31),a=n(9),o=n(3),l=n(7),c=n(35),d=n(49);class h{async init(){const e={load:async(e,t)=>{const n={resourceId:e,metadata:{errorName:"ErrorFailedToLoadPresInfo"}};if(!t.meta_clientWidth||!t.meta_clientHeight)return a.a.sendTraceTag(506857180,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,"SlideShowUIResourceProvider::presInfoLoader missing clientWidth or clientHeight"),n.metadata.errorName="ErrorMissingClientWidthOrHeight",n;t.meta_correlationId||(t.meta_correlationId=Object(c.v4)());const i={ClientWidth:t.meta_clientWidth,ClientHeight:t.meta_clientHeight,CorrelationId:t.meta_correlationId,IncludeSections:t.includeSectionData};let r={presInfo:void 0,responseErrorCode:s.c.ErrorRESERVEDSuccess,responseErrorCategory:s.b.ErrorRESERVEDSuccess,itemErrorCodeMap:void 0,responseIsIntentional:!1};return r=await this.m_podsProxy.getItemsPresInfoAsync(i),r.presInfo?(n.resource=r.presInfo,n.metadata={created:new Date,lastAccessed:new Date},r.metadata&&(n.metadata.getItemsResult=r.metadata),n):("ErrorRESERVEDSuccess"!==r.responseErrorCode.toString()&&(n.metadata.errorName=r.responseErrorCode.toString()),a.a.sendTraceTag(506857179,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,`SlideShowUIResourceProvider::presInfoLoader failed to get presInfo. responseErrorCode:${n.metadata.errorName}, resourceId:${e}, correlation:${t.meta_correlationId}`),n)}},t=async(e,t)=>{const n={resourceId:e,metadata:{errorName:"ErrorFailedToLoadSlideInfo"}};if(!t.meta_clientWidth||!t.meta_clientHeight)return a.a.sendTraceTag(506857178,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,"SlideShowUIResourceProvider::slideInfoLoader missing clientWidth or clientHeight"),n.metadata.errorName="ErrorMissingClientWidthOrHeight",n;const i=JSON.parse(e).slideIds;if(!i)return a.a.sendTraceTag(506857177,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,"SlideShowUIResourceProvider::slideInfoLoader invalid slideIdList "+e),n.metadata.errorName="ErrorMissingSlideId",n;t.meta_correlationId||(t.meta_correlationId=Object(c.v4)());const r=[];for(let e=0;e<i.length;e+=1)r.push({slideId:i[e]});const d={SlideLocations:r,GetSlideImage:t.getSlideImage,ClientWidth:t.meta_clientWidth,ClientHeight:t.meta_clientHeight,IsHighContrast:t.isHighContrast,ColorMode:t.colorMode,ClientColorSettings:t.clientColorSettings,DevicePixelRatio:window.devicePixelRatio,RenderOptions:{RenderSlides:!1,RenderThumbs:!1},GetSlideNotes:t.getSlideNotes,GetSlideAccessibilityModelData:t.getSlideAccessibilityModel,CorrelationId:t.meta_correlationId,Filters:{...t.Filters}};d.SkipGetSlideInfo=t.skipGetSlideInfo||!1;let h={slideInfo:[],responseErrorCode:s.c.ErrorRESERVEDSuccess,responseErrorCategory:s.b.ErrorRESERVEDSuccess,itemErrorCodeMap:void 0,responseIsIntentional:!1};if(h=await this.m_podsProxy.getItemsSlideInfosAsync(d),!h.slideInfo||0===h.slideInfo.length)return"ErrorRESERVEDSuccess"!==h.responseErrorCode.toString()&&(n.metadata.errorName=h.responseErrorCode.toString()),a.a.sendTraceTag(506857176,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,`SlideShowUIResourceProvider::slideInfoLoader failed to get slideInfo. errorName:${n.metadata.errorName}, resourceId:${e}, correlation:${t.meta_correlationId}`),n;const u=h.slideInfo;return n.resource=u,n.metadata={created:new Date,lastAccessed:new Date,cached:h.usedOutputCache&&"true"===h.usedOutputCache.toString().toLowerCase().trim()},h.metadata&&(n.metadata.getItemsResult=h.metadata),n},n={batchLoad:async e=>{let n="";const i=[];e.forEach(e=>{i.push(JSON.parse(e.resourceId))}),n=JSON.stringify({slideIds:i});const r=await t(n,e[0].options),s=[];return r&&r.resource&&r.metadata&&!r.metadata.errorName?r.resource.forEach(t=>{const n=e.filter(e=>JSON.parse(e.resourceId).sid===t.ID.sid)[0],i={resourceId:n.resourceId,options:n.options,resource:t,metadata:r.metadata};s.push(i)}):a.a.sendTraceTag(506857175,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,"SlideShowUIResourceProvider::batchSlideInfoLoader error during get loadReuslt"),s}};this.m_batchSlideInfoProvider=new d.a(n),this.m_presInfo=new d.b(e)}async presInfo(e){try{if(this.m_presInfo){const t=await this.m_presInfo.load("",e);return t&&t.resource?t.resource:(a.a.sendTraceTag(506857174,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,"SlideShowUIResourceProvider::presInfo no result from load call."),Promise.reject())}a.a.sendTraceTag(506857173,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,"SlideShowUIResourceProvider::presInfo no m_presinfo object.")}catch(e){a.a.sendTraceTag(506857172,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,`SlideShowUIResourceProvider::presInfo exception in presInfo call: ${e}.`)}return Promise.reject()}async batchLoad(e,t){const n=[];e.forEach(e=>{const i={resourceId:JSON.stringify(e),options:t};n.push(i)});const i=[];return this.m_batchSlideInfoProvider&&(await this.m_batchSlideInfoProvider.batchLoad(n)).forEach(e=>{e.resource&&i.push(e.resource)}),i}constructor(e){this.m_podsProxy=e}}class u{static enterFullScreenMode(e){if(!u.isFullScreen()){const t=e;let n;t.requestFullscreen?n=t.requestFullscreen():t.msRequestFullscreen?n=t.msRequestFullscreen():t.mozRequestFullScreen?n=t.mozRequestFullScreen():t.webkitRequestFullscreen&&(n=t.webkitRequestFullscreen()),n&&n.then(()=>{a.a.sendTraceTag(506857096,o.a.msoulscat_Wac_PptSlideshow,l.a.Verbose,"SlideShowUIComponent::enterFullScreenMode - Entered full screen mode")}).catch(e=>{a.a.sendTraceTag(506857095,o.a.msoulscat_Wac_PptSlideshow,l.a.Warning,`SlideShowUIComponent::enterFullScreenMode - Full screen enter mode failed, with message: ${e.message} errorname: ${e.name}`)})}}static exitFullScreenMode(){const e=document;if(u.isFullScreen()){let t;e.exitFullscreen?t=e.exitFullscreen():e.msExitFullscreen?t=e.msExitFullscreen():e.mozCancelFullScreen?t=e.mozCancelFullScreen():e.webkitExitFullscreen&&(t=e.webkitExitFullscreen()),t&&t.then(()=>{a.a.sendTraceTag(506857094,o.a.msoulscat_Wac_PptSlideshow,l.a.Verbose,"SlideShowUIComponent::exitFullScreenMode - Exit from full screen mode")}).catch(e=>{a.a.sendTraceTag(506857093,o.a.msoulscat_Wac_PptSlideshow,l.a.Warning,`SlideShowUIComponent::exitFullScreenMode - Full screen exit mode failed, with message: ${e.message} errorname: ${e.name}`)})}}static isFullScreen(){const e=document;return!!(e.fullscreenElement||e.mozFullScreenElement||e.webkitFullscreenElement||e.msFullscreenElement)}static canEnterFullScreen(){const e=document;return!!(e.fullscreenEnabled||e.mozFullScreenEnabled||e.webkitFullscreenEnabled||e.msFullscreenEnabled)}}var f=n(60),m=n(1);class p{onLoadedAsync(e){return Promise.resolve()}async initializeAsync(e){this.m_slideShowUIEvents=e.uiEvents,this.m_currentSlideLocation=e.currentSlideLocation,this.m_hostFrameUrl=e.hostFrameUrl;const t=document.createElement("div");t.id=this.m_notesPaneElementId,e.containerElement.appendChild(t);const n=document.createElement("div");n.id=e.showFloatingToolbar?this.m_floatingToolbarElementId:this.m_toolbarElementtId,e.containerElement.appendChild(n);const s=document.createElement("div");s.id=this.m_gridViewElementId,e.containerElement.appendChild(s),this.m_slideShowUIContainers={},this.m_slideShowUIContainers[i.SlideShowUIRootContainer]=e.containerElement,this.m_slideShowUIContainers[i.NotesPane]=t,this.m_slideShowUIContainers[i.SlideShowToolbar]=n,this.m_slideShowUIContainers[i.GridView]=s;const a=!e.showFloatingToolbar;this.updateDarkThemePreference(a),window.matchMedia(this.m_darkThemeMediaQuery).addEventListener("change",()=>this.updateDarkThemePreference(a)),e.showFloatingToolbar&&(this.onMouseMoveFloatingToolbar(),window.addEventListener("mousemove",()=>this.onMouseMoveFloatingToolbar())),n.classList.add(e.removeRoundedCornersInToolbar?this.m_noRoundedCornerToolbarClassName:this.m_roundedCornerToolbarClassName),this.m_uiResourceProvider=new h(e.podsProxy),await this.m_uiResourceProvider.init(),this.m_fEnableGridViewThumbnailsPrefetch=m.a.readBooleanOrDefault("enableGridViewThumbnailsPrefetch",!1),this.m_fEnableNotesContentPrefetch=m.a.readBooleanOrDefault("enableNotesContentPrefetch",!1),this.m_showAccessibilityDeclaration=m.a.readBooleanOrDefault("showAccessibilityDeclaration",!1);const o=m.a.readBooleanOrDefault("disableGridViewOnSmallAppSize",!1)&&(e.containerElement.clientWidth<this.m_thumbnailWidth||e.containerElement.clientHeight<this.m_thumbnailHeight),l={slideShowUIContainers:this.m_slideShowUIContainers,totalSlideCount:e.slideCount,startingSlideIndex:e.currentSlideLocation?e.currentSlideLocation.slideIndex:void 0,showOICButtonsInToolbar:!!this.m_hostFrameUrl,showDownloadCopyButtonInToolbar:!1,showFullScreenButtonInToolbar:u.canEnterFullScreen(),showGridViewButtonInToolbar:!o,showOnlyNavigationControlsInToolbar:!!e.showOnlyNavigationControlsInToolbar,fileName:e.fileName,showFileNameInOICButtonInToolbar:"reading"===e.uiType,lcid:e.lcid,showAccessibilityDeclaration:this.m_showAccessibilityDeclaration,showFloatingToolbar:!!e.showFloatingToolbar};this.m_slideShowUIEvents.on("slideStateChanged",({slideLocation:e})=>{this.onSlideStateChanged(e)}),this.m_slideShowUIEvents.on("openInBrowserClicked",()=>{this.onOpenInBrowserButtonClick()}),this.m_slideShowUIEvents.on("openInDesktopClicked",()=>{this.onOpenInDesktopButtonClick()}),this.m_slideShowUIEvents.on("gridViewToggled",e=>{!e||this.m_fGridViewLoaded||this.m_fEnableGridViewThumbnailsPrefetch||this.populateGridViewThumbnailsAsync()}),this.m_slideShowUIEvents.on("notesPaneToggled",e=>{this.m_fNotesPaneVisible=e,!e||this.m_fNotesLoaded||this.m_fEnableNotesContentPrefetch||this.populateNotesContentAsync()}),n.addEventListener("keydown",e=>{this.onToolbarKeyDown(e)});const c=window.exposed;c instanceof Object&&c.slideshowmodernui&&(this.m_slideShowUIManager=c.slideshowmodernui.slideShowUIFactory.createSlideShowUI(l,this.m_slideShowUIEvents)),this.m_slideShowUIManager&&(await this.m_slideShowUIManager.initAsync(),this.m_slideShowUIManager.registerToolbarButtonCallback(r.FullscreenButton,()=>this.onFullScreenButtonClick()),this.m_fEnableGridViewThumbnailsPrefetch&&this.populateGridViewThumbnailsAsync(),this.m_fEnableNotesContentPrefetch&&this.populateNotesContentAsync())}getToolbarElement(){return this.m_slideShowUIContainers?this.m_slideShowUIContainers[i.SlideShowToolbar]:void 0}async populateNotesContentAsync(){this.m_fNotesLoaded=!0;try{if(this.m_uiResourceProvider&&this.m_currentSlideLocation&&this.m_slideShowUIManager){const e=this.m_currentSlideLocation.slideId,t={meta_clientWidth:1,meta_clientHeight:1,getSlideNotes:!0,skipGetSlideInfo:!0,Filters:{ShouldUseRenderChunks:!0,EnableClustering:!1}},i=await this.m_uiResourceProvider.batchLoad([e],t);if(i&&i[0]&&i[0].NoteHtml&&i[0].ID.sid===e.sid)if(""===i[0].NoteHtml.trim())this.m_slideShowUIManager.setNotesPlaceholder();else{const e=i[0].NoteHtml,t=(await n.e(0).then(n.t.bind(null,250,7))).sanitize(e);this.m_slideShowUIManager.setNotesContent(t)}}}catch(e){a.a.sendTraceTag(506857304,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,"SlideShowUIComponent::populateNotesContentAsync exception: "+Object(f.c)(e))}}async populateGridViewThumbnailsAsync(){if(this.m_fGridViewLoaded=!0,this.m_uiResourceProvider){const e={getSlideImage:!0,getSlideAccessibilityModel:!0,meta_clientWidth:this.m_metaClientWidth,meta_clientHeight:this.m_metaClientHeight,includeSectionData:!0,meta_correlationId:""};try{const t=[],n=await this.m_uiResourceProvider.presInfo(e);this.adjustGridViewThumbnailDimensions(n.SlideEmuWidth,n.SlideEmuHeight);const i=n.SlideOrder,r=n.HiddenSlideOrder;i.forEach((e,n)=>{const i=!!r&&r.filter(t=>t.sid===e.sid&&t.cid===e.cid).length>0,s={id:{sid:e.sid,cid:e.cid},index:n,isHidden:i,imageSource:""};t.push(s)});const s=p.chunkSlideIdList(i,this.m_maxChunkSize);for(let n=0;n<s.length;n+=1){e.meta_correlationId=Object(c.v4)();const i=s[n],r=await this.m_uiResourceProvider.batchLoad(i,e);t.forEach(e=>{if(i.some(t=>t.sid===e.id.sid&&t.cid===e.id.cid)){const t=r.find(t=>t.ID.sid===e.id.sid);if(t&&(e.imageSource=t.SlideImageData,e.title=t.Title,t.AccessibilityModel)){const n=JSON.parse(t.AccessibilityModel).shp;for(const t of n)if("Title"===t.tp){e.title=t.val,a.a.sendTraceTag(506857303,o.a.msoulscat_Wac_PptSlideshow,l.a.Info,"SlideShowUIComponent::populateGridViewThumbnailsAsync - slide title value comes from slideInfo.AccessibilityModel");break}}}}),this.m_slideShowUIManager&&this.m_slideShowUIManager.setGridViewContent(t)}}catch(e){a.a.sendTraceTag(506857302,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,"SlideShowUIComponent::populateGridViewThumbnailsAsync exception trying to fetch presinfo. Exception: "+Object(f.c)(e))}}}adjustGridViewThumbnailDimensions(e,t){if(e<=0||t<=0)return void a.a.sendTraceTag(506857301,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,`SlideShowUIComponent::adjustGridViewThumbnailDimensions width or height incorrect, width=${e}, height=${t}.`);let n=e/t;n=n>=this.m_thumbnailWidth/this.m_thumbnailHeight?this.m_thumbnailWidth/e:this.m_thumbnailHeight/t,this.m_thumbnailWidth=Math.floor(e*n),this.m_thumbnailHeight=Math.floor(t*n),this.m_slideShowUIManager&&this.m_slideShowUIManager.adjustGridViewThumbnailDimensions(this.m_thumbnailWidth,this.m_thumbnailHeight)}static chunkSlideIdList(e,t){if(!e||t<=0)return[];const n=[];for(let i=0;i<e.length;i+=t)n.push(e.slice(i,i+t));return n}onFullScreenButtonClick(){if(u.isFullScreen())u.exitFullScreenMode();else if(this.m_slideShowUIContainers&&this.m_slideShowUIContainers[i.SlideShowUIRootContainer]){const e=document.querySelector("body");u.enterFullScreenMode(e)}}onSlideStateChanged(e){try{this.m_currentSlideLocation=e,this.m_slideShowUIManager&&(this.m_slideShowUIManager.clearNotesContent(),this.m_fNotesLoaded=!1,(this.m_fEnableNotesContentPrefetch||this.m_fNotesPaneVisible)&&this.populateNotesContentAsync())}catch(e){a.a.sendTraceTag(506857300,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,"SlideShowUIComponent::onSlideStateChanged exception: "+Object(f.c)(e))}}onOpenInBrowserButtonClick(){try{if(this.m_hostFrameUrl){a.a.sendTraceTag(506857299,o.a.msoulscat_Wac_PptSlideshow,l.a.Info,"SlideShowUIComponent::onOpenInBrowserButtonClick - Opening file in Online Client");const e=new URL(this.m_hostFrameUrl);e.searchParams.set("action","edit"),window.open(e.toString(),"_blank")}}catch(e){a.a.sendTraceTag(506857298,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,"SlideShowUIComponent::onOpenInBrowserButtonClick exception: "+Object(f.c)(e))}}onOpenInDesktopButtonClick(){try{if(this.m_hostFrameUrl){a.a.sendTraceTag(506857297,o.a.msoulscat_Wac_PptSlideshow,l.a.Info,"SlideShowUIComponent::onOpenInBrowserButtonClick - Opening file in Desktop Client");const e="ms-powerpoint:ofe|u|"+this.m_hostFrameUrl;window.open(e,"_self")}}catch(e){a.a.sendTraceTag(506857296,o.a.msoulscat_Wac_PptSlideshow,l.a.Error,"SlideShowUIComponent::onOpenInDesktopButtonClick exception: "+Object(f.c)(e))}}onToolbarKeyDown(e){if(e&&e.key)switch(e.key.toLowerCase()){case"enter":case" ":e.stopImmediatePropagation()}}updateDarkThemePreference(e){const t=window.matchMedia(this.m_darkThemeMediaQuery).matches,n=!!e&&m.a.readBooleanOrDefault("forceDarkThemeInModernUI",!0);this.m_slideShowUIContainers&&this.m_slideShowUIContainers[i.SlideShowUIRootContainer]&&(n||t?this.m_slideShowUIContainers[i.SlideShowUIRootContainer].classList.add(this.m_darkThemeClassName):this.m_slideShowUIContainers[i.SlideShowUIRootContainer].classList.remove(this.m_darkThemeClassName))}onMouseMoveFloatingToolbar(){this.hideFloatingToolbarTimeout&&clearTimeout(this.hideFloatingToolbarTimeout),this.showFloatingToolbar(),this.hideFloatingToolbarTimeout=window.setTimeout(()=>{this.hideFloatingToolbar()},3e3)}hideFloatingToolbar(){const e=this.getToolbarElement();e&&e.classList.add("hidden")}showFloatingToolbar(){const e=this.getToolbarElement();e&&e.classList.remove("hidden")}constructor(){this.componentId="SlideShowUI",this.dependencies=[],this.m_fEnableGridViewThumbnailsPrefetch=!1,this.m_fGridViewLoaded=!1,this.m_fEnableNotesContentPrefetch=!1,this.m_showAccessibilityDeclaration=!1,this.m_fNotesLoaded=!1,this.m_fNotesPaneVisible=!1,this.m_thumbnailWidth=247,this.m_thumbnailHeight=140,this.m_metaClientWidth=3*this.m_thumbnailWidth,this.m_metaClientHeight=3*this.m_thumbnailHeight,this.m_maxChunkSize=3,this.m_notesPaneElementId="slideshow-app-notes-pane",this.m_toolbarElementtId="slideshow-toolbar",this.m_floatingToolbarElementId="slideshow-toolbar-floating",this.m_gridViewElementId="slideshow-app-grid-view",this.m_darkThemeMediaQuery="screen and (prefers-color-scheme: dark)",this.m_darkThemeClassName="dark-theme",this.m_roundedCornerToolbarClassName="toobar-rounded-corners",this.m_noRoundedCornerToolbarClassName="toobar-no-rounded-corners"}}},,,,,,,,,,,,,function(e,t,n){"use strict";function i(e,t,n,i){var r,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(s<3?r(a):s>3?r(t,n,a):r(t,n))||a);return s>3&&a&&Object.defineProperty(t,n,a),a}n.d(t,"a",(function(){return i})),Object.create,Object.create},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return a})),n.d(t,"l",(function(){return o})),n.d(t,"d",(function(){return l})),n.d(t,"g",(function(){return c})),n.d(t,"m",(function(){return d})),n.d(t,"n",(function(){return h})),n.d(t,"j",(function(){return u})),n.d(t,"f",(function(){return f})),n.d(t,"e",(function(){return m})),n.d(t,"h",(function(){return p})),n.d(t,"k",(function(){return g})),n.d(t,"i",(function(){return _})),n.d(t,"b",(function(){return v}));var i=n(392);function r(e,t){return(n,r)=>{const s=Object(i.a)(n);s[r]||(s[r]={type:e,sourceName:t})}}function s(e,t=null){return function(e,t=null){return(n,i)=>{const r=t||"_"+i;Object.defineProperty(n,i,{get:function(){return this[r]},set:function(t){"function"==typeof this.equals&&this.equals(t)||this[r]!==t&&(this[r]=t,n[e].apply(this))},enumerable:!0,configurable:!0})}}(e,t)}function a(e){return r(0,e)}function o(e){return r(1,e)}function l(e){return r(2,e)}function c(e){return r(3,e)}function d(e){return r(4,e)}function h(e){return r(5,e)}function u(e){return r(6,e)}function f(e){return r(7,e)}function m(e){return r(8,e)}function p(e){return r(9,e)}function g(e){return r(10,e)}function _(e){return r(12,e)}function v(e,t,n,i){const r=n.value;n.value=(...n)=>{let s=r;if("undefined"!=typeof _native&&_native[t]){const e=_native[t];s=i?(...t)=>i(...t)?e(...t):r(...t):e}return e[t]=s,s(...n)}}v.filter=function(e){return(t,n,i)=>v(t,n,i,e)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return u})),n.d(t,"c",(function(){return f}));var i=n(87),r=n(108),s=n(69),a=n(26);function o(e){return Math.pow(e,s.c)}function l(e){return e<=.04045?.0773993808*e:Math.pow(.947867299*(e+.055),2.4)}function c(e){return Math.pow(e,s.b)}function d(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}class h{toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=255*this.r|0;return e=397*e^(255*this.g|0),e=397*e^(255*this.b|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return h.FromArrayToRef(e,t,this),this}toColor4(e=1){return new u(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return.3*this.r+.59*this.g+.11*this.b}multiply(e){return new h(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyByFloats(e,t,n){return new h(this.r*e,this.g*t,this.b*n)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.r,e.g,e.b)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.r,e.g,e.b)}minimizeInPlaceFromFloats(e,t,n){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(n,this.b),this}maximizeInPlaceFromFloats(e,t,n){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(n,this.b),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,n){return this.equalsToFloats(e,t,n)}equalsToFloats(e,t,n){return this.r===e&&this.g===t&&this.b===n}equalsWithEpsilon(e,t=s.a){return Object(a.h)(this.r,e.r,t)&&Object(a.h)(this.g,e.g,t)&&Object(a.h)(this.b,e.b,t)}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}scale(e){return new h(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t}clampToRef(e=0,t=1,n){return n.r=Object(a.a)(this.r,e,t),n.g=Object(a.a)(this.g,e,t),n.b=Object(a.a)(this.b,e,t),n}add(e){return new h(this.r+e.r,this.g+e.g,this.b+e.b)}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addInPlaceFromFloats(e,t,n){return this.r+=e,this.g+=t,this.b+=n,this}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t}subtract(e){return new h(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this}subtractFromFloats(e,t,n){return new h(this.r-e,this.g-t,this.b-n)}subtractFromFloatsToRef(e,t,n,i){return i.r=this.r-e,i.g=this.g-t,i.b=this.b-n,i}clone(){return new h(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,n){return this.r=e,this.g=t,this.b=n,this}set(e,t,n){return this.copyFromFloats(e,t,n)}setAll(e){return this.r=this.g=this.b=e,this}toHexString(){const e=Math.round(255*this.r),t=Math.round(255*this.g),n=Math.round(255*this.b);return"#"+Object(a.g)(e)+Object(a.g)(t)+Object(a.g)(n)}fromHexString(e){return"#"!==e.substring(0,1)||7!==e.length||(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255),this}toHSV(){return this.toHSVToRef(new h)}toHSVToRef(e){const t=this.r,n=this.g,i=this.b,r=Math.max(t,n,i),s=Math.min(t,n,i);let a=0,o=0;const l=r,c=r-s;return 0!==r&&(o=c/r),r!=s&&(r==t?(a=(n-i)/c,n<i&&(a+=6)):r==n?a=(i-t)/c+2:r==i&&(a=(t-n)/c+4),a*=60),e.r=a,e.g=o,e.b=l,e}toLinearSpace(e=!1){const t=new h;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=l(this.r),e.g=l(this.g),e.b=l(this.b)):(e.r=o(this.r),e.g=o(this.g),e.b=o(this.b)),this}toGammaSpace(e=!1){const t=new h;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=d(this.r),e.g=d(this.g),e.b=d(this.b)):(e.r=c(this.r),e.g=c(this.g),e.b=c(this.b)),this}static HSVtoRGBToRef(e,t,n,i){const r=n*t,s=e/60,a=r*(1-Math.abs(s%2-1));let o=0,l=0,c=0;s>=0&&s<=1?(o=r,l=a):s>=1&&s<=2?(o=a,l=r):s>=2&&s<=3?(l=r,c=a):s>=3&&s<=4?(l=a,c=r):s>=4&&s<=5?(o=a,c=r):s>=5&&s<=6&&(o=r,c=a);const d=n-r;return i.r=o+d,i.g=l+d,i.b=c+d,i}static FromHSV(e,t,n){const i=new h(0,0,0);return h.HSVtoRGBToRef(e,t,n,i),i}static FromHexString(e){return new h(0,0,0).fromHexString(e)}static FromArray(e,t=0){return new h(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,n){n.r=e[t],n.g=e[t+1],n.b=e[t+2]}static FromInts(e,t,n){return new h(e/255,t/255,n/255)}static Lerp(e,t,n){const i=new h(0,0,0);return h.LerpToRef(e,t,n,i),i}static LerpToRef(e,t,n,i){i.r=e.r+(t.r-e.r)*n,i.g=e.g+(t.g-e.g)*n,i.b=e.b+(t.b-e.b)*n}static Hermite(e,t,n,i,r){const s=r*r,a=r*s,o=2*a-3*s+1,l=-2*a+3*s,c=a-2*s+r,d=a-s,u=e.r*o+n.r*l+t.r*c+i.r*d,f=e.g*o+n.g*l+t.g*c+i.g*d,m=e.b*o+n.b*l+t.b*c+i.b*d;return new h(u,f,m)}static Hermite1stDerivative(e,t,n,i,r){const s=h.Black();return this.Hermite1stDerivativeToRef(e,t,n,i,r,s),s}static Hermite1stDerivativeToRef(e,t,n,i,r,s){const a=r*r;s.r=6*(a-r)*e.r+(3*a-4*r+1)*t.r+6*(-a+r)*n.r+(3*a-2*r)*i.r,s.g=6*(a-r)*e.g+(3*a-4*r+1)*t.g+6*(-a+r)*n.g+(3*a-2*r)*i.g,s.b=6*(a-r)*e.b+(3*a-4*r+1)*t.b+6*(-a+r)*n.b+(3*a-2*r)*i.b}static Red(){return new h(1,0,0)}static Green(){return new h(0,1,0)}static Blue(){return new h(0,0,1)}static Black(){return new h(0,0,0)}static get BlackReadOnly(){return h._BlackReadOnly}static White(){return new h(1,1,1)}static Purple(){return new h(.5,0,.5)}static Magenta(){return new h(1,0,1)}static Yellow(){return new h(1,1,0)}static Gray(){return new h(.5,.5,.5)}static Teal(){return new h(0,1,1)}static Random(){return new h(Math.random(),Math.random(),Math.random())}constructor(e=0,t=0,n=0){this.r=e,this.g=t,this.b=n}}h._V8PerformanceHack=new h(.5,.5,.5),h._BlackReadOnly=h.Black(),Object.defineProperties(h.prototype,{dimension:{value:[3]},rank:{value:1}});class u{asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3],this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new u(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t.a=this.a+e.a,t}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}addInPlaceFromFloats(e,t,n,i){return this.r+=e,this.g+=t,this.b+=n,this.a+=i,this}subtract(e){return new u(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this}subtractFromFloats(e,t,n,i){return new u(this.r-e,this.g-t,this.b-n,this.a-i)}subtractFromFloatsToRef(e,t,n,i,r){return r.r=this.r-e,r.g=this.g-t,r.b=this.b-n,r.a=this.a-i,r}scale(e){return new u(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,t}clampToRef(e=0,t=1,n){return n.r=Object(a.a)(this.r,e,t),n.g=Object(a.a)(this.g,e,t),n.b=Object(a.a)(this.b,e,t),n.a=Object(a.a)(this.a,e,t),n}multiply(e){return new u(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this.a*=e.a,this}multiplyByFloats(e,t,n,i){return new u(this.r*e,this.g*t,this.b*n,this.a*i)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.r=Math.min(this.r,e.r),this.g=Math.min(this.g,e.g),this.b=Math.min(this.b,e.b),this.a=Math.min(this.a,e.a),this}maximizeInPlace(e){return this.r=Math.max(this.r,e.r),this.g=Math.max(this.g,e.g),this.b=Math.max(this.b,e.b),this.a=Math.max(this.a,e.a),this}minimizeInPlaceFromFloats(e,t,n,i){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(n,this.b),this.a=Math.min(i,this.a),this}maximizeInPlaceFromFloats(e,t,n,i){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(n,this.b),this.a=Math.max(i,this.a),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}equalsWithEpsilon(e,t=s.a){return Object(a.h)(this.r,e.r,t)&&Object(a.h)(this.g,e.g,t)&&Object(a.h)(this.b,e.b,t)&&Object(a.h)(this.a,e.a,t)}equalsToFloats(e,t,n,i){return this.r===e&&this.g===t&&this.b===n&&this.a===i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=255*this.r|0;return e=397*e^(255*this.g|0),e=397*e^(255*this.b|0),e=397*e^(255*this.a|0),e}clone(){return(new u).copyFrom(this)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,n,i){return this.r=e,this.g=t,this.b=n,this.a=i,this}set(e,t,n,i){return this.copyFromFloats(e,t,n,i)}setAll(e){return this.r=this.g=this.b=this.a=e,this}toHexString(e=!1){const t=Math.round(255*this.r),n=Math.round(255*this.g),i=Math.round(255*this.b);if(e)return"#"+Object(a.g)(t)+Object(a.g)(n)+Object(a.g)(i);const r=Math.round(255*this.a);return"#"+Object(a.g)(t)+Object(a.g)(n)+Object(a.g)(i)+Object(a.g)(r)}fromHexString(e){return"#"!==e.substring(0,1)||9!==e.length&&7!==e.length||(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,9===e.length&&(this.a=parseInt(e.substring(7,9),16)/255)),this}toLinearSpace(e=!1){const t=new u;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=l(this.r),e.g=l(this.g),e.b=l(this.b)):(e.r=o(this.r),e.g=o(this.g),e.b=o(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new u;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=d(this.r),e.g=d(this.g),e.b=d(this.b)):(e.r=c(this.r),e.g=c(this.g),e.b=c(this.b)),e.a=this.a,this}static FromHexString(e){return"#"!==e.substring(0,1)||9!==e.length&&7!==e.length?new u(0,0,0,0):new u(0,0,0,1).fromHexString(e)}static Lerp(e,t,n){return u.LerpToRef(e,t,n,new u)}static LerpToRef(e,t,n,i){return i.r=e.r+(t.r-e.r)*n,i.g=e.g+(t.g-e.g)*n,i.b=e.b+(t.b-e.b)*n,i.a=e.a+(t.a-e.a)*n,i}static Hermite(e,t,n,i,r){const s=r*r,a=r*s,o=2*a-3*s+1,l=-2*a+3*s,c=a-2*s+r,d=a-s,h=e.r*o+n.r*l+t.r*c+i.r*d,f=e.g*o+n.g*l+t.g*c+i.g*d,m=e.b*o+n.b*l+t.b*c+i.b*d,p=e.a*o+n.a*l+t.a*c+i.a*d;return new u(h,f,m,p)}static Hermite1stDerivative(e,t,n,i,r){const s=new u;return this.Hermite1stDerivativeToRef(e,t,n,i,r,s),s}static Hermite1stDerivativeToRef(e,t,n,i,r,s){const a=r*r;s.r=6*(a-r)*e.r+(3*a-4*r+1)*t.r+6*(-a+r)*n.r+(3*a-2*r)*i.r,s.g=6*(a-r)*e.g+(3*a-4*r+1)*t.g+6*(-a+r)*n.g+(3*a-2*r)*i.g,s.b=6*(a-r)*e.b+(3*a-4*r+1)*t.b+6*(-a+r)*n.b+(3*a-2*r)*i.b,s.a=6*(a-r)*e.a+(3*a-4*r+1)*t.a+6*(-a+r)*n.a+(3*a-2*r)*i.a}static FromColor3(e,t=1){return new u(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new u(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,n){n.r=e[t],n.g=e[t+1],n.b=e[t+2],n.a=e[t+3]}static FromInts(e,t,n,i){return new u(e/255,t/255,n/255,i/255)}static CheckColors4(e,t){if(e.length===3*t){const t=[];for(let n=0;n<e.length;n+=3){const i=n/3*4;t[i]=e[n],t[i+1]=e[n+1],t[i+2]=e[n+2],t[i+3]=1}return t}return e}constructor(e=0,t=0,n=0,i=1){this.r=e,this.g=t,this.b=n,this.a=i}}u._V8PerformanceHack=new u(.5,.5,.5,.5),Object.defineProperties(u.prototype,{dimension:{value:[4]},rank:{value:1}});class f{}f.Color3=Object(i.a)(3,h.Black),f.Color4=Object(i.a)(3,()=>new u(0,0,0,0)),Object(r.b)("BABYLON.Color3",h),Object(r.b)("BABYLON.Color4",u)},function(e,t,n){"use strict";n.d(t,"b",(function(){return g})),n.d(t,"a",(function(){return _}));var i=n(43),r=n(48),s=n(36),a=n(338),o=n(173),l=n(75),c=n(329),d=n(62),h=n(324),u=n(121),f=n(393),m=n(317),p=n(140);class g{static get BaseUrl(){return h.b.BaseUrl}static set BaseUrl(e){h.b.BaseUrl=e}static get CleanUrl(){return h.b.CleanUrl}static set CleanUrl(e){h.b.CleanUrl=e}static IsAbsoluteUrl(e){return 0===e.indexOf("//")||-1!==e.indexOf("://")&&-1!==e.indexOf(".")&&-1!==e.indexOf("/")&&!(e.indexOf(":")>e.indexOf("/"))&&(e.indexOf("://")<e.indexOf(".")||0===e.indexOf("data:")||0===e.indexOf("blob:"))}static set ScriptBaseUrl(e){h.b.ScriptBaseUrl=e}static get ScriptBaseUrl(){return h.b.ScriptBaseUrl}static set CDNBaseUrl(e){g.ScriptBaseUrl=e,g.AssetBaseUrl=e}static set ScriptPreprocessUrl(e){h.b.ScriptPreprocessUrl=e}static get ScriptPreprocessUrl(){return h.b.ScriptPreprocessUrl}static get DefaultRetryStrategy(){return h.b.DefaultRetryStrategy}static set DefaultRetryStrategy(e){h.b.DefaultRetryStrategy=e}static get CorsBehavior(){return h.b.CorsBehavior}static set CorsBehavior(e){h.b.CorsBehavior=e}static get UseFallbackTexture(){return d.a.UseFallbackTexture}static set UseFallbackTexture(e){d.a.UseFallbackTexture=e}static get RegisteredExternalClasses(){return f.a.RegisteredExternalClasses}static set RegisteredExternalClasses(e){f.a.RegisteredExternalClasses=e}static get fallbackTexture(){return d.a.FallbackTexture}static set fallbackTexture(e){d.a.FallbackTexture=e}static FetchToRef(e,t,n,i,r,s){const a=4*((Math.abs(e)*n%n|0)+(Math.abs(t)*i%i|0)*n);s.r=r[a]/255,s.g=r[a+1]/255,s.b=r[a+2]/255,s.a=r[a+3]/255}static Mix(e,t,n){return 0}static Instantiate(e){return f.a.Instantiate(e)}static SetImmediate(e){u.a.SetImmediate(e)}static IsExponentOfTwo(e){return!0}static FloatRound(e){return Math.fround(e)}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const n=e.lastIndexOf("/");return n<0?t?e:"":e.substring(0,n+1)}static ToDegrees(e){return 180*e/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,n=.9){const i=this.ToRadians(e),r=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-n)*Math.sin(r)+n*Math.sin(i),(1-n)*Math.cos(r)+n*Math.cos(i)))}static MakeArray(e,t){return!0===t||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:null}static GetPointerPrefix(e){return Object(r.d)()&&!window.PointerEvent?"mouse":"pointer"}static SetCorsBehavior(e,t){Object(h.i)(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static get PreprocessUrl(){return h.b.PreprocessUrl}static set PreprocessUrl(e){h.b.PreprocessUrl=e}static LoadImage(e,t,n,i,r,s){return Object(h.f)(e,t,n,i,r,s)}static LoadFile(e,t,n,i,r,s){return Object(h.d)(e,t,n,i,r,s)}static LoadFileAsync(e,t=!0){return new Promise((n,i)=>{Object(h.d)(e,e=>{n(e)},void 0,void 0,t,(e,t)=>{i(t)})})}static GetAssetUrl(e){if(!e)return"";if(g.AssetBaseUrl&&e.startsWith(g._DefaultAssetsUrl)){const t="/"===g.AssetBaseUrl[g.AssetBaseUrl.length-1]?g.AssetBaseUrl.substring(0,g.AssetBaseUrl.length-1):g.AssetBaseUrl;return e.replace(g._DefaultAssetsUrl,t)}return e}static GetBabylonScriptURL(e,t){if(!e)return"";if(g.ScriptBaseUrl&&e.startsWith(g._DefaultCdnUrl)){const t="/"===g.ScriptBaseUrl[g.ScriptBaseUrl.length-1]?g.ScriptBaseUrl.substring(0,g.ScriptBaseUrl.length-1):g.ScriptBaseUrl;e=e.replace(g._DefaultCdnUrl,t)}return e=g.ScriptPreprocessUrl(e),t&&(e=g.GetAbsoluteUrl(e)),e}static LoadBabylonScript(e,t,n,i){e=g.GetBabylonScriptURL(e),g.LoadScript(e,t,n)}static LoadBabylonScriptAsync(e){return e=g.GetBabylonScriptURL(e),g.LoadScriptAsync(e)}static LoadScript(e,t,n,i,s=!1){if("function"==typeof importScripts){try{importScripts(e),t&&t()}catch(t){null==n||n(`Unable to load script '${e}' in worker`,t)}return}if(!Object(r.d)())return void(null==n||n(`Cannot load script '${e}' outside of a window or a worker`));const a=document.getElementsByTagName("head")[0],o=document.createElement("script");s?(o.setAttribute("type","module"),o.innerText=e):(o.setAttribute("type","text/javascript"),o.setAttribute("src",e)),i&&(o.id=i),o.onload=()=>{t&&t()},o.onerror=t=>{n&&n(`Unable to load script '${e}'`,t)},a.appendChild(o)}static LoadScriptAsync(e,t){return new Promise((n,i)=>{this.LoadScript(e,()=>{n()},(e,t)=>{i(t||new Error(e))},t)})}static ReadFileAsDataURL(e,t,n){const r=new FileReader,s={onCompleteObservable:new i.a,abort:()=>r.abort()};return r.onloadend=()=>{s.onCompleteObservable.notifyObservers(s)},r.onload=e=>{t(e.target.result)},r.onprogress=n,r.readAsDataURL(e),s}static ReadFile(e,t,n,i,r){return Object(h.g)(e,t,n,i,r)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,n,i){a.a.DeepCopy(e,t,n,i)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let n=0;n<t.length;n++){const i=t[n];e.addEventListener(i.name,i.handler,!1);try{window.parent&&window.parent.addEventListener(i.name,i.handler,!1)}catch(e){}}}static UnregisterTopRootEvents(e,t){for(let n=0;n<t.length;n++){const i=t[n];e.removeEventListener(i.name,i.handler);try{e.parent&&e.parent.removeEventListener(i.name,i.handler)}catch(e){}}}static async DumpFramebuffer(e,t,n,i,r="image/png",s,a){throw Object(l.a)("DumpTools")}static DumpData(e,t,n,i,r="image/png",s,a=!1,o=!1,c){throw Object(l.a)("DumpTools")}static DumpDataAsync(e,t,n,i="image/png",r,s=!1,a=!1,o){throw Object(l.a)("DumpTools")}static _IsOffScreenCanvas(e){return void 0!==e.convertToBlob}static ToBlob(e,t,n="image/png",i){g._IsOffScreenCanvas(e)||e.toBlob||(e.toBlob=function(e,t,n){setTimeout(()=>{const i=atob(this.toDataURL(t,n).split(",")[1]),r=i.length,s=new Uint8Array(r);for(let e=0;e<r;e++)s[e]=i.charCodeAt(e);e(new Blob([s]))})}),g._IsOffScreenCanvas(e)?e.convertToBlob({type:n,quality:i}).then(e=>t(e)):e.toBlob((function(e){t(e)}),n,i)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const e=new Date;t="screenshot_"+(e.getFullYear()+"-"+(e.getMonth()+1)).slice(2)+"-"+e.getDate()+"_"+e.getHours()+"-"+("0"+e.getMinutes()).slice(-2)+".png"}g.Download(e,t)}else if(e&&"undefined"!=typeof URL){const t=URL.createObjectURL(e),n=window.open("");if(!n)return;const i=n.document.createElement("img");i.onload=function(){URL.revokeObjectURL(t)},i.src=t,n.document.body.appendChild(i)}}static EncodeScreenshotCanvasData(e,t,n="image/png",i,r){if("string"!=typeof i&&t){if(t){if(g._IsOffScreenCanvas(e))return void e.convertToBlob({type:n,quality:r}).then(e=>{const n=new FileReader;n.readAsDataURL(e),n.onloadend=()=>{const e=n.result;t(e)}});const i=e.toDataURL(n,r);t(i)}}else this.ToBlob(e,(function(e){e&&g.DownloadBlob(e,i),t&&t("")}),n,r)}static Download(e,t){if("undefined"==typeof URL)return;const n=window.URL.createObjectURL(e),i=document.createElement("a");document.body.appendChild(i),i.style.display="none",i.href=n,i.download=t,i.addEventListener("click",()=>{i.parentElement&&i.parentElement.removeChild(i)}),i.click(),window.URL.revokeObjectURL(n)}static BackCompatCameraNoPreventDefault(e){return"boolean"==typeof e[0]?e[0]:"boolean"==typeof e[1]&&e[1]}static CreateScreenshot(e,t,n,i,r="image/png",s=!1,a){throw Object(l.a)("ScreenshotTools")}static CreateScreenshotAsync(e,t,n,i="image/png",r){throw Object(l.a)("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,n,i,r="image/png",s=1,a=!1,o,c=!1,d=!1,h=!0,u,f){throw Object(l.a)("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,n,i="image/png",r=1,s=!1,a,o=!1,c=!1,d=!0,h,u){throw Object(l.a)("ScreenshotTools")}static RandomId(){return Object(m.a)()}static IsBase64(e){return Object(h.c)(e)}static DecodeBase64(e){return Object(h.a)(e)}static get errorsCount(){return s.a.errorsCount}static Log(e){s.a.Log(e)}static Warn(e){s.a.Warn(e)}static Error(e){s.a.Error(e)}static get LogCache(){return s.a.LogCache}static ClearLogCache(){s.a.ClearLogCache()}static set LogLevels(e){s.a.LogLevels=e}static set PerformanceLogLevel(e){return(e&g.PerformanceUserMarkLogLevel)===g.PerformanceUserMarkLogLevel?(g.StartPerformanceCounter=g._StartUserMark,void(g.EndPerformanceCounter=g._EndUserMark)):(e&g.PerformanceConsoleLogLevel)===g.PerformanceConsoleLogLevel?(g.StartPerformanceCounter=g._StartPerformanceConsole,void(g.EndPerformanceCounter=g._EndPerformanceConsole)):(g.StartPerformanceCounter=g._StartPerformanceCounterDisabled,void(g.EndPerformanceCounter=g._EndPerformanceCounterDisabled))}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!g._Performance){if(!Object(r.d)())return;g._Performance=window.performance}t&&g._Performance.mark&&g._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){t&&g._Performance.mark&&(g._Performance.mark(e+"-End"),g._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(g._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(g._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return o.a.Now}static GetClassName(e,t=!1){let n=null;return!t&&e.getClassName?n=e.getClassName():(e instanceof Object&&(n=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),n||(n=typeof e)),n}static First(e,t){for(const n of e)if(t(n))return n;return null}static getFullClassName(e,t=!1){let n=null,i=null;if(!t&&e.getClassName)n=e.getClassName();else{if(e instanceof Object){const r=t?e:Object.getPrototypeOf(e);n=r.constructor.__bjsclassName__,i=r.constructor.__bjsmoduleName__}n||(n=typeof e)}return n?(null!=i?i+".":"")+n:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return!!Object(r.c)()&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}}g.AssetBaseUrl="",g.UseCustomRequestHeaders=!1,g.CustomRequestHeaders=c.a.CustomRequestHeaders,g.GetDOMTextContent=r.a,g._DefaultCdnUrl="https://cdn.babylonjs.com",g._DefaultAssetsUrl="https://assets.babylonjs.com/core",g.GetAbsoluteUrl="object"==typeof document?e=>{const t=document.createElement("a");return t.href=e,t.href}:"function"==typeof URL&&"object"==typeof location?e=>new URL(e,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},g.NoneLogLevel=s.a.NoneLogLevel,g.MessageLogLevel=s.a.MessageLogLevel,g.WarningLogLevel=s.a.WarningLogLevel,g.ErrorLogLevel=s.a.ErrorLogLevel,g.AllLogLevel=s.a.AllLogLevel,g.IsWindowObjectExist=r.d,g.PerformanceNoneLogLevel=0,g.PerformanceUserMarkLogLevel=1,g.PerformanceConsoleLogLevel=2,g.StartPerformanceCounter=g._StartPerformanceCounterDisabled,g.EndPerformanceCounter=g._EndPerformanceCounterDisabled;class _{executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,n,i=0){const r=new _(e,t,n,i);return r.executeNext(),r}static SyncAsyncForLoop(e,t,n,i,r,s=0){return _.Run(Math.ceil(e/t),i=>{r&&r()?i.breakLoop():setTimeout(()=>{for(let s=0;s<t;++s){const a=i.index*t+s;if(a>=e)break;if(n(a),r&&r()){i.breakLoop();break}}i.executeNext()},s)},i)}constructor(e,t,n,i=0){this.iterations=e,this.index=i-1,this._done=!1,this._fn=t,this._successCallback=n}}g.Mix=p.d,g.IsExponentOfTwo=p.c,d.a.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z"},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(75),r=n(325),s=n(311),a=n(84),o=n(392);const l=function(e,t,n,i={}){const s=e();r.a&&r.a.HasTags(t)&&r.a.AddTagsTo(s,r.a.GetTags(t,!0));const a=Object(o.b)(s),l={};for(const e in a){const r=a[e],o=t[e],d=r.type;if(null!=o&&("uniqueId"!==e||c.AllowLoadingUniqueId))switch(d){case 0:case 6:case 9:case 11:s[e]=o;break;case 1:i.cloneTexturesOnlyOnce&&l[o.uniqueId]?s[e]=l[o.uniqueId]:(s[e]=n||o.isRenderTarget?o:o.clone(),l[o.uniqueId]=s[e]);break;case 2:case 3:case 4:case 5:case 7:case 8:case 10:case 12:s[e]=n?o:o.clone()}}return s};class c{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let n=0;n<e.animations.length;n++){const i=e.animations[n];t.animations.push(i.serialize())}}}static Serialize(e,t){t||(t={}),r.a&&(t.tags=r.a.GetTags(e));const n=Object(o.b)(e);for(const i in n){const r=n[i],s=r.sourceName||i,a=r.type,o=e[i];if(null!=o&&("uniqueId"!==i||c.AllowLoadingUniqueId))switch(a){case 0:t[s]=o;break;case 1:t[s]=o.serialize();break;case 2:t[s]=o.asArray();break;case 3:t[s]=o.serialize();break;case 4:case 5:t[s]=o.asArray();break;case 6:t[s]=o.id;break;case 7:t[s]=o.serialize();break;case 8:t[s]=o.asArray();break;case 9:t[s]=o.serialize();break;case 10:t[s]=o.asArray();break;case 11:t[s]=o.id;break;case 12:t[s]=o.asArray()}}return t}static ParseProperties(e,t,n,i){i||(i="");const r=Object(o.b)(t);for(const o in r){const l=r[o],d=e[l.sourceName||o],h=l.type;if(null!=d&&("uniqueId"!==o||c.AllowLoadingUniqueId)){const e=t;switch(h){case 0:e[o]=d;break;case 1:n&&(e[o]=c._TextureParser(d,n,i));break;case 2:e[o]=s.a.FromArray(d);break;case 3:e[o]=c._FresnelParametersParser(d);break;case 4:e[o]=a.d.FromArray(d);break;case 5:e[o]=a.e.FromArray(d);break;case 6:n&&(e[o]=n.getLastMeshById(d));break;case 7:e[o]=c._ColorCurvesParser(d);break;case 8:e[o]=s.b.FromArray(d);break;case 9:e[o]=c._ImageProcessingConfigurationParser(d);break;case 10:e[o]=a.b.FromArray(d);break;case 11:n&&(e[o]=n.getCameraById(d));break;case 12:e[o]=a.a.FromArray(d)}}}}static Parse(e,t,n,i=null){const s=e();return r.a&&r.a.AddTagsTo(s,t.tags),c.ParseProperties(t,s,n,i),s}static Clone(e,t,n={}){return l(e,t,!1,n)}static Instanciate(e,t){return l(e,t,!0)}}c.AllowLoadingUniqueId=!1,c._ImageProcessingConfigurationParser=e=>{throw Object(i.a)("ImageProcessingConfiguration")},c._FresnelParametersParser=e=>{throw Object(i.a)("FresnelParameters")},c._ColorCurvesParser=e=>{throw Object(i.a)("ColorCurves")},c._TextureParser=(e,t,n)=>{throw Object(i.a)("Texture")}},function(e,t,n){"use strict";n.d(t,"a",(function(){return _}));var i=n(309),r=n(310),s=n(43),a=n(84),o=n(332),l=n(108),c=n(75),d=n(121),h=n(393),u=n(328),f=n(373);function m(e,t,n=!1){const i=t.width,r=t.height;if(e instanceof Float32Array){let t=e.byteLength/e.BYTES_PER_ELEMENT;const n=new Uint8Array(t);for(;--t>=0;){let i=e[t];i<0?i=0:i>1&&(i=1),n[t]=255*i}e=n}const s=document.createElement("canvas");s.width=i,s.height=r;const a=s.getContext("2d");if(!a)return null;const o=a.createImageData(i,r);if(o.data.set(e),a.putImageData(o,0,0),n){const e=document.createElement("canvas");e.width=i,e.height=r;const t=e.getContext("2d");return t?(t.translate(0,r),t.scale(1,-1),t.drawImage(s,0,0),e.toDataURL("image/png")):null}return s.toDataURL("image/png")}var p=n(394),g=n(313);class _ extends o.a{static _CreateVideoTexture(e,t,n,i=!1,r=!1,s=_.TRILINEAR_SAMPLINGMODE,a={},o,l=5){throw Object(c.a)("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}updateURL(e,t=null,n,i){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1,e=>e.hasTexture(this))),this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=i,this.delayLoadState=4,n&&(this._delayedOnLoad=n),this.delayLoad()}delayLoad(){if(4!==this.delayLoadState)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?d.a.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,n,i){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,n-=this.wRotationCenter,a.e.TransformCoordinatesFromFloatsToRef(e,t,n,this._rowGenerationMatrix,i),i.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,i.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,i.z+=this.wRotationCenter}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,this._cachedTextureMatrix&&this._rowGenerationMatrix||(this._cachedTextureMatrix=a.a.Zero(),this._rowGenerationMatrix=new a.a,this._t0=a.e.Zero(),this._t1=a.e.Zero(),this._t2=a.e.Zero()),a.a.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(a.a.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,a.c.Matrix[0]),a.a.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,a.c.Matrix[1]),a.a.ScalingToRef(this._cachedUScale,this._cachedVScale,0,a.c.Matrix[2]),a.a.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,a.c.Matrix[3]),a.c.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(a.c.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(a.c.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(a.c.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),a.a.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();if(!t)return this._cachedTextureMatrix;const n=this._cachedIdentity3x2;return this._cachedIdentity3x2=this._cachedTextureMatrix.isIdentityAs3x2(),this.optimizeUVAllocation&&n!==this._cachedIdentity3x2&&t.markAllMaterialsAsDirty(1,e=>e.hasTexture(this)),this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode){if(this.coordinatesMode!==_.PROJECTION_MODE)return this._cachedReflectionTextureMatrix;if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=a.a.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=a.a.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case _.PLANAR_MODE:a.a.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break;case _.PROJECTION_MODE:{a.a.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const t=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=t.updateFlag,t.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:a.a.IdentityToRef(this._cachedReflectionTextureMatrix)}return t&&e.markAllMaterialsAsDirty(1,e=>e.hasTexture(this)),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return g.a.Clone(()=>new _(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){var e;const t=this.name;_.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const n=super.serialize(_._SerializeInternalTextureUniqueId);return n?((_.SerializeBuffers||_.ForceSerializeBuffers)&&("string"==typeof this._buffer&&"data:"===this._buffer.substring(0,5)?(n.base64String=this._buffer,n.name=n.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?n.base64String="data:image/png;base64,"+Object(f.d)(this._buffer):(_.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(n.base64String=!this._engine||this._engine._features.supportSyncTextureRead?function(e,t=0,n=0){const i=e.getInternalTexture();if(!i)return null;const r=e._readPixelsSync(t,n);return r?m(r,e.getSize(),i.invertY):null}(this):async function(e,t=0,n=0){const i=e.getInternalTexture();if(!i)return null;const r=await e.readPixels(t,n);return r?m(r,e.getSize(),i.invertY):null}(this))),n.invertY=this._invertY,n.samplingMode=this.samplingMode,n._creationFlags=this._creationFlags,n._useSRGBBuffer=this._useSRGBBuffer,_._SerializeInternalTextureUniqueId&&(n.internalTextureUniqueId=null===(i=this._texture)||void 0===i?void 0:i.uniqueId),n.internalTextureLabel=null===(e=this._texture)||void 0===e?void 0:e.label,n.noMipmap=this._noMipmap,this.name=t,n):null;var i}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,n){if(e.customType){const i=h.a.Instantiate(e.customType).Parse(e,t,n);return e.samplingMode&&i.updateSamplingMode&&i._samplingMode&&i._samplingMode!==e.samplingMode&&i.updateSamplingMode(e.samplingMode),i}if(e.isCube&&!e.isRenderTarget)return _._CubeTextureParser(e,t,n);const i=void 0!==e.internalTextureUniqueId;if(!e.name&&!e.isRenderTarget&&!i)return null;let r;if(i){const n=t.getEngine().getLoadedTexturesCache();for(const t of n)if(t.uniqueId===e.internalTextureUniqueId){r=t;break}}const s=t=>{if(t&&t._texture&&(t._texture._cachedWrapU=null,t._texture._cachedWrapV=null,t._texture._cachedWrapR=null),e.samplingMode){const n=e.samplingMode;t&&t.samplingMode!==n&&t.updateSamplingMode(n)}if(t&&e.animations)for(let n=0;n<e.animations.length;n++){const i=e.animations[n],r=Object(l.a)("BABYLON.Animation");r&&t.animations.push(r.Parse(i))}t&&t._texture&&(i&&!r&&t._texture._setUniqueId(e.internalTextureUniqueId),t._texture.label=e.internalTextureLabel)};return g.a.Parse(()=>{let i=!0;if(e.noMipmap&&(i=!1),e.mirrorPlane){const n=_._CreateMirror(e.name,e.renderTargetSize,t,i);return n._waitingRenderList=e.renderList,n.mirrorPlane=u.a.FromArray(e.mirrorPlane),s(n),n}if(e.isRenderTarget){let n=null;var a;if(e.isCube){if(t.reflectionProbes)for(let n=0;n<t.reflectionProbes.length;n++){const i=t.reflectionProbes[n];if(i.name===e.name)return i.cubeTexture}}else n=_._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,i,null!==(a=e._creationFlags)&&void 0!==a?a:0),n._waitingRenderList=e.renderList;return s(n),n}if(e.isVideo){const r=_._CreateVideoTexture(n+(e.url||e.name),n+(e.src||e.url),t,i,e.invertY,e.samplingMode,e.settings||{});return s(r),r}{let a;if(e.base64String&&!r){var o,l;a=_.CreateFromBase64String(e.base64String,e.base64String,t,!i,e.invertY,e.samplingMode,()=>{s(a)},null!==(o=e._creationFlags)&&void 0!==o?o:0,null!==(l=e._useSRGBBuffer)&&void 0!==l&&l),a.name=e.name}else{let o;o=e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?e.name:n+e.name,e.url&&(e.url.startsWith("data:")||_.UseSerializedUrlIfAny)&&(o=e.url);const l={noMipmap:!i,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{s(a)},internalTexture:r};a=new _(o,t,l)}return a}},e,t)}static CreateFromBase64String(e,t,n,i,r,s=_.TRILINEAR_SAMPLINGMODE,a=null,o=null,l=5,c,d){return new _("data:"+t,n,i,r,s,a,o,e,!1,l,void 0,void 0,c,d)}static LoadFromDataString(e,t,n,i=!1,r,s=!0,a=_.TRILINEAR_SAMPLINGMODE,o=null,l=null,c=5,d,h){return"data:"!==e.substring(0,5)&&(e="data:"+e),new _(e,n,r,s,a,o,l,t,i,c,void 0,void 0,d,h)}constructor(e,t,n,i,r=_.TRILINEAR_SAMPLINGMODE,a=null,o=null,l=null,c=!1,h,u,f,m,g){var v;let E;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedIdentity3x2=!0,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new s.a,this._isBlocking=!0,this.name=e||"",this.url=e;let T=!1,S=null,A=!0;var b,I,R,C,y,M,O,x,D,P,L;"object"==typeof n&&null!==n?(E=null!==(b=n.noMipmap)&&void 0!==b&&b,i=null!==(I=n.invertY)&&void 0!==I?I:!p.a,r=null!==(R=n.samplingMode)&&void 0!==R?R:_.TRILINEAR_SAMPLINGMODE,a=null!==(C=n.onLoad)&&void 0!==C?C:null,o=null!==(y=n.onError)&&void 0!==y?y:null,l=null!==(M=n.buffer)&&void 0!==M?M:null,c=null!==(O=n.deleteBuffer)&&void 0!==O&&O,h=n.format,u=n.mimeType,f=n.loaderOptions,m=n.creationFlags,T=null!==(x=n.useSRGBBuffer)&&void 0!==x&&x,S=null!==(D=n.internalTexture)&&void 0!==D?D:null,A=null!==(P=n.gammaSpace)&&void 0!==P?P:A,g=null!==(L=n.forcedExtension)&&void 0!==L?L:g):E=!!n,this._gammaSpace=A,this._noMipmap=E,this._invertY=void 0===i?!p.a:i,this._initialSamplingMode=r,this._buffer=l,this._deleteBuffer=c,this._mimeType=u,this._loaderOptions=f,this._creationFlags=m,this._useSRGBBuffer=T,this._forcedExtension=g,h&&(this._format=h);const N=this.getScene(),F=this._getEngine();if(!F)return;F.onBeforeTextureInitObservable.notifyObservers(this);const w=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),null!==this._texture._cachedWrapU&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),null!==this._texture._cachedWrapV&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),null!==this._texture._cachedWrapR&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),a&&a(),!this.isBlocking&&N&&N.resetCachedMaterial()},U=(e,t)=>{this._loadingError=!0,this._errorObject={message:e,exception:t},o&&o(e,t),_.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!S)return this._delayedOnLoad=w,void(this._delayedOnError=U);if(this._texture=null!==(v=S)&&void 0!==v?v:this._getFromCache(this.url,E,r,this._invertY,T,this.isCube),this._texture)if(this._texture.isReady)d.a.SetImmediate(()=>w());else{const e=this._texture.onLoadedObservable.add(w);this._texture.onErrorObservable.add(t=>{var n;U(t.message,t.exception),null===(n=this._texture)||void 0===n||n.onLoadedObservable.remove(e)})}else if(N&&N.useDelayedTextureLoading)this.delayLoadState=4,this._delayedOnLoad=w,this._delayedOnError=U;else{try{this._texture=F.createTexture(this.url,E,this._invertY,N,r,w,U,this._buffer,void 0,this._format,this._forcedExtension,u,f,m,T)}catch(e){throw U("error loading",e),e}c&&(this._buffer=null)}}}_.SerializeBuffers=!0,_.ForceSerializeBuffers=!1,_.OnTextureLoadErrorObservable=new s.a,_._SerializeInternalTextureUniqueId=!1,_._CubeTextureParser=(e,t,n)=>{throw Object(c.a)("CubeTexture")},_._CreateMirror=(e,t,n,i)=>{throw Object(c.a)("MirrorTexture")},_._CreateRenderTargetTexture=(e,t,n,i,r)=>{throw Object(c.a)("RenderTargetTexture")},_.NEAREST_SAMPLINGMODE=1,_.NEAREST_NEAREST_MIPLINEAR=8,_.BILINEAR_SAMPLINGMODE=2,_.LINEAR_LINEAR_MIPNEAREST=11,_.TRILINEAR_SAMPLINGMODE=3,_.LINEAR_LINEAR_MIPLINEAR=3,_.NEAREST_NEAREST_MIPNEAREST=4,_.NEAREST_LINEAR_MIPNEAREST=5,_.NEAREST_LINEAR_MIPLINEAR=6,_.NEAREST_LINEAR=7,_.NEAREST_NEAREST=1,_.LINEAR_NEAREST_MIPNEAREST=9,_.LINEAR_NEAREST_MIPLINEAR=10,_.LINEAR_LINEAR=2,_.LINEAR_NEAREST=12,_.EXPLICIT_MODE=0,_.SPHERICAL_MODE=1,_.PLANAR_MODE=2,_.CUBIC_MODE=3,_.PROJECTION_MODE=4,_.SKYBOX_MODE=5,_.INVCUBIC_MODE=6,_.EQUIRECTANGULAR_MODE=7,_.FIXED_EQUIRECTANGULAR_MODE=8,_.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,_.CLAMP_ADDRESSMODE=0,_.WRAP_ADDRESSMODE=1,_.MIRROR_ADDRESSMODE=2,_.UseSerializedUrlIfAny=!1,Object(i.a)([Object(r.c)()],_.prototype,"url",void 0),Object(i.a)([Object(r.c)()],_.prototype,"uOffset",void 0),Object(i.a)([Object(r.c)()],_.prototype,"vOffset",void 0),Object(i.a)([Object(r.c)()],_.prototype,"uScale",void 0),Object(i.a)([Object(r.c)()],_.prototype,"vScale",void 0),Object(i.a)([Object(r.c)()],_.prototype,"uAng",void 0),Object(i.a)([Object(r.c)()],_.prototype,"vAng",void 0),Object(i.a)([Object(r.c)()],_.prototype,"wAng",void 0),Object(i.a)([Object(r.c)()],_.prototype,"uRotationCenter",void 0),Object(i.a)([Object(r.c)()],_.prototype,"vRotationCenter",void 0),Object(i.a)([Object(r.c)()],_.prototype,"wRotationCenter",void 0),Object(i.a)([Object(r.c)()],_.prototype,"homogeneousRotationInUVTransform",void 0),Object(i.a)([Object(r.c)()],_.prototype,"isBlocking",null),Object(l.b)("BABYLON.Texture",_),g.a._TextureParser=_.Parse},function(e,t,n){"use strict";(function(e){
/*!
 * Microsoft Dynamic Proto Utility, 1.1.9
 * Copyright (c) Microsoft and contributors. All rights reserved.
 */
var i;n.d(t,"a",(function(){return S}));var r,s=Object,a=s.getPrototypeOf,o=s.getOwnPropertyNames,l=("undefined"!=typeof globalThis&&(r=globalThis),r||"undefined"==typeof self||(r=self),r||"undefined"==typeof window||(r=window),r||void 0===e||(r=e),r||{}),c=l.__dynProto$Gbl||(l.__dynProto$Gbl={o:(i={},i.setInstFuncs=!0,i.useBaseInst=!0,i),n:1e3});function d(e,t){return e&&s.prototype.hasOwnProperty.call(e,t)}function h(e){return e&&(e===s.prototype||e===Array.prototype)}function u(e){return h(e)||e===Function.prototype}function f(e){var t;if(e){if(a)return a(e);var n=e.__proto__||e.prototype||(e.constructor?e.constructor.prototype:null);t=e._dyn__proto__||n,d(e,"_dyn__proto__")||(delete e._dynInstProto,t=e._dyn__proto__=e._dynInstProto||e._dyn__proto__,e._dynInstProto=n)}return t}function m(e,t){var n=[];if(o)n=o(e);else for(var i in e)"string"==typeof i&&d(e,i)&&n.push(i);if(n&&n.length>0)for(var r=0;r<n.length;r++)t(n[r])}function p(e,t,n){return"constructor"!==t&&"function"==typeof e[t]&&(n||d(e,t))}function g(e){throw new TypeError("DynamicProto: "+e)}function _(e,t){for(var n=e.length-1;n>=0;n--)if(e[n]===t)return!0;return!1}function v(e,t,n,i){var r=null;if(e&&d(n,"_dynClass")){var s=e._dynInstFuncs||{};if((r=(s[n._dynClass]||{})[t])||g("Missing ["+t+"] function"),!r._dynInstChk&&!1!==s._dynInstChk){for(var a=!d(e,t),o=f(e),l=[];a&&o&&!u(o)&&!_(l,o);){var c=o[t];if(c){a=c===i;break}l.push(o),o=f(o)}try{a&&(e[t]=r),r._dynInstChk=1}catch(e){s._dynInstChk=!1}}}return r}function E(e,t,n){var i=t[e];return i===n&&(i=f(t)[e]),"function"!=typeof i&&g("["+e+"] is not a function"),i}function T(e,t){return d(e,"prototype")?e.name||t||"_unknown_":((e||{}).constructor||{}).name||t||"_unknown_"}function S(e,t,n,i){d(e,"prototype")||g("theClass is an invalid class definition.");var r=e.prototype;(function(e,t){if(a){for(var n=[],i=f(t);i&&!u(i)&&!_(n,i);){if(i===e)return!0;n.push(i),i=f(i)}return!1}return!0})(r,t)||g("["+T(e)+"] not in hierarchy of ["+T(t)+"]");var s=null;d(r,"_dynClass")?s=r._dynClass:(s="_dynCls$"+T(e,"_")+"$"+c.n,c.n++,r._dynClass=s);var o=S._dfOpts,l=!!o.useBaseInst;l&&i&&void 0!==i.useBaseInst&&(l=!!i.useBaseInst);var A=function(e){var t={};return m(e,(function(n){!t[n]&&p(e,n,!1)&&(t[n]=e[n])})),t}(t);n(t,function(e,t,n,i){function r(e,t,n){var r=t[n];if(r._isDynProxy&&i){var s=e._dynInstFuncs||{};!1!==s._dynInstChk&&(r=(s[t._dynClass]||{})[n]||r)}return function(){return r.apply(e,arguments)}}var s={};m(n,(function(e){s[e]=r(t,n,e)}));for(var o=f(e),l=[];o&&!u(o)&&!_(l,o);)m(o,(function(e){!s[e]&&p(o,e,!a)&&(s[e]=r(t,o,e))})),l.push(o),o=f(o);return s}(r,t,A,l));var b=!!a&&!!o.setInstFuncs;b&&i&&(b=!!i.setInstFuncs),function(e,t,n,i,r){if(!h(e)){var s=n._dynInstFuncs=n._dynInstFuncs||{},a=s[t]=s[t]||{};!1!==s._dynInstChk&&(s._dynInstChk=!!r),m(n,(function(t){p(n,t,!1)&&n[t]!==i[t]&&(a[t]=n[t],delete n[t],(!d(e,t)||e[t]&&!e[t]._isDynProxy)&&(e[t]=function(e,t){var n=function(){var i=v(this,t,e,n)||E(t,e,n);return i.apply(this,arguments)};return n._isDynProxy=1,n}(e,t)))}))}}(r,s,t,A,!1!==b)}S._dfOpts=c.o}).call(this,n(96))},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(309),r=n(84),s=n(310),a=n(43),o=n(62),l=n(75),c=n(313);class d{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new a.a,this._onClonedObservable=new a.a}}class h{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,n,i){const r=this._NodeConstructors[e];return r?r(t,n,i):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return!!this._nodeDataStorage._doNotSerialize||!!this._parentNode&&this._parentNode.doNotSerialize}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&void 0!==this._parentNode._children&&null!==this._parentNode._children){const t=this._parentNode._children.indexOf(this);-1!==t&&this._parentNode._children.splice(t,1),e||this._nodeDataStorage._isDisposed||this._addToSceneRootNodes()}this._parentNode=e,this._isDirty=!0,this._parentNode&&(void 0!==this._parentNode._children&&null!==this._parentNode._children||(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){-1===this._nodeDataStorage._sceneRootNodesIndex&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(-1!==this._nodeDataStorage._sceneRootNodesIndex){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return-1!==this._behaviors.indexOf(e)||(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e)),this}removeBehavior(e){const t=this._behaviors.indexOf(e);return-1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={}}updateCache(e){!e&&this.isSynchronized()||this._updateCache()}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return!this._parentNode||!this._parentNode._isDirty&&this._parentUpdateId===this._parentNode._childUpdateId&&this._parentNode.isSynchronized()}isSynchronized(){return!(this._parentNode&&!this.isSynchronizedWithParent())&&this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return!1===e?this._nodeDataStorage._isEnabled:!!this._nodeDataStorage._isEnabled&&this._nodeDataStorage._isParentEnabled}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=!this._parentNode||this._parentNode.isEnabled(),this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return!!this.parent&&(this.parent===e||this.parent.isDescendantOf(e))}_getDescendants(e,t=!1,n){if(this._children)for(let i=0;i<this._children.length;i++){const r=this._children[i];n&&!n(r)||e.push(r),t||r._getDescendants(e,!1,n)}}getDescendants(e,t){const n=[];return this._getDescendants(n,e,t),n}getChildMeshes(e,t){const n=[];return this._getDescendants(n,e,e=>(!t||t(e))&&void 0!==e.cullingStrategy),n}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){e!==this._nodeDataStorage._isReady&&(e?(this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0):this._nodeDataStorage._isReady=!1)}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const n=this.animations[t];if(n.name===e)return n}return null}createAnimationRange(e,t,n){if(!this._ranges[e]){this._ranges[e]=h._AnimationRangeFactory(e,t,n);for(let i=0,r=this.animations.length;i<r;i++)this.animations[i]&&this.animations[i].createRange(e,t,n)}}deleteAnimationRange(e,t=!0){for(let n=0,i=this.animations.length;n<i;n++)this.animations[n]&&this.animations[n].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,n){const i=c.a.Clone(()=>new h(e,this.getScene()),this);if(t&&(i.parent=t),!n){const t=this.getDescendants(!0);for(let n=0;n<t.length;n++){const r=t[n];r.clone(e+"."+r.name,i)}}return i}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,n,i){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,n,i):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const n=this._ranges[t];if(!n)continue;const i={};i.name=t,i.from=n.from,i.to=n.to,e.push(i)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=r.a.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const n=this.getDescendants(!0);for(const i of n)i.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const e of this._behaviors)e.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,n){if(t.ranges)for(let n=0;n<t.ranges.length;n++){const i=t.ranges[n];e.createAnimationRange(i.name,i.from,i.to)}}getHierarchyBoundingVectors(e=!0,t=null){let n,i;this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);const s=this;if(s.getBoundingInfo&&s.subMeshes){const e=s.getBoundingInfo();n=e.boundingBox.minimumWorld.clone(),i=e.boundingBox.maximumWorld.clone()}else n=new r.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new r.e(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const e=this.getDescendants(!1);for(const s of e){const e=s;if(e.computeWorldMatrix(!0),t&&!t(e))continue;if(!e.getBoundingInfo||0===e.getTotalVertices())continue;const a=e.getBoundingInfo().boundingBox,o=a.minimumWorld,l=a.maximumWorld;r.e.CheckExtends(o,n,i),r.e.CheckExtends(l,n,i)}}return{min:n,max:i}}constructor(e,t=null,n=!0){this._isDirty=!1,this._nodeDataStorage=new d,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new a.a,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=r.a.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new a.a,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||o.a.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache(),n&&this._addToSceneRootNodes()}}h._AnimationRangeFactory=(e,t,n)=>{throw Object(l.a)("AnimationRange")},h._NodeConstructors={},Object(i.a)([Object(s.c)()],h.prototype,"name",void 0),Object(i.a)([Object(s.c)()],h.prototype,"id",void 0),Object(i.a)([Object(s.c)()],h.prototype,"uniqueId",void 0),Object(i.a)([Object(s.c)()],h.prototype,"state",void 0),Object(i.a)([Object(s.c)()],h.prototype,"metadata",void 0)},function(e,t,n){"use strict";function i(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}n.d(t,"a",(function(){return i}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return $}));var i=n(312),r=n(173),s=n(43),a=n(319);class o{copyFrom(e){this.clear(),e.forEach((e,t)=>this.add(e,t))}get(e){const t=this._data[e];if(void 0!==t)return t}getOrAddWithFactory(e,t){let n=this.get(e);return void 0!==n||(n=t(e),n&&this.add(e,n)),n}getOrAdd(e,t){const n=this.get(e);return void 0!==n?n:(this.add(e,t),t)}contains(e){return void 0!==this._data[e]}add(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)}set(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null}remove(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data)e(t,this._data[t])}first(e){for(const t in this._data){const n=e(t,this._data[t]);if(n)return n}return null}constructor(){this._count=0,this._data={}}}var l=n(325),c=n(84),d=n(388),h=n(339),u=n(376);class f{static CreateNew(e,t,n){const i=e.getScene();return new f(e,i.pointerX,i.pointerY,i.meshUnderPointer||e,t,n)}static CreateNewFromSprite(e,t,n,i){return new f(e,t.pointerX,t.pointerY,t.meshUnderPointer,n,i)}static CreateNewFromScene(e,t){return new f(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,n,i){return new f(e,t.x,t.y,null,n,i)}constructor(e,t,n,i,r,s){this.source=e,this.pointerX=t,this.pointerY=n,this.meshUnderPointer=i,this.sourceEvent=r,this.additionalData=s}}var m=n(374),p=n(389),g=n(340),_=n(48),v=n(62),E=n(75),T=n(330);class S{static get HasTriggers(){for(const e in S.Triggers)if(Object.prototype.hasOwnProperty.call(S.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in S.Triggers)if(Object.prototype.hasOwnProperty.call(S.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in S.Triggers)if(Object.prototype.hasOwnProperty.call(S.Triggers,t)&&parseInt(t)===e)return!0;return!1}constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1,this.disposeWhenUnowned=!0}}S.Triggers={};var A,b,I,R,C,y,M,O=n(399);!function(e){e[e.Generic=0]="Generic",e[e.Keyboard=1]="Keyboard",e[e.Mouse=2]="Mouse",e[e.Touch=3]="Touch",e[e.DualShock=4]="DualShock",e[e.Xbox=5]="Xbox",e[e.Switch=6]="Switch",e[e.DualSense=7]="DualSense"}(A||(A={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.Move=12]="Move"}(b||(b={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.DeltaHorizontal=10]="DeltaHorizontal",e[e.DeltaVertical=11]="DeltaVertical"}(I||(I={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(R||(R={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Create=8]="Create",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(C||(C={})),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.LT=6]="LT",e[e.RT=7]="RT",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.LStickXAxis=17]="LStickXAxis",e[e.LStickYAxis=18]="LStickYAxis",e[e.RStickXAxis=19]="RStickXAxis",e[e.RStickYAxis=20]="RStickYAxis"}(y||(y={})),function(e){e[e.B=0]="B",e[e.A=1]="A",e[e.Y=2]="Y",e[e.X=3]="X",e[e.L=4]="L",e[e.R=5]="R",e[e.ZL=6]="ZL",e[e.ZR=7]="ZR",e[e.Minus=8]="Minus",e[e.Plus=9]="Plus",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.Capture=17]="Capture",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(M||(M={}));var x=n(400);class D{static CreateDeviceEvent(e,t,n,i,r,s,a){switch(e){case A.Keyboard:return this._CreateKeyboardEvent(n,i,r,s);case A.Mouse:if(n===b.MouseWheelX||n===b.MouseWheelY||n===b.MouseWheelZ)return this._CreateWheelEvent(e,t,n,i,r,s);case A.Touch:return this._CreatePointerEvent(e,t,n,i,r,s,a);default:throw"Unable to generate event for device "+A[e]}}static _CreatePointerEvent(e,t,n,i,r,s,a){const o=this._CreateMouseEvent(e,t,n,i,r,s);e===A.Mouse?(o.deviceType=A.Mouse,o.pointerId=1,o.pointerType="mouse"):(o.deviceType=A.Touch,o.pointerId=null!=a?a:t,o.pointerType="touch");let l=0;return l+=r.pollInput(e,t,b.LeftClick),l+=2*r.pollInput(e,t,b.RightClick),l+=4*r.pollInput(e,t,b.MiddleClick),o.buttons=l,n===b.Move?o.type="pointermove":n>=b.LeftClick&&n<=b.RightClick&&(o.type=1===i?"pointerdown":"pointerup",o.button=n-2),o}static _CreateWheelEvent(e,t,n,i,r,s){const a=this._CreateMouseEvent(e,t,n,i,r,s);switch(a.pointerId=1,a.type="wheel",a.deltaMode=x.a.DOM_DELTA_PIXEL,a.deltaX=0,a.deltaY=0,a.deltaZ=0,n){case b.MouseWheelX:a.deltaX=i;break;case b.MouseWheelY:a.deltaY=i;break;case b.MouseWheelZ:a.deltaZ=i}return a}static _CreateMouseEvent(e,t,n,i,r,s){const a=this._CreateEvent(s),o=r.pollInput(e,t,b.Horizontal),l=r.pollInput(e,t,b.Vertical);return s?(a.movementX=0,a.movementY=0,a.offsetX=a.movementX-s.getBoundingClientRect().x,a.offsetY=a.movementY-s.getBoundingClientRect().y):(a.movementX=r.pollInput(e,t,10),a.movementY=r.pollInput(e,t,11),a.offsetX=0,a.offsetY=0),this._CheckNonCharacterKeys(a,r),a.clientX=o,a.clientY=l,a.x=o,a.y=l,a.deviceType=e,a.deviceSlot=t,a.inputIndex=n,a}static _CreateKeyboardEvent(e,t,n,i){const r=this._CreateEvent(i);return this._CheckNonCharacterKeys(r,n),r.deviceType=A.Keyboard,r.deviceSlot=0,r.inputIndex=e,r.type=1===t?"keydown":"keyup",r.key=String.fromCharCode(e),r.keyCode=e,r}static _CheckNonCharacterKeys(e,t){const n=t.isDeviceAvailable(A.Keyboard),i=n&&1===t.pollInput(A.Keyboard,0,18),r=n&&1===t.pollInput(A.Keyboard,0,17),s=n&&(1===t.pollInput(A.Keyboard,0,91)||1===t.pollInput(A.Keyboard,0,92)||1===t.pollInput(A.Keyboard,0,93)),a=n&&1===t.pollInput(A.Keyboard,0,16);e.altKey=i,e.ctrlKey=r,e.metaKey=s,e.shiftKey=a}static _CreateEvent(e){const t={preventDefault:()=>{}};return t.target=e,t}}class P{pollInput(e,t,n){return this._nativeInput.pollInput(e,t,n)}isDeviceAvailable(e){return e===A.Mouse||e===A.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}constructor(e,t,n){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(e,t,i,r)=>{const s=D.CreateDeviceEvent(e,t,i,r,this);n(e,t,s)}):this._createDummyNativeInput()}}const L=Object.keys(b).length/2;class N{pollInput(e,t,n){const r=this._inputs[e][t];if(!r)throw"Unable to find device "+A[e];e>=A.DualShock&&e<=A.DualSense&&this._updateDevice(e,t,n);const s=r[n];if(void 0===s)throw`Unable to find input ${n} for device ${A[e]} in slot ${t}`;return n===b.Move&&i.b.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),s}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=null==this?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(const e of this._inputs)if(e)for(const t in e){const n=e[+t];if(n)for(let e=0;e<n.length;e++)n[e]=0}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOS&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(A.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),n=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,n,e.buttons.length+e.axes.length),this._gamepads[n]=t}_addPointerDevice(e,t,n,i){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,L);const r=this._inputs[e][t];r[0]=n,r[1]=i}_registerDevice(e,t,n){if(void 0===t)throw`Unable to register device ${A[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const i=new Array(n);i.fill(0),this._inputs[e][t]=i,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(A.Keyboard,0,255));const t=this._inputs[A.Keyboard][0];if(t){t[e.keyCode]=1;const n=e;n.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&"Meta"!==e.key&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(A.Keyboard,0,n)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(A.Keyboard,0,255));const t=this._inputs[A.Keyboard][0];if(t){t[e.keyCode]=0;const n=e;if(n.inputIndex=e.keyCode,this._usingMacOS&&"Meta"===e.key&&this._metaKeys.length>0){for(const e of this._metaKeys){const n=D.CreateDeviceEvent(A.Keyboard,0,e,0,this,this._elementToAttachTo);t[e]=0,this._onInputChanged(A.Keyboard,0,n)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(A.Keyboard,0,n)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[A.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;const n=D.CreateDeviceEvent(A.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(A.Keyboard,0,n)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=Object(_.c)()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let e=0;e<this._maxTouchPoints;e++)this._activeTouchIds[e]=-1;this._pointerMoveEvent=e=>{const t=this._getPointerType(e);let n=t===A.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===A.Touch&&-1===n){const r=this._activeTouchIds.indexOf(-1);if(!(r>=0))return void i.b.Warn("Max number of touches exceeded.  Ignoring touches in excess of "+this._maxTouchPoints);n=r,this._activeTouchIds[r]=e.pointerId,this._onDeviceConnected(t,n)}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][n]||this._addPointerDevice(t,n,e.clientX,e.clientY);const r=this._inputs[t][n];if(r){const i=e;i.inputIndex=b.Move,r[b.Horizontal]=e.clientX,r[b.Vertical]=e.clientY,t===A.Touch&&0===r[b.LeftClick]&&(r[b.LeftClick]=1),void 0===e.pointerId&&(e.pointerId=this._mouseId),this._onInputChanged(t,n,i),this._usingSafari||-1===e.button||(i.inputIndex=e.button+2,r[e.button+2]=r[e.button+2]?0:1,this._onInputChanged(t,n,i))}},this._pointerDownEvent=e=>{const t=this._getPointerType(e);let n=t===A.Mouse?0:e.pointerId;if(t===A.Touch){let t=this._activeTouchIds.indexOf(e.pointerId);if(-1===t&&(t=this._activeTouchIds.indexOf(-1)),!(t>=0))return void i.b.Warn("Max number of touches exceeded.  Ignoring touches in excess of "+this._maxTouchPoints);n=t,this._activeTouchIds[t]=e.pointerId}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][n]?t===A.Touch&&this._onDeviceConnected(t,n):this._addPointerDevice(t,n,e.clientX,e.clientY);const r=this._inputs[t][n];if(r){const i=r[b.Horizontal],s=r[b.Vertical];if(t===A.Mouse){if(void 0===e.pointerId&&(e.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch(e){}}else if(e.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(e.pointerId)}catch(e){}r[b.Horizontal]=e.clientX,r[b.Vertical]=e.clientY,r[e.button+2]=1;const a=e;a.inputIndex=e.button+2,this._onInputChanged(t,n,a),i===e.clientX&&s===e.clientY||(a.inputIndex=b.Move,this._onInputChanged(t,n,a))}},this._pointerUpEvent=e=>{var t;const n=this._getPointerType(e),i=n===A.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(n===A.Touch){if(-1===i)return;this._activeTouchIds[i]=-1}const r=null===(t=this._inputs[n])||void 0===t?void 0:t[i];if(r&&0!==r[e.button+2]){var s,a,o,l;const t=r[b.Horizontal],c=r[b.Vertical];r[b.Horizontal]=e.clientX,r[b.Vertical]=e.clientY,r[e.button+2]=0;const d=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),t===e.clientX&&c===e.clientY||(d.inputIndex=b.Move,this._onInputChanged(n,i,d)),d.inputIndex=e.button+2,n===A.Mouse&&this._mouseId>=0&&null!==(s=(a=this._elementToAttachTo).hasPointerCapture)&&void 0!==s&&s.call(a,this._mouseId)?this._elementToAttachTo.releasePointerCapture(this._mouseId):e.pointerId&&null!==(o=(l=this._elementToAttachTo).hasPointerCapture)&&void 0!==o&&o.call(l,e.pointerId)&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._onInputChanged(n,i,d),n===A.Touch&&this._onDeviceDisconnected(n,i)}},this._pointerCancelTouch=e=>{var t,n;const i=this._activeTouchIds.indexOf(e);if(-1===i)return;null!==(t=(n=this._elementToAttachTo).hasPointerCapture)&&void 0!==t&&t.call(n,e)&&this._elementToAttachTo.releasePointerCapture(e),this._inputs[A.Touch][i][b.LeftClick]=0;const r=D.CreateDeviceEvent(A.Touch,i,b.LeftClick,0,this,this._elementToAttachTo,e);this._onInputChanged(A.Touch,i,r),this._activeTouchIds[i]=-1,this._onDeviceDisconnected(A.Touch,i)},this._pointerCancelEvent=e=>{if("mouse"===e.pointerType){var t,n;const e=this._inputs[A.Mouse][0];this._mouseId>=0&&null!==(t=(n=this._elementToAttachTo).hasPointerCapture)&&void 0!==t&&t.call(n,this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=b.LeftClick;t<=b.BrowserForward;t++)if(1===e[t]){e[t]=0;const n=D.CreateDeviceEvent(A.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(A.Mouse,0,n)}}else this._pointerCancelTouch(e.pointerId)},this._pointerLeaveEvent=e=>{"pen"===e.pointerType&&this._pointerCancelTouch(e.pointerId)},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const n=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,n),this._elementToAttachTo.removeEventListener("test",t,n)}catch(e){}this._pointerBlurEvent=()=>{if(this.isDeviceAvailable(A.Mouse)){var e,t;const n=this._inputs[A.Mouse][0];this._mouseId>=0&&null!==(e=(t=this._elementToAttachTo).hasPointerCapture)&&void 0!==e&&e.call(t,this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let e=b.LeftClick;e<=b.BrowserForward;e++)if(1===n[e]){n[e]=0;const t=D.CreateDeviceEvent(A.Mouse,0,e,0,this,this._elementToAttachTo);this._onInputChanged(A.Mouse,0,t)}}if(this.isDeviceAvailable(A.Touch)){const e=this._inputs[A.Touch];for(let t=0;t<this._activeTouchIds.length;t++){var n,i,r;const s=this._activeTouchIds[t];if(null!==(n=(i=this._elementToAttachTo).hasPointerCapture)&&void 0!==n&&n.call(i,s)&&this._elementToAttachTo.releasePointerCapture(s),-1!==s&&1===(null===(r=e[t])||void 0===r?void 0:r[b.LeftClick])){e[t][b.LeftClick]=0;const n=D.CreateDeviceEvent(A.Touch,t,b.LeftClick,0,this,this._elementToAttachTo,s);this._onInputChanged(A.Touch,t,n),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(A.Touch,t)}}}},this._pointerWheelEvent=e=>{const t=A.Mouse;this._inputs[t]||(this._inputs[t]=[]),this._inputs[t][0]||(this._pointerActive=!0,this._registerDevice(t,0,L));const n=this._inputs[t][0];if(n){n[b.MouseWheelX]=e.deltaX||0,n[b.MouseWheelY]=e.deltaY||e.wheelDelta||0,n[b.MouseWheelZ]=e.deltaZ||0;const i=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),0!==n[b.MouseWheelX]&&(i.inputIndex=b.MouseWheelX,this._onInputChanged(t,0,i)),0!==n[b.MouseWheelY]&&(i.inputIndex=b.MouseWheelY,this._onInputChanged(t,0,i)),0!==n[b.MouseWheelZ]&&(i.inputIndex=b.MouseWheelZ,this._onInputChanged(t,0,i))}},this._usingMacOS&&this._isUsingChromium&&(this._pointerMacOSChromeOutEvent=e=>{e.buttons>1&&this._pointerCancelEvent(e)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(A.Mouse)){const e=this._inputs[A.Mouse][0];e[b.MouseWheelX]=0,e[b.MouseWheelY]=0,e[b.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),n=e.gamepad.index;this._unregisterDevice(t,n),delete this._gamepads[n]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,n){const i=navigator.getGamepads()[t];if(i&&e===this._gamepads[t]){const r=this._inputs[e][t];n>=i.buttons.length?r[n]=i.axes[n-i.buttons.length].valueOf():r[n]=i.buttons[n].value}}_getGamepadDeviceType(e){return-1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?A.DualSense:A.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?A.Xbox:-1!==e.indexOf("057e")?A.Switch:A.Generic}_getPointerType(e){let t=A.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=A.Touch),t}constructor(e,t,n,r){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=i.b.IsSafari(),this._usingMacOS=Object(_.c)()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=e=>{},this._keyboardUpEvent=e=>{},this._keyboardBlurEvent=e=>{},this._pointerMoveEvent=e=>{},this._pointerDownEvent=e=>{},this._pointerUpEvent=e=>{},this._pointerCancelEvent=e=>{},this._pointerCancelTouch=e=>{},this._pointerLeaveEvent=e=>{},this._pointerWheelEvent=e=>{},this._pointerBlurEvent=e=>{},this._pointerMacOSChromeOutEvent=e=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Object(_.c)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._isUsingChromium=Object(_.c)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Chrome"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=e=>{},this._gamepadDisconnectedEvent=e=>{},this._eventPrefix=i.b.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=n,this._onInputChanged=r,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}}class F{getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}constructor(e,t,n=0){this.deviceType=t,this.deviceSlot=n,this.onInputChangedObservable=new s.a,this._deviceInputSystem=e}}class w{dispose(){this._deviceInputSystem.dispose()}constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=e=>{for(let t=0;t<this._devices.length;t++){const n=this._devices[t];for(const i in n){const n=+i;e._addDevice(new F(this._deviceInputSystem,t,n))}}this._registeredManagers.push(e)},this.unregisterManager=e=>{const t=this._registeredManagers.indexOf(e);t>-1&&this._registeredManagers.splice(t,1)};const t=Object.keys(A).length/2;this._devices=new Array(t);const n=(e,t)=>{this._devices[e]||(this._devices[e]=new Array),this._devices[e][t]||(this._devices[e][t]=t);for(const n of this._registeredManagers){const i=new F(this._deviceInputSystem,e,t);n._addDevice(i)}},i=(e,t)=>{var n;null!==(n=this._devices[e])&&void 0!==n&&n[t]&&delete this._devices[e][t];for(const n of this._registeredManagers)n._removeDevice(e,t)},r=(e,t,n)=>{if(n)for(const i of this._registeredManagers)i._onInputChanged(e,t,n)};"undefined"!=typeof _native?this._deviceInputSystem=new P(n,i,r):this._deviceInputSystem=new N(e,n,i,r)}}class U{getDeviceSource(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(e=>!!e):[]}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var n,i;const r=null===(n=this._devices[e])||void 0===n?void 0:n[t];this.onDeviceDisconnectedObservable.notifyObservers(r),null!==(i=this._devices[e])&&void 0!==i&&i[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,n){var i;null===(i=this._devices[e])||void 0===i||null===(i=i[t])||void 0===i||i.onInputChangedObservable.notifyObservers(n)}_updateFirstDevices(e){switch(e){case A.Keyboard:case A.Mouse:this._firstDevice[e]=0;break;case A.Touch:case A.DualSense:case A.DualShock:case A.Xbox:case A.Switch:case A.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t)for(let n=0;n<t.length;n++)if(t[n]){this._firstDevice[e]=n;break}break}}}constructor(e){const t=Object.keys(A).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new w(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new s.a(e=>{for(const t of this._devices)if(t)for(const n of t)n&&this.onDeviceConnectedObservable.notifyObserver(e,n)}),this.onDeviceDisconnectedObservable=new s.a,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}}class B{}B._IsPickingAvailable=!1;class k{get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}}class V{get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new c.d(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const n=this._scene,i=n.getEngine(),r=i.getInputElement();r&&(r.tabIndex=i.canvasTabIndex,n.doNotHandleCursors||(r.style.cursor=n.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,n);for(const i of n._pointerMoveStage){var s;const n=!(null===(s=e=e||this._pickMove(t))||void 0===s||!s.pickedMesh);e=i.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,n,r)}const a=t.inputIndex>=b.MouseWheelX&&t.inputIndex<=b.MouseWheelZ?T.a.POINTERWHEEL:T.a.POINTERMOVE;let o;n.onPointerMove&&(e=e||this._pickMove(t),n.onPointerMove(t,e,a)),e?(o=new T.b(a,t,e),this._setRayOnPointerInfo(e,t)):(o=new T.b(a,t,null,this),this._movePointerInfo=o),n.onPointerObservable.hasObservers()&&n.onPointerObservable.notifyObservers(o,a)}_setRayOnPointerInfo(e,t){const n=this._scene;e&&B._IsPickingAvailable&&(e.ray||(e.ray=n.createPickingRay(t.offsetX,t.offsetY,c.a.Identity(),n.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,n){const i=this._scene,r=new T.c(n,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(r.originalPickingInfo=e,r.ray=e.ray,"xr-near"===t.pointerType&&e.originMesh&&(r.nearInteractionPickingInfo=e)),i.onPrePointerObservable.notifyObservers(r,n),!!r.skipOnPointerObservable}_pickMove(e){const t=this._scene,n=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,t.pointerMoveFastCheck,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(n,e,t),n}_setCursorAndPointerOverMesh(e,t,n){const i=n.getEngine().getInputElement();if(null!=e&&e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!n.doNotHandleCursors&&i&&this._pointerOverMesh){const e=this._pointerOverMesh._getActionManagerForTrigger();e&&e.hasPointerTriggers&&(i.style.cursor=e.hoverCursor||n.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){const n=new PointerEvent("pointermove",t);n.inputIndex=b.Move,this._checkPrePointerObservable(e,n,T.a.POINTERMOVE)||this._processPointerMove(e,n)}simulatePointerDown(e,t){const n=new PointerEvent("pointerdown",t);n.inputIndex=n.button+2,this._checkPrePointerObservable(e,n,T.a.POINTERDOWN)||this._processPointerDown(e,n)}_processPointerDown(e,t){var n;const i=this._scene;if(null!==(n=e)&&void 0!==n&&n.pickedMesh){this._pickedDownMesh=e.pickedMesh;const n=e.pickedMesh._getActionManagerForTrigger();if(n){if(n.hasPickTriggers)switch(n.processTrigger(5,new f(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e)),t.button){case 0:n.processTrigger(2,new f(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break;case 1:n.processTrigger(4,new f(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break;case 2:n.processTrigger(3,new f(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e))}n.hasSpecificTrigger(8)&&window.setTimeout(()=>{const e=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,e=>e.isPickable&&e.isVisible&&e.isReady()&&e.actionManager&&e.actionManager.hasSpecificTrigger(8)&&e===this._pickedDownMesh,!1,i.cameraToUseForPointers);null!=e&&e.pickedMesh&&n&&0!==this._activePointerIdsCount&&Date.now()-this._startingPointerTime>V.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,n.processTrigger(8,f.CreateNew(e.pickedMesh,t)))},V.LongPressDelay)}}else for(const n of i._pointerDownStage)e=n.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let r;const s=T.a.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,s),r=new T.b(s,t,e),this._setRayOnPointerInfo(e,t)):r=new T.b(s,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(r,s)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,n){const i=new PointerEvent("pointerup",t);i.inputIndex=b.Move;const r=new k;n?r.doubleClick=!0:r.singleClick=!0,this._checkPrePointerObservable(e,i,T.a.POINTERUP)||this._processPointerUp(e,i,r)}_processPointerUp(e,t,n){var i;const r=this._scene;if(null!==(i=e)&&void 0!==i&&i.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(r.onPointerPick&&r.onPointerPick(t,e),n.singleClick&&!n.ignore&&r.onPointerObservable.observers.length>this._cameraObserverCount)){const n=T.a.POINTERPICK,i=new T.b(n,t,e);this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(i,n)}const i=e.pickedMesh._getActionManagerForTrigger();if(i&&!n.ignore){i.processTrigger(7,f.CreateNew(e.pickedMesh,t,e)),!n.hasSwiped&&n.singleClick&&i.processTrigger(1,f.CreateNew(e.pickedMesh,t,e));const r=e.pickedMesh._getActionManagerForTrigger(6);n.doubleClick&&r&&r.processTrigger(6,f.CreateNew(e.pickedMesh,t,e))}}else if(!n.ignore)for(const i of r._pointerUpStage)e=i.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,n.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const e=this._pickedDownMesh._getActionManagerForTrigger(16);e&&e.processTrigger(16,f.CreateNew(this._pickedDownMesh,t))}if(!n.ignore){const i=new T.b(T.a.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(i,T.a.POINTERUP),r.onPointerUp&&r.onPointerUp(t,e,T.a.POINTERUP),!n.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let i=0;if(n.singleClick?i=T.a.POINTERTAP:n.doubleClick&&(i=T.a.POINTERDOUBLETAP),i){const n=new T.b(i,t,e);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(i)&&r.onPointerObservable.notifyObservers(n,i)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,n=!0,i=null){const r=this._scene,s=r.getEngine();i||(i=s.getInputElement()),this._alreadyAttached&&this.detachControl(),i&&(this._alreadyAttachedTo=i),this._deviceSourceManager=new U(s),this._initActionManager=e=>{if(!this._meshPickProceed){const t=r.skipPointerUpPicking||0===r._registeredActions&&!this._checkForPicking()&&!r.onPointerUp?null:r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerUpPredicate,r.pointerUpFastCheck,r.cameraToUseForPointers,r.pointerUpTrianglePredicate);this._currentPickResult=t,t&&(e=t.hit&&t.pickedMesh?t.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return e},this._delayedSimpleClick=(e,t,n)=>{if((Date.now()-this._previousStartingPointerTime>V.DoubleClickDelay&&!this._doubleClickOccured||e!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,t.singleClick=!0,t.ignore=!1,this._delayedClicks[e])){const t=this._delayedClicks[e].evt,n=T.a.POINTERTAP,i=new T.b(n,t,this._currentPickResult);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(n)&&r.onPointerObservable.notifyObservers(i,n),this._delayedClicks[e]=null}},this._initClickEvent=(e,t,n,i)=>{const r=new k;this._currentPickResult=null;let s=null,a=e.hasSpecificMask(T.a.POINTERPICK)||t.hasSpecificMask(T.a.POINTERPICK)||e.hasSpecificMask(T.a.POINTERTAP)||t.hasSpecificMask(T.a.POINTERTAP)||e.hasSpecificMask(T.a.POINTERDOUBLETAP)||t.hasSpecificMask(T.a.POINTERDOUBLETAP);!a&&S&&(s=this._initActionManager(s,r),s&&(a=s.hasPickTriggers));let o=!1;if(a=a&&!this._isMultiTouchGesture,a){const a=n.button;if(r.hasSwiped=this._isPointerSwiping(),!r.hasSwiped){let d=!V.ExclusiveDoubleClickMode;if(d||(d=!e.hasSpecificMask(T.a.POINTERDOUBLETAP)&&!t.hasSpecificMask(T.a.POINTERDOUBLETAP),d&&!S.HasSpecificTrigger(6)&&(s=this._initActionManager(s,r),s&&(d=!s.hasSpecificTrigger(6)))),d)(Date.now()-this._previousStartingPointerTime>V.DoubleClickDelay||a!==this._previousButtonPressed)&&(r.singleClick=!0,i(r,this._currentPickResult),o=!0);else{const e={evt:n,clickInfo:r,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,a,r,i),V.DoubleClickDelay)};this._delayedClicks[a]=e}let h=e.hasSpecificMask(T.a.POINTERDOUBLETAP)||t.hasSpecificMask(T.a.POINTERDOUBLETAP);if(!h&&S.HasSpecificTrigger(6)&&(s=this._initActionManager(s,r),s&&(h=s.hasSpecificTrigger(6))),h)if(a===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<V.DoubleClickDelay&&!this._doubleClickOccured){var l;if(r.hasSwiped||this._isPointerSwiping())if(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=a,V.ExclusiveDoubleClickMode){var c;this._delayedClicks[a]&&(clearTimeout(null===(c=this._delayedClicks[a])||void 0===c?void 0:c.timeoutId),this._delayedClicks[a]=null),i(r,this._previousPickResult)}else i(r,this._currentPickResult);else this._previousStartingPointerTime=0,this._doubleClickOccured=!0,r.doubleClick=!0,r.ignore=!1,V.ExclusiveDoubleClickMode&&this._delayedClicks[a]&&(clearTimeout(null===(l=this._delayedClicks[a])||void 0===l?void 0:l.timeoutId),this._delayedClicks[a]=null),i(r,this._currentPickResult);o=!0}else this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=a}}o||i(r,this._currentPickResult)},this._onPointerMove=e=>{if(this._updatePointerPosition(e),this._isSwiping||-1===this._swipeButtonPressed||(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>V.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>V.DragMovementThreshold),s.isPointerLock&&s._verifyPointerLock(),this._checkPrePointerObservable(null,e,e.inputIndex>=b.MouseWheelX&&e.inputIndex<=b.MouseWheelZ?T.a.POINTERWHEEL:T.a.POINTERMOVE))return;if(!r.cameraToUseForPointers&&!r.activeCamera)return;if(r.skipPointerMovePicking)return void this._processPointerMove(new u.a,e);r.pointerMovePredicate||(r.pointerMovePredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(e.enablePointerMoveEvents||r.constantlyUpdateMeshUnderPointer||null!==e._getActionManagerForTrigger())&&(!r.cameraToUseForPointers||0!=(r.cameraToUseForPointers.layerMask&e.layerMask)));const t=r._registeredActions>0||r.constantlyUpdateMeshUnderPointer?this._pickMove(e):null;this._processPointerMove(t,e)},this._onPointerDown=e=>{const t=this._activePointerIds.indexOf(-1);if(-1===t?this._activePointerIds.push(e.pointerId):this._activePointerIds[t]=e.pointerId,this._activePointerIdsCount++,this._pickedDownMesh=null,this._meshPickProceed=!1,V.ExclusiveDoubleClickMode)for(let t=0;t<this._delayedClicks.length;t++)if(this._delayedClicks[t])if(e.button===t){var n;clearTimeout(null===(n=this._delayedClicks[t])||void 0===n?void 0:n.timeoutId)}else{const e=this._delayedClicks[t].clickInfo;this._doubleClickOccured=!1,e.singleClick=!0,e.ignore=!1;const n=this._delayedClicks[t].evt,i=T.a.POINTERTAP,s=new T.b(i,n,this._currentPickResult);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(i)&&r.onPointerObservable.notifyObservers(s,i),this._delayedClicks[t]=null}if(this._updatePointerPosition(e),-1===this._swipeButtonPressed&&(this._swipeButtonPressed=e.button),r.preventDefaultOnPointerDown&&i&&(e.preventDefault(),i.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,e,T.a.POINTERDOWN))return;if(!r.cameraToUseForPointers&&!r.activeCamera)return;let s;this._pointerCaptures[e.pointerId]=!0,r.pointerDownPredicate||(r.pointerDownPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!r.cameraToUseForPointers||0!=(r.cameraToUseForPointers.layerMask&e.layerMask))),this._pickedDownMesh=null,s=r.skipPointerDownPicking||0===r._registeredActions&&!this._checkForPicking()&&!r.onPointerDown?new u.a:r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerDownPredicate,r.pointerDownFastCheck,r.cameraToUseForPointers,r.pointerDownTrianglePredicate),this._processPointerDown(s,e)},this._onPointerUp=e=>{const t=this._activePointerIds.indexOf(e.pointerId);-1!==t&&(this._activePointerIds[t]=-1,this._activePointerIdsCount--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(e),r.preventDefaultOnPointerUp&&i&&(e.preventDefault(),i.focus()),this._initClickEvent(r.onPrePointerObservable,r.onPointerObservable,e,(t,n)=>{if(r.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!t.ignore)){if(this._checkPrePointerObservable(null,e,T.a.POINTERUP))return this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1),void(0===e.buttons&&(this._pointerCaptures[e.pointerId]=!1));t.hasSwiped||(t.singleClick&&r.onPrePointerObservable.hasSpecificMask(T.a.POINTERTAP)&&this._checkPrePointerObservable(null,e,T.a.POINTERTAP)&&(this._skipPointerTap=!0),t.doubleClick&&r.onPrePointerObservable.hasSpecificMask(T.a.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,e,T.a.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}this._pointerCaptures[e.pointerId]?(0===e.buttons&&(this._pointerCaptures[e.pointerId]=!1),(r.cameraToUseForPointers||r.activeCamera)&&(r.pointerUpPredicate||(r.pointerUpPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!r.cameraToUseForPointers||0!=(r.cameraToUseForPointers.layerMask&e.layerMask))),!this._meshPickProceed&&(S&&S.HasTriggers||this._checkForPicking()||r.onPointerUp)&&this._initActionManager(null,t),n||(n=this._currentPickResult),this._processPointerUp(n,e,t),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))):this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1)}))},this._onKeyDown=e=>{const t=O.a.KEYDOWN;if(r.onPreKeyboardObservable.hasObservers()){const n=new O.c(t,e);if(r.onPreKeyboardObservable.notifyObservers(n,t),n.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const n=new O.b(t,e);r.onKeyboardObservable.notifyObservers(n,t)}r.actionManager&&r.actionManager.processTrigger(14,f.CreateNewFromScene(r,e))},this._onKeyUp=e=>{const t=O.a.KEYUP;if(r.onPreKeyboardObservable.hasObservers()){const n=new O.c(t,e);if(r.onPreKeyboardObservable.notifyObservers(n,t),n.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const n=new O.b(t,e);r.onKeyboardObservable.notifyObservers(n,t)}r.actionManager&&r.actionManager.processTrigger(15,f.CreateNewFromScene(r,e))},this._deviceSourceManager.onDeviceConnectedObservable.add(i=>{i.deviceType===A.Mouse?i.onInputChangedObservable.add(r=>{this._originMouseEvent=r,r.inputIndex===b.LeftClick||r.inputIndex===b.MiddleClick||r.inputIndex===b.RightClick||r.inputIndex===b.BrowserBack||r.inputIndex===b.BrowserForward?t&&1===i.getInput(r.inputIndex)?this._onPointerDown(r):e&&0===i.getInput(r.inputIndex)&&this._onPointerUp(r):n&&(r.inputIndex===b.Move?this._onPointerMove(r):r.inputIndex!==b.MouseWheelX&&r.inputIndex!==b.MouseWheelY&&r.inputIndex!==b.MouseWheelZ||this._onPointerMove(r))}):i.deviceType===A.Touch?i.onInputChangedObservable.add(r=>{r.inputIndex===b.LeftClick&&(t&&1===i.getInput(r.inputIndex)?(this._onPointerDown(r),this._activePointerIdsCount>1&&(this._isMultiTouchGesture=!0)):e&&0===i.getInput(r.inputIndex)&&(this._onPointerUp(r),0===this._activePointerIdsCount&&(this._isMultiTouchGesture=!1))),n&&r.inputIndex===b.Move&&this._onPointerMove(r)}):i.deviceType===A.Keyboard&&i.onInputChangedObservable.add(e=>{"keydown"===e.type?this._onKeyDown(e):"keyup"===e.type&&this._onKeyUp(e)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,n,i){if(!(this._meshUnderPointerId[t]!==e||e&&e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const r=this._meshUnderPointerId[t];let s;r&&(s=r._getActionManagerForTrigger(10),s&&s.processTrigger(10,new f(r,this._pointerX,this._pointerY,e,i,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,s=e._getActionManagerForTrigger(9),s&&s.processTrigger(9,new f(e,this._pointerX,this._pointerY,e,i,{pointerId:t,pickResult:n}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null),this._scene.onMeshUnderPointerUpdatedObservable.hasObservers()&&this._scene.onMeshUnderPointerUpdatedObservable.notifyObservers({mesh:e,pointerId:t})}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._activePointerIds=new Array,this._activePointerIdsCount=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new c.d(0,0),this._previousStartingPointerPosition=new c.d(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||v.a.LastCreatedScene,this._scene}}V.DragMovementThreshold=10,V.LongPressDelay=500,V.DoubleClickDelay=300,V.ExclusiveDoubleClickMode=!1;var G=n(396),H=n(311),W=n(333);class X{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}X._UniqueIdCounter=1;var j=n(324),z=n(377),K=n(87);class Y{constructor(){this.pointerDownFastCheck=!1,this.pointerUpFastCheck=!1,this.pointerMoveFastCheck=!1,this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1}}var q,Q=n(36),Z=n(108);!function(e){e[e.BackwardCompatible=0]="BackwardCompatible",e[e.Intermediate=1]="Intermediate",e[e.Aggressive=2]="Aggressive"}(q||(q={}));class ${static DefaultMaterialFactory(e){throw Object(E.a)("StandardMaterial")}static CollisionCoordinatorFactory(){throw Object(E.a)("DefaultCollisionCoordinator")}get clearColor(){return this._clearColor}set clearColor(e){e!==this._clearColor&&(this._clearColor=e,this.onClearColorChangedObservable.notifyObservers(this._clearColor))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case 0:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case 1:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case 2:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.onEnvironmentTextureChangedObservable.notifyObservers(e),this.markAllMaterialsAsDirty(1))}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return V.DragMovementThreshold}static set DragMovementThreshold(e){V.DragMovementThreshold=e}static get LongPressDelay(){return V.LongPressDelay}static set LongPressDelay(e){V.LongPressDelay=e}static get DoubleClickDelay(){return V.DoubleClickDelay}static set DoubleClickDelay(e){V.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return V.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){V.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",n=!1){var i,r;const s=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:null!==(i=null===(r=this.activeCamera)||void 0===r?void 0:r.globalPosition)&&void 0!==i?i:c.e.ZeroReadOnly,a=this.useRightHandedSystem===(null!=this._mirroredCameraPosition);return c.c.Vector4[0].set(s.x,s.y,s.z,a?-1:1),e&&(n?e.setFloat3(t,c.c.Vector4[0].x,c.c.Vector4[0].y,c.c.Vector4[0].z):e.setVector4(t,c.c.Vector4[0])),c.c.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=Object(K.c)(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=$.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}get frameGraph(){return this._frameGraph}set frameGraph(e){if(this._frameGraph)return this._frameGraph=e,void(e||(this.customRenderFunction=this._currentCustomRenderFunction));this._frameGraph=e,e&&(this._currentCustomRenderFunction=this.customRenderFunction,this.customRenderFunction=this._renderWithFrameGraph)}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=$.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,n=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==n}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return void 0!==this._animationRatio?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,n){return this._inputManager.simulatePointerUp(e,t,n),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,n=!0){this._inputManager.attachControl(e,t,n)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){var t,n,i;if(this._isDisposed)return!1;let r;const s=this.getEngine(),a=s.currentRenderPassId;s.currentRenderPassId=null!==(t=null===(n=this.activeCamera)||void 0===n?void 0:n.renderPassId)&&void 0!==t?t:a;let o=!0;for(this._pendingData.length>0&&(o=!1),null===(i=this.prePassRenderer)||void 0===i||i.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&o&&(o=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),r=0;r<this.meshes.length;r++){const t=this.meshes[r];if(!t.subMeshes||0===t.subMeshes.length)continue;if(!t.isReady(!0)){o=!1;continue}const n=t.hasThinInstances||"InstancedMesh"===t.getClassName()||"InstancedLinesMesh"===t.getClassName()||s.getCaps().instancedArrays&&t.instances.length>0;for(const e of this._isReadyForMeshStage)e.action(t,n)||(o=!1);if(!e)continue;const i=t.material||this.defaultMaterial;if(i)if(i._storeEffectOnSubMeshes)for(const e of t.subMeshes){const t=e.getMaterial();t&&t.hasRenderTargetTextures&&null!=t.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(t)&&(this._processedMaterials.push(t),this._materialsRenderTargets.concatWithNoDuplicate(t.getRenderTargetTextures()))}else i.hasRenderTargetTextures&&null!=i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._materialsRenderTargets.concatWithNoDuplicate(i.getRenderTargetTextures()))}if(e)for(r=0;r<this._materialsRenderTargets.length;++r)this._materialsRenderTargets.data[r].isReadyForRendering()||(o=!1);for(r=0;r<this.geometries.length;r++)2===this.geometries[r].delayLoadState&&(o=!1);if(this.activeCameras&&this.activeCameras.length>0)for(const e of this.activeCameras)e.isReady(!0)||(o=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(o=!1));for(const e of this.particleSystems)e.isReady()||(o=!1);if(this.layers)for(const e of this.layers)e.isReady()||(o=!1);return s.areAllEffectsReady()||(o=!1),s.currentRenderPassId=a,o}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){void 0!==t?setTimeout(()=>{this._executeOnceBeforeRender(e)},t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,n=this._pendingData.indexOf(e);-1!==n&&this._pendingData.splice(n,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){return this._registerTransientComponents(),this.isReady(e)?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):this._isDisposed?(this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):void(this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100))}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=r.a.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,n,i){n||i||!this._multiviewSceneUbo||(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag||(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?W.a.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=W.a.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(n,i):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new h.a(this._engine,void 0,!1,null!=e?e:"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return X.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),i.b.SetImmediate(()=>{this.onNewMeshAddedObservable.notifyObservers(e)}),t&&e.getChildMeshes().forEach(e=>{this.addMesh(e)}))}removeMesh(e,t=!1){const n=this.meshes.indexOf(e);return-1!==n&&(this.meshes.splice(n,1),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(e=>{this.removeMesh(e)}),n}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneTransformNodesArray||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(-1!==t){if(t!==this.transformNodes.length-1){const e=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=e,e._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return-1!==t&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return-1!==t&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(-1!==t){for(const t of this.meshes)t._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(-1!==t&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const t=this.activeCameras.indexOf(e);-1!==t&&this.activeCameras.splice(t,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return-1!==t&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return-1!==t&&this.animations.splice(t,1),t}stopAnimation(e,t,n){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return-1!==t&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return-1!==t&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(-1!==t&&t<this.materials.length){if(t!==this.materials.length-1){const e=this.materials[this.materials.length-1];this.materials[t]=e,e._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return-1!==t&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return-1!==t&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)-1===t.lightSources.indexOf(e)&&(t.lightSources.push(e),t._resyncLightSources());i.b.SetImmediate(()=>{this.onNewLightAddedObservable.notifyObservers(e)})}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(z.a.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),i.b.SetImmediate(()=>{this.onNewCameraAddedObservable.notifyObservers(e)}),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),i.b.SetImmediate(()=>{this.onNewSkeletonAddedObservable.notifyObservers(e)}))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),i.b.SetImmediate(()=>{this.onNewMultiMaterialAddedObservable.notifyObservers(e)}))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneMaterialArray||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),i.b.SetImmediate(()=>{this.onNewMaterialAddedObservable.notifyObservers(e)}))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let e=0;e<this.materials.length;e++){const n=this.materials[e];if(t(n))return n}if(e)for(let e=0;e<this.multiMaterials.length;e++){const n=this.multiMaterials[e];if(t(n))return n}return null}getMaterialByUniqueID(e,t=!1){return this._getMaterial(t,t=>t.uniqueId===e)}getMaterialById(e,t=!1){return this._getMaterial(t,t=>t.id===e)}getMaterialByName(e,t=!1){return this._getMaterial(t,t=>t.name===e)}getLastMaterialById(e,t=!1){for(let t=this.materials.length-1;t>=0;t--)if(this.materials[t].id===e)return this.materials[t];if(t)for(let t=this.multiMaterials.length-1;t>=0;t--)if(this.multiMaterials[t].id===e)return this.multiMaterials[t];return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const n=this.skeletons[t];for(let t=0;t<n.bones.length;t++)if(n.bones[t].id===e)return n.bones[t]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const n=this.skeletons[t];for(let t=0;t<n.bones.length;t++)if(n.bones[t].name===e)return n.bones[t]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(void 0!==t)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}pushGeometry(e,t){return!(!t&&this._getGeometryByUniqueId(e.uniqueId)||(this.addGeometry(e),i.b.SetImmediate(()=>{this.onNewGeometryAddedObservable.notifyObservers(e)}),0))}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],void 0===t)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const e=this.geometries[this.geometries.length-1];e&&(this.geometries[t]=e,this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter((function(t){return t.id===e}))}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter((function(t){return t.id===e}))}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const n=this.getTransformNodeById(e);if(n)return n;const i=this.getLightById(e);if(i)return i;const r=this.getCameraById(e);if(r)return r;return this.getBoneById(e)||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const n=this.getTransformNodeByName(e);if(n)return n;const i=this.getLightByName(e);if(i)return i;const r=this.getCameraByName(e);if(r)return r;return this.getBoneByName(e)||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const n=this.morphTargetManagers[t];for(let t=0;t<n.numTargets;++t){const i=n.getTarget(t);if(i.id===e)return i}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const n=this.morphTargetManagers[t];for(let t=0;t<n.numTargets;++t){const i=n.getTarget(t);if(i.name===e)return i}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const n=this.postProcesses[t];if(n.name===e)return n}return null}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}get uid(){return this._uid||(this._uid=i.b.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new o),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new o),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,n,i){if(i||e.isInFrustum(this._frustumPlanes)){for(const n of this._evaluateSubMeshStage)n.action(t,e);const n=e.getMaterial();null!=n&&(n.hasRenderTargetTextures&&null!=n.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(n)&&(this._processedMaterials.push(n),this._materialsRenderTargets.concatWithNoDuplicate(n.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,n))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,n,i=!0,r=!1){return this.executeWhenReady(()=>{if(this.activeCamera){if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=r,this._skipEvaluateActiveMeshesCompletely=e,i)for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._freeze();t&&t()}else n&&n("No active camera found")}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){(!this._engine.snapshotRendering||1!==this._engine.snapshotRenderingMode)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){var e;if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode)return void(this._activeMeshes.length>0&&(null===(e=this.activeCamera)||void 0===e||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset()));if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const e=this._activeMeshes.length;for(let t=0;t<e;t++)this._activeMeshes.data[t].computeWorldMatrix()}if(this._activeParticleSystems){const e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate()}return void this._renderingManager.resetSprites()}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const e of this._beforeEvaluateActiveMeshStage)e.action();const t=this.getActiveMeshCandidates(),n=t.length;for(let e=0;e<n;e++){const n=t.data[e];let i=n._internalAbstractMeshDataInfo._currentLOD.get(this.activeCamera);if(i?i[1]=-1:(i=[n,-1],n._internalAbstractMeshDataInfo._currentLOD.set(this.activeCamera,i)),n.isBlocked)continue;if(this._totalVertices.addCount(n.getTotalVertices(),!1),!n.isReady()||!n.isEnabled()||n.scaling.hasAZeroComponent)continue;n.computeWorldMatrix(),n.actionManager&&n.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(n);let r=this.customLODSelector?this.customLODSelector(n,this.activeCamera):n.getLOD(this.activeCamera);if(i[0]=r,i[1]=this._frameId,null!=r&&(r!==n&&0!==r.billboardMode&&r.computeWorldMatrix(),n._preActivate(),n.isVisible&&n.visibility>0&&0!=(n.layerMask&this.activeCamera.layerMask)&&(this._skipFrustumClipping||n.alwaysSelectAsActiveMesh||n.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(n),this.activeCamera._activeMeshes.push(n),r!==n&&r._activate(this._renderId,!1);for(const e of this._preActiveMeshStage)e.action(n);n._activate(this._renderId,!1)&&(n.isAnInstance?n._internalAbstractMeshDataInfo._actAsRegularMesh&&(r=n):r._internalAbstractMeshDataInfo._onlyForInstances=!1,r._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(n,r)),n._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let e=0;e<this.particleSystems.length;e++){const t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;const n=t.emitter;n.position&&!n.isEnabled()||(this._activeParticleSystems.push(t),t.animate(),this._renderingManager.dispatchParticles(t))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_prepareSkeleton(e){this._skeletonsEnabled&&e.skeleton&&(this._activeSkeletons.pushNoDuplicate(e.skeleton)&&(e.skeleton.prepare(),this._activeBones.addCount(e.skeleton.bones.length,!1)),e.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(e)&&this.frameGraph&&e.applySkeleton(e.skeleton))}_activeMesh(e,t){this._prepareSkeleton(t);let n=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const i=this.getActiveSubMeshCandidates(t),r=i.length;n=n||1===r;for(let s=0;s<r;s++){const r=i.data[s];this._evaluateSubMesh(r,t,e,n)}}}updateTransformMatrix(e){const t=this.activeCamera;if(t)if(t._renderingMultiview){const n=t._rigCameras[0],i=t._rigCameras[1];this.setTransformMatrix(n.getViewMatrix(),n.getProjectionMatrix(e),i.getViewMatrix(),i.getProjectionMatrix(e))}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){this._useCurrentFrameBuffer||(e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer()),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(e&&e._multiviewTexture);else if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||e.isRightCamera||(this.autoClear&&this._engine.clear(t.clearColor||this._clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,n=!0){var r,s,a;if(e&&e._skipRendering)return;const o=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(o.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&n){let t=!0;e._renderingMultiview&&e.outputRenderTarget&&(t=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=t)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let e=0;e<this._softwareSkinnedMeshes.length;e++){const t=this._softwareSkinnedMeshes.data[e];t.applySkeleton(t.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const e of this._gatherActiveCameraRenderTargetsStage)e.action(this._renderTargets);let l=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){i.b.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let e=0;e<this._renderTargets.length;e++){const t=this._renderTargets.data[e];if(t._shouldRender()){this._renderId++;const e=t.activeCamera&&t.activeCamera!==this.activeCamera;t.render(e,this.dumpNextRenderTargets),l=!0}}i.b.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const e of this._cameraDrawRenderTargetStage)l=e.action(this.activeCamera)||l;this._intermediateRendering=!1}this._engine.currentRenderPassId=null!==(r=null!==(s=null===(a=e.outputRenderTarget)||void 0===a?void 0:a.renderPassId)&&void 0!==s?s:e.renderPassId)&&void 0!==r?r:0,l&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,!1),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),!this.postProcessManager||e._multiviewTexture||this.prePass||this.postProcessManager._prepareFrame();for(const e of this._beforeCameraDrawStage)e.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),o.snapshotRendering&&1===o.snapshotRenderingMode&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const e of this._afterCameraDrawStage)e.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const t=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,t)}for(const e of this._afterCameraPostProcessStage)e.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(0===e.cameraRigMode||e._renderingMultiview)return e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),void this.onAfterRenderCameraObservable.notifyObservers(e);if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let t=0;t<e._rigCameras.length;t++)this._renderForCamera(e._rigCameras[t],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let e=0;t.actionManager&&e<t.actionManager.actions.length;e++){const n=t.actionManager.actions[e];if(12===n.trigger||13===n.trigger){const e=n.getTriggerParameter(),i=e.mesh?e.mesh:e,r=i.intersectsMesh(t,e.usePreciseIntersection),s=t._intersectionsInProgress.indexOf(i);r&&-1===s?12===n.trigger?(n._executeCurrent(f.CreateNew(t,void 0,i)),t._intersectionsInProgress.push(i)):13===n.trigger&&t._intersectionsInProgress.push(i):!r&&s>-1&&(13===n.trigger&&n._executeCurrent(f.CreateNew(t,void 0,i)),t.actionManager.hasSpecificTrigger(13,e=>{const t=e.mesh?e.mesh:e;return i===t})&&13!==n.trigger||t._intersectionsInProgress.splice(s,1))}}}}_advancePhysicsEngineStep(e){}_animate(e){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max($.MinDeltaTime,Math.min(this._engine.getDeltaTime(),$.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),n=1e3/t/1e3;let i=0;const r=this._engine.getLockstepMaxSteps();let s=Math.floor(e/t);for(s=Math.min(s,r);e>0&&i<s;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*n,this._animate(t),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,i++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max($.MinDeltaTime,Math.min(this._engine.getDeltaTime(),$.MaxDeltaTime));this._animationRatio=.06*e,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this._clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var t;if(null==e||!e.outputRenderTarget||null!=e&&e.isRigCamera||(e.outputRenderTarget._cleared=!1),null!=e&&null!==(t=e.rigCameras)&&void 0!==t&&t.length)for(let t=0;t<e.rigCameras.length;++t){const n=e.rigCameras[t].outputRenderTarget;n&&(n._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}_renderWithFrameGraph(e=!0,t=!1){var n;if(this.activeCamera=null,this._activeParticleSystems.reset(),this._activeSkeletons.reset(),e)for(const e of this.cameras)if(e.update(),0!==e.cameraRigMode)for(let t=0;t<e._rigCameras.length;t++)e._rigCameras[t].update();for(const e of this._beforeClearStage)e.action();const i=this.getActiveMeshCandidates(),r=i.length;for(let e=0;e<r;e++){const t=i.data[e];t.isBlocked||(this._totalVertices.addCount(t.getTotalVertices(),!1),t.isReady()&&t.isEnabled()&&!t.scaling.hasAZeroComponent&&(t.computeWorldMatrix(),t.actionManager&&t.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(t)))}if(this.particlesEnabled)for(let e=0;e<this.particleSystems.length;e++){const t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;const n=t.emitter;n.position&&!n.isEnabled()||(this._activeParticleSystems.push(t),t.animate())}null===(n=this.frameGraph)||void 0===n||n.execute()}render(e=!0,t=!1){var n;if(!this.isDisposed){this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),null!==(n=this.activeCameras)&&void 0!==n&&n.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const e of this._beforeCameraUpdateStage)e.action();if(e)if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];if(t.update(),0!==t.cameraRigMode)for(let e=0;e<t._rigCameras.length;e++)t._rigCameras[e].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(let e=0;e<this.activeCamera._rigCameras.length;e++)this.activeCamera._rigCameras[e].update();if(this.onBeforeRenderObservable.notifyObservers(this),this.customRenderFunction)this._renderId++,this._engine.currentRenderPassId=0,this.customRenderFunction(e,t);else{var r,s;const e=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const t=null!==(r=this.activeCameras)&&void 0!==r&&r.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){i.b.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let n=0;n<this.customRenderTargets.length;n++){const i=this.customRenderTargets[n];if(i._shouldRender()){if(this._renderId++,this.activeCamera=i.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");e.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),i.render(t!==this.activeCamera,this.dumpNextRenderTargets)}}i.b.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=null!==(s=null==t?void 0:t.renderPassId)&&void 0!==s?s:0,this.activeCamera=t,this._activeCamera&&22!==this._activeCamera.cameraRigMode&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const e of this._beforeClearStage)e.action();this._clearFrameBuffer(this.activeCamera);for(const e of this._gatherRenderTargetsStage)e.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++)this._processSubCameras(this.activeCameras[e],e>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}}this._checkIntersections();for(const e of this._afterRenderStage)e.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let e=0;e<this._toBeDisposed.length;e++){const t=this._toBeDisposed[e];t&&t.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this._activeAnimatables&&this.stopAllAnimations&&(this._activeAnimatables.forEach(e=>{e.onAnimationEndObservable.clear(),e.onAnimationEnd=null}),this.stopAllAnimations()),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const t of e)t.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(e){Q.a.Error("An error occurred while calling onDisposeObservable!",e)}if(this.detachControl(),this._engine.getInputElement())for(let e=0;e<this.cameras.length;e++)this.cameras[e].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.meshes,e=>e.dispose(!0)),this._disposeList(this.transformNodes,e=>e.dispose(!0));const t=this.cameras;this._disposeList(t),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let n=this._engine.scenes.indexOf(this);if(n>-1&&this._engine.scenes.splice(n,1),v.a._LastCreatedScene===this){v.a._LastCreatedScene=null;let e=v.a.Instances.length-1;for(;e>=0;){const t=v.a.Instances[e];if(t.scenes.length>0){v.a._LastCreatedScene=t.scenes[this._engine.scenes.length-1];break}e--}}n=this._engine._virtualScenes.indexOf(this),n>-1&&this._engine._virtualScenes.splice(n,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this.onClearColorChangedObservable.clear(),this.onEnvironmentTextureChangedObservable.clear(),this.onMeshUnderPointerUpdatedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){var n;const i=e.slice(0);t=null!==(n=t)&&void 0!==n?n:e=>e.dispose();for(const e of i)t(e);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e].geometry;t&&t.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new c.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new c.e(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach(e=>{if(e.computeWorldMatrix(!0),!e.subMeshes||0===e.subMeshes.length||e.infiniteDistance)return;const i=e.getBoundingInfo(),r=i.boundingBox.minimumWorld,s=i.boundingBox.maximumWorld;c.e.CheckExtends(r,t,n),c.e.CheckExtends(s,t,n)}),{min:t,max:n}}createPickingRay(e,t,n,i,r=!1){throw Object(E.a)("Ray")}createPickingRayToRef(e,t,n,i,r,s=!1,a=!1){throw Object(E.a)("Ray")}createPickingRayInCameraSpace(e,t,n){throw Object(E.a)("Ray")}createPickingRayInCameraSpaceToRef(e,t,n,i){throw Object(E.a)("Ray")}pick(e,t,n,i,r,s){const a=Object(E.a)("Ray",!0);return a&&Q.a.Warn(a),new u.a}pickWithBoundingInfo(e,t,n,i,r){const s=Object(E.a)("Ray",!0);return s&&Q.a.Warn(s),new u.a}pickWithRay(e,t,n,i){throw Object(E.a)("Ray")}multiPick(e,t,n,i,r){throw Object(E.a)("Ray")}multiPickWithRay(e,t,n){throw Object(E.a)("Ray")}setPointerOverMesh(e,t,n){this._inputManager.setPointerOverMesh(e,t,n)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild(!0);this.markAllMaterialsAsDirty(1)}_getByTags(e,t,n){if(void 0===t)return e;const i=[];for(const r in e){const s=e[r];l.a&&l.a.MatchesQuery(s,t)&&(!n||n(s))&&i.push(s)}return i}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,n=null,i=null){this._renderingManager.setRenderingOrder(e,t,n,i)}setRenderingAutoClearDepthStencil(e,t,n=!0,i=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,n,i)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const n of this.materials)t&&!t(n)||n.markAsDirty(e)}_loadFile(e,t,n,i,r,s,a){const o=Object(j.d)(e,t,n,i?this.offlineProvider:void 0,r,s,a);return this._activeRequests.push(o),o.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),o}_loadFileAsync(e,t,n,i,r){return new Promise((s,a)=>{this._loadFile(e,e=>{s(e)},t,n,i,(e,t)=>{a(t)},r)})}_requestFile(e,t,n,i,r,s,a){const o=Object(j.h)(e,t,n,i?this.offlineProvider:void 0,r,s,a);return this._activeRequests.push(o),o.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),o}_requestFileAsync(e,t,n,i,r){return new Promise((s,a)=>{this._requestFile(e,e=>{s(e)},t,n,i,e=>{a(e)},r)})}_readFile(e,t,n,i,r){const s=Object(j.g)(e,t,n,i,r);return this._activeRequests.push(s),s.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),s}_readFileAsync(e,t,n){return new Promise((i,r)=>{this._readFile(e,e=>{i(e)},t,n,e=>{r(e)})})}getPerfCollector(){throw Object(E.a)("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}constructor(e,t){this._inputManager=new V(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this._clearColor=new H.b(.2,.2,.3,1),this.onClearColorChangedObservable=new s.a,this.ambientColor=new H.a(0,0,0),this.environmentIntensity=1,this._performancePriority=0,this.onScenePerformancePriorityChangedObservable=new s.a,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.effectLayers=[],this.sounds=null,this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new s.a,this._onDisposeObserver=null,this.onBeforeRenderObservable=new s.a,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new s.a,this.onAfterRenderCameraObservable=new s.a,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new s.a,this.onAfterAnimationsObservable=new s.a,this.onBeforeDrawPhaseObservable=new s.a,this.onAfterDrawPhaseObservable=new s.a,this.onReadyObservable=new s.a,this.onBeforeCameraRenderObservable=new s.a,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new s.a,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new s.a,this.onAfterActiveMeshesEvaluationObservable=new s.a,this.onBeforeParticlesRenderingObservable=new s.a,this.onAfterParticlesRenderingObservable=new s.a,this.onDataLoadedObservable=new s.a,this.onNewCameraAddedObservable=new s.a,this.onCameraRemovedObservable=new s.a,this.onNewLightAddedObservable=new s.a,this.onLightRemovedObservable=new s.a,this.onNewGeometryAddedObservable=new s.a,this.onGeometryRemovedObservable=new s.a,this.onNewTransformNodeAddedObservable=new s.a,this.onTransformNodeRemovedObservable=new s.a,this.onNewMeshAddedObservable=new s.a,this.onMeshRemovedObservable=new s.a,this.onNewSkeletonAddedObservable=new s.a,this.onSkeletonRemovedObservable=new s.a,this.onNewMaterialAddedObservable=new s.a,this.onNewMultiMaterialAddedObservable=new s.a,this.onMaterialRemovedObservable=new s.a,this.onMultiMaterialRemovedObservable=new s.a,this.onNewTextureAddedObservable=new s.a,this.onTextureRemovedObservable=new s.a,this.onBeforeRenderTargetsRenderObservable=new s.a,this.onAfterRenderTargetsRenderObservable=new s.a,this.onBeforeStepObservable=new s.a,this.onAfterStepObservable=new s.a,this.onActiveCameraChanged=new s.a,this.onActiveCamerasChanged=new s.a,this.onBeforeRenderingGroupObservable=new s.a,this.onAfterRenderingGroupObservable=new s.a,this.onMeshImportedObservable=new s.a,this.onAnimationFileImportedObservable=new s.a,this.onEnvironmentTextureChangedObservable=new s.a,this.onMeshUnderPointerUpdatedObservable=new s.a,this._registeredForLateAnimationBindings=new a.b(256),this._pointerPickingConfiguration=new Y,this.onPrePointerObservable=new s.a,this.onPointerObservable=new s.a,this.onPreKeyboardObservable=new s.a,this.onKeyboardObservable=new s.a,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=$.FOGMODE_NONE,this.fogColor=new H.a(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this._frameGraph=null,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new c.e(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new a.b(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new G.a,this._activeIndices=new G.a,this._activeParticles=new G.a,this._activeBones=new G.a,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new a.a(256),this._processedMaterials=new a.a(256),this._renderTargets=new a.b(256),this._materialsRenderTargets=new a.b(256),this._activeParticleSystems=new a.a(256),this._activeSkeletons=new a.b(32),this._softwareSkinnedMeshes=new a.b(32),this._activeAnimatables=new Array,this._transformMatrix=c.a.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=g.b.Create(),this._beforeClearStage=g.b.Create(),this._beforeRenderTargetClearStage=g.b.Create(),this._gatherRenderTargetsStage=g.b.Create(),this._gatherActiveCameraRenderTargetsStage=g.b.Create(),this._isReadyForMeshStage=g.b.Create(),this._beforeEvaluateActiveMeshStage=g.b.Create(),this._evaluateSubMeshStage=g.b.Create(),this._preActiveMeshStage=g.b.Create(),this._cameraDrawRenderTargetStage=g.b.Create(),this._beforeCameraDrawStage=g.b.Create(),this._beforeRenderTargetDrawStage=g.b.Create(),this._beforeRenderingGroupDrawStage=g.b.Create(),this._beforeRenderingMeshStage=g.b.Create(),this._afterRenderingMeshStage=g.b.Create(),this._afterRenderingGroupDrawStage=g.b.Create(),this._afterCameraDrawStage=g.b.Create(),this._afterCameraPostProcessStage=g.b.Create(),this._afterRenderTargetDrawStage=g.b.Create(),this._afterRenderTargetPostProcessStage=g.b.Create(),this._afterRenderStage=g.b.Create(),this._pointerMoveStage=g.b.Create(),this._pointerDownStage=g.b.Create(),this._pointerUpStage=g.b.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._useCurrentFrameBuffer=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[];const n={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...t};e=this._engine=e||v.a.LastCreatedEngine,n.virtual?e._virtualScenes.push(this):(v.a._LastCreatedScene=this,e.scenes.push(this)),this._uid=null,this._renderingManager=new p.a(this),m.a&&(this.postProcessManager=new m.a(this)),Object(_.d)()&&this.attachControl(),this._createUbo(),d.a&&(this._imageProcessingConfiguration=new d.a),this.setDefaultCandidateProviders(),n.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=n.useMaterialMeshMap,this.useClonedMeshMap=n.useClonedMeshMap,t&&t.virtual||e.onNewSceneAddedObservable.notifyObservers(this)}}$.FOGMODE_NONE=0,$.FOGMODE_EXP=1,$.FOGMODE_EXP2=2,$.FOGMODE_LINEAR=3,$.MinDeltaTime=1,$.MaxDeltaTime=1e3,Object(Z.b)("BABYLON.Scene",$)},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return r}));class i{push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return-1!==this.indexOf(e)}constructor(e){this.length=0,this.data=new Array(e),this._id=i._GlobalId++}}i._GlobalId=0;class r extends i{push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return!(e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId||(this.push(e),0))}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++){const n=(e.data||e)[t];this.pushNoDuplicate(n)}}}constructor(){super(...arguments),this._duplicateId=0}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var i=n(309),r=n(319),s=n(43),a=n(84),o=n(76),l=n(310),c=n(313),d=n(108),h=n(100),u=n(140),f=n(336);h.a.prototype.setTextureFromPostProcess=function(e,t,n){var i,r;let s=null;t&&(t._forcedOutputTexture?s=t._forcedOutputTexture:t._textures.data[t._currentRenderTextureInd]&&(s=t._textures.data[t._currentRenderTextureInd])),this._bindTexture(e,null!==(i=null===(r=s)||void 0===r?void 0:r.texture)&&void 0!==i?i:null,n)},h.a.prototype.setTextureFromPostProcessOutput=function(e,t,n){var i,r;this._bindTexture(e,null!==(i=null==t||null===(r=t._outputTexture)||void 0===r?void 0:r.texture)&&void 0!==i?i:null,n)},o.a.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)},o.a.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)};class m{static get ForceGLSL(){return f.b.ForceGLSL}static set ForceGLSL(e){f.b.ForceGLSL=e}static RegisterShaderCodeProcessing(e,t){f.b.RegisterShaderCodeProcessing(e,t)}get name(){return this._effectWrapper.name}set name(e){this._effectWrapper.name=e}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(e){this._effectWrapper.alphaMode=e}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(e=>{e.setSamples(this._samples)})}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}_gatherImports(e=!1,t){e&&this._webGPUReady?t.push(Promise.all([n.e(0).then(n.bind(null,406))])):t.push(Promise.all([Promise.resolve().then(n.bind(null,375))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){0==this._textures.length&&(this._textures=new r.a(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,n=null,i,r,s,a,o){this._effectWrapper.updateEffect(e,t,n,i,r,s,a,o),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,n=0){for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture.width===e.width&&this._textureCache[i].texture.height===e.height&&this._textureCache[i].postProcessChannel===n&&this._textureCache[i].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[i].texture.samples===t.samples)return this._textureCache[i].texture;const i=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:i,postProcessChannel:n,lastUsedRenderId:-1}),i}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let e=!1;for(let n=0;n<this._textures.length;n++)if(this._textures.data[n]===this._textureCache[t].texture){e=!0;break}e||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,n=null,i=!1,r=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let s=null;if(n)for(let e=0;e<n._postProcesses.length;e++)if(null!==n._postProcesses[e]){s=n._postProcesses[e];break}const a={width:this.width,height:this.height},o={generateMipMaps:i,generateDepthBuffer:r||s===this,generateStencilBuffer:(r||s===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(a,o,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(a,o,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let t;e=this.inputTexture;for(let n=0;n<this._textureCache.length;n++)if(this._textureCache[n].texture===e){t=this._textureCache[n];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,n){var i,r,s;const a=null===e||void 0!==e.cameraRigMode?e||this._camera:null,o=null!==(i=null==a?void 0:a.getScene())&&void 0!==i?i:e,l=o.getEngine(),c=l.getCaps().maxTextureSize,d=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,h=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0;let f=this._options.width||d,m=this._options.height||h;const p=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let g=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const e=l.currentViewport;e&&(f*=e.width,m*=e.height)}(p||this.alwaysForcePOT)&&(this._options.width||(f=l.needPOTTextures?Object(u.b)(f,c,this.scaleMode):f),this._options.height||(m=l.needPOTTextures?Object(u.b)(m,c,this.scaleMode):m)),this.width===f&&this.height===m&&(g=this._getTarget())||this.resize(f,m,a,p,n),this._textures.forEach(e=>{e.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(e,this.samples)}),this._flushTextureCache(),this._renderId++}return g||(g=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(d/f,h/m),this._engine.bindFramebuffer(g,0,d,h,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(g,0,void 0,void 0,this.forceFullscreenViewport)),null===(r=(s=this._engine)._debugInsertMarker)||void 0===r||r.call(s,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(a),this.autoClear&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:o.clearColor,o._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),g}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;let e;var t;return this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),e=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",null===(t=e)||void 0===t?void 0:t.texture),this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(),this._effectWrapper.drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(e){let t;if(e=e||this._camera,this._disposeTextures(),this._scene&&(t=this._scene.postProcesses.indexOf(this),-1!==t&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const e=this._parentContainer.postProcesses.indexOf(this);e>-1&&this._parentContainer.postProcesses.splice(e,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),-1!==t&&this._engine.postProcesses.splice(t,1),e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),0===t&&e._postProcesses.length>0){const e=this._camera._getFirstPostProcess();e&&e.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const e=c.a.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.uniformBuffers=this._uniformBuffers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=m.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,n){const i=Object(d.a)(e.customType);if(!i||!i._Parse)return null;const r=t?t.getCameraById(e.cameraId):null;return i._Parse(e,r,t,n)}static _Parse(e,t,n,i){return c.a.Parse(()=>new m(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,n,i)}constructor(e,t,n,i,o,l,c=1,d,h,u=null,p=0,g="postprocess",_,v=!1,E=5,T,S){var A,b;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new r.a(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new a.d(1,1),this._texelSize=a.d.Zero(),this.onActivateObservable=new s.a,this.onSizeChangedObservable=new s.a,this.onApplyObservable=new s.a,this.onBeforeRenderObservable=new s.a,this.onAfterRenderObservable=new s.a;let I,R=1,C=null;if(n&&!Array.isArray(n)){var y,M,O,x,D,P,L,N,F,w,U,B;const e=n;n=null!==(y=e.uniforms)&&void 0!==y?y:null,i=null!==(M=e.samplers)&&void 0!==M?M:null,R=null!==(O=e.size)&&void 0!==O?O:1,l=null!==(x=e.camera)&&void 0!==x?x:null,c=null!==(D=e.samplingMode)&&void 0!==D?D:1,d=e.engine,h=e.reusable,u=Array.isArray(e.defines)?e.defines.join("\n"):null!==(P=e.defines)&&void 0!==P?P:null,p=null!==(L=e.textureType)&&void 0!==L?L:0,g=null!==(N=e.vertexUrl)&&void 0!==N?N:"postprocess",_=e.indexParameters,v=null!==(F=e.blockCompilation)&&void 0!==F&&F,E=null!==(w=e.textureFormat)&&void 0!==w?w:5,T=null!==(U=e.shaderLanguage)&&void 0!==U?U:0,C=null!==(B=e.uniformBuffers)&&void 0!==B?B:null,S=e.extraInitializations,I=e.effectWrapper}else o&&(R="number"==typeof o?o:{width:o.width,height:o.height});const k=!!I;if(this._effectWrapper=null!==(A=I)&&void 0!==A?A:new f.b({name:e,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:t,engine:d||(null===(b=l)||void 0===b?void 0:b.getScene().getEngine()),uniforms:n,samplers:i,uniformBuffers:C,defines:u,vertexUrl:g,indexParameters:_,blockCompilation:!0,shaderLanguage:T,extraInitializations:void 0}),this.name=e,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=l?(this._camera=l,this._scene=l.getScene(),l.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):d&&(this._engine=d,this._engine.postProcesses.push(this)),this._options=R,this.renderTargetSamplingMode=c||1,this._reusable=h||!1,this._textureType=p,this._textureFormat=E,this._shaderLanguage=T||0,this._samplers=i||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=g,this._parameters=n||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=C||[],this._indexParameters=_,!k){this._webGPUReady=1===this._shaderLanguage;const e=[];this._gatherImports(this._engine.isWebGPU&&!m.ForceGLSL,e),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(v,u,S,e)}}}Object(i.a)([Object(l.c)()],m.prototype,"uniqueId",void 0),Object(i.a)([Object(l.c)()],m.prototype,"name",null),Object(i.a)([Object(l.c)()],m.prototype,"width",void 0),Object(i.a)([Object(l.c)()],m.prototype,"height",void 0),Object(i.a)([Object(l.c)()],m.prototype,"renderTargetSamplingMode",void 0),Object(i.a)([Object(l.e)()],m.prototype,"clearColor",void 0),Object(i.a)([Object(l.c)()],m.prototype,"autoClear",void 0),Object(i.a)([Object(l.c)()],m.prototype,"forceAutoClearInAlphaMode",void 0),Object(i.a)([Object(l.c)()],m.prototype,"alphaMode",null),Object(i.a)([Object(l.c)()],m.prototype,"alphaConstants",void 0),Object(i.a)([Object(l.c)()],m.prototype,"enablePixelPerfectMode",void 0),Object(i.a)([Object(l.c)()],m.prototype,"forceFullscreenViewport",void 0),Object(i.a)([Object(l.c)()],m.prototype,"scaleMode",void 0),Object(i.a)([Object(l.c)()],m.prototype,"alwaysForcePOT",void 0),Object(i.a)([Object(l.c)("samples")],m.prototype,"_samples",void 0),Object(i.a)([Object(l.c)()],m.prototype,"adaptScaleToCurrentViewport",void 0),Object(d.b)("BABYLON.PostProcess",m)},function(e,t,n){"use strict";n.d(t,"d",(function(){return u})),n.d(t,"g",(function(){return f})),n.d(t,"f",(function(){return m})),n.d(t,"e",(function(){return p})),n.d(t,"b",(function(){return g})),n.d(t,"c",(function(){return _})),n.d(t,"a",(function(){return E}));var i=n(84),r=n(311),s=n(26),a=n(108),o=n(404),l=n(316),c=n(334),d=n(329),h=n(313);const u=Object.freeze(new i.b(0,0,0,0)),f=Object.freeze(i.e.Zero()),m=Object.freeze(i.d.Zero()),p=Object.freeze(c.a.Zero()),g=Object.freeze(r.a.Black()),_=Object.freeze(new r.b(0,0,0,0)),v={key:0,repeatCount:0,loopMode:2};class E{static _PrepareAnimation(e,t,n,s,a,o,l,d){let h=void 0;if(!isNaN(parseFloat(a))&&isFinite(a)?h=E.ANIMATIONTYPE_FLOAT:a instanceof i.b?h=E.ANIMATIONTYPE_QUATERNION:a instanceof i.e?h=E.ANIMATIONTYPE_VECTOR3:a instanceof i.d?h=E.ANIMATIONTYPE_VECTOR2:a instanceof r.a?h=E.ANIMATIONTYPE_COLOR3:a instanceof r.b?h=E.ANIMATIONTYPE_COLOR4:a instanceof c.a&&(h=E.ANIMATIONTYPE_SIZE),null==h)return null;const u=new E(e,t,n,h,l),f=[{frame:0,value:a},{frame:s,value:o}];return u.setKeys(f),void 0!==d&&u.setEasingFunction(d),u}static CreateAnimation(e,t,n,i){const r=new E(e+"Animation",e,n,t,E.ANIMATIONLOOPMODE_CONSTANT);return r.setEasingFunction(i),r}static CreateAndStartAnimation(e,t,n,i,r,s,a,o,l,c,d){const h=E._PrepareAnimation(e,n,i,r,s,a,o,l);return h?(t.getScene&&(d=t.getScene()),d?d.beginDirectAnimation(t,[h],0,r,h.loopMode!==E.ANIMATIONLOOPMODE_CONSTANT,1,c):null):null}static CreateAndStartHierarchyAnimation(e,t,n,i,r,s,a,o,l,c,d){const h=E._PrepareAnimation(e,i,r,s,a,o,l,c);return h?t.getScene().beginDirectHierarchyAnimation(t,n,[h],0,s,1===h.loopMode,1,d):null}static CreateMergeAndStartAnimation(e,t,n,i,r,s,a,o,l,c){const d=E._PrepareAnimation(e,n,i,r,s,a,o,l);return d?(t.animations.push(d),t.getScene().beginAnimation(t,0,r,1===d.loopMode,1,c)):null}static MakeAnimationAdditive(e,t,n,r=!1,s){let a;a="object"==typeof t?t:{referenceFrame:null!=t?t:0,range:n,cloneOriginalAnimation:r,clonedAnimationName:s};let o=e;if(a.cloneOriginalAnimation&&(o=e.clone(),o.name=a.clonedAnimationName||o.name),!o._keys.length)return o;const l=a.referenceFrame&&a.referenceFrame>=0?a.referenceFrame:0;let c=0;const d=o._keys[0];let h=o._keys.length-1;const u=o._keys[h],f={referenceValue:d.value,referencePosition:i.c.Vector3[0],referenceQuaternion:i.c.Quaternion[0],referenceScaling:i.c.Vector3[1],keyPosition:i.c.Vector3[2],keyQuaternion:i.c.Quaternion[1],keyScaling:i.c.Vector3[3]};let m=d.frame,p=u.frame;if(a.range){const e=o.getRange(a.range);e&&(m=e.from,p=e.to)}else{var g,_;m=null!==(g=a.fromFrame)&&void 0!==g?g:m,p=null!==(_=a.toFrame)&&void 0!==_?_:p}if(m!==d.frame&&(c=o.createKeyForFrame(m)),p!==u.frame&&(h=o.createKeyForFrame(p)),1===o._keys.length){const e=o._getKeyValue(o._keys[0]);f.referenceValue=e.clone?e.clone():e}else if(l<=d.frame){const e=o._getKeyValue(d.value);f.referenceValue=e.clone?e.clone():e}else if(l>=u.frame){const e=o._getKeyValue(u.value);f.referenceValue=e.clone?e.clone():e}else{v.key=0;const e=o._interpolate(l,v);f.referenceValue=e.clone?e.clone():e}o.dataType===E.ANIMATIONTYPE_QUATERNION?f.referenceValue.normalize().conjugateInPlace():o.dataType===E.ANIMATIONTYPE_MATRIX&&(f.referenceValue.decompose(f.referenceScaling,f.referenceQuaternion,f.referencePosition),f.referenceQuaternion.normalize().conjugateInPlace());let T=Number.MAX_VALUE;const S=a.clipKeys?[]:null;for(let e=c;e<=h;e++){let t=o._keys[e];if((S||a.cloneOriginalAnimation)&&(t={frame:t.frame,value:t.value.clone?t.value.clone():t.value,inTangent:t.inTangent,outTangent:t.outTangent,interpolation:t.interpolation,lockedTangent:t.lockedTangent},S&&(T===Number.MAX_VALUE&&(T=t.frame),t.frame-=T,S.push(t))),!e||o.dataType===E.ANIMATIONTYPE_FLOAT||t.value!==d.value)switch(o.dataType){case E.ANIMATIONTYPE_MATRIX:t.value.decompose(f.keyScaling,f.keyQuaternion,f.keyPosition),f.keyPosition.subtractInPlace(f.referencePosition),f.keyScaling.divideInPlace(f.referenceScaling),f.referenceQuaternion.multiplyToRef(f.keyQuaternion,f.keyQuaternion),i.a.ComposeToRef(f.keyScaling,f.keyQuaternion,f.keyPosition,t.value);break;case E.ANIMATIONTYPE_QUATERNION:f.referenceValue.multiplyToRef(t.value,t.value);break;case E.ANIMATIONTYPE_VECTOR2:case E.ANIMATIONTYPE_VECTOR3:case E.ANIMATIONTYPE_COLOR3:case E.ANIMATIONTYPE_COLOR4:t.value.subtractToRef(f.referenceValue,t.value);break;case E.ANIMATIONTYPE_SIZE:t.value.width-=f.referenceValue.width,t.value.height-=f.referenceValue.height;break;default:t.value-=f.referenceValue}}return S&&o.setKeys(S,!0),o}static TransitionTo(e,t,n,i,r,s,a,o=null){if(a<=0)return n[e]=t,o&&o(),null;const l=r*(a/1e3);s.setKeys([{frame:0,value:n[e].clone?n[e].clone():n[e]},{frame:l,value:t}]),n.animations||(n.animations=[]),n.animations.push(s);const c=i.beginAnimation(n,0,l,!1);return c.onAnimationEnd=o,c}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let e=!0;for(const n in this._ranges)e&&(t+=", ",e=!1),t+=n;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((e,t)=>e.frame-t.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,n){this._ranges[e]||(this._ranges[e]=new o.a(e,t,n))}deleteRange(e,t=!0){const n=this._ranges[e];if(n){if(t){const e=n.from,t=n.to;for(let n=this._keys.length-1;n>=0;n--)this._keys[n].frame>=e&&this._keys[n].frame<=t&&this._keys.splice(n,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,n=this._keys.length;t<n;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,n){return Object(s.d)(e,t,n)}floatInterpolateFunctionWithTangents(e,t,n,i,r){return Object(s.b)(e,t,n,i,r)}quaternionInterpolateFunction(e,t,n){return i.b.Slerp(e,t,n)}quaternionInterpolateFunctionWithTangents(e,t,n,r,s){return i.b.Hermite(e,t,n,r,s).normalize()}vector3InterpolateFunction(e,t,n){return i.e.Lerp(e,t,n)}vector3InterpolateFunctionWithTangents(e,t,n,r,s){return i.e.Hermite(e,t,n,r,s)}vector2InterpolateFunction(e,t,n){return i.d.Lerp(e,t,n)}vector2InterpolateFunctionWithTangents(e,t,n,r,s){return i.d.Hermite(e,t,n,r,s)}sizeInterpolateFunction(e,t,n){return c.a.Lerp(e,t,n)}color3InterpolateFunction(e,t,n){return r.a.Lerp(e,t,n)}color3InterpolateFunctionWithTangents(e,t,n,i,s){return r.a.Hermite(e,t,n,i,s)}color4InterpolateFunction(e,t,n){return r.b.Lerp(e,t,n)}color4InterpolateFunctionWithTangents(e,t,n,i,s){return r.b.Hermite(e,t,n,i,s)}_getKeyValue(e){return"function"==typeof e?e():e}evaluate(e){return v.key=0,this._interpolate(e,v)}_interpolate(e,t,n=!1){var i;if(t.loopMode===E.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const r=this._keys,s=r.length;let a=t.key;for(;a>=0&&e<r[a].frame;)--a;for(;a+1<=s-1&&e>=r[a+1].frame;)++a;if(t.key=a,a<0)return n?void 0:this._getKeyValue(r[0].value);if(a+1>s-1)return n?void 0:this._getKeyValue(r[s-1].value);const o=r[a],l=r[a+1];if(n&&(e===o.frame||e===l.frame))return;const c=this._getKeyValue(o.value),d=this._getKeyValue(l.value);if(1===o.interpolation)return l.frame>e?c:d;const h=void 0!==o.outTangent&&void 0!==l.inTangent,v=l.frame-o.frame;let T=(e-o.frame)/v;const S=o.easingFunction||this.getEasingFunction();switch(null!==S&&(T=S.ease(T)),this.dataType){case E.ANIMATIONTYPE_FLOAT:{const e=h?this.floatInterpolateFunctionWithTangents(c,o.outTangent*v,d,l.inTangent*v,T):this.floatInterpolateFunction(c,d,T);switch(t.loopMode){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:case E.ANIMATIONLOOPMODE_YOYO:return e;case E.ANIMATIONLOOPMODE_RELATIVE:case E.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(null!==(i=t.offsetValue)&&void 0!==i?i:0)*t.repeatCount+e}break}case E.ANIMATIONTYPE_QUATERNION:{const e=h?this.quaternionInterpolateFunctionWithTangents(c,o.outTangent.scale(v),d,l.inTangent.scale(v),T):this.quaternionInterpolateFunction(c,d,T);switch(t.loopMode){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:case E.ANIMATIONLOOPMODE_YOYO:return e;case E.ANIMATIONLOOPMODE_RELATIVE:case E.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||u).scale(t.repeatCount))}return e}case E.ANIMATIONTYPE_VECTOR3:{const e=h?this.vector3InterpolateFunctionWithTangents(c,o.outTangent.scale(v),d,l.inTangent.scale(v),T):this.vector3InterpolateFunction(c,d,T);switch(t.loopMode){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:case E.ANIMATIONLOOPMODE_YOYO:return e;case E.ANIMATIONLOOPMODE_RELATIVE:case E.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||f).scale(t.repeatCount))}break}case E.ANIMATIONTYPE_VECTOR2:{const e=h?this.vector2InterpolateFunctionWithTangents(c,o.outTangent.scale(v),d,l.inTangent.scale(v),T):this.vector2InterpolateFunction(c,d,T);switch(t.loopMode){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:case E.ANIMATIONLOOPMODE_YOYO:return e;case E.ANIMATIONLOOPMODE_RELATIVE:case E.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||m).scale(t.repeatCount))}break}case E.ANIMATIONTYPE_SIZE:switch(t.loopMode){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:case E.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(c,d,T);case E.ANIMATIONLOOPMODE_RELATIVE:case E.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(c,d,T).add((t.offsetValue||p).scale(t.repeatCount))}break;case E.ANIMATIONTYPE_COLOR3:{const e=h?this.color3InterpolateFunctionWithTangents(c,o.outTangent.scale(v),d,l.inTangent.scale(v),T):this.color3InterpolateFunction(c,d,T);switch(t.loopMode){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:case E.ANIMATIONLOOPMODE_YOYO:return e;case E.ANIMATIONLOOPMODE_RELATIVE:case E.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||g).scale(t.repeatCount))}break}case E.ANIMATIONTYPE_COLOR4:{const e=h?this.color4InterpolateFunctionWithTangents(c,o.outTangent.scale(v),d,l.inTangent.scale(v),T):this.color4InterpolateFunction(c,d,T);switch(t.loopMode){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:case E.ANIMATIONLOOPMODE_YOYO:return e;case E.ANIMATIONLOOPMODE_RELATIVE:case E.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||_).scale(t.repeatCount))}break}case E.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case E.ANIMATIONLOOPMODE_CYCLE:case E.ANIMATIONLOOPMODE_CONSTANT:case E.ANIMATIONLOOPMODE_YOYO:return E.AllowMatricesInterpolation?this.matrixInterpolateFunction(c,d,T,t.workValue):c;case E.ANIMATIONLOOPMODE_RELATIVE:case E.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return c}}return 0}matrixInterpolateFunction(e,t,n,r){return E.AllowMatrixDecomposeForInterpolation?r?(i.a.DecomposeLerpToRef(e,t,n,r),r):i.a.DecomposeLerp(e,t,n):r?(i.a.LerpToRef(e,t,n,r),r):i.a.Lerp(e,t,n)}clone(){const e=new E(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const n=this._ranges[t];n&&(e._ranges[t]=n.clone())}}return e}setKeys(e,t=!1){this._keys=t?e:e.slice(0)}createKeyForFrame(e){v.key=0;const t=this._interpolate(e,v,!0);if(!t)return this._keys[v.key].frame===e?v.key:v.key+1;const n={frame:e,value:t.clone?t.clone():t};return this._keys.splice(v.key+1,0,n),v.key+1}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const n=this.getKeys();for(let i=0;i<n.length;i++){const r=n[i],s={};switch(s.frame=r.frame,t){case E.ANIMATIONTYPE_FLOAT:s.values=[r.value],void 0!==r.inTangent&&s.values.push(r.inTangent),void 0!==r.outTangent&&(void 0===r.inTangent&&s.values.push(void 0),s.values.push(r.outTangent)),void 0!==r.interpolation&&(void 0===r.inTangent&&s.values.push(void 0),void 0===r.outTangent&&s.values.push(void 0),s.values.push(r.interpolation));break;case E.ANIMATIONTYPE_QUATERNION:case E.ANIMATIONTYPE_MATRIX:case E.ANIMATIONTYPE_VECTOR3:case E.ANIMATIONTYPE_COLOR3:case E.ANIMATIONTYPE_COLOR4:s.values=r.value.asArray(),null!=r.inTangent&&s.values.push(r.inTangent.asArray()),null!=r.outTangent&&(void 0===r.inTangent&&s.values.push(void 0),s.values.push(r.outTangent.asArray())),void 0!==r.interpolation&&(void 0===r.inTangent&&s.values.push(void 0),void 0===r.outTangent&&s.values.push(void 0),s.values.push(r.interpolation))}e.keys.push(s)}e.ranges=[];for(const t in this._ranges){const n=this._ranges[t];if(!n)continue;const i={};i.name=t,i.from=n.from,i.to=n.to,e.ranges.push(i)}return e}static _UniversalLerp(e,t,n){const i=e.constructor;return i.Lerp?i.Lerp(e,t,n):i.Slerp?i.Slerp(e,t,n):e.toFixed?e*(1-n)+n*t:t}static Parse(e){const t=new E(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),n=e.dataType,s=[];let a,o;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),o=0;o<e.keys.length;o++){const t=e.keys[o];let l=void 0,c=void 0,d=void 0;switch(n){case E.ANIMATIONTYPE_FLOAT:a=t.values[0],t.values.length>=2&&(l=t.values[1]),t.values.length>=3&&(c=t.values[2]),t.values.length>=4&&(d=t.values[3]);break;case E.ANIMATIONTYPE_QUATERNION:if(a=i.b.FromArray(t.values),t.values.length>=8){const e=i.b.FromArray(t.values.slice(4,8));e.equals(i.b.Zero())||(l=e)}if(t.values.length>=12){const e=i.b.FromArray(t.values.slice(8,12));e.equals(i.b.Zero())||(c=e)}t.values.length>=13&&(d=t.values[12]);break;case E.ANIMATIONTYPE_MATRIX:a=i.a.FromArray(t.values),t.values.length>=17&&(d=t.values[16]);break;case E.ANIMATIONTYPE_COLOR3:a=r.a.FromArray(t.values),t.values[3]&&(l=r.a.FromArray(t.values[3])),t.values[4]&&(c=r.a.FromArray(t.values[4])),t.values[5]&&(d=t.values[5]);break;case E.ANIMATIONTYPE_COLOR4:a=r.b.FromArray(t.values),t.values[4]&&(l=r.b.FromArray(t.values[4])),t.values[5]&&(c=r.b.FromArray(t.values[5])),t.values[6]&&(d=r.b.FromArray(t.values[6]));break;case E.ANIMATIONTYPE_VECTOR3:default:a=i.e.FromArray(t.values),t.values[3]&&(l=i.e.FromArray(t.values[3])),t.values[4]&&(c=i.e.FromArray(t.values[4])),t.values[5]&&(d=t.values[5])}const h={};h.frame=t.frame,h.value=a,null!=l&&(h.inTangent=l),null!=c&&(h.outTangent=c),null!=d&&(h.interpolation=d),s.push(h)}if(t.setKeys(s),e.ranges)for(o=0;o<e.ranges.length;o++)a=e.ranges[o],t.createRange(a.name,a.from,a.to);return t}static AppendSerializedAnimations(e,t){h.a.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((n,i)=>{const r=new d.a;r.addEventListener("readystatechange",()=>{if(4==r.readyState)if(200==r.status){let t=JSON.parse(r.responseText);if(t.animations&&(t=t.animations),t.length){const e=[];for(const n of t)e.push(this.Parse(n));n(e)}else{const i=this.Parse(t);e&&(i.name=e),n(i)}}else i("Unable to load the animation")}),r.open("GET",t),r.send()})}static ParseFromSnippetAsync(e){return new Promise((t,n)=>{const i=new d.a;i.addEventListener("readystatechange",()=>{if(4==i.readyState)if(200==i.status){const n=JSON.parse(JSON.parse(i.responseText).jsonPayload);if(n.animations){const i=JSON.parse(n.animations),r=[];for(const t of i.animations){const n=this.Parse(t);n.snippetId=e,r.push(n)}t(r)}else{const i=JSON.parse(n.animation),r=this.Parse(i);r.snippetId=e,t(r)}}else n("Unable to load the snippet "+e)}),i.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),i.send()})}constructor(e,t,n,i,r,s){this.name=e,this.targetProperty=t,this.framePerSecond=n,this.dataType=i,this.loopMode=r,this.enableBlending=s,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=i,this.loopMode=void 0===r?E.ANIMATIONLOOPMODE_CYCLE:r,this.uniqueId=E._UniqueIdGenerator++}}E._UniqueIdGenerator=0,E.AllowMatricesInterpolation=!1,E.AllowMatrixDecomposeForInterpolation=!0,E.SnippetUrl="https://snippet.babylonjs.com",E.ANIMATIONTYPE_FLOAT=0,E.ANIMATIONTYPE_VECTOR3=1,E.ANIMATIONTYPE_QUATERNION=2,E.ANIMATIONTYPE_MATRIX=3,E.ANIMATIONTYPE_COLOR3=4,E.ANIMATIONTYPE_COLOR4=7,E.ANIMATIONTYPE_VECTOR2=5,E.ANIMATIONTYPE_SIZE=6,E.ANIMATIONLOOPMODE_RELATIVE=0,E.ANIMATIONLOOPMODE_CYCLE=1,E.ANIMATIONLOOPMODE_CONSTANT=2,E.ANIMATIONLOOPMODE_YOYO=4,E.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5,E.CreateFromSnippetAsync=E.ParseFromSnippetAsync,Object(a.b)("BABYLON.Animation",E),l.a._AnimationRangeFactory=(e,t,n)=>new o.a(e,t,n)},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.helperFunctions="const PI: f32=3.1415926535897932384626433832795;const TWO_PI: f32=6.283185307179586;const HALF_PI: f32=1.5707963267948966;const RECIPROCAL_PI: f32=0.3183098861837907;const RECIPROCAL_PI2: f32=0.15915494309189535;const RECIPROCAL_PI4: f32=0.07957747154594767;const HALF_MIN: f32=5.96046448e-08; \nconst LinearEncodePowerApprox: f32=2.2;const GammaEncodePowerApprox: f32=1.0/LinearEncodePowerApprox;const LuminanceEncodeApprox: vec3f=vec3f(0.2126,0.7152,0.0722);const Epsilon:f32=0.0000001;fn square(x: f32)->f32 {return x*x;}\nfn saturate(x: f32)->f32 {return clamp(x,0.0,1.0);}\nfn saturateVec3(x: vec3f)->vec3f {return clamp(x,vec3f(),vec3f(1.0));}\nfn saturateEps(x: f32)->f32 {return clamp(x,Epsilon,1.0);}\nfn maxEps(x: f32)->f32 {return max(x,Epsilon);}\nfn maxEpsVec3(x: vec3f)->vec3f {return max(x,vec3f(Epsilon));}\nfn absEps(x: f32)->f32 {return abs(x)+Epsilon;}\nfn transposeMat3(inMatrix: mat3x3f)->mat3x3f {let i0: vec3f=inMatrix[0];let i1: vec3f=inMatrix[1];let i2: vec3f=inMatrix[2];let outMatrix:mat3x3f=mat3x3f(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);return outMatrix;}\nfn inverseMat3(inMatrix: mat3x3f)->mat3x3f {let a00: f32=inMatrix[0][0];let a01: f32=inMatrix[0][1];let a02: f32=inMatrix[0][2];let a10: f32=inMatrix[1][0];let a11: f32=inMatrix[1][1];let a12: f32=inMatrix[1][2];let a20: f32=inMatrix[2][0];let a21: f32=inMatrix[2][1];let a22: f32=inMatrix[2][2];let b01: f32=a22*a11-a12*a21;let b11: f32=-a22*a10+a12*a20;let b21: f32=a21*a10-a11*a20;let det: f32=a00*b01+a01*b11+a02*b21;return mat3x3f(b01/det,(-a22*a01+a02*a21)/det,(a12*a01-a02*a11)/det,\nb11/det,(a22*a00-a02*a20)/det,(-a12*a00+a02*a10)/det,\nb21/det,(-a21*a00+a01*a20)/det,(a11*a00-a01*a10)/det);}\n#if USE_EXACT_SRGB_CONVERSIONS\nfn toLinearSpaceExact(color: vec3f)->vec3f\n{let nearZeroSection: vec3f=0.0773993808*color;let remainingSection: vec3f=pow(0.947867299*(color+vec3f(0.055)),vec3f(2.4));return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3f(0.04045)));}\nfn toGammaSpaceExact(color: vec3f)->vec3f\n{let nearZeroSection: vec3f=12.92*color;let remainingSection: vec3f=1.055*pow(color,vec3f(0.41666))-vec3f(0.055);return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3f(0.0031308)));}\n#endif\nfn toLinearSpace(color: f32)->f32\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nvar nearZeroSection=0.0773993808*color;var remainingSection=pow(0.947867299*(color+0.055),2.4);return select(remainingSection,nearZeroSection,color<=0.04045);\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nfn toLinearSpaceVec3(color: vec3f)->vec3f\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3f(LinearEncodePowerApprox));\n#endif\n}\nfn toLinearSpaceVec4(color: vec4<f32>)->vec4<f32>\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4f(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4f(pow(color.rgb,vec3f(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfn toGammaSpace(color: vec4<f32>)->vec4<f32>\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4<f32>(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4<f32>(pow(color.rgb,vec3f(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfn toGammaSpaceVec3(color: vec3f)->vec3f\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3f(GammaEncodePowerApprox));\n#endif\n}\nfn squareVec3(value: vec3f)->vec3f\n{return value*value;}\nfn pow5(value: f32)->f32 {let sq: f32=value*value;return sq*sq*value;}\nfn getLuminance(color: vec3f)->f32\n{return saturate(dot(color,LuminanceEncodeApprox));}\nfn getRand(seed: vec2<f32>)->f32 {return fract(sin(dot(seed.xy ,vec2<f32>(12.9898,78.233)))*43758.5453);}\nfn dither(seed: vec2<f32>,varianceAmount: f32)->f32 {let rand: f32=getRand(seed);let normVariance: f32=varianceAmount/255.0;let dither: f32=mix(-normVariance,normVariance,rand);return dither;}\nconst rgbdMaxRange: f32=255.0;fn toRGBD(color: vec3f)->vec4<f32> {let maxRGB: f32=max(max(color.r,max(color.g,color.b)),Epsilon);var D: f32 =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);var rgb: vec3f =color.rgb*D;rgb=toGammaSpaceVec3(rgb);return vec4<f32>(saturateVec3(rgb),D);}\nfn fromRGBD(rgbd: vec4<f32>)->vec3f {let rgb=toLinearSpaceVec3(rgbd.rgb);return rgb/rgbd.a;}\nfn parallaxCorrectNormal(vertexPos: vec3f,origVec: vec3f,cubeSize: vec3f,cubePos: vec3f)->vec3f {let invOrigVec: vec3f=vec3f(1.)/origVec;let halfSize: vec3f=cubeSize*0.5;let intersecAtMaxPlane: vec3f=(cubePos+halfSize-vertexPos)*invOrigVec;let intersecAtMinPlane: vec3f=(cubePos-halfSize-vertexPos)*invOrigVec;let largestIntersec: vec3f=max(intersecAtMaxPlane,intersecAtMinPlane);let distance: f32=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);let intersectPositionWS: vec3f=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}\nfn equirectangularToCubemapDirection(uv : vec2f)->vec3f {var longitude : f32=uv.x*TWO_PI-PI;var latitude : f32=HALF_PI-uv.y*PI;var direction : vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\nfn sqrtClamped(value: f32)->f32 {return sqrt(max(value,0.));}\nfn avg(value: vec3f)->f32 {return dot(value,vec3f(0.333333333));}\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.helperFunctions="const float PI=3.1415926535897932384626433832795;const float TWO_PI=6.283185307179586;const float HALF_PI=1.5707963267948966;const float RECIPROCAL_PI=0.3183098861837907;const float RECIPROCAL_PI2=0.15915494309189535;const float RECIPROCAL_PI4=0.07957747154594767;const float HALF_MIN=5.96046448e-08; \nconst float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;\n#define saturate(x) clamp(x,0.0,1.0)\n#define absEps(x) abs(x)+Epsilon\n#define maxEps(x) max(x,Epsilon)\n#define saturateEps(x) clamp(x,Epsilon,1.0)\nmat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);return outMatrix;}\nmat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}\n#if USE_EXACT_SRGB_CONVERSIONS\nvec3 toLinearSpaceExact(vec3 color)\n{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));\n#else\nreturn\nvec3(\ncolor.r<=0.04045 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.04045 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.04045 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\nvec3 toGammaSpaceExact(vec3 color)\n{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));\n#else\nreturn\nvec3(\ncolor.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\n#endif\nfloat toLinearSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nvec3 toLinearSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3(LinearEncodePowerApprox));\n#endif\n}\nvec4 toLinearSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfloat toGammaSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,GammaEncodePowerApprox);\n#endif\n}\nvec3 toGammaSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3(GammaEncodePowerApprox));\n#endif\n}\nvec4 toGammaSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfloat square(float value)\n{return value*value;}\nvec3 square(vec3 value)\n{return value*value;}\nfloat pow5(float value) {float sq=value*value;return sq*sq*value;}\nfloat getLuminance(vec3 color)\n{return saturate(dot(color,LuminanceEncodeApprox));}\nfloat getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}\nfloat dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}\nconst float rgbdMaxRange=255.;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =saturate(floor(D)/255.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(saturate(rgb),D);}\nvec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}\nvec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*TWO_PI-PI;float latitude=HALF_PI-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}\nfloat sqrtClamped(float value) {return sqrt(max(value,0.));}\nfloat avg(vec3 value) {return dot(value,vec3(0.333333333));}"},function(e,t,n){"use strict";n.d(t,"e",(function(){return g})),n.d(t,"b",(function(){return E})),n.d(t,"i",(function(){return T})),n.d(t,"f",(function(){return A})),n.d(t,"g",(function(){return b})),n.d(t,"d",(function(){return I})),n.d(t,"h",(function(){return R})),n.d(t,"c",(function(){return y})),n.d(t,"a",(function(){return O}));var i=n(329),r=n(48),s=n(43);class a{}a.FilesToLoad={};var o=n(335),l=n(373),c=n(110),d=n(62),h=n(36),u=n(121),f=n(55),m=n(100);const p=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class g extends o.c{constructor(e,t){super(e,o.b.LoadFileError),this.name="LoadFileError",o.a._setPrototypeOf(this,g.prototype),t instanceof i.a?this.request=t:this.file=t}}class _ extends o.c{constructor(e,t){super(e,o.b.RequestFileError),this.request=t,this.name="RequestFileError",o.a._setPrototypeOf(this,_.prototype)}}class v extends o.c{constructor(e,t){super(e,o.b.ReadFileError),this.file=t,this.name="ReadFileError",o.a._setPrototypeOf(this,v.prototype)}}const E={DefaultRetryStrategy:class{static ExponentialBackoff(e=3,t=500){return(n,i,r)=>0!==i.status||r>=e||-1!==n.indexOf("file:")?-1:Math.pow(2,r)*t}}.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:e=>e,ScriptBaseUrl:"",ScriptPreprocessUrl:e=>e,CleanUrl:e=>e.replace(/#/gm,"%23")},T=(e,t)=>{if((!e||0!==e.indexOf("data:"))&&E.CorsBehavior)if("string"==typeof E.CorsBehavior||E.CorsBehavior instanceof String)t.crossOrigin=E.CorsBehavior;else{const n=E.CorsBehavior(e);n&&(t.crossOrigin=n)}},S={getRequiredSize:null},A=(e,t,n,r,s="",o)=>{const c=d.a.LastCreatedEngine;if("undefined"==typeof HTMLImageElement&&(null==c||!c._features.forceBitmapOverHTMLImageElement))return n("LoadImage is only supported in web or BabylonNative environments."),null;let h,u=!1;e instanceof ArrayBuffer||ArrayBuffer.isView(e)?"undefined"!=typeof Blob&&"undefined"!=typeof URL?(h=URL.createObjectURL(new Blob([e],{type:s})),u=!0):h=`data:${s};base64,`+Object(l.d)(e):e instanceof Blob?(h=URL.createObjectURL(e),u=!0):(h=E.CleanUrl(e),h=E.PreprocessUrl(h));const f=t=>{if(n){const i=h||e.toString();n("Error while trying to load image: "+(0===i.indexOf("http")||i.length<=128?i:i.slice(0,128)+"..."),t)}};if(null!=c&&c._features.forceBitmapOverHTMLImageElement)return I(h,i=>{c.createImageBitmap(new Blob([i],{type:s}),{premultiplyAlpha:"none",...o}).then(e=>{t(e),u&&URL.revokeObjectURL(h)}).catch(t=>{n&&n("Error while trying to load image: "+e,t)})},void 0,r||void 0,!0,(e,t)=>{f(t)}),null;const m=new Image;if(S.getRequiredSize){const t=S.getRequiredSize(e);t.width&&(m.width=t.width),t.height&&(m.height=t.height)}T(h,m);const p=[],g=()=>{p.forEach(e=>{e.target.removeEventListener(e.name,e.handler)}),p.length=0};p.push({target:m,name:"load",handler:()=>{g(),t(m),u&&m.src&&URL.revokeObjectURL(m.src)}}),p.push({target:m,name:"error",handler:e=>{g(),f(e),u&&m.src&&URL.revokeObjectURL(m.src)}}),p.push({target:document,name:"securitypolicyviolation",handler:e=>{if(e.blockedURI!==m.src||"report"===e.disposition)return;g();const t=new Error(`CSP violation of policy ${e.effectiveDirective} ${e.blockedURI}. Current policy is ${e.originalPolicy}`);d.a.UseFallbackTexture=!1,f(t),u&&m.src&&URL.revokeObjectURL(m.src),m.src=""}}),p.forEach(e=>{e.target.addEventListener(e.name,e.handler)});const _="blob:"===h.substring(0,5),v="data:"===h.substring(0,5),A=()=>{_||v||!i.a.IsCustomRequestAvailable?m.src=h:I(h,(e,t,n)=>{const i=new Blob([e],{type:!s&&n?n:s}),r=URL.createObjectURL(i);u=!0,m.src=r},void 0,r||void 0,!0,(e,t)=>{f(t)})};if(!_&&!v&&r&&r.enableTexturesOffline)r.open(()=>{r&&r.loadImage(h,m)},A);else{if(-1!==h.indexOf("file:")){const e=decodeURIComponent(h.substring(5).toLowerCase());if(a.FilesToLoad[e]&&"undefined"!=typeof URL){try{let t;try{t=URL.createObjectURL(a.FilesToLoad[e])}catch(n){t=URL.createObjectURL(a.FilesToLoad[e])}m.src=t,u=!0}catch(e){m.src=""}return m}}A()}return m},b=(e,t,n,i,r)=>{const a=new FileReader,o={onCompleteObservable:new s.a,abort:()=>a.abort()};return a.onloadend=()=>o.onCompleteObservable.notifyObservers(o),r&&(a.onerror=()=>{r(new v("Unable to read "+e.name,e))}),a.onload=e=>{t(e.target.result)},n&&(a.onprogress=n),i?a.readAsArrayBuffer(e):a.readAsText(e),o},I=(e,t,n,i,r,o,l)=>{if(e.name)return b(e,t,n,r,o?e=>{o(void 0,e)}:void 0);const c=e;if(-1!==c.indexOf("file:")){let e=decodeURIComponent(c.substring(5).toLowerCase());0===e.indexOf("./")&&(e=e.substring(2));const i=a.FilesToLoad[e];if(i)return b(i,t,n,r,o?e=>o(void 0,new g(e.message,e.file)):void 0)}const{match:d,type:f}=M(c);if(d){const e={onCompleteObservable:new s.a,abort:()=>()=>{}};try{const e=r?O(c):x(c);t(e,void 0,f)}catch(e){o?o(void 0,e):h.a.Error(e.message||"Failed to parse the Data URL")}return u.a.SetImmediate(()=>{e.onCompleteObservable.notifyObservers(e)}),e}return R(c,(e,n)=>{t(e,null==n?void 0:n.responseURL,null==n?void 0:n.getResponseHeader("content-type"))},n,i,r,o?e=>{o(e.request,new g(e.message,e.request))}:void 0,l)},R=(e,t,n,a,o,l,c)=>{e=E.CleanUrl(e),e=E.PreprocessUrl(e);const d=E.BaseUrl+e;let u=!1;const f={onCompleteObservable:new s.a,abort:()=>u=!0},m=()=>{let e,s=new i.a,a=null;const m=()=>{s&&(n&&s.removeEventListener("progress",n),e&&s.removeEventListener("readystatechange",e),s.removeEventListener("loadend",p))};let p=()=>{m(),f.onCompleteObservable.notifyObservers(f),f.onCompleteObservable.clear(),n=void 0,e=null,p=null,l=void 0,c=void 0,t=void 0};f.abort=()=>{u=!0,p&&p(),s&&s.readyState!==(XMLHttpRequest.DONE||4)&&s.abort(),null!==a&&(clearTimeout(a),a=null),s=null};const g=e=>{const t=e.message||"Unknown error";l&&s?l(new _(t,s)):h.a.Error(t)},v=h=>{if(s){if(s.open("GET",d),c)try{c(s)}catch(e){return void g(e)}o&&(s.responseType="arraybuffer"),n&&s.addEventListener("progress",n),p&&s.addEventListener("loadend",p),e=()=>{if(!u&&s&&s.readyState===(XMLHttpRequest.DONE||4)){if(e&&s.removeEventListener("readystatechange",e),s.status>=200&&s.status<300||0===s.status&&(!Object(r.d)()||C())){const e=o?s.response:s.responseText;if(null!==e){try{t&&t(e,s)}catch(e){g(e)}return}}const n=E.DefaultRetryStrategy;if(n){const e=n(d,s,h);if(-1!==e)return m(),s=new i.a,void(a=setTimeout(()=>v(h+1),e))}const c=new _("Error status: "+s.status+" "+s.statusText+" - Unable to load "+d,s);l&&l(c)}},s.addEventListener("readystatechange",e),s.send()}};v(0)};if(a&&a.enableSceneOffline){const i=e=>{e&&e.status>400?l&&l(e):m()},r=()=>{a&&a.loadFile(E.BaseUrl+e,e=>{!u&&t&&t(e),f.onCompleteObservable.notifyObservers(f)},n?e=>{!u&&n&&n(e)}:void 0,i,o)};a.open(r,i)}else m();return f},C=()=>"undefined"!=typeof location&&"file:"===location.protocol,y=e=>p.test(e),M=e=>{const t=p.exec(e);return null===t||0===t.length?{match:!1,type:""}:{match:!0,type:t[0].replace("data:","").replace("base64,","")}};function O(e){return Object(l.b)(e.split(",")[1])}const x=e=>Object(l.c)(e.split(",")[1]);let D;m.a._FileToolsLoadImage=A,f.a.loadFile=I,c.e.loadFile=I,((e,t,n,i,r,s,a,o,l,c)=>{D={DecodeBase64UrlToBinary:e,DecodeBase64UrlToString:t,DefaultRetryStrategy:n.DefaultRetryStrategy,BaseUrl:n.BaseUrl,CorsBehavior:n.CorsBehavior,PreprocessUrl:n.PreprocessUrl,IsBase64DataUrl:i,IsFileURL:r,LoadFile:s,LoadImage:a,ReadFile:o,RequestFile:l,SetCorsBehavior:c},Object.defineProperty(D,"DefaultRetryStrategy",{get:function(){return n.DefaultRetryStrategy},set:function(e){n.DefaultRetryStrategy=e}}),Object.defineProperty(D,"BaseUrl",{get:function(){return n.BaseUrl},set:function(e){n.BaseUrl=e}}),Object.defineProperty(D,"PreprocessUrl",{get:function(){return n.PreprocessUrl},set:function(e){n.PreprocessUrl=e}}),Object.defineProperty(D,"CorsBehavior",{get:function(){return n.CorsBehavior},set:function(e){n.CorsBehavior=e}})})(O,x,E,y,C,I,A,b,R,T)},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));class i{static Eval(e,t){return"true"===(e=e.match(/\([^()]*\)/g)?e.replace(/\([^()]*\)/g,e=>(e=e.slice(1,e.length-1),i._HandleParenthesisContent(e,t))):i._HandleParenthesisContent(e,t))||"false"!==e&&i.Eval(e,t)}static _HandleParenthesisContent(e,t){let n;t=t||(e=>"true"===e);const r=e.split("||");for(const e in r)if(Object.prototype.hasOwnProperty.call(r,e)){let s=i._SimplifyNegation(r[e].trim());const a=s.split("&&");if(a.length>1)for(let e=0;e<a.length;++e){const r=i._SimplifyNegation(a[e].trim());if(n="true"!==r&&"false"!==r?"!"===r[0]?!t(r.substring(1)):t(r):"true"===r,!n){s="false";break}}if(n||"true"===s){n=!0;break}n="true"!==s&&"false"!==s?"!"===s[0]?!t(s.substring(1)):t(s):"true"===s}return n?"true":"false"}static _SimplifyNegation(e){return"!true"===(e=(e=e.replace(/^[\s!]+/,e=>(e=e.replace(/[\s]/g,()=>"")).length%2?"!":"")).trim())?e="false":"!false"===e&&(e="true"),e}}class r{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>r.HasTags(e),e.addTags=t=>r.AddTagsTo(e,t),e.removeTags=t=>r.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>r.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const t=[];for(const n in e._tags)Object.prototype.hasOwnProperty.call(e._tags,n)&&!0===e._tags[n]&&t.push(n);return t.join(" ")}return e._tags}static AddTagsTo(e,t){t&&"string"==typeof t&&t.split(" ").forEach((function(t){r._AddTagTo(e,t)}))}static _AddTagTo(e,t){""!==(t=t.trim())&&"true"!==t&&"false"!==t&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(r.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!r.HasTags(e))return;const n=t.split(" ");for(const t in n)r._RemoveTagFrom(e,n[t])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return void 0===t||(""===t?r.HasTags(e):i.Eval(t,t=>r.HasTags(e)&&e._tags[t]))}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i,r,s=n(84);!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD",e[e.BONE=2]="BONE"}(i||(i={}));class a{}a.X=new s.e(1,0,0),a.Y=new s.e(0,1,0),a.Z=new s.e(0,0,1),function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(r||(r={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var i=n(43),r=n(84),s=n(314),a=n(374),o=n(140),l=n(76),c=n(36),d=n(389),h=n(87);class u{get renderList(){return this._renderList}set renderList(e){this._renderList!==e&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=Object(h.c)(e,this._renderListHasChanged)),this._renderList=e)}get name(){return this._name}set name(e){if(this._name===e)return;if(this._name=e,!this._scene)return;const t=this._scene.getEngine();for(let e=0;e<this._renderPassIds.length;++e){const n=this._renderPassIds[e];t._renderPassNames[n]=`${this._name}#${e}`}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let n;n=Array.isArray(e)?e:[e];for(let e=0;e<n.length;++e)for(let i=0;i<this.options.numPasses;++i)n[e].setMaterialForRenderPass(this._renderPassIds[i],void 0!==t?Array.isArray(t)?t[i]:t:void 0)}_releaseRenderPassId(){const e=this._scene.getEngine();for(let t=0;t<this.options.numPasses;++t)e.releaseRenderPassId(this._renderPassIds[t]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine();for(let t=0;t<this.options.numPasses;++t)this._renderPassIds[t]=e.createRenderPassId(`${this.name}#${t}`)}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(e,t){this.prepareRenderList(),this.initRender(e,t);const n=this._checkReadiness();return this.finishRender(),n}prepareRenderList(){const e=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let t=0;t<this._waitingRenderList.length;t++){const n=this._waitingRenderList[t],i=e.getMeshById(n);i&&this.renderList.push(i)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const e=this._scene.meshes;for(let t=0;t<e.length;t++){const n=e[t];this.renderListPredicate(n)&&this.renderList.push(n)}}}initRender(e,t){var n;const i=this._scene.getEngine(),r=null!==(n=this.activeCamera)&&void 0!==n?n:this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,r&&(r!==this._scene.activeCamera&&(this._scene.setTransformMatrix(r.getViewMatrix(),r.getProjectionMatrix(!0)),this._scene.activeCamera=r),i.setViewport(r.rigParent?r.rigParent.viewport:r.viewport,e,t)),this._defaultRenderListPrepared=!1}finishRender(){const e=this._scene;e.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==e.activeCamera&&e.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),e.getEngine().setViewport(this._currentSceneCamera.viewport)),e.resetCachedMaterial()}render(e=0,t=!1){const n=this._scene,i=n.getEngine(),r=i.currentRenderPassId;if(i.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e),i.snapshotRendering&&1===i.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(e);else{let t=null;const i=this.renderList?this.renderList:n.getActiveMeshes().data,r=this.renderList?this.renderList.length:n.getActiveMeshes().length;this.getCustomRenderList&&(t=this.getCustomRenderList(e,i,r)),t?this._prepareRenderingManager(t,t.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(i,r,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),t=i),this.onBeforeRenderingManagerRenderObservable.notifyObservers(e),this._renderingManager.render(this.customRenderFunction,t,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(e)}t||this.onAfterRenderObservable.notifyObservers(e),i.currentRenderPassId=r}_checkReadiness(){const e=this._scene,t=e.getEngine(),n=t.currentRenderPassId;let i=!0;e.getViewMatrix()||e.updateTransformMatrix();const r=this.options.numPasses;for(let n=0;n<r&&i;n++){let s=null;const a=this.renderList?this.renderList:e.getActiveMeshes().data,o=this.renderList?this.renderList.length:e.getActiveMeshes().length;t.currentRenderPassId=this._renderPassIds[n],this.onBeforeRenderObservable.notifyObservers(n),this.getCustomRenderList&&(s=this.getCustomRenderList(n,a,o)),s||(s=a),this.options.doNotChangeAspectRatio||e.updateTransformMatrix(!0);for(let e=0;e<s.length&&i;++e){const t=s[e];if(t.isEnabled()&&!t.isBlocked&&t.isVisible&&t.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(t,this.refreshRate,!0)){i=!1;continue}}else if(!t.isReady(!0)){i=!1;continue}}this.onAfterRenderObservable.notifyObservers(n),r>1&&(e.incrementRenderId(),e.resetCachedMaterial())}const s=this.particleSystemList||e.particleSystems;for(const e of s)e.isReady()||(i=!1);return t.currentRenderPassId=n,i}_prepareRenderingManager(e,t,n){var i;const r=this._scene,s=r.activeCamera,a=null!==(i=this.cameraForLOD)&&void 0!==i?i:s;this._renderingManager.reset();const o=r.getRenderId(),l=r.getFrameId();for(let i=0;i<t;i++){const t=e[i];if(t&&!t.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(t,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!t.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let e,i=null;if(a){const e=t._internalAbstractMeshDataInfo._currentLOD.get(a);e&&e[1]===l?i=e[0]:(i=r.customLODSelector?r.customLODSelector(t,a):t.getLOD(a),e?(e[0]=i,e[1]=l):t._internalAbstractMeshDataInfo._currentLOD.set(a,[i,l]))}else i=t;if(!i)continue;if(i!==t&&0!==i.billboardMode&&i.computeWorldMatrix(),i._preActivateForIntermediateRendering(o),e=!(!n||!s)&&0==(t.layerMask&s.layerMask),t.isEnabled()&&t.isVisible&&t.subMeshes&&!e){if(i!==t&&i._activate(o,!0),t._activate(o,!0)&&t.subMeshes.length){t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(i=t):i._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,i._internalAbstractMeshDataInfo._isActiveIntermediate=!0,r._prepareSkeleton(i);for(let e=0;e<i.subMeshes.length;e++){const t=i.subMeshes[e];this._renderingManager.dispatch(t,i)}}t._postActivate()}}}const c=this.particleSystemList||r.particleSystems;for(let e=0;e<c.length;e++){const t=c[e],n=t.emitter;t.isStarted()&&n&&(!n.position||n.isEnabled())&&this._renderingManager.dispatchParticles(t)}}setRenderingOrder(e,t=null,n=null,i=null){this._renderingManager.setRenderingOrder(e,t,n,i)}setRenderingAutoClearDepthStencil(e,t,n=!0,i=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,n,i),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=new u(this.name,this._scene,this.options);return this.renderList&&(e.renderList=this.renderList.slice(0)),e}dispose(){const e=this.renderList?this.renderList:this._scene.getActiveMeshes().data,t=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let n=0;n<t;n++){const t=e[n];void 0!==t.getMaterialForRenderPass(this.renderPassId)&&t.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}_rebuild(){this.refreshRate===u.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=u.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}constructor(e,t,n){this._unObserveRenderList=null,this._renderListHasChanged=(e,t)=>{const n=this._renderList?this._renderList.length:0;(0===t&&n>0||0===n)&&this._scene.meshes.forEach(e=>{e._markSubMeshesAsLightDirty()})},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.onBeforeRenderObservable=new i.a,this.onAfterRenderObservable=new i.a,this.onBeforeRenderingManagerRenderObservable=new i.a,this.onAfterRenderingManagerRenderObservable=new i.a,this.onFastPathRenderObservable=new i.a,this._currentRefreshId=-1,this._refreshRate=1,this._currentSceneCamera=null,this.name=e,this._scene=t,this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...n},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new d.a(t),this._renderingManager._useSceneAutoClearSetup=!0}}u.REFRESHRATE_RENDER_ONCE=0,u.REFRESHRATE_RENDER_ONEVERYFRAME=1,u.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,l.a.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)};class f extends s.a{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(e){this._objectRenderer.renderListPredicate=e}get renderList(){return this._objectRenderer.renderList}set renderList(e){this._objectRenderer.renderList=e}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(e){this._objectRenderer.particleSystemList=e}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(e){this._objectRenderer.getCustomRenderList=e}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(e){this._objectRenderer.renderParticles=e}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(e){this._objectRenderer.renderSprites=e}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._objectRenderer.forceLayerMaskCheck=e}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(e){this._objectRenderer.activeCamera=e}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(e){this._objectRenderer.cameraForLOD=e}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(e){this._objectRenderer.customIsReadyFunction=e}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(e){this._objectRenderer.customRenderFunction=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(e){this._objectRenderer._waitingRenderList=e}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(e,t){this._objectRenderer.setMaterialForRendering(e,t)}get isMulti(){var e,t;return null!==(e=null===(t=this._renderTarget)||void 0===t?void 0:t.isMulti)&&void 0!==e&&e}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e,t;return null!==(e=null===(t=this._renderTarget)||void 0===t?void 0:t._depthStencilTexture)&&void 0!==e?e:null}createDepthStencilTexture(e=0,t=!0,n=!1,i=1,r=14,s){var a;null===(a=this._renderTarget)||void 0===a||a.createDepthStencilTexture(e,t,n,i,r,s)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e}get samples(){var e,t;return null!==(e=null===(t=this._renderTarget)||void 0===t?void 0:t.samples)&&void 0!==e?e:this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}addPostProcess(e){if(!this._postProcessManager){const e=this.getScene();if(!e)return;this._postProcessManager=new a.a(e),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const e of this._postProcesses)e.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(e){this._objectRenderer.refreshRate=e}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;if(e)return e;return this._size.depth||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var t;const n=this.isCube;null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null;const i=this.getScene();i&&(this._processSizeParameter(e),this._renderTarget=n?i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,n.e(0).then(n.bind(null,490)).then(e=>this._dumpTools=e)),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const e=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),e}_render(e=!1,t=!1){const n=this.getScene();if(n){if(void 0!==this.useCameraPostProcesses&&(e=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let i=0;i<6;i++)this._renderToTarget(i,e,t),n.incrementRenderId(),n.resetCachedMaterial();else this._renderToTarget(0,e,t);else for(let i=0;i<this.getRenderLayers();i++)this._renderToTarget(0,e,t,i),n.incrementRenderId(),n.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(e,t){const n=e*t,i=Object(o.e)(n+16384/(128+n));return Math.min(Object(o.a)(e),i)}_bindFrameBuffer(e=0,t=0){const n=this.getScene();if(!n)return;const i=n.getEngine();this._renderTarget&&i.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,n,i){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):i&&e.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(t,n)}_renderToTarget(e,t,n,i=0){var r,s;const a=this.getScene();if(!a)return;const o=a.getEngine();this._currentFaceIndex=e,this._currentLayer=i,this._currentUseCameraPostProcess=t,this._currentDumpForDebug=n,this._prepareFrame(a,e,i,t),null===(r=o._debugPushGroup)||void 0===r||r.call(o,`render to face #${e} layer #${i}`,2),this._objectRenderer.render(e+i,!0),null===(s=o._debugPopGroup)||void 0===s||s.call(o,2),this._unbindFrameBuffer(o,e),this._texture&&this.isCube&&5===e&&o.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(e,t=null,n=null,i=null){this._objectRenderer.setRenderingOrder(e,t,n,i)}setRenderingAutoClearDepthStencil(e,t){this._objectRenderer.setRenderingAutoClearDepthStencil(e,t)}clone(){const e=this.getSize(),t=new f(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){var e;null===(e=this._renderTarget)||void 0===e||e.dispose(!0)}releaseInternalTexture(){var e;null===(e=this._renderTarget)||void 0===e||e.releaseTextures(),this._texture=null}dispose(){var e;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const t=this.getScene();if(!t)return;let n=t.customRenderTargets.indexOf(this);n>=0&&t.customRenderTargets.splice(n,1);for(const e of t.cameras)n=e.customRenderTargets.indexOf(this),n>=0&&e.customRenderTargets.splice(n,1);null===(e=this._renderTarget)||void 0===e||e.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}constructor(e,t,n,a=!1,o=!0,l=0,d=!1,h=s.a.TRILINEAR_SAMPLINGMODE,f=!0,m=!1,p=!1,g=5,_=!1,v,E,T=!1,S=!1){var A,b;let I=void 0,R=!0,C=void 0;if("object"==typeof a){var y,M,O,x,D,P;const e=a;a=!!e.generateMipMaps,o=null===(y=e.doNotChangeAspectRatio)||void 0===y||y,l=null!==(M=e.type)&&void 0!==M?M:0,d=!!e.isCube,h=null!==(O=e.samplingMode)&&void 0!==O?O:s.a.TRILINEAR_SAMPLINGMODE,f=null===(x=e.generateDepthBuffer)||void 0===x||x,m=!!e.generateStencilBuffer,p=!!e.isMulti,g=null!==(D=e.format)&&void 0!==D?D:5,_=!!e.delayAllocation,v=e.samples,E=e.creationFlags,T=!!e.noColorAttachment,S=!!e.useSRGBBuffer,I=e.colorAttachment,R=null!==(P=e.gammaSpace)&&void 0!==P?P:R,C=e.existingObjectRenderer}if(super(null,n,!a,void 0,h,void 0,void 0,void 0,void 0,g),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new i.a,this.onAfterUnbindObservable=new i.a,this.onClearObservable=new i.a,this.onResizeObservable=new i.a,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=r.e.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(n=this.getScene()))return;const L=this.getScene().getEngine();this._gammaSpace=R,this._coordinatesMode=s.a.PROJECTION_MODE,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._dontDisposeObjectRenderer=!!C,this._processSizeParameter(t),this._objectRenderer=null!==(A=C)&&void 0!==A?A:new u(e,n,{numPasses:d?6:this.getRenderLayers()||1,doNotChangeAspectRatio:o}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add(()=>{if(!this._disableEngineStages)for(const e of this._scene._beforeRenderTargetClearStage)e.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(L):this.skipInitialClear||L.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const e of this._scene._beforeRenderTargetDrawStage)e.action(this,this._currentFaceIndex,this._currentLayer)}),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add(()=>{var e,t;if(!this._disableEngineStages)for(const e of this._scene._afterRenderTargetDrawStage)e.action(this,this._currentFaceIndex,this._currentLayer);const n=null!==(e=null===(t=this._texture)||void 0===t?void 0:t.generateMipMaps)&&void 0!==e&&e;var i;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager)this._postProcessManager._finalizeFrame(!1,null!==(i=this._renderTarget)&&void 0!==i?i:void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport);else if(this._currentUseCameraPostProcess){var r;this._scene.postProcessManager._finalizeFrame(!1,null!==(r=this._renderTarget)&&void 0!==r?r:void 0,this._currentFaceIndex)}if(!this._disableEngineStages)for(const e of this._scene._afterRenderTargetPostProcessStage)e.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=n),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),L):c.a.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))}),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add(()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(L):this.skipInitialClear||L.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)}),this._resizeObserver=L.onResizeObservable.add(()=>{}),this._generateMipMaps=!!a,this._doNotChangeAspectRatio=o,p||(this._renderTargetOptions={generateMipMaps:a,type:l,format:null!==(b=this._format)&&void 0!==b?b:void 0,samplingMode:this.samplingMode,generateDepthBuffer:f,generateStencilBuffer:m,samples:v,creationFlags:E,noColorAttachment:T,useSRGBBuffer:S,colorAttachment:I,label:this.name},this.samplingMode===s.a.NEAREST_SAMPLINGMODE&&(this.wrapU=s.a.CLAMP_ADDRESSMODE,this.wrapV=s.a.CLAMP_ADDRESSMODE),_||(d?(this._renderTarget=n.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=s.a.INVCUBIC_MODE,this._textureMatrix=r.a.Identity()):this._renderTarget=n.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==v&&(this.samples=v)))}}f.REFRESHRATE_RENDER_ONCE=u.REFRESHRATE_RENDER_ONCE,f.REFRESHRATE_RENDER_ONEVERYFRAME=u.REFRESHRATE_RENDER_ONEVERYFRAME,f.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=u.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,s.a._CreateRenderTargetTexture=(e,t,n,i,r)=>new f(e,t,n,i)},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(84);class r{asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new r(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=397*e^(0|this.d),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=r._TmpMatrix;e.invertToRef(t);const n=t.m,i=this.normal.x,s=this.normal.y,a=this.normal.z,o=this.d,l=i*n[0]+s*n[1]+a*n[2]+o*n[3],c=i*n[4]+s*n[5]+a*n[6]+o*n[7],d=i*n[8]+s*n[9]+a*n[10]+o*n[11],h=i*n[12]+s*n[13]+a*n[14]+o*n[15];return new r(l,c,d,h)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,n){const i=t.x-e.x,r=t.y-e.y,s=t.z-e.z,a=n.x-e.x,o=n.y-e.y,l=n.z-e.z,c=r*l-s*o,d=s*a-i*l,h=i*o-r*a,u=Math.sqrt(c*c+d*d+h*h);let f;return f=0!==u?1/u:0,this.normal.x=c*f,this.normal.y=d*f,this.normal.z=h*f,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return i.e.Dot(this.normal,e)<=t}signedDistanceTo(e){return i.e.Dot(e,this.normal)+this.d}static FromArray(e){return new r(e[0],e[1],e[2],e[3])}static FromPoints(e,t,n){const i=new r(0,0,0,0);return i.copyFromPoints(e,t,n),i}static FromPositionAndNormal(e,t){const n=new r(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,n)}static FromPositionAndNormalToRef(e,t,n){return n.normal.copyFrom(t),n.normal.normalize(),n.d=-e.dot(n.normal),n}static SignedDistanceToPlaneFromPositionAndNormal(e,t,n){const r=-(t.x*e.x+t.y*e.y+t.z*e.z);return i.e.Dot(n,t)+r}constructor(e,t,n,r){this.normal=new i.e(e,t,n),this.d=r}}r._TmpMatrix=i.a.Identity()},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{static get IsCustomRequestAvailable(){return Object.keys(i.CustomRequestHeaders).length>0||i.CustomRequestModifiers.length>0}get requestURL(){return this._requestURL}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in i.CustomRequestHeaders){const t=i.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return i.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,n){this._xhr.addEventListener(e,t,n)}removeEventListener(e,t,n){this._xhr.removeEventListener(e,t,n)}abort(){this._xhr.abort()}send(e){i.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const e of i.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;t=e(this._xhr,t)||t}t=(t=t.replace("file:http:","http:")).replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}constructor(){this._xhr="undefined"!=typeof _native&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest,this._requestURL=""}}i.CustomRequestHeaders={},i.CustomRequestModifiers=new Array,i.SkipRequestModificationForBabylonCDN=!0},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"b",(function(){return o}));var i=n(84);class r{}r.POINTERDOWN=1,r.POINTERUP=2,r.POINTERMOVE=4,r.POINTERWHEEL=8,r.POINTERPICK=16,r.POINTERTAP=32,r.POINTERDOUBLETAP=64;class s{constructor(e,t){this.type=e,this.event=t}}class a extends s{constructor(e,t,n,r){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new i.d(n,r)}}class o extends s{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}constructor(e,t,n,i=null){super(e,t),this._pickInfo=n,this._inputManager=i}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return d}));var i,r=n(84);n(326),n(311),n(69),n(333),n(26),function(e){e[e.CW=0]="CW",e[e.CCW=1]="CCW"}(i||(i={})),n(328),n(334),n(174);const s=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],a=[()=>1,e=>e.y,e=>e.z,e=>e.x,e=>e.x*e.y,e=>e.y*e.z,e=>3*e.z*e.z-1,e=>e.x*e.z,e=>e.x*e.x-e.y*e.y],o=(e,t)=>s[e]*a[e](t),l=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class c{addLight(e,t,n){r.c.Vector3[0].set(t.r,t.g,t.b);const i=r.c.Vector3[0],s=r.c.Vector3[1];i.scaleToRef(n,s),s.scaleToRef(o(0,e),r.c.Vector3[2]),this.l00.addInPlace(r.c.Vector3[2]),s.scaleToRef(o(1,e),r.c.Vector3[2]),this.l1_1.addInPlace(r.c.Vector3[2]),s.scaleToRef(o(2,e),r.c.Vector3[2]),this.l10.addInPlace(r.c.Vector3[2]),s.scaleToRef(o(3,e),r.c.Vector3[2]),this.l11.addInPlace(r.c.Vector3[2]),s.scaleToRef(o(4,e),r.c.Vector3[2]),this.l2_2.addInPlace(r.c.Vector3[2]),s.scaleToRef(o(5,e),r.c.Vector3[2]),this.l2_1.addInPlace(r.c.Vector3[2]),s.scaleToRef(o(6,e),r.c.Vector3[2]),this.l20.addInPlace(r.c.Vector3[2]),s.scaleToRef(o(7,e),r.c.Vector3[2]),this.l21.addInPlace(r.c.Vector3[2]),s.scaleToRef(o(8,e),r.c.Vector3[2]),this.l22.addInPlace(r.c.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(l[0]),this.l1_1.scaleInPlace(l[1]),this.l10.scaleInPlace(l[2]),this.l11.scaleInPlace(l[3]),this.l2_2.scaleInPlace(l[4]),this.l2_1.scaleInPlace(l[5]),this.l20.scaleInPlace(l[6]),this.l21.scaleInPlace(l[7]),this.l22.scaleInPlace(l[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(s[0]),this.l1_1.scaleInPlace(s[1]),this.l10.scaleInPlace(s[2]),this.l11.scaleInPlace(s[3]),this.l2_2.scaleInPlace(s[4]),this.l2_1.scaleInPlace(s[5]),this.l20.scaleInPlace(s[6]),this.l21.scaleInPlace(s[7]),this.l22.scaleInPlace(s[8])}updateFromArray(e){return r.e.FromArrayToRef(e[0],0,this.l00),r.e.FromArrayToRef(e[1],0,this.l1_1),r.e.FromArrayToRef(e[2],0,this.l10),r.e.FromArrayToRef(e[3],0,this.l11),r.e.FromArrayToRef(e[4],0,this.l2_2),r.e.FromArrayToRef(e[5],0,this.l2_1),r.e.FromArrayToRef(e[6],0,this.l20),r.e.FromArrayToRef(e[7],0,this.l21),r.e.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return r.e.FromFloatsToRef(e[0],e[1],e[2],this.l00),r.e.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),r.e.FromFloatsToRef(e[6],e[7],e[8],this.l10),r.e.FromFloatsToRef(e[9],e[10],e[11],this.l11),r.e.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),r.e.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),r.e.FromFloatsToRef(e[18],e[19],e[20],this.l20),r.e.FromFloatsToRef(e[21],e[22],e[23],this.l21),r.e.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return(new c).updateFromArray(e)}static FromPolynomial(e){const t=new c;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}constructor(){this.preScaled=!1,this.l00=r.e.Zero(),this.l1_1=r.e.Zero(),this.l10=r.e.Zero(),this.l11=r.e.Zero(),this.l2_2=r.e.Zero(),this.l2_1=r.e.Zero(),this.l20=r.e.Zero(),this.l21=r.e.Zero(),this.l22=r.e.Zero()}}class d{get preScaledHarmonics(){return this._harmonics||(this._harmonics=c.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){r.c.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=r.c.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),r.c.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),r.c.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(r.c.Vector3[0]).addInPlace(r.c.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(r.c.Vector3[0]).subtractInPlace(r.c.Vector3[1]),this.zz.copyFrom(e.l00),r.c.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(r.c.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return(new d).updateFromHarmonics(e)}static FromArray(e){const t=new d;return r.e.FromArrayToRef(e[0],0,t.x),r.e.FromArrayToRef(e[1],0,t.y),r.e.FromArrayToRef(e[2],0,t.z),r.e.FromArrayToRef(e[3],0,t.xx),r.e.FromArrayToRef(e[4],0,t.yy),r.e.FromArrayToRef(e[5],0,t.zz),r.e.FromArrayToRef(e[6],0,t.yz),r.e.FromArrayToRef(e[7],0,t.zx),r.e.FromArrayToRef(e[8],0,t.xy),t}constructor(){this.x=r.e.Zero(),this.y=r.e.Zero(),this.z=r.e.Zero(),this.xx=r.e.Zero(),this.yy=r.e.Zero(),this.zz=r.e.Zero(),this.xy=r.e.Zero(),this.yz=r.e.Zero(),this.zx=r.e.Zero()}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(309),r=n(310),s=n(43),a=n(84),o=n(62),l=n(317),c=(n(324),n(334));class d{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return!!this._texture&&this._texture.isCube}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return void 0!==(null==e?void 0:e.shareDepth)}isReady(){return 4===this.delayLoadState?(this.delayLoad(),!1):!!this._texture&&this._texture.isReady}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return this.isReady()&&this._texture?this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize):(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=c.a.Zero(),this._cachedBaseSize=c.a.Zero(),this._initialSamplingMode=2,this._texture=d._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}}var h=n(313);class u extends d{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,e=>e.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,e=>e.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,e=>e.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,e=>e.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){return this._texture?(null===this._texture._gammaSpace&&(this._texture._gammaSpace=this._gammaSpace),this._texture._gammaSpace&&!this._texture._useSRGBBuffer):this._gammaSpace}set gammaSpace(e){var t;if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1,e=>e.hasTexture(this))}get isRGBD(){return null!=this._texture&&this._texture._isRGBD}set isRGBD(e){var t;e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1,e=>e.hasTexture(this)))}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return!!this._texture&&this._texture._linearSpecularLOD}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=Object(l.a)()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}getScene(){return this._scene}_getEngine(){return this._engine}getTextureMatrix(){return a.a.IdentityReadOnly}getReflectionTextureMatrix(){return a.a.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,n,i,r,s){const a=this._getEngine();if(!a)return null;const o=a._getUseSRGBBuffer(!!r,t),l=a.getLoadedTexturesCache();for(let a=0;a<l.length;a++){const c=l[a];if(!(void 0!==r&&o!==c._useSRGBBuffer||void 0!==i&&i!==c.invertY||c.url!==e||c.generateMipMaps!==!t||n&&n!==c.samplingMode||void 0!==s&&s!==c.isCube))return c.incrementReferences(),c}return null}_rebuild(e=!1){}clone(){return null}get textureType(){return this._texture&&void 0!==this._texture.type?this._texture.type:0}get textureFormat(){return this._texture&&void 0!==this._texture.format?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,n=null,i=!0,r=!1,s=0,a=0,o=Number.MAX_VALUE,l=Number.MAX_VALUE){if(!this._texture)return null;const c=this._getEngine();if(!c)return null;const d=this.getSize();let h=d.width,u=d.height;0!==t&&(h/=Math.pow(2,t),u/=Math.pow(2,t),h=Math.round(h),u=Math.round(u)),o=Math.min(h,o),l=Math.min(u,l);try{return this._texture.isCube?c._readTexturePixels(this._texture,o,l,e,t,n,i,r,s,a):c._readTexturePixels(this._texture,o,l,-1,t,n,i,r,s,a)}catch(e){return null}}_readPixelsSync(e=0,t=0,n=null,i=!0,r=!1){if(!this._texture)return null;const s=this.getSize();let a=s.width,o=s.height;const l=this._getEngine();if(!l)return null;0!=t&&(a/=Math.pow(2,t),o/=Math.pow(2,t),a=Math.round(a),o=Math.round(o));try{return this._texture.isCube?l._readTexturePixelsSync(this._texture,a,o,e,t,n,i,r):l._readTexturePixelsSync(this._texture,a,o,-1,t,n,i,r)}catch(e){return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const e=this._parentContainer.textures.indexOf(this);e>-1&&this._parentContainer.textures.splice(e,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=h.a.Serialize(this);return h.a.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let n=e.length;if(0!==n)for(let i=0;i<e.length;i++){const r=e[i];if(r.isReady())0==--n&&t();else{const e=r.onLoadObservable;e?e.addOnce(()=>{0==--n&&t()}):0==--n&&t()}}else t()}static _IsScene(e){return"Scene"===e.getClassName()}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=u.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=[],this.onDisposeObservable=new s.a,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?u._IsScene(e)?this._scene=e:this._engine=e:this._scene=o.a.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}}u.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,Object(i.a)([Object(r.c)()],u.prototype,"uniqueId",void 0),Object(i.a)([Object(r.c)()],u.prototype,"name",void 0),Object(i.a)([Object(r.c)()],u.prototype,"displayName",void 0),Object(i.a)([Object(r.c)()],u.prototype,"metadata",void 0),Object(i.a)([Object(r.c)("hasAlpha")],u.prototype,"_hasAlpha",void 0),Object(i.a)([Object(r.c)("getAlphaFromRGB")],u.prototype,"_getAlphaFromRGB",void 0),Object(i.a)([Object(r.c)()],u.prototype,"level",void 0),Object(i.a)([Object(r.c)("coordinatesIndex")],u.prototype,"_coordinatesIndex",void 0),Object(i.a)([Object(r.c)()],u.prototype,"optimizeUVAllocation",void 0),Object(i.a)([Object(r.c)("coordinatesMode")],u.prototype,"_coordinatesMode",void 0),Object(i.a)([Object(r.c)()],u.prototype,"wrapU",null),Object(i.a)([Object(r.c)()],u.prototype,"wrapV",null),Object(i.a)([Object(r.c)()],u.prototype,"wrapR",void 0),Object(i.a)([Object(r.c)()],u.prototype,"anisotropicFilteringLevel",void 0),Object(i.a)([Object(r.c)()],u.prototype,"isCube",null),Object(i.a)([Object(r.c)()],u.prototype,"is3D",null),Object(i.a)([Object(r.c)()],u.prototype,"is2DArray",null),Object(i.a)([Object(r.c)()],u.prototype,"gammaSpace",null),Object(i.a)([Object(r.c)()],u.prototype,"invertZ",void 0),Object(i.a)([Object(r.c)()],u.prototype,"lodLevelInAlpha",void 0),Object(i.a)([Object(r.c)()],u.prototype,"lodGenerationOffset",null),Object(i.a)([Object(r.c)()],u.prototype,"lodGenerationScale",null),Object(i.a)([Object(r.c)()],u.prototype,"linearSpecularLOD",null),Object(i.a)([Object(r.l)()],u.prototype,"irradianceTexture",null),Object(i.a)([Object(r.c)()],u.prototype,"isRenderTarget",void 0)},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(328);class r{static GetPlanes(e){const t=[];for(let e=0;e<6;e++)t.push(new i.a(0,0,0,0));return r.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const n=e.m;t.normal.x=n[3]+n[2],t.normal.y=n[7]+n[6],t.normal.z=n[11]+n[10],t.d=n[15]+n[14],t.normalize()}static GetFarPlaneToRef(e,t){const n=e.m;t.normal.x=n[3]-n[2],t.normal.y=n[7]-n[6],t.normal.z=n[11]-n[10],t.d=n[15]-n[14],t.normalize()}static GetLeftPlaneToRef(e,t){const n=e.m;t.normal.x=n[3]+n[0],t.normal.y=n[7]+n[4],t.normal.z=n[11]+n[8],t.d=n[15]+n[12],t.normalize()}static GetRightPlaneToRef(e,t){const n=e.m;t.normal.x=n[3]-n[0],t.normal.y=n[7]-n[4],t.normal.z=n[11]-n[8],t.d=n[15]-n[12],t.normalize()}static GetTopPlaneToRef(e,t){const n=e.m;t.normal.x=n[3]-n[1],t.normal.y=n[7]-n[5],t.normal.z=n[11]-n[9],t.d=n[15]-n[13],t.normalize()}static GetBottomPlaneToRef(e,t){const n=e.m;t.normal.x=n[3]+n[1],t.normal.y=n[7]+n[5],t.normal.z=n[11]+n[9],t.d=n[15]+n[13],t.normalize()}static GetPlanesToRef(e,t){r.GetNearPlaneToRef(e,t[0]),r.GetFarPlaneToRef(e,t[1]),r.GetLeftPlaneToRef(e,t[2]),r.GetRightPlaneToRef(e,t[3]),r.GetTopPlaneToRef(e,t[4]),r.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let n=0;n<6;n++)if(t[n].dotCoordinate(e)<0)return!1;return!0}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=0|this.width;return e=397*e^(0|this.height),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new i(this.width*e,this.height*t)}clone(){return new i(this.width,this.height)}equals(e){return!!e&&this.width===e.width&&this.height===e.height}get surface(){return this.width*this.height}static Zero(){return new i(0,0)}add(e){return new i(this.width+e.width,this.height+e.height)}subtract(e){return new i(this.width-e.width,this.height-e.height)}scale(e){return new i(this.width*e,this.height*e)}static Lerp(e,t,n){const r=e.width+(t.width-e.width)*n,s=e.height+(t.height-e.height)*n;return new i(r,s)}constructor(e,t){this.width=e,this.height=t}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return s}));class i extends Error{}i._setPrototypeOf=Object.setPrototypeOf||((e,t)=>(e.__proto__=t,e));const r={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};class s extends i{constructor(e,t,n){super(e),this.errorCode=t,this.innerError=n,this.name="RuntimeError",i._setPrototypeOf(this,s.prototype)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return d}));var i=n(165),r=n(174),s=n(43),a=n(76),o=n(337);n(375);const l={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class c{setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e.drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return void 0!==e.renderTarget}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const n=null===t?null:this._isRenderTargetTexture(t)?t.renderTarget:t;n&&this.engine.bindFramebuffer(n),this.applyEffectWrapper(e),this.draw(),n&&this.engine.unBindFramebuffer(n),this.restoreStates()}dispose(){const e=this._vertexBuffers[i.b.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[i.b.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}constructor(e,t=l){var n,s;this._fullscreenViewport=new r.a(0,0,1,1);const a=null!==(n=t.positions)&&void 0!==n?n:l.positions,o=null!==(s=t.indices)&&void 0!==s?s:l.indices;this.engine=e,this._vertexBuffers={[i.b.PositionKind]:new i.b(e,a,i.b.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(o),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(o);for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()})}}class d{static RegisterShaderCodeProcessing(e,t){t?d._CustomShaderCodeProcessing[null!=e?e:""]=t:delete d._CustomShaderCodeProcessing[null!=e?e:""]}static _GetShaderCodeProcessing(e){var t;return null!==(t=d._CustomShaderCodeProcessing[e])&&void 0!==t?t:d._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(e){this.options.name=e}isReady(){var e,t;return null!==(e=null===(t=this._drawWrapper.effect)||void 0===t?void 0:t.isReady())&&void 0!==e&&e}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}_gatherImports(e=!1,t){this.options.useAsPostProcess&&(e&&this._webGPUReady?t.push(Promise.all([n.e(0).then(n.bind(null,406))])):t.push(Promise.all([Promise.resolve().then(n.bind(null,375))])))}_postConstructor(e,t=null,n,i){this._importPromises.length=0,i&&this._importPromises.push(...i);const r=this.options.engine.isWebGPU&&!d.ForceGLSL;this._gatherImports(r,this._importPromises),void 0!==n&&n(r,this._importPromises),r&&this._webGPUReady&&(this.options.shaderLanguage=1),e||this.updateEffect(t)}updateEffect(e=null,t=null,n=null,i,r,s,o,l){const c=d._GetShaderCodeProcessing(this.name);if(null!=c&&c.defineCustomBindings){var h,u,f,m;const i=null!==(h=null===(u=t)||void 0===u?void 0:u.slice())&&void 0!==h?h:[];i.push(...this.options.uniforms);const r=null!==(f=null===(m=n)||void 0===m?void 0:m.slice())&&void 0!==f?f:[];r.push(...this.options.samplers),e=c.defineCustomBindings(this.name,e,i,r),t=i,n=r}this.options.defines=e||"";const p=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let g;g=this.options.extraInitializationsAsync?async()=>{null==p||p(),await this.options.extraInitializationsAsync}:p,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({vertex:null!=o?o:this._shaderPath.vertex,fragment:null!=l?l:this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:t||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:n||this.options.samplers,defines:null!==e?e:"",fallbacks:null,onCompiled:null!=r?r:this.options.onCompiled,onError:null!=s?s:null,indexParameters:i||this.options.indexParameters,processCodeAfterIncludes:null!=c&&c.processCodeAfterIncludes?(e,t)=>c.processCodeAfterIncludes(this.name,e,t):null,processFinalCode:null!=c&&c.processFinalCode?(e,t)=>c.processFinalCode(this.name,e,t):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:g},this.options.engine):this._drawWrapper.effect=new a.a(this._shaderPath,this.options.attributeNames,t||this.options.uniforms,n||this.options.samplerNames,this.options.engine,e,void 0,r||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,g),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var e,t;this.options.useAsPostProcess&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),null===(e=d._GetShaderCodeProcessing(this.name))||void 0===e||null===(t=e.bindCustomBindings)||void 0===t||t.call(e,this.name,this._drawWrapper.effect)}dispose(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}constructor(e){var t;this.alphaMode=0,this.onEffectCreatedObservable=new s.a(void 0,!0),this.onApplyObservable=new s.a,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...e,name:e.name||"effectWrapper",engine:e.engine,uniforms:e.uniforms||e.uniformNames||[],uniformNames:void 0,samplers:e.samplers||e.samplerNames||[],samplerNames:void 0,attributeNames:e.attributeNames||["position"],uniformBuffers:e.uniformBuffers||[],defines:e.defines||"",useShaderStore:e.useShaderStore||!1,vertexUrl:e.vertexUrl||e.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:e.fragmentShader||"pass",indexParameters:e.indexParameters,blockCompilation:e.blockCompilation||!1,shaderLanguage:e.shaderLanguage||0,onCompiled:e.onCompiled||void 0,extraInitializations:e.extraInitializations||void 0,extraInitializationsAsync:e.extraInitializationsAsync||void 0,useAsPostProcess:null!==(t=e.useAsPostProcess)&&void 0!==t&&t},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),e.vertexUrl||e.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)})),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add(()=>{this.bind()}),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()})),this._drawWrapper=new o.a(this.options.engine),this._webGPUReady=1===this.options.shaderLanguage;const n=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,n,this.options.extraInitializations)}}d.ForceGLSL=!1,d._CustomShaderCodeProcessing={}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(121);class r{static GetEffect(e){return void 0===e.getPipelineContext?e.effect:e}setEffect(e,t,n=!0){var i;this.effect=e,void 0!==t&&(this.defines=t),n&&(null===(i=this.drawContext)||void 0===i||i.reset())}dispose(e=!1){var t;if(this.effect){const t=this.effect;e?t.dispose():i.a.SetImmediate(()=>{t.getEngine().onEndFrameObservable.addOnce(()=>{t.dispose()})}),this.effect=null}null===(t=this.drawContext)||void 0===t||t.dispose()}constructor(e,t=!0){this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!0,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(36);const r=(e,t,n)=>e?e.getClassName&&"Mesh"===e.getClassName()?null:!e.getClassName||"SubMesh"!==e.getClassName()&&"PhysicsBody"!==e.getClassName()?e.clone?e.clone():Array.isArray(e)?e.slice():n&&"object"==typeof e?{...e}:null:e.clone(t):null;class s{static DeepCopy(e,t,n,s,a=!1){const o=function(e){const t=[];do{Object.getOwnPropertyNames(e).forEach((function(e){-1===t.indexOf(e)&&t.push(e)}))}while(e=Object.getPrototypeOf(e));return t}(e);for(const l of o){if("_"===l[0]&&(!s||-1===s.indexOf(l)))continue;if(l.endsWith("Observable"))continue;if(n&&-1!==n.indexOf(l))continue;const o=e[l],c=typeof o;if("function"!==c)try{if("object"===c)if(o instanceof Uint8Array)t[l]=Uint8Array.from(o);else if(o instanceof Array){if(t[l]=[],o.length>0)if("object"==typeof o[0])for(let e=0;e<o.length;e++){const n=r(o[e],t,a);-1===t[l].indexOf(n)&&t[l].push(n)}else t[l]=o.slice(0)}else t[l]=r(o,t,a);else t[l]=o}catch(e){i.a.Warn(e.message)}}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(36),r=n(312);class s{get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return void 0!==this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(t=e<=2?e:4,this._uniformLocationPointer%t!=0){const e=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const n=this._uniformLocationPointer-e;for(let e=0;e<n;e++)this._data.push(0)}}addUniform(e,t,n=0){if(this._noUBO)return;if(void 0!==this._uniformLocations[e])return;let i;if(n>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:n},16==t?t*=n:t=t*n+(4-t)*n,i=[];for(let e=0;e<t;e++)i.push(0)}else{if(t instanceof Array)i=t,t=i.length;else{t=t,i=[];for(let e=0;e<t;e++)i.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let e=0;e<t;e++)this._data.push(i[e]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()))}addFloat2(e,t,n){const i=[t,n];this.addUniform(e,i)}addFloat3(e,t,n,i){const r=[t,n,i];this.addUniform(e,r)}addColor3(e,t){const n=[t.r,t.g,t.b];this.addUniform(e,n)}addColor4(e,t,n){const i=[t.r,t.g,t.b,n];this.addUniform(e,i)}addVector3(e,t){const n=[t.x,t.y,t.z];this.addUniform(e,n)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNames(){const e=[];let t=0;for(const n in this._uniformLocations)if(e.push(n),10==++t)break;return e.join(",")}_rebuild(){!this._noUBO&&this._bufferData&&(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}_rebuildAfterContextLost(){this._engine._features.trackUbosInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild()}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}_copyBuffer(e,t){for(let n=0;n<e.length;++n)t[n]=e[n]}update(){if(!this._noUBO)if(this.bindUniformBuffer(),this._buffer)if(this._dynamic||this._needSync){if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1]){if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1]))return this._needSync=!1,void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1])}this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(s._UpdatedUbosInFrame[this._name]||(s._UpdatedUbosInFrame[this._name]=0),s._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}else this._createBufferOnWrite=this._engine._features.trackUbosInFrame;else this.create()}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,n){this._checkNewFrame();let r=this._uniformLocations[e];if(void 0===r){if(this._buffer)return void i.a.Error("Cannot add an uniform after UBO has been created. uniformName="+e);this.addUniform(e,n),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let e=0;e<n;e++)this._bufferData[r+e]=t[e];else{let e=!1;for(let i=0;i<n;i++)(16===n&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[r+i]!==Math.fround(t[i]))&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+i]=t[i]);this._needSync=this._needSync||e}}updateUniformArray(e,t,n){this._checkNewFrame();const s=this._uniformLocations[e];if(void 0===s)return void i.a.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");this._buffer||this.create();const a=this._uniformArraySizes[e];if(this._dynamic)for(let e=0;e<n;e++)this._bufferData[s+e]=t[e];else{let e=!1,i=0,o=0;for(let l=0;l<n;l++)if(this._bufferData[s+4*o+i]!==r.b.FloatRound(t[l])&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+4*o+i]=t[l]),i++,i===a.strideSize){for(;i<4;i++)this._bufferData[s+4*o+i]=0;i=0,o++}this._needSync=this._needSync||e}}_cacheMatrix(e,t){this._checkNewFrame();const n=this._valueCache[e],i=t.updateFlag;return(void 0===n||n!==i)&&(this._valueCache[e]=i,!0)}_updateMatrix3x3ForUniform(e,t){for(let e=0;e<3;e++)s._TempBuffer[4*e]=t[3*e],s._TempBuffer[4*e+1]=t[3*e+1],s._TempBuffer[4*e+2]=t[3*e+2],s._TempBuffer[4*e+3]=0;this.updateUniform(e,s._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let e=0;e<2;e++)s._TempBuffer[4*e]=t[2*e],s._TempBuffer[4*e+1]=t[2*e+1],s._TempBuffer[4*e+2]=0,s._TempBuffer[4*e+3]=0;this.updateUniform(e,s._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){s._TempBuffer[0]=t,this.updateUniform(e,s._TempBuffer,1)}_updateFloat2ForEffect(e,t,n,i=""){this._currentEffect.setFloat2(e+i,t,n)}_updateFloat2ForUniform(e,t,n){s._TempBuffer[0]=t,s._TempBuffer[1]=n,this.updateUniform(e,s._TempBuffer,2)}_updateFloat3ForEffect(e,t,n,i,r=""){this._currentEffect.setFloat3(e+r,t,n,i)}_updateFloat3ForUniform(e,t,n,i){s._TempBuffer[0]=t,s._TempBuffer[1]=n,s._TempBuffer[2]=i,this.updateUniform(e,s._TempBuffer,3)}_updateFloat4ForEffect(e,t,n,i,r,s=""){this._currentEffect.setFloat4(e+s,t,n,i,r)}_updateFloat4ForUniform(e,t,n,i,r){s._TempBuffer[0]=t,s._TempBuffer[1]=n,s._TempBuffer[2]=i,s._TempBuffer[3]=r,this.updateUniform(e,s._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){s._TempBufferInt32View.set(t),this.updateUniformArray(e,s._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){s._TempBufferUInt32View.set(t),this.updateUniformArray(e,s._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){s._TempBuffer[0]=t.x,s._TempBuffer[1]=t.y,s._TempBuffer[2]=t.z,this.updateUniform(e,s._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){s._TempBuffer[0]=t.x,s._TempBuffer[1]=t.y,s._TempBuffer[2]=t.z,s._TempBuffer[3]=t.w,this.updateUniform(e,s._TempBuffer,4)}_updateColor3ForEffect(e,t,n=""){this._currentEffect.setColor3(e+n,t)}_updateColor3ForUniform(e,t){s._TempBuffer[0]=t.r,s._TempBuffer[1]=t.g,s._TempBuffer[2]=t.b,this.updateUniform(e,s._TempBuffer,3)}_updateColor4ForEffect(e,t,n,i=""){this._currentEffect.setColor4(e+i,t,n)}_updateDirectColor4ForEffect(e,t,n=""){this._currentEffect.setDirectColor4(e+n,t)}_updateColor4ForUniform(e,t,n){s._TempBuffer[0]=t.r,s._TempBuffer[1]=t.g,s._TempBuffer[2]=t.b,s._TempBuffer[3]=n,this.updateUniform(e,s._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){s._TempBuffer[0]=t.r,s._TempBuffer[1]=t.g,s._TempBuffer[2]=t.b,s._TempBuffer[3]=t.a,this.updateUniform(e,s._TempBuffer,4)}_updateIntForEffect(e,t,n=""){this._currentEffect.setInt(e+n,t)}_updateIntForUniform(e,t){s._TempBufferInt32View[0]=t,this.updateUniform(e,s._TempBuffer,1)}_updateInt2ForEffect(e,t,n,i=""){this._currentEffect.setInt2(e+i,t,n)}_updateInt2ForUniform(e,t,n){s._TempBufferInt32View[0]=t,s._TempBufferInt32View[1]=n,this.updateUniform(e,s._TempBuffer,2)}_updateInt3ForEffect(e,t,n,i,r=""){this._currentEffect.setInt3(e+r,t,n,i)}_updateInt3ForUniform(e,t,n,i){s._TempBufferInt32View[0]=t,s._TempBufferInt32View[1]=n,s._TempBufferInt32View[2]=i,this.updateUniform(e,s._TempBuffer,3)}_updateInt4ForEffect(e,t,n,i,r,s=""){this._currentEffect.setInt4(e+s,t,n,i,r)}_updateInt4ForUniform(e,t,n,i,r){s._TempBufferInt32View[0]=t,s._TempBufferInt32View[1]=n,s._TempBufferInt32View[2]=i,s._TempBufferInt32View[3]=r,this.updateUniform(e,s._TempBuffer,4)}_updateUIntForEffect(e,t,n=""){this._currentEffect.setUInt(e+n,t)}_updateUIntForUniform(e,t){s._TempBufferUInt32View[0]=t,this.updateUniform(e,s._TempBuffer,1)}_updateUInt2ForEffect(e,t,n,i=""){this._currentEffect.setUInt2(e+i,t,n)}_updateUInt2ForUniform(e,t,n){s._TempBufferUInt32View[0]=t,s._TempBufferUInt32View[1]=n,this.updateUniform(e,s._TempBuffer,2)}_updateUInt3ForEffect(e,t,n,i,r=""){this._currentEffect.setUInt3(e+r,t,n,i)}_updateUInt3ForUniform(e,t,n,i){s._TempBufferUInt32View[0]=t,s._TempBufferUInt32View[1]=n,s._TempBufferUInt32View[2]=i,this.updateUniform(e,s._TempBuffer,3)}_updateUInt4ForEffect(e,t,n,i,r,s=""){this._currentEffect.setUInt4(e+s,t,n,i,r)}_updateUInt4ForUniform(e,t,n,i,r){s._TempBufferUInt32View[0]=t,s._TempBufferUInt32View[1]=n,s._TempBufferUInt32View[2]=i,s._TempBufferUInt32View[3]=r,this.updateUniform(e,s._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}setTextureArray(e,t){this._currentEffect.setTextureArray(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let e=0;e<this._buffers.length;++e){const t=this._buffers[e][0];this._engine._releaseBuffer(t)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}constructor(e,t,n,i,r=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||r,this._dynamic=n,this._name=null!=i?i:"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}}s._UpdatedUbosInFrame={},s._MAX_UNIFORM_SIZE=256,s._TempBuffer=new Float32Array(s._MAX_UNIFORM_SIZE),s._TempBufferInt32View=new Int32Array(s._TempBuffer.buffer),s._TempBufferUInt32View=new Uint32Array(s._TempBuffer.buffer)},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return r}));class i{}i.NAME_EFFECTLAYER="EffectLayer",i.NAME_LAYER="Layer",i.NAME_LENSFLARESYSTEM="LensFlareSystem",i.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",i.NAME_PARTICLESYSTEM="ParticleSystem",i.NAME_GAMEPAD="Gamepad",i.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",i.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",i.NAME_PREPASSRENDERER="PrePassRenderer",i.NAME_DEPTHRENDERER="DepthRenderer",i.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",i.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",i.NAME_SPRITE="Sprite",i.NAME_SUBSURFACE="SubSurface",i.NAME_OUTLINERENDERER="Outline",i.NAME_PROCEDURALTEXTURE="ProceduralTexture",i.NAME_SHADOWGENERATOR="ShadowGenerator",i.NAME_OCTREE="Octree",i.NAME_PHYSICSENGINE="PhysicsEngine",i.NAME_AUDIO="Audio",i.NAME_FLUIDRENDERER="FluidRenderer",i.NAME_IBLCDFGENERATOR="iblCDFGenerator",i.STEP_ISREADYFORMESH_EFFECTLAYER=0,i.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,i.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,i.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,i.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,i.STEP_BEFORECAMERADRAW_PREPASS=0,i.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,i.STEP_BEFORECAMERADRAW_LAYER=2,i.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,i.STEP_BEFORERENDERTARGETDRAW_LAYER=1,i.STEP_BEFORERENDERINGMESH_PREPASS=0,i.STEP_BEFORERENDERINGMESH_OUTLINE=1,i.STEP_AFTERRENDERINGMESH_PREPASS=0,i.STEP_AFTERRENDERINGMESH_OUTLINE=1,i.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,i.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,i.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,i.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,i.STEP_BEFORECLEAR_PREPASS=1,i.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,i.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,i.STEP_AFTERRENDERTARGETDRAW_LAYER=1,i.STEP_AFTERCAMERADRAW_PREPASS=0,i.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,i.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,i.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,i.STEP_AFTERCAMERADRAW_LAYER=4,i.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,i.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,i.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,i.STEP_AFTERRENDER_AUDIO=0,i.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,i.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,i.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,i.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,i.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,i.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,i.STEP_POINTERMOVE_SPRITE=0,i.STEP_POINTERDOWN_SPRITE=0,i.STEP_POINTERUP_SPRITE=0;class r extends Array{static Create(){return Object.create(r.prototype)}registerStep(e,t,n){let i=0,r=Number.MAX_VALUE;for(;i<this.length&&(r=this[i].index,!(e<r));i++);this.splice(i,0,{index:e,component:t,action:n.bind(t)})}clear(){this.length=0}constructor(e){super(...e)}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var i=n(84),r=n(87),s=n(316);class a extends s.a{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){(e.updateFlag!==this._localMatrix.updateFlag||this._needToCompose)&&(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return null===this._index?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const e=this.parent.children.indexOf(this);-1!==e&&this.parent.children.splice(e,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){var e;const t=i.c.Vector3[0],n=i.c.Quaternion[0],r=i.c.Vector3[1];this.getRestMatrix().decompose(t,n,r),this._linkedTransformNode.position.copyFrom(r),this._linkedTransformNode.rotationQuaternion=null!==(e=this._linkedTransformNode.rotationQuaternion)&&void 0!==e?e:i.b.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(n),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=i.e.Zero(),this._localRotation=i.b.Zero(),this._localPosition=i.e.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){this._needToCompose&&(this._localScaling?(this._needToCompose=!1,i.a.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)):this._needToCompose=!1)}updateMatrix(e,t=!0,n=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),n?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let e=0;e<this.children.length;e++)this.children[e]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=0,n,r=!0){const s=this.getLocalMatrix();if(0==t)r?(s.addAtIndex(12,e.x),s.addAtIndex(13,e.y),s.addAtIndex(14,e.z)):s.setTranslationFromFloats(e.x,e.y,e.z);else{let t=null;n&&(t=n.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const o=a._TmpMats[0],l=a._TmpVecs[0];this.parent?n&&t?(o.copyFrom(this.parent.getAbsoluteMatrix()),o.multiplyToRef(t,o)):o.copyFrom(this.parent.getAbsoluteMatrix()):i.a.IdentityToRef(o),r&&o.setTranslationFromFloats(0,0,0),o.invert(),i.e.TransformCoordinatesToRef(e,o,l),r?(s.addAtIndex(12,l.x),s.addAtIndex(13,l.y),s.addAtIndex(14,l.z)):s.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()}translate(e,t=0,n){this._updatePosition(e,t,n,!0)}setPosition(e,t=0,n){this._updatePosition(e,t,n,!1)}setAbsolutePosition(e,t){this.setPosition(e,1,t)}scale(e,t,n,r=!1){const s=this.getLocalMatrix(),o=a._TmpMats[0];i.a.ScalingToRef(e,t,n,o),o.multiplyToRef(s,s),o.invert();for(const i of this.children){const r=i.getLocalMatrix();r.multiplyToRef(o,r),r.multiplyAtIndex(12,e),r.multiplyAtIndex(13,t),r.multiplyAtIndex(14,n),i._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),r)for(const i of this.children)i.scale(e,t,n,r)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,n,r=0,s){if(0===r){const o=a._TmpQuat;return i.b.RotationYawPitchRollToRef(e,t,n,o),void this.setRotationQuaternion(o,r,s)}const o=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(o,s))return;const l=a._TmpMats[1];i.a.RotationYawPitchRollToRef(e,t,n,l),o.multiplyToRef(l,l),this._rotateWithMatrix(l,r,s)}rotate(e,t,n=0,r){const s=a._TmpMats[0];s.setTranslationFromFloats(0,0,0),i.a.RotationAxisToRef(e,t,s),this._rotateWithMatrix(s,n,r)}setAxisAngle(e,t,n=0,r){if(0===n){const s=a._TmpQuat;return i.b.RotationAxisToRef(e,t,s),void this.setRotationQuaternion(s,n,r)}const s=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,r))return;const o=a._TmpMats[1];i.a.RotationAxisToRef(e,t,o),s.multiplyToRef(o,o),this._rotateWithMatrix(o,n,r)}setRotation(e,t=0,n){this.setYawPitchRoll(e.y,e.x,e.z,t,n)}setRotationQuaternion(e,t=0,n){if(0===t)return this._decompose(),this._localRotation.copyFrom(e),void this._markAsDirtyAndCompose();const r=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,n))return;const s=a._TmpMats[1];i.a.FromQuaternionToRef(e,s),r.multiplyToRef(s,s),this._rotateWithMatrix(s,t,n)}setRotationMatrix(e,t=0,n){if(0===t){const r=a._TmpQuat;return i.b.FromRotationMatrixToRef(e,r),void this.setRotationQuaternion(r,t,n)}const r=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,n))return;const s=a._TmpMats[1];s.copyFrom(e),r.multiplyToRef(e,s),this._rotateWithMatrix(s,t,n)}_rotateWithMatrix(e,t=0,n){const i=this.getLocalMatrix(),r=i.m[12],s=i.m[13],o=i.m[14],l=this.getParent(),c=a._TmpMats[3],d=a._TmpMats[4];l&&1==t?(n?(c.copyFrom(n.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteMatrix()),d.copyFrom(c),d.invert(),i.multiplyToRef(c,i),i.multiplyToRef(e,i),i.multiplyToRef(d,i)):1==t&&n?(c.copyFrom(n.getWorldMatrix()),d.copyFrom(c),d.invert(),i.multiplyToRef(c,i),i.multiplyToRef(e,i),i.multiplyToRef(d,i)):i.multiplyToRef(e,i),i.setTranslationFromFloats(r,s,o),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){const n=a._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),i.a.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,n)):i.a.IdentityToRef(n),e.invert(),!isNaN(e.m[0])&&(n.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(n,e),!0)}getPosition(e=0,t=null){const n=i.e.Zero();return this.getPositionToRef(e,t,n),n}getPositionToRef(e=0,t,n){if(0==e){const e=this.getLocalMatrix();n.x=e.m[12],n.y=e.m[13],n.z=e.m[14]}else{let e=null;t&&(e=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let i=a._TmpMats[0];t&&e?(i.copyFrom(this.getAbsoluteMatrix()),i.multiplyToRef(e,i)):i=this.getAbsoluteMatrix(),n.x=i.m[12],n.y=i.m[13],n.z=i.m[14]}}getAbsolutePosition(e=null){const t=i.e.Zero();return this.getPositionToRef(1,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(1,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const e=this._skeleton.getPoseMatrix();e&&this._absoluteMatrix.multiplyToRef(e,this._absoluteMatrix)}const e=this.children,t=e.length;for(let n=0;n<t;n++)e[n].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){const n=i.e.Zero();return this.getDirectionToRef(e,t,n),n}getDirectionToRef(e,t=null,n){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=a._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&r&&s.multiplyToRef(r,s),i.e.TransformNormalToRef(e,s,n),n.normalize()}getRotation(e=0,t=null){const n=i.e.Zero();return this.getRotationToRef(e,t,n),n}getRotationToRef(e=0,t=null,n){const i=a._TmpQuat;this.getRotationQuaternionToRef(e,t,i),i.toEulerAnglesToRef(n)}getRotationQuaternion(e=0,t=null){const n=i.b.Identity();return this.getRotationQuaternionToRef(e,t,n),n}getRotationQuaternionToRef(e=0,t=null,n){if(0==e)this._decompose(),n.copyFrom(this._localRotation);else{const e=a._TmpMats[0],i=this.getAbsoluteMatrix();t?i.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(i),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.decompose(void 0,n,void 0)}}getRotationMatrix(e=0,t){const n=i.a.Identity();return this.getRotationMatrixToRef(e,t,n),n}getRotationMatrixToRef(e=0,t,n){if(0==e)this.getLocalMatrix().getRotationMatrixToRef(n);else{const e=a._TmpMats[0],i=this.getAbsoluteMatrix();t?i.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(i),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.getRotationMatrixToRef(n)}}getAbsolutePositionFromLocal(e,t=null){const n=i.e.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,n),n}getAbsolutePositionFromLocalToRef(e,t=null,n){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=a._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&r&&s.multiplyToRef(r,s),i.e.TransformCoordinatesToRef(e,s,n)}getLocalPositionFromAbsolute(e,t=null){const n=i.e.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,n),n}getLocalPositionFromAbsoluteToRef(e,t=null,n){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=a._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&r&&s.multiplyToRef(r,s),s.invert(),i.e.TransformCoordinatesToRef(e,s,n)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}dispose(){this._linkedTransformNode=null;const e=this._skeleton.bones.indexOf(this);if(-1!==e&&this._skeleton.bones.splice(e,1),this._parentNode&&this._parentNode.children){const e=this._parentNode.children,t=e.indexOf(this);-1!==t&&e.splice(t,1)}super.dispose()}constructor(e,t,n=null,r=null,s=null,a=null,o=null){var l;super(e,t.getScene(),!1),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=null!==(l=null==r?void 0:r.clone())&&void 0!==l?l:i.a.Identity(),this._restMatrix=null!=s?s:this._localMatrix.clone(),this._bindMatrix=null!=a?a:this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new i.a,this._absoluteBindMatrix=new i.a,this._absoluteInverseBindMatrix=new i.a,this._finalMatrix=new i.a,t.bones.push(this),this.setParent(n,!1),this._updateAbsoluteBindMatrices()}}a._TmpVecs=Object(r.a)(2,i.e.Zero),a._TmpQuat=i.b.Identity(),a._TmpMats=Object(r.a)(5,i.a.Identity)},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.clipPlaneFragmentDeclaration="#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nvarying float fClipDistance6;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.clipPlaneFragment="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fClipDistance>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE2\nelse if (fClipDistance2>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE3\nelse if (fClipDistance3>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE4\nelse if (fClipDistance4>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE5\nelse if (fClipDistance5>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE6\nelse if (fClipDistance6>0.0)\n{discard;}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.bonesDeclaration="#if NUM_BONE_INFLUENCERS>0\nattribute vec4 matricesIndices;attribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;attribute vec4 matricesWeightsExtra;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nuniform highp sampler2D boneSampler;uniform float boneTextureWidth;\n#else\nuniform mat4 mBones[BonesPerMesh];\n#endif\n#ifdef BONES_VELOCITY_ENABLED\nuniform mat4 mPreviousBones[BonesPerMesh];\n#endif\n#ifdef BONETEXTURE\n#define inline\nmat4 readMatrixFromRawSampler(sampler2D smp,float index)\n{float offset=index *4.0;float dx=1.0/boneTextureWidth;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));return mat4(m0,m1,m2,m3);}\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform float bakedVertexAnimationTime;uniform vec2 bakedVertexAnimationTextureSizeInverted;uniform vec4 bakedVertexAnimationSettings;uniform sampler2D bakedVertexAnimationTexture;\n#ifdef INSTANCES\nattribute vec4 bakedVertexAnimationSettingsInstanced;\n#endif\n#define inline\nmat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)\n{float offset=index*4.0;float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;float dx=bakedVertexAnimationTextureSizeInverted.x;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));return mat4(m0,m1,m2,m3);}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.morphTargetsVertexGlobalDeclaration="#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#ifdef MORPHTARGETS_TEXTURE \nuniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];uniform vec3 morphTargetTextureInfo;uniform highp sampler2DArray morphTargets;vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)\n{ \nfloat y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV).xyz;}\nvec4 readVector4FromRawSampler(int targetIndex,float vertexIndex)\n{ \nfloat y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV);}\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.morphTargetsVertexDeclaration="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\n#ifdef MORPHTARGETS_POSITION\nattribute vec3 position{X};\n#endif\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#ifdef MORPHTARGETS_UV\nattribute vec2 uv_{X};\n#endif\n#ifdef MORPHTARGETS_UV2\nattribute vec2 uv2_{X};\n#endif\n#elif {X}==0\nuniform int morphTargetCount;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.clipPlaneVertexDeclaration="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;varying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;varying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;varying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;varying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;varying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;varying float fClipDistance6;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.morphTargetsVertexGlobal="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nfloat vertexID;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.morphTargetsVertex="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\n#if {X}==0\nfor (int i=0; i<NUM_MORPH_INFLUENCERS; i++) {if (i>=morphTargetCount) break;vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;\n#ifdef MORPHTARGETS_POSITION\npositionUpdated+=(readVector3FromRawSampler(i,vertexID)-position)*morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASPOSITIONS\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(readVector3FromRawSampler(i,vertexID) -normal)*morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASNORMALS\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(readVector3FromRawSampler(i,vertexID).xy-uv)*morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASUVS\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(readVector3FromRawSampler(i,vertexID) -tangent.xyz)*morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASTANGENTS\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_UV2\nuv2Updated+=(readVector3FromRawSampler(i,vertexID).xy-uv2)*morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASUV2S\nvertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_COLOR\ncolorUpdated+=(readVector4FromRawSampler(i,vertexID)-color)*morphTargetInfluences[i];\n#endif\n}\n#endif\n#else\n#ifdef MORPHTARGETS_POSITION\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV2\nuv2Updated+=(uv2_{X}-uv2)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_COLOR\ncolorUpdated+=(color{X}-color)*morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.instancesVertex="#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nmat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,\npreviousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\nfinalWorld=world*finalWorld;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\nmat4 finalWorld=world;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nmat4 finalPreviousWorld=previousWorld;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.bonesVertex="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];\n#endif\n#else\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\n#define BVASNAME bakedVertexAnimationSettingsInstanced\n#else\n#define BVASNAME bakedVertexAnimationSettings\n#endif\nfloat VATStartFrame=BVASNAME.x;float VATEndFrame=BVASNAME.y;float VATOffsetFrame=BVASNAME.z;float VATSpeed=BVASNAME.w;float totalFrames=VATEndFrame-VATStartFrame+1.0;float time=bakedVertexAnimationTime*VATSpeed/totalFrames;float frameCorrection=time<1.0 ? 0.0 : 1.0;float numOfFrames=totalFrames-frameCorrection;float VATFrameNum=fract(time)*numOfFrames;VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);VATFrameNum=floor(VATFrameNum);VATFrameNum+=VATStartFrame+frameCorrection;mat4 VATInfluence;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.clipPlaneVertex="#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nfClipDistance2=dot(worldPos,vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nfClipDistance3=dot(worldPos,vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nfClipDistance4=dot(worldPos,vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nfClipDistance5=dot(worldPos,vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nfClipDistance6=dot(worldPos,vClipPlane6);\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.clipPlaneFragmentDeclaration="#ifdef CLIPPLANE\nvarying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nvarying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nvarying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nvarying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nvarying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nvarying fClipDistance6: f32;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.clipPlaneFragment="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fragmentInputs.fClipDistance>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE2\nelse if (fragmentInputs.fClipDistance2>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE3\nelse if (fragmentInputs.fClipDistance3>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE4\nelse if (fragmentInputs.fClipDistance4>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE5\nelse if (fragmentInputs.fClipDistance5>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE6\nelse if (fragmentInputs.fClipDistance6>0.0)\n{discard;}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.bonesDeclaration="#if NUM_BONE_INFLUENCERS>0\nattribute matricesIndices : vec4<f32>;attribute matricesWeights : vec4<f32>;\n#if NUM_BONE_INFLUENCERS>4\nattribute matricesIndicesExtra : vec4<f32>;attribute matricesWeightsExtra : vec4<f32>;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nvar boneSampler : texture_2d<f32>;uniform boneTextureWidth : f32;\n#else\nuniform mBones : array<mat4x4,BonesPerMesh>;\n#ifdef BONES_VELOCITY_ENABLED\nuniform mPreviousBones : array<mat4x4,BonesPerMesh>;\n#endif\n#endif\n#ifdef BONETEXTURE\nfn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>\n{let offset=i32(index) *4; \nlet m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform bakedVertexAnimationTime: f32;uniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;uniform bakedVertexAnimationSettings: vec4<f32>;var bakedVertexAnimationTexture : texture_2d<f32>;\n#ifdef INSTANCES\nattribute bakedVertexAnimationSettingsInstanced : vec4<f32>;\n#endif\nfn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>\n{let offset=i32(index)*4;let frameUV=i32(frame);let m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);let m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);let m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);let m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);return mat4x4<f32>(m0,m1,m2,m3);}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.morphTargetsVertexGlobalDeclaration="#ifdef MORPHTARGETS\nuniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;\n#ifdef MORPHTARGETS_TEXTURE \nuniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;uniform morphTargetTextureInfo : vec3<f32>;var morphTargets : texture_2d_array<f32>;var morphTargetsSampler : sampler;fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>\n{ \nlet y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;}\nfn readVector4FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec4<f32>\n{ \nlet y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0);}\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.morphTargetsVertexDeclaration="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\n#ifdef MORPHTARGETS_POSITION\nattribute position{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_NORMAL\nattribute normal{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute tangent{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_UV\nattribute uv_{X} : vec2<f32>;\n#endif\n#ifdef MORPHTARGETS_UV2\nattribute uv2_{X} : vec2<f32>;\n#endif\n#elif {X}==0\nuniform morphTargetCount: i32;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.clipPlaneVertexDeclaration="#ifdef CLIPPLANE\nuniform vClipPlane: vec4<f32>;varying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nuniform vClipPlane2: vec4<f32>;varying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nuniform vClipPlane3: vec4<f32>;varying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nuniform vClipPlane4: vec4<f32>;varying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nuniform vClipPlane5: vec4<f32>;varying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nuniform vClipPlane6: vec4<f32>;varying fClipDistance6: f32;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.morphTargetsVertexGlobal="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nvar vertexID : f32;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.morphTargetsVertex="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\n#if {X}==0\nfor (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (i>=uniforms.morphTargetCount) {break;}\nvertexID=f32(vertexInputs.vertexIndex)*uniforms.morphTargetTextureInfo.x;\n#ifdef MORPHTARGETS_POSITION\npositionUpdated=positionUpdated+(readVector3FromRawSampler(i,vertexID)-vertexInputs.position)*uniforms.morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASPOSITIONS\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated=normalUpdated+(readVector3FromRawSampler(i,vertexID) -vertexInputs.normal)*uniforms.morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASNORMALS\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(readVector3FromRawSampler(i,vertexID).xy-vertexInputs.uv)*uniforms.morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETTEXTURE_HASUVS\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated=vec4f(tangentUpdated.xyz+(readVector3FromRawSampler(i,vertexID) -vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[i],tangentUpdated.a);\n#endif\n#ifdef MORPHTARGETTEXTURE_HASTANGENTS\nvertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_UV2\nuv2Updated=uv2Updated+(readVector3FromRawSampler(i,vertexID).xy-vertexInputs.uv2)*uniforms.morphTargetInfluences[i];\n#endif\n#ifdef MORPHTARGETS_COLOR\ncolorUpdated=colorUpdated+(readVector4FromRawSampler(i,vertexID)-vertexInputs.color)*uniforms.morphTargetInfluences[i];\n#endif\n}\n#endif\n#else\n#ifdef MORPHTARGETS_POSITION\npositionUpdated=positionUpdated+(vertexInputs.position{X}-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated=normalUpdated+(vertexInputs.normal{X}-vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated=vec4f(tangentUpdated.xyz+(vertexInputs.tangent{X}-vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}],tangentUpdated.a);\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(vertexInputs.uv_{X}-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV2\nuv2Updated=uv2Updated+(vertexInputs.uv2_{X}-vertexInputs.uv2)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_COLOR\ncolorUpdated=colorUpdated+(vertexInputs.color{X}-vertexInputs.color)*uniforms.morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.instancesVertex="#ifdef INSTANCES\nvar finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nvar finalPreviousWorld=mat4x4<f32>(\nvertexInputs.previousWorld0,vertexInputs.previousWorld1,\nvertexInputs.previousWorld2,vertexInputs.previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\n#if !defined(WORLD_UBO)\nfinalWorld=uniforms.world*finalWorld;\n#else\nfinalWorld=mesh.world*finalWorld;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nfinalPreviousWorld=uniforms.previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nvar finalWorld=uniforms.world;\n#else\nvar finalWorld=mesh.world;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nvar finalPreviousWorld=uniforms.previousWorld;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.bonesVertex="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nvar influence : mat4x4<f32>;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[0])*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[1])*vertexInputs.matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[2])*vertexInputs.matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[3])*vertexInputs.matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[0])*vertexInputs.matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[1])*vertexInputs.matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[2])*vertexInputs.matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[3])*vertexInputs.matricesWeightsExtra[3];\n#endif \n#else \ninfluence=uniforms.mBones[int(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];\n#endif \n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\nlet VATStartFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.x;let VATEndFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.y;let VATOffsetFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.z;let VATSpeed: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.w;\n#else\nlet VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;let VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;let VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;let VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;\n#endif\nlet totalFrames: f32=VATEndFrame-VATStartFrame+1.0;let time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;let frameCorrection: f32=select(1.0,0.0,time<1.0);let numOfFrames: f32=totalFrames-frameCorrection;var VATFrameNum: f32=fract(time)*numOfFrames;VATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;VATFrameNum=floor(VATFrameNum);VATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;var VATInfluence : mat4x4<f32>;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[0],VATFrameNum)*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[1],VATFrameNum)*vertexInputs.matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[2],VATFrameNum)*vertexInputs.matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[3],VATFrameNum)*vertexInputs.matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[0],VATFrameNum)*vertexInputs.matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[1],VATFrameNum)*vertexInputs.matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[2],VATFrameNum)*vertexInputs.matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[3],VATFrameNum)*vertexInputs.matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.clipPlaneVertex="#ifdef CLIPPLANE\nvertexOutputs.fClipDistance=dot(worldPos,uniforms.vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nvertexOutputs.fClipDistance2=dot(worldPos,uniforms.vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nvertexOutputs.fClipDistance3=dot(worldPos,uniforms.vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nvertexOutputs.fClipDistance4=dot(worldPos,uniforms.vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nvertexOutputs.fClipDistance5=dot(worldPos,uniforms.vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nvertexOutputs.fClipDistance6=dot(worldPos,uniforms.vClipPlane6);\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.mainUVVaryingDeclaration="#ifdef MAINUV{X}\nvarying vMainUV{X}: vec2f;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.logDepthDeclaration="#ifdef LOGARITHMICDEPTH\nuniform logarithmicDepthConstant: f32;varying vFragmentDepth: f32;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.mainUVVaryingDeclaration="#ifdef MAINUV{X}\nvarying vec2 vMainUV{X};\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.logDepthDeclaration="#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;varying float vFragmentDepth;\n#endif\n"},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var i=n(52),r=n(62),s=n(44),a=n(173);class o{sampleFrame(e=a.a.Now){if(this._enabled){if(null!=this._lastFrameTimeMs){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return 0===e?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}constructor(e=30){this._enabled=!0,this._rollingFrameTime=new l(e)}}class l{add(e){let t;if(this.isSaturated()){const e=this._samples[this._pos];t=e-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(e-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}constructor(e){this._samples=new Array(e),this.reset()}}var c=n(145),d=n(36),h=n(101);s.ThinEngine.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode!==e){switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}t||(this.depthCullingState.depthMask=0===e),this._alphaMode=e}else if(!t){const t=0===e;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}};var u=n(140);function f(e,t,n,i){let r,s=1;1===i?r=new Float32Array(t*n*4):2===i?(r=new Uint16Array(t*n*4),s=15360):r=7===i?new Uint32Array(t*n*4):new Uint8Array(t*n*4);for(let i=0;i<t;i++)for(let a=0;a<n;a++){const n=3*(a*t+i),o=4*(a*t+i);r[o+0]=e[n+0],r[o+1]=e[n+1],r[o+2]=e[n+2],r[o+3]=s}return r}function m(e){return function(t,n,r,s,a,o,l,c,d=null,h=0){const u=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,f=e?10:11,m=new i.a(this,f);m.baseWidth=n,m.baseHeight=r,m.baseDepth=s,m.width=n,m.height=r,m.depth=s,m.format=a,m.type=h,m.generateMipMaps=o,m.samplingMode=c,e?m.is3D=!0:m.is2DArray=!0,this._doNotHandleContextLost||(m._bufferView=t),e?this.updateRawTexture3D(m,t,a,l,d,h):this.updateRawTexture2DArray(m,t,a,l,d,h),this._bindTextureDirectly(u,m,!0);const p=this._getSamplingParameters(c,o);return this._gl.texParameteri(u,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(u,this._gl.TEXTURE_MIN_FILTER,p.min),o&&this._gl.generateMipmap(u),this._bindTextureDirectly(u,null),this._internalTexturesCache.push(m),m}}function p(e){return function(t,n,i,r,s=null,a=0){const o=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(a),c=this._getInternalFormat(i),d=this._getRGBABufferInternalSizedFormat(a,i);this._bindTextureDirectly(o,t,!0),this._unpackFlipY(void 0===r||!!r),this._doNotHandleContextLost||(t._bufferView=n,t.format=i,t.invertY=r,t._compression=s),t.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&n?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[s],t.width,t.height,t.depth,0,n):this._gl.texImage3D(o,0,d,t.width,t.height,t.depth,0,c,l,n),t.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),t.isReady=!0}}s.ThinEngine.prototype.updateRawTexture=function(e,t,n,i,r=null,s=0,a=!1){if(!e)return;const o=this._getRGBABufferInternalSizedFormat(s,n,a),l=this._getInternalFormat(n),c=this._getWebGLTextureType(s);this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===i||!!i),this._doNotHandleContextLost||(e._bufferView=t,e.format=n,e.type=s,e.invertY=i,e._compression=r),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&t?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],e.width,e.height,0,t):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,e.width,e.height,0,l,c,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0},s.ThinEngine.prototype.createRawTexture=function(e,t,n,r,s,a,o,l=null,c=0,d=0,h=!1){const u=new i.a(this,3);u.baseWidth=t,u.baseHeight=n,u.width=t,u.height=n,u.format=r,u.generateMipMaps=s,u.samplingMode=o,u.invertY=a,u._compression=l,u.type=c,u._useSRGBBuffer=this._getUseSRGBBuffer(h,!s),this._doNotHandleContextLost||(u._bufferView=e),this.updateRawTexture(u,e,r,a,l,c,u._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,u,!0);const f=this._getSamplingParameters(o,s);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,f.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,f.min),s&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(u),u},s.ThinEngine.prototype.createRawCubeTexture=function(e,t,n,r,s,a,o,l=null){const c=this._gl,h=new i.a(this,8);h.isCube=!0,h.format=n,h.type=r,this._doNotHandleContextLost||(h._bufferViewArray=e);const f=this._getWebGLTextureType(r);let m=this._getInternalFormat(n);m===c.RGB&&(m=c.RGBA),f!==c.FLOAT||this._caps.textureFloatLinearFiltering?f!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?f!==c.FLOAT||this._caps.textureFloatRender?f!==c.HALF_FLOAT||this._caps.colorBufferFloat||(s=!1,d.a.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(s=!1,d.a.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(s=!1,o=1,d.a.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(s=!1,o=1,d.a.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const p=t,g=p;if(h.width=p,h.height=g,h.invertY=a,h._compression=l,!this.needPOTTextures||Object(u.c)(h.width)&&Object(u.c)(h.height)||(s=!1),e)this.updateRawCubeTexture(h,e,n,r,a,l);else{const e=this._getRGBABufferInternalSizedFormat(r),t=0;this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,h,!0);for(let n=0;n<6;n++)l?c.compressedTexImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+n,t,this.getCaps().s3tc[l],h.width,h.height,0,void 0):c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+n,t,e,h.width,h.height,0,m,f,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,h,!0),e&&s&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const _=this._getSamplingParameters(o,s);return c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MAG_FILTER,_.mag),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MIN_FILTER,_.min),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,null),h.generateMipMaps=s,h.samplingMode=o,h.isReady=!0,h},s.ThinEngine.prototype.updateRawCubeTexture=function(e,t,n,i,r,s=null,a=0){e._bufferViewArray=t,e.format=n,e.type=i,e.invertY=r,e._compression=s;const o=this._gl,l=this._getWebGLTextureType(i);let c=this._getInternalFormat(n);const d=this._getRGBABufferInternalSizedFormat(i);let h=!1;c===o.RGB&&(c=o.RGBA,h=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(void 0===r||!!r),e.width%4!=0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let n=0;n<6;n++){let r=t[n];s?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+n,a,this.getCaps().s3tc[s],e.width,e.height,0,r):(h&&(r=f(r,e.width,e.height,i)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+n,a,d,e.width,e.height,0,c,l,r))}(!this.needPOTTextures||Object(u.c)(e.width)&&Object(u.c)(e.height))&&e.generateMipMaps&&0===a&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),e.isReady=!0},s.ThinEngine.prototype.createRawCubeTextureFromUrl=function(e,t,n,i,r,s,a,o,l=null,c=null,d=3,h=!1){const u=this._gl,m=this.createRawCubeTexture(null,n,i,r,!s,h,d,null);null==t||t.addPendingData(m),m.url=e,m.isReady=!1,this._internalTexturesCache.push(m);const p=e=>{if(!m._hardwareTexture)return;const n=m.width,s=a(e);if(s){if(o){const e=this._getWebGLTextureType(r);let t=this._getInternalFormat(i);const a=this._getRGBABufferInternalSizedFormat(r);let l=!1;t===u.RGB&&(t=u.RGBA,l=!0),this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,m,!0),this._unpackFlipY(!1);const c=o(s);for(let i=0;i<c.length;i++){const s=n>>i;for(let n=0;n<6;n++){let o=c[i][n];l&&(o=f(o,s,s,r)),u.texImage2D(n,i,a,s,s,0,t,e,o)}}this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(m,s,i,r,h);m.isReady=!0,null==t||t.removePendingData(m),m.onLoadedObservable.notifyObservers(m),m.onLoadedObservable.clear(),l&&l()}};return this._loadFile(e,e=>{p(e)},void 0,null==t?void 0:t.offlineProvider,!0,(e,n)=>{null==t||t.removePendingData(m),c&&e&&c(e.status+" "+e.statusText,n)}),m},s.ThinEngine.prototype.createRawTexture2DArray=m(!1),s.ThinEngine.prototype.createRawTexture3D=m(!0),s.ThinEngine.prototype.updateRawTexture2DArray=p(!1),s.ThinEngine.prototype.updateRawTexture3D=p(!0),n(185),n(186),s.ThinEngine.prototype._createDepthStencilCubeTexture=function(e,t){const n=new i.a(this,12);if(n.isCube=!0,1===this.webGLVersion)return d.a.Error("Depth cube texture is not supported by WebGL 1."),n;const r={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...t},s=this._gl;this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,n,!0),this._setupDepthStencilTexture(n,e,r.bilinearFiltering,r.comparisonFunction);for(let t=0;t<6;t++)r.generateStencil?s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,s.DEPTH24_STENCIL8,e,e,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,s.DEPTH_COMPONENT24,e,e,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null);return this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(n),n},s.ThinEngine.prototype._setCubeMapTextureParams=function(e,t,n){const i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),e.samplingMode=t?3:2,t&&this.getCaps().textureMaxLevel&&void 0!==n&&n>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,n),e._maxLodLevel=n),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)},s.ThinEngine.prototype.createCubeTexture=function(e,t,n,i,r=null,s=null,a,o=null,l=!1,c=0,h=0,f=null,m,p=!1,g=null){const _=this._gl;return this.createCubeTextureBase(e,t,n,!!i,r,s,a,o,l,c,h,f,e=>this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,e,!0),(e,t)=>{const n=this.needPOTTextures?Object(u.b)(t[0].width,this._caps.maxCubemapTextureSize):t[0].width,s=n,o=[_.TEXTURE_CUBE_MAP_POSITIVE_X,_.TEXTURE_CUBE_MAP_POSITIVE_Y,_.TEXTURE_CUBE_MAP_POSITIVE_Z,_.TEXTURE_CUBE_MAP_NEGATIVE_X,_.TEXTURE_CUBE_MAP_NEGATIVE_Y,_.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(!1);const l=a?this._getInternalFormat(a,e._useSRGBBuffer):e._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:_.RGBA;let c=a?this._getInternalFormat(a):_.RGBA;e._useSRGBBuffer&&1===this.webGLVersion&&(c=l);for(let e=0;e<o.length;e++)if(t[e].width!==n||t[e].height!==s){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void d.a.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=n,this._workingCanvas.height=s,this._workingContext.drawImage(t[e],0,0,t[e].width,t[e].height,0,0,n,s),_.texImage2D(o[e],0,l,c,_.UNSIGNED_BYTE,this._workingCanvas)}else _.texImage2D(o[e],0,l,c,_.UNSIGNED_BYTE,t[e]);i||_.generateMipmap(_.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(e,!i),e.width=n,e.height=s,e.isReady=!0,a&&(e.format=a),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r()},!!p,g)},s.ThinEngine.prototype.generateMipMapsForCubemap=function(e,t=!0){if(e.generateMipMaps){const n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,e,!0),n.generateMipmap(n.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null)}},n(189),s.ThinEngine.prototype.setDepthStencilTexture=function(e,t,n,i){void 0!==e&&(t&&(this._boundUniforms[e]=t),n&&n.depthStencilTexture?this._setTexture(e,n,!1,!0,i):this._setTexture(e,null,void 0,void 0,i))},s.ThinEngine.prototype.createRenderTargetCubeTexture=function(e,t){const n=this._createHardwareRenderTargetWrapper(!1,!0,e),r={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...t};r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,(1!==r.type||this._caps.textureFloatLinearFiltering)&&(2!==r.type||this._caps.textureHalfFloatLinearFiltering)||(r.samplingMode=1);const s=this._gl,a=new i.a(this,5);this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,a,!0);const o=this._getSamplingParameters(r.samplingMode,r.generateMipMaps);1!==r.type||this._caps.textureFloat||(r.type=0,d.a.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,o.mag),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,o.min),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);for(let t=0;t<6;t++)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this._getRGBABufferInternalSizedFormat(r.type,r.format),e,e,0,this._getInternalFormat(r.format),this._getWebGLTextureType(r.type),null);const l=s.createFramebuffer();return this._bindUnboundFramebuffer(l),n._depthStencilBuffer=this._setupFramebufferDepthAttachments(r.generateStencilBuffer,r.generateDepthBuffer,e,e),r.generateMipMaps&&s.generateMipmap(s.TEXTURE_CUBE_MAP),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),n._framebuffer=l,n._generateDepthBuffer=r.generateDepthBuffer,n._generateStencilBuffer=r.generateStencilBuffer,a.width=e,a.height=e,a.isReady=!0,a.isCube=!0,a.samples=1,a.generateMipMaps=r.generateMipMaps,a.samplingMode=r.samplingMode,a.type=r.type,a.format=r.format,this._internalTexturesCache.push(a),n.setTextures(a),n};var g=n(331),_=n(332);s.ThinEngine.prototype.createPrefilteredCubeTexture=function(e,t,r,s,a=null,o=null,l,c=null,h=!0){return this.createCubeTexture(e,t,null,!1,async e=>{if(!e)return void(a&&a(null));const o=e.texture;if(h?e.info.sphericalPolynomial&&(o._sphericalPolynomial=e.info.sphericalPolynomial):o._sphericalPolynomial=new g.b,o._source=9,this.getCaps().textureLOD)return void(a&&a(o));const l=this._gl,c=e.width;if(!c)return;const{DDSTools:u}=await n.e(0).then(n.bind(null,390)),f=[];for(let n=0;n<3;n++){const a=1-n/2,h=s,m=Math.log2(c)*r+s,p=h+(m-h)*a,g=Math.round(Math.min(Math.max(p,0),m)),v=new i.a(this,2);if(v.type=o.type,v.format=o.format,v.width=Math.pow(2,Math.max(Math.log2(c)-g,0)),v.height=v.width,v.isCube=!0,v._cachedWrapU=0,v._cachedWrapV=0,this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,v,!0),v.samplingMode=2,l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),e.isDDS){const t=e.info,n=e.data;this._unpackFlipY(t.isCompressed),u.UploadDDSLevels(this,v,n,t,!0,6,g)}else d.a.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null);const E=new _.a(t);E._isCube=!0,E._texture=v,v.isReady=!0,f.push(E)}o._lodTextureHigh=f[2],o._lodTextureMid=f[1],o._lodTextureLow=f[0],a&&a(o)},o,l,c,h,r,s)},s.ThinEngine.prototype.createUniformBuffer=function(e,t){const n=this._gl.createBuffer();if(!n)throw new Error("Unable to create uniform buffer");const i=new c.a(n);return this.bindUniformBuffer(i),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),i.references=1,i},s.ThinEngine.prototype.createDynamicUniformBuffer=function(e,t){const n=this._gl.createBuffer();if(!n)throw new Error("Unable to create dynamic uniform buffer");const i=new c.a(n);return this.bindUniformBuffer(i),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),i.references=1,i},s.ThinEngine.prototype.updateUniformBuffer=function(e,t,n,i){this.bindUniformBuffer(e),void 0===n&&(n=0),void 0===i?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,n,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,n,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(n,n+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(n,n+i)),this.bindUniformBuffer(null)},s.ThinEngine.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null)},s.ThinEngine.prototype.bindUniformBufferBase=function(e,t,n){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e?e.underlyingResource:null)},s.ThinEngine.prototype.bindUniformBlock=function(e,t,n){const i=e.program,r=this._gl.getUniformBlockIndex(i,t);4294967295!==r&&this._gl.uniformBlockBinding(i,r,n)};var v=n(48),E=n(100);E.a.prototype.displayLoadingUI=function(){if(!Object(v.d)())return;const e=this.loadingScreen;e&&e.displayLoadingUI()},E.a.prototype.hideLoadingUI=function(){if(!Object(v.d)())return;const e=this._loadingScreen;e&&e.hideLoadingUI()},Object.defineProperty(E.a.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=E.a.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(e){this._loadingScreen=e},enumerable:!0,configurable:!0}),Object.defineProperty(E.a.prototype,"loadingUIText",{set:function(e){this.loadingScreen.loadingUIText=e},enumerable:!0,configurable:!0}),Object.defineProperty(E.a.prototype,"loadingUIBackgroundColor",{set:function(e){this.loadingScreen.loadingUIBackgroundColor=e},enumerable:!0,configurable:!0}),E.a.prototype.getInputElement=function(){return this._renderingCanvas},E.a.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},E.a.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},E.a.prototype.getAspectRatio=function(e,t=!1){const n=e.viewport;return this.getRenderWidth(t)*n.width/(this.getRenderHeight(t)*n.height)},E.a.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},E.a.prototype._verifyPointerLock=function(){var e;null===(e=this._onPointerLockChange)||void 0===e||e.call(this)},E.a.prototype.setAlphaEquation=function(e){if(this._alphaEquation!==e){switch(e){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=e}},E.a.prototype.getInputElement=function(){return this._renderingCanvas},E.a.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},E.a.prototype.setDepthFunction=function(e){this._depthCullingState.depthFunc=e},E.a.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},E.a.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},E.a.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},E.a.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},E.a.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},E.a.prototype.setDepthWrite=function(e){this._depthCullingState.depthMask=e},E.a.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},E.a.prototype.setStencilBuffer=function(e){this._stencilState.stencilTest=e},E.a.prototype.getStencilMask=function(){return this._stencilState.stencilMask},E.a.prototype.setStencilMask=function(e){this._stencilState.stencilMask=e},E.a.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},E.a.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},E.a.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},E.a.prototype.setStencilFunction=function(e){this._stencilState.stencilFunc=e},E.a.prototype.setStencilFunctionReference=function(e){this._stencilState.stencilFuncRef=e},E.a.prototype.setStencilFunctionMask=function(e){this._stencilState.stencilFuncMask=e},E.a.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},E.a.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},E.a.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},E.a.prototype.setStencilOperationFail=function(e){this._stencilState.stencilOpStencilFail=e},E.a.prototype.setStencilOperationDepthFail=function(e){this._stencilState.stencilOpDepthFail=e},E.a.prototype.setStencilOperationPass=function(e){this._stencilState.stencilOpStencilDepthPass=e},E.a.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},E.a.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},E.a.prototype.setAlphaConstants=function(e,t,n,i){this._alphaState.setAlphaBlendConstants(e,t,n,i)},E.a.prototype.getAlphaMode=function(){return this._alphaMode},E.a.prototype.getAlphaEquation=function(){return this._alphaEquation},E.a.prototype.getRenderPassNames=function(){return this._renderPassNames},E.a.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},E.a.prototype.createRenderPassId=function(e){const t=++E.a._RenderPassIdCounter;return this._renderPassNames[t]=null!=e?e:"NONAME",t},E.a.prototype.releaseRenderPassId=function(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const n=this.scenes[t];for(let t=0;t<n.meshes.length;++t){const i=n.meshes[t];if(i.subMeshes)for(let t=0;t<i.subMeshes.length;++t)i.subMeshes[t]._removeDrawWrapper(e)}}},n(184);var T=n(395),S=n(396),A=(n(397),n(121));class b extends s.ThinEngine{static get NpmPackage(){return E.a.NpmPackage}static get Version(){return E.a.Version}static get Instances(){return r.a.Instances}static get LastCreatedEngine(){return r.a.LastCreatedEngine}static get LastCreatedScene(){return r.a.LastCreatedScene}static DefaultLoadingScreenFactory(e){return E.a.DefaultLoadingScreenFactory(e)}get _supportsHardwareTextureRescaling(){return!!b._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),Object(T.i)(this,e,this._creationOptions)}resizeImageBitmap(e,t,n){return Object(T.g)(this,e,t,n)}_createImageBitmapFromSource(e,t){return Object(T.a)(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&Object(T.e)(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&Object(T.b)()}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(e,t,n,i){const r=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,n,i),r}scissorClear(e,t,n,i,r){this.enableScissor(e,t,n,i),this.clear(r,!0,!0,!0),this.disableScissor()}enableScissor(e,t,n,i){const r=this._gl;r.enable(r.SCISSOR_TEST),r.scissor(e,t,n,i)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_loadFileAsync(e,t,n){return new Promise((i,r)=>{this._loadFile(e,e=>{i(e)},void 0,t,n,(e,t)=>{r(t)})})}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries();super._rebuildBuffers()}getFontOffset(e){return Object(T.d)(e)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}}else super._cancelFrame()}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&Object(T.f)(this._renderingCanvas)}exitPointerlock(){Object(T.c)()}beginFrame(){this._measureFps(),super.beginFrame()}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,n,i,r,s=null){r=r||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const a=super.createShaderProgram(e,t,n,i,r,s);return this.onAfterShaderCompilationObservable.notifyObservers(this),a}_createShaderProgram(e,t,n,i,r=null){const s=i.createProgram();if(e.program=s,!s)throw new Error("Unable to create program");if(i.attachShader(s,t),i.attachShader(s,n),this.webGLVersion>1&&r){const t=this.createTransformFeedback();this.bindTransformFeedback(t),this.setTranformFeedbackVaryings(s,r),e.transformFeedback=t}return i.linkProgram(s),this.webGLVersion>1&&r&&this.bindTransformFeedback(null),e.context=i,e.vertexShader=t,e.fragmentShader=n,e.isParallelCompiled||this._finalizePipelineContext(e),s}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach(t=>{t.postProcesses.forEach(t=>{t._outputTexture===e&&(t._outputTexture=null)}),t.cameras.forEach(t=>{t._postProcesses.forEach(t=>{t&&t._outputTexture===e&&(t._outputTexture=null)})})})}_rescaleTexture(e,t,n,i,r){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const s=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&b._RescalePostProcessFactory&&(this._rescalePostProcess=b._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const a=()=>{this._rescalePostProcess.onApply=function(t){t._bindTexture("textureSampler",e)};let a=n;a||(a=this.scenes[this.scenes.length-1]),a.postProcessManager.directRender([this._rescalePostProcess],s,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,i,0,0,t.width,t.height,0),this.unBindFramebuffer(s),s.dispose(),r&&r()},o=this._rescalePostProcess.getEffect();o?o.executeWhenCompiled(a):this._rescalePostProcess.onEffectCreatedObservable.addOnce(e=>{e.executeWhenCompiled(a)})}}wrapWebGLTexture(e,t=!1,n=3,r=0,s=0){const a=new h.a(e,this._gl),o=new i.a(this,0,!0);return o._hardwareTexture=a,o.baseWidth=r,o.baseHeight=s,o.width=r,o.height=s,o.isReady=!0,o.useMipMaps=t,this.updateTextureSamplingMode(n,o),o}_uploadImageToTexture(e,t,n=0,i=0){const r=this._gl,s=this._getWebGLTextureType(e.type),a=this._getInternalFormat(e.format),o=this._getRGBABufferInternalSizedFormat(e.type,a),l=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(l,e,!0),this._unpackFlipY(e.invertY);let c=r.TEXTURE_2D;e.isCube&&(c=r.TEXTURE_CUBE_MAP_POSITIVE_X+n),r.texImage2D(c,i,o,a,s,t),this._bindTextureDirectly(l,null,!0)}updateTextureComparisonFunction(e,t){if(1===this.webGLVersion)return void d.a.Error("WebGL 1 does not support texture comparison.");const n=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),0===t?(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,t),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),0===t?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const n=new c.a(t);return n.capacity=e,this.bindArrayBuffer(n),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),n.references=1,n}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,n=10){const i=this._gl;return new Promise((r,s)=>{Object(A.b)(()=>{const n=i.clientWaitSync(e,t,0);if(n==i.WAIT_FAILED)throw new Error("clientWaitSync failed");return n!=i.TIMEOUT_EXPIRED},r,s,n)})}_readPixelsAsync(e,t,n,i,r,s,a){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const o=this._gl,l=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,l),o.bufferData(o.PIXEL_PACK_BUFFER,a.byteLength,o.STREAM_READ),o.readPixels(e,t,n,i,r,s,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null);const c=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);return c?(o.flush(),this._clientWaitAsync(c,0,10).then(()=>(o.deleteSync(c),o.bindBuffer(o.PIXEL_PACK_BUFFER,l),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,a),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),o.deleteBuffer(l),a))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),Object(T.h)(this,this._renderingCanvas),super.dispose()}constructor(e,t,n,i=!1){super(e,t,n,i),this.customAnimationFrameRequester=null,this._performanceMonitor=new o,this._drawCalls=new S.a,e&&(this._features.supportRenderPasses=!0,n=this._creationOptions)}}b.ALPHA_DISABLE=0,b.ALPHA_ADD=1,b.ALPHA_COMBINE=2,b.ALPHA_SUBTRACT=3,b.ALPHA_MULTIPLY=4,b.ALPHA_MAXIMIZED=5,b.ALPHA_ONEONE=6,b.ALPHA_PREMULTIPLIED=7,b.ALPHA_PREMULTIPLIED_PORTERDUFF=8,b.ALPHA_INTERPOLATE=9,b.ALPHA_SCREENMODE=10,b.DELAYLOADSTATE_NONE=0,b.DELAYLOADSTATE_LOADED=1,b.DELAYLOADSTATE_LOADING=2,b.DELAYLOADSTATE_NOTLOADED=4,b.NEVER=512,b.ALWAYS=519,b.LESS=513,b.EQUAL=514,b.LEQUAL=515,b.GREATER=516,b.GEQUAL=518,b.NOTEQUAL=517,b.KEEP=7680,b.REPLACE=7681,b.INCR=7682,b.DECR=7683,b.INVERT=5386,b.INCR_WRAP=34055,b.DECR_WRAP=34056,b.TEXTURE_CLAMP_ADDRESSMODE=0,b.TEXTURE_WRAP_ADDRESSMODE=1,b.TEXTURE_MIRROR_ADDRESSMODE=2,b.TEXTUREFORMAT_ALPHA=0,b.TEXTUREFORMAT_LUMINANCE=1,b.TEXTUREFORMAT_LUMINANCE_ALPHA=2,b.TEXTUREFORMAT_RGB=4,b.TEXTUREFORMAT_RGBA=5,b.TEXTUREFORMAT_RED=6,b.TEXTUREFORMAT_R=6,b.TEXTUREFORMAT_R16_UNORM=33322,b.TEXTUREFORMAT_RG16_UNORM=33324,b.TEXTUREFORMAT_RGB16_UNORM=32852,b.TEXTUREFORMAT_RGBA16_UNORM=32859,b.TEXTUREFORMAT_R16_SNORM=36760,b.TEXTUREFORMAT_RG16_SNORM=36761,b.TEXTUREFORMAT_RGB16_SNORM=36762,b.TEXTUREFORMAT_RGBA16_SNORM=36763,b.TEXTUREFORMAT_RG=7,b.TEXTUREFORMAT_RED_INTEGER=8,b.TEXTUREFORMAT_R_INTEGER=8,b.TEXTUREFORMAT_RG_INTEGER=9,b.TEXTUREFORMAT_RGB_INTEGER=10,b.TEXTUREFORMAT_RGBA_INTEGER=11,b.TEXTURETYPE_UNSIGNED_BYTE=0,b.TEXTURETYPE_UNSIGNED_INT=0,b.TEXTURETYPE_FLOAT=1,b.TEXTURETYPE_HALF_FLOAT=2,b.TEXTURETYPE_BYTE=3,b.TEXTURETYPE_SHORT=4,b.TEXTURETYPE_UNSIGNED_SHORT=5,b.TEXTURETYPE_INT=6,b.TEXTURETYPE_UNSIGNED_INTEGER=7,b.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,b.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,b.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,b.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,b.TEXTURETYPE_UNSIGNED_INT_24_8=12,b.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,b.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,b.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,b.TEXTURE_NEAREST_SAMPLINGMODE=1,b.TEXTURE_BILINEAR_SAMPLINGMODE=2,b.TEXTURE_TRILINEAR_SAMPLINGMODE=3,b.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,b.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,b.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,b.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,b.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,b.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,b.TEXTURE_NEAREST_LINEAR=7,b.TEXTURE_NEAREST_NEAREST=1,b.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,b.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,b.TEXTURE_LINEAR_LINEAR=2,b.TEXTURE_LINEAR_NEAREST=12,b.TEXTURE_EXPLICIT_MODE=0,b.TEXTURE_SPHERICAL_MODE=1,b.TEXTURE_PLANAR_MODE=2,b.TEXTURE_CUBIC_MODE=3,b.TEXTURE_PROJECTION_MODE=4,b.TEXTURE_SKYBOX_MODE=5,b.TEXTURE_INVCUBIC_MODE=6,b.TEXTURE_EQUIRECTANGULAR_MODE=7,b.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,b.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,b.SCALEMODE_FLOOR=1,b.SCALEMODE_NEAREST=2,b.SCALEMODE_CEILING=3},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"d",(function(){return r})),n.d(t,"c",(function(){return s})),n.d(t,"b",(function(){return a}));const i=e=>{if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let n=0;n<e.byteLength;n++)t+=String.fromCharCode(e[n]);return t},r=e=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let n,i,r,s,a,o,l,c="",d=0;const h=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);for(;d<h.length;)n=h[d++],i=d<h.length?h[d++]:Number.NaN,r=d<h.length?h[d++]:Number.NaN,s=n>>2,a=(3&n)<<4|i>>4,o=(15&i)<<2|r>>6,l=63&r,isNaN(i)?o=l=64:isNaN(r)&&(l=64),c+=t.charAt(s)+t.charAt(a)+t.charAt(o)+t.charAt(l);return c},s=e=>atob(e),a=e=>{const t=s(e),n=t.length,i=new Uint8Array(new ArrayBuffer(n));for(let e=0;e<n;e++)i[e]=t.charCodeAt(e);return i.buffer}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(165),r=n(43);class s{_prepareBuffers(){if(this._vertexBuffers[i.b.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[i.b.PositionKind]=new i.b(this._scene.getEngine(),e,i.b.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[i.b.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const n=this._scene.activeCamera;return!(!n||!(t=t||n._postProcesses.filter(e=>null!=e))||0===t.length||!this._scene.postProcessesEnabled||(t[0].activate(n,e,null!=t),0))}directRender(e,t=null,n=!1,i=0,r=0,s=!1){const a=this._scene.getEngine();for(let l=0;l<e.length;l++){var o;l<e.length-1?e[l+1].activate(this._scene.activeCamera||this._scene,null==t?void 0:t.texture):(t?a.bindFramebuffer(t,i,void 0,void 0,n,r):s||a.restoreDefaultFramebuffer(),null===(o=a._debugInsertMarker)||void 0===o||o.call(a,`post process ${e[l].name} output`));const c=e[l],d=c.apply();d&&(c.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,d),a.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(d))}a.setDepthBuffer(!0),a.setDepthWrite(!0)}_finalizeFrame(e,t,n,i,r=!1){const s=this._scene.activeCamera;if(!s)return;if(this.onBeforeRenderObservable.notifyObservers(this),0===(i=i||s._postProcesses.filter(e=>null!=e)).length||!this._scene.postProcessesEnabled)return;const a=this._scene.getEngine();for(let l=0,c=i.length;l<c;l++){const d=i[l];var o;if(l<c-1?d._outputTexture=i[l+1].activate(s,null==t?void 0:t.texture):(t?(a.bindFramebuffer(t,n,void 0,void 0,r),d._outputTexture=t):(a.restoreDefaultFramebuffer(),d._outputTexture=null),null===(o=a._debugInsertMarker)||void 0===o||o.call(a,`post process ${i[l].name} output`)),e)break;const h=d.apply();h&&(d.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,h),a.drawElementsType(0,0,6),d.onAfterRenderObservable.notifyObservers(h))}a.setDepthBuffer(!0),a.setDepthWrite(!0),a.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[i.b.PositionKind];e&&(e.dispose(),this._vertexBuffers[i.b.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}constructor(e){this._vertexBuffers={},this.onBeforeRenderObservable=new r.a,this._scene=e}}},function(e,t,n){"use strict";n.r(t),n.d(t,"postprocessVertexShader",(function(){return s}));const i="postprocessVertexShader",r="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";n(66).a.ShadersStore[i]=r;const s={name:i,shader:r}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(84),r=n(165);class s{getNormal(e=!1,t=!0){var n;if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(r.b.NormalKind))return null;let s,a=this.pickedMesh.getIndices();0===(null===(n=a)||void 0===n?void 0:n.length)&&(a=null);const o=i.c.Vector3[0],l=i.c.Vector3[1],c=i.c.Vector3[2];if(t){const e=this.pickedMesh.getVerticesData(r.b.NormalKind);let t=a?i.e.FromArrayToRef(e,3*a[3*this.faceId],o):o.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),n=a?i.e.FromArrayToRef(e,3*a[3*this.faceId+1],l):l.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),d=a?i.e.FromArrayToRef(e,3*a[3*this.faceId+2],c):c.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]);t=t.scale(this.bu),n=n.scale(this.bv),d=d.scale(1-this.bu-this.bv),s=new i.e(t.x+n.x+d.x,t.y+n.y+d.y,t.z+n.z+d.z)}else{const e=this.pickedMesh.getVerticesData(r.b.PositionKind),t=a?i.e.FromArrayToRef(e,3*a[3*this.faceId],o):o.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),n=a?i.e.FromArrayToRef(e,3*a[3*this.faceId+1],l):l.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),d=a?i.e.FromArrayToRef(e,3*a[3*this.faceId+2],c):c.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]),h=t.subtract(n),u=d.subtract(n);s=i.e.Cross(h,u)}const d=(e,t)=>{let n=e.getWorldMatrix();e.nonUniformScaling&&(i.c.Matrix[0].copyFrom(n),n=i.c.Matrix[0],n.setTranslationFromFloats(0,0,0),n.invert(),n.transposeToRef(i.c.Matrix[1]),n=i.c.Matrix[1]),i.e.TransformNormalToRef(t,n,t)};if(e&&d(this.pickedMesh,s),this.ray){const t=i.c.Vector3[0].copyFrom(s);e||d(this.pickedMesh,t),i.e.Dot(t,this.ray.direction)>0&&s.negateInPlace()}return s.normalize(),s}getTextureCoordinates(e=r.b.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const n=this.pickedMesh.getVerticesData(e);if(!n)return null;let s=i.d.FromArray(n,2*t[3*this.faceId]),a=i.d.FromArray(n,2*t[3*this.faceId+1]),o=i.d.FromArray(n,2*t[3*this.faceId+2]);return s=s.scale(this.bu),a=a.scale(this.bv),o=o.scale(1-this.bu-this.bv),new i.d(s.x+a.x+o.x,s.y+a.y+o.y)}constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}i.FALLOFF_DEFAULT=0,i.FALLOFF_PHYSICAL=1,i.FALLOFF_GLTF=2,i.FALLOFF_STANDARD=3,i.LIGHTMAP_DEFAULT=0,i.LIGHTMAP_SPECULAR=1,i.LIGHTMAP_SHADOWSONLY=2,i.INTENSITYMODE_AUTOMATIC=0,i.INTENSITYMODE_LUMINOUSPOWER=1,i.INTENSITYMODE_LUMINOUSINTENSITY=2,i.INTENSITYMODE_ILLUMINANCE=3,i.INTENSITYMODE_LUMINANCE=4,i.LIGHTTYPEID_POINTLIGHT=0,i.LIGHTTYPEID_DIRECTIONALLIGHT=1,i.LIGHTTYPEID_SPOTLIGHT=2,i.LIGHTTYPEID_HEMISPHERICLIGHT=3,i.LIGHTTYPEID_RECT_AREALIGHT=4},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.packingFunctions="vec4 pack(float depth)\n{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.instancesDeclaration="#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#ifdef INSTANCESCOLOR\nattribute vec4 instanceColor;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nattribute vec4 previousWorld0;attribute vec4 previousWorld1;attribute vec4 previousWorld2;attribute vec4 previousWorld3;\n#ifdef THIN_INSTANCES\nuniform mat4 previousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nuniform mat4 previousWorld;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.packingFunctions="fn pack(depth: f32)->vec4f\n{const bit_shift: vec4f= vec4f(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const bit_mask: vec4f= vec4f(0.0,1.0/255.0,1.0/255.0,1.0/255.0);var res: vec4f=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfn unpack(color: vec4f)->f32\n{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.sceneUboDeclaration="struct Scene {viewProjection : mat4x4<f32>,\n#ifdef MULTIVIEW\nviewProjectionR : mat4x4<f32>,\n#endif \nview : mat4x4<f32>,\nprojection : mat4x4<f32>,\nvEyePosition : vec4<f32>,};\n#define SCENE_UBO\nvar<uniform> scene : Scene;\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.meshUboDeclaration="struct Mesh {world : mat4x4<f32>,\nvisibility : f32,};var<uniform> mesh : Mesh;\n#define WORLD_UBO\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.sceneUboDeclaration="layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nmat4 view;mat4 projection;vec4 vEyePosition;};\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.meshUboDeclaration="#ifdef WEBGL2\nuniform mat4 world;uniform float visibility;\n#else\nlayout(std140,column_major) uniform;uniform Mesh\n{mat4 world;float visibility;};\n#endif\n#define WORLD_UBO\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.instancesDeclaration="#ifdef INSTANCES\nattribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;\n#ifdef INSTANCESCOLOR\nattribute instanceColor : vec4<f32>;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nattribute previousWorld0 : vec4<f32>;attribute previousWorld1 : vec4<f32>;attribute previousWorld2 : vec4<f32>;attribute previousWorld3 : vec4<f32>;\n#ifdef THIN_INSTANCES\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.samplerFragmentDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying v_VARYINGNAME_UV: vec2f;\n#endif\nvar _SAMPLERNAME_SamplerSampler: sampler;var _SAMPLERNAME_Sampler: texture_2d<f32>;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.samplerFragmentDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\nuniform sampler2D _SAMPLERNAME_Sampler;\n#endif\n"},function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var i=n(309),r=n(310),s=n(43),a=n(311),o=n(313);function l(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}class c{get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,n="vCameraColorCurvePositive",i="vCameraColorCurveNeutral",r="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(n,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(i,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(r,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}_getColorGradingDataToRef(e,t,n,i,r){null!=e&&(e=c._Clamp(e,0,360),t=c._Clamp(t,-100,100),n=c._Clamp(n,-100,100),i=c._Clamp(i,-100,100),t=c._ApplyColorGradingSliderNonlinear(t),t*=.5,i=c._ApplyColorGradingSliderNonlinear(i),t<0&&(t*=-1,e=(e+180)%360),c._FromHSBToRef(e,t,50+.25*i,r),r.scaleToRef(2,r),r.a=1+.01*n)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,n,i){let r=c._Clamp(e,0,360);const s=c._Clamp(t/100,0,1),a=c._Clamp(n/100,0,1);if(0===s)i.r=a,i.g=a,i.b=a;else{r/=60;const e=Math.floor(r),t=r-e,n=a*(1-s),o=a*(1-s*t),l=a*(1-s*(1-t));switch(e){case 0:i.r=a,i.g=l,i.b=n;break;case 1:i.r=o,i.g=a,i.b=n;break;case 2:i.r=n,i.g=a,i.b=l;break;case 3:i.r=n,i.g=o,i.b=a;break;case 4:i.r=l,i.g=n,i.b=a;break;default:i.r=a,i.g=n,i.b=o}}i.a=1}static _Clamp(e,t,n){return Math.min(Math.max(e,t),n)}clone(){return o.a.Clone(()=>new c,this)}serialize(){return o.a.Serialize(this)}static Parse(e){return o.a.Parse(()=>new c,e,null,null)}constructor(){this._dirty=!0,this._tempColor=new a.b(0,0,0,0),this._globalCurve=new a.b(0,0,0,0),this._highlightsCurve=new a.b(0,0,0,0),this._midtonesCurve=new a.b(0,0,0,0),this._shadowsCurve=new a.b(0,0,0,0),this._positiveCurve=new a.b(0,0,0,0),this._negativeCurve=new a.b(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}}c.PrepareUniforms=l,Object(i.a)([Object(r.c)()],c.prototype,"_globalHue",void 0),Object(i.a)([Object(r.c)()],c.prototype,"_globalDensity",void 0),Object(i.a)([Object(r.c)()],c.prototype,"_globalSaturation",void 0),Object(i.a)([Object(r.c)()],c.prototype,"_globalExposure",void 0),Object(i.a)([Object(r.c)()],c.prototype,"_highlightsHue",void 0),Object(i.a)([Object(r.c)()],c.prototype,"_highlightsDensity",void 0),Object(i.a)([Object(r.c)()],c.prototype,"_highlightsSaturation",void 0),Object(i.a)([Object(r.c)()],c.prototype,"_highlightsExposure",void 0),Object(i.a)([Object(r.c)()],c.prototype,"_midtonesHue",void 0),Object(i.a)([Object(r.c)()],c.prototype,"_midtonesDensity",void 0),Object(i.a)([Object(r.c)()],c.prototype,"_midtonesSaturation",void 0),Object(i.a)([Object(r.c)()],c.prototype,"_midtonesExposure",void 0),o.a._ColorCurvesParser=c.Parse;var d=n(140),h=n(108);class u{get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled)return e.VIGNETTE=!1,e.TONEMAPPING=0,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,void(e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled);if(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===u._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,this._toneMappingEnabled)switch(this._toneMappingType){case u.TONEMAPPING_KHR_PBR_NEUTRAL:e.TONEMAPPING=3;break;case u.TONEMAPPING_ACES:e.TONEMAPPING=2;break;default:e.TONEMAPPING=1}else e.TONEMAPPING=0;e.CONTRAST=1!==this.contrast,e.EXPOSURE=1!==this.exposure,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||!!e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&c.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const n=1/e.getEngine().getRenderWidth(),i=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",n,i),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const r=null!=t?t:i/n;let s=Math.tan(.5*this.vignetteCameraFov),a=s*r;const o=Math.sqrt(a*s);a=Object(d.d)(a,o,this.vignetteStretch),s=Object(d.d)(s,o,this.vignetteStretch),e.setFloat4("vignetteSettings1",a,s,-a*this.vignetteCenterX,-s*this.vignetteCenterY);const l=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,l)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const t=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(t-1)/t,.5/t,t,this.colorGradingTexture.level)}}clone(){return o.a.Clone(()=>new u,this)}serialize(){return o.a.Serialize(this)}static Parse(e){const t=o.a.Parse(()=>new u,e,null,null);return void 0!==e.vignetteCentreX&&(t.vignetteCenterX=e.vignetteCentreX),void 0!==e.vignetteCentreY&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}constructor(){this.colorCurves=new c,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=u.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new a.b(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=u.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new s.a}}u.TONEMAPPING_STANDARD=0,u.TONEMAPPING_ACES=1,u.TONEMAPPING_KHR_PBR_NEUTRAL=2,u.PrepareUniforms=function(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&l(e),t.DITHER&&e.push("ditherIntensity")},u.PrepareSamplers=function(e,t){t.COLORGRADING&&e.push("txColorTransform")},u._VIGNETTEMODE_MULTIPLY=0,u._VIGNETTEMODE_OPAQUE=1,Object(i.a)([Object(r.f)()],u.prototype,"colorCurves",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_colorCurvesEnabled",void 0),Object(i.a)([Object(r.l)("colorGradingTexture")],u.prototype,"_colorGradingTexture",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_colorGradingEnabled",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_colorGradingWithGreenDepth",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_colorGradingBGR",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_exposure",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_toneMappingEnabled",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_toneMappingType",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_contrast",void 0),Object(i.a)([Object(r.c)()],u.prototype,"vignetteStretch",void 0),Object(i.a)([Object(r.c)()],u.prototype,"vignetteCenterX",void 0),Object(i.a)([Object(r.c)()],u.prototype,"vignetteCenterY",void 0),Object(i.a)([Object(r.c)()],u.prototype,"vignetteWeight",void 0),Object(i.a)([Object(r.e)()],u.prototype,"vignetteColor",void 0),Object(i.a)([Object(r.c)()],u.prototype,"vignetteCameraFov",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_vignetteBlendMode",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_vignetteEnabled",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_ditheringEnabled",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_ditheringIntensity",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_skipFinalColorClamp",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_applyByPostProcess",void 0),Object(i.a)([Object(r.c)()],u.prototype,"_isEnabled",void 0),o.a._ImageProcessingConfigurationParser=u.Parse,Object(h.b)("BABYLON.ImageProcessingConfiguration",u)},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var i=n(319),r=n(84);class s{set opaqueSortCompareFn(e){this._opaqueSortCompareFn=e||s.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){this._alphaTestSortCompareFn=e||s.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){this._transparentSortCompareFn=e||s.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}render(e,t,n,i){if(e)return void e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);const r=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(r.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),r.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);const s=r.getStencilBuffer();if(r.setStencilBuffer(!1),t&&this._renderSprites(),n&&this._renderParticles(i),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency){if(r.setStencilBuffer(s),this._scene.useOrderIndependentTransparency){const e=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);e.length&&this._renderTransparent(e)}else this._renderTransparent(this._transparentSubMeshes);r.setAlphaMode(0)}if(r.setStencilBuffer(!1),this._edgesRenderers.length){for(let e=0;e<this._edgesRenderers.length;e++)this._edgesRenderers.data[e].render();r.setAlphaMode(0)}r.setStencilBuffer(s)}_renderOpaqueSorted(e){s._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){s._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){s._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,n,i){let a,o=0;const l=n?n.globalPosition:s._ZeroVector;if(i)for(;o<e.length;o++)a=e.data[o],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=r.e.Distance(a.getBoundingInfo().boundingSphere.centerWorld,l);const c=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&c.sort(t);const d=c[0].getMesh().getScene();for(o=0;o<c.length;o++)if(a=c[o],!d._activeMeshesFrozenButKeepClipping||a.isInFrustum(d._frustumPlanes)){if(i){const e=a.getMaterial();if(e&&e.needDepthPrePass){const t=e.getScene().getEngine();t.setColorWrite(!1),t.setAlphaMode(0),a.render(!1),t.setColorWrite(!0)}}a.render(i)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:s.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const n=e.getMesh(),i=t.getMesh();return n.material&&i.material?n.material.uniqueId-i.material.uniqueId:n.uniqueId-i.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,n){void 0===t&&(t=e.getMesh()),void 0===n&&(n=e.getMaterial()),null!=n&&(n.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):n.needAlphaTestingForMesh(t)?(n.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(n.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t.isEnabled()&&t.isVisible&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(0===this._particleSystems.length)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let n=0;n<this._particleSystems.length;n++){const i=this._particleSystems.data[n];if(0===(t&&t.layerMask&i.layerMask))continue;const r=i.emitter;r.position&&e&&-1===e.indexOf(r)||this._scene._activeParticles.addCount(i.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||0===this._spriteManagers.length)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const n=this._spriteManagers.data[t];0!==(e&&e.layerMask&n.layerMask)&&n.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}constructor(e,t,n=null,r=null,s=null){this.index=e,this._opaqueSubMeshes=new i.a(256),this._transparentSubMeshes=new i.a(256),this._alphaTestSubMeshes=new i.a(256),this._depthOnlySubMeshes=new i.a(256),this._particleSystems=new i.a(256),this._spriteManagers=new i.a(256),this._empty=!0,this._edgesRenderers=new i.b(16),this._scene=t,this.opaqueSortCompareFn=n,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=s}}s._ZeroVector=r.e.Zero();class a{}class o{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(const e of this._scene.meshes)if(e.subMeshes)for(const t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(const e of this._scene.spriteManagers)e._wasDispatched=!1;for(const e of this._scene.particleSystems)e._wasDispatched=!1}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,n,i){const r=this._renderingGroupInfo;if(r.scene=this._scene,r.camera=this._scene.activeCamera,r.renderingManager=this,this._scene.spriteManagers&&i)for(let e=0;e<this._scene.spriteManagers.length;e++){const t=this._scene.spriteManagers[e];this.dispatchSprites(t)}for(let s=o.MIN_RENDERINGGROUPS;s<o.MAX_RENDERINGGROUPS;s++){this._depthStencilBufferAlreadyCleaned=s===o.MIN_RENDERINGGROUPS;const a=this._renderingGroups[s];if(!a||a._empty)continue;const l=1<<s;if(r.renderingGroupId=s,this._scene.onBeforeRenderingGroupObservable.notifyObservers(r,l),o.AUTOCLEAR){const e=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(s):this._autoClearDepthStencil[s];e&&e.autoClear&&this._clearDepthStencilBuffer(e.depth,e.stencil)}for(const e of this._scene._beforeRenderingGroupDrawStage)e.action(s);a.render(e,i,n,t);for(const e of this._scene._afterRenderingGroupDrawStage)e.action(s);this._scene.onAfterRenderingGroupObservable.notifyObservers(r,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){void 0===this._renderingGroups[e]&&(this._renderingGroups[e]=new s(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,n){void 0===t&&(t=e.getMesh()),this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,n))}setRenderingOrder(e,t=null,n=null,i=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=n,this._customTransparentSortCompareFn[e]=i,this._renderingGroups[e]){const t=this._renderingGroups[e];t.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],t.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],t.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,n=!0,i=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:n,stencil:i}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new a,this._maintainStateBetweenFrames=!1,this._scene=e;for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++)this._autoClearDepthStencil[e]={autoClear:!0,depth:!0,stencil:!0}}}o.MAX_RENDERINGGROUPS=4,o.MIN_RENDERINGGROUPS=0,o.AUTOCLEAR=!0},function(e,t,n){"use strict";n.r(t),n.d(t,"DDSTools",(function(){return u}));var i=n(26),r=n(36),s=n(391),a=n(485);function o(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}n(487);const l=o("DXT1"),c=o("DXT3"),d=o("DXT5"),h=o("DX10");class u{static GetDDSInfo(e){const t=new Int32Array(e.buffer,e.byteOffset,31),n=new Int32Array(e.buffer,e.byteOffset,35);let i=1;131072&t[2]&&(i=Math.max(1,t[7]));const r=t[21],s=r===h?n[32]:0;let a=0;switch(r){case 113:a=2;break;case 116:a=1;break;case h:if(10===s){a=2;break}if(2===s){a=1;break}}return{width:t[4],height:t[3],mipmapCount:i,isFourCC:4==(4&t[20]),isRGB:64==(64&t[20]),isLuminance:131072==(131072&t[20]),isCube:512==(512&t[28]),isCompressed:r===l||r===c||r===d,dxgiFormat:s,textureType:a}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,n,i,r,s){const o=new Float32Array(i),l=new Uint16Array(r,n);let c=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++){const i=4*(t+n*e);o[c]=Object(a.b)(l[i]),o[c+1]=Object(a.b)(l[i+1]),o[c+2]=Object(a.b)(l[i+2]),u.StoreLODInAlphaChannel?o[c+3]=s:o[c+3]=Object(a.b)(l[i+3]),c+=4}return o}static _GetHalfFloatRGBAArrayBuffer(e,t,n,i,r,s){if(u.StoreLODInAlphaChannel){const o=new Uint16Array(i),l=new Uint16Array(r,n);let c=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++){const i=4*(t+n*e);o[c]=l[i],o[c+1]=l[i+1],o[c+2]=l[i+2],o[c+3]=Object(a.c)(s),c+=4}return o}return new Uint16Array(r,n,i)}static _GetFloatRGBAArrayBuffer(e,t,n,i,r,s){if(u.StoreLODInAlphaChannel){const a=new Float32Array(i),o=new Float32Array(r,n);let l=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++){const i=4*(t+n*e);a[l]=o[i],a[l+1]=o[i+1],a[l+2]=o[i+2],a[l+3]=s,l+=4}return a}return new Float32Array(r,n,i)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,n,i,r,s){const o=new Uint16Array(i),l=new Float32Array(r,n);let c=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++)o[c]=Object(a.c)(l[c]),o[c+1]=Object(a.c)(l[c+1]),o[c+2]=Object(a.c)(l[c+2]),u.StoreLODInAlphaChannel?o[c+3]=Object(a.c)(s):o[c+3]=Object(a.c)(l[c+3]),c+=4;return o}static _GetFloatAsUIntRGBAArrayBuffer(e,t,n,r,s,a){const o=new Uint8Array(r),l=new Float32Array(s,n);let c=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++){const r=4*(t+n*e);o[c]=255*Object(i.a)(l[r]),o[c+1]=255*Object(i.a)(l[r+1]),o[c+2]=255*Object(i.a)(l[r+2]),u.StoreLODInAlphaChannel?o[c+3]=a:o[c+3]=255*Object(i.a)(l[r+3]),c+=4}return o}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,t,n,r,s,o){const l=new Uint8Array(r),c=new Uint16Array(s,n);let d=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++){const r=4*(t+n*e);l[d]=255*Object(i.a)(Object(a.b)(c[r])),l[d+1]=255*Object(i.a)(Object(a.b)(c[r+1])),l[d+2]=255*Object(i.a)(Object(a.b)(c[r+2])),u.StoreLODInAlphaChannel?l[d+3]=o:l[d+3]=255*Object(i.a)(Object(a.b)(c[r+3])),d+=4}return l}static _GetRGBAArrayBuffer(e,t,n,i,r,s,a,o,l){const c=new Uint8Array(i),d=new Uint8Array(r,n);let h=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++){const i=4*(t+n*e);c[h]=d[i+s],c[h+1]=d[i+a],c[h+2]=d[i+o],c[h+3]=d[i+l],h+=4}return c}static _ExtractLongWordOrder(e){return 0===e||255===e||-16777216===e?0:1+u._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,n,i,r,s,a,o){const l=new Uint8Array(i),c=new Uint8Array(r,n);let d=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++){const i=3*(t+n*e);l[d]=c[i+s],l[d+1]=c[i+a],l[d+2]=c[i+o],d+=3}return l}static _GetLuminanceArrayBuffer(e,t,n,i,r){const s=new Uint8Array(i),a=new Uint8Array(r,n);let o=0;for(let n=0;n<t;n++)for(let t=0;t<e;t++){const i=t+n*e;s[o]=a[i],o++}return s}static UploadDDSLevels(e,t,n,i,a,o,f=-1,m,p=!0){let g=null;i.sphericalPolynomial&&(g=[]);const _=!!e.getCaps().s3tc;t.generateMipMaps=a;const v=new Int32Array(n.buffer,n.byteOffset,31);let E,T,S,A,b,I,R,C=0,y=0,M=1;if(542327876!==v[0])return void r.a.Error("Invalid magic number in DDS header");if(!i.isFourCC&&!i.isRGB&&!i.isLuminance)return void r.a.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(i.isCompressed&&!_)return void r.a.Error("Compressed textures are not supported on this platform.");let O=v[22];A=v[1]+4;let x=!1;if(i.isFourCC)switch(E=v[21],E){case l:M=8,y=33777;break;case c:M=16,y=33778;break;case d:M=16,y=33779;break;case 113:x=!0,O=64;break;case 116:x=!0,O=128;break;case h:{A+=20;let e=!1;switch(i.dxgiFormat){case 10:x=!0,O=64,e=!0;break;case 2:x=!0,O=128,e=!0;break;case 88:i.isRGB=!0,i.isFourCC=!1,O=32,e=!0}if(e)break}default:return void r.a.Error(["Unsupported FourCC code:",(D=E,String.fromCharCode(255&D,D>>8&255,D>>16&255,D>>24&255))])}var D;const P=u._ExtractLongWordOrder(v[23]),L=u._ExtractLongWordOrder(v[24]),N=u._ExtractLongWordOrder(v[25]),F=u._ExtractLongWordOrder(v[26]);x&&(y=e._getRGBABufferInternalSizedFormat(i.textureType)),I=1,131072&v[2]&&!1!==a&&(I=Math.max(1,v[7]));const w=m||0,U=e.getCaps();for(let r=w;r<o;r++){for(T=v[4],S=v[3],R=0;R<I;++R){if(-1===f||f===R){const s=-1===f?R:0;if(!i.isCompressed&&i.isFourCC){t.format=5,C=T*S*4;let i=null;if(e._badOS||e._badDesktopOS||!U.textureHalfFloat&&!U.textureFloat)128===O?(i=u._GetFloatAsUIntRGBAArrayBuffer(T,S,n.byteOffset+A,C,n.buffer,s),g&&0==s&&g.push(u._GetFloatRGBAArrayBuffer(T,S,n.byteOffset+A,C,n.buffer,s))):64===O&&(i=u._GetHalfFloatAsUIntRGBAArrayBuffer(T,S,n.byteOffset+A,C,n.buffer,s),g&&0==s&&g.push(u._GetHalfFloatAsFloatRGBAArrayBuffer(T,S,n.byteOffset+A,C,n.buffer,s))),t.type=0;else{const e=U.textureFloat&&(p&&U.textureFloatLinearFiltering||!p),r=U.textureHalfFloat&&(p&&U.textureHalfFloatLinearFiltering||!p),a=(128===O||64===O&&!r)&&e?1:(64===O||128===O&&!e)&&r?2:0;let o,l=null;switch(O){case 128:switch(a){case 1:o=u._GetFloatRGBAArrayBuffer,l=null;break;case 2:o=u._GetFloatAsHalfFloatRGBAArrayBuffer,l=u._GetFloatRGBAArrayBuffer;break;case 0:o=u._GetFloatAsUIntRGBAArrayBuffer,l=u._GetFloatRGBAArrayBuffer}break;default:switch(a){case 1:o=u._GetHalfFloatAsFloatRGBAArrayBuffer,l=null;break;case 2:o=u._GetHalfFloatRGBAArrayBuffer,l=u._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:o=u._GetHalfFloatAsUIntRGBAArrayBuffer,l=u._GetHalfFloatAsFloatRGBAArrayBuffer}}t.type=a,i=o(T,S,n.byteOffset+A,C,n.buffer,s),g&&0==s&&g.push(l?l(T,S,n.byteOffset+A,C,n.buffer,s):i)}i&&e._uploadDataToTextureDirectly(t,i,r,s)}else if(i.isRGB)t.type=0,24===O?(t.format=4,C=T*S*3,b=u._GetRGBArrayBuffer(T,S,n.byteOffset+A,C,n.buffer,P,L,N),e._uploadDataToTextureDirectly(t,b,r,s)):(t.format=5,C=T*S*4,b=u._GetRGBAArrayBuffer(T,S,n.byteOffset+A,C,n.buffer,P,L,N,F),e._uploadDataToTextureDirectly(t,b,r,s));else if(i.isLuminance){const i=e._getUnpackAlignement(),a=T;C=Math.floor((T+i-1)/i)*i*(S-1)+a,b=u._GetLuminanceArrayBuffer(T,S,n.byteOffset+A,C,n.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,b,r,s)}else C=Math.max(4,T)/4*Math.max(4,S)/4*M,b=new Uint8Array(n.buffer,n.byteOffset+A,C),t.type=0,e._uploadCompressedDataToTextureDirectly(t,y,T,S,b,r,s)}A+=O?T*S*(O/8):C,T*=.5,S*=.5,T=Math.max(1,T),S=Math.max(1,S)}if(void 0!==m)break}g&&g.length>0?i.sphericalPolynomial=s.a.ConvertCubeMapToSphericalPolynomial({size:v[4],right:g[0],left:g[1],up:g[2],down:g[3],front:g[4],back:g[5],format:5,type:1,gammaSpace:!1}):i.sphericalPolynomial=void 0}}u.StoreLODInAlphaChannel=!1},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var i=n(84),r=n(26),s=n(331),a=n(69),o=n(311);class l{constructor(e,t,n,i){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=n,this.worldAxisForFileY=i}}class c{static ConvertCubeMapTextureToSphericalPolynomial(e){var t;if(!e.isCube)return null;null===(t=e.getScene())||void 0===t||t.getEngine().flushFramebuffer();const n=e.getSize().width,i=e.readPixels(0,void 0,void 0,!1),r=e.readPixels(1,void 0,void 0,!1);let s,a;e.isRenderTarget?(s=e.readPixels(3,void 0,void 0,!1),a=e.readPixels(2,void 0,void 0,!1)):(s=e.readPixels(2,void 0,void 0,!1),a=e.readPixels(3,void 0,void 0,!1));const o=e.readPixels(4,void 0,void 0,!1),l=e.readPixels(5,void 0,void 0,!1),c=e.gammaSpace;let d=0;return 1!=e.textureType&&2!=e.textureType||(d=1),new Promise(e=>{Promise.all([r,i,s,a,o,l]).then(([t,i,r,s,a,o])=>{const l={size:n,right:i,left:t,up:r,down:s,front:a,back:o,format:5,type:d,gammaSpace:c};e(this.ConvertCubeMapToSphericalPolynomial(l))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new s.a;let n=0;const i=2/e.size,l=i,c=.5*i,d=c-1;for(let s=0;s<6;s++){const h=this._FileFaces[s],u=e[h.name];let f=d;const m=5===e.format?4:3;for(let s=0;s<e.size;s++){let p=d;for(let l=0;l<e.size;l++){const d=h.worldAxisForFileX.scale(p).add(h.worldAxisForFileY.scale(f)).add(h.worldAxisForNormal);d.normalize();const g=this._AreaElement(p-c,f-c)-this._AreaElement(p-c,f+c)-this._AreaElement(p+c,f-c)+this._AreaElement(p+c,f+c);let _=u[s*e.size*m+l*m+0],v=u[s*e.size*m+l*m+1],E=u[s*e.size*m+l*m+2];isNaN(_)&&(_=0),isNaN(v)&&(v=0),isNaN(E)&&(E=0),0===e.type&&(_/=255,v/=255,E/=255),e.gammaSpace&&(_=Math.pow(Object(r.a)(_),a.c),v=Math.pow(Object(r.a)(v),a.c),E=Math.pow(Object(r.a)(E),a.c));const T=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const e=Math.max(_,v,E);if(e>T){const t=T/e;_*=t,v*=t,E*=t}}else _=Object(r.a)(_,0,T),v=Object(r.a)(v,0,T),E=Object(r.a)(E,0,T);const S=new o.a(_,v,E);t.addLight(d,S,g),n+=g,p+=i}f+=l}}const h=4*Math.PI*6/6/n;return t.scaleInPlace(h),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),s.b.FromHarmonics(t)}}c._FileFaces=[new l("right",new i.e(1,0,0),new i.e(0,0,-1),new i.e(0,-1,0)),new l("left",new i.e(-1,0,0),new i.e(0,0,1),new i.e(0,-1,0)),new l("up",new i.e(0,1,0),new i.e(1,0,0),new i.e(0,0,1)),new l("down",new i.e(0,-1,0),new i.e(1,0,0),new i.e(0,0,-1)),new l("front",new i.e(0,0,1),new i.e(1,0,0),new i.e(0,-1,0)),new l("back",new i.e(0,0,-1),new i.e(-1,0,0),new i.e(0,-1,0))],c.MAX_HDRI_VALUE=4096,c.PRESERVE_CLAMPED_COLORS=!1},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return a}));const i={},r={};function s(e){const t=e.getClassName();return r[t]||(r[t]={}),r[t]}function a(e){const t=e.getClassName();if(i[t])return i[t];i[t]={};const n=i[t];let s=e,a=t;for(;a;){const e=r[a];for(const t in e)n[t]=e[t];let t,i=!1;do{if(t=Object.getPrototypeOf(s),!t.getClassName){i=!0;break}if(t.getClassName()!==a)break;s=t}while(t);if(i)break;a=t.getClassName(),s=t}return n}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(36),r=n(108);class s{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=Object(r.a)(e);if(t)return t;i.a.Warn(e+" not found, you may have missed an import.");const n=e.split(".");let s=window||this;for(let e=0,t=n.length;e<t;e++)s=s[n[e]];return"function"!=typeof s?null:s}}s.RegisteredExternalClasses={}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));let i=!1},function(e,t,n){"use strict";n.d(t,"i",(function(){return a})),n.d(t,"h",(function(){return o})),n.d(t,"d",(function(){return l})),n.d(t,"a",(function(){return c})),n.d(t,"g",(function(){return d})),n.d(t,"e",(function(){return h})),n.d(t,"b",(function(){return u})),n.d(t,"f",(function(){return f})),n.d(t,"c",(function(){return m}));var i=n(48),r=n(100),s=n(62);function a(e,t,n){e._onCanvasFocus=()=>{e.onCanvasFocusObservable.notifyObservers(e)},e._onCanvasBlur=()=>{e.onCanvasBlurObservable.notifyObservers(e)},e._onCanvasContextMenu=t=>{e.disableContextMenu&&t.preventDefault()},t.addEventListener("focus",e._onCanvasFocus),t.addEventListener("blur",e._onCanvasBlur),t.addEventListener("contextmenu",e._onCanvasContextMenu),e._onBlur=()=>{e.disablePerformanceMonitorInBackground&&e.performanceMonitor.disable(),e._windowIsBackground=!0},e._onFocus=()=>{e.disablePerformanceMonitorInBackground&&e.performanceMonitor.enable(),e._windowIsBackground=!1},e._onCanvasPointerOut=n=>{document.elementFromPoint(n.clientX,n.clientY)!==t&&e.onCanvasPointerOutObservable.notifyObservers(n)};const s=e.getHostWindow();s&&"function"==typeof s.addEventListener&&(s.addEventListener("blur",e._onBlur),s.addEventListener("focus",e._onFocus)),t.addEventListener("pointerout",e._onCanvasPointerOut),n.doNotHandleTouchAction||function(e){e&&e.setAttribute&&(e.setAttribute("touch-action","none"),e.style.touchAction="none",e.style.webkitTapHighlightColor="transparent")}(t),!r.a.audioEngine&&n.audioEngine&&r.a.AudioEngineFactory&&(r.a.audioEngine=r.a.AudioEngineFactory(e.getRenderingCanvas(),e.getAudioContext(),e.getAudioDestination())),Object(i.b)()&&(e._onFullscreenChange=()=>{e.isFullscreen=!!document.fullscreenElement,e.isFullscreen&&e._pointerLockRequested&&t&&f(t)},document.addEventListener("fullscreenchange",e._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",e._onFullscreenChange,!1),e._onPointerLockChange=()=>{e.isPointerLock=document.pointerLockElement===t},document.addEventListener("pointerlockchange",e._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",e._onPointerLockChange,!1)),e.enableOfflineSupport=void 0!==r.a.OfflineProviderFactory,e._deterministicLockstep=!!n.deterministicLockstep,e._lockstepMaxSteps=n.lockstepMaxSteps||0,e._timeStep=n.timeStep||1/60}function o(e,t){1===s.a.Instances.length&&r.a.audioEngine&&(r.a.audioEngine.dispose(),r.a.audioEngine=null);const n=e.getHostWindow();n&&"function"==typeof n.removeEventListener&&(n.removeEventListener("blur",e._onBlur),n.removeEventListener("focus",e._onFocus)),t&&(t.removeEventListener("focus",e._onCanvasFocus),t.removeEventListener("blur",e._onCanvasBlur),t.removeEventListener("pointerout",e._onCanvasPointerOut),t.removeEventListener("contextmenu",e._onCanvasContextMenu)),Object(i.b)()&&(document.removeEventListener("fullscreenchange",e._onFullscreenChange),document.removeEventListener("mozfullscreenchange",e._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",e._onFullscreenChange),document.removeEventListener("msfullscreenchange",e._onFullscreenChange),document.removeEventListener("pointerlockchange",e._onPointerLockChange),document.removeEventListener("mspointerlockchange",e._onPointerLockChange),document.removeEventListener("mozpointerlockchange",e._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",e._onPointerLockChange))}function l(e){const t=document.createElement("span");t.textContent="Hg",t.style.font=e;const n=document.createElement("div");n.style.display="inline-block",n.style.width="1px",n.style.height="0px",n.style.verticalAlign="bottom";const i=document.createElement("div");i.style.whiteSpace="nowrap",i.appendChild(t),i.appendChild(n),document.body.appendChild(i);let r=0,s=0;try{s=n.getBoundingClientRect().top-t.getBoundingClientRect().top,n.style.verticalAlign="baseline",r=n.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(i)}return{ascent:r,height:s,descent:s-r}}function c(e,t,n){return new Promise((i,r)=>{const s=new Image;s.onload=()=>{s.decode().then(()=>{e.createImageBitmap(s,n).then(e=>{i(e)})})},s.onerror=()=>{r("Error loading image "+s.src)},s.src=t})}function d(e,t,n,i){const r=e.createCanvas(n,i).getContext("2d");if(!r)throw new Error("Unable to get 2d context for resizeImageBitmap");return r.drawImage(t,0,0),r.getImageData(0,0,n,i).data}function h(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}function u(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}function f(e){if(e.requestPointerLock){const t=e.requestPointerLock();t instanceof Promise?t.then(()=>{e.focus()}).catch(()=>{}):e.focus()}}function m(){document.exitPointerLock&&document.exitPointerLock()}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(173);class r{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){r.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){r.Enabled&&(this._startMonitoringTime=i.a.Now)}endMonitoring(e=!0){if(!r.Enabled)return;e&&this.fetchNewFrame();const t=i.a.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=i.a.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}}r.Enabled=!0},function(e,t,n){"use strict";var i=n(43),r=n(36),s=n(100),a=n(48);s.a.AudioEngineFactory=(e,t,n)=>new o(e,t,n);class o{get audioContext(){return this._audioContextInitialized||this._initializeAudioContext(),this._audioContext}lock(){this._triggerSuspendedState()}unlock(){var e,t;if("running"===(null===(e=this._audioContext)||void 0===e?void 0:e.state))return this._hideMuteButton(),void(this.unlocked||(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)));this._tryToRun?null===(t=this._audioContext)||void 0===t||t.suspend().then(()=>{this._tryToRun=!1,this._triggerRunningState()}):this._triggerRunningState()}_resumeAudioContextOnStateChange(){var e;null===(e=this._audioContext)||void 0===e||e.addEventListener("statechange",()=>{var e;this.unlocked&&"running"!==(null===(e=this._audioContext)||void 0===e?void 0:e.state)&&this._resumeAudioContext()},{once:!0,passive:!0,signal:AbortSignal.timeout(3e3)})}_resumeAudioContext(){var e;return null!==(e=this._audioContext)&&void 0!==e&&e.resume?this._audioContext.resume():Promise.resolve()}_initializeAudioContext(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,"running"===this._audioContext.state&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,r.a.Error("Web Audio: "+e.message)}}_triggerRunningState(){this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(()=>{this._tryToRun=!1,this._muteButton&&this._hideMuteButton(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)}).catch(()=>{this._tryToRun=!1,this.unlocked=!1}))}_triggerSuspendedState(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()}_displayMuteButton(){if(this.useCustomUnlockedButton||this._muteButton)return;this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";const e=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png")+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",()=>{this._triggerRunningState()},!0),this._muteButton.addEventListener("click",()=>{this.unlock()},!0),window.addEventListener("resize",this._onResize)}_moveButtonToTopLeft(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")}_hideMuteButton(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)}dispose(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1}setGlobalVolume(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))}constructor(e=null,t=null,n=null){if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new i.a,this.onAudioLockedObservable=new i.a,this._tryToRun=!1,this._onResize=()=>{this._moveButtonToTopLeft()},!Object(a.d)())return;void 0!==window.AudioContext&&(this.canUseWebAudio=!0);const r=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=n;try{r&&r.canPlayType&&(r.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||r.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch(e){}try{r&&r.canPlayType&&r.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch(e){}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return m})),n.d(t,"c",(function(){return v})),n.d(t,"d",(function(){return E}));var i=n(312),r=n(84),s=n(26),a=n(331),o=n(52),l=n(332),c=(n(318),n(320)),d=n(36);n(401),n(490),n(402);const h=[134,22,135,150,246,214,150,54];function u(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let n=0;for(let e=0;e<h.length;e++)if(t.getUint8(n++)!==h[e])return d.a.Error("Not a babylon environment map"),null;let i="",r=0;for(;r=t.getUint8(n++);)i+=String.fromCharCode(r);let s=JSON.parse(i);return s=f(s),s.binaryDataPosition=n,s.specular&&(s.specular.lodGenerationScale=s.specular.lodGenerationScale||.8),s}function f(e){if(e.version>2)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "2".`);return 2===e.version?e:e={...e,version:2,imageType:"image/png"}}function m(e,t,n){var i;const r=(n=f(n)).specular;if(!r)return Promise.resolve([]);e._lodGenerationScale=r.lodGenerationScale;const s=[],a=function(e,t){const n=(t=f(t)).specular;let i=Math.log2(t.width);if(i=Math.round(i)+1,n.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${n.mipmaps.length}"`);const r=new Array(i);for(let s=0;s<i;s++){r[s]=new Array(6);for(let i=0;i<6;i++){const a=n.mipmaps[6*s+i];r[s][i]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+a.position,a.length)}}return r}(t,n);s.push(g(e,a,n.imageType));const c=null===(i=n.irradiance)||void 0===i?void 0:i.irradianceTexture;if(c){const i=function(e,t){var n;t=f(t);const i=new Array(6),r=null===(n=t.irradiance)||void 0===n?void 0:n.irradianceTexture;if(r){if(6!==r.faces.length)throw new Error(`Incorrect irradiance texture faces number "${r.faces.length}"`);for(let n=0;n<6;n++){const s=r.faces[n];i[n]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+s.position,s.length)}}return i}(t,n);s.push(async function(e,t,n,i="image/png"){const r=e.getEngine(),s=new o.a(r,5),a=new l.a(r,s);e._irradianceTexture=a,s.isCube=!0,s.format=5,s.type=0,s.generateMipMaps=!0,s._cachedAnisotropicFilteringLevel=null,s.generateMipMaps=!0,s.width=n,s.height=n,r.updateTextureSamplingMode(3,s),await _(s,[t],!1,i),r.generateMipMapsForCubemap(s),s.isReady=!0}(e,i,c.size,n.imageType))}return Promise.all(s)}function p(e,t,n,i,r,s,a,o,l,c,d){return new Promise((h,u)=>{if(n){const n=t.createTexture(null,!0,!0,null,1,null,e=>{u(e)},e);null==i||i.onEffectCreatedObservable.addOnce(o=>{o.executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=i=>{i._bindTexture("textureSampler",n),i.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([i],c,!0,s,a),t.restoreDefaultFramebuffer(),n.dispose(),URL.revokeObjectURL(r),h())})})}else{if(t._uploadImageToTexture(d,e,s,a),o){const n=l[a];n&&t._uploadImageToTexture(n._texture,e,s,0)}h()}})}async function g(e,t,n="image/png"){const i=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,i.updateTextureSamplingMode(3,e),await _(e,t,!0,n),e.isReady=!0}async function _(e,t,r,a="image/png"){if(!i.b.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const d=Object(s.c)(e.width)+1,h=e.getEngine();let u=!1,f=!1,m=null,g=null,_=null;const v=h.getCaps();v.textureLOD?h._features.supportRenderAndCopyToLodForFloatTextures?v.textureHalfFloatRender&&v.textureHalfFloatLinearFiltering?(u=!0,e.type=2):v.textureFloatRender&&v.textureFloatLinearFiltering&&(u=!0,e.type=1):u=!1:(u=!1,f=r);let E=0;if(u)h.isWebGPU?(E=1,await n.e(0).then(n.bind(null,407))):await n.e(0).then(n.bind(null,408)),m=new c.a("rgbdDecode","rgbdDecode",null,null,1,null,3,h,!1,void 0,e.type,void 0,null,!1,void 0,E),e._isRGBD=!1,e.invertY=!1,g=h.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,f){const t=3;_={};const n=e._lodGenerationScale,i=e._lodGenerationOffset;for(let r=0;r<t;r++){const s=(d-1)*n+i,a=i+(s-i)*(1-r/(t-1)),c=Math.round(Math.min(Math.max(a,0),s)),u=new o.a(h,2);u.isCube=!0,u.invertY=!0,u.generateMipMaps=!1,h.updateTextureSamplingMode(2,u);const f=new l.a(null);switch(f._isCube=!0,f._texture=u,_[c]=f,r){case 0:e._lodTextureLow=f;break;case 1:e._lodTextureMid=f;break;case 2:e._lodTextureHigh=f}}}const T=[];for(let n=0;n<t.length;n++)for(let i=0;i<6;i++){const r=t[n][i],s=new Blob([r],{type:a}),o=URL.createObjectURL(s);let l;if(h._features.forceBitmapOverHTMLImageElement)l=h.createImageBitmap(s,{premultiplyAlpha:"none"}).then(t=>p(t,h,u,m,o,i,n,f,_,g,e));else{const t=new Image;t.src=o,l=new Promise((r,s)=>{t.onload=()=>{p(t,h,u,m,o,i,n,f,_,g,e).then(()=>r()).catch(e=>{s(e)})},t.onerror=e=>{s(e)}})}T.push(l)}if(t.length<d){let n;const i=Math.pow(2,d-1-t.length),r=i*i*4;switch(e.type){case 0:n=new Uint8Array(r);break;case 2:n=new Uint16Array(r);break;case 1:n=new Float32Array(r)}for(let i=t.length;i<d;i++)for(let t=0;t<6;t++)h._uploadArrayBufferViewToTexture(e,n,t,i)}if(await Promise.all(T),g){const t=e._irradianceTexture;e._irradianceTexture=null,h._releaseTexture(e),g._swapAndDie(e),e._irradianceTexture=t}m&&m.dispose(),f&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function v(e,t){const n=(t=f(t)).irradiance;if(!n)return;const i=new a.b;r.e.FromArrayToRef(n.x,0,i.x),r.e.FromArrayToRef(n.y,0,i.y),r.e.FromArrayToRef(n.z,0,i.z),r.e.FromArrayToRef(n.xx,0,i.xx),r.e.FromArrayToRef(n.yy,0,i.yy),r.e.FromArrayToRef(n.zz,0,i.zz),r.e.FromArrayToRef(n.yz,0,i.yz),r.e.FromArrayToRef(n.zx,0,i.zx),r.e.FromArrayToRef(n.xy,0,i.xy),e._sphericalPolynomial=i}function E(e,t,n,i,r){const s=g(e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),t).then(()=>e);return e.onRebuildCallback=e=>({proxy:s,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=t,e._lodGenerationScale=i,e._lodGenerationOffset=r,e._sphericalPolynomial=n,g(e,t).then(()=>(e.isReady=!0,e))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return s}));class i{}i.KEYDOWN=1,i.KEYUP=2;class r{constructor(e,t){this.type=e,this.event=t}}class s extends r{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}},function(e,t,n){"use strict";var i;n.d(t,"a",(function(){return r})),function(e){e[e.PointerMove=0]="PointerMove",e[e.PointerDown=1]="PointerDown",e[e.PointerUp=2]="PointerUp"}(i||(i={}));class r{}r.DOM_DELTA_PIXEL=0,r.DOM_DELTA_LINE=1,r.DOM_DELTA_PAGE=2},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(320),r=n(485);class s{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const r=t.getEngine(),s=r.getCaps(),a=t.isReady;let o=!1;s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?(o=!0,t.type=2):s.textureFloatRender&&s.textureFloatLinearFiltering&&(o=!0,t.type=1),o&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const l=async()=>{const s=r.isWebGPU,a=s?1:0;t.isReady=!1,s?await n.e(0).then(n.bind(null,407)):await n.e(0).then(n.bind(null,408));const o=new i.a("rgbdDecode","rgbdDecode",null,null,1,null,3,r,!1,void 0,t.type,void 0,null,!1,void 0,a);o.externalTextureSamplerBinding=!0;const l=r.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});o.onEffectCreatedObservable.addOnce(n=>{n.executeWhenCompiled(()=>{o.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([o],l,!0),r.restoreDefaultFramebuffer(),r._releaseTexture(t),o&&o.dispose(),l._swapAndDie(t),t.isReady=!0})})};o&&(a?l():e.onLoadObservable.addOnce(l))}static async EncodeTextureToRGBD(e,t,i=0){return t.getEngine().isWebGPU?await n.e(0).then(n.bind(null,494)):await n.e(0).then(n.bind(null,493)),Object(r.a)("rgbdEncode",e,t,i,1,5)}}},function(e,t,n){"use strict";var i=n(391),r=n(332);r.a.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(r.a.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=i.a.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0})},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i extends class{dispose(){for(const e of this._workerInfos)e.workerPromise.then(e=>{e.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(n=>{t(n,()=>{const t=this._pendingActions.shift();t?this._execute(e,t):e.idle=!0})})}constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(e=>({workerPromise:Promise.resolve(e),idle:!0}))}}{push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(n,i)=>{t(n,()=>{i(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(e=>{e.terminate()});const t=this._workerInfos.indexOf(e);-1!==t&&this._workerInfos.splice(t,1)},this._options.idleTimeElapsedBeforeRelease))})})}constructor(e,t,n=i.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=n}}i.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class i{clone(){return new i(this.name,this.from,this.to)}constructor(e,t,n){this.name=e,this.from=t,this.to=n}}},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.pointCloudVertex="#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n"},function(e,t,n){"use strict";n.r(t),n.d(t,"postprocessVertexShaderWGSL",(function(){return s}));const i="postprocessVertexShader",r="attribute position: vec2<f32>;uniform scale: vec2<f32>;varying vUV: vec2<f32>;const madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=(vertexInputs.position*madd+madd)*uniforms.scale;vertexOutputs.position=vec4(vertexInputs.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n";n(66).a.ShadersStoreWGSL[i]=r;const s={name:i,shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"rgbdDecodePixelShaderWGSL",(function(){return a}));var i=n(66);n(322);const r="rgbdDecodePixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=vec4f(fromRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV)),1.0);}";i.a.ShadersStoreWGSL[r]=s;const a={name:r,shader:s}},function(e,t,n){"use strict";n.r(t),n.d(t,"rgbdDecodePixelShader",(function(){return a}));var i=n(66);n(323);const r="rgbdDecodePixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}";i.a.ShadersStore[r]=s;const a={name:r,shader:s}},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.kernelBlurVaryingDeclaration="varying sampleCoord{X}: vec2f;"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.kernelBlurVaryingDeclaration="varying vec2 sampleCoord{X};"},function(e,t,n){"use strict";var i=n(66);n(381),n(382);i.a.IncludesShadersStoreWGSL.defaultUboDeclaration="uniform diffuseLeftColor: vec4f;uniform diffuseRightColor: vec4f;uniform opacityParts: vec4f;uniform reflectionLeftColor: vec4f;uniform reflectionRightColor: vec4f;uniform refractionLeftColor: vec4f;uniform refractionRightColor: vec4f;uniform emissiveLeftColor: vec4f;uniform emissiveRightColor: vec4f;uniform vDiffuseInfos: vec2f;uniform vAmbientInfos: vec2f;uniform vOpacityInfos: vec2f;uniform vReflectionInfos: vec2f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vSpecularInfos: vec2f;uniform vBumpInfos: vec3f;uniform diffuseMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform reflectionMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform specularMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform pointSize: f32;uniform alphaCutOff: f32;uniform refractionMatrix: mat4x4f;uniform vRefractionInfos: vec4f;uniform vRefractionPosition: vec3f;uniform vRefractionSize: vec3f;uniform vSpecularColor: vec4f;uniform vEmissiveColor: vec3f;uniform vDiffuseColor: vec4f;uniform vAmbientColor: vec3f;\n#define ADDITIONAL_UBO_DECLARATION\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.uvAttributeDeclaration="#ifdef UV{X}\nattribute uv{X}: vec2f;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.prePassVertexDeclaration="#ifdef PREPASS\n#ifdef PREPASS_LOCAL_POSITION\nvarying vPosition : vec3f;\n#endif\n#ifdef PREPASS_DEPTH\nvarying vViewPos: vec3f;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nuniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.samplerVertexDeclaration="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nvarying v_VARYINGNAME_UV: vec2f;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.bumpVertexDeclaration="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL) \nvarying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.fogVertexDeclaration="#ifdef FOG\nvarying vFogDistance: vec3f;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.lightVxUboDeclaration="#ifdef LIGHT{X}\nstruct Light{X}\n{vLightData: vec4f,\nvLightDiffuse: vec4f,\nvLightSpecular: vec4f,\n#ifdef SPOTLIGHT{X}\nvLightDirection: vec4f,\nvLightFalloff: vec4f,\n#elif defined(POINTLIGHT{X})\nvLightFalloff: vec4f,\n#elif defined(HEMILIGHT{X})\nvLightGround: vec3f,\n#endif\n#if defined(AREALIGHT{X})\nvLightWidth: vec4f,\nvLightHeight: vec4f,\n#endif\nshadowsInfo: vec4f,\ndepthValues: vec2f} ;var<uniform> light{X} : Light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.prePassVertex="#ifdef PREPASS_DEPTH\nvertexOutputs.vViewPos=(scene.view*worldPos).rgb;\n#endif\n#ifdef PREPASS_LOCAL_POSITION\nvertexOutputs.vPosition=positionUpdated.xyz;\n#endif\n#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*worldPos;\n#if NUM_BONE_INFLUENCERS>0\nvar previousInfluence: mat4x4f;previousInfluence=mPreviousBones[ i32(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[ i32(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[ i32(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[ i32(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);\n#else\nvertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.uvVariableDeclaration="#ifdef MAINUV{X}\n#if !defined(UV{X})\nvar uv{X}: vec2f=vec2f(0.,0.);\n#else\nvar uv{X}: vec2f=vertexInputs.uv{X};\n#endif\nvertexOutputs.vMainUV{X}=uv{X};\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.samplerVertexImplementation="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nif (uniforms.v_INFONAME_==0.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(uvUpdated,1.0,0.0)).xy;}\n#ifdef UV2\nelse if (uniforms.v_INFONAME_==1.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(uv2Updated,1.0,0.0)).xy;}\n#endif\n#ifdef UV3\nelse if (uniforms.v_INFONAME_==2.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv3,1.0,0.0)).xy;}\n#endif\n#ifdef UV4\nelse if (uniforms.v_INFONAME_==3.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv4,1.0,0.0)).xy;}\n#endif\n#ifdef UV5\nelse if (uniforms.v_INFONAME_==4.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv5,1.0,0.0)).xy;}\n#endif\n#ifdef UV6\nelse if (uniforms.v_INFONAME_==5.)\n{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv6,1.0,0.0)).xy;}\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.bumpVertex="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvar tbnNormal: vec3f=normalize(normalUpdated);var tbnTangent: vec3f=normalize(tangentUpdated.xyz);var tbnBitangent: vec3f=cross(tbnNormal,tbnTangent)*tangentUpdated.w;var matTemp= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz)* mat3x3f(tbnTangent,tbnBitangent,tbnNormal);vertexOutputs.vTBN0=matTemp[0];vertexOutputs.vTBN1=matTemp[1];vertexOutputs.vTBN2=matTemp[2];\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.fogVertex="#ifdef FOG\n#ifdef SCENE_UBO\nvertexOutputs.vFogDistance=(scene.view*worldPos).xyz;\n#else\nvertexOutputs.vFogDistance=(uniforms.view*worldPos).xyz;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.shadowsVertex="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvertexOutputs.vPositionFromCamera{X}=scene.view*worldPos;\n#if SHADOWCSMNUM_CASCADES{X}>0\nvertexOutputs.vPositionFromLight{X}_0=uniforms.lightMatrix{X}[0]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_0=(-vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_0= (vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#if SHADOWCSMNUM_CASCADES{X}>1\nvertexOutputs.vPositionFromLight{X}_1=uniforms.lightMatrix{X}[1]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_1=(-vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_1= (vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif \n#if SHADOWCSMNUM_CASCADES{X}>2\nvertexOutputs.vPositionFromLight{X}_2=uniforms.lightMatrix{X}[2]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_2=(-vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_2= (vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif \n#if SHADOWCSMNUM_CASCADES{X}>3\nvertexOutputs.vPositionFromLight{X}_3=uniforms.lightMatrix{X}[3]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_3=(-vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_3= (vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif \n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvertexOutputs.vPositionFromLight{X}=uniforms.lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}=(-vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}=(vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.vertexColorMixing="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvertexOutputs.vColor=vec4f(1.0);\n#ifdef VERTEXCOLOR\n#ifdef VERTEXALPHA\nvertexOutputs.vColor*=vertexInputs.color;\n#else\nvertexOutputs.vColor=vec4f(vertexOutputs.vColor.rgb*vertexInputs.color.rgb,vertexOutputs.vColor.a);\n#endif\n#endif\n#ifdef INSTANCESCOLOR\nvertexOutputs.vColor*=vertexInputs.instanceColor;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.logDepthVertex="#ifdef LOGARITHMICDEPTH\nvertexOutputs.vFragmentDepth=1.0+vertexOutputs.position.w;vertexOutputs.position.z=log2(max(0.000001,vertexOutputs.vFragmentDepth))*uniforms.logarithmicDepthConstant;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.prePassDeclaration="#ifdef PREPASS\n#ifdef PREPASS_LOCAL_POSITION\nvarying vPosition : vec3f;\n#endif\n#ifdef PREPASS_DEPTH\nvarying vViewPos: vec3f;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nvarying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.oitDeclaration="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\n#define MAX_DEPTH 99999.0\nvar oitDepthSamplerSampler: sampler;var oitDepthSampler: texture_2d<f32>;var oitFrontColorSamplerSampler: sampler;var oitFrontColorSampler: texture_2d<f32>;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.lightUboDeclaration="#ifdef LIGHT{X}\nstruct Light{X}\n{vLightData: vec4f,\nvLightDiffuse: vec4f,\nvLightSpecular: vec4f,\n#ifdef SPOTLIGHT{X}\nvLightDirection: vec4f,\nvLightFalloff: vec4f,\n#elif defined(POINTLIGHT{X})\nvLightFalloff: vec4f,\n#elif defined(HEMILIGHT{X})\nvLightGround: vec3f,\n#endif\n#if defined(AREALIGHT{X})\nvLightWidth: vec4f,\nvLightHeight: vec4f,\n#endif\nshadowsInfo: vec4f,\ndepthValues: vec2f} ;var<uniform> light{X} : Light{X};\n#ifdef IESLIGHTTEXTURE{X}\nvar iesLightTexture{X}Sampler: sampler;var iesLightTexture{X}: texture_2d<f32>;\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform textureProjectionMatrix{X}: mat4x4f;var projectionLightTexture{X}Sampler: sampler;var projectionLightTexture{X}: texture_2d<f32>;\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;uniform viewFrustumZ{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform frustumLengths{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform cascadeBlendFactor{X}: f32;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;var<private> vPositionFromLight{X}: array<vec4f,4>;var<private> vDepthMetric{X} : array<f32,4>;\n#if defined(SHADOWPCSS{X})\nvar shadowTexture{X}Sampler: sampler_comparison; \nvar shadowTexture{X}: texture_depth_2d_array;var depthTexture{X}Sampler: sampler;var depthTexture{X}: texture_2d_array<f32>;uniform lightSizeUVCorrection{X}: array<vec2f,SHADOWCSMNUM_CASCADES{X}>;uniform depthCorrection{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform penumbraDarkness{X}: f32;\n#elif defined(SHADOWPCF{X})\nvar shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d_array;\n#else \nvar shadowTexture{X}Sampler: sampler; \nvar shadowTexture{X}: texture_2d_array<f32>;\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vCascadeColorsMultiplier{X}: array<vec3f,8>=array<vec3f,8>\n(\nvec3f ( 1.5,0.0,0.0 ),\nvec3f ( 0.0,1.5,0.0 ),\nvec3f ( 0.0,0.0,5.5 ),\nvec3f ( 1.5,0.0,5.5 ),\nvec3f ( 1.5,1.5,0.0 ),\nvec3f ( 1.0,1.0,1.0 ),\nvec3f ( 0.0,1.0,5.5 ),\nvec3f ( 0.5,3.5,0.75 )\n);\n#endif\n#elif defined(SHADOWCUBE{X})\nvar shadowTexture{X}Sampler: sampler;var shadowTexture{X}: texture_cube<f32>;\n#else\nvarying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;\n#if defined(SHADOWPCSS{X})\nvar shadowTexture{X}Sampler: sampler_comparison; \nvar shadowTexture{X}: texture_depth_2d;var depthTexture{X}Sampler: sampler; \nvar depthTexture{X}: texture_2d<f32>;\n#elif defined(SHADOWPCF{X})\nvar shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d;\n#else\nvar shadowTexture{X}Sampler: sampler; \nvar shadowTexture{X}: texture_2d<f32>;\n#endif\nuniform lightMatrix{X}: mat4x4f;\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.ltcHelperFunctions="fn LTCUv(N: vec3f,V: vec3f,roughness: f32)->vec2f {var LUTSIZE: f32=64.0;var LUTSCALE: f32=( LUTSIZE-1.0 )/LUTSIZE;var LUTBIAS:f32=0.5/LUTSIZE;var dotNV:f32=saturate( dot( N,V ) );var uv:vec2f=vec2f( roughness,sqrt( 1.0-dotNV ) );uv=uv*LUTSCALE+LUTBIAS;return uv;}\nfn LTCClippedSphereFormFactor( f:vec3f )->f32 {var l: f32=length( f );return max( ( l*l+f.z )/( l+1.0 ),0.0 );}\nfn LTCEdgeVectorFormFactor( v1:vec3f,v2:vec3f )->vec3f {var x:f32=dot( v1,v2 );var y:f32=abs( x );var a:f32=0.8543985+( 0.4965155+0.0145206*y )*y;var b:f32=3.4175940+( 4.1616724+y )*y;var v:f32=a/b;var thetaSintheta:f32=0.0;if( x>0.0 )\n{thetaSintheta=v;}\nelse\n{thetaSintheta=0.5*inverseSqrt( max( 1.0-x*x,0.00000001 ) )-v;}\nreturn cross( v1,v2 )*thetaSintheta;}\nfn LTCEvaluate( N:vec3f,V:vec3f,P:vec3f,mInv: mat3x3<f32>,rectCoords0:vec3f,rectCoords1:vec3f,rectCoords2:vec3f,rectCoords3:vec3f )->vec3f {var v1:vec3f=rectCoords1-rectCoords0;var v2:vec3f=rectCoords3-rectCoords0;var lightNormal:vec3f=cross( v1,v2 );if( dot( lightNormal,P-rectCoords0 )<0.0 ){return vec3f( 0.0 );}\nvar T1:vec3f=normalize( V-N*dot( V,N ) );var T2:vec3f=- cross( N,T1 ); \nvar mat: mat3x3<f32>=mInv*transposeMat3( mat3x3<f32>( T1,T2,N ) );var coords0: vec3f=mat*( rectCoords0-P );var coords1: vec3f=mat*( rectCoords1-P );var coords2: vec3f=mat*( rectCoords2-P );var coords3: vec3f=mat*( rectCoords3-P );coords0=normalize( coords0 );coords1=normalize( coords1 );coords2=normalize( coords2 );coords3=normalize( coords3 );var vectorFormFactor:vec3f=vec3( 0.0 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords0,coords1 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords1,coords2 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords2,coords3 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords3,coords0 );var result:f32=LTCClippedSphereFormFactor( vectorFormFactor );return vec3f( result );}\nstruct areaLightData\n{Diffuse: vec3f,\nSpecular: vec3f,\nFresnel: vec4f};fn computeAreaLightSpecularDiffuseFresnel(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDir: vec3f,normal:vec3f,position:vec3f,lightPos:vec3f,halfWidth:vec3f, halfHeight:vec3f,roughness:f32)->areaLightData {var result: areaLightData;var rectCoords0:vec3f=lightPos+halfWidth-halfHeight; \nvar rectCoords1:vec3f=lightPos-halfWidth-halfHeight;var rectCoords2:vec3f=lightPos-halfWidth+halfHeight;var rectCoords3:vec3f=lightPos+halfWidth+halfHeight;\n#ifdef SPECULARTERM\nvar uv:vec2f=LTCUv( normal,viewDir,roughness );var t1:vec4f=textureSample( ltc1,ltc1Sampler,uv );var t2:vec4f=textureSample( ltc2,ltc2Sampler,uv );var mInv:mat3x3<f32>=mat3x3<f32>(\nvec3f( t1.x,0,t1.y ),\nvec3f( 0,1, 0 ),\nvec3f( t1.z,0,t1.w )\n);result.Fresnel=t2;result.Specular=LTCEvaluate( normal,viewDir,position,mInv,rectCoords0,rectCoords1,rectCoords2,rectCoords3 );\n#endif\nvar mInvEmpty:mat3x3<f32>=mat3x3<f32>(\nvec3f( 1,0,0 ),\nvec3f( 0,1,0 ),\nvec3f( 0,0,1 )\n);result.Diffuse+=LTCEvaluate( normal,viewDir,position,mInvEmpty,rectCoords0,rectCoords1,rectCoords2,rectCoords3 );return result;}"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.shadowsFragmentFunctions="#ifdef SHADOWS\n#ifndef SHADOWFLOAT\nfn unpack(color: vec4f)->f32\n{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}\n#endif\nfn computeFallOff(value: f32,clipSpace: vec2f,frustumEdgeFalloff: f32)->f32\n{var mask: f32=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}\nfn computeShadowCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nvar shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));\n#else\nvar shadow: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;\n#endif\nreturn select(1.0,darkness,depth>shadow);}\nfn computeShadowWithPoissonSamplingCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;var visibility: f32=1.;var poissonDisk: array<vec3f,4>;poissonDisk[0]= vec3f(-1.0,1.0,-1.0);poissonDisk[1]= vec3f(1.0,-1.0,-1.0);poissonDisk[2]= vec3f(-1.0,-1.0,-1.0);poissonDisk[3]= vec3f(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) {visibility-=0.25;};\n#else\nif (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) {visibility-=0.25;};\n#endif\nreturn min(1.0,visibility+darkness);}\nfn computeShadowWithESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));\n#else\nvar shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;\n#endif\nvar esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}\nfn computeShadowWithCloseESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));\n#else\nvar shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;\n#endif\nvar esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}\nfn computeShadowCSM(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d_array<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nvar shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,uv,layer));\n#else\nvar shadow: f32=textureSample(shadowTexture,shadowSampler,uv,layer).x;\n#endif\nreturn select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}\nfn computeShadow(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nvar shadow: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));\n#else\nvar shadow: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;\n#endif\nreturn select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}}\nfn computeShadowWithPoissonSampling(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);var visibility: f32=1.;var poissonDisk: array<vec2f,4>;poissonDisk[0]= vec2f(-0.94201624,-0.39906216);poissonDisk[1]= vec2f(0.94558609,-0.76890725);poissonDisk[2]= vec2f(-0.094184101,-0.92938870);poissonDisk[3]= vec2f(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\n#else\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));\n#else\nvar shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;\n#endif\nvar esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithCloseESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));\n#else\nvar shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;\n#endif\nvar esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\nfn getZInClip(clipSpace: vec3f,uvDepth: vec3f)->f32\n{\n#ifdef IS_NDC_HALF_ZRANGE\nreturn clipSpace.z;\n#else\nreturn uvDepth.z;\n#endif\n}\nconst GREATEST_LESS_THAN_ONE: f32=0.99999994;\n#define DISABLE_UNIFORMITY_ANALYSIS\nfn computeShadowWithCSMPCF1(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var shadow: f32=textureSampleCompare(shadowTexture,shadowSampler,uvDepth.xy,layer,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\nfn computeShadowWithCSMPCF3(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\nfn computeShadowWithCSMPCF5(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),layer,uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),layer,uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),layer,uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),layer,uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\nfn computeShadowWithPCF1(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var shadow: f32=textureSampleCompareLevel(shadowTexture,shadowSampler,uvDepth.xy,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithPCF3(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithPCF5(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nconst PoissonSamplers32: array<vec3f,64>=array<vec3f,64> (\nvec3f(0.06407013,0.05409927,0.),\nvec3f(0.7366577,0.5789394,0.),\nvec3f(-0.6270542,-0.5320278,0.),\nvec3f(-0.4096107,0.8411095,0.),\nvec3f(0.6849564,-0.4990818,0.),\nvec3f(-0.874181,-0.04579735,0.),\nvec3f(0.9989998,0.0009880066,0.),\nvec3f(-0.004920578,-0.9151649,0.),\nvec3f(0.1805763,0.9747483,0.),\nvec3f(-0.2138451,0.2635818,0.),\nvec3f(0.109845,0.3884785,0.),\nvec3f(0.06876755,-0.3581074,0.),\nvec3f(0.374073,-0.7661266,0.),\nvec3f(0.3079132,-0.1216763,0.),\nvec3f(-0.3794335,-0.8271583,0.),\nvec3f(-0.203878,-0.07715034,0.),\nvec3f(0.5912697,0.1469799,0.),\nvec3f(-0.88069,0.3031784,0.),\nvec3f(0.5040108,0.8283722,0.),\nvec3f(-0.5844124,0.5494877,0.),\nvec3f(0.6017799,-0.1726654,0.),\nvec3f(-0.5554981,0.1559997,0.),\nvec3f(-0.3016369,-0.3900928,0.),\nvec3f(-0.5550632,-0.1723762,0.),\nvec3f(0.925029,0.2995041,0.),\nvec3f(-0.2473137,0.5538505,0.),\nvec3f(0.9183037,-0.2862392,0.),\nvec3f(0.2469421,0.6718712,0.),\nvec3f(0.3916397,-0.4328209,0.),\nvec3f(-0.03576927,-0.6220032,0.),\nvec3f(-0.04661255,0.7995201,0.),\nvec3f(0.4402924,0.3640312,0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.)\n);const PoissonSamplers64: array<vec3f,64>=array<vec3f,64> (\nvec3f(-0.613392,0.617481,0.),\nvec3f(0.170019,-0.040254,0.),\nvec3f(-0.299417,0.791925,0.),\nvec3f(0.645680,0.493210,0.),\nvec3f(-0.651784,0.717887,0.),\nvec3f(0.421003,0.027070,0.),\nvec3f(-0.817194,-0.271096,0.),\nvec3f(-0.705374,-0.668203,0.),\nvec3f(0.977050,-0.108615,0.),\nvec3f(0.063326,0.142369,0.),\nvec3f(0.203528,0.214331,0.),\nvec3f(-0.667531,0.326090,0.),\nvec3f(-0.098422,-0.295755,0.),\nvec3f(-0.885922,0.215369,0.),\nvec3f(0.566637,0.605213,0.),\nvec3f(0.039766,-0.396100,0.),\nvec3f(0.751946,0.453352,0.),\nvec3f(0.078707,-0.715323,0.),\nvec3f(-0.075838,-0.529344,0.),\nvec3f(0.724479,-0.580798,0.),\nvec3f(0.222999,-0.215125,0.),\nvec3f(-0.467574,-0.405438,0.),\nvec3f(-0.248268,-0.814753,0.),\nvec3f(0.354411,-0.887570,0.),\nvec3f(0.175817,0.382366,0.),\nvec3f(0.487472,-0.063082,0.),\nvec3f(-0.084078,0.898312,0.),\nvec3f(0.488876,-0.783441,0.),\nvec3f(0.470016,0.217933,0.),\nvec3f(-0.696890,-0.549791,0.),\nvec3f(-0.149693,0.605762,0.),\nvec3f(0.034211,0.979980,0.),\nvec3f(0.503098,-0.308878,0.),\nvec3f(-0.016205,-0.872921,0.),\nvec3f(0.385784,-0.393902,0.),\nvec3f(-0.146886,-0.859249,0.),\nvec3f(0.643361,0.164098,0.),\nvec3f(0.634388,-0.049471,0.),\nvec3f(-0.688894,0.007843,0.),\nvec3f(0.464034,-0.188818,0.),\nvec3f(-0.440840,0.137486,0.),\nvec3f(0.364483,0.511704,0.),\nvec3f(0.034028,0.325968,0.),\nvec3f(0.099094,-0.308023,0.),\nvec3f(0.693960,-0.366253,0.),\nvec3f(0.678884,-0.204688,0.),\nvec3f(0.001801,0.780328,0.),\nvec3f(0.145177,-0.898984,0.),\nvec3f(0.062655,-0.611866,0.),\nvec3f(0.315226,-0.604297,0.),\nvec3f(-0.780145,0.486251,0.),\nvec3f(-0.371868,0.882138,0.),\nvec3f(0.200476,0.494430,0.),\nvec3f(-0.494552,-0.711051,0.),\nvec3f(0.612476,0.705252,0.),\nvec3f(-0.578845,-0.768792,0.),\nvec3f(-0.772454,-0.090976,0.),\nvec3f(0.504440,0.372295,0.),\nvec3f(0.155736,0.065157,0.),\nvec3f(0.391522,0.849605,0.),\nvec3f(-0.620106,-0.328104,0.),\nvec3f(0.789239,-0.419965,0.),\nvec3f(-0.545396,0.538133,0.),\nvec3f(-0.178564,-0.596057,0.)\n);fn computeShadowWithCSMPCSS(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uvDepthLayer: vec4f= vec4f(uvDepth.x,uvDepth.y,f32(layer),uvDepth.z);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;for (var i: i32=0; i<searchTapCount; i ++) {blockerDepth=textureSample(depthTexture,depthSampler, uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}\nvar avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);var filterRadius: vec4f= vec4f(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {var offset: vec4f= vec4f(poissonSamplers[i],0.);offset= vec4f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);let coords=uvDepthLayer+offset*filterRadius;shadow+=textureSampleCompare(shadowTexture,shadowSampler,coords.xy,i32(coords.z),coords.w);}\nshadow/= f32(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,numBlocker<1.0);}\nfn computeShadowWithPCSS(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;var exitCondition: bool=depthMetric>1.0 || depthMetric<0.0;for (var i: i32=0; i<searchTapCount; i ++) {if (exitCondition) {break;}\nblockerDepth=textureSampleLevel(depthTexture,depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}\nexitCondition=exitCondition || numBlocker<1.0;var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)+AAOffset);var filterRadius: f32=penumbraRatio*lightSizeUV*shadowMapSizeInverse;var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {if (exitCondition) {break;}\nvar offset: vec3f=poissonSamplers[i];offset= vec3f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);let coords=uvDepth+offset*filterRadius;shadow+=textureSampleCompareLevel(shadowTexture,shadowSampler,coords.xy,coords.z);}\nshadow/= f32(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,exitCondition);}\nfn computeShadowWithPCSS16(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}\nfn computeShadowWithPCSS32(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}\nfn computeShadowWithPCSS64(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}\nfn computeShadowWithCSMPCSS16(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\nfn computeShadowWithCSMPCSS32(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\nfn computeShadowWithCSMPCSS64(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.reflectionFunction="fn computeFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f\n{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0); }\nfn computeMirroredFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f\n{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(1.0-s,t,0); }\nfn computeEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{var cameraToVertex: vec3f=normalize(worldPos.xyz-eyePosition);var r: vec3f=normalize(reflect(cameraToVertex,worldNormal));r= (reflectionMatrix* vec4f(r,0)).xyz;var lon: f32=atan2(r.z,r.x);var lat: f32=acos(r.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0);}\nfn computeSphericalCoords(worldPos: vec4f,worldNormal: vec3f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f\n{var viewDir: vec3f=normalize((view*worldPos).xyz);var viewNormal: vec3f=normalize((view* vec4f(worldNormal,0.0)).xyz);var r: vec3f=reflect(viewDir,viewNormal);r= (reflectionMatrix* vec4f(r,0)).xyz;r.z=r.z-1.0;var m: f32=2.0*length(r);return vec3f(r.x/m+0.5,1.0-r.y/m-0.5,0);}\nfn computePlanarCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{var viewDir: vec3f=worldPos.xyz-eyePosition;var coords: vec3f=normalize(reflect(viewDir,worldNormal));return (reflectionMatrix* vec4f(coords,1)).xyz;}\nfn computeCubicCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords= (reflectionMatrix* vec4f(coords,0)).xyz;\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nfn computeCubicLocalCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f,reflectionSize: vec3f,reflectionPosition: vec3f)->vec3f\n{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=(reflectionMatrix* vec4f(coords,0)).xyz;\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nfn computeProjectionCoords(worldPos: vec4f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f\n{return (reflectionMatrix*(view*worldPos)).xyz;}\nfn computeSkyBoxCoords(positionW: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{return (reflectionMatrix* vec4f(positionW,1.)).xyz;}\n#ifdef REFLECTION\nfn computeReflectionCoords(worldPos: vec4f,worldNormal: vec3f)->vec3f\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvar direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvar direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,scene.view,uniforms.reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix,uniforms.vReflectionSize,uniforms.vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,scene.view,uniforms.reflectionMatrix);\n#endif\n#ifndef REFLECTIONMAP_CUBIC\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(fragmentInputs.vPositionUVW,uniforms.reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3f(0,0,0);\n#endif\n}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.imageProcessingDeclaration="#ifdef EXPOSURE\nuniform exposureLinear: f32;\n#endif\n#ifdef CONTRAST\nuniform contrast: f32;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vInverseScreenSize: vec2f;\n#endif\n#ifdef VIGNETTE\nuniform vignetteSettings1: vec4f;uniform vignetteSettings2: vec4f;\n#endif\n#ifdef COLORCURVES\nuniform vCameraColorCurveNegative: vec4f;uniform vCameraColorCurveNeutral: vec4f;uniform vCameraColorCurvePositive: vec4f;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nvar txColorTransformSampler: sampler;var txColorTransform: texture_3d<f32>;\n#else\nvar txColorTransformSampler: sampler;var txColorTransform: texture_2d<f32>;\n#endif\nuniform colorTransformSettings: vec4f;\n#endif\n#ifdef DITHER\nuniform ditherIntensity: f32;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.imageProcessingFunctions="#if TONEMAPPING==3\nconst PBRNeutralStartCompression: f32=0.8-0.04;const PBRNeutralDesaturation: f32=0.15;fn PBRNeutralToneMapping( color: vec3f )->vec3f {var x: f32=min(color.r,min(color.g,color.b));var offset: f32=select(0.04,x-6.25*x*x,x<0.08);var result=color;result-=offset;var peak: f32=max(result.r,max(result.g,result.b));if (peak<PBRNeutralStartCompression) {return result;}\nvar d: f32=1.-PBRNeutralStartCompression;var newPeak: f32=1.-d*d/(peak+d-PBRNeutralStartCompression);result*=newPeak/peak;var g: f32=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(result,newPeak* vec3f(1,1,1),g);}\n#endif\n#if TONEMAPPING==2\nconst ACESInputMat: mat3x3f= mat3x3f(\nvec3f(0.59719,0.07600,0.02840),\nvec3f(0.35458,0.90834,0.13383),\nvec3f(0.04823,0.01566,0.83777)\n);const ACESOutputMat: mat3x3f= mat3x3f(\nvec3f( 1.60475,-0.10208,-0.00327),\nvec3f(-0.53108, 1.10813,-0.07276),\nvec3f(-0.07367,-0.00605, 1.07602)\n);fn RRTAndODTFit(v: vec3f)->vec3f\n{var a: vec3f=v*(v+0.0245786)-0.000090537;var b: vec3f=v*(0.983729*v+0.4329510)+0.238081;return a/b;}\nfn ACESFitted(color: vec3f)->vec3f\n{var output=ACESInputMat*color;output=RRTAndODTFit(output);output=ACESOutputMat*output;output=saturateVec3(output);return output;}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nfn applyImageProcessing(result: vec4f)->vec4f {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\nvar rgb=result.rgb;;\n#ifdef EXPOSURE\nrgb*=uniforms.exposureLinear;\n#endif\n#ifdef VIGNETTE\nvar viewportXY: vec2f=fragmentInputs.position.xy*uniforms.vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;var vignetteXY1: vec3f= vec3f(viewportXY*uniforms.vignetteSettings1.xy+uniforms.vignetteSettings1.zw,1.0);var vignetteTerm: f32=dot(vignetteXY1,vignetteXY1);var vignette: f32=pow(vignetteTerm,uniforms.vignetteSettings2.w);var vignetteColor: vec3f=uniforms.vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvar vignetteColorMultiplier: vec3f=mix(vignetteColor, vec3f(1,1,1),vignette);rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nrgb=mix(vignetteColor,rgb,vignette);\n#endif\n#endif\n#if TONEMAPPING==3\nrgb=PBRNeutralToneMapping(rgb);\n#elif TONEMAPPING==2\nrgb=ACESFitted(rgb);\n#elif TONEMAPPING==1\nconst tonemappingCalibration: f32=1.590579;rgb=1.0-exp2(-tonemappingCalibration*rgb);\n#endif\nrgb=toGammaSpaceVec3(rgb);rgb=saturateVec3(rgb);\n#ifdef CONTRAST\nvar resultHighContrast: vec3f=rgb*rgb*(3.0-2.0*rgb);if (uniforms.contrast<1.0) {rgb=mix( vec3f(0.5,0.5,0.5),rgb,uniforms.contrast);} else {rgb=mix(rgb,resultHighContrast,uniforms.contrast-1.0);}\n#endif\n#ifdef COLORGRADING\nvar colorTransformInput: vec3f=rgb*uniforms.colorTransformSettings.xxx+uniforms.colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvar colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput).rgb;\n#else\nvar colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput,uniforms.colorTransformSettings.yz).rgb;\n#endif\nrgb=mix(rgb,colorTransformOutput,uniforms.colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nvar luma: f32=getLuminance(rgb);var curveMix: vec2f=clamp( vec2f(luma*3.0-1.5,luma*-3.0+1.5), vec2f(0.0), vec2f(1.0));var colorCurve: vec4f=uniforms.vCameraColorCurveNeutral+curveMix.x*uniforms.vCameraColorCurvePositive-curveMix.y*uniforms.vCameraColorCurveNegative;rgb*=colorCurve.rgb;rgb=mix( vec3f(luma),rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nvar rand: f32=getRand(fragmentInputs.position.xy*uniforms.vInverseScreenSize);var dither: f32=mix(-uniforms.ditherIntensity,uniforms.ditherIntensity,rand);rgb=saturateVec3(rgb+ vec3f(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn vec4f(rgb,result.a);}"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.bumpFragmentMainFunctions="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform normalMatrix: mat4x4f;fn toNormalMatrix(m: mat4x4f)->mat4x4f\n{var a00=m[0][0];var a01=m[0][1];var a02=m[0][2];var a03=m[0][3];var a10=m[1][0];var a11=m[1][1];var a12=m[1][2];var a13=m[1][3];var a20=m[2][0]; \nvar a21=m[2][1];var a22=m[2][2];var a23=m[2][3];var a30=m[3][0]; \nvar a31=m[3][1];var a32=m[3][2];var a33=m[3][3];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;var mi=mat4x4<f32>(\n(a11*b11-a12*b10+a13*b09)/det,\n(a02*b10-a01*b11-a03*b09)/det,\n(a31*b05-a32*b04+a33*b03)/det,\n(a22*b04-a21*b05-a23*b03)/det,\n(a12*b08-a10*b11-a13*b07)/det,\n(a00*b11-a02*b08+a03*b07)/det,\n(a32*b02-a30*b05-a33*b01)/det,\n(a20*b05-a22*b02+a23*b01)/det,\n(a10*b10-a11*b08+a13*b06)/det,\n(a01*b08-a00*b10-a03*b06)/det,\n(a30*b04-a31*b02+a33*b00)/det,\n(a21*b02-a20*b04-a23*b00)/det,\n(a11*b07-a10*b09-a12*b06)/det,\n(a00*b09-a01*b07+a02*b06)/det,\n(a31*b01-a30*b03-a32*b00)/det,\n(a20*b03-a21*b01+a22*b00)/det);return mat4x4<f32>(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);}\n#endif\nfn perturbNormalBase(cotangentFrame: mat3x3f,normal: vec3f,scale: f32)->vec3f\n{var output=normal;\n#ifdef NORMALXYSCALE\noutput=normalize(output* vec3f(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*output);}\nfn perturbNormal(cotangentFrame: mat3x3f,textureSample: vec3f,scale: f32)->vec3f\n{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}\nfn cotangent_frame(normal: vec3f,p: vec3f,uv: vec2f,tangentSpaceParams: vec2f)->mat3x3f\n{var dp1: vec3f=dpdx(p);var dp2: vec3f=dpdy(p);var duv1: vec2f=dpdx(uv);var duv2: vec2f=dpdy(uv);var dp2perp: vec3f=cross(dp2,normal);var dp1perp: vec3f=cross(normal,dp1);var tangent: vec3f=dp2perp*duv1.x+dp1perp*duv2.x;var bitangent: vec3f=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;var det: f32=max(dot(tangent,tangent),dot(bitangent,bitangent));var invmax: f32=select(inverseSqrt(det),0.0,det==0.0);return mat3x3f(tangent*invmax,bitangent*invmax,normal);}\n#endif\n"},function(e,t,n){"use strict";var i=n(66);n(386);i.a.IncludesShadersStoreWGSL.bumpFragmentFunctions="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst minSamples: f32=4.;const maxSamples: f32=15.;const iMaxSamples: i32=15;fn parallaxOcclusion(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32)->vec2f {var parallaxLimit: f32=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;var vOffsetDir: vec2f=normalize(vViewDirCoT.xy);var vMaxOffset: vec2f=vOffsetDir*parallaxLimit;var numSamples: f32=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));var stepSize: f32=1.0/numSamples;var currRayHeight: f32=1.0;var vCurrOffset: vec2f= vec2f(0,0);var vLastOffset: vec2f= vec2f(0,0);var lastSampledHeight: f32=1.0;var currSampledHeight: f32=1.0;var keepWorking: bool=true;for (var i: i32=0; i<iMaxSamples; i++)\n{currSampledHeight=textureSample(bumpSampler,bumpSamplerSampler,texCoord+vCurrOffset).w;if (!keepWorking)\n{}\nelse if (currSampledHeight>currRayHeight)\n{var delta1: f32=currSampledHeight-currRayHeight;var delta2: f32=(currRayHeight+stepSize)-lastSampledHeight;var ratio: f32=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}\nelse\n{currRayHeight-=stepSize;vLastOffset=vCurrOffset;\n#ifdef PARALLAX_RHS\nvCurrOffset-=stepSize*vMaxOffset;\n#else\nvCurrOffset+=stepSize*vMaxOffset;\n#endif\nlastSampledHeight=currSampledHeight;}}\nreturn vCurrOffset;}\nfn parallaxOffset(viewDir: vec3f,heightScale: f32)->vec2f\n{var height: f32=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).w;var texCoordOffset: vec2f=heightScale*viewDir.xy*height;\n#ifdef PARALLAX_RHS\nreturn texCoordOffset;\n#else\nreturn -texCoordOffset;\n#endif\n}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.fogFragmentDeclaration="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\nconst E=2.71828;uniform vFogInfos: vec4f;uniform vFogColor: vec3f;varying vFogDistance: vec3f;fn CalcFogFactor()->f32\n{var fogCoeff: f32=1.0;var fogStart: f32=uniforms.vFogInfos.y;var fogEnd: f32=uniforms.vFogInfos.z;var fogDensity: f32=uniforms.vFogInfos.w;var fogDistance: f32=length(fragmentInputs.vFogDistance);if (FOGMODE_LINEAR==uniforms.vFogInfos.x)\n{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}\nelse if (FOGMODE_EXP==uniforms.vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}\nelse if (FOGMODE_EXP2==uniforms.vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}\nreturn clamp(fogCoeff,0.0,1.0);}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.bumpFragment="var uvOffset: vec2f= vec2f(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nvar normalScale: f32=1.0;\n#elif defined(BUMP)\nvar normalScale: f32=uniforms.vBumpInfos.y;\n#else\nvar normalScale: f32=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nvar TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); \n#elif defined(BUMP)\nvar TBNUV: vec2f=select(-fragmentInputs.vBumpUV,fragmentInputs.vBumpUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV,uniforms.vTangentSpaceParams);\n#else\nvar TBNUV: vec2f=select(-fragmentInputs.vDetailUV,fragmentInputs.vDetailUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV, vec2f(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvar TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); \n#else\nvar TBNUV: vec2f=select( -fragmentInputs.vMainUV1,fragmentInputs.vMainUV1,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW,input.vPositionW,TBNUV, vec2f(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nvar invTBN: mat3x3f=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,fragmentInputs.vBumpUV,uniforms.vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,uniforms.vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvar detailColor: vec4f=textureSample(detailSampler,detailSamplerSampler,fragmentInputs.vDetailUV+uvOffset);var detailNormalRG: vec2f=detailColor.wy*2.0-1.0;var detailNormalB: f32=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));var detailNormal: vec3f= vec3f(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3x3f(uniforms.normalMatrix[0].xyz,uniforms.normalMatrix[1].xyz,uniforms.normalMatrix[2].xyz)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz,uniforms.vBumpInfos.y);\n#else\nvar bumpNormal: vec3f=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);var blendedNormal: vec3f=normalize( vec3f(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);bumpNormal+= vec3f(0.0,0.0,1.0);detailNormal*= vec3f(-1.0,-1.0,1.0);var blendedNormal: vec3f=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,uniforms.vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);normalW=perturbNormalBase(TBN,detailNormal,uniforms.vDetailInfos.z);\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.decalFragment="#ifdef DECAL\nvar decalTempColor=decalColor.rgb;var decalTempAlpha=decalColor.a;\n#ifdef GAMMADECAL\ndecalTempColor=toLinearSpaceVec3(decalColor.rgb);\n#endif\n#ifdef DECAL_SMOOTHALPHA\ndecalTempAlpha=decalColor.a*decalColor.a;\n#endif\nsurfaceAlbedo=mix(surfaceAlbedo.rgb,decalTempColor,decalTempAlpha);\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.depthPrePass="#ifdef DEPTHPREPASS\nfragmentOutputs.color= vec4f(0.,0.,0.,1.0);return fragmentOutputs;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.lightFragment="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\nvar diffuse{X}: vec4f=light{X}.vLightDiffuse;\n#define CUSTOM_LIGHT{X}_COLOR \n#ifdef PBR\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)\npreInfo=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC1SamplerSampler,areaLightsLTC2Sampler,areaLightsLTC2SamplerSampler,viewDirectionW,normalW,fragmentInputs.vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,roughness);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#endif\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#endif\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif \n#endif \n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);\n#elif AREALIGHT{X}\ninfo.diffuse=computeAreaDiffuseLighting(preInfo,diffuse{X}.rgb);\n#elif defined(SS_TRANSLUCENCY)\ninfo.diffuse=computeDiffuseAndTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance,subSurfaceOut.translucencyIntensity,surfaceAlbedo.rgb);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);\n#endif\n#ifdef SPECULARTERM\n#if AREALIGHT{X}\ninfo.specular=computeAreaSpecularLighting(preInfo,light{X}.vLightSpecular.rgb);\n#else\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#endif\n#endif\n#ifndef AREALIGHT{X}\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\n#ifdef IESLIGHTTEXTURE{X}\ninfo=computeIESSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness,iesLightTexture{X},iesLightTexture{X}Sampler);\n#else\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#endif \n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#elif define(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)\ninfo=computeAreaLighting(areaLightsLTC1Sampler,areaLightsLTC1SamplerSampler,areaLightsLTC2Sampler,areaLightsLTC2SamplerSampler,viewDirectionW,normalW,fragmentInputs.vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,\n#ifdef AREALIGHTNOROUGHTNESS\n0.5\n#else\nuniforms.vReflectionInfos.y\n#endif\n);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},projectionLightTexture{X}Sampler,uniforms.textureProjectionMatrix{X},fragmentInputs.vPositionW);\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSMDEBUG{X}\nvar shadowDebug{X}: vec3f;\n#endif\n#ifdef SHADOWCSM{X}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nvar index{X}: i32=-1;\n#else\nvar index{X}: i32=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nvar diff{X}: f32=0.;vPositionFromLight{X}[0]=fragmentInputs.vPositionFromLight{X}_0;vPositionFromLight{X}[1]=fragmentInputs.vPositionFromLight{X}_1;vPositionFromLight{X}[2]=fragmentInputs.vPositionFromLight{X}_2;vPositionFromLight{X}[3]=fragmentInputs.vPositionFromLight{X}_3;vDepthMetric{X}[0]=fragmentInputs.vDepthMetric{X}_0;vDepthMetric{X}[1]=fragmentInputs.vDepthMetric{X}_1;vDepthMetric{X}[2]=fragmentInputs.vDepthMetric{X}_2;vDepthMetric{X}[3]=fragmentInputs.vDepthMetric{X}_3;for (var i:i32=0; i<SHADOWCSMNUM_CASCADES{X}; i++) \n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=uniforms.viewFrustumZ{X}[i]+fragmentInputs.vPositionFromCamera{X}.z;\n#else\ndiff{X}=uniforms.viewFrustumZ{X}[i]-fragmentInputs.vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {index{X}=i;break;}}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3f(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nvar frustumLength:f32=uniforms.frustumLengths{X}[index{X}];var diffRatio:f32=clamp(diff{X}/frustumLength,0.,1.)*uniforms.cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{index{X}+=1;var nextShadow: f32=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],,shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;shadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\naggShadow+=shadow;numLights+=1.0;\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else \ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.logDepthFragment="#ifdef LOGARITHMICDEPTH\nfragmentOutputs.fragDepth=log2(fragmentInputs.vFragmentDepth)*uniforms.logarithmicDepthConstant*0.5;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.fogFragment="#ifdef FOG\nvar fog: f32=CalcFogFactor();\n#ifdef PBR\nfog=toLinearSpace(fog);\n#endif\ncolor= vec4f(mix(uniforms.vFogColor,color.rgb,fog),color.a);\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.oitFragment="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\nvar fragDepth: f32=fragmentInputs.position.z; \n#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS\nvar halfFloat: u32=pack2x16float( vec2f(fragDepth));var full: vec2f=unpack2x16float(halfFloat);fragDepth=full.x;\n#endif\nvar fragCoord: vec2i=vec2i(fragmentInputs.position.xy);var lastDepth: vec2f=textureLoad(oitDepthSampler,fragCoord,0).rg;var lastFrontColor: vec4f=textureLoad(oitFrontColorSampler,fragCoord,0);fragmentOutputs.depth=vec2f(-MAX_DEPTH);fragmentOutputs.frontColor=lastFrontColor;fragmentOutputs.backColor= vec4f(0.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nvar furthestDepth: f32=-lastDepth.x;var nearestDepth: f32=lastDepth.y;\n#else\nvar nearestDepth: f32=-lastDepth.x;var furthestDepth: f32=lastDepth.y;\n#endif\nvar alphaMultiplier: f32=1.0-lastFrontColor.a;\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth>nearestDepth || fragDepth<furthestDepth) {\n#else\nif (fragDepth<nearestDepth || fragDepth>furthestDepth) {\n#endif\nreturn fragmentOutputs;}\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth<nearestDepth && fragDepth>furthestDepth) {\n#else\nif (fragDepth>nearestDepth && fragDepth<furthestDepth) {\n#endif\nfragmentOutputs.depth=vec2f(-fragDepth,fragDepth);return fragmentOutputs;}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.decalVertexDeclaration="#ifdef DECAL\nuniform vec4 vDecalInfos;uniform mat4 decalMatrix;\n#endif\n"},function(e,t,n){"use strict";var i=n(66);n(383),n(384);i.a.IncludesShadersStore.defaultUboDeclaration="layout(std140,column_major) uniform;uniform Material\n{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vReflectionInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 reflectionMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.uvAttributeDeclaration="#ifdef UV{X}\nattribute vec2 uv{X};\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.prePassVertexDeclaration="#ifdef PREPASS\n#ifdef PREPASS_LOCAL_POSITION\nvarying vec3 vPosition;\n#endif\n#ifdef PREPASS_DEPTH\nvarying vec3 vViewPos;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nuniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.samplerVertexDeclaration="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.bumpVertexDeclaration="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.fogVertexDeclaration="#ifdef FOG\nvarying vec3 vFogDistance;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.lightVxFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#if defined(AREALIGHT{X})\nuniform vec4 vLightWidth{X};uniform vec4 vLightHeight{X};\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.lightVxUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;vec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\n#if defined(AREALIGHT{X})\nvec4 vLightWidth;vec4 vLightHeight;\n#endif\nvec4 shadowsInfo;vec2 depthValues;} light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.prePassVertex="#ifdef PREPASS_DEPTH\nvViewPos=(view*worldPos).rgb;\n#endif\n#ifdef PREPASS_LOCAL_POSITION\nvPosition=positionUpdated.xyz;\n#endif\n#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*worldPos;\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.uvVariableDeclaration="#if !defined(UV{X}) && defined(MAINUV{X})\nvec2 uv{X}=vec2(0.,0.);\n#endif\n#ifdef MAINUV{X}\nvMainUV{X}=uv{X};\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.samplerVertexImplementation="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nif (v_INFONAME_==0.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));}\n#ifdef UV2\nelse if (v_INFONAME_==1.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2Updated,1.0,0.0));}\n#endif\n#ifdef UV3\nelse if (v_INFONAME_==2.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));}\n#endif\n#ifdef UV4\nelse if (v_INFONAME_==3.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));}\n#endif\n#ifdef UV5\nelse if (v_INFONAME_==4.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));}\n#endif\n#ifdef UV6\nelse if (v_INFONAME_==5.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));}\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.bumpVertex="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.fogVertex="#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.shadowsVertex="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n}\n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.vertexColorMixing="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvColor=vec4(1.0);\n#ifdef VERTEXCOLOR\n#ifdef VERTEXALPHA\nvColor*=colorUpdated;\n#else\nvColor.rgb*=colorUpdated.rgb;\n#endif\n#endif\n#ifdef INSTANCESCOLOR\nvColor*=instanceColor;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.logDepthVertex="#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.decalFragmentDeclaration="#ifdef DECAL\nuniform vec4 vDecalInfos;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.prePassDeclaration="#ifdef PREPASS\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;\n#ifdef PREPASS_LOCAL_POSITION\nvarying highp vec3 vPosition;\n#endif\n#ifdef PREPASS_DEPTH\nvarying highp vec3 vViewPos;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nvarying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.oitDeclaration="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out vec2 depth; \nlayout(location=1) out vec4 frontColor;layout(location=2) out vec4 backColor;\n#define MAX_DEPTH 99999.0\nhighp vec4 gl_FragColor;uniform sampler2D oitDepthSampler;uniform sampler2D oitFrontColorSampler;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.lightFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};\n#else\nuniform highp sampler2DArray shadowTexture{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);vec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowTexture{X};\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowTexture{X};\n#else\nuniform sampler2D shadowTexture{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#ifdef AREALIGHT{X}\nuniform vec4 vLightWidth{X};uniform vec4 vLightHeight{X};\n#endif\n#ifdef IESLIGHTTEXTURE{X}\nuniform sampler2D iesLightTexture{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.lightUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;vec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\n#if defined(AREALIGHT{X})\nvec4 vLightWidth;vec4 vLightHeight;\n#endif\nvec4 shadowsInfo;vec2 depthValues;} light{X};\n#ifdef IESLIGHTTEXTURE{X}\nuniform sampler2D iesLightTexture{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};\n#else\nuniform highp sampler2DArray shadowTexture{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);vec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowTexture{X}; \n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowTexture{X};\n#else\nuniform sampler2D shadowTexture{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.ltcHelperFunctions="vec2 LTCUv( const in vec3 N,const in vec3 V,const in float roughness ) {const float LUTSIZE=64.0;const float LUTSCALE=( LUTSIZE-1.0 )/LUTSIZE;const float LUTBIAS=0.5/LUTSIZE;float dotNV=saturate( dot( N,V ) );vec2 uv=vec2( roughness,sqrt( 1.0-dotNV ) );uv=uv*LUTSCALE+LUTBIAS;return uv;}\nfloat LTCClippedSphereFormFactor( const in vec3 f ) {float l=length( f );return max( ( l*l+f.z )/( l+1.0 ),0.0 );}\nvec3 LTCEdgeVectorFormFactor( const in vec3 v1,const in vec3 v2 ) {float x=dot( v1,v2 );float y=abs( x );float a=0.8543985+( 0.4965155+0.0145206*y )*y;float b=3.4175940+( 4.1616724+y )*y;float v=a/b;float thetaSintheta=0.0;if( x>0.0 )\n{thetaSintheta=v;}\nelse\n{thetaSintheta=0.5*inversesqrt( max( 1.0-x*x,1e-7 ) )-v;}\nreturn cross( v1,v2 )*thetaSintheta;}\nvec3 LTCEvaluate( const in vec3 N,const in vec3 V,const in vec3 P,const in mat3 mInv,const in vec3 rectCoords[ 4 ] ) {vec3 v1=rectCoords[ 1 ]-rectCoords[ 0 ];vec3 v2=rectCoords[ 3 ]-rectCoords[ 0 ];vec3 lightNormal=cross( v1,v2 );if( dot( lightNormal,P-rectCoords[ 0 ] )<0.0 ) return vec3( 0.0 );vec3 T1,T2;T1=normalize( V-N*dot( V,N ) );T2=- cross( N,T1 ); \nmat3 mat=mInv*transposeMat3( mat3( T1,T2,N ) );vec3 coords[ 4 ];coords[ 0 ]=mat*( rectCoords[ 0 ]-P );coords[ 1 ]=mat*( rectCoords[ 1 ]-P );coords[ 2 ]=mat*( rectCoords[ 2 ]-P );coords[ 3 ]=mat*( rectCoords[ 3 ]-P );coords[ 0 ]=normalize( coords[ 0 ] );coords[ 1 ]=normalize( coords[ 1 ] );coords[ 2 ]=normalize( coords[ 2 ] );coords[ 3 ]=normalize( coords[ 3 ] );vec3 vectorFormFactor=vec3( 0.0 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 0 ],coords[ 1 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 1 ],coords[ 2 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 2 ],coords[ 3 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 3 ],coords[ 0 ] );float result=LTCClippedSphereFormFactor( vectorFormFactor );return vec3( result );}\nstruct areaLightData\n{vec3 Diffuse;vec3 Specular;vec4 Fresnel;};\n#define inline\nareaLightData computeAreaLightSpecularDiffuseFresnel(const in sampler2D ltc1,const in sampler2D ltc2,const in vec3 viewDir,const in vec3 normal,const in vec3 position,const in vec3 lightPos,const in vec3 halfWidth,const in vec3 halfHeight,const in float roughness) \n{areaLightData result;vec3 rectCoords[ 4 ];rectCoords[ 0 ]=lightPos+halfWidth-halfHeight; \nrectCoords[ 1 ]=lightPos-halfWidth-halfHeight;rectCoords[ 2 ]=lightPos-halfWidth+halfHeight;rectCoords[ 3 ]=lightPos+halfWidth+halfHeight;\n#ifdef SPECULARTERM\nvec2 uv=LTCUv( normal,viewDir,roughness );vec4 t1=texture2D( ltc1,uv );vec4 t2=texture2D( ltc2,uv );mat3 mInv=mat3(\nvec3( t1.x,0,t1.y ),\nvec3( 0,1, 0 ),\nvec3( t1.z,0,t1.w )\n);result.Specular=LTCEvaluate( normal,viewDir,position,mInv,rectCoords );result.Fresnel=t2;\n#endif\nresult.Diffuse=LTCEvaluate( normal,viewDir,position,mat3( 1.0 ),rectCoords );return result;}"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.shadowsFragmentFunctions="#ifdef SHADOWS\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}\n#endif\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}\n#define inline\nfloat computeShadowCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nreturn depth>shadow ? darkness : 1.0;}\n#define inline\nfloat computeShadowWithPoissonSamplingCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);}\n#define inline\nfloat computeShadowWithESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}\n#define inline\nfloat computeShadowWithCloseESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define inline\nfloat computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uvLayer));\n#else\nfloat shadow=texture2D(shadowSampler,uvLayer).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}\n#endif\n#define inline\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}\n#define inline\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\n#else\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\n#ifdef IS_NDC_HALF_ZRANGE\n#define ZINCLIP clipSpace.z\n#else\n#define ZINCLIP uvDepth.z\n#endif\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define GREATEST_LESS_THAN_ONE 0.99999994\n#define DISABLE_UNIFORMITY_ANALYSIS\n#define inline\nfloat computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.)\n);const vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n#define inline\nfloat computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}\nshadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}\nelse\n{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}\nif (numBlocker<1.0) {return 1.0;}\nelse\n{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}\nshadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}\n#define inline\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}\n#define inline\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}\n#define inline\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}\n#define inline\nfloat computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#define inline\nfloat computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#define inline\nfloat computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.reflectionFunction="vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }\nvec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }\nvec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}\nvec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)\n{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}\nvec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}\nvec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nvec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)\n{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nvec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)\n{return vec3(reflectionMatrix*(view*worldPos));}\nvec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)\n{return vec3(reflectionMatrix*vec4(positionW,1.));}\n#ifdef REFLECTION\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(vPositionUVW,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.imageProcessingDeclaration="#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vec2 vInverseScreenSize;\n#endif\n#ifdef VIGNETTE\nuniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif\n#ifdef DITHER\nuniform float ditherIntensity;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.imageProcessingFunctions="#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n/** \n* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.\n* sampler3dSetting.x=textureOffset (0.5/textureSize).\n* sampler3dSetting.y=textureSize.\n*/\n#define inline\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{float sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;}\n#endif\n#if TONEMAPPING==3\nconst float PBRNeutralStartCompression=0.8-0.04;const float PBRNeutralDesaturation=0.15;vec3 PBRNeutralToneMapping( vec3 color ) {float x=min(color.r,min(color.g,color.b));float offset=x<0.08 ? x-6.25*x*x : 0.04;color-=offset;float peak=max(color.r,max(color.g,color.b));if (peak<PBRNeutralStartCompression) return color;float d=1.-PBRNeutralStartCompression;float newPeak=1.-d*d/(peak+d-PBRNeutralStartCompression);color*=newPeak/peak;float g=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(color,newPeak*vec3(1,1,1),g);}\n#endif\n#if TONEMAPPING==2\nconst mat3 ACESInputMat=mat3(\nvec3(0.59719,0.07600,0.02840),\nvec3(0.35458,0.90834,0.13383),\nvec3(0.04823,0.01566,0.83777)\n);const mat3 ACESOutputMat=mat3(\nvec3( 1.60475,-0.10208,-0.00327),\nvec3(-0.53108, 1.10813,-0.07276),\nvec3(-0.07367,-0.00605, 1.07602)\n);vec3 RRTAndODTFit(vec3 v)\n{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}\nvec3 ACESFitted(vec3 color)\n{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nvec4 applyImageProcessing(vec4 result) {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#if TONEMAPPING==3\nresult.rgb=PBRNeutralToneMapping(result.rgb);\n#elif TONEMAPPING==2\nresult.rgb=ACESFitted(result.rgb);\n#elif TONEMAPPING==1\nconst float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\nresult.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);\n#ifdef CONTRAST\nvec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}\n#endif\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nfloat luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nfloat rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn result;}"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.bumpFragmentMainFunctions="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#if defined(WEBGL2) || defined(WEBGPU)\nmat4 toNormalMatrix(mat4 wMatrix)\n{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}\n#else\nmat4 toNormalMatrix(mat4 m)\n{float\na00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],\na10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],\na20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],\na30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],\nb00=a00*a11-a01*a10,\nb01=a00*a12-a02*a10,\nb02=a00*a13-a03*a10,\nb03=a01*a12-a02*a11,\nb04=a01*a13-a03*a11,\nb05=a02*a13-a03*a12,\nb06=a20*a31-a21*a30,\nb07=a20*a32-a22*a30,\nb08=a20*a33-a23*a30,\nb09=a21*a32-a22*a31,\nb10=a21*a33-a23*a31,\nb11=a22*a33-a23*a32,\ndet=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(\na11*b11-a12*b10+a13*b09,\na02*b10-a01*b11-a03*b09,\na31*b05-a32*b04+a33*b03,\na22*b04-a21*b05-a23*b03,\na12*b08-a10*b11-a13*b07,\na00*b11-a02*b08+a03*b07,\na32*b02-a30*b05-a33*b01,\na20*b05-a22*b02+a23*b01,\na10*b10-a11*b08+a13*b06,\na01*b08-a00*b10-a03*b06,\na30*b04-a31*b02+a33*b00,\na21*b02-a20*b04-a23*b00,\na11*b07-a10*b09-a12*b06,\na00*b09-a01*b07+a02*b06,\na31*b01-a30*b03-a32*b00,\na20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);}\n#endif\n#endif\nvec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)\n{\n#ifdef NORMALXYSCALE\nnormal=normalize(normal*vec3(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*normal);}\nvec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)\n{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)\n{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}\n#endif\n"},function(e,t,n){"use strict";var i=n(66);n(387);i.a.IncludesShadersStore.bumpFragmentFunctions="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)\n{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)\n{}\nelse if (currSampledHeight>currRayHeight)\n{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}\nelse\n{currRayHeight-=stepSize;vLastOffset=vCurrOffset;\n#ifdef PARALLAX_RHS\nvCurrOffset-=stepSize*vMaxOffset;\n#else\nvCurrOffset+=stepSize*vMaxOffset;\n#endif\nlastSampledHeight=currSampledHeight;}}\nreturn vCurrOffset;}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;\n#ifdef PARALLAX_RHS\nreturn texCoordOffset;\n#else\nreturn -texCoordOffset;\n#endif\n}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.fogFragmentDeclaration="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()\n{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)\n{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}\nelse if (FOGMODE_EXP==vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}\nelse if (FOGMODE_EXP2==vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}\nreturn clamp(fogCoeff,0.0,1.0);}\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.bumpFragment="vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#elif defined(BUMP)\nfloat normalScale=vBumpInfos.y;\n#else\nfloat normalScale=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#elif defined(BUMP)\nvec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);\n#else\nvec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nvec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);\n#else\nvec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.decalFragment="#ifdef DECAL\n#ifdef GAMMADECAL\ndecalColor.rgb=toLinearSpace(decalColor.rgb);\n#endif\n#ifdef DECAL_SMOOTHALPHA\ndecalColor.a*=decalColor.a;\n#endif\nsurfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.depthPrePass="#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);return;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.lightFragment="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\nvec4 diffuse{X}=light{X}.vLightDiffuse;\n#define CUSTOM_LIGHT{X}_COLOR \n#ifdef PBR\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)\npreInfo=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,roughness);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#endif\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#endif\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#ifdef IESLIGHTTEXTURE{X}\npreInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});\n#else\npreInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif \n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);\n#elif defined(AREALIGHT{X})\ninfo.diffuse=computeAreaDiffuseLighting(preInfo,diffuse{X}.rgb);\n#elif defined(SS_TRANSLUCENCY)\ninfo.diffuse=computeDiffuseAndTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance,subSurfaceOut.translucencyIntensity,surfaceAlbedo.rgb);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);\n#endif\n#ifdef SPECULARTERM\n#if AREALIGHT{X}\ninfo.specular=computeAreaSpecularLighting(preInfo,light{X}.vLightSpecular.rgb);\n#else\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#endif\n#endif\n#ifndef AREALIGHT{X}\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\n#ifdef IESLIGHTTEXTURE{X}\ninfo=computeIESSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness,iesLightTexture{X});\n#else\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#endif\n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)\ninfo=computeAreaLighting(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.rgb,light{X}.vLightHeight.rgb,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,\n#ifdef AREALIGHTNOROUGHTNESS\n0.5\n#else\nvReflectionInfos.y\n#endif\n);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) \n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;\n#else\ndiff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {index{X}=i;break;}}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nfloat frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{index{X}+=1;float nextShadow=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;shadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\naggShadow+=shadow;numLights+=1.0;\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else \ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.logDepthFragment="#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.fogFragment="#ifdef FOG\nfloat fog=CalcFogFactor();\n#ifdef PBR\nfog=toLinearSpace(fog);\n#endif\ncolor.rgb=mix(vFogColor,color.rgb,fog);\n#endif\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.oitFragment="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\nfloat fragDepth=gl_FragCoord.z; \n#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS\nuint halfFloat=packHalf2x16(vec2(fragDepth));vec2 full=unpackHalf2x16(halfFloat);fragDepth=full.x;\n#endif\nivec2 fragCoord=ivec2(gl_FragCoord.xy);vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);depth.rg=vec2(-MAX_DEPTH);frontColor=lastFrontColor;backColor=vec4(0.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nfloat furthestDepth=-lastDepth.x;float nearestDepth=lastDepth.y;\n#else\nfloat nearestDepth=-lastDepth.x;float furthestDepth=lastDepth.y;\n#endif\nfloat alphaMultiplier=1.0-lastFrontColor.a;\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth>nearestDepth || fragDepth<furthestDepth) {\n#else\nif (fragDepth<nearestDepth || fragDepth>furthestDepth) {\n#endif\nreturn;}\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth<nearestDepth && fragDepth>furthestDepth) {\n#else\nif (fragDepth>nearestDepth && fragDepth<furthestDepth) {\n#endif\ndepth.rg=vec2(-fragDepth,fragDepth);return;}\n#endif\n"},function(e,t,n){"use strict";var i=n(66);n(381),n(382);i.a.IncludesShadersStoreWGSL.pbrUboDeclaration="uniform vAlbedoInfos: vec2f;uniform vBaseWeightInfos: vec2f;uniform vAmbientInfos: vec4f;uniform vOpacityInfos: vec2f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vReflectivityInfos: vec3f;uniform vMicroSurfaceSamplerInfos: vec2f;uniform vReflectionInfos: vec2f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vBumpInfos: vec3f;uniform albedoMatrix: mat4x4f;uniform baseWeightMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform reflectivityMatrix: mat4x4f;uniform microSurfaceSamplerMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionColor: vec3f;uniform vAlbedoColor: vec4f;uniform baseWeight: f32;uniform vLightingIntensity: vec4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform pointSize: f32;uniform vReflectivityColor: vec4f;uniform vEmissiveColor: vec3f;uniform vAmbientColor: vec3f;uniform vDebugMode: vec2f;uniform vMetallicReflectanceFactors: vec4f;uniform vMetallicReflectanceInfos: vec2f;uniform metallicReflectanceMatrix: mat4x4f;uniform vReflectanceInfos: vec2f;uniform reflectanceMatrix: mat4x4f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;\n#define ADDITIONAL_UBO_DECLARATION\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStoreWGSL.harmonicsFunctions="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nfn computeEnvironmentIrradiance(normal: vec3f)->vec3f {return uniforms.vSphericalL00\n+ uniforms.vSphericalL1_1*(normal.y)\n+ uniforms.vSphericalL10*(normal.z)\n+ uniforms.vSphericalL11*(normal.x)\n+ uniforms.vSphericalL2_2*(normal.y*normal.x)\n+ uniforms.vSphericalL2_1*(normal.y*normal.z)\n+ uniforms.vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+ uniforms.vSphericalL21*(normal.z*normal.x)\n+ uniforms.vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}\n#else\nfn computeEnvironmentIrradiance(normal: vec3f)->vec3f {var Nx: f32=normal.x;var Ny: f32=normal.y;var Nz: f32=normal.z;var C1: vec3f=uniforms.vSphericalZZ.rgb;var Cx: vec3f=uniforms.vSphericalX.rgb;var Cy: vec3f=uniforms.vSphericalY.rgb;var Cz: vec3f=uniforms.vSphericalZ.rgb;var Cxx_zz: vec3f=uniforms.vSphericalXX_ZZ.rgb;var Cyy_zz: vec3f=uniforms.vSphericalYY_ZZ.rgb;var Cxy: vec3f=uniforms.vSphericalXY.rgb;var Cyz: vec3f=uniforms.vSphericalYZ.rgb;var Czx: vec3f=uniforms.vSphericalZX.rgb;var a1: vec3f=Cyy_zz*Ny+Cy;var a2: vec3f=Cyz*Nz+a1;var b1: vec3f=Czx*Nz+Cx;var b2: vec3f=Cxy*Ny+b1;var b3: vec3f=Cxx_zz*Nx+b2;var t1: vec3f=Cz *Nz+C1;var t2: vec3f=a2 *Ny+t1;var t3: vec3f=b3 *Nx+t2;return t3;}\n#endif\n#endif\n"},function(e,t,n){"use strict";var i=n(66);n(383),n(384);i.a.IncludesShadersStore.pbrUboDeclaration="layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec2 vBaseWeightInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec2 vReflectionInfos;vec2 vReflectionFilteringInfo;vec3 vReflectionPosition;vec3 vReflectionSize;vec3 vBumpInfos;mat4 albedoMatrix;mat4 baseWeightMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;mat4 reflectionMatrix;vec3 vReflectionColor;vec4 vAlbedoColor;float baseWeight;vec4 vLightingIntensity;vec3 vReflectionMicrosurfaceInfos;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n"},function(e,t,n){"use strict";n(66).a.IncludesShadersStore.harmonicsFunctions="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nvec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00\n+ vSphericalL1_1*(normal.y)\n+ vSphericalL10*(normal.z)\n+ vSphericalL11*(normal.x)\n+ vSphericalL2_2*(normal.y*normal.x)\n+ vSphericalL2_1*(normal.y*normal.z)\n+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+ vSphericalL21*(normal.z*normal.x)\n+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}\n#else\nvec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}\n#endif\n#endif\n"},function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"c",(function(){return v})),n.d(t,"b",(function(){return E})),n(314),n(327);var i=n(309),r=n(320),s=n(100),a=n(108),o=n(313),l=n(336),c=n(372);class d extends l.b{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([n.e(0).then(n.bind(null,503))]))):t.push(Promise.all([n.e(0).then(n.bind(null,492))])),super._gatherImports(e,t)}constructor(e,t=null,n){super({...n,name:e,engine:t||c.a.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:d.FragmentUrl})}}d.FragmentUrl="pass";class h extends l.b{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([n.e(0).then(n.bind(null,504))]))):t.push(Promise.all([n.e(0).then(n.bind(null,505))])),super._gatherImports(e,t)}get face(){return this._face}set face(e){if(!(e<0||e>5))switch(this._face=e,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}}constructor(e,t=null,n){super({...n,name:e,engine:t||c.a.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:h.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0}}h.FragmentUrl="passCube";var u=n(310);class f extends r.a{getClassName(){return"PassPostProcess"}static _Parse(e,t,n,i){return o.a.Parse(()=>new f(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,n,i)}constructor(e,t,n=null,i,r,s,a=0,o=!1){const l={size:"number"==typeof t?t:void 0,camera:n,samplingMode:i,engine:r,reusable:s,textureType:a,blockCompilation:o,...t};super(e,d.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new d(e,r,l),...l})}}Object(a.b)("BABYLON.PassPostProcess",f);class m extends r.a{get face(){return this._effectWrapper.face}set face(e){this._effectWrapper.face=e}getClassName(){return"PassCubePostProcess"}static _Parse(e,t,n,i){return o.a.Parse(()=>new m(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,n,i)}constructor(e,t,n=null,i,r,s,a=0,o=!1){const l={size:"number"==typeof t?t:void 0,camera:n,samplingMode:i,engine:r,reusable:s,textureType:a,blockCompilation:o,...t};super(e,d.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new h(e,r,l),...l})}}function p(e,t,n,i,s,a,o,l){var c,d,h,u,f;const m=t.getEngine();return t.isReady=!1,s=null!==(c=s)&&void 0!==c?c:t.samplingMode,i=null!==(d=i)&&void 0!==d?d:t.type,a=null!==(h=a)&&void 0!==h?h:t.format,o=null!==(u=o)&&void 0!==u?u:t.width,l=null!==(f=l)&&void 0!==f?f:t.height,-1===i&&(i=0),new Promise(c=>{const d=new r.a("postprocess",e,null,null,1,null,s,m,!1,void 0,i,void 0,null,!1,a);d.externalTextureSamplerBinding=!0;const h=m.createRenderTargetTexture({width:o,height:l},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:s,type:i,format:a});d.onEffectCreatedObservable.addOnce(e=>{e.executeWhenCompiled(()=>{d.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},n.postProcessManager.directRender([d],h,!0),m.restoreDefaultFramebuffer(),m._releaseTexture(t),d&&d.dispose(),h._swapAndDie(t),t.type=i,t.format=5,t.isReady=!0,c(t)})})})}let g,_;function v(e){g||(g=new Float32Array(1),_=new Int32Array(g.buffer)),g[0]=e;const t=_[0];let n=t>>16&32768,i=t>>12&2047;const r=t>>23&255;return r<103?n:r>142?(n|=31744,n|=(255==r?0:1)&&8388607&t,n):r<113?(i|=2048,n|=(i>>114-r)+(i>>113-r&1),n):(n|=r-112<<10|i>>1,n+=1&i,n)}function E(e){const t=(32768&e)>>15,n=(31744&e)>>10,i=1023&e;return 0===n?(t?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):31==n?i?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,n-15)*(1+i/Math.pow(2,10))}Object(i.a)([Object(u.c)()],m.prototype,"face",null),s.a._RescalePostProcessFactory=e=>new f("rescale",1,null,2,e,!1,0)},function(e,t,n){"use strict";var i=n(341),r=n(43),s=n(84),a=n(321);class o{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}_preparePath(e,t=0){const n=this._animation.targetPropertyPath;if(n.length>1){let i=e;for(let e=0;e<n.length-1;e++){const t=n[e];if(i=i[t],void 0===i)throw new Error(`Invalid property (${t}) in property path (${n.join(".")})`)}this._targetPath=n[n.length-1],this._activeTargets[t]=i}else this._targetPath=n[0],this._activeTargets[t]=e;if(void 0===this._activeTargets[t][this._targetPath])throw new Error(`Invalid property (${this._targetPath}) in property path (${n.join(".")})`)}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let e=0;for(const t of this._target)void 0!==this._originalValue[e]&&this._setValue(t,this._activeTargets[e],this._originalValue[e],-1,e),e++}else void 0!==this._originalValue[0]&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let e=0;e<this._events.length;e++)this._events[e].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray)for(let n=0;n<this._target.length;n++){const i=this._target[n];this._setValue(i,this._activeTargets[n],e,t,n)}else this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const n=this._activeTargets[e];t=n.getLocalMatrix&&"_matrix"===this._targetPath?n.getLocalMatrix():n[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_registerTargetForLateAnimationBinding(e,t){const n=e.target;this._scene._registeredForLateAnimationBindings.pushNoDuplicate(n),n._lateAnimationHolders||(n._lateAnimationHolders={}),n._lateAnimationHolders[e.targetPath]||(n._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:t}),e.isAdditive?(n._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),n._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(n._lateAnimationHolders[e.targetPath].animations.push(e),n._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)}_setValue(e,t,n,i,r){if(this._currentActiveTarget=t,this._weight=i,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const e=t[this._targetPath];e.clone?this._originalBlendValue=e.clone():this._originalBlendValue=e}this._originalBlendValue.m?a.a.AllowMatrixDecomposeForInterpolation?this._currentValue?s.a.DecomposeLerpToRef(this._originalBlendValue,n,this._blendingFactor,this._currentValue):this._currentValue=s.a.DecomposeLerp(this._originalBlendValue,n,this._blendingFactor):this._currentValue?s.a.LerpToRef(this._originalBlendValue,n,this._blendingFactor,this._currentValue):this._currentValue=s.a.Lerp(this._originalBlendValue,n,this._blendingFactor):this._currentValue=a.a._UniversalLerp(this._originalBlendValue,n,this._blendingFactor);const i=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=i}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(n):this._currentValue=n:null!=n&&n.clone?this._currentValue=n.clone():this._currentValue=n;-1!==i?this._registerTargetForLateAnimationBinding(this,this._originalValue[r]):this._animationState.loopMode===a.a.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[r],t[this._targetPath]):t[this._targetPath]=this._originalValue[r]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e,t=-1){const n=this._animation.getKeys();e<n[0].frame?e=n[0].frame:e>n[n.length-1].frame&&(e=n[n.length-1].frame);const i=this._events;if(i.length)for(let t=0;t<i.length;t++)i[t].onlyOnce||(i[t].isDone=i[t].frame<e);this._currentFrame=e;const r=this._animation._interpolate(e,this._animationState);this.setValue(r,t)}_prepareForSpeedRatioChange(e){const t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,n,i,r,s=-1){const o=this._animation,l=o.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let c=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(n<this._minFrame||n>this._maxFrame)&&(n=this._maxFrame);const d=n-t;let h,u=e*(o.framePerSecond*r)/1e3+this._absoluteFrameOffset,f=0,m=!1;const p=i&&this._animationState.loopMode===a.a.ANIMATIONLOOPMODE_YOYO;if(p){const e=(u-t)/d,n=Math.sin(e*Math.PI);u=Math.abs(n)*d+t;const i=n>=0?1:-1;this._yoyoDirection!==i&&(m=!0),this._yoyoDirection=i}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=u,!i&&n>=t&&(u>=d&&r>0||u<=0&&r<0))c=!1,f=o._getKeyValue(this._maxValue);else if(!i&&t>=n&&(u<=d&&r<0||u>=0&&r>0))c=!1,f=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==a.a.ANIMATIONLOOPMODE_CYCLE){const e=n.toString()+t.toString();if(!this._offsetsCache[e]){this._animationState.repeatCount=0,this._animationState.loopMode=a.a.ANIMATIONLOOPMODE_CYCLE;const i=o._interpolate(t,this._animationState),r=o._interpolate(n,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case a.a.ANIMATIONTYPE_FLOAT:this._offsetsCache[e]=r-i;break;case a.a.ANIMATIONTYPE_QUATERNION:case a.a.ANIMATIONTYPE_VECTOR3:case a.a.ANIMATIONTYPE_VECTOR2:case a.a.ANIMATIONTYPE_SIZE:case a.a.ANIMATIONTYPE_COLOR3:this._offsetsCache[e]=r.subtract(i)}this._highLimitsCache[e]=r}f=this._highLimitsCache[e],h=this._offsetsCache[e]}if(void 0===h)switch(o.dataType){case a.a.ANIMATIONTYPE_FLOAT:h=0;break;case a.a.ANIMATIONTYPE_QUATERNION:h=a.d;break;case a.a.ANIMATIONTYPE_VECTOR3:h=a.g;break;case a.a.ANIMATIONTYPE_VECTOR2:h=a.f;break;case a.a.ANIMATIONTYPE_SIZE:h=a.e;break;case a.a.ANIMATIONTYPE_COLOR3:h=a.b;break;case a.a.ANIMATIONTYPE_COLOR4:h=a.c}let g;if(this._host&&this._host.syncRoot){const e=this._host.syncRoot;g=t+d*((e.masterFrame-e.fromFrame)/(e.toFrame-e.fromFrame))}else g=u>0&&t>n||u<0&&t<n?c&&0!==d?n+u%d:t:c&&0!==d?t+u%d:n;const _=this._events;if(!p&&(r>0&&this.currentFrame>g||r<0&&this.currentFrame<g)||p&&m){this._onLoop();for(let e=0;e<_.length;e++)_[e].onlyOnce||(_[e].isDone=!1);this._animationState.key=r>0?0:o.getKeys().length-1}this._currentFrame=g,this._animationState.repeatCount=0===d?0:u/d>>0,this._animationState.highLimitValue=f,this._animationState.offsetValue=h;const v=o._interpolate(g,this._animationState);if(this.setValue(v,s),_.length)for(let e=0;e<_.length;e++)if(d>=0&&g>=_[e].frame&&_[e].frame>=t||d<0&&g<=_[e].frame&&_[e].frame<=t){const t=_[e];t.isDone||(t.onlyOnce&&(_.splice(e,1),e--),t.isDone=!0,t.action(g))}return c||(this._stopped=!0),c}constructor(e,t,n,i){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=n,this._host=i,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===a.a.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=s.a.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,0!==this._minFrame){const e={frame:0,value:this._minValue};this._keys.splice(0,0,e)}if(this._target instanceof Array){let e=0;for(const t of this._target)this._preparePath(t,e),this._getOriginalValues(e),e++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const r=t.getEvents();r&&r.length>0&&r.forEach(e=>{this._events.push(e._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}}var l,c,d=n(173);class h{get syncRoot(){return this._syncRoot}get masterFrame(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){this._weight=-1!==e?Math.min(Math.max(e,0),1):-1}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,null!==this._goToFrame&&this.goToFrame(this._goToFrame)}get elapsedTime(){return null===this._localDelayOffset?0:this._scene._animationTime-this._localDelayOffset}syncWith(e){if(this._syncRoot=e,e){const e=this._scene._activeAnimatables.indexOf(this);e>-1&&(this._scene._activeAnimatables.splice(e,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let n=0;n<t.length;n++){const i=t[n],r=new o(e,i,this._scene,this);r._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(r)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let n=0;n<t.length;n++)if(t[n].animation.targetProperty===e)return t[n].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let n=0;n<t.length;n++)if(t[n].animation.targetProperty===e)return t[n];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let n=0;n<t.length;n++)t[n].animation.enableBlending=!0,t[n].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e,t=!1){const n=this._runtimeAnimations;if(n[0]){var i;const t=n[0].animation.framePerSecond;this._frameToSyncFromJump=null!==(i=this._frameToSyncFromJump)&&void 0!==i?i:n[0].currentFrame;const r=0===this.speedRatio?0:(e-this._frameToSyncFromJump)/t*1e3/this.speedRatio;this._manualJumpDelay=-r}for(let i=0;i<n.length;i++)n[i].goToFrame(e,t?this._weight:-1);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,n=!1,i=!1){if(e||t){const r=this._scene._activeAnimatables.indexOf(this);if(r>-1){const s=this._runtimeAnimations;for(let n=s.length-1;n>=0;n--){const i=s[n];e&&i.animation.name!=e||t&&!t(i.target)||(i.dispose(),s.splice(n,1))}0==s.length&&(n||this._scene._activeAnimatables.splice(r,1),i||this._raiseOnAnimationEnd())}}else{const e=this._scene._activeAnimatables.indexOf(this);if(e>-1){n||this._scene._activeAnimatables.splice(e,1);const t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].dispose();this._runtimeAnimations.length=0,i||this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=e),!0;if(null===this._localDelayOffset?(this._localDelayOffset=e,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),null!==this._manualJumpDelay&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,0===this._weight&&0===this._previousWeight)return!0;this._previousWeight=this._weight;let t=!1;const n=this._runtimeAnimations;let i;for(i=0;i<n.length;i++){const r=n[i].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||r}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(i=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(i,1),i=0;i<n.length;i++)n[i].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}constructor(e,t,n=0,i=100,s=!1,a=1,o,l,c,d=!1,h=0){this.target=t,this.fromFrame=n,this.toFrame=i,this.loopAnimation=s,this.onAnimationEnd=o,this.onAnimationLoop=c,this.isAdditive=d,this.playOrder=h,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._previousWeight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new r.a,this.onAnimationLoopObservable=new r.a,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=a,e._activeAnimatables.push(this)}}function u(e){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return e.originalValue;let t=1;const n=s.c.Vector3[0],i=s.c.Vector3[1],r=s.c.Quaternion[0];let a=0;const o=e.animations[0],l=e.originalValue;let c=1,d=!1;if(e.totalWeight<1)c=1-e.totalWeight,l.decompose(i,r,n);else{if(a=1,t=e.totalWeight,c=o.weight/t,1==c){if(!e.totalAdditiveWeight)return o.currentValue;d=!0}o.currentValue.decompose(i,r,n)}if(!d){i.scaleInPlace(c),n.scaleInPlace(c),r.scaleInPlace(c);for(let o=a;o<e.animations.length;o++){const a=e.animations[o];if(0===a.weight)continue;c=a.weight/t;const l=s.c.Vector3[2],d=s.c.Vector3[3],h=s.c.Quaternion[1];a.currentValue.decompose(d,h,l),d.scaleAndAddToRef(c,i),h.scaleAndAddToRef(s.b.Dot(r,h)>0?c:-c,r),l.scaleAndAddToRef(c,n)}r.normalize()}for(let t=0;t<e.additiveAnimations.length;t++){const a=e.additiveAnimations[t];if(0===a.weight)continue;const o=s.c.Vector3[2],l=s.c.Vector3[3],c=s.c.Quaternion[1];a.currentValue.decompose(l,c,o),l.multiplyToRef(i,l),s.e.LerpToRef(i,l,a.weight,i),r.multiplyToRef(c,c),s.b.SlerpToRef(r,c,a.weight,r),o.scaleAndAddToRef(a.weight,n)}const h=o?o._animationState.workValue:s.c.Matrix[0].clone();return s.a.ComposeToRef(i,r,n,h),h}function f(e,t){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return t;const n=e.animations[0],i=e.originalValue;let r=t;if(0===e.totalWeight&&e.totalAdditiveWeight>0)r.copyFrom(i);else if(1===e.animations.length){if(s.b.SlerpToRef(i,n.currentValue,Math.min(1,e.totalWeight),r),0===e.totalAdditiveWeight)return r}else if(e.animations.length>1){let n,a,o=1;if(e.totalWeight<1){const t=1-e.totalWeight;n=[],a=[],n.push(i),a.push(t)}else{if(2===e.animations.length&&(s.b.SlerpToRef(e.animations[0].currentValue,e.animations[1].currentValue,e.animations[1].weight/e.totalWeight,t),0===e.totalAdditiveWeight))return t;n=[],a=[],o=e.totalWeight}for(let t=0;t<e.animations.length;t++){const i=e.animations[t];n.push(i.currentValue),a.push(i.weight/o)}let l=0;for(let e=0;e<n.length;)e?(l+=a[e],s.b.SlerpToRef(r,n[e],a[e]/l,r),e++):(s.b.SlerpToRef(n[e],n[e+1],a[e+1]/(a[e]+a[e+1]),t),r=t,l=a[e]+a[e+1],e+=2)}for(let t=0;t<e.additiveAnimations.length;t++){const n=e.additiveAnimations[t];0!==n.weight&&(r.multiplyToRef(n.currentValue,s.c.Quaternion[0]),s.b.SlerpToRef(r,s.c.Quaternion[0],n.weight,r))}return r}l=n(318).a,(c=i.a)&&(c.prototype.copyAnimationRange=function(e,t,n,i=!1,r=null){0===this.animations.length&&(this.animations.push(new a.a(this.name,"_matrix",e.animations[0].framePerSecond,a.a.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const s=e.animations[0].getRange(t);if(!s)return!1;const o=s.from,l=s.to,c=e.animations[0].getKeys(),d=e.length,h=e.getParent(),u=this.getParent(),f=i&&h&&d&&this.length&&d!==this.length,m=f&&u&&h?u.length/h.length:1,p=i&&!u&&r&&(1!==r.x||1!==r.y||1!==r.z),g=this.animations[0].getKeys();let _,v,E;for(let e=0,t=c.length;e<t;e++)_=c[e],_.frame>=o&&_.frame<=l&&(i?(E=_.value.clone(),f?(v=E.getTranslation(),E.setTranslation(v.scaleInPlace(m))):p&&r?(v=E.getTranslation(),E.setTranslation(v.multiplyInPlace(r))):E=_.value):E=_.value,g.push({frame:_.frame+n,value:E}));return this.animations[0].createRange(t,o+n,l+n),!0}),l&&(l.prototype._animate=function(e){if(!this.animationsEnabled)return;const t=d.a.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=t}this.deltaTime=void 0!==e?e:this.useConstantAnimationDeltaTime?16:(t-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=t;const n=this._activeAnimatables;if(0===n.length)return;this._animationTime+=this.deltaTime;const i=this._animationTime;for(let e=0;e<n.length;e++){const t=n[e];!t._animate(i)&&t.disposeOnEnd&&e--}!function(e){if(e._registeredForLateAnimationBindings.length){for(let t=0;t<e._registeredForLateAnimationBindings.length;t++){const n=e._registeredForLateAnimationBindings.data[t];for(const e in n._lateAnimationHolders){const t=n._lateAnimationHolders[e],i=t.animations[0],r=t.originalValue;if(null==r)continue;const o=a.a.AllowMatrixDecomposeForInterpolation&&r.m;let l=n[e];if(o)l=u(t);else if(void 0!==r.w)l=f(t,l||s.b.Identity());else{let e=0,n=1;const s=i&&i._animationState.loopMode===a.a.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(t.totalWeight<1)l=s?r.clone?r.clone():r:i&&r.scale?r.scale(1-t.totalWeight):i?r*(1-t.totalWeight):r.clone?r.clone():r;else if(i){n=t.totalWeight;const a=i.weight/n;l=1!==a?i.currentValue.scale?i.currentValue.scale(a):i.currentValue*a:i.currentValue,s&&(l.addToRef?l.addToRef(r,l):l+=r),e=1}for(let i=e;i<t.animations.length;i++){const e=t.animations[i],r=e.weight/n;r&&(e.currentValue.scaleAndAddToRef?e.currentValue.scaleAndAddToRef(r,l):l+=e.currentValue*r)}for(let e=0;e<t.additiveAnimations.length;e++){const n=t.additiveAnimations[e],i=n.weight;i&&(n.currentValue.scaleAndAddToRef?n.currentValue.scaleAndAddToRef(i,l):l+=n.currentValue*i)}}n[e]=l}n._lateAnimationHolders={}}e._registeredForLateAnimationBindings.reset()}}(this)},l.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((e,t)=>e.playOrder-t.playOrder)},l.prototype.beginWeightedAnimation=function(e,t,n,i=1,r,s=1,a,o,l,c,d=!1){const h=this.beginAnimation(e,t,n,r,s,a,o,!1,l,c,d);return h.weight=i,h},l.prototype.beginAnimation=function(e,t,n,i,r=1,s,a,o=!0,l,c,d=!1){if(r<0){const e=t;t=n,n=e,r=-r}t>n&&(r=-r),o&&this.stopAnimation(e,void 0,l),a||(a=new h(this,e,t,n,i,r,s,void 0,c,d));const u=!l||l(e);if(e.animations&&u&&a.appendAnimations(e,e.animations),e.getAnimatables){const d=e.getAnimatables();for(let e=0;e<d.length;e++)this.beginAnimation(d[e],t,n,i,r,s,a,o,l,c)}return a.reset(),a},l.prototype.beginHierarchyAnimation=function(e,t,n,i,r,s=1,a,o,l=!0,c,d,h=!1){const u=e.getDescendants(t),f=[];f.push(this.beginAnimation(e,n,i,r,s,a,o,l,c,void 0,h));for(const e of u)f.push(this.beginAnimation(e,n,i,r,s,a,o,l,c,void 0,h));return f},l.prototype.beginDirectAnimation=function(e,t,n,i,r,s=1,a,o,l=!1){if(s<0){const e=n;n=i,i=e,s=-s}return n>i&&(s=-s),new h(this,e,n,i,r,s,a,t,o,l)},l.prototype.beginDirectHierarchyAnimation=function(e,t,n,i,r,s,a,o,l,c=!1){const d=e.getDescendants(t),h=[];h.push(this.beginDirectAnimation(e,n,i,r,s,a,o,l,c));for(const e of d)h.push(this.beginDirectAnimation(e,n,i,r,s,a,o,l,c));return h},l.prototype.getAnimatableByTarget=function(e){for(let t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return this._activeAnimatables[t];return null},l.prototype.getAllAnimatablesByTarget=function(e){const t=[];for(let n=0;n<this._activeAnimatables.length;n++)this._activeAnimatables[n].target===e&&t.push(this._activeAnimatables[n]);return t},l.prototype.stopAnimation=function(e,t,n){const i=this.getAllAnimatablesByTarget(e);for(const e of i)e.stop(t,n)},l.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const e of this.animationGroups)e.stop()})},function(e,t,n){"use strict";var i=n(52),r=n(36),s=n(324),a=n(317),o=n(100),l=n(176);o.a.prototype._partialLoadFile=function(e,t,n,i,r=null){this._loadFile(e,e=>{n[t]=e,n._internalCount++,6===n._internalCount&&i(n)},void 0,void 0,!0,(e,t)=>{r&&e&&r(e.status+" "+e.statusText,t)})},o.a.prototype._cascadeLoadFiles=function(e,t,n,i=null){const r=[];r._internalCount=0;for(let e=0;e<6;e++)this._partialLoadFile(n[e],e,r,t,i)},o.a.prototype._cascadeLoadImgs=function(e,t,n,i,r=null,s){const a=[];a._internalCount=0;for(let o=0;o<6;o++)this._partialLoadImg(i[o],o,a,e,t,n,r,s)},o.a.prototype._partialLoadImg=function(e,t,n,i,r,o,l=null,c){const d=Object(a.a)();Object(s.f)(e,e=>{n[t]=e,n._internalCount++,i&&i.removePendingData(d),6===n._internalCount&&o&&o(r,n)},(e,t)=>{i&&i.removePendingData(d),l&&l(e,t)},i?i.offlineProvider:null,c),i&&i.addPendingData(d)},o.a.prototype.createCubeTextureBase=function(e,t,n,s,a=null,o=null,c,d=null,h=!1,u=0,f=0,m=null,p=null,g=null,_=!1,v=null){const E=m||new i.a(this,7);E.isCube=!0,E.url=e,E.generateMipMaps=!s,E._lodGenerationScale=u,E._lodGenerationOffset=f,E._useSRGBBuffer=!!_&&this._caps.supportSRGBBuffers&&(this.version>1||this.isWebGPU||!!s),E!==m&&(E.label=e.substring(0,60)),this._doNotHandleContextLost||(E._extension=d,E._files=n,E._buffer=v);const T=e;this._transformTextureUrl&&!m&&(e=this._transformTextureUrl(e));const S=null!=d?d:function(e){const t=e.split("?")[0],n=t.lastIndexOf(".");return n>-1?t.substring(n).toLowerCase():""}(e),A=Object(l.a)(S),b=(i,l)=>{e===T?o&&i&&o(i.status+" "+i.statusText,l):(r.a.Warn(`Failed to load ${e}, falling back to the ${T}`),this.createCubeTextureBase(T,t,n,!!s,a,o,c,d,h,u,f,E,p,g,_,v))};if(A)A.then(i=>{const s=e=>{p&&p(E,e),i.loadCubeData(e,E,h,a,o)};v?s(v):n&&6===n.length?i.supportCascades?this._cascadeLoadFiles(t,e=>s(e.map(e=>new Uint8Array(e))),n,o):o?o("Textures type does not support cascades."):r.a.Warn("Texture loader does not support cascades."):this._loadFile(e,e=>s(new Uint8Array(e)),void 0,void 0,!0,b)});else{if(!n||0===n.length)throw new Error("Cannot load cubemap because files were not defined, or the correct loader was not found.");this._cascadeLoadImgs(t,E,(e,t)=>{g&&g(e,t)},n,o)}return this._internalTexturesCache.push(E),E}},,,function(e,t,n){"use strict";n.r(t),n.d(t,"DumpFramebuffer",(function(){return c})),n.d(t,"DumpDataAsync",(function(){return d})),n.d(t,"DumpData",(function(){return h})),n.d(t,"Dispose",(function(){return u})),n.d(t,"DumpTools",(function(){return f}));var i=n(336),r=n(312),s=n(26),a=n(62);let o,l=null;async function c(e,t,n,i,r="image/png",s,a){const o=await n.readPixels(0,0,e,t);h(e,t,new Uint8Array(o.buffer),i,r,s,!0,void 0,a)}function d(e,t,n,i="image/png",r,s=!1,a=!1,o){return new Promise(l=>{h(e,t,n,e=>l(e),i,r,s,a,o)})}function h(e,t,c,d,h="image/png",f,m=!1,p=!1,g){(async function(){return l||(l=new Promise((e,t)=>{let r,s=null;const l={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};Promise.resolve().then(n.bind(null,44)).then(({ThinEngine:c})=>{const d=a.a.Instances.length;try{r=new OffscreenCanvas(100,100),s=new c(r,!1,l)}catch(e){var h;d<a.a.Instances.length&&(null===(h=a.a.Instances.pop())||void 0===h||h.dispose()),r=document.createElement("canvas"),s=new c(r,!1,l)}a.a.Instances.pop(),a.a.OnEnginesDisposedObservable.add(e=>{s&&e!==s&&!s.isDisposed&&0===a.a.Instances.length&&u()}),s.getCaps().parallelShaderCompile=void 0;const f=new i.a(s);n.e(0).then(n.bind(null,492)).then(({passPixelShader:n})=>{if(!s)return void t("Engine is not defined");const a=new i.b({engine:s,name:n.name,fragmentShader:n.shader,samplerNames:["textureSampler"]});o={canvas:r,engine:s,renderer:f,wrapper:a},e(o)})}).catch(t)})),await l})().then(n=>{if(n.engine.setSize(e,t,!0),c instanceof Float32Array){const e=new Uint8Array(c.length);let t=c.length;for(;t--;){const n=c[t];e[t]=Math.round(255*Object(s.a)(n))}c=e}const i=n.engine.createRawTexture(c,e,t,5,!1,!m,1);n.renderer.setViewport(),n.renderer.applyEffectWrapper(n.wrapper),n.wrapper.effect._bindTexture("textureSampler",i),n.renderer.draw(),p?r.b.ToBlob(n.canvas,e=>{const t=new FileReader;t.onload=e=>{const t=e.target.result;d&&d(t)},t.readAsArrayBuffer(e)},h,g):r.b.EncodeScreenshotCanvasData(n.canvas,d,h,f,g),i.dispose()})}function u(){var e;o?(o.wrapper.dispose(),o.renderer.dispose(),o.engine.dispose()):null===(e=l)||void 0===e||e.then(e=>{e.wrapper.dispose(),e.renderer.dispose(),e.engine.dispose()}),l=null,o=null}const f={DumpData:h,DumpDataAsync:d,DumpFramebuffer:c,Dispose:u};r.b.DumpData=h,r.b.DumpDataAsync=d,r.b.DumpFramebuffer=c},function(e,t,n){"use strict";n.r(t),n.d(t,"depthPixelShader",(function(){return a}));var i=n(66);n(342),n(378),n(343);const r="depthPixelShader",s="#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying float vDepthMetric;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vec4 vViewPos;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\ngl_FragColor=pack(vViewPos.z);\n#else\ngl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\ngl_FragColor=pack(gl_FragCoord.z);\n#else\ngl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\ngl_FragColor=pack(vDepthMetric);\n#else\ngl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";i.a.ShadersStore[r]=s;const a={name:r,shader:s}},function(e,t,n){"use strict";n.r(t),n.d(t,"passPixelShader",(function(){return r}));const i="varying vec2 vUV;uniform sampler2D textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);}";n(66).a.ShadersStore.passPixelShader=i;const r={name:"passPixelShader",shader:i}},function(e,t,n){"use strict";n.r(t),n.d(t,"rgbdEncodePixelShader",(function(){return a}));var i=n(66);n(323);const r="rgbdEncodePixelShader",s="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}";i.a.ShadersStore[r]=s;const a={name:r,shader:s}},function(e,t,n){"use strict";n.r(t),n.d(t,"rgbdEncodePixelShaderWGSL",(function(){return a}));var i=n(66);n(322);const r="rgbdEncodePixelShader",s="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=toRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb);}";i.a.ShadersStoreWGSL[r]=s;const a={name:r,shader:s}},function(e,t,n){"use strict";n.r(t),n.d(t,"depthVertexShader",(function(){return s}));var i=n(66);n(344),n(345),n(346),n(347),n(348),n(379);i.a.IncludesShadersStore.pointCloudVertexDeclaration="#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n",n(349),n(350),n(351),n(352),n(353),n(354),n(405);const r="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform mat4 view;varying vec4 vViewPos;\n#endif\n#include<pointCloudVertexDeclaration>\nvarying float vDepthMetric;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\ngl_Position=viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvViewPos=view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));\n#else\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#include<pointCloudVertex>\n}\n";i.a.ShadersStore.depthVertexShader=r;const s={name:"depthVertexShader",shader:r}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return o}));var i=n(53),r=n(245),s=((Object(r.a)()||{}).Symbol,(Object(r.a)()||{}).Reflect,i.a,function(e,t){return(s=i.b.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t[i.i](n)&&(e[n]=t[n])})(e,t)});function a(e,t){function n(){this.constructor=e}typeof t!==i.h&&null!==t&&Object(r.c)("Class extends value "+String(t)+" is not a constructor or null"),s(e,t),e[i.k]=null===t?Object(r.b)(t):(n[i.k]=t[i.k],new n)}function o(e,t){for(var n=0,i=t.length,r=e.length;n<i;n++,r++)e[r]=t[n];return e}},function(e,t,n){"use strict";function i(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}n.r(t),n.d(t,"AbrController",(function(){return pn})),n.d(t,"AttrList",(function(){return y})),n.d(t,"AudioStreamController",(function(){return Vi})),n.d(t,"AudioTrackController",(function(){return Xi})),n.d(t,"BasePlaylistController",(function(){return nn})),n.d(t,"BaseSegment",(function(){return D})),n.d(t,"BaseStreamController",(function(){return Fn})),n.d(t,"BufferController",(function(){return Qi})),n.d(t,"CMCDController",(function(){return hs})),n.d(t,"CapLevelController",(function(){return Hr})),n.d(t,"ChunkMetadata",(function(){return Sn})),n.d(t,"ContentSteeringController",(function(){return us})),n.d(t,"DateRange",(function(){return O})),n.d(t,"EMEController",(function(){return Xr})),n.d(t,"ErrorActionFlags",(function(){return en})),n.d(t,"ErrorController",(function(){return tn})),n.d(t,"ErrorDetails",(function(){return T})),n.d(t,"ErrorTypes",(function(){return E})),n.d(t,"Events",(function(){return v})),n.d(t,"FPSController",(function(){return Wr})),n.d(t,"Fragment",(function(){return P})),n.d(t,"Hls",(function(){return Ls})),n.d(t,"HlsSkip",(function(){return Pt})),n.d(t,"HlsUrlParameters",(function(){return Nt})),n.d(t,"KeySystemFormats",(function(){return k})),n.d(t,"KeySystems",(function(){return B})),n.d(t,"Level",(function(){return Ft})),n.d(t,"LevelDetails",(function(){return N})),n.d(t,"LevelKey",(function(){return Ue})),n.d(t,"LoadStats",(function(){return x})),n.d(t,"MetadataSchema",(function(){return bt})),n.d(t,"NetworkErrorAction",(function(){return Jt})),n.d(t,"Part",(function(){return L})),n.d(t,"PlaylistLevelType",(function(){return mt})),n.d(t,"SubtitleStreamController",(function(){return ji})),n.d(t,"SubtitleTrackController",(function(){return Ki})),n.d(t,"TimelineController",(function(){return kr})),n.d(t,"default",(function(){return Ls})),n.d(t,"getMediaSource",(function(){return Xe})),n.d(t,"isMSESupported",(function(){return Os})),n.d(t,"isSupported",(function(){return xs}));var r,s,a,o,l,c={exports:{}};r=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,a=/(?:\/|^)\.(?=\/)/g,o=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,c.exports=l={buildAbsoluteURL:function(e,t,n){if(n=n||{},e=e.trim(),!(t=t.trim())){if(!n.alwaysNormalize)return e;var i=l.parseURL(e);if(!i)throw new Error("Error trying to parse base URL.");return i.path=l.normalizePath(i.path),l.buildURLFromParts(i)}var r=l.parseURL(t);if(!r)throw new Error("Error trying to parse relative URL.");if(r.scheme)return n.alwaysNormalize?(r.path=l.normalizePath(r.path),l.buildURLFromParts(r)):t;var a=l.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var o=s.exec(a.path);a.netLoc=o[1],a.path=o[2]}a.netLoc&&!a.path&&(a.path="/");var c={scheme:a.scheme,netLoc:r.netLoc,path:null,params:r.params,query:r.query,fragment:r.fragment};if(!r.netLoc&&(c.netLoc=a.netLoc,"/"!==r.path[0]))if(r.path){var d=a.path,h=d.substring(0,d.lastIndexOf("/")+1)+r.path;c.path=l.normalizePath(h)}else c.path=a.path,r.params||(c.params=a.params,r.query||(c.query=a.query));return null===c.path&&(c.path=n.alwaysNormalize?l.normalizePath(r.path):r.path),l.buildURLFromParts(c)},parseURL:function(e){var t=r.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(a,"");e.length!==(e=e.replace(o,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}};var d=c.exports;function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach((function(t){f(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function f(e,t,n){return(t="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(t,"string"))?i:String(i))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e;var i}function m(){return(m=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}const p=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},g=Number.isSafeInteger||function(e){return"number"==typeof e&&Math.abs(e)<=_},_=Number.MAX_SAFE_INTEGER||9007199254740991;let v=function(e){return e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.BUFFER_RESET="hlsBufferReset",e.BUFFER_CODECS="hlsBufferCodecs",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_EOS="hlsBufferEos",e.BUFFER_FLUSHING="hlsBufferFlushing",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_UPDATED="hlsLevelsUpdated",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.CUES_PARSED="hlsCuesParsed",e.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_LOADING="hlsKeyLoading",e.KEY_LOADED="hlsKeyLoaded",e.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",e.BACK_BUFFER_REACHED="hlsBackBufferReached",e.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",e}({}),E=function(e){return e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e}({}),T=function(e){return e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",e.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",e.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",e.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_PARSING_ERROR="levelParsingError",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.FRAG_GAP="fragGap",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.INTERNAL_EXCEPTION="internalException",e.INTERNAL_ABORTED="aborted",e.UNKNOWN="unknown",e}({});const S=function(){},A={trace:S,debug:S,log:S,warn:S,info:S,error:S};let b=A;const I=b,R=/^(\d+)x(\d+)$/,C=/(.+?)=(".*?"|.*?)(?:,|$)/g;class y{get clientAttrs(){return Object.keys(this).filter(e=>"X-"===e.substring(0,2))}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const n=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)n[e]=parseInt(t.slice(2*e,2*e+2),16);return n}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const n=this[e];return n?parseFloat(n):t}enumeratedString(e){return this[e]}bool(e){return"YES"===this[e]}decimalResolution(e){const t=R.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t;const n={};for(C.lastIndex=0;null!==(t=C.exec(e));){let e=t[2];0===e.indexOf('"')&&e.lastIndexOf('"')===e.length-1&&(e=e.slice(1,-1)),n[t[1].trim()]=e}return n}constructor(e){"string"==typeof e&&(e=y.parseAttrList(e)),m(this,e)}}function M(e){return"SCTE35-OUT"===e||"SCTE35-IN"===e}class O{get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const e=this.duration;return null!==e?new Date(this._startDate.getTime()+1e3*e):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(p(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&p(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}constructor(e,t){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,t){const n=t.attr;for(const t in n)if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]!==n[t]){I.warn(`DATERANGE tag attribute: "${t}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=t;break}e=m(new y({}),n,e)}if(this.attr=e,this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const e=new Date(this.attr["END-DATE"]);p(e.getTime())&&(this._endDate=e)}}}class x{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}class D{setByteRange(e,t){const n=e.split("@",2);let i;i=1===n.length?(null==t?void 0:t.byteRangeEndOffset)||0:parseInt(n[1]),this._byteRange=[i,parseInt(n[0])+i]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=d.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}constructor(e){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={audio:null,video:null,audiovideo:null},this.baseurl=e}}class P extends D{get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{const e=Object.keys(this.levelkeys);if(1===e.length)return this._decryptdata=this.levelkeys[e[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;if(!p(this.programDateTime))return null;const e=p(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){var e;if(null!=(e=this._decryptdata)&&e.encrypted)return!0;if(this.levelkeys){const e=Object.keys(this.levelkeys),t=e.length;if(t>1||1===t&&this.levelkeys[e[0]].encrypted)return!0}return!1}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;null==(e=this.loader)||e.abort(),null==(t=this.keyLoader)||t.abort()}setElementaryStreamInfo(e,t,n,i,r,s=!1){const{elementaryStreams:a}=this,o=a[e];o?(o.startPTS=Math.min(o.startPTS,t),o.endPTS=Math.max(o.endPTS,n),o.startDTS=Math.min(o.startDTS,i),o.endDTS=Math.max(o.endDTS,r)):a[e]={startPTS:t,endPTS:n,startDTS:i,endDTS:r,partial:s}}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e.audio=null,e.video=null,e.audiovideo=null}constructor(e,t){super(t),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new x,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}}class L extends D{get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}constructor(e,t,n,i,r){super(n),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new x,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=i;const s=e.enumeratedString("BYTERANGE");s&&this.setByteRange(s,r),r&&(this.fragOffset=r.fragOffset+r.duration)}}class N{reloaded(e){if(!e)return this.advanced=!0,void(this.updated=!0);const t=this.lastPartSn-e.lastPartSn,n=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!n||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||0===t&&n>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&p(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?1e3*(this.driftEnd-this.driftStart)/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}}function F(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}function w(e){return Uint8Array.from(unescape(encodeURIComponent(e)),e=>e.charCodeAt(0))}const U="undefined"!=typeof self?self:void 0;var B={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},k={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function V(e){switch(e){case k.FAIRPLAY:return B.FAIRPLAY;case k.PLAYREADY:return B.PLAYREADY;case k.WIDEVINE:return B.WIDEVINE;case k.CLEARKEY:return B.CLEARKEY}}function G(e){return"edef8ba979d64acea3c827dcd51d21ed"===e?B.WIDEVINE:"9a04f07998404286ab92e65be0885f95"===e?B.PLAYREADY:"1077efecc0b24d02ace33c1e52e2fb4b"===e||"e2719d58a985b3c9781ab030af78d30e"===e?B.CLEARKEY:void 0}function H(e){switch(e){case B.FAIRPLAY:return k.FAIRPLAY;case B.PLAYREADY:return k.PLAYREADY;case B.WIDEVINE:return k.WIDEVINE;case B.CLEARKEY:return k.CLEARKEY}}function W(e){const{drmSystems:t,widevineLicenseUrl:n}=e,i=t?[B.FAIRPLAY,B.WIDEVINE,B.PLAYREADY,B.CLEARKEY].filter(e=>!!t[e]):[];return!i[B.WIDEVINE]&&n&&i.push(B.WIDEVINE),i}const X=null!=U&&null!=(j=U.navigator)&&j.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;var j;function z(e){const t=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),n=String.fromCharCode.apply(null,Array.from(t)),i=n.substring(n.indexOf("<"),n.length),r=(new DOMParser).parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(r){const e=r.childNodes[0]?r.childNodes[0].nodeValue:r.getAttribute("VALUE");if(e){const t=F(e).subarray(0,16);return function(e){const t=function(e,t,n){const i=e[t];e[t]=e[n],e[n]=i};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}(t),t}}return null}function K(e,t,n){return Uint8Array.prototype.slice?e.slice(t,n):new Uint8Array(Array.prototype.slice.call(e,t,n))}const Y=(e,t)=>t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,q=(e,t)=>t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,Q=(e,t)=>{const n=t;let i=0;for(;Y(e,t);)i+=10,i+=Z(e,t+6),q(e,t+10)&&(i+=10),t+=i;if(i>0)return e.subarray(n,n+i)},Z=(e,t)=>{let n=0;return n=(127&e[t])<<21,n|=(127&e[t+1])<<14,n|=(127&e[t+2])<<7,n|=127&e[t+3],n},$=(e,t)=>Y(e,t)&&Z(e,t+6)+10<=e.length-t,J=e=>{const t=ne(e);for(let e=0;e<t.length;e++){const n=t[e];if(ee(n))return oe(n)}},ee=e=>e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info,te=e=>{const t=String.fromCharCode(e[0],e[1],e[2],e[3]),n=Z(e,4);return{type:t,size:n,data:e.subarray(10,10+n)}},ne=e=>{let t=0;const n=[];for(;Y(e,t);){const i=Z(e,t+6);t+=10;const r=t+i;for(;t+8<r;){const i=te(e.subarray(t)),r=ie(i);r&&n.push(r),t+=i.size+10}q(e,t)&&(t+=10)}return n},ie=e=>"PRIV"===e.type?re(e):"W"===e.type[0]?ae(e):se(e),re=e=>{if(e.size<2)return;const t=le(e.data,!0),n=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:n.buffer}},se=e=>{if(e.size<2)return;if("TXXX"===e.type){let t=1;const n=le(e.data.subarray(t),!0);t+=n.length+1;const i=le(e.data.subarray(t));return{key:e.type,info:n,data:i}}const t=le(e.data.subarray(1));return{key:e.type,data:t}},ae=e=>{if("WXXX"===e.type){if(e.size<2)return;let t=1;const n=le(e.data.subarray(t),!0);t+=n.length+1;const i=le(e.data.subarray(t));return{key:e.type,info:n,data:i}}const t=le(e.data);return{key:e.type,data:t}},oe=e=>{if(8===e.data.byteLength){const t=new Uint8Array(e.data),n=1&t[3];let i=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return i/=45,n&&(i+=47721858.84),Math.round(i)}},le=(e,t=!1)=>{const n=de();if(n){const i=n.decode(e);if(t){const e=i.indexOf("\0");return-1!==e?i.substring(0,e):i}return i.replace(/\0/g,"")}const i=e.length;let r,s,a,o="",l=0;for(;l<i;){if(r=e[l++],0===r&&t)return o;if(0!==r&&3!==r)switch(r>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(r);break;case 12:case 13:s=e[l++],o+=String.fromCharCode((31&r)<<6|63&s);break;case 14:s=e[l++],a=e[l++],o+=String.fromCharCode((15&r)<<12|(63&s)<<6|(63&a)<<0)}}return o};let ce;function de(){if(!navigator.userAgent.includes("PlayStation 4"))return ce||void 0===self.TextDecoder||(ce=new self.TextDecoder("utf-8")),ce}const he=function(e){let t="";for(let n=0;n<e.length;n++){let i=e[n].toString(16);i.length<2&&(i="0"+i),t+=i}return t},ue=Math.pow(2,32)-1,fe=[].push,me={video:1,audio:2,id3:3,text:4};function pe(e){return String.fromCharCode.apply(null,e)}function ge(e,t){const n=e[t]<<8|e[t+1];return n<0?65536+n:n}function _e(e,t){const n=Ee(e,t);return n<0?4294967296+n:n}function ve(e,t){let n=_e(e,t);return n*=Math.pow(2,32),n+=_e(e,t+4),n}function Ee(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function Te(e,t,n){e[t]=n>>24,e[t+1]=n>>16&255,e[t+2]=n>>8&255,e[t+3]=255&n}function Se(e,t){const n=[];if(!t.length)return n;const i=e.byteLength;for(let r=0;r<i;){const s=_e(e,r),a=s>1?r+s:i;if(pe(e.subarray(r+4,r+8))===t[0])if(1===t.length)n.push(e.subarray(r+8,a));else{const i=Se(e.subarray(r+8,a),t.slice(1));i.length&&fe.apply(n,i)}r=a}return n}function Ae(e){const t=[],n=e[0];let i=8;const r=_e(e,i);i+=4;let s=0,a=0;0===n?(s=_e(e,i),a=_e(e,i+4),i+=8):(s=ve(e,i),a=ve(e,i+8),i+=16),i+=2;let o=e.length+a;const l=ge(e,i);i+=2;for(let n=0;n<l;n++){let n=i;const s=_e(e,n);n+=4;const a=2147483647&s;if(1==(2147483648&s)>>>31)return I.warn("SIDX has hierarchical references (not supported)"),null;const l=_e(e,n);n+=4,t.push({referenceSize:a,subsegmentDuration:l,info:{duration:l/r,start:o,end:o+a-1}}),o+=a,n+=4,i=n}return{earliestPresentationTime:s,timescale:r,version:n,referencesCount:l,references:t}}function be(e){const t=[],n=Se(e,["moov","trak"]);for(let e=0;e<n.length;e++){const i=n[e],r=Se(i,["tkhd"])[0];if(r){let e=r[0];const n=_e(r,0===e?12:20),s=Se(i,["mdia","mdhd"])[0];if(s){e=s[0];const r=_e(s,0===e?12:20),a=Se(i,["mdia","hdlr"])[0];if(a){const e={soun:"audio",vide:"video"}[pe(a.subarray(8,12))];if(e){const s=Ie(Se(i,["mdia","minf","stbl","stsd"])[0]);t[n]={timescale:r,type:e},t[e]=u({timescale:r,id:n},s)}}}}}return Se(e,["moov","mvex","trex"]).forEach(e=>{const n=_e(e,4),i=t[n];i&&(i.default={duration:_e(e,12),flags:_e(e,20)})}),t}function Ie(e){const t=e.subarray(8),n=t.subarray(86),i=pe(t.subarray(4,8));let r=i;const s="enca"===i||"encv"===i;if(s){const e=Se(t,[i])[0];Se(e.subarray("enca"===i?28:78),["sinf"]).forEach(e=>{const t=Se(e,["schm"])[0];if(t){const n=pe(t.subarray(4,8));if("cbcs"===n||"cenc"===n){const t=Se(e,["frma"])[0];t&&(r=pe(t))}}})}switch(r){case"avc1":case"avc2":case"avc3":case"avc4":{const e=Se(n,["avcC"])[0];r+="."+Ce(e[1])+Ce(e[2])+Ce(e[3]);break}case"mp4a":{const e=Se(t,[i])[0],n=Se(e.subarray(28),["esds"])[0];if(n&&n.length>12){let e=4;if(3!==n[e++])break;e=Re(n,e),e+=2;const t=n[e++];if(128&t&&(e+=2),64&t&&(e+=n[e++]),4!==n[e++])break;e=Re(n,e);const i=n[e++];if(64!==i)break;if(r+="."+Ce(i),e+=12,5!==n[e++])break;e=Re(n,e);const s=n[e++];let a=(248&s)>>3;31===a&&(a+=1+((7&s)<<3)+((224&n[e])>>5)),r+="."+a}break}case"hvc1":case"hev1":{const e=Se(n,["hvcC"])[0],t=e[1],i=["","A","B","C"][t>>6],s=31&t,a=_e(e,2),o=(32&t)>>5?"H":"L",l=e[12],c=e.subarray(6,12);r+="."+i+s,r+="."+a.toString(16).toUpperCase(),r+="."+o+l;let d="";for(let e=c.length;e--;){const t=c[e];(t||d)&&(d="."+t.toString(16).toUpperCase()+d)}r+=d;break}case"dvh1":case"dvhe":{const e=Se(n,["dvcC"])[0],t=e[2]>>1&127,i=e[2]<<5&32|e[3]>>3&31;r+="."+ye(t)+"."+ye(i);break}case"vp09":{const e=Se(n,["vpcC"])[0],t=e[4],i=e[5],s=e[6]>>4&15;r+="."+ye(t)+"."+ye(i)+"."+ye(s);break}case"av01":{const e=Se(n,["av1C"])[0],t=e[1]>>>5,i=31&e[1],s=e[2]>>>7?"H":"M",a=(64&e[2])>>6,o=(32&e[2])>>5,l=2===t&&a?o?12:10:a?10:8,c=(16&e[2])>>4,d=(8&e[2])>>3,h=(4&e[2])>>2,u=3&e[2],f=1,m=1,p=1,g=0;r+="."+t+"."+ye(i)+s+"."+ye(l)+"."+c+"."+d+h+u+"."+ye(f)+"."+ye(m)+"."+ye(p)+"."+g;break}}return{codec:r,encrypted:s}}function Re(e,t){const n=t+5;for(;128&e[t++]&&t<n;);return t}function Ce(e){return("0"+e.toString(16).toUpperCase()).slice(-2)}function ye(e){return(e<10?"0":"")+e}function Me(e){const t=Se(e,["schm"])[0];if(t){const n=pe(t.subarray(4,8));if("cbcs"===n||"cenc"===n)return Se(e,["schi","tenc"])[0]}return null}function Oe(e){const t=_e(e,0);let n=8;1&t&&(n+=4),4&t&&(n+=4);let i=0;const r=_e(e,4);for(let s=0;s<r;s++)256&t&&(i+=_e(e,n),n+=4),512&t&&(n+=4),1024&t&&(n+=4),2048&t&&(n+=4);return i}function xe(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}function De(e,t){const n=[],i=t.samples,r=t.timescale,s=t.id;let a=!1;return Se(i,["moof"]).map(o=>{const l=o.byteOffset-8;Se(o,["traf"]).map(o=>{const c=Se(o,["tfdt"]).map(e=>{const t=e[0];let n=_e(e,4);return 1===t&&(n*=Math.pow(2,32),n+=_e(e,8)),n/r})[0];return void 0!==c&&(e=c),Se(o,["tfhd"]).map(c=>{const d=_e(c,4),h=16777215&_e(c,0);let u=0;const f=0!=(16&h);let m=0;const p=0!=(32&h);let g=8;d===s&&(0!=(1&h)&&(g+=8),0!=(2&h)&&(g+=4),0!=(8&h)&&(u=_e(c,g),g+=4),f&&(m=_e(c,g),g+=4),p&&(g+=4),"video"===t.type&&(a=function(e){if(!e)return!1;const t=e.indexOf("."),n=t<0?e:e.substring(0,t);return"hvc1"===n||"hev1"===n||"dvh1"===n||"dvhe"===n}(t.codec)),Se(o,["trun"]).map(s=>{const o=s[0],c=16777215&_e(s,0),d=0!=(1&c);let h=0;const f=0!=(4&c),p=0!=(256&c);let g=0;const _=0!=(512&c);let v=0;const E=0!=(1024&c),T=0!=(2048&c);let S=0;const A=_e(s,4);let b=8;d&&(h=_e(s,b),b+=4),f&&(b+=4);let I=h+l;for(let l=0;l<A;l++){if(p?(g=_e(s,b),b+=4):g=u,_?(v=_e(s,b),b+=4):v=m,E&&(b+=4),T&&(S=0===o?_e(s,b):Ee(s,b),b+=4),"video"===t.type){let t=0;for(;t<v;){const s=_e(i,I);I+=4,Pe(a,i[I])&&Le(i.subarray(I,I+s),a?2:1,e+S/r,n),I+=s,t+=s+4}}e+=g/r}}))})})}),n}function Pe(e,t){if(e){const e=t>>1&63;return 39===e||40===e}return 6==(31&t)}function Le(e,t,n,i){const r=Ne(e);let s=0;s+=t;let a=0,o=0,l=0;for(;s<r.length;){a=0;do{if(s>=r.length)break;l=r[s++],a+=l}while(255===l);o=0;do{if(s>=r.length)break;l=r[s++],o+=l}while(255===l);const e=r.length-s;let t=s;if(o<e)s+=o;else if(o>e){I.error(`Malformed SEI payload. ${o} is too small, only ${e} bytes left to parse.`);break}if(4===a){if(181===r[t++]){const e=ge(r,t);if(t+=2,49===e){const e=_e(r,t);if(t+=4,1195456820===e){const e=r[t++];if(3===e){const s=r[t++],o=31&s,l=64&s,c=l?2+3*o:0,d=new Uint8Array(c);if(l){d[0]=s;for(let e=1;e<c;e++)d[e]=r[t++]}i.push({type:e,payloadType:a,pts:n,bytes:d})}}}}}else if(5===a&&o>16){const e=[];for(let n=0;n<16;n++){const i=r[t++].toString(16);e.push(1==i.length?"0"+i:i),3!==n&&5!==n&&7!==n&&9!==n||e.push("-")}const s=o-16,l=new Uint8Array(s);for(let e=0;e<s;e++)l[e]=r[t++];i.push({payloadType:a,pts:n,uuid:e.join(""),userData:le(l),userDataBytes:l})}}}function Ne(e){const t=e.byteLength,n=[];let i=1;for(;i<t-2;)0===e[i]&&0===e[i+1]&&3===e[i+2]?(n.push(i+2),i+=2):i++;if(0===n.length)return e;const r=t-n.length,s=new Uint8Array(r);let a=0;for(i=0;i<r;a++,i++)a===n[0]&&(a++,n.shift()),s[i]=e[a];return s}function Fe(e){const t=e.getUint32(0),n=e.byteOffset,i=e.byteLength;if(i<t)return{offset:n,size:i};if(1886614376!==e.getUint32(4))return{offset:n,size:t};const r=e.getUint32(8)>>>24;if(0!==r&&1!==r)return{offset:n,size:t};const s=e.buffer,a=he(new Uint8Array(s,n+12,16)),o=e.getUint32(28);let l=null,c=null;if(0===r){if(t-32<o||o<22)return{offset:n,size:t};c=new Uint8Array(s,n+32,o)}else if(1===r){if(!o||i<n+32+16*o+16)return{offset:n,size:t};l=[];for(let e=0;e<o;e++)l.push(new Uint8Array(s,n+32+16*e,16))}return{version:r,systemId:a,kids:l,data:c,offset:n,size:t}}let we={};class Ue{static clearKeyUriToKeyIdMap(){we={}}isSupported(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case k.FAIRPLAY:case k.WIDEVINE:case k.PLAYREADY:case k.CLEARKEY:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof e&&("AES-128"!==this.method||this.iv||I.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const t=function(e){const t=new Uint8Array(16);for(let n=12;n<16;n++)t[n]=e>>8*(15-n)&255;return t}(e);return new Ue(this.method,this.uri,"identity",this.keyFormatVersions,t)}const t=function(e){const t=e.split(":");let n=null;if("data"===t[0]&&2===t.length){const e=t[1].split(";"),i=e[e.length-1].split(",");if(2===i.length){const t="base64"===i[0],r=i[1];t?(e.splice(-1,1),n=F(r)):n=function(e){const t=w(e).subarray(0,16),n=new Uint8Array(16);return n.set(t,16-t.length),n}(r)}}return n}(this.uri);if(t)switch(this.keyFormat){case k.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case k.PLAYREADY:{const e=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=function(e,t,n){if(16!==e.byteLength)throw new RangeError("Invalid system id");let i,r,s;if(t){i=1,r=new Uint8Array(16*t.length);for(let e=0;e<t.length;e++){const n=t[e];if(16!==n.byteLength)throw new RangeError("Invalid key");r.set(n,16*e)}}else i=0,r=new Uint8Array;i>0?(s=new Uint8Array(4),t.length>0&&new DataView(s.buffer).setUint32(0,t.length,!1)):s=new Uint8Array;const a=new Uint8Array(4);return n&&n.byteLength>0&&new DataView(a.buffer).setUint32(0,n.byteLength,!1),function(e,...t){const n=t.length;let i=8,r=n;for(;r--;)i+=t[r].byteLength;const s=new Uint8Array(i);for(s[0]=i>>24&255,s[1]=i>>16&255,s[2]=i>>8&255,s[3]=255&i,s.set(e,4),r=0,i=8;r<n;r++)s.set(t[r],i),i+=t[r].byteLength;return s}([112,115,115,104],new Uint8Array([i,0,0,0]),e,s,r,a,n||new Uint8Array)}(e,null,t),this.keyId=z(t);break}default:{let e=t.subarray(0,16);if(16!==e.length){const t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=we[this.uri];if(!e){const t=Object.keys(we).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16),new DataView(e.buffer,12,4).setUint32(0,t),we[this.uri]=e}this.keyId=e}return this}constructor(e,t,n,i=[1],r=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=n,this.keyFormatVersions=i,this.iv=r,this.encrypted=!!e&&"NONE"!==e,this.isCommonEncryption=this.encrypted&&"AES-128"!==e}}const Be=/\{\$([a-zA-Z0-9-_]+)\}/g;function ke(e){return Be.test(e)}function Ve(e,t,n){if(null!==e.variableList||e.hasVariableRefs)for(let i=n.length;i--;){const r=n[i],s=t[r];s&&(t[r]=Ge(e,s))}}function Ge(e,t){if(null!==e.variableList||e.hasVariableRefs){const n=e.variableList;return t.replace(Be,t=>{const i=t.substring(2,t.length-1),r=null==n?void 0:n[i];return void 0===r?(e.playlistParsingError||(e.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${i}"`)),t):r})}return t}function He(e,t,n){let i,r,s=e.variableList;if(s||(e.variableList=s={}),"QUERYPARAM"in t){i=t.QUERYPARAM;try{const e=new self.URL(n).searchParams;if(!e.has(i))throw new Error(`"${i}" does not match any query parameter in URI: "${n}"`);r=e.get(i)}catch(t){e.playlistParsingError||(e.playlistParsingError=new Error("EXT-X-DEFINE QUERYPARAM: "+t.message))}}else i=t.NAME,r=t.VALUE;i in s?e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${i}"`)):s[i]=r||""}function We(e,t,n){const i=t.IMPORT;if(n&&i in n){let t=e.variableList;t||(e.variableList=t={}),t[i]=n[i]}else e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}function Xe(e=!0){if("undefined"!=typeof self)return(e||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}const je={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function ze(e,t,n=!0){return!e.split(",").some(e=>!Ke(e,t,n))}function Ke(e,t,n=!0){var i;const r=Xe(n);return null!=(i=null==r?void 0:r.isTypeSupported(Ye(e,t)))&&i}function Ye(e,t){return`${t}/mp4;codecs="${e}"`}function qe(e){if(e){const t=e.substring(0,4);return je.video[t]}return 2}function Qe(e){return e.split(",").reduce((e,t)=>{const n=je.video[t];return n?(2*n+e)/(e?3:2):(je.audio[t]+e)/(e?2:1)},0)}const Ze={},$e=/flac|opus/i;function Je(e,t=!0){return e.replace($e,e=>function(e,t=!0){if(Ze[e])return Ze[e];const n={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[e];for(let i=0;i<n.length;i++)if(Ke(n[i],"audio",t))return Ze[e]=n[i],n[i];return e}(e.toLowerCase(),t))}function et(e,t){return e&&"mp4a"!==e?e:t?t.split(",")[0]:t}const tt=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,nt=/#EXT-X-MEDIA:(.*)/g,it=/^#EXT(?:INF|-X-TARGETDURATION):/m,rt=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),st=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class at{static findGroup(e,t){for(let n=0;n<e.length;n++){const i=e[n];if(i.id===t)return i}}static resolve(e,t){return d.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return it.test(e)}static parseMasterPlaylist(e,t){const n={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:ke(e)},i=[];let r;for(tt.lastIndex=0;null!=(r=tt.exec(e));)if(r[1]){var s;const e=new y(r[1]);Ve(n,e,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const a=Ge(n,r[2]),o={attrs:e,bitrate:e.decimalInteger("BANDWIDTH")||e.decimalInteger("AVERAGE-BANDWIDTH"),name:e.NAME,url:at.resolve(a,t)},l=e.decimalResolution("RESOLUTION");l&&(o.width=l.width,o.height=l.height),ct(e.CODECS,o),null!=(s=o.unknownCodecs)&&s.length||i.push(o),n.levels.push(o)}else if(r[3]){const e=r[3],i=r[4];switch(e){case"SESSION-DATA":{const e=new y(i);Ve(n,e,["DATA-ID","LANGUAGE","VALUE","URI"]);const t=e["DATA-ID"];t&&(null===n.sessionData&&(n.sessionData={}),n.sessionData[t]=e);break}case"SESSION-KEY":{const e=ot(i,t,n);e.encrypted&&e.isSupported()?(null===n.sessionKeys&&(n.sessionKeys=[]),n.sessionKeys.push(e)):I.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${i}"`);break}case"DEFINE":{const e=new y(i);Ve(n,e,["NAME","VALUE","QUERYPARAM"]),He(n,e,t)}break;case"CONTENT-STEERING":{const e=new y(i);Ve(n,e,["SERVER-URI","PATHWAY-ID"]),n.contentSteering={uri:at.resolve(e["SERVER-URI"],t),pathwayId:e["PATHWAY-ID"]||"."};break}case"START":n.startTimeOffset=lt(i)}}const a=i.length>0&&i.length<n.levels.length;return n.levels=a?i:n.levels,0===n.levels.length&&(n.playlistParsingError=new Error("no levels found in manifest")),n}static parseMasterPlaylistMedia(e,t,n){let i;const r={},s=n.levels,a={AUDIO:s.map(e=>({id:e.attrs.AUDIO,audioCodec:e.audioCodec})),SUBTITLES:s.map(e=>({id:e.attrs.SUBTITLES,textCodec:e.textCodec})),"CLOSED-CAPTIONS":[]};let o=0;for(nt.lastIndex=0;null!==(i=nt.exec(e));){const e=new y(i[1]),s=e.TYPE;if(s){const i=a[s],l=r[s]||[];r[s]=l,Ve(n,e,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const c=e.LANGUAGE,d=e["ASSOC-LANGUAGE"],h=e.CHANNELS,u=e.CHARACTERISTICS,f=e["INSTREAM-ID"],m={attrs:e,bitrate:0,id:o++,groupId:e["GROUP-ID"]||"",name:e.NAME||c||"",type:s,default:e.bool("DEFAULT"),autoselect:e.bool("AUTOSELECT"),forced:e.bool("FORCED"),lang:c,url:e.URI?at.resolve(e.URI,t):""};if(d&&(m.assocLang=d),h&&(m.channels=h),u&&(m.characteristics=u),f&&(m.instreamId=f),null!=i&&i.length){const e=at.findGroup(i,m.groupId)||i[0];dt(m,e,"audioCodec"),dt(m,e,"textCodec")}l.push(m)}}return r}static parseLevelPlaylist(e,t,n,i,r,s){const a=new N(t),o=a.fragments;let l,c,d,h=null,u=0,f=0,g=0,_=0,v=null,E=new P(i,t),T=-1,S=!1,A=null;for(rt.lastIndex=0,a.m3u8=e,a.hasVariableRefs=ke(e);null!==(l=rt.exec(e));){S&&(S=!1,E=new P(i,t),E.start=g,E.sn=u,E.cc=_,E.level=n,h&&(E.initSegment=h,E.rawProgramDateTime=h.rawProgramDateTime,h.rawProgramDateTime=null,A&&(E.setByteRange(A),A=null)));const e=l[1];if(e){E.duration=parseFloat(e);const t=(" "+l[2]).slice(1);E.title=t||null,E.tagList.push(t?["INF",e,t]:["INF",e])}else if(l[3]){if(p(E.duration)){E.start=g,d&&ft(E,d,a),E.sn=u,E.level=n,E.cc=_,o.push(E);const e=(" "+l[3]).slice(1);E.relurl=Ge(a,e),ht(E,v),v=E,g+=E.duration,u++,f=0,S=!0}}else if(l[4]){const e=(" "+l[4]).slice(1);v?E.setByteRange(e,v):E.setByteRange(e)}else if(l[5])E.rawProgramDateTime=(" "+l[5]).slice(1),E.tagList.push(["PROGRAM-DATE-TIME",E.rawProgramDateTime]),-1===T&&(T=o.length);else{if(l=l[0].match(st),!l){I.warn("No matches on slow regex match for level playlist!");continue}for(c=1;c<l.length&&void 0===l[c];c++);const e=(" "+l[c]).slice(1),r=(" "+l[c+1]).slice(1),g=l[c+2]?(" "+l[c+2]).slice(1):"";switch(e){case"PLAYLIST-TYPE":a.type=r.toUpperCase();break;case"MEDIA-SEQUENCE":u=a.startSN=parseInt(r);break;case"SKIP":{const e=new y(r);Ve(a,e,["RECENTLY-REMOVED-DATERANGES"]);const t=e.decimalInteger("SKIPPED-SEGMENTS");if(p(t)){a.skippedSegments=t;for(let e=t;e--;)o.unshift(null);u+=t}const n=e.enumeratedString("RECENTLY-REMOVED-DATERANGES");n&&(a.recentlyRemovedDateranges=n.split("\t"));break}case"TARGETDURATION":a.targetduration=Math.max(parseInt(r),1);break;case"VERSION":a.version=parseInt(r);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":a.live=!1;break;case"#":(r||g)&&E.tagList.push(g?[r,g]:[r]);break;case"DISCONTINUITY":_++,E.tagList.push(["DIS"]);break;case"GAP":E.gap=!0,E.tagList.push([e]);break;case"BITRATE":E.tagList.push([e,r]);break;case"DATERANGE":{const e=new y(r);Ve(a,e,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),Ve(a,e,e.clientAttrs);const t=new O(e,a.dateRanges[e.ID]);t.isValid||a.skippedSegments?a.dateRanges[t.id]=t:I.warn(`Ignoring invalid DATERANGE tag: "${r}"`),E.tagList.push(["EXT-X-DATERANGE",r]);break}case"DEFINE":{const e=new y(r);Ve(a,e,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in e?We(a,e,s):He(a,e,t)}break;case"DISCONTINUITY-SEQUENCE":_=parseInt(r);break;case"KEY":{const e=ot(r,t,a);if(e.isSupported()){if("NONE"===e.method){d=void 0;break}d||(d={}),d[e.keyFormat]&&(d=m({},d)),d[e.keyFormat]=e}else I.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${r}"`);break}case"START":a.startTimeOffset=lt(r);break;case"MAP":{const e=new y(r);if(Ve(a,e,["BYTERANGE","URI"]),E.duration){const r=new P(i,t);ut(r,e,n,d),h=r,E.initSegment=h,h.rawProgramDateTime&&!E.rawProgramDateTime&&(E.rawProgramDateTime=h.rawProgramDateTime)}else{const t=E.byteRangeEndOffset;if(t){const e=E.byteRangeStartOffset;A=`${t-e}@${e}`}else A=null;ut(E,e,n,d),h=E,S=!0}break}case"SERVER-CONTROL":{const e=new y(r);a.canBlockReload=e.bool("CAN-BLOCK-RELOAD"),a.canSkipUntil=e.optionalFloat("CAN-SKIP-UNTIL",0),a.canSkipDateRanges=a.canSkipUntil>0&&e.bool("CAN-SKIP-DATERANGES"),a.partHoldBack=e.optionalFloat("PART-HOLD-BACK",0),a.holdBack=e.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const e=new y(r);a.partTarget=e.decimalFloatingPoint("PART-TARGET");break}case"PART":{let e=a.partList;e||(e=a.partList=[]);const n=f>0?e[e.length-1]:void 0,i=f++,s=new y(r);Ve(a,s,["BYTERANGE","URI"]);const o=new L(s,E,t,i,n);e.push(o),E.duration+=o.duration;break}case"PRELOAD-HINT":{const e=new y(r);Ve(a,e,["URI"]),a.preloadHint=e;break}case"RENDITION-REPORT":{const e=new y(r);Ve(a,e,["URI"]),a.renditionReports=a.renditionReports||[],a.renditionReports.push(e);break}default:I.warn("line parsed but not handled: "+l)}}}v&&!v.relurl?(o.pop(),g-=v.duration,a.partList&&(a.fragmentHint=v)):a.partList&&(ht(E,v),E.cc=_,a.fragmentHint=E,d&&ft(E,d,a));const b=o.length,R=o[0],C=o[b-1];if(g+=a.skippedSegments*a.targetduration,g>0&&b&&C){a.averagetargetduration=g/b;const e=C.sn;a.endSN="initSegment"!==e?e:0,a.live||(C.endList=!0),R&&(a.startCC=R.cc)}else a.endSN=0,a.startCC=0;return a.fragmentHint&&(g+=a.fragmentHint.duration),a.totalduration=g,a.endCC=_,T>0&&function(e,t){let n=e[t];for(let i=t;i--;){const t=e[i];if(!t)return;t.programDateTime=n.programDateTime-1e3*t.duration,n=t}}(o,T),a}}function ot(e,t,n){var i,r;const s=new y(e);Ve(n,s,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const a=null!=(i=s.METHOD)?i:"",o=s.URI,l=s.hexadecimalInteger("IV"),c=s.KEYFORMATVERSIONS,d=null!=(r=s.KEYFORMAT)?r:"identity";o&&s.IV&&!l&&I.error("Invalid IV: "+s.IV);const h=o?at.resolve(o,t):"",u=(c||"1").split("/").map(Number).filter(Number.isFinite);return new Ue(a,h,d,u,l)}function lt(e){const t=new y(e).decimalFloatingPoint("TIME-OFFSET");return p(t)?t:null}function ct(e,t){let n=(e||"").split(/[ ,]+/).filter(e=>e);["video","audio","text"].forEach(e=>{const i=n.filter(t=>function(e,t){const n=je[t];return!!n&&!!n[e.slice(0,4)]}(t,e));i.length&&(t[e+"Codec"]=i.join(","),n=n.filter(e=>-1===i.indexOf(e)))}),t.unknownCodecs=n}function dt(e,t,n){const i=t[n];i&&(e[n]=i)}function ht(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):null!=t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime),p(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}function ut(e,t,n,i){e.relurl=t.URI,t.BYTERANGE&&e.setByteRange(t.BYTERANGE),e.level=n,e.sn="initSegment",i&&(e.levelkeys=i),e.initSegment=null}function ft(e,t,n){e.levelkeys=t;const{encryptedFragments:i}=n;i.length&&i[i.length-1].levelkeys===t||!Object.keys(t).some(e=>t[e].isCommonEncryption)||i.push(e)}var mt={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function pt(e){const{type:t}=e;switch(t){case"audioTrack":return mt.AUDIO;case"subtitleTrack":return mt.SUBTITLE;default:return mt.MAIN}}function gt(e,t){let n=e.url;return void 0!==n&&0!==n.indexOf("data:")||(n=t.url),n}class _t{startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.LEVEL_LOADING,this.onLevelLoading,this),e.on(v.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(v.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:e}=this;e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.LEVEL_LOADING,this.onLevelLoading,this),e.off(v.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(v.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(e){const t=this.hls.config,n=t.pLoader,i=t.loader,r=new(n||i)(t);return this.loaders[e.type]=r,r}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:n}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:"manifest",url:n,deliveryDirectives:null})}onLevelLoading(e,t){const{id:n,level:i,pathwayId:r,url:s,deliveryDirectives:a}=t;this.load({id:n,level:i,pathwayId:r,responseType:"text",type:"level",url:s,deliveryDirectives:a})}onAudioTrackLoading(e,t){const{id:n,groupId:i,url:r,deliveryDirectives:s}=t;this.load({id:n,groupId:i,level:null,responseType:"text",type:"audioTrack",url:r,deliveryDirectives:s})}onSubtitleTrackLoading(e,t){const{id:n,groupId:i,url:r,deliveryDirectives:s}=t;this.load({id:n,groupId:i,level:null,responseType:"text",type:"subtitleTrack",url:r,deliveryDirectives:s})}load(e){var t;const n=this.hls.config;let i,r=this.getInternalLoader(e);if(r){const t=r.context;if(t&&t.url===e.url&&t.level===e.level)return void I.trace("[playlist-loader]: playlist request ongoing");I.log("[playlist-loader]: aborting previous loader for type: "+e.type),r.abort()}if(i="manifest"===e.type?n.manifestLoadPolicy.default:m({},n.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),r=this.createInternalLoader(e),p(null==(t=e.deliveryDirectives)?void 0:t.part)){let t;if("level"===e.type&&null!==e.level?t=this.hls.levels[e.level].details:"audioTrack"===e.type&&null!==e.id?t=this.hls.audioTracks[e.id].details:"subtitleTrack"===e.type&&null!==e.id&&(t=this.hls.subtitleTracks[e.id].details),t){const e=t.partTarget,n=t.targetduration;if(e&&n){const t=1e3*Math.max(3*e,.8*n);i=m({},i,{maxTimeToFirstByteMs:Math.min(t,i.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(t,i.maxTimeToFirstByteMs)})}}}const s=i.errorRetry||i.timeoutRetry||{},a={loadPolicy:i,timeout:i.maxLoadTimeMs,maxRetry:s.maxNumRetry||0,retryDelay:s.retryDelayMs||0,maxRetryDelay:s.maxRetryDelayMs||0},o={onSuccess:(e,t,n,i)=>{const r=this.getInternalLoader(n);this.resetInternalLoader(n.type);const s=e.data;0===s.indexOf("#EXTM3U")?(t.parsing.start=performance.now(),at.isMediaPlaylist(s)?this.handleTrackOrLevelPlaylist(e,t,n,i||null,r):this.handleMasterPlaylist(e,t,n,i)):this.handleManifestParsingError(e,n,new Error("no EXTM3U delimiter"),i||null,t)},onError:(e,t,n,i)=>{this.handleNetworkError(t,n,!1,e,i)},onTimeout:(e,t,n)=>{this.handleNetworkError(t,n,!0,void 0,e)}};r.load(e,a,o)}handleMasterPlaylist(e,t,n,i){const r=this.hls,s=e.data,a=gt(e,n),o=at.parseMasterPlaylist(s,a);if(o.playlistParsingError)return void this.handleManifestParsingError(e,n,o.playlistParsingError,i,t);const{contentSteering:l,levels:c,sessionData:d,sessionKeys:h,startTimeOffset:u,variableList:f}=o;this.variableList=f;const{AUDIO:m=[],SUBTITLES:p,"CLOSED-CAPTIONS":g}=at.parseMasterPlaylistMedia(s,a,o);m.length&&(m.some(e=>!e.url)||!c[0].audioCodec||c[0].attrs.AUDIO||(I.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),m.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new y({}),bitrate:0,url:""}))),r.trigger(v.MANIFEST_LOADED,{levels:c,audioTracks:m,subtitles:p,captions:g,contentSteering:l,url:a,stats:t,networkDetails:i,sessionData:d,sessionKeys:h,startTimeOffset:u,variableList:f})}handleTrackOrLevelPlaylist(e,t,n,i,r){const s=this.hls,{id:a,level:o,type:l}=n,c=gt(e,n),d=p(o)?o:p(a)?a:0,h=pt(n),u=at.parseLevelPlaylist(e.data,c,d,h,0,this.variableList);if("manifest"===l){const e={attrs:new y({}),bitrate:0,details:u,name:"",url:c};s.trigger(v.MANIFEST_LOADED,{levels:[e],audioTracks:[],url:c,stats:t,networkDetails:i,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),n.levelDetails=u,this.handlePlaylistLoaded(u,e,t,n,i,r)}handleManifestParsingError(e,t,n,i,r){this.hls.trigger(v.ERROR,{type:E.NETWORK_ERROR,details:T.MANIFEST_PARSING_ERROR,fatal:"manifest"===t.type,url:e.url,err:n,error:n,reason:n.message,response:e,context:t,networkDetails:i,stats:r})}handleNetworkError(e,t,n=!1,i,r){let s=`A network ${n?"timeout":"error"+(i?" (status "+i.code+")":"")} occurred while loading ${e.type}`;"level"===e.type?s+=`: ${e.level} id: ${e.id}`:"audioTrack"!==e.type&&"subtitleTrack"!==e.type||(s+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(s);I.warn("[playlist-loader]: "+s);let o=T.UNKNOWN,l=!1;const c=this.getInternalLoader(e);switch(e.type){case"manifest":o=n?T.MANIFEST_LOAD_TIMEOUT:T.MANIFEST_LOAD_ERROR,l=!0;break;case"level":o=n?T.LEVEL_LOAD_TIMEOUT:T.LEVEL_LOAD_ERROR,l=!1;break;case"audioTrack":o=n?T.AUDIO_TRACK_LOAD_TIMEOUT:T.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case"subtitleTrack":o=n?T.SUBTITLE_TRACK_LOAD_TIMEOUT:T.SUBTITLE_LOAD_ERROR,l=!1}c&&this.resetInternalLoader(e.type);const d={type:E.NETWORK_ERROR,details:o,fatal:l,url:e.url,loader:c,context:e,error:a,networkDetails:t,stats:r};if(i){const n=(null==t?void 0:t.url)||e.url;d.response=u({url:n,data:void 0},i)}this.hls.trigger(v.ERROR,d)}handlePlaylistLoaded(e,t,n,i,r,s){const a=this.hls,{type:o,level:l,id:c,groupId:d,deliveryDirectives:h}=i,u=gt(t,i),f=pt(i),m="number"==typeof i.level&&f===mt.MAIN?l:void 0;if(!e.fragments.length){const e=new Error("No Segments found in Playlist");return void a.trigger(v.ERROR,{type:E.NETWORK_ERROR,details:T.LEVEL_EMPTY_ERROR,fatal:!1,url:u,error:e,reason:e.message,response:t,context:i,level:m,parent:f,networkDetails:r,stats:n})}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const p=e.playlistParsingError;if(p)a.trigger(v.ERROR,{type:E.NETWORK_ERROR,details:T.LEVEL_PARSING_ERROR,fatal:!1,url:u,error:p,reason:p.message,response:t,context:i,level:m,parent:f,networkDetails:r,stats:n});else switch(e.live&&s&&(s.getCacheAge&&(e.ageHeader=s.getCacheAge()||0),s.getCacheAge&&!isNaN(e.ageHeader)||(e.ageHeader=0)),o){case"manifest":case"level":a.trigger(v.LEVEL_LOADED,{details:e,level:m||0,id:c||0,stats:n,networkDetails:r,deliveryDirectives:h});break;case"audioTrack":a.trigger(v.AUDIO_TRACK_LOADED,{details:e,id:c||0,groupId:d||"",stats:n,networkDetails:r,deliveryDirectives:h});break;case"subtitleTrack":a.trigger(v.SUBTITLE_TRACK_LOADED,{details:e,id:c||0,groupId:d||"",stats:n,networkDetails:r,deliveryDirectives:h})}}constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=e,this.registerListeners()}}function vt(e,t){let n;try{n=new Event("addtrack")}catch(e){n=document.createEvent("Event"),n.initEvent("addtrack",!1,!1)}n.track=e,t.dispatchEvent(n)}function Et(e,t){const n=e.mode;if("disabled"===n&&(e.mode="hidden"),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw new Error("addCue is failed for: "+t)}catch(n){I.debug("[texttrack-utils]: "+n);try{const n=new self.TextTrackCue(t.startTime,t.endTime,t.text);n.id=t.id,e.addCue(n)}catch(e){I.debug("[texttrack-utils]: Legacy TextTrackCue fallback failed: "+e)}}"disabled"===n&&(e.mode=n)}function Tt(e){const t=e.mode;if("disabled"===t&&(e.mode="hidden"),e.cues)for(let t=e.cues.length;t--;)e.removeCue(e.cues[t]);"disabled"===t&&(e.mode=t)}function St(e,t,n,i){const r=e.mode;if("disabled"===r&&(e.mode="hidden"),e.cues&&e.cues.length>0){const r=function(e,t,n){const i=[],r=function(e,t){if(t<e[0].startTime)return 0;const n=e.length-1;if(t>e[n].endTime)return-1;let i=0,r=n;for(;i<=r;){const s=Math.floor((r+i)/2);if(t<e[s].startTime)r=s-1;else{if(!(t>e[s].startTime&&i<n))return s;i=s+1}}return e[i].startTime-t<t-e[r].startTime?i:r}(e,t);if(r>-1)for(let s=r,a=e.length;s<a;s++){const r=e[s];if(r.startTime>=t&&r.endTime<=n)i.push(r);else if(r.startTime>n)return i}return i}(e.cues,t,n);for(let t=0;t<r.length;t++)i&&!i(r[t])||e.removeCue(r[t])}"disabled"===r&&(e.mode=r)}function At(e){const t=[];for(let n=0;n<e.length;n++){const i=e[n];"subtitles"!==i.kind&&"captions"!==i.kind||!i.label||t.push(e[n])}return t}var bt={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};function It(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function Rt(e,t,n,i,r){let s=new e(t,n,"");try{s.value=i,r&&(s.type=r)}catch(a){s=new e(t,n,JSON.stringify(r?u({type:r},i):i))}return s}const Ct=(()=>{const e=It();try{e&&new e(0,Number.POSITIVE_INFINITY,"")}catch(e){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function yt(e,t){return e.getTime()/1e3-t}class Mt{destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:e}=this;e.on(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(v.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(v.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(v.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(v.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(e,t){this.media=t.media}onMediaDetaching(){this.id3Track&&(Tt(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const n=e[t];if("metadata"===n.kind&&"id3"===n.label)return vt(n,this.media),n}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:n,enableID3MetadataCues:i}}}=this;if(!n&&!i)return;const{samples:r}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const s=It();if(s)for(let e=0;e<r.length;e++){const t=r[e].type;if(t===bt.emsg&&!n||!i)continue;const a=ne(r[e].data);if(a){const n=r[e].pts;let i=n+r[e].duration;i>Ct&&(i=Ct),i-n<=0&&(i=n+.25);for(let e=0;e<a.length;e++){const r=a[e];if(!ee(r)){this.updateId3CueEnds(n,t);const e=Rt(s,n,i,r,t);e&&this.id3Track.addCue(e)}}}}}updateId3CueEnds(e,t){var n;const i=null==(n=this.id3Track)?void 0:n.cues;if(i)for(let n=i.length;n--;){const r=i[n];r.type===t&&r.startTime<e&&r.endTime===Ct&&(r.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:n,type:i}){const{id3Track:r,hls:s}=this;if(!s)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:o}}=s;if(r&&(a||o)){let e;e="audio"===i?e=>e.type===bt.audioId3&&o:"video"===i?e=>e.type===bt.emsg&&a:e=>e.type===bt.audioId3&&o||e.type===bt.emsg&&a,St(r,t,n,e)}}onLevelUpdated(e,{details:t}){if(!this.media||!t.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:n,id3Track:i}=this,{dateRanges:r}=t,s=Object.keys(r);if(i){const e=Object.keys(n).filter(e=>!s.includes(e));for(let t=e.length;t--;){const r=e[t];Object.keys(n[r].cues).forEach(e=>{i.removeCue(n[r].cues[e])}),delete n[r]}}const a=t.fragments[t.fragments.length-1];if(0===s.length||!p(null==a?void 0:a.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=a.programDateTime/1e3-a.start,l=It();for(let e=0;e<s.length;e++){const t=s[e],i=r[t],a=yt(i.startDate,o),h=n[t],u=(null==h?void 0:h.cues)||{};let f=(null==h?void 0:h.durationKnown)||!1,m=Ct;const p=i.endDate;if(p)m=yt(p,o),f=!0;else if(i.endOnNext&&!f){const e=s.reduce((e,t)=>{if(t!==i.id){const n=r[t];if(n.class===i.class&&n.startDate>i.startDate&&(!e||i.startDate<e.startDate))return n}return e},null);e&&(m=yt(e.startDate,o),f=!0)}const g=Object.keys(i.attr);for(let e=0;e<g.length;e++){const n=g[e];if("ID"===(d=n)||"CLASS"===d||"START-DATE"===d||"DURATION"===d||"END-DATE"===d||"END-ON-NEXT"===d)continue;const r=u[n];if(r)f&&!h.durationKnown&&(r.endTime=m);else if(l){let e=i.attr[n];M(n)&&(c=e,e=Uint8Array.from(c.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer);const r=Rt(l,a,m,{key:n,data:e},bt.dateRange);r&&(r.id=t,this.id3Track.addCue(r),u[n]=r)}}n[t]={cues:u,dateRange:i,durationKnown:f}}var c,d}constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=e,this._registerListeners()}}class Ot{get latency(){return this._latency||0}get maxLatency(){const{config:e,levelDetails:t}=this;return void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const{levelDetails:e}=this;if(null===e)return null;const{holdBack:t,partHoldBack:n,targetduration:i}=e,{liveSyncDuration:r,liveSyncDurationCount:s,lowLatencyMode:a}=this.config,o=this.hls.userConfig;let l=a&&n||t;(o.liveSyncDuration||o.liveSyncDurationCount||0===l)&&(l=void 0!==r?r:s*i);const c=i;return l+Math.min(1*this.stallCount,c)}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency,n=this.levelDetails;if(null===e||null===t||null===n)return null;const i=n.edge,r=e-t-this.edgeStalled,s=i-n.totalduration,a=i-(this.config.lowLatencyMode&&n.partTarget||n.targetduration);return Math.min(Math.max(s,r),a)}get drift(){const{levelDetails:e}=this;return null===e?1:e.drift}get edgeStalled(){const{levelDetails:e}=this;if(null===e)return 0;const t=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e,levelDetails:t}=this;if(!e||!t)return 0;const n=e.buffered.length;return(n?e.buffered.end(n-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(v.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(v.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(v.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(v.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(v.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(v.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(v.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(v.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){this.levelDetails=t,t.advanced&&this.timeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(e,t){var n;t.details===T.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(n=this.levelDetails)&&n.live&&I.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:e,levelDetails:t}=this;if(!e||!t)return;this.currentTime=e.currentTime;const n=this.computeLatency();if(null===n)return;this._latency=n;const{lowLatencyMode:i,maxLiveSyncPlaybackRate:r}=this.config;if(!i||1===r||!t.live)return;const s=this.targetLatency;if(null===s)return;const a=n-s;if(a<Math.min(this.maxLatency,s+t.targetduration)&&a>.05&&this.forwardBufferLength>1){const t=Math.min(2,Math.max(1,r)),n=Math.round(2/(1+Math.exp(-.75*a-this.edgeStalled))*20)/20;e.playbackRate=Math.min(t,Math.max(1,n))}else 1!==e.playbackRate&&0!==e.playbackRate&&(e.playbackRate=1)}estimateLiveEdge(){const{levelDetails:e}=this;return null===e?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return null===e?null:e-this.currentTime}constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=e,this.config=e.config,this.registerListeners()}}const xt=["NONE","TYPE-0","TYPE-1",null],Dt=["SDR","PQ","HLG"];var Pt={No:"",Yes:"YES",v2:"v2"};function Lt(e){const{canSkipUntil:t,canSkipDateRanges:n,age:i}=e;return t&&i<t/2?n?Pt.v2:Pt.Yes:Pt.No}class Nt{addDirectives(e){const t=new self.URL(e);return void 0!==this.msn&&t.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}constructor(e,t,n){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=n}}class Ft{get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return wt(this._audioGroups,e)}hasSubtitleGroup(e){return wt(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t)if("audio"===e){let e=this._audioGroups;e||(e=this._audioGroups=[]),-1===e.indexOf(t)&&e.push(t)}else if("text"===e){let e=this._subtitleGroups;e||(e=this._subtitleGroups=[]),-1===e.indexOf(t)&&e.push(t)}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return null==(e=this.audioGroups)?void 0:e[0]}get textGroupId(){var e;return null==(e=this.subtitleGroups)?void 0:e[0]}addFallback(){}constructor(e){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(e=>!!e).map(e=>e.substring(0,4)).join(","),this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}}function wt(e,t){return!(!t||!e)&&-1!==e.indexOf(t)}function Ut(e,t){const n=t.startPTS;if(p(n)){let i,r=0;t.sn>e.sn?(r=n-e.start,i=e):(r=e.start-n,i=t),i.duration!==r&&(i.duration=r)}else t.sn>e.sn?e.cc===t.cc&&e.minEndPTS?t.start=e.start+(e.minEndPTS-e.start):t.start=e.start+e.duration:t.start=Math.max(e.start-t.duration,0)}function Bt(e,t,n,i,r,s){i-n<=0&&(I.warn("Fragment should have a positive duration",t),i=n+t.duration,s=r+t.duration);let a=n,o=i;const l=t.startPTS,c=t.endPTS;if(p(l)){const e=Math.abs(l-n);p(t.deltaPTS)?t.deltaPTS=Math.max(e,t.deltaPTS):t.deltaPTS=e,a=Math.max(n,l),n=Math.min(n,l),r=Math.min(r,t.startDTS),o=Math.min(i,c),i=Math.max(i,c),s=Math.max(s,t.endDTS)}const d=n-t.start;0!==t.start&&(t.start=n),t.duration=i-t.start,t.startPTS=n,t.maxStartPTS=a,t.startDTS=r,t.endPTS=i,t.minEndPTS=o,t.endDTS=s;const h=t.sn;if(!e||h<e.startSN||h>e.endSN)return 0;let u;const f=h-e.startSN,m=e.fragments;for(m[f]=t,u=f;u>0;u--)Ut(m[u],m[u-1]);for(u=f;u<m.length-1;u++)Ut(m[u],m[u+1]);return e.fragmentHint&&Ut(m[m.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,d}function kt(e,t){const n=t.startSN+t.skippedSegments-e.startSN,i=e.fragments;n<0||n>=i.length||Vt(t,i[n].start)}function Vt(e,t){if(t){const n=e.fragments;for(let i=e.skippedSegments;i<n.length;i++)n[i].start+=t;e.fragmentHint&&(e.fragmentHint.start+=t)}}function Gt(e,t,n){var i;return null!=e&&e.details?Ht(null==(i=e.details)?void 0:i.partList,t,n):null}function Ht(e,t,n){if(e)for(let i=e.length;i--;){const r=e[i];if(r.index===n&&r.fragment.sn===t)return r}return null}function Wt(e){e.forEach((e,t)=>{const{details:n}=e;null!=n&&n.fragments&&n.fragments.forEach(e=>{e.level=t})})}function Xt(e){switch(e.details){case T.FRAG_LOAD_TIMEOUT:case T.KEY_LOAD_TIMEOUT:case T.LEVEL_LOAD_TIMEOUT:case T.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function jt(e,t){const n=Xt(t);return e.default[(n?"timeout":"error")+"Retry"]}function zt(e,t){const n="linear"===e.backoff?1:Math.pow(2,t);return Math.min(n*e.retryDelayMs,e.maxRetryDelayMs)}function Kt(e){return u(u({},e),{errorRetry:null,timeoutRetry:null})}function Yt(e,t,n,i){if(!e)return!1;const r=null==i?void 0:i.code,s=t<e.maxNumRetry&&(function(e){return 0===e&&!1===navigator.onLine||!!e&&(e<400||e>499)}(r)||!!n);return e.shouldRetry?e.shouldRetry(e,t,n,i,s):s}const qt=function(e,t){let n=0,i=e.length-1,r=null,s=null;for(;n<=i;){r=(n+i)/2|0,s=e[r];const a=t(s);if(a>0)n=r+1;else{if(!(a<0))return s;i=r-1}}return null};function Qt(e,t,n=0,i=0,r=.005){let s=null;if(e){s=t[e.sn-t[0].sn+1]||null;const i=e.endDTS-n;i>0&&i<15e-7&&(n+=15e-7)}else 0===n&&0===t[0].start&&(s=t[0]);if(s&&((!e||e.level===s.level)&&0===Zt(n,i,s)||function(e,t,n){if(t&&0===t.start&&t.level<e.level&&(t.endPTS||0)>0){const i=t.tagList.reduce((e,t)=>("INF"===t[0]&&(e+=parseFloat(t[1])),e),n);return e.start<=i}return!1}(s,e,Math.min(r,i))))return s;const a=qt(t,Zt.bind(null,n,i));return!a||a===e&&s?s:a}function Zt(e=0,t=0,n){if(n.start<=e&&n.start+n.duration>e)return 0;const i=Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0));return n.start+n.duration-i<=e?1:n.start-i>e&&n.start?-1:0}function $t(e,t,n){const i=1e3*Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0));return(n.endProgramDateTime||0)-i>e}var Jt={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},en={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class tn{registerListeners(){const e=this.hls;e.on(v.ERROR,this.onError,this),e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(v.ERROR,this.onError,this),e.off(v.ERROR,this.onErrorOut,this),e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(null==e?void 0:e.type)===mt.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var n,i;if(t.fatal)return;const r=this.hls,s=t.context;switch(t.details){case T.FRAG_LOAD_ERROR:case T.FRAG_LOAD_TIMEOUT:case T.KEY_LOAD_ERROR:case T.KEY_LOAD_TIMEOUT:return void(t.errorAction=this.getFragRetryOrSwitchAction(t));case T.FRAG_PARSING_ERROR:if(null!=(n=t.frag)&&n.gap)return void(t.errorAction={action:Jt.DoNothing,flags:en.None});case T.FRAG_GAP:case T.FRAG_DECRYPT_ERROR:return t.errorAction=this.getFragRetryOrSwitchAction(t),void(t.errorAction.action=Jt.SendAlternateToPenaltyBox);case T.LEVEL_EMPTY_ERROR:case T.LEVEL_PARSING_ERROR:{var a,o;const e=t.parent===mt.MAIN?t.level:r.loadLevel;t.details===T.LEVEL_EMPTY_ERROR&&null!=(a=t.context)&&null!=(o=a.levelDetails)&&o.live?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,e):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e))}return;case T.LEVEL_LOAD_ERROR:case T.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==s?void 0:s.level)&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.level)));case T.AUDIO_TRACK_LOAD_ERROR:case T.AUDIO_TRACK_LOAD_TIMEOUT:case T.SUBTITLE_LOAD_ERROR:case T.SUBTITLE_TRACK_LOAD_TIMEOUT:if(s){const e=r.levels[r.loadLevel];if(e&&("audioTrack"===s.type&&e.hasAudioGroup(s.groupId)||"subtitleTrack"===s.type&&e.hasSubtitleGroup(s.groupId)))return t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.loadLevel),t.errorAction.action=Jt.SendAlternateToPenaltyBox,void(t.errorAction.flags=en.MoveAllAlternatesMatchingHost)}return;case T.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const e=r.levels[r.loadLevel],n=null==e?void 0:e.attrs["HDCP-LEVEL"];n?t.errorAction={action:Jt.SendAlternateToPenaltyBox,flags:en.MoveAllAlternatesMatchingHDCP,hdcpLevel:n}:this.keySystemError(t)}return;case T.BUFFER_ADD_CODEC_ERROR:case T.REMUX_ALLOC_ERROR:case T.BUFFER_APPEND_ERROR:return void(t.errorAction=this.getLevelSwitchAction(t,null!=(i=t.level)?i:r.loadLevel));case T.INTERNAL_EXCEPTION:case T.BUFFER_APPENDING_ERROR:case T.BUFFER_FULL_ERROR:case T.LEVEL_SWITCH_ERROR:case T.BUFFER_STALLED_ERROR:case T.BUFFER_SEEK_OVER_HOLE:case T.BUFFER_NUDGE_ON_STALL:return void(t.errorAction={action:Jt.DoNothing,flags:en.None})}t.type===E.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const n=jt(this.hls.config.playlistLoadPolicy,e),i=this.playlistError++;if(Yt(n,i,Xt(e),e.response))return{action:Jt.RetryRequest,flags:en.None,retryConfig:n,retryCount:i};const r=this.getLevelSwitchAction(e,t);return n&&(r.retryConfig=n,r.retryCount=i),r}getFragRetryOrSwitchAction(e){const t=this.hls,n=this.getVariantLevelIndex(e.frag),i=t.levels[n],{fragLoadPolicy:r,keyLoadPolicy:s}=t.config,a=jt(e.details.startsWith("key")?s:r,e),o=t.levels.reduce((e,t)=>e+t.fragmentError,0);if(i&&(e.details!==T.FRAG_GAP&&i.fragmentError++,Yt(a,o,Xt(e),e.response)))return{action:Jt.RetryRequest,flags:en.None,retryConfig:a,retryCount:o};const l=this.getLevelSwitchAction(e,n);return a&&(l.retryConfig=a,l.retryCount=o),l}getLevelSwitchAction(e,t){const n=this.hls;null==t&&(t=n.loadLevel);const i=this.hls.levels[t];if(i){var r,s;const t=e.details;i.loadError++,t===T.BUFFER_APPEND_ERROR&&i.fragmentError++;let l=-1;const{levels:c,loadLevel:d,minAutoLevel:h,maxAutoLevel:u}=n;n.autoLevelEnabled||(n.loadLevel=-1);const f=null==(r=e.frag)?void 0:r.type,m=(f===mt.AUDIO&&t===T.FRAG_PARSING_ERROR||"audio"===e.sourceBufferName&&(t===T.BUFFER_ADD_CODEC_ERROR||t===T.BUFFER_APPEND_ERROR))&&c.some(({audioCodec:e})=>i.audioCodec!==e),p="video"===e.sourceBufferName&&(t===T.BUFFER_ADD_CODEC_ERROR||t===T.BUFFER_APPEND_ERROR)&&c.some(({codecSet:e,audioCodec:t})=>i.codecSet!==e&&i.audioCodec===t),{type:g,groupId:_}=null!=(s=e.context)?s:{};for(let n=c.length;n--;){const r=(n+d)%c.length;if(r!==d&&r>=h&&r<=u&&0===c[r].loadError){var a,o;const n=c[r];if(t===T.FRAG_GAP&&f===mt.MAIN&&e.frag){const t=c[r].details;if(t){const n=Qt(e.frag,t.fragments,e.frag.start);if(null!=n&&n.gap)continue}}else{if("audioTrack"===g&&n.hasAudioGroup(_)||"subtitleTrack"===g&&n.hasSubtitleGroup(_))continue;if(f===mt.AUDIO&&null!=(a=i.audioGroups)&&a.some(e=>n.hasAudioGroup(e))||f===mt.SUBTITLE&&null!=(o=i.subtitleGroups)&&o.some(e=>n.hasSubtitleGroup(e))||m&&i.audioCodec===n.audioCodec||!m&&i.audioCodec!==n.audioCodec||p&&i.codecSet===n.codecSet)continue}l=r;break}}if(l>-1&&n.loadLevel!==l)return e.levelRetry=!0,this.playlistError=0,{action:Jt.SendAlternateToPenaltyBox,flags:en.None,nextAutoLevel:l}}return{action:Jt.SendAlternateToPenaltyBox,flags:en.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var n;switch(null==(n=t.errorAction)?void 0:n.action){case Jt.DoNothing:break;case Jt.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),t.errorAction.resolved||t.details===T.FRAG_GAP?/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):t.fatal=!0;break;case Jt.RetryRequest:}t.fatal&&this.hls.stopLoad()}sendAlternateToPenaltyBox(e){const t=this.hls,n=e.errorAction;if(!n)return;const{flags:i,hdcpLevel:r,nextAutoLevel:s}=n;switch(i){case en.None:this.switchLevel(e,s);break;case en.MoveAllAlternatesMatchingHDCP:r&&(t.maxHdcpLevel=xt[xt.indexOf(r)-1],n.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`)}n.resolved||this.switchLevel(e,s)}switchLevel(e,t){void 0!==t&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}constructor(e){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=e,this.log=I.log.bind(I,"[info]:"),this.warn=I.warn.bind(I,"[warning]:"),this.error=I.error.bind(I,"[error]:"),this.registerListeners()}}class nn{destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,n){const i=null==t?void 0:t.renditionReports;if(i){let r=-1;for(let n=0;n<i.length;n++){const s=i[n];let a;try{a=new self.URL(s.URI,t.url).href}catch(e){I.warn("Could not construct new URL for Rendition Report: "+e),a=s.URI||""}if(a===e){r=n;break}a===e.substring(0,a.length)&&(r=n)}if(-1!==r){const e=i[r],s=parseInt(e["LAST-MSN"])||(null==t?void 0:t.lastPartSn);let a=parseInt(e["LAST-PART"])||(null==t?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const e=Math.min(t.age-t.partTarget,t.targetduration);a>=0&&e>t.partTarget&&(a+=1)}const o=n&&Lt(n);return new Nt(s,a>=0?a:void 0,o)}}}loadPlaylist(e){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}shouldReloadPlaylist(e){return-1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(e)}playlistLoaded(e,t,n){const{details:i,stats:r}=t,s=self.performance.now(),a=r.loading.first?Math.max(0,s-r.loading.first):0;if(i.advancedDateTime=Date.now()-a,i.live||null!=n&&n.live){if(i.reloaded(n),n&&this.log(`live playlist ${e} ${i.advanced?"REFRESHED "+i.lastPartSn+"-"+i.lastPartIndex:i.updated?"UPDATED":"MISSED"}`),n&&i.fragments.length>0&&function(e,t){let n=null;const i=e.fragments;for(let e=i.length-1;e>=0;e--){const t=i[e].initSegment;if(t){n=t;break}}let r;e.fragmentHint&&delete e.fragmentHint.endPTS,function(e,t,n){const i=t.skippedSegments,r=Math.max(e.startSN,t.startSN)-t.startSN,s=(e.fragmentHint?1:0)+(i?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,a=t.startSN-e.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;for(let e=r;e<=s;e++){const r=l[a+e];let s=o[e];i&&!s&&e<i&&(s=t.fragments[e]=r),r&&s&&n(r,s,e,o)}}(e,t,(e,i,s,a)=>{if(t.skippedSegments&&i.cc!==e.cc){const t=e.cc-i.cc;for(let e=s;e<a.length;e++)a[e].cc+=t}p(e.startPTS)&&p(e.endPTS)&&(i.start=i.startPTS=e.startPTS,i.startDTS=e.startDTS,i.maxStartPTS=e.maxStartPTS,i.endPTS=e.endPTS,i.endDTS=e.endDTS,i.minEndPTS=e.minEndPTS,i.duration=e.endPTS-e.startPTS,i.duration&&(r=i),t.PTSKnown=t.alignedSliding=!0),i.elementaryStreams=e.elementaryStreams,i.loader=e.loader,i.stats=e.stats,e.initSegment&&(i.initSegment=e.initSegment,n=e.initSegment)});const s=t.fragments;if(n&&(t.fragmentHint?s.concat(t.fragmentHint):s).forEach(e=>{var t;!e||e.initSegment&&e.initSegment.relurl!==(null==(t=n)?void 0:t.relurl)||(e.initSegment=n)}),t.skippedSegments){if(t.deltaUpdateFailed=s.some(e=>!e),t.deltaUpdateFailed){I.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let e=t.skippedSegments;e--;)s.shift();t.startSN=s[0].sn}else t.canSkipDateRanges&&(t.dateRanges=function(e,t,n){const i=m({},e);return n&&n.forEach(e=>{delete i[e]}),Object.keys(t).forEach(e=>{const n=new O(t[e].attr,i[e]);n.isValid?i[e]=n:I.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(t[e].attr)}"`)}),i}(e.dateRanges,t.dateRanges,t.recentlyRemovedDateranges));t.startCC=t.fragments[0].cc,t.endCC=s[s.length-1].cc}!function(e,t,n){if(e&&t){let i=0;for(let r=0,s=e.length;r<=s;r++){const s=e[r],a=t[r+i];s&&a&&s.index===a.index&&s.fragment.sn===a.fragment.sn?n(s,a):i--}}}(e.partList,t.partList,(e,t)=>{t.elementaryStreams=e.elementaryStreams,t.stats=e.stats}),r?Bt(t,r,r.startPTS,r.endPTS,r.startDTS,r.endDTS):kt(e,t),s.length&&(t.totalduration=t.edge-s[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;const a=t.advancedDateTime;if(t.advanced&&a){const e=t.edge;t.driftStart||(t.driftStartTime=a,t.driftStart=e),t.driftEndTime=a,t.driftEnd=e}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime}(n,i),!this.canLoad||!i.live)return;let a,o=void 0,l=void 0;if(i.canBlockReload&&i.endSN&&i.advanced){const e=this.hls.config.lowLatencyMode,r=i.lastPartSn,s=i.endSN,c=i.lastPartIndex,d=r===s,h=e?0:c;-1!==c?(o=d?s+1:r,l=d?h:c+1):o=s+1;const u=i.age,f=u+i.ageHeader;let m=Math.min(f-i.partTarget,1.5*i.targetduration);if(m>0){if(n&&m>n.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${n.tuneInGoal} to: ${m} with playlist age: ${i.age}`),m=0;else{const e=Math.floor(m/i.targetduration);o+=e,void 0!==l&&(l+=Math.round(m%i.targetduration/i.partTarget)),this.log(`CDN Tune-in age: ${i.ageHeader}s last advanced ${u.toFixed(2)}s goal: ${m} skip sn ${e} to part ${l}`)}i.tuneInGoal=m}if(a=this.getDeliveryDirectives(i,t.deliveryDirectives,o,l),e||!d)return void this.loadPlaylist(a)}else(i.canBlockReload||i.canSkipUntil)&&(a=this.getDeliveryDirectives(i,t.deliveryDirectives,o,l));const c=this.hls.mainForwardBufferInfo,d=c?c.end-c.len:0,h=function(e,t=1/0){let n=1e3*e.targetduration;if(e.updated){const i=e.fragments,r=4;if(i.length&&n*r>t){const e=1e3*i[i.length-1].duration;e<n&&(n=e)}}else n/=2;return Math.round(n)}(i,1e3*(i.edge-d));i.updated&&s>this.requestScheduled+h&&(this.requestScheduled=r.loading.start),void 0!==o&&i.canBlockReload?this.requestScheduled=r.loading.first+h-(1e3*i.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+h<s?this.requestScheduled=s:this.requestScheduled-s<=0&&(this.requestScheduled+=h);let u=this.requestScheduled-s;u=Math.max(0,u),this.log(`reload live playlist ${e} in ${Math.round(u)} ms`),this.timer=self.setTimeout(()=>this.loadPlaylist(a),u)}else this.clearTimer()}getDeliveryDirectives(e,t,n,i){let r=Lt(e);return null!=t&&t.skip&&e.deltaUpdateFailed&&(n=t.msn,i=t.part,r=Pt.No),new Nt(n,i,r)}checkRetry(e){const t=e.details,n=Xt(e),i=e.errorAction,{action:r,retryCount:s=0,retryConfig:a}=i||{},o=!!i&&!!a&&(r===Jt.RetryRequest||!i.resolved&&r===Jt.SendAlternateToPenaltyBox);if(o){var l;if(this.requestScheduled=-1,s>=a.maxNumRetry)return!1;if(n&&null!=(l=e.context)&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${s+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const e=zt(a,s);this.timer=self.setTimeout(()=>this.loadPlaylist(),e),this.warn(`Retrying playlist loading ${s+1}/${a.maxNumRetry} after "${t}" in ${e}ms`)}e.levelRetry=!0,i.resolved=!0}return o}constructor(e,t){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=I.log.bind(I,t+":"),this.warn=I.warn.bind(I,t+":"),this.hls=e}}class rn{sample(e,t){const n=Math.pow(this.alpha_,e);this.estimate_=t*(1-n)+n*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}constructor(e,t=0,n=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=n}}class sn{update(e,t){const{slow_:n,fast_:i,ttfb_:r}=this;n.halfLife!==e&&(this.slow_=new rn(e,n.getEstimate(),n.getTotalWeight())),i.halfLife!==t&&(this.fast_=new rn(t,i.getEstimate(),i.getTotalWeight())),r.halfLife!==e&&(this.ttfb_=new rn(e,r.getEstimate(),r.getTotalWeight()))}sample(e,t){const n=(e=Math.max(e,this.minDelayMs_))/1e3,i=8*t/n;this.fast_.sample(n,i),this.slow_.sample(n,i)}sampleTTFB(e){const t=e/1e3,n=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(n,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}constructor(e,t,n,i=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=n,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new rn(e),this.fast_=new rn(t),this.defaultTTFB_=i,this.ttfb_=new rn(e)}}const an={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},on={};function ln(e,t,n,i,r,s){const a=e.audioCodec?e.audioGroups:null,o=null==s?void 0:s.audioCodec,l=null==s?void 0:s.channels,c=l?parseInt(l):o?1/0:2;let d=null;if(null!=a&&a.length)try{d=1===a.length&&a[0]?t.groups[a[0]].channels:a.reduce((e,n)=>{if(n){const i=t.groups[n];if(!i)throw new Error(`Audio track group ${n} not found`);Object.keys(i.channels).forEach(t=>{e[t]=(e[t]||0)+i.channels[t]})}return e},{2:0})}catch(e){return!0}return void 0!==e.videoCodec&&(e.width>1920&&e.height>1088||e.height>1920&&e.width>1088||e.frameRate>Math.max(i,30)||"SDR"!==e.videoRange&&e.videoRange!==n||e.bitrate>Math.max(r,8e6))||!!d&&p(c)&&Object.keys(d).some(e=>parseInt(e)>c)}function cn(e,t,n){const i=e.videoCodec,r=e.audioCodec;if(!i||!r||!n)return Promise.resolve(an);const s={width:e.width,height:e.height,bitrate:Math.ceil(Math.max(.9*e.bitrate,e.averageBitrate)),framerate:e.frameRate||30},a=e.videoRange;"SDR"!==a&&(s.transferFunction=a.toLowerCase());const o=i.split(",").map(e=>({type:"media-source",video:u(u({},s),{},{contentType:Ye(e,"video")})}));return r&&e.audioGroups&&e.audioGroups.forEach(e=>{var n;e&&(null==(n=t.groups[e])||n.tracks.forEach(t=>{if(t.groupId===e){const e=t.channels||"",n=parseFloat(e);p(n)&&n>2&&o.push.apply(o,r.split(",").map(e=>({type:"media-source",audio:{contentType:Ye(e,"audio"),channels:""+n}})))}}))}),Promise.all(o.map(e=>{const t=function(e){const{audio:t,video:n}=e,i=n||t;if(i){const e=i.contentType.split('"')[1];if(n)return`r${n.height}x${n.width}f${Math.ceil(n.framerate)}${n.transferFunction||"sd"}_${e}_${Math.ceil(n.bitrate/1e5)}`;if(t)return`c${t.channels}${t.spatialRendering?"s":"n"}_${e}`}return""}(e);return on[t]||(on[t]=n.decodingInfo(e))})).then(e=>({supported:!e.some(e=>!e.supported),configurations:o,decodingInfoResults:e})).catch(e=>({supported:!1,configurations:o,decodingInfoResults:[],error:e}))}function dn(e,t){I.log(`[abr] start candidates with "${e}" ignored because ${t}`)}function hn(e,t,n){if("attrs"in e){const n=t.indexOf(e);if(-1!==n)return n}for(let i=0;i<t.length;i++)if(un(e,t[i],n))return i;return-1}function un(e,t,n){const{groupId:i,name:r,lang:s,assocLang:a,default:o}=e,l=e.forced;return(void 0===i||t.groupId===i)&&(void 0===r||t.name===r)&&(void 0===s||t.lang===s)&&(void 0===s||t.assocLang===a)&&(void 0===o||t.default===o)&&(void 0===l||t.forced===l)&&(!("characteristics"in e)||function(e,t=""){const n=e.split(","),i=t.split(",");return n.length===i.length&&!n.some(e=>-1===i.indexOf(e))}(e.characteristics||"",t.characteristics))&&(void 0===n||n(e,t))}function fn(e,t){const{audioCodec:n,channels:i}=e;return!(void 0!==n&&(t.audioCodec||"").substring(0,4)!==n.substring(0,4)||void 0!==i&&i!==(t.channels||"2"))}function mn(e,t,n){for(let i=t;i>-1;i--)if(n(e[i]))return i;for(let i=t+1;i<e.length;i++)if(n(e[i]))return i;return-1}class pn{resetEstimator(e){e&&(I.log("setting initial bwe to "+e),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new sn(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.FRAG_LOADING,this.onFragLoading,this),e.on(v.FRAG_LOADED,this.onFragLoaded,this),e.on(v.FRAG_BUFFERED,this.onFragBuffered,this),e.on(v.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(v.LEVEL_LOADED,this.onLevelLoaded,this),e.on(v.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(v.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(v.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.FRAG_LOADING,this.onFragLoading,this),e.off(v.FRAG_LOADED,this.onFragLoaded,this),e.off(v.FRAG_BUFFERED,this.onFragBuffered,this),e.off(v.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(v.LEVEL_LOADED,this.onLevelLoaded,this),e.off(v.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(v.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(v.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const n=t.frag;var i;this.ignoreFragment(n)||(n.bitrateTest||(this.fragCurrent=n,this.partCurrent=null!=(i=t.part)?i:null),this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100))}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case T.BUFFER_ADD_CODEC_ERROR:case T.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case T.FRAG_LOAD_TIMEOUT:{const e=t.frag,{fragCurrent:n,partCurrent:i}=this;if(e&&n&&e.sn===n.sn&&e.level===n.level){const t=performance.now(),n=i?i.stats:e.stats,r=t-n.loading.start,s=n.loading.first?n.loading.first-n.loading.start:-1;if(n.loaded&&s>-1){const e=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(r-Math.min(e,s),n.loaded)}else this.bwEstimator.sampleTTFB(r)}break}}}getTimeToLoadFrag(e,t,n,i){return e+n/t+(i?this.lastLevelLoadSec:0)}onLevelLoaded(e,t){const n=this.hls.config,{loading:i}=t.stats,r=i.end-i.start;p(r)&&(this.lastLevelLoadSec=r/1e3),t.details.live?this.bwEstimator.update(n.abrEwmaSlowLive,n.abrEwmaFastLive):this.bwEstimator.update(n.abrEwmaSlowVoD,n.abrEwmaFastVoD)}onFragLoaded(e,{frag:t,part:n}){const i=n?n.stats:t.stats;if(t.type===mt.MAIN&&this.bwEstimator.sampleTTFB(i.loading.first-i.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const e=n?n.duration:t.duration,r=this.hls.levels[t.level],s=(r.loaded?r.loaded.bytes:0)+i.loaded,a=(r.loaded?r.loaded.duration:0)+e;r.loaded={bytes:s,duration:a},r.realBitrate=Math.round(8*s/a)}if(t.bitrateTest){const e={stats:i,frag:t,part:n,id:t.type};this.onFragBuffered(v.FRAG_BUFFERED,e),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:n,part:i}=t,r=null!=i&&i.stats.loaded?i.stats:n.stats;if(r.aborted)return;if(this.ignoreFragment(n))return;const s=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(s,r.loaded),r.bwEstimate=this.getBwEstimate(),n.bitrateTest?this.bitrateTestDelay=s/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==mt.MAIN||"initSegment"===e.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,n=this.getBwEstimate(),i=this.hls.config.maxStarvationDelay,r=this.findBestLevel(n,t,e,0,i,1,1);if(r>-1)return r;const s=this.hls.firstLevel,a=Math.min(Math.max(s,t),e);return I.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${s} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,t=this.bwEstimator.canEstimate(),n=this.lastLoadedFragLevel>-1;if(!(-1===e||t&&n&&this.nextAutoLevelKey!==this.getAutoLevelKey()))return e;const i=t&&n?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==e){const t=this.hls.levels;if(t.length>Math.max(e,i)&&t[e].loadError<=t[i].loadError)return e}return this._nextAutoLevel=i,this.nextAutoLevelKey=this.getAutoLevelKey(),i}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:n}=this,{maxAutoLevel:i,config:r,minAutoLevel:s}=n,a=t?t.duration:e?e.duration:0,o=this.getBwEstimate(),l=this.getStarvationDelay();let c=r.abrBandWidthFactor,d=r.abrBandWidthUpFactor;if(l){const e=this.findBestLevel(o,s,i,l,0,c,d);if(e>=0)return e}let h=a?Math.min(a,r.maxStarvationDelay):r.maxStarvationDelay;if(!l){const e=this.bitrateTestDelay;e&&(h=(a?Math.min(a,r.maxLoadingDelay):r.maxLoadingDelay)-e,I.info(`[abr] bitrate test took ${Math.round(1e3*e)}ms, set first fragment max fetchDuration to ${Math.round(1e3*h)} ms`),c=d=1)}const u=this.findBestLevel(o,s,i,l,h,c,d);if(I.info(`[abr] ${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${u}`),u>-1)return u;const f=n.levels[s],m=n.levels[n.loadLevel];return(null==f?void 0:f.bitrate)<(null==m?void 0:m.bitrate)?s:n.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const n=t&&0!==t.playbackRate?Math.abs(t.playbackRate):1,i=e.mainForwardBufferInfo;return(i?i.len:0)/n}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,n,i,r,s,a){var o;const l=i+r,c=this.lastLoadedFragLevel,d=-1===c?this.hls.firstLevel:c,{fragCurrent:h,partCurrent:u}=this,{levels:f,allAudioTracks:m,loadLevel:g,config:_}=this.hls;if(1===f.length)return 0;const v=f[d],E=!(null==v||null==(o=v.details)||!o.live),T=-1===g||-1===c;let S,A="SDR",b=(null==v?void 0:v.frameRate)||0;const{audioPreference:R,videoPreference:C}=_,y=this.audioTracksByGroup||(this.audioTracksByGroup=function(e){return e.reduce((e,t)=>{let n=e.groups[t.groupId];n||(n=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),n.tracks.push(t);const i=t.channels||"2";return n.channels[i]=(n.channels[i]||0)+1,n.hasDefault=n.hasDefault||t.default,n.hasAutoSelect=n.hasAutoSelect||t.autoselect,n.hasDefault&&(e.hasDefaultAudio=!0),n.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}(m));if(T){if(-1!==this.firstSelection)return this.firstSelection;const i=function(e,t,n,i,r){const s=Object.keys(e),a=null==i?void 0:i.channels,o=null==i?void 0:i.audioCodec,l=a&&2===parseInt(a);let c=!0,d=!1,h=1/0,u=1/0,f=1/0,m=0,g=[];const{preferHDR:_,allowedVideoRanges:v}=function(e,t){let n=!1,i=[];return e&&(n="SDR"!==e,i=[e]),t&&(i=t.allowedVideoRanges||Dt.slice(0),n=void 0!==t.preferHDR?t.preferHDR:function(){if("function"==typeof matchMedia){const e=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(e.media!==t.media)return!0===e.matches}return!1}(),i=n?i.filter(e=>"SDR"!==e):["SDR"]),{preferHDR:n,allowedVideoRanges:i}}(t,r);for(let t=s.length;t--;){const n=e[s[t]];c=n.channels[2]>0,h=Math.min(h,n.minHeight),u=Math.min(u,n.minFramerate),f=Math.min(f,n.minBitrate);const i=v.filter(e=>n.videoRanges[e]>0);i.length>0&&(d=!0,g=i)}h=p(h)?h:0,u=p(u)?u:0;const E=Math.max(1080,h),T=Math.max(30,u);return f=p(f)?f:n,n=Math.max(f,n),d||(t=void 0,g=[]),{codecSet:s.reduce((t,i)=>{const r=e[i];if(i===t)return t;if(r.minBitrate>n)return dn(i,`min bitrate of ${r.minBitrate} > current estimate of ${n}`),t;if(!r.hasDefaultAudio)return dn(i,"no renditions with default or auto-select sound found"),t;if(o&&i.indexOf(o.substring(0,4))%5!=0)return dn(i,`audio codec preference "${o}" not found`),t;if(a&&!l){if(!r.channels[a])return dn(i,`no renditions with ${a} channel sound found (channels options: ${Object.keys(r.channels)})`),t}else if((!o||l)&&c&&0===r.channels[2])return dn(i,"no renditions with stereo sound found"),t;return r.minHeight>E?(dn(i,`min resolution of ${r.minHeight} > maximum of ${E}`),t):r.minFramerate>T?(dn(i,`min framerate of ${r.minFramerate} > maximum of ${T}`),t):g.some(e=>r.videoRanges[e]>0)?r.maxScore<m?(dn(i,`max score of ${r.maxScore} < selected max of ${m}`),t):t&&(Qe(i)>=Qe(t)||r.fragmentError>e[t].fragmentError)?t:(m=r.maxScore,i):(dn(i,`no variants with VIDEO-RANGE of ${JSON.stringify(g)} found`),t)},void 0),videoRanges:g,preferHDR:_,minFramerate:u,minBitrate:f}}(this.codecTiers||(this.codecTiers=function(e,t,n,i){return e.slice(n,i+1).reduce((e,n)=>{if(!n.codecSet)return e;const i=n.audioGroups;let r=e[n.codecSet];r||(e[n.codecSet]=r={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!i,fragmentError:0}),r.minBitrate=Math.min(r.minBitrate,n.bitrate);const s=Math.min(n.height,n.width);return r.minHeight=Math.min(r.minHeight,s),r.minFramerate=Math.min(r.minFramerate,n.frameRate),r.maxScore=Math.max(r.maxScore,n.score),r.fragmentError+=n.fragmentError,r.videoRanges[n.videoRange]=(r.videoRanges[n.videoRange]||0)+1,i&&i.forEach(e=>{if(!e)return;const n=t.groups[e];n&&(r.hasDefaultAudio=r.hasDefaultAudio||t.hasDefaultAudio?n.hasDefault:n.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(n.channels).forEach(e=>{r.channels[e]=(r.channels[e]||0)+n.channels[e]}))}),e},{})}(f,y,t,n)),A,e,R,C),{codecSet:r,videoRanges:s,minFramerate:a,minBitrate:o,preferHDR:l}=i;S=r,A=l?s[s.length-1]:s[0],b=a,e=Math.max(e,o),I.log("[abr] picked start tier "+JSON.stringify(i))}else S=null==v?void 0:v.codecSet,A=null==v?void 0:v.videoRange;const M=u?u.duration:h?h.duration:0,O=this.bwEstimator.getEstimateTTFB()/1e3,x=[];for(let o=n;o>=t;o--){var D;const t=f[o],h=o>d;if(!t)continue;if(_.useMediaCapabilities&&!t.supportedResult&&!t.supportedPromise){const n=navigator.mediaCapabilities;"function"==typeof(null==n?void 0:n.decodingInfo)&&ln(t,y,A,b,e,R)?(t.supportedPromise=cn(t,y,n),t.supportedPromise.then(e=>{if(!this.hls)return;t.supportedResult=e;const n=this.hls.levels,i=n.indexOf(t);e.error?I.warn(`[abr] MediaCapabilities decodingInfo error: "${e.error}" for level ${i} ${JSON.stringify(e)}`):e.supported||(I.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${i} ${JSON.stringify(e)}`),i>-1&&n.length>1&&(I.log("[abr] Removing unsupported level "+i),this.hls.removeLevel(i)))})):t.supportedResult=an}if(S&&t.codecSet!==S||A&&t.videoRange!==A||h&&b>t.frameRate||!h&&b>0&&b<t.frameRate||t.supportedResult&&(null==(D=t.supportedResult.decodingInfoResults)||!D[0].smooth)){x.push(o);continue}const m=t.details,C=(u?null==m?void 0:m.partTarget:null==m?void 0:m.averagetargetduration)||M;let P;P=h?a*e:s*e;const L=M&&i>=2*M&&0===r?f[o].averageBitrate:f[o].maxBitrate,N=this.getTimeToLoadFrag(O,P,L*C,void 0===m);if(P>=L&&(o===c||0===t.loadError&&0===t.fragmentError)&&(N<=O||!p(N)||E&&!this.bitrateTestDelay||N<l)){const e=this.forcedAutoLevel;return o===g||-1!==e&&e===g||(x.length&&I.trace(`[abr] Skipped level(s) ${x.join(",")} of ${n} max with CODECS and VIDEO-RANGE:"${f[x[0]].codecs}" ${f[x[0]].videoRange}; not compatible with "${v.codecs}" ${A}`),I.info(`[abr] switch candidate:${d}->${o} adjustedbw(${Math.round(P)})-bitrate=${Math.round(P-L)} ttfb:${O.toFixed(1)} avgDuration:${C.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${N.toFixed(1)} firstSelection:${T} codecSet:${S} videoRange:${A} hls.loadLevel:${g}`)),T&&(this.firstSelection=o),o}}return-1}set nextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:n}=this.hls,i=Math.min(Math.max(e,n),t);this._nextAutoLevel!==i&&(this.nextAutoLevelKey="",this._nextAutoLevel=i)}constructor(e){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:e,partCurrent:t,hls:n}=this,{autoLevelEnabled:i,media:r}=n;if(!e||!r)return;const s=performance.now(),a=t?t.stats:e.stats,o=t?t.duration:e.duration,l=s-a.loading.start,c=n.minAutoLevel;if(a.aborted||a.loaded&&a.loaded===a.total||e.level<=c)return this.clearTimer(),void(this._nextAutoLevel=-1);if(!i||r.paused||!r.playbackRate||!r.readyState)return;const d=n.mainForwardBufferInfo;if(null===d)return;const h=this.bwEstimator.getEstimateTTFB(),u=Math.abs(r.playbackRate);if(l<=Math.max(h,o/(2*u)*1e3))return;const f=d.len/u,m=a.loading.first?a.loading.first-a.loading.start:-1,g=a.loaded&&m>-1,_=this.getBwEstimate(),E=n.levels,T=E[e.level],S=a.total||Math.max(a.loaded,Math.round(o*T.averageBitrate/8));let A=g?l-m:l;A<1&&g&&(A=Math.min(l,8*a.loaded/_));const b=g?1e3*a.loaded/A:0,R=b?(S-a.loaded)/b:8*S/_+h/1e3;if(R<=f)return;const C=b?8*b:_;let y,M=Number.POSITIVE_INFINITY;for(y=e.level-1;y>c;y--){const e=E[y].maxBitrate;if(M=this.getTimeToLoadFrag(h/1e3,C,o*e,!E[y].details),M<f)break}if(M>=R)return;if(M>10*o)return;n.nextLoadLevel=n.nextAutoLevel=y,g?this.bwEstimator.sample(l-Math.min(h,m),a.loaded):this.bwEstimator.sampleTTFB(l);const O=E[y].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>O&&this.resetEstimator(O),this.clearTimer(),I.warn(`[abr] Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} is loading too slowly;\n      Time to underbuffer: ${f.toFixed(3)} s\n      Estimated load time for current fragment: ${R.toFixed(3)} s\n      Estimated load time for down switch fragment: ${M.toFixed(3)} s\n      TTFB estimate: ${0|m} ms\n      Current BW estimate: ${p(_)?0|_:"Unknown"} bps\n      New BW estimate: ${0|this.getBwEstimate()} bps\n      Switching to level ${y} @ ${0|O} bps`),n.trigger(v.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:t,stats:a})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}}class gn{_registerListeners(){const{hls:e}=this;e.on(v.BUFFER_APPENDED,this.onBufferAppended,this),e.on(v.FRAG_BUFFERED,this.onFragBuffered,this),e.on(v.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(v.BUFFER_APPENDED,this.onBufferAppended,this),e.off(v.FRAG_BUFFERED,this.onFragBuffered,this),e.off(v.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const n=this.activePartLists[t];if(n)for(let t=n.length;t--;){const i=n[t];if(!i)break;const r=i.end;if(i.start<=e&&null!==r&&e<=r)return i}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){const{fragments:n}=this,i=Object.keys(n);for(let r=i.length;r--;){const s=n[i[r]];if((null==s?void 0:s.body.type)===t&&s.buffered){const t=s.body;if(t.start<=e&&e<=t.end)return t}}return null}detectEvictedFragments(e,t,n,i){this.timeRanges&&(this.timeRanges[e]=t);const r=(null==i?void 0:i.fragment.sn)||-1;Object.keys(this.fragments).forEach(i=>{const s=this.fragments[i];if(!s)return;if(r>=s.body.sn)return;if(!s.buffered&&!s.loaded)return void(s.body.type===n&&this.removeFragment(s.body));const a=s.range[e];a&&a.time.some(e=>{const n=!this.isTimeBuffered(e.startPTS,e.endPTS,t);return n&&this.removeFragment(s.body),n})})}detectPartialFragments(e){const t=this.timeRanges,{frag:n,part:i}=e;if(!t||"initSegment"===n.sn)return;const r=vn(n),s=this.fragments[r];if(!s||s.buffered&&n.gap)return;const a=!n.relurl;Object.keys(t).forEach(e=>{const r=n.elementaryStreams[e];if(!r)return;const o=t[e],l=a||!0===r.partial;s.range[e]=this.getBufferedTimes(n,i,l,o)}),s.loaded=null,Object.keys(s.range).length?(s.buffered=!0,(s.body.endList=n.endList||s.body.endList)&&(this.endListFragments[s.body.type]=s),_n(s)||this.removeParts(n.sn-1,n.type)):this.removeFragment(s.body)}removeParts(e,t){const n=this.activePartLists[t];n&&(this.activePartLists[t]=n.filter(t=>t.fragment.sn>=e))}fragBuffered(e,t){const n=vn(e);let i=this.fragments[n];!i&&t&&(i=this.fragments[n]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),i&&(i.loaded=null,i.buffered=!0)}getBufferedTimes(e,t,n,i){const r={time:[],partial:n},s=e.start,a=e.end,o=e.minEndPTS||a,l=e.maxStartPTS||s;for(let e=0;e<i.length;e++){const t=i.start(e)-this.bufferPadding,n=i.end(e)+this.bufferPadding;if(l>=t&&o<=n){r.time.push({startPTS:Math.max(s,i.start(e)),endPTS:Math.min(a,i.end(e))});break}if(s<n&&a>t){const t=Math.max(s,i.start(e)),n=Math.min(a,i.end(e));n>t&&(r.partial=!0,r.time.push({startPTS:t,endPTS:n}))}else if(a<=t)break}return r}getPartialFragment(e){let t,n,i,r=null,s=0;const{bufferPadding:a,fragments:o}=this;return Object.keys(o).forEach(l=>{const c=o[l];c&&_n(c)&&(n=c.body.start-a,i=c.body.end+a,e>=n&&e<=i&&(t=Math.min(e-n,i-e),s<=t&&(r=c.body,s=t)))}),r}isEndListAppended(e){const t=this.endListFragments[e];return void 0!==t&&(t.buffered||_n(t))}getState(e){const t=vn(e),n=this.fragments[t];return n?n.buffered?_n(n)?"PARTIAL":"OK":"APPENDING":"NOT_LOADED"}isTimeBuffered(e,t,n){let i,r;for(let s=0;s<n.length;s++){if(i=n.start(s)-this.bufferPadding,r=n.end(s)+this.bufferPadding,e>=i&&t<=r)return!0;if(t<=i)return!1}return!1}onFragLoaded(e,t){const{frag:n,part:i}=t;if("initSegment"===n.sn||n.bitrateTest)return;const r=i?null:t,s=vn(n);this.fragments[s]={body:n,appendedPTS:null,loaded:r,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:n,part:i,timeRanges:r}=t;if("initSegment"===n.sn)return;const s=n.type;if(i){let e=this.activePartLists[s];e||(this.activePartLists[s]=e=[]),e.push(i)}this.timeRanges=r,Object.keys(r).forEach(e=>{const t=r[e];this.detectEvictedFragments(e,t,s,i)})}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=vn(e);return!!this.fragments[t]}hasParts(e){var t;return!(null==(t=this.activePartLists[e])||!t.length)}removeFragmentsInRange(e,t,n,i,r){i&&!this.hasGaps||Object.keys(this.fragments).forEach(s=>{const a=this.fragments[s];if(!a)return;const o=a.body;o.type!==n||i&&!o.gap||o.start<t&&o.end>e&&(a.buffered||r)&&this.removeFragment(o)})}removeFragment(e){const t=vn(e);e.stats.loaded=0,e.clearElementaryStreamInfo();const n=this.activePartLists[e.type];if(n){const t=e.sn;this.activePartLists[e.type]=n.filter(e=>e.fragment.sn!==t)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}}function _n(e){var t,n,i;return e.buffered&&(e.body.gap||(null==(t=e.range.video)?void 0:t.partial)||(null==(n=e.range.audio)?void 0:n.partial)||(null==(i=e.range.audiovideo)?void 0:i.partial))}function vn(e){return`${e.type}_${e.level}_${e.sn}`}const En={length:0,start:()=>0,end:()=>0};class Tn{static isBuffered(e,t){try{if(e){const n=Tn.getBuffered(e);for(let e=0;e<n.length;e++)if(t>=n.start(e)&&t<=n.end(e))return!0}}catch(e){}return!1}static bufferInfo(e,t,n){try{if(e){const i=Tn.getBuffered(e),r=[];let s;for(s=0;s<i.length;s++)r.push({start:i.start(s),end:i.end(s)});return this.bufferedInfo(r,t,n)}}catch(e){}return{len:0,start:t,end:t,nextStart:void 0}}static bufferedInfo(e,t,n){t=Math.max(0,t),e.sort((function(e,t){return e.start-t.start||t.end-e.end}));let i=[];if(n)for(let t=0;t<e.length;t++){const r=i.length;if(r){const s=i[r-1].end;e[t].start-s<n?e[t].end>s&&(i[r-1].end=e[t].end):i.push(e[t])}else i.push(e[t])}else i=e;let r,s=0,a=t,o=t;for(let e=0;e<i.length;e++){const l=i[e].start,c=i[e].end;if(t+n>=l&&t<c)a=l,o=c,s=o-t;else if(t+n<l){r=l;break}}return{len:s,start:a||0,end:o||0,nextStart:r}}static getBuffered(e){try{return e.buffered}catch(e){return I.log("failed to get media.buffered",e),En}}}class Sn{constructor(e,t,n,i=0,r=-1,s=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=e,this.sn=t,this.id=n,this.size=i,this.part=r,this.partial=s}}function An(e,t){for(let i=0,r=e.length;i<r;i++){var n;if((null==(n=e[i])?void 0:n.cc)===t)return e[i]}return null}function bn(e,t){if(e){const n=e.start+t;e.start=e.startPTS=n,e.endPTS=n+e.duration}}function In(e,t){const n=t.fragments;for(let t=0,i=n.length;t<i;t++)bn(n[t],e);t.fragmentHint&&bn(t.fragmentHint,e),t.alignedSliding=!0}function Rn(e,t){if(!e.hasProgramDateTime||!t.hasProgramDateTime)return;const n=e.fragments,i=t.fragments;if(!n.length||!i.length)return;let r,s;const a=Math.min(t.endCC,e.endCC);t.startCC<a&&e.startCC<a&&(r=An(i,a),s=An(n,a)),r&&s||(r=i[Math.floor(i.length/2)],s=An(n,r.cc)||n[Math.floor(n.length/2)]);const o=r.programDateTime,l=s.programDateTime;o&&l&&In((l-o)/1e3-(s.start-r.start),e)}const Cn=Math.pow(2,17);class yn{destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const n=e.url;if(!n)return Promise.reject(new xn({type:E.NETWORK_ERROR,details:T.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error("Fragment does not have a "+(n?"part list":"url")),networkDetails:null}));this.abort();const i=this.config,r=i.fLoader,s=i.loader;return new Promise((a,o)=>{if(this.loader&&this.loader.destroy(),e.gap){if(e.tagList.some(e=>"GAP"===e[0]))return void o(On(e));e.gap=!1}const l=this.loader=e.loader=r?new r(i):new s(i),c=Mn(e),d=Kt(i.fragLoadPolicy.default),h={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===e.sn?1/0:Cn};e.stats=l.stats,l.load(c,h,{onSuccess:(t,n,i,r)=>{this.resetLoader(e,l);let s=t.data;i.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(s.slice(0,16)),s=s.slice(16)),a({frag:e,part:null,payload:s,networkDetails:r})},onError:(t,i,r,s)=>{this.resetLoader(e,l),o(new xn({type:E.NETWORK_ERROR,details:T.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:u({url:n,data:void 0},t),error:new Error(`HTTP Error ${t.code} ${t.text}`),networkDetails:r,stats:s}))},onAbort:(t,n,i)=>{this.resetLoader(e,l),o(new xn({type:E.NETWORK_ERROR,details:T.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:i,stats:t}))},onTimeout:(t,n,i)=>{this.resetLoader(e,l),o(new xn({type:E.NETWORK_ERROR,details:T.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${h.timeout}ms`),networkDetails:i,stats:t}))},onProgress:(n,i,r,s)=>{t&&t({frag:e,part:null,payload:r,networkDetails:s})}})})}loadPart(e,t,n){this.abort();const i=this.config,r=i.fLoader,s=i.loader;return new Promise((a,o)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap)return void o(On(e,t));const l=this.loader=e.loader=r?new r(i):new s(i),c=Mn(e,t),d=Kt(i.fragLoadPolicy.default),h={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Cn};t.stats=l.stats,l.load(c,h,{onSuccess:(i,r,s,o)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);const c={frag:e,part:t,payload:i.data,networkDetails:o};n(c),a(c)},onError:(n,i,r,s)=>{this.resetLoader(e,l),o(new xn({type:E.NETWORK_ERROR,details:T.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:u({url:c.url,data:void 0},n),error:new Error(`HTTP Error ${n.code} ${n.text}`),networkDetails:r,stats:s}))},onAbort:(n,i,r)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),o(new xn({type:E.NETWORK_ERROR,details:T.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:r,stats:n}))},onTimeout:(n,i,r)=>{this.resetLoader(e,l),o(new xn({type:E.NETWORK_ERROR,details:T.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${h.timeout}ms`),networkDetails:r,stats:n}))}})})}updateStatsFromPart(e,t){const n=e.stats,i=t.stats,r=i.total;if(n.loaded+=i.loaded,r){const i=Math.round(e.duration/t.duration),s=Math.min(Math.round(n.loaded/r),i),a=(i-s)*Math.round(n.loaded/s);n.total=n.loaded+a}else n.total=Math.max(n.loaded,n.total);const s=n.loading,a=i.loading;s.start?s.first+=a.first-a.start:(s.start=a.start,s.first=a.first),s.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}}function Mn(e,t=null){const n=t||e,i={frag:e,part:t,responseType:"arraybuffer",url:n.url,headers:{},rangeStart:0,rangeEnd:0},r=n.byteRangeStartOffset,s=n.byteRangeEndOffset;if(p(r)&&p(s)){var a;let t=r,n=s;if("initSegment"===e.sn&&"AES-128"===(null==(a=e.decryptdata)?void 0:a.method)){const e=s-r;e%16&&(n=s+(16-e%16)),0!==r&&(i.resetIV=!0,t=r-16)}i.rangeStart=t,i.rangeEnd=n}return i}function On(e,t){const n=new Error(`GAP ${e.gap?"tag":"attribute"} found`),i={type:E.MEDIA_ERROR,details:T.FRAG_GAP,fatal:!1,frag:e,error:n,networkDetails:null};return t&&(i.part=t),(t||e).stats.aborted=!0,new xn(i)}class xn extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class Dn{decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}constructor(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}}class Pn{expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}constructor(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}}class Ln{uint8ArrayToUint32Array_(e){const t=new DataView(e),n=new Uint32Array(4);for(let e=0;e<4;e++)n[e]=t.getUint32(4*e);return n}initTable(){const e=this.sBox,t=this.invSBox,n=this.subMix,i=n[0],r=n[1],s=n[2],a=n[3],o=this.invSubMix,l=o[0],c=o[1],d=o[2],h=o[3],u=new Uint32Array(256);let f=0,m=0,p=0;for(p=0;p<256;p++)u[p]=p<128?p<<1:p<<1^283;for(p=0;p<256;p++){let n=m^m<<1^m<<2^m<<3^m<<4;n=n>>>8^255&n^99,e[f]=n,t[n]=f;const o=u[f],p=u[o],g=u[p];let _=257*u[n]^16843008*n;i[f]=_<<24|_>>>8,r[f]=_<<16|_>>>16,s[f]=_<<8|_>>>24,a[f]=_,_=16843009*g^65537*p^257*o^16843008*f,l[n]=_<<24|_>>>8,c[n]=_<<16|_>>>16,d[n]=_<<8|_>>>24,h[n]=_,f?(f=o^u[u[u[g^o]]],m^=u[u[m]]):f=m=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let n=!0,i=0;for(;i<t.length&&n;)n=t[i]===this.key[i],i++;if(n)return;this.key=t;const r=this.keySize=t.length;if(4!==r&&6!==r&&8!==r)throw new Error("Invalid aes key size="+r);const s=this.ksRows=4*(r+6+1);let a,o;const l=this.keySchedule=new Uint32Array(s),c=this.invKeySchedule=new Uint32Array(s),d=this.sBox,h=this.rcon,u=this.invSubMix,f=u[0],m=u[1],p=u[2],g=u[3];let _,v;for(a=0;a<s;a++)a<r?_=l[a]=t[a]:(v=_,a%r==0?(v=v<<8|v>>>24,v=d[v>>>24]<<24|d[v>>>16&255]<<16|d[v>>>8&255]<<8|d[255&v],v^=h[a/r|0]<<24):r>6&&a%r==4&&(v=d[v>>>24]<<24|d[v>>>16&255]<<16|d[v>>>8&255]<<8|d[255&v]),l[a]=_=(l[a-r]^v)>>>0);for(o=0;o<s;o++)a=s-o,v=3&o?l[a]:l[a-4],c[o]=o<4||a<=4?v:f[d[v>>>24]]^m[d[v>>>16&255]]^p[d[v>>>8&255]]^g[d[255&v]],c[o]=c[o]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,n){const i=this.keySize+6,r=this.invKeySchedule,s=this.invSBox,a=this.invSubMix,o=a[0],l=a[1],c=a[2],d=a[3],h=this.uint8ArrayToUint32Array_(n);let u=h[0],f=h[1],m=h[2],p=h[3];const g=new Int32Array(e),_=new Int32Array(g.length);let v,E,T,S,A,b,I,R,C,y,M,O,x,D;const P=this.networkToHostOrderSwap;for(;t<g.length;){for(C=P(g[t]),y=P(g[t+1]),M=P(g[t+2]),O=P(g[t+3]),A=C^r[0],b=O^r[1],I=M^r[2],R=y^r[3],x=4,D=1;D<i;D++)v=o[A>>>24]^l[b>>16&255]^c[I>>8&255]^d[255&R]^r[x],E=o[b>>>24]^l[I>>16&255]^c[R>>8&255]^d[255&A]^r[x+1],T=o[I>>>24]^l[R>>16&255]^c[A>>8&255]^d[255&b]^r[x+2],S=o[R>>>24]^l[A>>16&255]^c[b>>8&255]^d[255&I]^r[x+3],A=v,b=E,I=T,R=S,x+=4;v=s[A>>>24]<<24^s[b>>16&255]<<16^s[I>>8&255]<<8^s[255&R]^r[x],E=s[b>>>24]<<24^s[I>>16&255]<<16^s[R>>8&255]<<8^s[255&A]^r[x+1],T=s[I>>>24]<<24^s[R>>16&255]<<16^s[A>>8&255]<<8^s[255&b]^r[x+2],S=s[R>>>24]<<24^s[A>>16&255]<<16^s[b>>8&255]<<8^s[255&I]^r[x+3],_[t]=P(v^u),_[t+1]=P(S^f),_[t+2]=P(T^m),_[t+3]=P(E^p),u=C,f=y,m=M,p=O,t+=4}return _.buffer}constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}}class Nn{destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const n=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?function(e){const t=e.byteLength,n=t&&new DataView(e.buffer).getUint8(t-1);return n?K(e,0,t-n):e}(n):n}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,n){return this.useSoftware?new Promise((i,r)=>{this.softwareDecrypt(new Uint8Array(e),t,n);const s=this.flush();s?i(s.buffer):r(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,n)}softwareDecrypt(e,t,n){const{currentIV:i,currentResult:r,remainderData:s}=this;this.logOnce("JS AES decrypt"),s&&(e=xe(s,e),this.remainderData=null);const a=this.getValidChunk(e);if(!a.length)return null;i&&(n=i);let o=this.softwareDecrypter;o||(o=this.softwareDecrypter=new Ln),o.expandKey(t);const l=r;return this.currentResult=o.decrypt(a.buffer,0,n),this.currentIV=K(a,-16).buffer,l||null}webCryptoDecrypt(e,t,n){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,n));this.key=t,this.fastAesKey=new Pn(this.subtle,t)}return this.fastAesKey.expandKey().then(t=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new Dn(this.subtle,new Uint8Array(n)).decrypt(e.buffer,t)):Promise.reject(new Error("web crypto not initialized"))).catch(i=>(I.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${i.name}: ${i.message}`),this.onWebCryptoError(e,t,n)))}onWebCryptoError(e,t,n){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,n);const i=this.flush();if(i)return i.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(e){let t=e;const n=e.length-e.length%16;return n!==e.length&&(t=K(e,0,n),this.remainderData=K(e,n)),t}logOnce(e){this.logEnabled&&(I.log("[decrypter]: "+e),this.logEnabled=!1)}constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const e=self.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(e){}this.useSoftware=!this.subtle}}class Fn extends class{destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}}{doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;null!=e&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state="STOPPED"}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}_streamEnded(e,t){if(t.live||e.nextStart||!e.end||!this.media)return!1;const n=t.partList;if(null!=n&&n.length){const e=n[n.length-1];return Tn.isBuffered(this.media,e.start+e.duration/2)}const i=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(i)}getLevelDetails(){var e;if(this.levels&&null!==this.levelLastLoaded)return null==(e=this.levelLastLoaded)?void 0:e.details}onMediaAttached(e,t){const n=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),n.addEventListener("seeking",this.onvseeking),n.addEventListener("ended",this.onvended);const i=this.config;this.levels&&i.autoStartLoad&&"STOPPED"===this.state&&this.startLoad(i.startPosition)}onMediaDetaching(){const e=this.media;null!=e&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&this.onvseeking&&this.onvended&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:e,fragCurrent:t,media:n,mediaBuffer:i,state:r}=this,s=n?n.currentTime:0,a=Tn.bufferInfo(i||n,s,e.maxBufferHole);if(this.log(`media seeking to ${p(s)?s.toFixed(3):s}, state: ${r}`),"ENDED"===this.state)this.resetLoadingState();else if(t){const n=e.maxFragLookUpTolerance,i=t.start-n,r=t.start+t.duration+n;if(!a.len||r<a.start||i>a.end){const e=s>r;(s<i||e)&&(e&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}n&&(this.fragmentTracker.removeFragmentsInRange(s,1/0,this.playlistType,!0),this.lastCurrentTime=s),this.loadedmetadata||a.len||(this.nextLoadPosition=this.startPosition=s),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(v.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state="STOPPED",this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,n){this._loadFragForPlayback(e,t,n)}_loadFragForPlayback(e,t,n){this._doFragLoad(e,t,n,t=>{if(this.fragContextChanged(e))return this.warn(`Fragment ${e.sn}${t.part?" p: "+t.part.index:""} of level ${e.level} was dropped during download.`),void this.fragmentTracker.removeFragment(e);e.stats.chunkCount++,this._handleFragmentLoadProgress(t)}).then(t=>{if(!t)return;const n=this.state;this.fragContextChanged(e)?("FRAG_LOADING"===n||!this.fragCurrent&&"PARSING"===n)&&(this.fragmentTracker.removeFragment(e),this.state="IDLE"):("payload"in t&&(this.log(`Loaded fragment ${e.sn} of level ${e.level}`),this.hls.trigger(v.FRAG_LOADED,t)),this._handleFragmentLoadComplete(t))}).catch(t=>{"STOPPED"!==this.state&&"ERROR"!==this.state&&(this.warn("Frag error: "+((null==t?void 0:t.message)||t)),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:n}=this;if("APPENDING"===n.getState(e)){const t=e.type,i=this.getFwdBufferInfo(this.mediaBuffer,t),r=Math.max(e.duration,i?i.len:this.config.maxBufferLength),s=this.backtrackFragment;(1==(s?e.sn-s.sn:0)||this.reduceMaxBufferLength(r,e.duration))&&n.removeFragment(e)}else 0===(null==(t=this.mediaBuffer)?void 0:t.buffered.length)?n.removeAllFragments():n.hasParts(e.type)&&(n.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),"PARTIAL"===n.getState(e)&&n.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}flushMainBuffer(e,t,n=null){if(!(e-t))return;const i={startOffset:e,endOffset:t,type:n};this.hls.trigger(v.BUFFER_FLUSHING,i)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(t=>{if(!t||this.fragContextChanged(e)||!this.levels)throw new Error("init load aborted");return t}).then(t=>{const{hls:n}=this,{payload:i}=t,r=e.decryptdata;if(i&&i.byteLength>0&&null!=r&&r.key&&r.iv&&"AES-128"===r.method){const s=self.performance.now();return this.decrypter.decrypt(new Uint8Array(i),r.key.buffer,r.iv.buffer).catch(t=>{throw n.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.FRAG_DECRYPT_ERROR,fatal:!1,error:t,reason:t.message,frag:e}),t}).then(i=>{const r=self.performance.now();return n.trigger(v.FRAG_DECRYPTED,{frag:e,payload:i,stats:{tstart:s,tdecrypt:r}}),t.payload=i,this.completeInitSegmentLoad(t)})}return this.completeInitSegmentLoad(t)}).catch(t=>{"STOPPED"!==this.state&&"ERROR"!==this.state&&(this.warn(t),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const n=e.frag.stats;this.state="IDLE",e.frag.data=new Uint8Array(e.payload),n.parsing.start=n.buffering.start=self.performance.now(),n.parsing.end=n.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){var n,i,r,s;const a=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.playlistType===mt.MAIN?"level":"track"} ${e.level} (frag:[${(null!=(n=e.startPTS)?n:NaN).toFixed(3)}-${(null!=(i=e.endPTS)?i:NaN).toFixed(3)}] > buffer:${a?function(e){let t="";const n=e.length;for(let i=0;i<n;i++)t+=`[${e.start(i).toFixed(3)}-${e.end(i).toFixed(3)}]`;return t}(Tn.getBuffered(a)):"(detached)"})`),"initSegment"!==e.sn){var o;if(e.type!==mt.SUBTITLE){const t=e.elementaryStreams;if(!Object.keys(t).some(e=>!!t[e]))return void(this.state="IDLE")}const t=null==(o=this.levels)?void 0:o[e.level];null!=t&&t.fragmentError&&(this.log(`Resetting level fragment error count of ${t.fragmentError} on frag buffered`),t.fragmentError=0)}this.state="IDLE",a&&(!this.loadedmetadata&&e.type==mt.MAIN&&a.buffered.length&&(null==(r=this.fragCurrent)?void 0:r.sn)===(null==(s=this.fragPrevious)?void 0:s.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:n,part:i,partsLoaded:r}=e,s=!r||0===r.length||r.some(e=>!e),a=new Sn(n.level,n.sn,n.stats.chunkCount+1,0,i?i.index:-1,!s);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,n=null,i){var r;const s=null==t?void 0:t.details;if(!this.levels||!s)throw new Error(`frag load aborted, missing level${s?"":" detail"}s`);let a=null;if(!e.encrypted||null!=(r=e.decryptdata)&&r.key?!e.encrypted&&s.encryptedFragments.length&&this.keyLoader.loadClear(e,s.encryptedFragments):(this.log(`Loading key for ${e.sn} of [${s.startSN}-${s.endSN}], ${"[stream-controller]"===this.logPrefix?"level":"track"} ${e.level}`),this.state="KEY_LOADING",this.fragCurrent=e,a=this.keyLoader.load(e).then(e=>{if(!this.fragContextChanged(e.frag))return this.hls.trigger(v.KEY_LOADED,e),"KEY_LOADING"===this.state&&(this.state="IDLE"),e}),this.hls.trigger(v.KEY_LOADING,{frag:e}),null===this.fragCurrent&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))),n=Math.max(e.start,n||0),this.config.lowLatencyMode&&"initSegment"!==e.sn){const r=s.partList;if(r&&i){n>e.end&&s.fragmentHint&&(e=s.fragmentHint);const o=this.getNextPart(r,e,n);if(o>-1){const l=r[o];let c;return this.log(`Loading part sn: ${e.sn} p: ${l.index} cc: ${e.cc} of playlist [${s.startSN}-${s.endSN}] parts [0-${o}-${r.length-1}] ${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(n.toFixed(3))}`),this.nextLoadPosition=l.start+l.duration,this.state="FRAG_LOADING",c=a?a.then(n=>!n||this.fragContextChanged(n.frag)?null:this.doFragPartsLoad(e,l,t,i)).catch(e=>this.handleFragLoadError(e)):this.doFragPartsLoad(e,l,t,i).catch(e=>this.handleFragLoadError(e)),this.hls.trigger(v.FRAG_LOADING,{frag:e,part:l,targetBufferTime:n}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):c}if(!e.url||this.loadedEndOfParts(r,n))return Promise.resolve(null)}}this.log(`Loading fragment ${e.sn} cc: ${e.cc} ${s?"of ["+s.startSN+"-"+s.endSN+"] ":""}${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(n.toFixed(3))}`),p(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state="FRAG_LOADING";const o=this.config.progressive;let l;return l=o&&a?a.then(t=>!t||this.fragContextChanged(null==t?void 0:t.frag)?null:this.fragmentLoader.load(e,i)).catch(e=>this.handleFragLoadError(e)):Promise.all([this.fragmentLoader.load(e,o?i:void 0),a]).then(([e])=>(!o&&e&&i&&i(e),e)).catch(e=>this.handleFragLoadError(e)),this.hls.trigger(v.FRAG_LOADING,{frag:e,targetBufferTime:n}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):l}doFragPartsLoad(e,t,n,i){return new Promise((r,s)=>{var a;const o=[],l=null==(a=n.details)?void 0:a.partList,c=t=>{this.fragmentLoader.loadPart(e,t,i).then(i=>{o[t.index]=i;const s=i.part;this.hls.trigger(v.FRAG_LOADED,i);const a=Gt(n,e.sn,t.index+1)||Ht(l,e.sn,t.index+1);if(!a)return r({frag:e,part:s,partsLoaded:o});c(a)}).catch(s)};c(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===T.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(v.ERROR,t)}else this.hls.trigger(v.ERROR,{type:E.OTHER_ERROR,details:T.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||"PARSING"!==this.state)return void(this.fragCurrent||"STOPPED"===this.state||"ERROR"===this.state||(this.state="IDLE"));const{frag:n,part:i,level:r}=t,s=self.performance.now();n.stats.parsing.end=s,i&&(i.stats.parsing.end=s),this.updateLevelTiming(n,i,r,e.partial)}getCurrentContext(e){const{levels:t,fragCurrent:n}=this,{level:i,sn:r,part:s}=e;if(null==t||!t[i])return this.warn(`Levels object was unset while buffering fragment ${r} of level ${i}. The current chunk will not be buffered.`),null;const a=t[i],o=s>-1?Gt(a,r,s):null,l=o?o.fragment:function(e,t,n){if(null==e||!e.details)return null;const i=e.details;let r=i.fragments[t-i.startSN];return r||(r=i.fragmentHint,r&&r.sn===t?r:t<i.startSN&&n&&n.sn===t?n:null)}(a,r,n);return l?(n&&n!==l&&(l.stats=n.stats),{frag:l,part:o,level:a}):null}bufferFragmentData(e,t,n,i,r){var s;if(!e||"PARSING"!==this.state)return;const{data1:a,data2:o}=e;let l=a;if(a&&o&&(l=xe(a,o)),null==(s=l)||!s.length)return;const c={type:e.type,frag:t,part:n,chunkMeta:i,parent:t.type,data:l};if(this.hls.trigger(v.BUFFER_APPENDING,c),e.dropped&&e.independent&&!n){if(r)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!Tn.isBuffered(t,t.currentTime))return void this.flushMainBuffer(0,e.start);const n=t.currentTime,i=Tn.bufferInfo(t,n,0),r=e.duration,s=Math.min(2*this.config.maxFragLookUpTolerance,.25*r),a=Math.max(Math.min(e.start-s,i.end-s),n+s);e.start-a>s&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){const n=this.getLoadPosition();return p(n)?this.getFwdBufferInfoAtPos(e,n,t):null}getFwdBufferInfoAtPos(e,t,n){const{config:{maxBufferHole:i}}=this,r=Tn.bufferInfo(e,t,i);if(0===r.len&&void 0!==r.nextStart){const s=this.fragmentTracker.getBufferedFrag(t,n);if(s&&r.nextStart<s.end)return Tn.bufferInfo(e,t,Math.max(r.nextStart,i))}return r}getMaxBufferLength(e){const{config:t}=this;let n;return n=e?Math.max(8*t.maxBufferSize/e,t.maxBufferLength):t.maxBufferLength,Math.min(n,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const n=this.config,i=Math.max(Math.min(e-t,n.maxBufferLength),t),r=Math.max(e-3*t,n.maxMaxBufferLength/2,i);return r>=i&&(n.maxMaxBufferLength=r,this.warn(`Reduce max buffer length to ${r}s`),!0)}getAppendedFrag(e,t=mt.MAIN){const n=this.fragmentTracker.getAppendedFrag(e,mt.MAIN);return n&&"fragment"in n?n.fragment:n}getNextFragment(e,t){const n=t.fragments,i=n.length;if(!i)return null;const{config:r}=this,s=n[0].start;let a;if(t.live){const o=r.initialLiveManifestSize;if(i<o)return this.warn(`Not enough fragments to start playback (have: ${i}, need: ${o})`),null;(!t.PTSKnown&&!this.startFragRequested&&-1===this.startPosition||e<s)&&(a=this.getInitialLiveFragment(t,n),this.startPosition=this.nextLoadPosition=a?this.hls.liveSyncPosition||a.start:e)}else e<=s&&(a=n[0]);if(!a){const n=r.lowLatencyMode?t.partEnd:t.fragmentEnd;a=this.getFragmentAtPosition(e,n,t)}return this.mapToInitFragWhenRequired(a)}isLoopLoading(e,t){const n=this.fragmentTracker.getState(e);return("OK"===n||"PARTIAL"===n&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,n,i,r){const s=e.gap,a=this.getNextFragment(this.nextLoadPosition,t);if(null===a)return a;if(e=a,s&&e&&!e.gap&&n.nextStart){const t=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,n.nextStart,i);if(null!==t&&n.len+t.len>=r)return this.log(`buffer full after gaps in "${i}" playlist starting at sn: ${e.sn}`),null}return e}mapToInitFragWhenRequired(e){return null==e||!e.initSegment||null!=e&&e.initSegment.data||this.bitrateTest?e:e.initSegment}getNextPart(e,t,n){let i=-1,r=!1,s=!0;for(let a=0,o=e.length;a<o;a++){const o=e[a];if(s=s&&!o.independent,i>-1&&n<o.start)break;const l=o.loaded;l?i=-1:(r||o.independent||s)&&o.fragment===t&&(i=a),r=l}return i}loadedEndOfParts(e,t){const n=e[e.length-1];return n&&t>n.start&&n.loaded}getInitialLiveFragment(e,t){const n=this.fragPrevious;let i=null;if(n){if(e.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+n.programDateTime),i=function(e,t,n){if(null===t||!Array.isArray(e)||!e.length||!p(t))return null;if(t<(e[0].programDateTime||0))return null;if(t>=(e[e.length-1].endProgramDateTime||0))return null;n=n||0;for(let i=0;i<e.length;++i){const r=e[i];if($t(t,n,r))return r}return null}(t,n.endProgramDateTime,this.config.maxFragLookUpTolerance)),!i){const r=n.sn+1;if(r>=e.startSN&&r<=e.endSN){const s=t[r-e.startSN];n.cc===s.cc&&(i=s,this.log("Live playlist, switching playlist, load frag with next SN: "+i.sn))}i||(i=function(e,t){return qt(e,e=>e.cc<t?1:e.cc>t?-1:0)}(t,n.cc),i&&this.log("Live playlist, switching playlist, load frag with same CC: "+i.sn))}}else{const t=this.hls.liveSyncPosition;null!==t&&(i=this.getFragmentAtPosition(t,this.bitrateTest?e.fragmentEnd:e.edge,e))}return i}getFragmentAtPosition(e,t,n){const{config:i}=this;let{fragPrevious:r}=this,{fragments:s,endSN:a}=n;const{fragmentHint:o}=n,{maxFragLookUpTolerance:l}=i,c=n.partList,d=!!(i.lowLatencyMode&&null!=c&&c.length&&o);let h;if(d&&o&&!this.bitrateTest&&(s=s.concat(o),a=o.sn),h=e<t?Qt(r,s,e,e>t-l?0:l):s[s.length-1],h){const e=h.sn-n.startSN,t=this.fragmentTracker.getState(h);if(("OK"===t||"PARTIAL"===t&&h.gap)&&(r=h),r&&h.sn===r.sn&&(!d||c[0].fragment.sn>h.sn)&&r&&h.level===r.level){const t=s[e+1];h=h.sn<a&&"OK"!==this.fragmentTracker.getState(t)?t:null}}return h}synchronizeToLiveEdge(e){const{config:t,media:n}=this;if(!n)return;const i=this.hls.liveSyncPosition,r=n.currentTime,s=e.fragments[0].start,a=e.edge,o=r>=s-t.maxFragLookUpTolerance&&r<=a;if(null!==i&&n.duration>i&&(r<i||!o)){const s=void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!o&&n.readyState<4||r<a-s)&&(this.loadedmetadata||(this.nextLoadPosition=i),n.readyState&&(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${i.toFixed(3)}`),n.currentTime=i))}}alignPlaylists(e,t,n){const i=e.fragments.length;if(!i)return this.warn("No fragments in live playlist"),0;const r=e.fragments[0].start,s=!t,a=e.alignedSliding&&p(r);if(s||!a&&!r){const{fragPrevious:r}=this;!function(e,t,n){t&&(function(e,t,n){if(function(e,t,n){return!(!t||!(n.endCC>n.startCC||e&&e.cc<n.startCC))}(e,n,t)){const e=function(e,t){const n=e.fragments,i=t.fragments;if(!i.length||!n.length)return void I.log("No fragments to align");const r=An(n,i[0].cc);if(r&&(!r||r.startPTS))return r;I.log("No frag in previous level to align on")}(n,t);e&&p(e.start)&&(I.log("Adjusting PTS using last level due to CC increase within current level "+t.url),In(e.start,t))}}(e,n,t),!n.alignedSliding&&t&&Rn(n,t),n.alignedSliding||!t||n.skippedSegments||kt(t,n))}(r,n,e);const s=e.fragments[0].start;return this.log(`Live playlist sliding: ${s.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} prev-sn: ${r?r.sn:"na"} fragments: ${i}`),s}return r}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,3*e.partTarget)}setStartPosition(e,t){let n=this.startPosition;if(n<t&&(n=-1),-1===n||-1===this.lastCurrentTime){const i=null!==this.startTimeOffset,r=i?this.startTimeOffset:e.startTimeOffset;null!==r&&p(r)?(n=t+r,r<0&&(n+=e.totalduration),n=Math.min(Math.max(t,n),t+e.totalduration),this.log(`Start time offset ${r} found in ${i?"multivariant":"media"} playlist, adjust startPosition to ${n}`),this.startPosition=n):e.live?n=this.hls.liveSyncPosition||t:this.startPosition=n=0,this.lastCurrentTime=n}this.nextLoadPosition=n}getLoadPosition(){const{media:e}=this;let t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}handleFragLoadAborted(e,t){this.transmuxer&&"initSegment"!==e.sn&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){this.fragCurrent&&(this.fragContextChanged(e)||"FRAG_LOADING_WAITING_RETRY"===this.state)||(this.state="IDLE")}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const e=this.getCurrentContext(t.chunkMeta);e&&(t.frag=e.frag)}const n=t.frag;if(!n||n.type!==e||!this.levels)return;var i;if(this.fragContextChanged(n))return void this.warn(`Frag load error must match current frag to retry ${n.url} > ${null==(i=this.fragCurrent)?void 0:i.url}`);const r=t.details===T.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(n,!0);const s=t.errorAction,{action:a,retryCount:o=0,retryConfig:l}=s||{};if(s&&a===Jt.RetryRequest&&l){this.resetStartWhenNotLoaded(this.levelLastLoaded);const i=zt(l,o);this.warn(`Fragment ${n.sn} of ${e} ${n.level} errored with ${t.details}, retrying loading ${o+1}/${l.maxNumRetry} in ${i}ms`),s.resolved=!0,this.retryDate=self.performance.now()+i,this.state="FRAG_LOADING_WAITING_RETRY"}else if(l&&s){if(this.resetFragmentErrors(e),!(o<l.maxNumRetry))return void I.warn(`${t.details} reached or exceeded max retry (${o})`);r||a===Jt.RemoveAlternatePermanently||(s.resolved=!0)}else(null==s?void 0:s.action)===Jt.SendAlternateToPenaltyBox?this.state="WAITING_LEVEL":this.state="ERROR";this.tickImmediate()}reduceLengthAndFlushBuffer(e){if("PARSING"===this.state||"PARSED"===this.state){const t=e.frag,n=e.parent,i=this.getFwdBufferInfo(this.mediaBuffer,n),r=i&&i.len>.5;r&&this.reduceMaxBufferLength(i.len,(null==t?void 0:t.duration)||10);const s=!r;return s&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${n} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),s}return!1}resetFragmentErrors(e){e===mt.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),"STOPPED"!==this.state&&(this.state="IDLE")}afterBufferFlushed(e,t,n){if(!e)return;const i=Tn.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,i,n),"ENDED"===this.state&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state="IDLE"}resetStartWhenNotLoaded(e){if(!this.loadedmetadata){this.startFragRequested=!1;const t=e?e.details:null;null!=t&&t.live?(this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of level ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,n,i){var r;const s=n.details;if(s){if(!Object.keys(e.elementaryStreams).reduce((t,r)=>{const a=e.elementaryStreams[r];if(a){const o=a.endPTS-a.startPTS;if(o<=0)return this.warn(`Could not parse fragment ${e.sn} ${r} duration reliably (${o})`),t||!1;const l=i?0:Bt(s,e,a.startPTS,a.endPTS,a.startDTS,a.endDTS);return this.hls.trigger(v.LEVEL_PTS_UPDATED,{details:s,level:n,drift:l,type:r,frag:e,start:a.startPTS,end:a.endPTS}),!0}return t},!1)&&null===(null==(r=this.transmuxer)?void 0:r.error)){const t=new Error(`Found no media in fragment ${e.sn} of level ${e.level} resetting transmuxer to fallback to playlist timing`);if(0===n.fragmentError&&(n.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)),this.warn(t.message),this.hls.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.FRAG_PARSING_ERROR,fatal:!1,error:t,frag:e,reason:`Found no media in msn ${e.sn} of level "${n.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state="PARSED",this.hls.trigger(v.FRAG_PARSED,{frag:e,part:t})}else this.warn("level.details undefined")}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(e){"demuxerWorker"===e.event&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}constructor(e,t,n,i,r){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state="STOPPED",this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=r,this.logPrefix=i,this.log=I.log.bind(I,i+":"),this.warn=I.warn.bind(I,i+":"),this.hls=e,this.fragmentLoader=new yn(e.config),this.keyLoader=n,this.fragmentTracker=t,this.config=e.config,this.decrypter=new Nn(e.config),e.on(v.MANIFEST_LOADED,this.onManifestLoaded,this)}}class wn{push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let n;return e.length?(n=1===e.length?e[0]:function(e,t){const n=new Uint8Array(t);let i=0;for(let t=0;t<e.length;t++){const r=e[t];n.set(r,i),i+=r.length}return n}(e,t),this.reset(),n):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}constructor(){this.chunks=[],this.dataLength=0}}function Un(e="",t=9e4){return{type:e,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class Bn{resetInitSegment(e,t,n,i){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,n){}demux(e,t){this.cachedData&&(e=xe(this.cachedData,e),this.cachedData=null);let n,i=Q(e,0),r=i?i.length:0;const s=this._audioTrack,a=this._id3Track,o=i?J(i):void 0,l=e.length;for((null===this.basePTS||0===this.frameIndex&&p(o))&&(this.basePTS=kn(o,t,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),i&&i.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:bt.audioId3,duration:Number.POSITIVE_INFINITY});r<l;){if(this.canParse(e,r)){const t=this.appendFrame(s,e,r);t?(this.frameIndex++,this.lastPTS=t.sample.pts,r+=t.length,n=r):r=l}else $(e,r)?(i=Q(e,r),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:bt.audioId3,duration:Number.POSITIVE_INFINITY}),r+=i.length,n=r):r++;if(r===l&&n!==l){const t=K(e,n);this.cachedData?this.cachedData=xe(this.cachedData,t):this.cachedData=t}}return{audioTrack:s,videoTrack:Un(),id3Track:a,textTrack:Un()}}demuxSampleAes(e,t,n){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:Un(),id3Track:this._id3Track,textTrack:Un()}}destroy(){}constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}}const kn=(e,t,n)=>p(e)?90*e:9e4*t+(n?9e4*n.baseTime/n.timescale:0);function Vn(e,t){return 255===e[t]&&240==(246&e[t+1])}function Gn(e,t){return 1&e[t+1]?7:9}function Hn(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function Wn(e,t){return t+1<e.length&&Vn(e,t)}function Xn(e,t){if(Wn(e,t)){const n=Gn(e,t);if(t+n>=e.length)return!1;const i=Hn(e,t);if(i<=n)return!1;const r=t+i;return r===e.length||Wn(e,r)}return!1}function jn(e,t,n,i,r){if(!e.samplerate){const s=function(e,t,n,i){let r,s,a,o;const l=navigator.userAgent.toLowerCase(),c=i,d=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];r=1+((192&t[n+2])>>>6);const h=(60&t[n+2])>>>2;if(!(h>d.length-1))return a=(1&t[n+2])<<2,a|=(192&t[n+3])>>>6,I.log(`manifest codec:${i}, ADTS type:${r}, samplingIndex:${h}`),/firefox/i.test(l)?h>=6?(r=5,o=new Array(4),s=h-3):(r=2,o=new Array(2),s=h):-1!==l.indexOf("android")?(r=2,o=new Array(2),s=h):(r=5,o=new Array(4),i&&(-1!==i.indexOf("mp4a.40.29")||-1!==i.indexOf("mp4a.40.5"))||!i&&h>=6?s=h-3:((i&&-1!==i.indexOf("mp4a.40.2")&&(h>=6&&1===a||/vivaldi/i.test(l))||!i&&1===a)&&(r=2,o=new Array(2)),s=h)),o[0]=r<<3,o[0]|=(14&h)>>1,o[1]|=(1&h)<<7,o[1]|=a<<3,5===r&&(o[1]|=(14&s)>>1,o[2]=(1&s)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:d[h],channelCount:a,codec:"mp4a.40."+r,manifestCodec:c};{const t=new Error("invalid ADTS sampling index:"+h);e.emit(v.ERROR,v.ERROR,{type:E.MEDIA_ERROR,details:T.FRAG_PARSING_ERROR,fatal:!0,error:t,reason:t.message})}}(t,n,i,r);if(!s)return;e.config=s.config,e.samplerate=s.samplerate,e.channelCount=s.channelCount,e.codec=s.codec,e.manifestCodec=s.manifestCodec,I.log(`parsed codec:${e.codec}, rate:${s.samplerate}, channels:${s.channelCount}`)}}function zn(e){return 9216e4/e}function Kn(e,t,n,i,r){const s=i+r*zn(e.samplerate),a=function(e,t){const n=Gn(e,t);if(t+n<=e.length){const i=Hn(e,t)-n;if(i>0)return{headerLength:n,frameLength:i}}}(t,n);let o;if(a){const{frameLength:i,headerLength:r}=a,l=r+i,c=Math.max(0,n+l-t.length);c?(o=new Uint8Array(l-r),o.set(t.subarray(n+r,t.length),0)):o=t.subarray(n+r,n+l);const d={unit:o,pts:s};return c||e.samples.push(d),{sample:d,length:l,missing:c}}const l=t.length-n;return o=new Uint8Array(l),o.set(t.subarray(n,t.length),0),{sample:{unit:o,pts:s},length:l,missing:-1}}let Yn=null;const qn=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],Qn=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Zn=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],$n=[0,1,1,4];function Jn(e,t,n,i,r){if(n+24>t.length)return;const s=ei(t,n);if(s&&n+s.frameLength<=t.length){const a=i+r*(9e4*s.samplesPerFrame/s.sampleRate),o={unit:t.subarray(n,n+s.frameLength),pts:a,dts:a};return e.config=[],e.channelCount=s.channelCount,e.samplerate=s.sampleRate,e.samples.push(o),{sample:o,length:s.frameLength,missing:0}}}function ei(e,t){const n=e[t+1]>>3&3,i=e[t+1]>>1&3,r=e[t+2]>>4&15,s=e[t+2]>>2&3;if(1!==n&&0!==r&&15!==r&&3!==s){const a=e[t+2]>>1&1,o=e[t+3]>>6,l=1e3*qn[14*(3===n?3-i:3===i?3:4)+r-1],c=Qn[3*(3===n?0:2===n?1:2)+s],d=3===o?1:2,h=Zn[n][i],u=$n[i],f=8*h*u,m=Math.floor(h*l/c+a)*u;if(null===Yn){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Yn=e?parseInt(e[1]):0}return!!Yn&&Yn<=87&&2===i&&l>=224e3&&0===o&&(e[t+3]=128|e[t+3]),{sampleRate:c,channelCount:d,frameLength:m,samplesPerFrame:f}}}function ti(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])}function ni(e,t){return t+1<e.length&&ti(e,t)}function ii(e,t){if(t+1<e.length&&ti(e,t)){const n=4,i=ei(e,t);let r=n;null!=i&&i.frameLength&&(r=i.frameLength);const s=t+r;return s===e.length||ni(e,s)}return!1}const ri=/\/emsg[-/]ID3/i,si=(e,t)=>{let n=0,i=5;t+=i;const r=new Uint32Array(1),s=new Uint32Array(1),a=new Uint8Array(1);for(;i>0;){a[0]=e[t];const o=Math.min(i,8),l=8-o;s[0]=4278190080>>>24+l<<l,r[0]=(a[0]&s[0])>>l,n=n?n<<o|r[0]:r[0],t+=1,i-=o}return n};function ai(e,t,n,i,r){if(n+8>t.length)return-1;if(11!==t[n]||119!==t[n+1])return-1;const s=t[n+4]>>6;if(s>=3)return-1;const a=[48e3,44100,32e3][s],o=63&t[n+4],l=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*o+s];if(n+l>t.length)return-1;const c=t[n+6]>>5;let d=0;2===c?d+=2:(1&c&&1!==c&&(d+=2),4&c&&(d+=2));const h=(t[n+6]<<8|t[n+7])>>12-d&1,u=[2,1,2,3,3,4,4,5][c]+h,f=t[n+5]>>3,m=7&t[n+5],p=new Uint8Array([s<<6|f<<1|m>>2,(3&m)<<6|c<<3|h<<2|o>>4,o<<4&224]),g=i+r*(1536/a*9e4),_=t.subarray(n,n+l);return e.config=p,e.channelCount=u,e.samplerate=a,e.samples.push({unit:_,pts:g}),l}class oi{loadWord(){const e=this.data,t=this.bytesAvailable,n=e.byteLength-t,i=new Uint8Array(4),r=Math.min(4,t);if(0===r)throw new Error("no bytes available");i.set(e.subarray(n,n+r)),this.word=new DataView(i.buffer).getUint32(0),this.bitsAvailable=8*r,this.bytesAvailable-=r}skipBits(e){let t;e=Math.min(e,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(t=(e-=this.bitsAvailable)>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const n=this.word>>>32-t;if(e>32&&I.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return t=e-t,t>0&&this.bitsAvailable?n<<t|this.readBits(t):n}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t,n=8,i=8;for(let r=0;r<e;r++)0!==i&&(t=this.readEG(),i=(n+t+256)%256),n=0===i?n:i}readSPS(){let e,t,n,i=0,r=0,s=0,a=0;const o=this.readUByte.bind(this),l=this.readBits.bind(this),c=this.readUEG.bind(this),d=this.readBoolean.bind(this),h=this.skipBits.bind(this),u=this.skipEG.bind(this),f=this.skipUEG.bind(this),m=this.skipScalingList.bind(this);o();const p=o();if(l(5),h(3),o(),f(),100===p||110===p||122===p||244===p||44===p||83===p||86===p||118===p||128===p){const e=c();if(3===e&&h(1),f(),f(),h(1),d())for(t=3!==e?8:12,n=0;n<t;n++)d()&&m(n<6?16:64)}f();const g=c();if(0===g)c();else if(1===g)for(h(1),u(),u(),e=c(),n=0;n<e;n++)u();f(),h(1);const _=c(),v=c(),E=l(1);0===E&&h(1),h(1),d()&&(i=c(),r=c(),s=c(),a=c());let T=[1,1];if(d()&&d())switch(o()){case 1:T=[1,1];break;case 2:T=[12,11];break;case 3:T=[10,11];break;case 4:T=[16,11];break;case 5:T=[40,33];break;case 6:T=[24,11];break;case 7:T=[20,11];break;case 8:T=[32,11];break;case 9:T=[80,33];break;case 10:T=[18,11];break;case 11:T=[15,11];break;case 12:T=[64,33];break;case 13:T=[160,99];break;case 14:T=[4,3];break;case 15:T=[3,2];break;case 16:T=[2,1];break;case 255:T=[o()<<8|o(),o()<<8|o()]}return{width:Math.ceil(16*(_+1)-2*i-2*r),height:(2-E)*(v+1)*16-(E?2:4)*(s+a),pixelRatio:T}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}}class li extends class{createVideoSample(e,t,n,i){return{key:e,frame:!1,pts:t,dts:n,units:[],debug:i,length:0}}getLastNalUnit(e){var t;let n,i=this.VideoSample;if(i&&0!==i.units.length||(i=e[e.length-1]),null!=(t=i)&&t.units){const e=i.units;n=e[e.length-1]}return n}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){const n=t.samples,i=n.length;if(!i)return void t.dropped++;{const t=n[i-1];e.pts=t.pts,e.dts=t.dts}}t.samples.push(e)}e.debug.length&&I.log(e.pts+"/"+e.dts+":"+e.debug)}constructor(){this.VideoSample=null}}{parseAVCPES(e,t,n,i,r){const s=this.parseAVCNALu(e,n.data);let a,o=this.VideoSample,l=!1;n.data=null,o&&s.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts,"")),s.forEach(i=>{var s;switch(i.type){case 1:{let t=!1;a=!0;const r=i.data;if(l&&r.length>4){const e=new oi(r).readSliceType();2!==e&&4!==e&&7!==e&&9!==e||(t=!0)}var c;t&&null!=(c=o)&&c.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts,"")),o.frame=!0,o.key=t;break}case 5:a=!0,null!=(s=o)&&s.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts,"")),o.key=!0,o.frame=!0;break;case 6:a=!0,Le(i.data,1,n.pts,t.samples);break;case 7:{var d,h;a=!0,l=!0;const t=i.data,n=new oi(t).readSPS();if(!e.sps||e.width!==n.width||e.height!==n.height||(null==(d=e.pixelRatio)?void 0:d[0])!==n.pixelRatio[0]||(null==(h=e.pixelRatio)?void 0:h[1])!==n.pixelRatio[1]){e.width=n.width,e.height=n.height,e.pixelRatio=n.pixelRatio,e.sps=[t],e.duration=r;const i=t.subarray(1,4);let s="avc1.";for(let e=0;e<3;e++){let t=i[e].toString(16);t.length<2&&(t="0"+t),s+=t}e.codec=s}break}case 8:a=!0,e.pps=[i.data];break;case 9:a=!0,e.audFound=!0,o&&this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts,"");break;case 12:a=!0;break;default:a=!1,o&&(o.debug+="unknown NAL "+i.type+" ")}o&&a&&o.units.push(i)}),i&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}parseAVCNALu(e,t){const n=t.byteLength;let i=e.naluState||0;const r=i,s=[];let a,o,l,c=0,d=-1,h=0;for(-1===i&&(d=0,h=31&t[0],i=0,c=1);c<n;)if(a=t[c++],i)if(1!==i)if(a)if(1===a){if(o=c-i-1,d>=0){const e={data:t.subarray(d,o),type:h};s.push(e)}else{const n=this.getLastNalUnit(e.samples);n&&(r&&c<=4-r&&n.state&&(n.data=n.data.subarray(0,n.data.byteLength-r)),o>0&&(n.data=xe(n.data,t.subarray(0,o)),n.state=0))}c<n?(l=31&t[c],d=c,h=l,i=0):i=-1}else i=0;else i=3;else i=a?0:2;else i=a?0:1;if(d>=0&&i>=0){const e={data:t.subarray(d,n),type:h,state:i};s.push(e)}if(0===s.length){const n=this.getLastNalUnit(e.samples);n&&(n.data=xe(n.data,t))}return e.naluState=i,s}}class ci{decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(e,t,n){const i=e[t].unit;if(i.length<=16)return;const r=i.subarray(16,i.length-i.length%16),s=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(s).then(r=>{const s=new Uint8Array(r);i.set(s,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,n)})}decryptAacSamples(e,t,n){for(;;t++){if(t>=e.length)return void n();if(!(e[t].unit.length<32||(this.decryptAacSample(e,t,n),this.decrypter.isSync())))return}}getAvcEncryptedData(e){const t=16*Math.floor((e.length-48)/160)+16,n=new Int8Array(t);let i=0;for(let t=32;t<e.length-16;t+=160,i+=16)n.set(e.subarray(t,t+16),i);return n}getAvcDecryptedUnit(e,t){const n=new Uint8Array(t);let i=0;for(let t=32;t<e.length-16;t+=160,i+=16)e.set(n.subarray(i,i+16),t);return e}decryptAvcSample(e,t,n,i,r){const s=Ne(r.data),a=this.getAvcEncryptedData(s);this.decryptBuffer(a.buffer).then(a=>{r.data=this.getAvcDecryptedUnit(s,a),this.decrypter.isSync()||this.decryptAvcSamples(e,t,n+1,i)})}decryptAvcSamples(e,t,n,i){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,n=0){if(t>=e.length)return void i();const r=e[t].units;for(;!(n>=r.length);n++){const s=r[n];if(!(s.data.length<=48||1!==s.type&&5!==s.type||(this.decryptAvcSample(e,t,n,i,s),this.decrypter.isSync())))return}}}constructor(e,t,n){this.keyData=void 0,this.decrypter=void 0,this.keyData=n,this.decrypter=new Nn(t,{removePKCS7Padding:!1})}}class di{static probe(e){const t=di.syncOffset(e);return t>0&&I.warn("MPEG2-TS detected but first sync word found @ offset "+t),-1!==t}static syncOffset(e){const t=e.length;let n=Math.min(940,t-188)+1,i=0;for(;i<n;){let r=!1,s=-1,a=0;for(let o=i;o<t;o+=188){if(71!==e[o]||t-o!=188&&71!==e[o+188]){if(a)return-1;break}if(a++,-1===s&&(s=o,0!==s&&(n=Math.min(s+18612,e.length-188)+1)),r||(r=0===hi(e,o)),r&&a>1&&(0===s&&a>2||o+188>n))return s}i++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:me[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,n,i){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=di.createTrack("video"),this._audioTrack=di.createTrack("audio",i),this._id3Track=di.createTrack("id3"),this._txtTrack=di.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=n,this._duration=i}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:n}=this;e&&(e.pesData=null),t&&(t.pesData=null),n&&(n.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,n=!1,i=!1){let r;n||(this.sampleAes=null);const s=this._videoTrack,a=this._audioTrack,o=this._id3Track,l=this._txtTrack;let c=s.pid,d=s.pesData,h=a.pid,u=o.pid,f=a.pesData,m=o.pesData,p=null,g=this.pmtParsed,_=this._pmtId,v=e.length;if(this.remainderData&&(v=(e=xe(this.remainderData,e)).length,this.remainderData=null),v<188&&!i)return this.remainderData=e,{audioTrack:a,videoTrack:s,id3Track:o,textTrack:l};const E=Math.max(0,di.syncOffset(e));v-=(v-E)%188,v<e.byteLength&&!i&&(this.remainderData=new Uint8Array(e.buffer,v,e.buffer.byteLength-v));let T=0;for(let t=E;t<v;t+=188)if(71===e[t]){const i=!!(64&e[t+1]),v=hi(e,t);let T;if((48&e[t+3])>>4>1){if(T=t+5+e[t+4],T===t+188)continue}else T=t+4;switch(v){case c:i&&(d&&(r=gi(d))&&this.videoParser.parseAVCPES(s,l,r,!1,this._duration),d={data:[],size:0}),d&&(d.data.push(e.subarray(T,t+188)),d.size+=t+188-T);break;case h:if(i){if(f&&(r=gi(f)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,r);break;case"mp3":this.parseMPEGPES(a,r);break;case"ac3":this.parseAC3PES(a,r)}f={data:[],size:0}}f&&(f.data.push(e.subarray(T,t+188)),f.size+=t+188-T);break;case u:i&&(m&&(r=gi(m))&&this.parseID3PES(o,r),m={data:[],size:0}),m&&(m.data.push(e.subarray(T,t+188)),m.size+=t+188-T);break;case 0:i&&(T+=e[T]+1),_=this._pmtId=ui(e,T);break;case _:{i&&(T+=e[T]+1);const r=fi(e,T,this.typeSupported,n,this.observer);c=r.videoPid,c>0&&(s.pid=c,s.segmentCodec=r.segmentVideoCodec),h=r.audioPid,h>0&&(a.pid=h,a.segmentCodec=r.segmentAudioCodec),u=r.id3Pid,u>0&&(o.pid=u),null===p||g||(I.warn(`MPEG-TS PMT found at ${t} after unknown PID '${p}'. Backtracking to sync byte @${E} to parse all TS packets.`),p=null,t=E-188),g=this.pmtParsed=!0;break}case 17:case 8191:break;default:p=v}}else T++;T>0&&mi(this.observer,new Error(`Found ${T} TS packet/s that do not start with 0x47`)),s.pesData=d,a.pesData=f,o.pesData=m;const S={audioTrack:a,videoTrack:s,id3Track:o,textTrack:l};return i&&this.extractRemainingSamples(S),S}flush(){const{remainderData:e}=this;let t;return this.remainderData=null,t=e?this.demux(e,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:n,id3Track:i,textTrack:r}=e,s=n.pesData,a=t.pesData,o=i.pesData;let l;if(s&&(l=gi(s))?(this.videoParser.parseAVCPES(n,r,l,!0,this._duration),n.pesData=null):n.pesData=s,a&&(l=gi(a))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l);break;case"ac3":this.parseAC3PES(t,l)}t.pesData=null}else null!=a&&a.size&&I.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;o&&(l=gi(o))?(this.parseID3PES(i,l),i.pesData=null):i.pesData=o}demuxSampleAes(e,t,n){const i=this.demux(e,n,!0,!this.config.progressive),r=this.sampleAes=new ci(this.observer,this.config,t);return this.decrypt(i,r)}decrypt(e,t){return new Promise(n=>{const{audioTrack:i,videoTrack:r}=e;i.samples&&"aac"===i.segmentCodec?t.decryptAacSamples(i.samples,0,()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,()=>{n(e)}):n(e)}):r.samples&&t.decryptAvcSamples(r.samples,0,0,()=>{n(e)})})}destroy(){this._duration=0}parseAACPES(e,t){let n=0;const i=this.aacOverFlow;let r,s,a,o=t.data;if(i){this.aacOverFlow=null;const t=i.missing,r=i.sample.unit.byteLength;if(-1===t)o=xe(i.sample.unit,o);else{const s=r-t;i.sample.unit.set(o.subarray(0,t),s),e.samples.push(i.sample),n=i.missing}}for(r=n,s=o.length;r<s-1&&!Wn(o,r);r++);if(r!==n){let e;const t=r<s-1;if(e=t?"AAC PES did not start with ADTS header,offset:"+r:"No ADTS header found in AAC PES",mi(this.observer,new Error(e),t),!t)return}if(jn(e,this.observer,o,r,this.audioCodec),void 0!==t.pts)a=t.pts;else{if(!i)return void I.warn("[tsdemuxer]: AAC PES unknown PTS");{const t=zn(e.samplerate);a=i.sample.pts+t}}let l,c=0;for(;r<s;){if(l=Kn(e,o,r,a,c),r+=l.length,l.missing){this.aacOverFlow=l;break}for(c++;r<s-1&&!Wn(o,r);r++);}}parseMPEGPES(e,t){const n=t.data,i=n.length;let r=0,s=0;const a=t.pts;if(void 0!==a)for(;s<i;)if(ni(n,s)){const t=Jn(e,n,s,a,r);if(!t)break;s+=t.length,r++}else s++;else I.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseAC3PES(e,t){{const n=t.data,i=t.pts;if(void 0===i)return void I.warn("[tsdemuxer]: AC3 PES unknown PTS");const r=n.length;let s,a=0,o=0;for(;o<r&&(s=ai(e,n,o,i,a++))>0;)o+=s}}parseID3PES(e,t){if(void 0===t.pts)return void I.warn("[tsdemuxer]: ID3 PES unknown PTS");const n=m({},t,{type:this._videoTrack?bt.emsg:bt.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(n)}constructor(e,t,n){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=n,this.videoParser=new li}}function hi(e,t){return((31&e[t+1])<<8)+e[t+2]}function ui(e,t){return(31&e[t+10])<<8|e[t+11]}function fi(e,t,n,i,r){const s={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<a;){const a=hi(e,t),o=(15&e[t+3])<<8|e[t+4];switch(e[t]){case 207:if(!i){pi("ADTS AAC");break}case 15:-1===s.audioPid&&(s.audioPid=a);break;case 21:-1===s.id3Pid&&(s.id3Pid=a);break;case 219:if(!i){pi("H.264");break}case 27:-1===s.videoPid&&(s.videoPid=a,s.segmentVideoCodec="avc");break;case 3:case 4:n.mpeg||n.mp3?-1===s.audioPid&&(s.audioPid=a,s.segmentAudioCodec="mp3"):I.log("MPEG audio found, not supported in this browser");break;case 193:if(!i){pi("AC-3");break}case 129:n.ac3?-1===s.audioPid&&(s.audioPid=a,s.segmentAudioCodec="ac3"):I.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===s.audioPid&&o>0){let i=t+5,r=o;for(;r>2;){switch(e[i]){case 106:!0!==n.ac3?I.log("AC-3 audio found, not supported in this browser for now"):(s.audioPid=a,s.segmentAudioCodec="ac3")}const t=e[i+1]+2;i+=t,r-=t}}break;case 194:case 135:return mi(r,new Error("Unsupported EC-3 in M2TS found")),s;case 36:return mi(r,new Error("Unsupported HEVC in M2TS found")),s}t+=o+5}return s}function mi(e,t,n){I.warn("parsing error: "+t.message),e.emit(v.ERROR,v.ERROR,{type:E.MEDIA_ERROR,details:T.FRAG_PARSING_ERROR,fatal:!1,levelRetry:n,error:t,reason:t.message})}function pi(e){I.log(e+" with AES-128-CBC encryption found in unencrypted stream")}function gi(e){let t,n,i,r,s,a=0;const o=e.data;if(!e||0===e.size)return null;for(;o[0].length<19&&o.length>1;)o[0]=xe(o[0],o[1]),o.splice(1,1);if(t=o[0],1===(t[0]<<16)+(t[1]<<8)+t[2]){if(n=(t[4]<<8)+t[5],n&&n>e.size-6)return null;const l=t[7];192&l&&(r=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2,64&l?(s=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2,r-s>54e5&&(I.warn(Math.round((r-s)/9e4)+"s delta between PTS and DTS, align them"),r=s)):s=r),i=t[8];let c=i+9;if(e.size<=c)return null;e.size-=c;const d=new Uint8Array(e.size);for(let e=0,n=o.length;e<n;e++){t=o[e];let n=t.byteLength;if(c){if(c>n){c-=n;continue}t=t.subarray(c),n-=c,c=0}d.set(t,a),a+=n}return n&&(n-=i+3),{data:d,pts:r,dts:s,len:n}}return null}class _i{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const vi=Math.pow(2,32)-1;class Ei{static init(){let e;for(e in Ei.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},Ei.types)Ei.types.hasOwnProperty(e)&&(Ei.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),n=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);Ei.HDLR_TYPES={video:t,audio:n};const i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);Ei.STTS=Ei.STSC=Ei.STCO=r,Ei.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),Ei.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),Ei.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),Ei.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const s=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);Ei.FTYP=Ei.box(Ei.types.ftyp,s,o,s,a),Ei.DINF=Ei.box(Ei.types.dinf,Ei.box(Ei.types.dref,i))}static box(e,...t){let n=8,i=t.length;const r=i;for(;i--;)n+=t[i].byteLength;const s=new Uint8Array(n);for(s[0]=n>>24&255,s[1]=n>>16&255,s[2]=n>>8&255,s[3]=255&n,s.set(e,4),i=0,n=8;i<r;i++)s.set(t[i],n),n+=t[i].byteLength;return s}static hdlr(e){return Ei.box(Ei.types.hdlr,Ei.HDLR_TYPES[e])}static mdat(e){return Ei.box(Ei.types.mdat,e)}static mdhd(e,t){t*=e;const n=Math.floor(t/(vi+1)),i=Math.floor(t%(vi+1));return Ei.box(Ei.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,n>>24,n>>16&255,n>>8&255,255&n,i>>24,i>>16&255,i>>8&255,255&i,85,196,0,0]))}static mdia(e){return Ei.box(Ei.types.mdia,Ei.mdhd(e.timescale,e.duration),Ei.hdlr(e.type),Ei.minf(e))}static mfhd(e){return Ei.box(Ei.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?Ei.box(Ei.types.minf,Ei.box(Ei.types.smhd,Ei.SMHD),Ei.DINF,Ei.stbl(e)):Ei.box(Ei.types.minf,Ei.box(Ei.types.vmhd,Ei.VMHD),Ei.DINF,Ei.stbl(e))}static moof(e,t,n){return Ei.box(Ei.types.moof,Ei.mfhd(e),Ei.traf(n,t))}static moov(e){let t=e.length;const n=[];for(;t--;)n[t]=Ei.trak(e[t]);return Ei.box.apply(null,[Ei.types.moov,Ei.mvhd(e[0].timescale,e[0].duration)].concat(n).concat(Ei.mvex(e)))}static mvex(e){let t=e.length;const n=[];for(;t--;)n[t]=Ei.trex(e[t]);return Ei.box.apply(null,[Ei.types.mvex,...n])}static mvhd(e,t){t*=e;const n=Math.floor(t/(vi+1)),i=Math.floor(t%(vi+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,n>>24,n>>16&255,n>>8&255,255&n,i>>24,i>>16&255,i>>8&255,255&i,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return Ei.box(Ei.types.mvhd,r)}static sdtp(e){const t=e.samples||[],n=new Uint8Array(4+t.length);let i,r;for(i=0;i<t.length;i++)r=t[i].flags,n[i+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return Ei.box(Ei.types.sdtp,n)}static stbl(e){return Ei.box(Ei.types.stbl,Ei.stsd(e),Ei.box(Ei.types.stts,Ei.STTS),Ei.box(Ei.types.stsc,Ei.STSC),Ei.box(Ei.types.stsz,Ei.STSZ),Ei.box(Ei.types.stco,Ei.STCO))}static avc1(e){let t,n,i,r=[],s=[];for(t=0;t<e.sps.length;t++)n=e.sps[t],i=n.byteLength,r.push(i>>>8&255),r.push(255&i),r=r.concat(Array.prototype.slice.call(n));for(t=0;t<e.pps.length;t++)n=e.pps[t],i=n.byteLength,s.push(i>>>8&255),s.push(255&i),s=s.concat(Array.prototype.slice.call(n));const a=Ei.box(Ei.types.avcC,new Uint8Array([1,r[3],r[4],r[5],255,224|e.sps.length].concat(r).concat([e.pps.length]).concat(s))),o=e.width,l=e.height,c=e.pixelRatio[0],d=e.pixelRatio[1];return Ei.box(Ei.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,Ei.box(Ei.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),Ei.box(Ei.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,255&c,d>>24,d>>16&255,d>>8&255,255&d])))}static esds(e){const t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static audioStsd(e){const t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static mp4a(e){return Ei.box(Ei.types.mp4a,Ei.audioStsd(e),Ei.box(Ei.types.esds,Ei.esds(e)))}static mp3(e){return Ei.box(Ei.types[".mp3"],Ei.audioStsd(e))}static ac3(e){return Ei.box(Ei.types["ac-3"],Ei.audioStsd(e),Ei.box(Ei.types.dac3,e.config))}static stsd(e){return"audio"===e.type?"mp3"===e.segmentCodec&&"mp3"===e.codec?Ei.box(Ei.types.stsd,Ei.STSD,Ei.mp3(e)):"ac3"===e.segmentCodec?Ei.box(Ei.types.stsd,Ei.STSD,Ei.ac3(e)):Ei.box(Ei.types.stsd,Ei.STSD,Ei.mp4a(e)):Ei.box(Ei.types.stsd,Ei.STSD,Ei.avc1(e))}static tkhd(e){const t=e.id,n=e.duration*e.timescale,i=e.width,r=e.height,s=Math.floor(n/(vi+1)),a=Math.floor(n%(vi+1));return Ei.box(Ei.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,a>>24,a>>16&255,a>>8&255,255&a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,255&i,0,0,r>>8&255,255&r,0,0]))}static traf(e,t){const n=Ei.sdtp(e),i=e.id,r=Math.floor(t/(vi+1)),s=Math.floor(t%(vi+1));return Ei.box(Ei.types.traf,Ei.box(Ei.types.tfhd,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i])),Ei.box(Ei.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,s>>24,s>>16&255,s>>8&255,255&s])),Ei.trun(e,n.length+16+20+8+16+8+8),n)}static trak(e){return e.duration=e.duration||4294967295,Ei.box(Ei.types.trak,Ei.tkhd(e),Ei.mdia(e))}static trex(e){const t=e.id;return Ei.box(Ei.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const n=e.samples||[],i=n.length,r=12+16*i,s=new Uint8Array(r);let a,o,l,c,d,h;for(t+=8+r,s.set(["video"===e.type?1:0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,255&i,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),a=0;a<i;a++)o=n[a],l=o.duration,c=o.size,d=o.flags,h=o.cts,s.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,c>>>24&255,c>>>16&255,c>>>8&255,255&c,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,61440&d.degradPrio,15&d.degradPrio,h>>>24&255,h>>>16&255,h>>>8&255,255&h],12+16*a);return Ei.box(Ei.types.trun,s)}static initSegment(e){Ei.types||Ei.init();const t=Ei.moov(e);return xe(Ei.FTYP,t)}}function Ti(e,t,n=1,i=!1){const r=e*t*n;return i?Math.round(r):r}function Si(e,t=!1){return Ti(e,1e3,1/9e4,t)}Ei.types=void 0,Ei.HDLR_TYPES=void 0,Ei.STTS=void 0,Ei.STSC=void 0,Ei.STCO=void 0,Ei.STSZ=void 0,Ei.VMHD=void 0,Ei.SMHD=void 0,Ei.STSD=void 0,Ei.FTYP=void 0,Ei.DINF=void 0;let Ai,bi=null,Ii=null;class Ri{destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){I.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){I.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){I.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const n=e[0].pts,i=e.reduce((e,i)=>{let r=i.pts,s=r-e;return s<-4294967296&&(t=!0,r=Ci(r,n),s=r-e),s>0?e:r},n);return t&&I.debug("PTS rollover detected"),i}remux(e,t,n,i,r,s,a,o){let l,c,d,h,u,f,m=r,p=r;const g=e.pid>-1,_=t.pid>-1,v=t.samples.length,E=e.samples.length>0,T=a&&v>0||v>1;if((!g||E)&&(!_||T)||this.ISGenerated||a){if(this.ISGenerated){var S,A,b,R;const e=this.videoTrackConfig;!e||t.width===e.width&&t.height===e.height&&(null==(S=t.pixelRatio)?void 0:S[0])===(null==(A=e.pixelRatio)?void 0:A[0])&&(null==(b=t.pixelRatio)?void 0:b[1])===(null==(R=e.pixelRatio)?void 0:R[1])||this.resetInitSegment()}else d=this.generateIS(e,t,r,s);const n=this.isVideoContiguous;let i,a=-1;if(T&&(a=function(e){for(let t=0;t<e.length;t++)if(e[t].key)return t;return-1}(t.samples),!n&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,a>0){I.warn(`[mp4-remuxer]: Dropped ${a} out of ${v} video samples due to a missing keyframe`);const e=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(a),t.dropped+=a,p+=(t.samples[0].pts-e)/t.inputTimeScale,i=p}else-1===a&&(I.warn(`[mp4-remuxer]: No keyframe found out of ${v} video samples`),f=!1);if(this.ISGenerated){if(E&&T){const n=this.getVideoStartPts(t.samples),i=(Ci(e.samples[0].pts,n)-n)/t.inputTimeScale;m+=Math.max(0,i),p+=Math.max(0,-i)}if(E){if(e.samplerate||(I.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(e,t,r,s)),c=this.remuxAudio(e,m,this.isAudioContiguous,s,_||T||o===mt.AUDIO?p:void 0),T){const i=c?c.endPTS-c.startPTS:0;t.inputTimeScale||(I.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(e,t,r,s)),l=this.remuxVideo(t,p,n,i)}}else T&&(l=this.remuxVideo(t,p,n,0));l&&(l.firstKeyFrame=a,l.independent=-1!==a,l.firstKeyFramePTS=i)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(n.samples.length&&(u=yi(n,r,this._initPTS,this._initDTS)),i.samples.length&&(h=Mi(i,r,this._initPTS))),{audio:c,video:l,initSegment:d,independent:f,text:h,id3:u}}generateIS(e,t,n,i){const r=e.samples,s=t.samples,a=this.typeSupported,o={},l=this._initPTS;let c,d,h,u=!l||i,f="audio/mp4";if(u&&(c=d=1/0),e.config&&r.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(f="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3"}o.audio={id:"audio",container:f,codec:e.codec,initSegment:"mp3"===e.segmentCodec&&a.mpeg?new Uint8Array(0):Ei.initSegment([e]),metadata:{channelCount:e.channelCount}},u&&(h=e.inputTimeScale,l&&h===l.timescale?u=!1:c=d=r[0].pts-Math.round(h*n))}if(t.sps&&t.pps&&s.length){if(t.timescale=t.inputTimeScale,o.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:Ei.initSegment([t]),metadata:{width:t.width,height:t.height}},u)if(h=t.inputTimeScale,l&&h===l.timescale)u=!1;else{const e=this.getVideoStartPts(s),t=Math.round(h*n);d=Math.min(d,Ci(s[0].dts,e)-t),c=Math.min(c,e-t)}this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(o).length)return this.ISGenerated=!0,u?(this._initPTS={baseTime:c,timescale:h},this._initDTS={baseTime:d,timescale:h}):c=h=void 0,{tracks:o,initPTS:c,timescale:h}}remuxVideo(e,t,n,i){const r=e.inputTimeScale,s=e.samples,a=[],o=s.length,l=this._initPTS;let c,d,h=this.nextAvcDts,u=8,f=this.videoSampleDuration,p=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,_=!1;if(!n||null===h){const e=t*r,i=s[0].pts-Ci(s[0].dts,s[0].pts);bi&&null!==h&&Math.abs(e-i-h)<15e3?n=!0:h=e-i}const S=l.baseTime*r/l.timescale;for(let e=0;e<o;e++){const t=s[e];t.pts=Ci(t.pts-S,h),t.dts=Ci(t.dts-S,h),t.dts<s[e>0?e-1:e].dts&&(_=!0)}_&&s.sort((function(e,t){const n=e.dts-t.dts,i=e.pts-t.pts;return n||i})),c=s[0].dts,d=s[s.length-1].dts;const A=d-c,b=A?Math.round(A/(o-1)):f||e.inputTimeScale/30;if(n){const e=c-h,n=e>b,i=e<-1;if((n||i)&&(n?I.warn(`AVC: ${Si(e,!0)} ms (${e}dts) hole between fragments detected at ${t.toFixed(3)}`):I.warn(`AVC: ${Si(-e,!0)} ms (${e}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!i||h>=s[0].pts||bi)){c=h;const t=s[0].pts-e;if(n)s[0].dts=c,s[0].pts=t;else for(let n=0;n<s.length&&!(s[n].dts>t);n++)s[n].dts-=e,s[n].pts-=e;I.log(`Video: Initial PTS/DTS adjusted: ${Si(t,!0)}/${Si(c,!0)}, delta: ${Si(e,!0)} ms`)}}c=Math.max(0,c);let R=0,C=0,y=c;for(let e=0;e<o;e++){const t=s[e],n=t.units,i=n.length;let r=0;for(let e=0;e<i;e++)r+=n[e].data.length;C+=r,R+=i,t.length=r,t.dts<y?(t.dts=y,y+=b/4|0||1):y=t.dts,p=Math.min(t.pts,p),g=Math.max(t.pts,g)}d=s[o-1].dts;const M=C+4*R+8;let O;try{O=new Uint8Array(M)}catch(e){return void this.observer.emit(v.ERROR,v.ERROR,{type:E.MUX_ERROR,details:T.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:M,reason:"fail allocating video mdat "+M})}const x=new DataView(O.buffer);x.setUint32(0,M),O.set(Ei.types.mdat,4);let D=!1,P=Number.POSITIVE_INFINITY,L=Number.POSITIVE_INFINITY,N=Number.NEGATIVE_INFINITY,F=Number.NEGATIVE_INFINITY;for(let e=0;e<o;e++){const t=s[e],n=t.units;let l,c=0;for(let e=0,t=n.length;e<t;e++){const t=n[e],i=t.data,r=t.data.byteLength;x.setUint32(u,r),u+=4,O.set(i,u),u+=r,c+=4+r}if(e<o-1)f=s[e+1].dts-t.dts,l=s[e+1].pts-t.pts;else{const n=this.config,a=e>0?t.dts-s[e-1].dts:b;if(l=e>0?t.pts-s[e-1].pts:b,n.stretchShortVideoTrack&&null!==this.nextAudioPts){const e=Math.floor(n.maxBufferHole*r),s=(i?p+i*r:this.nextAudioPts)-t.pts;s>e?(f=s-a,f<0?f=a:D=!0,I.log(`[mp4-remuxer]: It is approximately ${s/90} ms to the next segment; using duration ${f/90} ms for the last video frame.`)):f=a}else f=a}const d=Math.round(t.pts-t.dts);P=Math.min(P,f),N=Math.max(N,f),L=Math.min(L,l),F=Math.max(F,l),a.push(new Oi(t.key,f,c,d))}if(a.length)if(bi){if(bi<70){const e=a[0].flags;e.dependsOn=2,e.isNonSync=0}}else if(Ii&&F-L<N-P&&b/N<.025&&0===a[0].cts){I.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let e=c;for(let t=0,n=a.length;t<n;t++){const i=e+a[t].duration,r=e+a[t].cts;if(t<n-1){const e=i+a[t+1].cts;a[t].duration=e-r}else a[t].duration=t?a[t-1].duration:b;a[t].cts=0,e=i}}f=D||!f?b:f,this.nextAvcDts=h=d+f,this.videoSampleDuration=f,this.isVideoContiguous=!0;const w={data1:Ei.moof(e.sequenceNumber++,c,m({},e,{samples:a})),data2:O,startPTS:p/r,endPTS:(g+f)/r,startDTS:c/r,endDTS:h/r,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,w}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(e,t,n,i,r){const s=e.inputTimeScale,a=s/(e.samplerate?e.samplerate:s),o=this.getSamplesPerFrame(e),l=o*a,c=this._initPTS,d="mp3"===e.segmentCodec&&this.typeSupported.mpeg,h=[],u=void 0!==r;let f=e.samples,p=d?0:8,g=this.nextAudioPts||-1;const _=t*s,S=c.baseTime*s/c.timescale;if(this.isAudioContiguous=n=n||f.length&&g>0&&(i&&Math.abs(_-g)<9e3||Math.abs(Ci(f[0].pts-S,_)-g)<20*l),f.forEach((function(e){e.pts=Ci(e.pts-S,_)})),!n||g<0){if(f=f.filter(e=>e.pts>=0),!f.length)return;g=0===r?0:i&&!u?Math.max(0,_):f[0].pts}if("aac"===e.segmentCodec){const t=this.config.maxAudioFramesDrift;for(let n=0,i=g;n<f.length;n++){const r=f[n],a=r.pts,o=a-i,c=Math.abs(1e3*o/s);if(o<=-t*l&&u)0===n&&(I.warn(`Audio frame @ ${(a/s).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*o/s)} ms.`),this.nextAudioPts=g=i=a);else if(o>=t*l&&c<1e4&&u){let t=Math.round(o/l);i=a-t*l,i<0&&(t--,i+=l),0===n&&(this.nextAudioPts=g=i),I.warn(`[mp4-remuxer]: Injecting ${t} audio frame @ ${(i/s).toFixed(3)}s due to ${Math.round(1e3*o/s)} ms gap.`);for(let s=0;s<t;s++){const t=Math.max(i,0);let s=_i.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);s||(I.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),s=r.unit.subarray()),f.splice(n,0,{unit:s,pts:t}),i+=l,n++}}r.pts=i,i+=l}}let A,b=null,R=null,C=0,y=f.length;for(;y--;)C+=f[y].unit.byteLength;for(let t=0,i=f.length;t<i;t++){const i=f[t],r=i.unit;let s=i.pts;if(null!==R)h[t-1].duration=Math.round((s-R)/a);else{if(n&&"aac"===e.segmentCodec&&(s=g),b=s,!(C>0))return;C+=p;try{A=new Uint8Array(C)}catch(e){return void this.observer.emit(v.ERROR,v.ERROR,{type:E.MUX_ERROR,details:T.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:C,reason:"fail allocating audio mdat "+C})}d||(new DataView(A.buffer).setUint32(0,C),A.set(Ei.types.mdat,4))}A.set(r,p);const l=r.byteLength;p+=l,h.push(new Oi(!0,o,l,0)),R=s}const M=h.length;if(!M)return;const O=h[h.length-1];this.nextAudioPts=g=R+a*O.duration;const x=d?new Uint8Array(0):Ei.moof(e.sequenceNumber++,b/a,m({},e,{samples:h}));e.samples=[];const D=b/s,P=g/s,L={data1:x,data2:A,startPTS:D,endPTS:P,startDTS:D,endDTS:P,type:"audio",hasAudio:!0,hasVideo:!1,nb:M};return this.isAudioContiguous=!0,L}remuxEmptyAudio(e,t,n,i){const r=e.inputTimeScale,s=r/(e.samplerate?e.samplerate:r),a=this.nextAudioPts,o=this._initDTS,l=9e4*o.baseTime/o.timescale,c=(null!==a?a:i.startDTS*r)+l,d=i.endDTS*r+l,h=1024*s,u=Math.ceil((d-c)/h),f=_i.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(I.warn("[mp4-remuxer]: remux empty Audio"),!f)return void I.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");const m=[];for(let e=0;e<u;e++){const t=c+e*h;m.push({unit:f,pts:t,dts:t})}return e.samples=m,this.remuxAudio(e,t,n,!1)}constructor(e,t,n,i=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=n,this.ISGenerated=!1,null===bi){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);bi=e?parseInt(e[1]):0}if(null===Ii){const e=navigator.userAgent.match(/Safari\/(\d+)/i);Ii=e?parseInt(e[1]):0}}}function Ci(e,t){let n;if(null===t)return e;for(n=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=n;return e}function yi(e,t,n,i){const r=e.samples.length;if(!r)return;const s=e.inputTimeScale;for(let a=0;a<r;a++){const r=e.samples[a];r.pts=Ci(r.pts-n.baseTime*s/n.timescale,t*s)/s,r.dts=Ci(r.dts-i.baseTime*s/i.timescale,t*s)/s}const a=e.samples;return e.samples=[],{samples:a}}function Mi(e,t,n){const i=e.samples.length;if(!i)return;const r=e.inputTimeScale;for(let s=0;s<i;s++){const i=e.samples[s];i.pts=Ci(i.pts-n.baseTime*r/n.timescale,t*r)/r}e.samples.sort((e,t)=>e.pts-t.pts);const s=e.samples;return e.samples=[],{samples:s}}class Oi{constructor(e,t,n,i){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=n,this.cts=i,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:e?2:1,isNonSync:e?0:1}}}function xi(e,t){const n=null==e?void 0:e.codec;if(n&&n.length>4)return n;if("audio"===t){if("ec-3"===n||"ac-3"===n||"alac"===n)return n;if("fLaC"===n||"Opus"===n)return Je(n,!1);const e="mp4a.40.5";return I.info(`Parsed audio codec "${n}" or audio object type not handled. Using "${e}"`),e}return I.warn(`Unhandled video codec "${n}"`),"hvc1"===n||"hev1"===n?"hvc1.1.6.L120.90":"av01"===n?"av01.0.04M.08":"avc1.42e01e"}try{Ai=self.performance.now.bind(self.performance)}catch(e){I.debug("Unable to use Performance API on this environment"),Ai=null==U?void 0:U.Date.now}const Di=[{demux:class{resetTimeStamp(){}resetInitSegment(e,t,n,i){const r=this.videoTrack=Un("video",1),s=this.audioTrack=Un("audio",1),a=this.txtTrack=Un("text",1);if(this.id3Track=Un("id3",1),this.timeOffset=0,null==e||!e.byteLength)return;const o=be(e);if(o.video){const{id:e,timescale:t,codec:n}=o.video;r.id=e,r.timescale=a.timescale=t,r.codec=n}if(o.audio){const{id:e,timescale:t,codec:n}=o.audio;s.id=e,s.timescale=t,s.codec=n}a.id=me.text,r.sampleDuration=0,r.duration=s.duration=i}resetContiguity(){this.remainderData=null}static probe(e){return function(e){const t=e.byteLength;for(let n=0;n<t;){const i=_e(e,n);if(i>8&&109===e[n+4]&&111===e[n+5]&&111===e[n+6]&&102===e[n+7])return!0;n=i>1?n+i:t}return!1}(e)}demux(e,t){this.timeOffset=t;let n=e;const i=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(n=xe(this.remainderData,e));const t=function(e){const t={valid:null,remainder:null},n=Se(e,["moof"]);if(n.length<2)return t.remainder=e,t;const i=n[n.length-1];return t.valid=K(e,0,i.byteOffset-8),t.remainder=K(e,i.byteOffset-8),t}(n);this.remainderData=t.remainder,i.samples=t.valid||new Uint8Array}else i.samples=n;const s=this.extractID3Track(i,t);return r.samples=De(t,i),{videoTrack:i,audioTrack:this.audioTrack,id3Track:s,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,n=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const i=this.extractID3Track(t,this.timeOffset);return n.samples=De(e,t),{videoTrack:t,audioTrack:Un(),id3Track:i,textTrack:Un()}}extractID3Track(e,t){const n=this.id3Track;if(e.samples.length){const i=Se(e.samples,["emsg"]);i&&i.forEach(e=>{const i=function(e){const t=e[0];let n="",i="",r=0,s=0,a=0,o=0,l=0,c=0;if(0===t){for(;"\0"!==pe(e.subarray(c,c+1));)n+=pe(e.subarray(c,c+1)),c+=1;for(n+=pe(e.subarray(c,c+1)),c+=1;"\0"!==pe(e.subarray(c,c+1));)i+=pe(e.subarray(c,c+1)),c+=1;i+=pe(e.subarray(c,c+1)),c+=1,r=_e(e,12),s=_e(e,16),o=_e(e,20),l=_e(e,24),c=28}else if(1===t){c+=4,r=_e(e,c),c+=4;const t=_e(e,c);c+=4;const s=_e(e,c);for(c+=4,a=2**32*t+s,g(a)||(a=Number.MAX_SAFE_INTEGER,I.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=_e(e,c),c+=4,l=_e(e,c),c+=4;"\0"!==pe(e.subarray(c,c+1));)n+=pe(e.subarray(c,c+1)),c+=1;for(n+=pe(e.subarray(c,c+1)),c+=1;"\0"!==pe(e.subarray(c,c+1));)i+=pe(e.subarray(c,c+1)),c+=1;i+=pe(e.subarray(c,c+1)),c+=1}return{schemeIdUri:n,value:i,timeScale:r,presentationTime:a,presentationTimeDelta:s,eventDuration:o,id:l,payload:e.subarray(c,e.byteLength)}}(e);if(ri.test(i.schemeIdUri)){const e=p(i.presentationTime)?i.presentationTime/i.timeScale:t+i.presentationTimeDelta/i.timeScale;let r=4294967295===i.eventDuration?Number.POSITIVE_INFINITY:i.eventDuration/i.timeScale;r<=.001&&(r=Number.POSITIVE_INFINITY);const s=i.payload;n.samples.push({data:s,len:s.byteLength,dts:e,pts:e,type:bt.emsg,duration:r})}})}return n}demuxSampleAes(e,t,n){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}},remux:class{destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,t,n,i){this.audioCodec=t,this.videoCodec=n,this.generateInitSegment(function(e,t){if(!e||!t)return e;const n=t.keyId;return n&&t.isCommonEncryption&&Se(e,["moov","trak"]).forEach(e=>{const t=Se(e,["mdia","minf","stbl","stsd"])[0].subarray(8);let i=Se(t,["enca"]);const r=i.length>0;r||(i=Se(t,["encv"])),i.forEach(e=>{Se(r?e.subarray(28):e.subarray(78),["sinf"]).forEach(e=>{const t=Me(e);if(t){const e=t.subarray(8,24);e.some(e=>0!==e)||(I.log(`[eme] Patching keyId in 'enc${r?"a":"v"}>sinf>>tenc' box: ${he(e)} -> ${he(n)}`),t.set(n,8))}})})}),e}(e,i)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:n}=this;if(null==e||!e.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const i=this.initData=be(e);i.audio&&(t=xi(i.audio,"audio")),i.video&&(n=xi(i.video,"video"));const r={};i.audio&&i.video?r.audiovideo={container:"video/mp4",codec:t+","+n,initSegment:e,id:"main"}:i.audio?r.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:i.video?r.video={container:"video/mp4",codec:n,initSegment:e,id:"main"}:I.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(e,t,n,i,r,s){var a,o;let{initPTS:l,lastEndTime:c}=this;const d={audio:void 0,video:void 0,text:i,id3:n,initSegment:void 0};p(c)||(c=this.lastEndTime=r||0);const h=t.samples;if(null==h||!h.length)return d;const u={initPTS:void 0,timescale:1};let f=this.initData;if(null!=(a=f)&&a.length||(this.generateInitSegment(h),f=this.initData),null==(o=f)||!o.length)return I.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),d;this.emitInitSegment&&(u.tracks=this.initTracks,this.emitInitSegment=!1);const m=function(e,t){let n=0,i=0,r=0;const s=Se(e,["moof","traf"]);for(let e=0;e<s.length;e++){const a=s[e],o=Se(a,["tfhd"])[0],l=t[_e(o,4)];if(!l)continue;const c=l.default,d=_e(o,0)|(null==c?void 0:c.flags);let h=null==c?void 0:c.duration;8&d&&(h=_e(o,2&d?12:8));const u=l.timescale||9e4,f=Se(a,["trun"]);for(let e=0;e<f.length;e++)n=Oe(f[e]),!n&&h&&(n=h*_e(f[e],4)),"video"===l.type?i+=n/u:"audio"===l.type&&(r+=n/u)}if(0===i&&0===r){let t=1/0,n=0,i=0;const r=Se(e,["sidx"]);for(let e=0;e<r.length;e++){const s=Ae(r[e]);if(null!=s&&s.references){t=Math.min(t,s.earliestPresentationTime/s.timescale);const e=s.references.reduce((e,t)=>e+t.info.duration||0,0);n=Math.max(n,e+s.earliestPresentationTime/s.timescale),i=n-t}}if(i&&p(i))return i}return i||r}(h,f),g=function(e,t){return Se(t,["moof","traf"]).reduce((t,n)=>{const i=Se(n,["tfdt"])[0],r=i[0],s=Se(n,["tfhd"]).reduce((t,n)=>{const s=_e(n,4),a=e[s];if(a){let e=_e(i,4);if(1===r){if(e===ue)return I.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),t;e*=ue+1,e+=_e(i,8)}const n=e/(a.timescale||9e4);if(p(n)&&(null===t||n<t))return n}return t},null);return null!==s&&p(s)&&(null===t||s<t)?s:t},null)}(f,h),_=null===g?r:g;(function(e,t,n,i){if(null===e)return!0;const r=Math.max(i,1),s=t-e.baseTime/e.timescale;return Math.abs(s-n)>r}(l,_,r,m)||u.timescale!==l.timescale&&s)&&(u.initPTS=_-r,l&&1===l.timescale&&I.warn("Adjusting initPTS by "+(u.initPTS-l.baseTime)),this.initPTS=l={baseTime:u.initPTS,timescale:1});const v=e?_-l.baseTime/l.timescale:c,E=v+m;!function(e,t,n){Se(t,["moof","traf"]).forEach(t=>{Se(t,["tfhd"]).forEach(i=>{const r=_e(i,4),s=e[r];if(!s)return;const a=s.timescale||9e4;Se(t,["tfdt"]).forEach(e=>{const t=e[0],i=n*a;if(i){let n=_e(e,4);if(0===t)n-=i,n=Math.max(n,0),Te(e,4,n);else{n*=Math.pow(2,32),n+=_e(e,8),n-=i,n=Math.max(n,0);const t=Math.floor(n/(ue+1)),r=Math.floor(n%(ue+1));Te(e,4,t),Te(e,8,r)}}})})})}(f,h,l.baseTime/l.timescale),m>0?this.lastEndTime=E:(I.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const T=!!f.audio,S=!!f.video;let A="";T&&(A+="audio"),S&&(A+="video");const b={data1:h,startPTS:v,startDTS:v,endPTS:E,endDTS:E,type:A,hasAudio:T,hasVideo:S,nb:1,dropped:0};return d.audio="audio"===b.type?b:void 0,d.video="audio"!==b.type?b:void 0,d.initSegment=u,d.id3=yi(n,r,l,l),i.samples.length&&(d.text=Mi(i,r,l)),d}constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}}},{demux:di,remux:Ri},{demux:class extends Bn{resetInitSegment(e,t,n,i){super.resetInitSegment(e,t,n,i),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=Q(e,0);let n=(null==t?void 0:t.length)||0;if(ii(e,n))return!1;for(let t=e.length;n<t;n++)if(Xn(e,n))return I.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return function(e,t){return t+5<e.length}(e,t)&&Vn(e,t)&&Hn(e,t)<=e.length-t}(e,t)}appendFrame(e,t,n){jn(e,this.observer,t,n,e.manifestCodec);const i=Kn(e,t,n,this.basePTS,this.frameIndex);if(i&&0===i.missing)return i}constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}},remux:Ri},{demux:class extends Bn{resetInitSegment(e,t,n,i){super.resetInitSegment(e,t,n,i),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=Q(e,0);let n=(null==t?void 0:t.length)||0;if(t&&11===e[n]&&119===e[n+1]&&void 0!==J(t)&&si(e,n)<=16)return!1;for(let t=e.length;n<t;n++)if(ii(e,n))return I.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return ti(e,t)&&4<=e.length-t}(e,t)}appendFrame(e,t,n){if(null!==this.basePTS)return Jn(e,t,n,this.basePTS,this.frameIndex)}},remux:Ri}];Di.splice(2,0,{demux:class extends Bn{resetInitSegment(e,t,n,i){super.resetInitSegment(e,t,n,i),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,n){const i=ai(e,t,n,this.basePTS,this.frameIndex);if(-1!==i)return{sample:e.samples[e.samples.length-1],length:i,missing:0}}static probe(e){if(!e)return!1;const t=Q(e,0);if(!t)return!1;const n=t.length;return 11===e[n]&&119===e[n+1]&&void 0!==J(t)&&si(e,n)<16}constructor(e){super(),this.observer=void 0,this.observer=e}},remux:Ri});class Pi{configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,n,i){const r=n.transmuxing;r.executeStart=Ai();let s=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:o}=this;i&&(this.currentTransmuxState=i);const{contiguous:l,discontinuity:c,trackSwitch:d,accurateTimeOffset:h,timeOffset:u,initSegmentChange:f}=i||a,{audioCodec:m,videoCodec:p,defaultInitPts:g,duration:_,initSegmentData:S}=o,A=function(e,t){let n=null;return e.byteLength>0&&null!=(null==t?void 0:t.key)&&null!==t.iv&&null!=t.method&&(n=t),n}(s,t);if(A&&"AES-128"===A.method){const e=this.getDecrypter();if(!e.isSync())return this.decryptionPromise=e.webCryptoDecrypt(s,A.key.buffer,A.iv.buffer).then(e=>{const t=this.push(e,null,n);return this.decryptionPromise=null,t}),this.decryptionPromise;{let t=e.softwareDecrypt(s,A.key.buffer,A.iv.buffer);if(n.part>-1&&(t=e.flush()),!t)return r.executeEnd=Ai(),Li(n);s=new Uint8Array(t)}}const b=this.needsProbing(c,d);if(b){const e=this.configureTransmuxer(s);if(e)return I.warn("[transmuxer] "+e.message),this.observer.emit(v.ERROR,v.ERROR,{type:E.MEDIA_ERROR,details:T.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message}),r.executeEnd=Ai(),Li(n)}(c||d||f||b)&&this.resetInitSegment(S,m,p,_,t),(c||f||b)&&this.resetInitialTimestamp(g),l||this.resetContiguity();const R=this.transmux(s,A,u,h,n),C=this.currentTransmuxState;return C.contiguous=!0,C.discontinuity=!1,C.trackSwitch=!1,r.executeEnd=Ai(),R}flush(e){const t=e.transmuxing;t.executeStart=Ai();const{decrypter:n,currentTransmuxState:i,decryptionPromise:r}=this;if(r)return r.then(()=>this.flush(e));const s=[],{timeOffset:a}=i;if(n){const t=n.flush();t&&s.push(this.push(t,null,e))}const{demuxer:o,remuxer:l}=this;if(!o||!l)return t.executeEnd=Ai(),[Li(e)];const c=o.flush(a);return Ni(c)?c.then(t=>(this.flushRemux(s,t,e),s)):(this.flushRemux(s,c,e),s)}flushRemux(e,t,n){const{audioTrack:i,videoTrack:r,id3Track:s,textTrack:a}=t,{accurateTimeOffset:o,timeOffset:l}=this.currentTransmuxState;I.log(`[transmuxer.ts]: Flushed fragment ${n.sn}${n.part>-1?" p: "+n.part:""} of level ${n.level}`);const c=this.remuxer.remux(i,r,s,a,l,o,!0,this.id);e.push({remuxResult:c,chunkMeta:n}),n.transmuxing.executeEnd=Ai()}resetInitialTimestamp(e){const{demuxer:t,remuxer:n}=this;t&&n&&(t.resetTimeStamp(e),n.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;e&&t&&(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,n,i,r){const{demuxer:s,remuxer:a}=this;s&&a&&(s.resetInitSegment(e,t,n,i),a.resetInitSegment(e,t,n,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,n,i,r){let s;return s=t&&"SAMPLE-AES"===t.method?this.transmuxSampleAes(e,t,n,i,r):this.transmuxUnencrypted(e,n,i,r),s}transmuxUnencrypted(e,t,n,i){const{audioTrack:r,videoTrack:s,id3Track:a,textTrack:o}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,s,a,o,t,n,!1,this.id),chunkMeta:i}}transmuxSampleAes(e,t,n,i,r){return this.demuxer.demuxSampleAes(e,t,n).then(e=>({remuxResult:this.remuxer.remux(e.audioTrack,e.videoTrack,e.id3Track,e.textTrack,n,i,!1,this.id),chunkMeta:r}))}configureTransmuxer(e){const{config:t,observer:n,typeSupported:i,vendor:r}=this;let s;for(let t=0,n=Di.length;t<n;t++){var a;if(null!=(a=Di[t].demux)&&a.probe(e)){s=Di[t];break}}if(!s)return new Error("Failed to find demuxer by probing fragment data");const o=this.demuxer,l=this.remuxer,c=s.remux,d=s.demux;l&&l instanceof c||(this.remuxer=new c(n,t,i,r)),o&&o instanceof d||(this.demuxer=new d(n,t,i),this.probe=d.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new Nn(this.config)),e}constructor(e,t,n,i,r){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=n,this.vendor=i,this.id=r}}const Li=e=>({remuxResult:{},chunkMeta:e});function Ni(e){return"then"in e&&e.then instanceof Function}class Fi{constructor(e,t,n,i,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=n,this.duration=i,this.defaultInitPts=r||null}}class wi{constructor(e,t,n,i,r,s){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=n,this.trackSwitch=i,this.timeOffset=r,this.initSegmentChange=s}}var Ui={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function i(){}function r(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,i,s,a){if("function"!=typeof i)throw new TypeError("The listener must be a function");var o=new r(i,s||e,a),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new i:delete e._events[t]}function o(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,i,r=[];if(0===this._eventsCount)return r;for(i in e=this._events)t.call(e,i)&&r.push(n?i.slice(1):i);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},o.prototype.listeners=function(e){var t=n?n+e:e,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var r=0,s=i.length,a=new Array(s);r<s;r++)a[r]=i[r].fn;return a},o.prototype.listenerCount=function(e){var t=n?n+e:e,i=this._events[t];return i?i.fn?1:i.length:0},o.prototype.emit=function(e,t,i,r,s,a){var o=n?n+e:e;if(!this._events[o])return!1;var l,c,d=this._events[o],h=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),h){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,i),!0;case 4:return d.fn.call(d.context,t,i,r),!0;case 5:return d.fn.call(d.context,t,i,r,s),!0;case 6:return d.fn.call(d.context,t,i,r,s,a),!0}for(c=1,l=new Array(h-1);c<h;c++)l[c-1]=arguments[c];d.fn.apply(d.context,l)}else{var u,f=d.length;for(c=0;c<f;c++)switch(d[c].once&&this.removeListener(e,d[c].fn,void 0,!0),h){case 1:d[c].fn.call(d[c].context);break;case 2:d[c].fn.call(d[c].context,t);break;case 3:d[c].fn.call(d[c].context,t,i);break;case 4:d[c].fn.call(d[c].context,t,i,r);break;default:if(!l)for(u=1,l=new Array(h-1);u<h;u++)l[u-1]=arguments[u];d[c].fn.apply(d[c].context,l)}}return!0},o.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,i,r){var s=n?n+e:e;if(!this._events[s])return this;if(!t)return a(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||r&&!o.once||i&&o.context!==i||a(this,s);else{for(var l=0,c=[],d=o.length;l<d;l++)(o[l].fn!==t||r&&!o[l].once||i&&o[l].context!==i)&&c.push(o[l]);c.length?this._events[s]=1===c.length?c[0]:c:a(this,s)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(Ui);var Bi=i(Ui.exports);class ki{resetWorker(){if(this.workerContext){const{worker:e,objectURL:t}=this.workerContext;t&&self.URL.revokeObjectURL(t),e.removeEventListener("message",this.onwmsg),e.onerror=null,e.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(e,t,n,i,r,s,a,o,l,c){var d,h;l.transmuxing.start=self.performance.now();const{transmuxer:u}=this,f=s?s.start:r.start,m=r.decryptdata,p=this.frag,g=!(p&&r.cc===p.cc),_=!(p&&l.level===p.level),v=p?l.sn-p.sn:-1,E=this.part?l.part-this.part.index:-1,T=0===v&&l.id>1&&l.id===(null==p?void 0:p.stats.chunkCount),S=!_&&(1===v||0===v&&(1===E||T&&E<=0)),A=self.performance.now();(_||v||0===r.stats.parsing.start)&&(r.stats.parsing.start=A),!s||!E&&S||(s.stats.parsing.start=A);const b=!(p&&(null==(d=r.initSegment)?void 0:d.url)===(null==(h=p.initSegment)?void 0:h.url)),R=new wi(g,S,o,_,f,b);if(!S||g||b){I.log(`[transmuxer-interface, ${r.type}]: Starting new transmux session for sn: ${l.sn} p: ${l.part} level: ${l.level} id: ${l.id}\n        discontinuity: ${g}\n        trackSwitch: ${_}\n        contiguous: ${S}\n        accurateTimeOffset: ${o}\n        timeOffset: ${f}\n        initSegmentChange: ${b}`);const e=new Fi(n,i,t,a,c);this.configureTransmuxer(e)}if(this.frag=r,this.part=s,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:e,decryptdata:m,chunkMeta:l,state:R},e instanceof ArrayBuffer?[e]:[]);else if(u){const t=u.push(e,m,l,R);Ni(t)?(u.async=!0,t.then(e=>{this.handleTransmuxComplete(e)}).catch(e=>{this.transmuxerError(e,l,"transmuxer-interface push error")})):(u.async=!1,this.handleTransmuxComplete(t))}}flush(e){e.transmuxing.start=self.performance.now();const{transmuxer:t}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:e});else if(t){let n=t.flush(e);Ni(n)||t.async?(Ni(n)||(n=Promise.resolve(n)),n.then(t=>{this.handleFlushResult(t,e)}).catch(t=>{this.transmuxerError(t,e,"transmuxer-interface flush error")})):this.handleFlushResult(n,e)}}transmuxerError(e,t,n){this.hls&&(this.error=e,this.hls.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,fatal:!1,error:e,err:e,reason:n}))}handleFlushResult(e,t){e.forEach(e=>{this.handleTransmuxComplete(e)}),this.onFlush(t)}onWorkerMessage(e){const t=e.data;if(null==t||!t.event)return void I.warn("worker message received with no "+(t?"event name":"data"));const n=this.hls;if(this.hls)switch(t.event){case"init":{var i;const e=null==(i=this.workerContext)?void 0:i.objectURL;e&&self.URL.revokeObjectURL(e);break}case"transmuxComplete":this.handleTransmuxComplete(t.data);break;case"flush":this.onFlush(t.data);break;case"workerLog":I[t.data.logType]&&I[t.data.logType](t.data.message);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,n.trigger(t.event,t.data)}}configureTransmuxer(e){const{transmuxer:t}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:e}):t&&t.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}constructor(e,t,n,i){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const r=e.config;this.hls=e,this.id=t,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=n,this.onFlush=i;const s=(e,t)=>{(t=t||{}).frag=this.frag,t.id=this.id,e===v.ERROR&&(this.error=t.error),this.hls.trigger(e,t)};this.observer=new Bi,this.observer.on(v.FRAG_DECRYPTED,s),this.observer.on(v.ERROR,s);const a=Xe(r.preferManagedMediaSource)||{isTypeSupported:()=>!1},o={mpeg:a.isTypeSupported("audio/mpeg"),mp3:a.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:a.isTypeSupported('audio/mp4; codecs="ac-3"')};if(!this.useWorker||"undefined"==typeof Worker||!r.workerPath&&"function"!=typeof __HLS_WORKER_BUNDLE__)this.transmuxer=new Pi(this.observer,o,r,"",t);else try{r.workerPath?(I.log(`loading Web Worker ${r.workerPath} for "${t}"`),this.workerContext=function(e){const t=new self.URL(e,self.location.href).href;return{worker:new self.Worker(t),scriptURL:t}}(r.workerPath)):(I.log(`injecting Web Worker for "${t}"`),this.workerContext=function(){const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e);return{worker:new self.Worker(t),objectURL:t}}()),this.onwmsg=e=>this.onWorkerMessage(e);const{worker:e}=this.workerContext;e.addEventListener("message",this.onwmsg),e.onerror=e=>{const n=new Error(`${e.message}  (${e.filename}:${e.lineno})`);r.enableWorker=!1,I.warn(`Error in "${t}" Web Worker, fallback to inline`),this.hls.trigger(v.ERROR,{type:E.OTHER_ERROR,details:T.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:n})},e.postMessage({cmd:"init",typeSupported:o,vendor:"",id:t,config:JSON.stringify(r)})}catch(e){I.warn(`Error setting up "${t}" Web Worker, fallback to inline`,e),this.resetWorker(),this.error=null,this.transmuxer=new Pi(this.observer,o,r,"",t)}}}class Vi extends Fn{onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:e}=this;e.on(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.LEVEL_LOADED,this.onLevelLoaded,this),e.on(v.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(v.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(v.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(v.ERROR,this.onError,this),e.on(v.BUFFER_RESET,this.onBufferReset,this),e.on(v.BUFFER_CREATED,this.onBufferCreated,this),e.on(v.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(v.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(v.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(v.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.LEVEL_LOADED,this.onLevelLoaded,this),e.off(v.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(v.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(v.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(v.ERROR,this.onError,this),e.off(v.BUFFER_RESET,this.onBufferReset,this),e.off(v.BUFFER_CREATED,this.onBufferCreated,this),e.off(v.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(v.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(v.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(v.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(e,{frag:t,id:n,initPTS:i,timescale:r}){if("main"===n){const e=t.cc;this.initPTS[t.cc]={baseTime:i,timescale:r},this.log(`InitPTS for cc: ${e} found from main: ${i}`),this.videoTrackCC=e,"WAITING_INIT_PTS"===this.state&&this.tick()}}startLoad(e){if(!this.levels)return this.startPosition=e,void(this.state="STOPPED");const t=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),t>0&&-1===e?(this.log("Override startPosition with lastCurrentTime @"+t.toFixed(3)),e=t,this.state="IDLE"):(this.loadedmetadata=!1,this.state="WAITING_TRACK"),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}doTick(){switch(this.state){case"IDLE":this.doTickIdle();break;case"WAITING_TRACK":{var e;const{levels:t,trackId:n}=this,i=null==t||null==(e=t[n])?void 0:e.details;if(i){if(this.waitForCdnTuneIn(i))break;this.state="WAITING_INIT_PTS"}break}case"FRAG_LOADING_WAITING_RETRY":{var t;const e=performance.now(),n=this.retryDate;if(!n||e>=n||null!=(t=this.media)&&t.seeking){const{levels:e,trackId:t}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==e?void 0:e[t])||null),this.state="IDLE"}break}case"WAITING_INIT_PTS":{const e=this.waitingData;if(e){const{frag:t,part:n,cache:i,complete:r}=e;if(void 0!==this.initPTS[t.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state="FRAG_LOADING";const e={frag:t,part:n,payload:i.flush(),networkDetails:null};this._handleFragmentLoadProgress(e),r&&super._handleFragmentLoadComplete(e)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${t.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const e=this.getLoadPosition(),n=Tn.bufferInfo(this.mediaBuffer,e,this.config.maxBufferHole);Zt(n.end,this.config.maxFragLookUpTolerance,t)<0&&(this.log(`Waiting fragment cc (${t.cc}) @ ${t.start} cancelled because another fragment at ${n.end} is needed`),this.clearWaitingFragment())}}else this.state="IDLE"}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state="IDLE")}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;null!=e&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){const{hls:e,levels:t,media:n,trackId:i}=this,r=e.config;if(!this.buffering||!n&&(this.startFragRequested||!r.startFragPrefetch)||null==t||!t[i])return;const s=t[i],a=s.details;if(!a||a.live&&this.levelLastLoaded!==s||this.waitForCdnTuneIn(a))return void(this.state="WAITING_TRACK");const o=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&o&&(this.bufferFlushed=!1,this.afterBufferFlushed(o,"audio",mt.AUDIO));const l=this.getFwdBufferInfo(o,mt.AUDIO);if(null===l)return;if(!this.switchingTrack&&this._streamEnded(l,a))return e.trigger(v.BUFFER_EOS,{type:"audio"}),void(this.state="ENDED");const c=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,mt.MAIN),d=l.len,h=this.getMaxBufferLength(null==c?void 0:c.len),u=a.fragments,f=u[0].start,m=this.getLoadPosition(),p=this.flushing?m:l.end;if(this.switchingTrack&&n){const e=m;a.PTSKnown&&e<f&&(l.end>f||l.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),n.currentTime=f+.05)}if(d>=h&&!this.switchingTrack&&p<u[u.length-1].start)return;let g=this.getNextFragment(p,a),_=!1;if(g&&this.isLoopLoading(g,p)&&(_=!!g.gap,g=this.getNextFragmentLoopLoading(g,a,l,mt.MAIN,h)),!g)return void(this.bufferFlushed=!0);const E=c&&g.start>c.end+a.targetduration;if(E||(null==c||!c.len)&&l.len){const e=this.getAppendedFrag(g.start,mt.MAIN);if(null===e)return;if(_||(_=!!e.gap||!!E&&0===c.len),E&&!_||_&&l.nextStart&&l.nextStart<e.end)return}this.loadFragment(g,s,p)}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.min(Math.max(t,e),this.config.maxMaxBufferLength):t}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(e=>new Ft(e))}onAudioTrackSwitching(e,t){const n=!!t.url;this.trackId=t.id;const{fragCurrent:i}=this;i&&(i.abortRequests(),this.removeUnbufferedFrags(i.start)),this.resetLoadingState(),n?this.setInterval(100):this.resetTransmuxer(),n?(this.switchingTrack=t,this.state="IDLE",this.flushAudioIfNeeded(t)):(this.switchingTrack=null,this.bufferedTrack=t,this.state="STOPPED"),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(e,t){this.mainDetails=t.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(v.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(e,t){var n;if(null==this.mainDetails)return void(this.cachedTrackLoadedData=t);const{levels:i}=this,{details:r,id:s}=t;if(!i)return void this.warn("Audio tracks were reset while loading level "+s);this.log(`Audio track ${s} loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);const a=i[s];let o=0;if(r.live||null!=(n=a.details)&&n.live){this.checkLiveUpdate(r);const e=this.mainDetails;if(r.deltaUpdateFailed||!e)return;var l;!a.details&&r.hasProgramDateTime&&e.hasProgramDateTime?(Rn(r,e),o=r.fragments[0].start):o=this.alignPlaylists(r,a.details,null==(l=this.levelLastLoaded)?void 0:l.details)}a.details=r,this.levelLastLoaded=a,this.startFragRequested||!this.mainDetails&&r.live||this.setStartPosition(this.mainDetails||r,o),"WAITING_TRACK"!==this.state||this.waitForCdnTuneIn(r)||(this.state="IDLE"),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:n,part:i,payload:r}=e,{config:s,trackId:a,levels:o}=this;if(!o)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${n.sn} of level ${n.level} will not be buffered`);const l=o[a];if(!l)return void this.warn("Audio track is undefined on fragment load progress");const c=l.details;if(!c)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(n.start);const d=s.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let h=this.transmuxer;h||(h=this.transmuxer=new ki(this.hls,mt.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const u=this.initPTS[n.cc],f=null==(t=n.initSegment)?void 0:t.data;if(void 0!==u){const e=!1,t=i?i.index:-1,s=-1!==t,a=new Sn(n.level,n.sn,n.stats.chunkCount,r.byteLength,t,s);h.push(r,f,d,"",n,i,c.totalduration,e,a,u)}else{this.log(`Unknown video PTS for cc ${n.cc}, waiting for video PTS before demuxing audio frag ${n.sn} of [${c.startSN} ,${c.endSN}],track ${a}`);const{cache:e}=this.waitingData=this.waitingData||{frag:n,part:i,cache:new wn,complete:!1};e.push(new Uint8Array(r)),this.waitingVideoCC=this.videoTrackCC,this.state="WAITING_INIT_PTS"}}_handleFragmentLoadComplete(e){this.waitingData?this.waitingData.complete=!0:super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(e,t){const n=t.tracks.audio;n&&(this.mediaBuffer=n.buffer||null),t.tracks.video&&(this.videoBuffer=t.tracks.video.buffer||null)}onFragBuffered(e,t){const{frag:n,part:i}=t;if(n.type===mt.AUDIO)if(this.fragContextChanged(n))this.warn(`Fragment ${n.sn}${i?" p: "+i.index:""} of level ${n.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);else{if("initSegment"!==n.sn){this.fragPrevious=n;const e=this.switchingTrack;e&&(this.bufferedTrack=e,this.switchingTrack=null,this.hls.trigger(v.AUDIO_TRACK_SWITCHED,u({},e)))}this.fragBufferedComplete(n,i)}else if(!this.loadedmetadata&&n.type===mt.MAIN){const e=this.videoBuffer||this.media;e&&Tn.getBuffered(e).length&&(this.loadedmetadata=!0)}}onError(e,t){var n;if(t.fatal)this.state="ERROR";else switch(t.details){case T.FRAG_GAP:case T.FRAG_PARSING_ERROR:case T.FRAG_DECRYPT_ERROR:case T.FRAG_LOAD_ERROR:case T.FRAG_LOAD_TIMEOUT:case T.KEY_LOAD_ERROR:case T.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(mt.AUDIO,t);break;case T.AUDIO_TRACK_LOAD_ERROR:case T.AUDIO_TRACK_LOAD_TIMEOUT:case T.LEVEL_PARSING_ERROR:t.levelRetry||"WAITING_TRACK"!==this.state||"audioTrack"!==(null==(n=t.context)?void 0:n.type)||(this.state="IDLE");break;case T.BUFFER_APPEND_ERROR:case T.BUFFER_FULL_ERROR:if(!t.parent||"audio"!==t.parent)return;if(t.details===T.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case T.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}onBufferFlushing(e,{type:t}){"video"!==t&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if("video"!==t){this.flushing=!1,this.bufferFlushed=!0,"ENDED"===this.state&&(this.state="IDLE");const e=this.mediaBuffer||this.media;e&&(this.afterBufferFlushed(e,t,mt.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const n="audio",{hls:i}=this,{remuxResult:r,chunkMeta:s}=e,a=this.getCurrentContext(s);if(!a)return void this.resetWhenMissingContext(s);const{frag:o,part:l,level:c}=a,{details:d}=c,{audio:h,text:u,id3:f,initSegment:p}=r;if(!this.fragContextChanged(o)&&d){if(this.state="PARSING",this.switchingTrack&&h&&this.completeAudioSwitch(this.switchingTrack),null!=p&&p.tracks){const e=o.initSegment||o;this._bufferInitSegment(c,p.tracks,e,s),i.trigger(v.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:n,tracks:p.tracks})}if(h){const{startPTS:e,endPTS:t,startDTS:n,endDTS:i}=h;l&&(l.elementaryStreams.audio={startPTS:e,endPTS:t,startDTS:n,endDTS:i}),o.setElementaryStreamInfo("audio",e,t,n,i),this.bufferFragmentData(h,o,l,s)}if(null!=f&&null!=(t=f.samples)&&t.length){const e=m({id:n,frag:o,details:d},f);i.trigger(v.FRAG_PARSING_METADATA,e)}if(u){const e=m({id:n,frag:o,details:d},u);i.trigger(v.FRAG_PARSING_USERDATA,e)}}else this.fragmentTracker.removeFragment(o)}_bufferInitSegment(e,t,n,i){if("PARSING"!==this.state)return;t.video&&delete t.video;const r=t.audio;if(!r)return;r.id="audio";const s=e.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${s}/${r.codec}]`),s&&1===s.split(",").length&&(r.levelCodec=s),this.hls.trigger(v.BUFFER_CODECS,t);const a=r.initSegment;if(null!=a&&a.byteLength){const e={type:"audio",frag:n,part:null,chunkMeta:i,parent:n.type,data:a};this.hls.trigger(v.BUFFER_APPENDING,e)}this.tickImmediate()}loadFragment(e,t,n){const i=this.fragmentTracker.getState(e);var r;if(this.fragCurrent=e,this.switchingTrack||"NOT_LOADED"===i||"PARTIAL"===i)if("initSegment"===e.sn)this._loadInitSegment(e,t);else if(null!=(r=t.details)&&r.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state="WAITING_INIT_PTS";const n=this.mainDetails;n&&n.fragments[0].start!==t.details.fragments[0].start&&Rn(t.details,n)}else this.startFragRequested=!0,super.loadFragment(e,t,n);else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:n,assocLang:i,characteristics:r,audioCodec:s,channels:a}=this.bufferedTrack;un({name:t,lang:n,assocLang:i,characteristics:r,audioCodec:s,channels:a},e,fn)||(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(v.AUDIO_TRACK_SWITCHED,u({},e))}constructor(e,t,n){super(e,t,n,"[audio-stream-controller]",mt.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}}function Gi(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Hi(e[n].attrs,t[n].attrs))return!1;return!0}function Hi(e,t,n){const i=e["STABLE-RENDITION-ID"];return i&&!n?i===t["STABLE-RENDITION-ID"]:!(n||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(n=>e[n]!==t[n])}function Wi(e,t){return t.label.toLowerCase()===e.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(e.lang||"").toLowerCase())}class Xi extends nn{registerListeners(){const{hls:e}=this;e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.MANIFEST_PARSED,this.onManifestParsed,this),e.on(v.LEVEL_LOADING,this.onLevelLoading,this),e.on(v.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(v.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(v.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.MANIFEST_PARSED,this.onManifestParsed,this),e.off(v.LEVEL_LOADING,this.onLevelLoading,this),e.off(v.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(v.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(v.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:n,groupId:i,details:r}=t,s=this.tracksInGroup[n];if(!s||s.groupId!==i)return void this.warn(`Audio track with id:${n} and group:${i} not found in active group ${null==s?void 0:s.groupId}`);const a=s.details;s.details=t.details,this.log(`Audio track ${n} "${s.name}" lang:${s.lang} group:${i} loaded [${r.startSN}-${r.endSN}]`),n===this.trackId&&this.playlistLoaded(n,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const n=t.audioGroups||null,i=this.groupIds;let r=this.currentTrack;if(!n||(null==i?void 0:i.length)!==(null==n?void 0:n.length)||null!=n&&n.some(e=>-1===(null==i?void 0:i.indexOf(e)))){this.groupIds=n,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter(e=>!n||-1!==n.indexOf(e.groupId));if(e.length)this.selectDefaultTrack&&!e.some(e=>e.default)&&(this.selectDefaultTrack=!1),e.forEach((e,t)=>{e.id=t});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.audioPreference;if(!r&&t){const n=hn(t,e,fn);if(n>-1)r=e[n];else{const e=hn(t,this.tracks);r=this.tracks[e]}}let i=this.findTrackId(r);-1===i&&r&&(i=this.findTrackId(null));const a={audioTracks:e};this.log(`Updating audio tracks, ${e.length} track(s) found in group(s): ${null==n?void 0:n.join(",")}`),this.hls.trigger(v.AUDIO_TRACKS_UPDATED,a);const o=this.trackId;if(-1!==i&&-1===o)this.setAudioTrack(i);else if(e.length&&-1===o){var s;const t=new Error(`No audio track selected for current audio group-ID(s): ${null==(s=this.groupIds)?void 0:s.join(",")} track count: ${e.length}`);this.warn(t.message),this.hls.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:t})}}else this.shouldReloadPlaylist(r)&&this.setAudioTrack(this.trackId)}onError(e,t){!t.fatal&&t.context&&("audioTrack"!==t.context.type||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||(this.requestScheduled=-1,this.checkRetry(t)))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const n=this.allAudioTracks;if(this.selectDefaultTrack=!1,n.length){const i=this.currentTrack;if(i&&un(e,i,fn))return i;const r=hn(e,this.tracksInGroup,fn);if(r>-1){const e=this.tracksInGroup[r];return this.setAudioTrack(r),e}if(i){let i=t.loadLevel;-1===i&&(i=t.firstAutoLevel);const r=function(e,t,n,i,r){const s=t[i],a=t.reduce((e,t,n)=>{const i=t.uri;return(e[i]||(e[i]=[])).push(n),e},{})[s.uri];a.length>1&&(i=Math.max.apply(Math,a));const o=s.videoRange,l=s.frameRate,c=s.codecSet.substring(0,4),d=mn(t,i,t=>{if(t.videoRange!==o||t.frameRate!==l||t.codecSet.substring(0,4)!==c)return!1;const i=t.audioGroups,s=n.filter(e=>!i||-1!==i.indexOf(e.groupId));return hn(e,s,r)>-1});return d>-1?d:mn(t,i,t=>{const i=t.audioGroups,s=n.filter(e=>!i||-1!==i.indexOf(e.groupId));return hn(e,s,r)>-1})}(e,t.levels,n,i,fn);if(-1===r)return null;t.nextLoadLevel=r}if(e.channels||e.audioCodec){const t=hn(e,n);if(t>-1)return n[t]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length)return void this.warn("Invalid audio track id: "+e);this.clearTimer(),this.selectDefaultTrack=!1;const n=this.currentTrack,i=t[e],r=i.details&&!i.details.live;if(e===this.trackId&&i===n&&r)return;if(this.log(`Switching to audio-track ${e} "${i.name}" lang:${i.lang} group:${i.groupId} channels:${i.channels}`),this.trackId=e,this.currentTrack=i,this.hls.trigger(v.AUDIO_TRACK_SWITCHING,u({},i)),r)return;const s=this.switchParams(i.url,null==n?void 0:n.details,i.details);this.loadPlaylist(s)}findTrackId(e){const t=this.tracksInGroup;for(let n=0;n<t.length;n++){const i=t[n];if((!this.selectDefaultTrack||i.default)&&(!e||un(e,i,fn)))return n}if(e){const{name:n,lang:i,assocLang:r,characteristics:s,audioCodec:a,channels:o}=e;for(let e=0;e<t.length;e++)if(un({name:n,lang:i,assocLang:r,characteristics:s,audioCodec:a,channels:o},t[e],fn))return e;for(let n=0;n<t.length;n++){const i=t[n];if(Hi(e.attrs,i.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(let n=0;n<t.length;n++){const i=t[n];if(Hi(e.attrs,i.attrs,["LANGUAGE"]))return n}}return-1}loadPlaylist(e){const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){super.loadPlaylist();const n=t.id,i=t.groupId;let r=t.url;if(e)try{r=e.addDirectives(r)}catch(e){this.warn("Could not construct new URL with HLS Delivery Directives: "+e)}this.log(`loading audio-track playlist ${n} "${t.name}" lang:${t.lang} group:${i}`),this.clearTimer(),this.hls.trigger(v.AUDIO_TRACK_LOADING,{url:r,id:n,groupId:i,deliveryDirectives:e||null})}}constructor(e){super(e,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}}class ji extends Fn{onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){const{hls:e}=this;e.on(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.LEVEL_LOADED,this.onLevelLoaded,this),e.on(v.ERROR,this.onError,this),e.on(v.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(v.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(v.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(v.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(v.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(v.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.LEVEL_LOADED,this.onLevelLoaded,this),e.off(v.ERROR,this.onError,this),e.off(v.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(v.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(v.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(v.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(v.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(v.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(e){this.stopLoad(),this.state="IDLE",this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:n,success:i}=t;if(this.fragPrevious=n,this.state="IDLE",!i)return;const r=this.tracksBuffered[this.currentTrackId];if(!r)return;let s;const a=n.start;for(let e=0;e<r.length;e++)if(a>=r[e].start&&a<=r[e].end){s=r[e];break}const o=n.start+n.duration;s?s.end=o:(s={start:a,end:o},r.push(s)),this.fragmentTracker.fragBuffered(n),this.fragBufferedComplete(n,null)}onBufferFlushing(e,t){const{startOffset:n,endOffset:i}=t;if(0===n&&i!==Number.POSITIVE_INFINITY){const e=i-1;if(e<=0)return;t.endOffsetSubtitles=Math.max(0,e),this.tracksBuffered.forEach(t=>{for(let n=0;n<t.length;)if(t[n].end<=e)t.shift();else{if(!(t[n].start<e))break;t[n].start=e,n++}}),this.fragmentTracker.removeFragmentsInRange(n,e,mt.SUBTITLE)}}onFragBuffered(e,t){var n;this.loadedmetadata||t.frag.type!==mt.MAIN||null!=(n=this.media)&&n.buffered.length&&(this.loadedmetadata=!0)}onError(e,t){const n=t.frag;(null==n?void 0:n.type)===mt.SUBTITLE&&(t.details===T.FRAG_GAP&&this.fragmentTracker.fragBuffered(n,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),"STOPPED"!==this.state&&(this.state="IDLE"))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){this.levels&&Gi(this.levels,t)?this.levels=t.map(e=>new Ft(e)):(this.tracksBuffered=[],this.levels=t.map(e=>{const t=new Ft(e);return this.tracksBuffered[t.id]=[],t}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,mt.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null)}onSubtitleTrackSwitch(e,t){var n;if(this.currentTrackId=t.id,null==(n=this.levels)||!n.length||-1===this.currentTrackId)return void this.clearInterval();const i=this.levels[this.currentTrackId];null!=i&&i.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,i&&this.setInterval(500)}onSubtitleTrackLoaded(e,t){var n;const{currentTrackId:i,levels:r}=this,{details:s,id:a}=t;if(!r)return void this.warn("Subtitle tracks were reset while loading level "+a);const o=r[a];if(a>=r.length||!o)return;this.log(`Subtitle track ${a} loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(s.live||null!=(n=o.details)&&n.live){const e=this.mainDetails;if(s.deltaUpdateFailed||!e)return;const t=e.fragments[0];var c;o.details?(l=this.alignPlaylists(s,o.details,null==(c=this.levelLastLoaded)?void 0:c.details),0===l&&t&&(l=t.start,Vt(s,l))):s.hasProgramDateTime&&e.hasProgramDateTime?(Rn(s,e),l=s.fragments[0].start):t&&(l=t.start,Vt(s,l))}o.details=s,this.levelLastLoaded=o,a===i&&(this.startFragRequested||!this.mainDetails&&s.live||this.setStartPosition(this.mainDetails||s,l),this.tick(),s.live&&!this.fragCurrent&&this.media&&"IDLE"===this.state)&&(Qt(null,s.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0))}_handleFragmentLoadComplete(e){const{frag:t,payload:n}=e,i=t.decryptdata,r=this.hls;if(!this.fragContextChanged(t)&&n&&n.byteLength>0&&null!=i&&i.key&&i.iv&&"AES-128"===i.method){const e=performance.now();this.decrypter.decrypt(new Uint8Array(n),i.key.buffer,i.iv.buffer).catch(e=>{throw r.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e}).then(n=>{const i=performance.now();r.trigger(v.FRAG_DECRYPTED,{frag:t,payload:n,stats:{tstart:e,tdecrypt:i}})}).catch(e=>{this.warn(`${e.name}: ${e.message}`),this.state="IDLE"})}}doTick(){if(this.media){if("IDLE"===this.state){const{currentTrackId:e,levels:t}=this,n=null==t?void 0:t[e];if(!n||!t.length||!n.details)return;const{config:i}=this,r=this.getLoadPosition(),s=Tn.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,i.maxBufferHole),{end:a,len:o}=s,l=this.getFwdBufferInfo(this.media,mt.MAIN),c=n.details;if(o>this.getMaxBufferLength(null==l?void 0:l.len)+c.levelTargetDuration)return;const d=c.fragments,h=d.length,u=c.edge;let f=null;const m=this.fragPrevious;if(a<u){const e=i.maxFragLookUpTolerance,t=a>u-e?0:e;f=Qt(m,d,Math.max(d[0].start,a),t),!f&&m&&m.start<d[0].start&&(f=d[0])}else f=d[h-1];if(!f)return;if(f=this.mapToInitFragWhenRequired(f),"initSegment"!==f.sn){const e=d[f.sn-c.startSN-1];e&&e.cc===f.cc&&"NOT_LOADED"===this.fragmentTracker.getState(e)&&(f=e)}"NOT_LOADED"===this.fragmentTracker.getState(f)&&this.loadFragment(f,n,a)}}else this.state="IDLE"}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.max(t,e):t}loadFragment(e,t,n){this.fragCurrent=e,"initSegment"===e.sn?this._loadInitSegment(e,t):(this.startFragRequested=!0,super.loadFragment(e,t,n))}get mediaBufferTimeRanges(){return new zi(this.tracksBuffered[this.currentTrackId]||[])}constructor(e,t,n){super(e,t,n,"[subtitle-stream-controller]",mt.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}}class zi{constructor(e){this.buffered=void 0;const t=(t,n,i)=>{if((n>>>=0)>i-1)throw new DOMException(`Failed to execute '${t}' on 'TimeRanges': The index provided (${n}) is greater than the maximum bound (${i})`);return e[n][t]};this.buffered={get length(){return e.length},end:n=>t("end",n,e.length),start:n=>t("start",n,e.length)}}}class Ki extends nn{destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.MANIFEST_PARSED,this.onManifestParsed,this),e.on(v.LEVEL_LOADING,this.onLevelLoading,this),e.on(v.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(v.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(v.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.MANIFEST_PARSED,this.onManifestParsed,this),e.off(v.LEVEL_LOADING,this.onLevelLoading,this),e.off(v.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(v.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(v.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(){this.media&&(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),At(this.media.textTracks).forEach(e=>{Tt(e)}),this.subtitleTrack=-1,this.media=null)}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:n,groupId:i,details:r}=t,s=this.tracksInGroup[n];if(!s||s.groupId!==i)return void this.warn(`Subtitle track with id:${n} and group:${i} not found in active group ${null==s?void 0:s.groupId}`);const a=s.details;s.details=t.details,this.log(`Subtitle track ${n} "${s.name}" lang:${s.lang} group:${i} loaded [${r.startSN}-${r.endSN}]`),n===this.trackId&&this.playlistLoaded(n,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const n=t.subtitleGroups||null,i=this.groupIds;let r=this.currentTrack;if(!n||(null==i?void 0:i.length)!==(null==n?void 0:n.length)||null!=n&&n.some(e=>-1===(null==i?void 0:i.indexOf(e)))){this.groupIds=n,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter(e=>!n||-1!==n.indexOf(e.groupId));if(e.length)this.selectDefaultTrack&&!e.some(e=>e.default)&&(this.selectDefaultTrack=!1),e.forEach((e,t)=>{e.id=t});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.subtitlePreference;if(!r&&t){this.selectDefaultTrack=!1;const n=hn(t,e);if(n>-1)r=e[n];else{const e=hn(t,this.tracks);r=this.tracks[e]}}let i=this.findTrackId(r);-1===i&&r&&(i=this.findTrackId(null));const s={subtitleTracks:e};this.log(`Updating subtitle tracks, ${e.length} track(s) found in "${null==n?void 0:n.join(",")}" group-id`),this.hls.trigger(v.SUBTITLE_TRACKS_UPDATED,s),-1!==i&&-1===this.trackId&&this.setSubtitleTrack(i)}else this.shouldReloadPlaylist(r)&&this.setSubtitleTrack(this.trackId)}findTrackId(e){const t=this.tracksInGroup,n=this.selectDefaultTrack;for(let i=0;i<t.length;i++){const r=t[i];if((!n||r.default)&&(n||e)&&(!e||un(r,e)))return i}if(e){for(let n=0;n<t.length;n++){const i=t[n];if(Hi(e.attrs,i.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(let n=0;n<t.length;n++){const i=t[n];if(Hi(e.attrs,i.attrs,["LANGUAGE"]))return n}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let n=0;n<t.length;n++)if(Wi(t[n],e))return n}return-1}onError(e,t){!t.fatal&&t.context&&("subtitleTrack"!==t.context.type||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||this.checkRetry(t))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const n=this.currentTrack;if(n&&un(e,n))return n;const i=hn(e,this.tracksInGroup);if(i>-1){const e=this.tracksInGroup[i];return this.setSubtitleTrack(i),e}if(n)return null;{const n=hn(e,t);if(n>-1)return t[n]}}}return null}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){const n=t.id,i=t.groupId;let r=t.url;if(e)try{r=e.addDirectives(r)}catch(e){this.warn("Could not construct new URL with HLS Delivery Directives: "+e)}this.log("Loading subtitle playlist for id "+n),this.hls.trigger(v.SUBTITLE_TRACK_LOADING,{url:r,id:n,groupId:i,deliveryDirectives:e||null})}}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=At(e.textTracks),n=this.currentTrack;let i;if(n&&(i=t.filter(e=>Wi(n,e))[0],i||this.warn(`Unable to find subtitle TextTrack with name "${n.name}" and language "${n.lang}"`)),[].slice.call(t).forEach(e=>{"disabled"!==e.mode&&e!==i&&(e.mode="disabled")}),i){const e=this.subtitleDisplay?"showing":"hidden";i.mode!==e&&(i.mode=e)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media)return void(this.queuedDefaultTrack=e);if(e<-1||e>=t.length||!p(e))return void this.warn("Invalid subtitle track id: "+e);this.clearTimer(),this.selectDefaultTrack=!1;const n=this.currentTrack,i=t[e]||null;if(this.trackId=e,this.currentTrack=i,this.toggleTrackModes(),!i)return void this.hls.trigger(v.SUBTITLE_TRACK_SWITCH,{id:e});const r=!!i.details&&!i.details.live;if(e===this.trackId&&i===n&&r)return;this.log("Switching to subtitle-track "+e+(i?` "${i.name}" lang:${i.lang} group:${i.groupId}`:""));const{id:s,groupId:a="",name:o,type:l,url:c}=i;this.hls.trigger(v.SUBTITLE_TRACK_SWITCH,{id:s,groupId:a,name:o,type:l,url:c});const d=this.switchParams(i.url,null==n?void 0:n.details,i.details);this.loadPlaylist(d)}constructor(e){super(e,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=null;const t=At(this.media.textTracks);for(let n=0;n<t.length;n++)if("hidden"===t[n].mode)e=t[n];else if("showing"===t[n].mode){e=t[n];break}const n=this.findTrackForTextTrack(e);this.subtitleTrack!==n&&this.setSubtitleTrack(n)},this.registerListeners()}}class Yi{append(e,t,n){const i=this.queues[t];i.push(e),1!==i.length||n||this.executeNext(t)}insertAbort(e,t){this.queues[t].unshift(e),this.executeNext(t)}appendBlocker(e){let t;const n=new Promise(e=>{t=e}),i={execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(i,e),n}executeNext(e){const t=this.queues[e];if(t.length){const n=t[0];try{n.execute()}catch(t){I.warn(`[buffer-operation-queue]: Exception executing "${e}" SourceBuffer operation: ${t}`),n.onError(t);const i=this.buffers[e];null!=i&&i.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues[e].shift(),this.executeNext(e)}current(e){return this.queues[e][0]}constructor(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}}const qi=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class Qi{hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls:e}=this;e.on(v.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.MANIFEST_PARSED,this.onManifestParsed,this),e.on(v.BUFFER_RESET,this.onBufferReset,this),e.on(v.BUFFER_APPENDING,this.onBufferAppending,this),e.on(v.BUFFER_CODECS,this.onBufferCodecs,this),e.on(v.BUFFER_EOS,this.onBufferEos,this),e.on(v.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(v.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(v.FRAG_PARSED,this.onFragParsed,this),e.on(v.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:e}=this;e.off(v.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.MANIFEST_PARSED,this.onManifestParsed,this),e.off(v.BUFFER_RESET,this.onBufferReset,this),e.off(v.BUFFER_APPENDING,this.onBufferAppending,this),e.off(v.BUFFER_CODECS,this.onBufferCodecs,this),e.off(v.BUFFER_EOS,this.onBufferEos,this),e.off(v.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(v.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(v.FRAG_PARSED,this.onFragParsed,this),e.off(v.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new Yi(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){let n=2;(t.audio&&!t.video||!t.altAudio)&&(n=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=n,this.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")}onMediaAttaching(e,t){const n=this.media=t.media,i=Xe(this.appendSource);if(n&&i){var r;const e=this.mediaSource=new i;this.log("created media source: "+(null==(r=e.constructor)?void 0:r.name)),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming));const t=this._objectUrl=self.URL.createObjectURL(e);if(this.appendSource)try{n.removeAttribute("src");const i=self.ManagedMediaSource;n.disableRemotePlayback=n.disableRemotePlayback||i&&e instanceof i,Zi(n),function(e,t){const n=self.document.createElement("source");n.type="video/mp4",n.src=t,e.appendChild(n)}(n,t),n.load()}catch(e){n.src=t}else n.src=t;n.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:e,mediaSource:t,_objectUrl:n}=this;if(t){if(this.log("media source detaching"),"open"===t.readyState)try{t.endOfStream()}catch(e){this.warn(`onMediaDetaching: ${e.message} while calling endOfStream`)}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(t.removeEventListener("startstreaming",this._onStartStreaming),t.removeEventListener("endstreaming",this._onEndStreaming)),e&&(e.removeEventListener("emptied",this._onMediaEmptied),n&&self.URL.revokeObjectURL(n),this.mediaSrc===n?(e.removeAttribute("src"),this.appendSource&&Zi(e),e.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(v.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach(e=>{this.resetBuffer(e)}),this._initSourceBuffer(),this.hls.resumeBuffering()}resetBuffer(e){const t=this.sourceBuffer[e];try{var n;t&&(this.removeBufferListeners(e),this.sourceBuffer[e]=void 0,null!=(n=this.mediaSource)&&n.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(t))}catch(t){this.warn("onBufferReset "+e,t)}}onBufferCodecs(e,t){const n=this.getSourceBufferTypes().length,i=Object.keys(t);if(i.forEach(e=>{if(n){const n=this.tracks[e];if(n&&"function"==typeof n.buffer.changeType){var i;const{id:r,codec:s,levelCodec:a,container:o,metadata:l}=t[e],c=et(n.codec,n.levelCodec),d=null==c?void 0:c.replace(qi,"$1");let h=et(s,a);const u=null==(i=h)?void 0:i.replace(qi,"$1");if(h&&d!==u){"audio"===e.slice(0,5)&&(h=Je(h,this.appendSource));const t=`${o};codecs=${h}`;this.appendChangeType(e,t),this.log(`switching codec ${c} to ${h}`),this.tracks[e]={buffer:n.buffer,codec:s,container:o,levelCodec:a,metadata:l,id:r}}}}else this.pendingTracks[e]=t[e]}),n)return;const r=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==r&&(this.log(`${r} bufferCodec event(s) expected ${i.join(",")}`),this.bufferCodecEventsExpected=r),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks()}appendChangeType(e,t){const{operationQueue:n}=this,i={execute:()=>{const i=this.sourceBuffer[e];i&&(this.log(`changing ${e} sourceBuffer type to ${t}`),i.changeType(t)),n.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:t=>{this.warn(`Failed to change ${e} SourceBuffer type`,t)}};n.append(i,e,!!this.pendingTracks[e])}onBufferAppending(e,t){const{hls:n,operationQueue:i,tracks:r}=this,{data:s,type:a,frag:o,part:l,chunkMeta:c}=t,d=c.buffering[a],h=self.performance.now();d.start=h;const u=o.stats.buffering,f=l?l.stats.buffering:null;0===u.start&&(u.start=h),f&&0===f.start&&(f.start=h);const m=r.audio;let p=!1;"audio"===a&&"audio/mpeg"===(null==m?void 0:m.container)&&(p=!this.lastMpegAudioChunk||1===c.id||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const g=o.start,_={execute:()=>{if(d.executeStart=self.performance.now(),p){const e=this.sourceBuffer[a];if(e){const t=g-e.timestampOffset;Math.abs(t)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${g} (delta: ${t}) sn: ${o.sn})`),e.timestampOffset=g)}}this.appendExecutor(s,a)},onStart:()=>{},onComplete:()=>{const e=self.performance.now();d.executeEnd=d.end=e,0===u.first&&(u.first=e),f&&0===f.first&&(f.first=e);const{sourceBuffer:t}=this,n={};for(const e in t)n[e]=Tn.getBuffered(t[e]);this.appendErrors[a]=0,"audio"===a||"video"===a?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(v.BUFFER_APPENDED,{type:a,frag:o,part:l,chunkMeta:c,parent:o.type,timeRanges:n})},onError:e=>{const t={type:E.MEDIA_ERROR,parent:o.type,details:T.BUFFER_APPEND_ERROR,sourceBufferName:a,frag:o,part:l,chunkMeta:c,error:e,err:e,fatal:!1};if(e.code===DOMException.QUOTA_EXCEEDED_ERR)t.details=T.BUFFER_FULL_ERROR;else{const e=++this.appendErrors[a];t.details=T.BUFFER_APPEND_ERROR,this.warn(`Failed ${e}/${n.config.appendErrorMaxRetry} times to append segment in "${a}" sourceBuffer`),e>=n.config.appendErrorMaxRetry&&(t.fatal=!0)}n.trigger(v.ERROR,t)}};i.append(_,a,!!this.pendingTracks[a])}onBufferFlushing(e,t){const{operationQueue:n}=this,i=e=>({execute:this.removeExecutor.bind(this,e,t.startOffset,t.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(v.BUFFER_FLUSHED,{type:e})},onError:t=>{this.warn(`Failed to remove from ${e} SourceBuffer`,t)}});t.type?n.append(i(t.type),t.type):this.getSourceBufferTypes().forEach(e=>{n.append(i(e),e)})}onFragParsed(e,t){const{frag:n,part:i}=t,r=[],s=i?i.elementaryStreams:n.elementaryStreams;s.audiovideo?r.push("audiovideo"):(s.audio&&r.push("audio"),s.video&&r.push("video")),0===r.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${n.type} level: ${n.level} sn: ${n.sn}`),this.blockBuffers(()=>{const e=self.performance.now();n.stats.buffering.end=e,i&&(i.stats.buffering.end=e);const t=i?i.stats:n.stats;this.hls.trigger(v.FRAG_BUFFERED,{frag:n,part:i,stats:t,id:n.type})},r)}onFragChanged(e,t){this.trimBuffers()}onBufferEos(e,t){this.getSourceBufferTypes().reduce((e,n)=>{const i=this.sourceBuffer[n];return!i||t.type&&t.type!==n||(i.ending=!0,i.ended||(i.ended=!0,this.log(n+" sourceBuffer now EOS"))),e&&!(i&&!i.ended)},!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach(e=>{const t=this.sourceBuffer[e];t&&(t.ending=!1)});const{mediaSource:e}=this;e&&"open"===e.readyState?(this.log("Calling mediaSource.endOfStream()"),e.endOfStream()):e&&this.log("Could not call mediaSource.endOfStream(). mediaSource.readyState: "+e.readyState)}))}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls:e,details:t,media:n}=this;if(!n||null===t)return;if(!this.getSourceBufferTypes().length)return;const i=e.config,r=n.currentTime,s=t.levelTargetDuration,a=t.live&&null!==i.liveBackBufferLength?i.liveBackBufferLength:i.backBufferLength;if(p(a)&&a>0){const e=Math.max(a,s),t=Math.floor(r/s)*s-e;this.flushBackBuffer(r,s,t)}if(p(i.frontBufferFlushThreshold)&&i.frontBufferFlushThreshold>0){const e=Math.max(i.maxBufferLength,i.frontBufferFlushThreshold),t=Math.max(e,s),n=Math.floor(r/s)*s+t;this.flushFrontBuffer(r,s,n)}}flushBackBuffer(e,t,n){const{details:i,sourceBuffer:r}=this;this.getSourceBufferTypes().forEach(s=>{const a=r[s];if(a){const r=Tn.getBuffered(a);if(r.length>0&&n>r.start(0)){if(this.hls.trigger(v.BACK_BUFFER_REACHED,{bufferEnd:n}),null!=i&&i.live)this.hls.trigger(v.LIVE_BACK_BUFFER_REACHED,{bufferEnd:n});else if(a.ended&&r.end(r.length-1)-e<2*t)return void this.log(`Cannot flush ${s} back buffer while SourceBuffer is in ended state`);this.hls.trigger(v.BUFFER_FLUSHING,{startOffset:0,endOffset:n,type:s})}}})}flushFrontBuffer(e,t,n){const{sourceBuffer:i}=this;this.getSourceBufferTypes().forEach(r=>{const s=i[r];if(s){const i=Tn.getBuffered(s),a=i.length;if(a<2)return;const o=i.start(a-1),l=i.end(a-1);if(n>o||e>=o&&e<=l)return;if(s.ended&&e-l<2*t)return void this.log(`Cannot flush ${r} front buffer while SourceBuffer is in ended state`);this.hls.trigger(v.BUFFER_FLUSHING,{startOffset:o,endOffset:1/0,type:r})}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;const{details:e,hls:t,media:n,mediaSource:i}=this,r=e.fragments[0].start+e.totalduration,s=n.duration,a=p(i.duration)?i.duration:0;e.live&&t.config.liveDurationInfinity?(i.duration=1/0,this.updateSeekableRange(e)):(r>a&&r>s||!p(s))&&(this.log("Updating Media Source duration to "+r.toFixed(3)),i.duration=r)}updateSeekableRange(e){const t=this.mediaSource,n=e.fragments;if(n.length&&e.live&&null!=t&&t.setLiveSeekableRange){const i=Math.max(0,n[0].start),r=Math.max(i,i+e.totalduration);this.log(`Media Source duration is set to ${t.duration}. Setting seekable range to ${i}-${r}.`),t.setLiveSeekableRange(i,r)}}checkPendingTracks(){const{bufferCodecEventsExpected:e,operationQueue:t,pendingTracks:n}=this,i=Object.keys(n).length;if(i&&(!e||2===i||"audiovideo"in n)){this.createSourceBuffers(n),this.pendingTracks={};const e=this.getSourceBufferTypes();if(e.length)this.hls.trigger(v.BUFFER_CREATED,{tracks:this.tracks}),e.forEach(e=>{t.executeNext(e)});else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}}createSourceBuffers(e){const{sourceBuffer:t,mediaSource:n}=this;if(!n)throw Error("createSourceBuffers called when mediaSource was null");for(const r in e)if(!t[r]){var i;const s=e[r];if(!s)throw Error(`source buffer exists for track ${r}, however track does not`);let a=-1===(null==(i=s.levelCodec)?void 0:i.indexOf(","))?s.levelCodec:s.codec;a&&"audio"===r.slice(0,5)&&(a=Je(a,this.appendSource));const o=`${s.container};codecs=${a}`;this.log(`creating sourceBuffer(${o})`);try{const e=t[r]=n.addSourceBuffer(o),i=r;this.addBufferListener(i,"updatestart",this._onSBUpdateStart),this.addBufferListener(i,"updateend",this._onSBUpdateEnd),this.addBufferListener(i,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(i,"bufferedchange",(e,t)=>{const n=t.removedRanges;null!=n&&n.length&&this.hls.trigger(v.BUFFER_FLUSHED,{type:r})}),this.tracks[r]={buffer:e,codec:a,container:s.container,levelCodec:s.levelCodec,metadata:s.metadata,id:s.id}}catch(e){this.error("error while trying to add sourceBuffer: "+e.message),this.hls.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,sourceBufferName:r,mimeType:o})}}}get mediaSrc(){var e,t;const n=(null==(e=this.media)||null==(t=e.querySelector)?void 0:t.call(e,"source"))||this.media;return null==n?void 0:n.src}_onSBUpdateStart(e){const{operationQueue:t}=this;t.current(e).onStart()}_onSBUpdateEnd(e){var t;if("closed"===(null==(t=this.mediaSource)?void 0:t.readyState))return void this.resetBuffer(e);const{operationQueue:n}=this;n.current(e).onComplete(),n.shiftAndExecuteNext(e)}_onSBUpdateError(e,t){var n;const i=new Error(`${e} SourceBuffer error. MediaSource readyState: ${null==(n=this.mediaSource)?void 0:n.readyState}`);this.error(""+i,t),this.hls.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:i,fatal:!1});const r=this.operationQueue.current(e);r&&r.onError(i)}removeExecutor(e,t,n){const{media:i,mediaSource:r,operationQueue:s,sourceBuffer:a}=this,o=a[e];if(!i||!r||!o)return this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),void s.shiftAndExecuteNext(e);const l=p(i.duration)?i.duration:1/0,c=p(r.duration)?r.duration:1/0,d=Math.max(0,t),h=Math.min(n,l,c);h>d&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${d},${h}] from the ${e} SourceBuffer`),o.remove(d,h)):s.shiftAndExecuteNext(e)}appendExecutor(e,t){const n=this.sourceBuffer[t];if(n)n.ended=!1,n.appendBuffer(e);else if(!this.pendingTracks[t])throw new Error(`Attempting to append to the ${t} SourceBuffer, but it does not exist`)}blockBuffers(e,t=this.getSourceBufferTypes()){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(e);const{operationQueue:n}=this,i=t.map(e=>n.appendBlocker(e));Promise.all(i).then(()=>{e(),t.forEach(e=>{const t=this.sourceBuffer[e];null!=t&&t.updating||n.shiftAndExecuteNext(e)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(e,t,n){const i=this.sourceBuffer[e];if(!i)return;const r=n.bind(this,e);this.listeners[e].push({event:t,listener:r}),i.addEventListener(t,r)}removeBufferListeners(e){const t=this.sourceBuffer[e];t&&this.listeners[e].forEach(e=>{t.removeEventListener(e.event,e.listener)})}constructor(e){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=e=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=e=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media:e,mediaSource:t}=this;this.log("Media source opened"),e&&(e.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(v.MEDIA_ATTACHED,{media:e,mediaSource:t})),t&&t.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:e,_objectUrl:t}=this;e!==t&&I.error(`Media element src was set while attaching MediaSource (${t} > ${e})`)},this.hls=e;const t="[buffer-controller]";var n;this.appendSource=(n=Xe(e.config.preferManagedMediaSource),"undefined"!=typeof self&&n===self.ManagedMediaSource),this.log=I.log.bind(I,t),this.warn=I.warn.bind(I,t),this.error=I.error.bind(I,t),this._initSourceBuffer(),this.registerListeners()}}function Zi(e){const t=e.querySelectorAll("source");[].slice.call(t).forEach(t=>{e.removeChild(t)})}const $i={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Ji=e=>String.fromCharCode($i[e]||e),er={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},tr={17:2,18:4,21:6,22:8,23:10,19:13,20:15},nr={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},ir={25:2,26:4,29:6,30:8,31:10,27:13,28:15},rr=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class sr{log(e,t){if(this.verboseLevel>=e){const n="function"==typeof t?t():t;I.log(`${this.time} [${e}] ${n}`)}}constructor(){this.time=null,this.verboseLevel=0}}const ar=function(e){const t=[];for(let n=0;n<e.length;n++)t.push(e[n].toString(16));return t};class or{reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let n=0;n<t.length;n++){const i=t[n];e.hasOwnProperty(i)&&(this[i]=e[i])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}}class lr{reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}constructor(){this.uchar=" ",this.penState=new or}}class cr{equals(e){for(let t=0;t<100;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<100;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<100;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>100&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=100)}moveCursor(e){const t=this.pos+e;if(e>1)for(let e=this.pos+1;e<t+1;e++)this.chars[e].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=Ji(e);this.pos>=100?this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){let t;for(t=e;t<100;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let n=0;n<100;n++){const i=this.chars[n].uchar;" "!==i&&(t=!1),e.push(i)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}constructor(e){this.chars=[],this.pos=0,this.currPenState=new or,this.cueStartTime=null,this.logger=void 0;for(let e=0;e<100;e++)this.chars.push(new lr);this.logger=e}}class dr{reset(){for(let e=0;e<15;e++)this.rows[e].clear();this.currRow=14}equals(e){let t=!0;for(let n=0;n<15;n++)if(!this.rows[n].equals(e.rows[n])){t=!1;break}return t}copy(e){for(let t=0;t<15;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<15;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+JSON.stringify(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let e=0;e<15;e++)this.rows[e].clear();const e=this.currRow+1-this.nrRollUpRows,n=this.lastOutputScreen;if(n){const i=n.rows[e].cueStartTime,r=this.logger.time;if(null!==i&&null!==r&&i<r)for(let i=0;i<this.nrRollUpRows;i++)this.rows[t-this.nrRollUpRows+i+1].copy(n.rows[e+i])}}this.currRow=t;const n=this.rows[this.currRow];if(null!==e.indent){const t=e.indent,i=Math.max(t-1,0);n.setCursor(e.indent),e.color=n.chars[i].penState.foreground}const i={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(i)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let n="",i=-1;for(let n=0;n<15;n++){const r=this.rows[n].getTextString();r&&(i=n+1,e?t.push("Row "+i+": '"+r+"'"):t.push(r.trim()))}return t.length>0&&(n=e?"["+t.join(" | ")+"]":t.join("\n")),n}getTextAndFormat(){return this.rows}constructor(e){this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<15;t++)this.rows.push(new cr(e));this.logger=e}}class hr{reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{const n=Math.floor(e/2)-16,i=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=i[n]}this.logger.log(2,"MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;null!==t&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}constructor(e,t,n){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new dr(n),this.nonDisplayedMemory=new dr(n),this.lastOutputScreen=new dr(n),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=n}}class ur{getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let e=0;e<t.length;e+=2){const n=127&t[e],i=127&t[e+1];let r=!1,s=null;if(0===n&&0===i)continue;this.logger.log(3,()=>"["+ar([t[e],t[e+1]])+"] -> ("+ar([n,i])+")");const a=this.cmdHistory;if(n>=16&&n<=31){if(mr(n,i,a)){fr(null,null,a),this.logger.log(3,()=>"Repeated command ("+ar([n,i])+") is dropped");continue}fr(n,i,this.cmdHistory),r=this.parseCmd(n,i),r||(r=this.parseMidrow(n,i)),r||(r=this.parsePAC(n,i)),r||(r=this.parseBackgroundAttributes(n,i))}else fr(null,null,a);if(!r&&(s=this.parseChars(n,i),s)){const e=this.currentChannel;e&&e>0?this.channels[e].insertChars(s):this.logger.log(2,"No channel found yet. TEXT-MODE?")}r||s||this.logger.log(2,()=>"Couldn't parse cleaned data "+ar([n,i])+" orig: "+ar([t[e],t[e+1]]))}}parseCmd(e,t){if(!((20===e||28===e||21===e||29===e)&&t>=32&&t<=47||(23===e||31===e)&&t>=33&&t<=35))return!1;const n=20===e||21===e||23===e?1:2,i=this.channels[n];return 20===e||21===e||28===e||29===e?32===t?i.ccRCL():33===t?i.ccBS():34===t?i.ccAOF():35===t?i.ccAON():36===t?i.ccDER():37===t?i.ccRU(2):38===t?i.ccRU(3):39===t?i.ccRU(4):40===t?i.ccFON():41===t?i.ccRDC():42===t?i.ccTR():43===t?i.ccRTD():44===t?i.ccEDM():45===t?i.ccCR():46===t?i.ccENM():47===t&&i.ccEOC():i.ccTO(t-32),this.currentChannel=n,!0}parseMidrow(e,t){let n=0;if((17===e||25===e)&&t>=32&&t<=47){if(n=17===e?1:2,n!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const i=this.channels[n];return!!i&&(i.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+ar([e,t])+")"),!0)}return!1}parsePAC(e,t){let n;if(!((e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127||(16===e||24===e)&&t>=64&&t<=95))return!1;const i=e<=23?1:2;n=t>=64&&t<=95?1===i?er[e]:nr[e]:1===i?tr[e]:ir[e];const r=this.channels[i];return!!r&&(r.setPAC(this.interpretPAC(n,t)),this.currentChannel=i,!0)}interpretPAC(e,t){let n;const i={color:null,italics:!1,indent:null,underline:!1,row:e};return n=t>95?t-96:t-64,i.underline=1==(1&n),n<=13?i.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(n/2)]:n<=15?(i.italics=!0,i.color="white"):i.indent=4*Math.floor((n-16)/2),i}parseChars(e,t){let n,i=null,r=null;if(e>=25?(n=2,r=e-8):(n=1,r=e),r>=17&&r<=19){let e;e=17===r?t+80:18===r?t+112:t+144,this.logger.log(2,()=>"Special char '"+Ji(e)+"' in channel "+n),i=[e]}else e>=32&&e<=127&&(i=0===t?[e]:[e,t]);return i&&this.logger.log(3,()=>"Char codes =  "+ar(i).join(",")),i}parseBackgroundAttributes(e,t){if(!((16===e||24===e)&&t>=32&&t<=47||(23===e||31===e)&&t>=45&&t<=47))return!1;let n;const i={};16===e||24===e?(n=Math.floor((t-32)/2),i.background=rr[n],t%2==1&&(i.background=i.background+"_semi")):45===t?i.background="transparent":(i.foreground="black",47===t&&(i.underline=!0));const r=e<=23?1:2;return this.channels[r].setBkgData(i),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}fr(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const n=this.channels[t];n&&n.cueSplitAtTime(e)}}constructor(e,t,n){this.channels=void 0,this.currentChannel=0,this.cmdHistory={a:null,b:null},this.logger=void 0;const i=this.logger=new sr;this.channels=[null,new hr(e,t,i),new hr(e+1,n,i)]}}function fr(e,t,n){n.a=e,n.b=t}function mr(e,t,n){return n.a===e&&n.b===t}class pr{dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,n){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=n,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}}var gr=function(){if(null!=U&&U.VTTCue)return self.VTTCue;const e=["","lr","rl"],t=["start","middle","end","left","right"];function n(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;const n=t.toLowerCase();return!!~e.indexOf(n)&&n}function i(e){return n(t,e)}function r(e,...t){let n=1;for(;n<arguments.length;n++){const t=arguments[n];for(const n in t)e[n]=t[n]}return e}function s(t,s,a){const o=this,l={enumerable:!0};o.hasBeenReset=!1;let c="",d=!1,h=t,u=s,f=a,m=null,p="",g=!0,_="auto",v="start",E=50,T="middle",S=50,A="middle";Object.defineProperty(o,"id",r({},l,{get:function(){return c},set:function(e){c=""+e}})),Object.defineProperty(o,"pauseOnExit",r({},l,{get:function(){return d},set:function(e){d=!!e}})),Object.defineProperty(o,"startTime",r({},l,{get:function(){return h},set:function(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");h=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",r({},l,{get:function(){return u},set:function(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");u=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",r({},l,{get:function(){return f},set:function(e){f=""+e,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",r({},l,{get:function(){return m},set:function(e){m=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",r({},l,{get:function(){return p},set:function(t){const i=function(t){return n(e,t)}(t);if(!1===i)throw new SyntaxError("An invalid or illegal string was specified.");p=i,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",r({},l,{get:function(){return g},set:function(e){g=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",r({},l,{get:function(){return _},set:function(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");_=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",r({},l,{get:function(){return v},set:function(e){const t=i(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");v=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",r({},l,{get:function(){return E},set:function(e){if(e<0||e>100)throw new Error("Position must be between 0 and 100.");E=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",r({},l,{get:function(){return T},set:function(e){const t=i(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");T=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",r({},l,{get:function(){return S},set:function(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100.");S=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",r({},l,{get:function(){return A},set:function(e){const t=i(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");A=t,this.hasBeenReset=!0}})),o.displayState=void 0}return s.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},s}();class _r{decode(e,t){if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function vr(e){function t(e,t,n,i){return 3600*(0|e)+60*(0|t)+(0|n)+parseFloat(i||0)}const n=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return n?parseFloat(n[2])>59?t(n[2],n[3],0,n[4]):t(n[1],n[2],n[3],n[4]):null}class Er{set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,n){return n?this.has(e)?this.values[e]:t[n]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,n){for(let i=0;i<n.length;++i)if(t===n[i]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const n=parseFloat(t);if(n>=0&&n<=100)return this.set(e,n),!0}return!1}constructor(){this.values=Object.create(null)}}function Tr(e,t,n,i){const r=i?e.split(i):[e];for(const e in r){if("string"!=typeof r[e])continue;const i=r[e].split(n);2===i.length&&t(i[0],i[1])}}const Sr=new gr(0,0,""),Ar="middle"===Sr.align?"middle":"center";function br(e,t,n){const i=e;function r(){const t=vr(e);if(null===t)throw new Error("Malformed timestamp: "+i);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t}function s(){e=e.replace(/^\s+/,"")}if(s(),t.startTime=r(),s(),"--\x3e"!==e.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+i);e=e.slice(3),s(),t.endTime=r(),s(),function(e,t){const i=new Er;Tr(e,(function(e,t){let r;switch(e){case"region":for(let r=n.length-1;r>=0;r--)if(n[r].id===t){i.set(e,n[r].region);break}break;case"vertical":i.alt(e,t,["rl","lr"]);break;case"line":r=t.split(","),i.integer(e,r[0]),i.percent(e,r[0])&&i.set("snapToLines",!1),i.alt(e,r[0],["auto"]),2===r.length&&i.alt("lineAlign",r[1],["start",Ar,"end"]);break;case"position":r=t.split(","),i.percent(e,r[0]),2===r.length&&i.alt("positionAlign",r[1],["start",Ar,"end","line-left","line-right","auto"]);break;case"size":i.percent(e,t);break;case"align":i.alt(e,t,["start",Ar,"end","left","right"])}}),/:/,/\s/),t.region=i.get("region",null),t.vertical=i.get("vertical","");let r=i.get("line","auto");"auto"===r&&-1===Sr.line&&(r=-1),t.line=r,t.lineAlign=i.get("lineAlign","start"),t.snapToLines=i.get("snapToLines",!0),t.size=i.get("size",100),t.align=i.get("align",Ar);let s=i.get("position","auto");"auto"===s&&50===Sr.position&&(s="start"===t.align||"left"===t.align?0:"end"===t.align||"right"===t.align?100:50),t.position=s}(e,t)}function Ir(e){return e.replace(/<br(?: \/)?>/gi,"\n")}class Rr{parse(e){const t=this;function n(){let e=t.buffer,n=0;for(e=Ir(e);n<e.length&&"\r"!==e[n]&&"\n"!==e[n];)++n;const i=e.slice(0,n);return"\r"===e[n]&&++n,"\n"===e[n]&&++n,t.buffer=e.slice(n),i}e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));try{let e="";if("INITIAL"===t.state){if(!/\r\n|\n/.test(t.buffer))return this;e=n();const i=e.match(/^()?WEBVTT([ \t].*)?$/);if(null==i||!i[0])throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let i=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(i?i=!1:e=n(),t.state){case"HEADER":/:/.test(e)?Tr(e,(function(e,t){}),/:/):e||(t.state="ID");continue;case"NOTE":e||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){t.state="NOTE";break}if(!e)continue;if(t.cue=new gr(0,0,""),t.state="CUE",-1===e.indexOf("--\x3e")){t.cue.id=e;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{br(e,t.cue,t.regionList)}catch(e){t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const n=-1!==e.indexOf("--\x3e");if(!e||n&&(i=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(null===t.cue)continue;t.cue.text&&(t.cue.text+="\n"),t.cue.text+=e}continue;case"BADCUE":e||(t.state="ID")}}}catch(e){"CUETEXT"===t.state&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state="INITIAL"===t.state?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||"HEADER"===e.state)&&(e.buffer+="\n\n",e.parse()),"INITIAL"===e.state||"BADWEBVTT"===e.state)throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}constructor(){this.state="INITIAL",this.buffer="",this.decoder=new _r,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}}const Cr=/\r\n|\n\r|\n|\r/g,yr=function(e,t,n=0){return e.slice(n,n+t.length)===t},Mr=function(e){let t=5381,n=e.length;for(;n;)t=33*t^e.charCodeAt(--n);return(t>>>0).toString()};function Or(e,t,n){return Mr(e.toString())+Mr(t.toString())+Mr(n)}const xr=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Dr=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Pr={left:"start",center:"center",right:"end",start:"start",end:"end"};function Lr(e,t,n,i){const r=Se(new Uint8Array(e),["mdat"]);if(0===r.length)return void i(new Error("Could not parse IMSC1 mdat"));const s=r.map(e=>le(e)),a=function(e,t,n=1,i=!1){return Ti(e,t,1/n,i)}(t.baseTime,1,t.timescale);try{s.forEach(e=>n(function(e,t){const n=(new DOMParser).parseFromString(e,"text/xml").getElementsByTagName("tt")[0];if(!n)throw new Error("Invalid ttml");const i={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},r=Object.keys(i).reduce((e,t)=>(e[t]=n.getAttribute("ttp:"+t)||i[t],e),{}),s="preserve"!==n.getAttribute("xml:space"),a=Fr(Nr(n,"styling","style")),o=Fr(Nr(n,"layout","region")),l=Nr(n,"body","[begin]");return[].map.call(l,e=>{const n=function e(t,n){return[].slice.call(t.childNodes).reduce((t,i,r)=>{var s;return"br"===i.nodeName&&r?t+"\n":null!=(s=i.childNodes)&&s.length?e(i,n):n?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}(e,s);if(!n||!e.hasAttribute("begin"))return null;const i=Br(e.getAttribute("begin"),r),l=Br(e.getAttribute("dur"),r);let c=Br(e.getAttribute("end"),r);if(null===i)throw Ur(e);if(null===c){if(null===l)throw Ur(e);c=i+l}const d=new gr(i-t,c-t,n);d.id=Or(d.startTime,d.endTime,d.text);const h=function(e,t,n){const i="http://www.w3.org/ns/ttml#styling";let r=null;const s=null!=e&&e.hasAttribute("style")?e.getAttribute("style"):null;return s&&n.hasOwnProperty(s)&&(r=n[s]),["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"].reduce((n,s)=>{const a=wr(t,i,s)||wr(e,i,s)||wr(r,i,s);return a&&(n[s]=a),n},{})}(o[e.getAttribute("region")],a[e.getAttribute("style")],a),{textAlign:u}=h;if(u){const e=Pr[u];e&&(d.lineAlign=e),d.align=u}return m(d,h),d}).filter(e=>null!==e)}(e,a)))}catch(e){i(e)}}function Nr(e,t,n){const i=e.getElementsByTagName(t)[0];return i?[].slice.call(i.querySelectorAll(n)):[]}function Fr(e){return e.reduce((e,t)=>{const n=t.getAttribute("xml:id");return n&&(e[n]=t),e},{})}function wr(e,t,n){return e&&e.hasAttributeNS(t,n)?e.getAttributeNS(t,n):null}function Ur(e){return new Error("Could not parse ttml timestamp "+e)}function Br(e,t){if(!e)return null;let n=vr(e);return null===n&&(xr.test(e)?n=function(e,t){const n=xr.exec(e),i=(0|n[4])+(0|n[5])/t.subFrameRate;return 3600*(0|n[1])+60*(0|n[2])+(0|n[3])+i/t.frameRate}(e,t):Dr.test(e)&&(n=function(e,t){const n=Dr.exec(e),i=Number(n[1]);switch(n[2]){case"h":return 3600*i;case"m":return 60*i;case"ms":return 1e3*i;case"f":return i/t.frameRate;case"t":return i/t.tickRate}return i}(e,t))),n}class kr{destroy(){const{hls:e}=this;e.off(v.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(v.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(v.FRAG_LOADING,this.onFragLoading,this),e.off(v.FRAG_LOADED,this.onFragLoaded,this),e.off(v.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(v.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(v.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(v.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(v.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){const e=new pr(this,"textTrack1"),t=new pr(this,"textTrack2"),n=new pr(this,"textTrack3"),i=new pr(this,"textTrack4");this.cea608Parser1=new ur(1,e,t),this.cea608Parser2=new ur(3,n,i)}}addCues(e,t,n,i,r){let s=!1;for(let e=r.length;e--;){const i=r[e],d=(a=i[0],o=i[1],l=t,c=n,Math.min(o,c)-Math.max(a,l));if(d>=0&&(i[0]=Math.min(i[0],t),i[1]=Math.max(i[1],n),s=!0,d/(n-t)>.5))return}var a,o,l,c;if(s||r.push([t,n]),this.config.renderTextTracksNatively){const r=this.captionsTracks[e];this.Cues.newCue(r,t,n,i)}else{const r=this.Cues.newCue(null,t,n,i);this.hls.trigger(v.CUES_PARSED,{type:"captions",cues:r,track:e})}}onInitPtsFound(e,{frag:t,id:n,initPTS:i,timescale:r}){const{unparsedVttFrags:s}=this;"main"===n&&(this.initPTS[t.cc]={baseTime:i,timescale:r}),s.length&&(this.unparsedVttFrags=[],s.forEach(e=>{this.onFragLoaded(v.FRAG_LOADED,e)}))}getExistingTrack(e,t){const{media:n}=this;if(n)for(let i=0;i<n.textTracks.length;i++){const r=n.textTracks[i];if(Gr(r,{name:e,lang:t,attrs:{}}))return r}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:n,media:i}=this,{label:r,languageCode:s}=t[e],a=this.getExistingTrack(r,s);if(a)n[e]=a,Tt(n[e]),vt(n[e],i);else{const t=this.createTextTrack("captions",r,s);t&&(t[e]=!0,n[e]=t)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const n={_id:e,label:t.label,kind:"captions",default:!!t.media&&!!t.media.default,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(v.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}createTextTrack(e,t,n){const i=this.media;if(i)return i.addTextTrack(e,t,n)}onMediaAttaching(e,t){this.media=t.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:e}=this;Object.keys(e).forEach(t=>{Tt(e[t]),delete e[t]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let e=0;e<t.length;e++)Tt(t[e])}onSubtitleTracksUpdated(e,t){const n=t.subtitleTracks||[],i=n.some(e=>"stpp.ttml.im1t"===e.textCodec);if(this.config.enableWebVTT||i&&this.config.enableIMSC1){if(Gi(this.tracks,n))return void(this.tracks=n);if(this.textTracks=[],this.tracks=n,this.config.renderTextTracksNatively){const e=this.media,t=e?At(e.textTracks):null;if(this.tracks.forEach((e,n)=>{let i;if(t){let n=null;for(let i=0;i<t.length;i++)if(t[i]&&Gr(t[i],e)){n=t[i],t[i]=null;break}n&&(i=n)}if(i)Tt(i);else{const t=Vr(e);i=this.createTextTrack(t,e.name,e.lang),i&&(i.mode="disabled")}i&&this.textTracks.push(i)}),null!=t&&t.length){const e=t.filter(e=>null!==e).map(e=>e.label);e.length&&I.warn(`Media element contains unused subtitle tracks: ${e.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const e=this.tracks.map(e=>({label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e}));this.hls.trigger(v.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:e})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(e=>{const t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(!t)return;const n="textTrack"+t[1],i=this.captionsProperties[n];i&&(i.label=e.name,e.lang&&(i.languageCode=e.lang),i.media=e)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return null==t?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===mt.MAIN){var n,i;const{cea608Parser1:e,cea608Parser2:r,lastSn:s}=this,{cc:a,sn:o}=t.frag,l=null!=(n=null==(i=t.part)?void 0:i.index)?n:-1;e&&r&&(o!==s+1||o===s&&l!==this.lastPartIndex+1||a!==this.lastCc)&&(e.reset(),r.reset()),this.lastCc=a,this.lastSn=o,this.lastPartIndex=l}}onFragLoaded(e,t){const{frag:n,payload:i}=t;if(n.type===mt.SUBTITLE)if(i.byteLength){const e=n.decryptdata,r="stats"in t;if(null==e||!e.encrypted||r){const e=this.tracks[n.level],r=this.vttCCs;r[n.cc]||(r[n.cc]={start:n.start,prevCC:this.prevCC,new:!0},this.prevCC=n.cc),e&&"stpp.ttml.im1t"===e.textCodec?this._parseIMSC1(n,i):this._parseVTTs(t)}}else this.hls.trigger(v.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const n=this.hls;Lr(t,this.initPTS[e.cc],t=>{this._appendCues(t,e.level),n.trigger(v.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},t=>{I.log("Failed to parse IMSC1: "+t),n.trigger(v.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})})}_parseVTTs(e){var t;const{frag:n,payload:i}=e,{initPTS:r,unparsedVttFrags:s}=this,a=r.length-1;if(!r[n.cc]&&-1===a)return void s.push(e);const o=this.hls;!function(e,t,n,i,r,s,a){const o=new Rr,l=le(new Uint8Array(e)).trim().replace(Cr,"\n").split("\n"),c=[],d=t?function(e,t=1){return Ti(e,9e4,1/t)}(t.baseTime,t.timescale):0;let h,u="00:00.000",f=0,m=0,g=!0;o.oncue=function(e){const s=n[i];let a=n.ccOffset;const o=(f-d)/9e4;if(null!=s&&s.new&&(void 0!==m?a=n.ccOffset=s.start:function(e,t,n){let i=e[t],r=e[i.prevCC];if(!r||!r.new&&i.new)return e.ccOffset=e.presentationOffset=i.start,void(i.new=!1);for(;null!=(s=r)&&s.new;){var s;e.ccOffset+=i.start-r.start,i.new=!1,i=r,r=e[i.prevCC]}e.presentationOffset=n}(n,i,o)),o){if(!t)return void(h=new Error("Missing initPTS for VTT MPEGTS"));a=o-n.presentationOffset}const l=e.endTime-e.startTime,u=Ci(9e4*(e.startTime+a-m),9e4*r)/9e4;e.startTime=Math.max(u,0),e.endTime=Math.max(u+l,0);const p=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(p)),e.id||(e.id=Or(e.startTime,e.endTime,p)),e.endTime>0&&c.push(e)},o.onparsingerror=function(e){h=e},o.onflush=function(){h?a(h):s(c)},l.forEach(e=>{if(g){if(yr(e,"X-TIMESTAMP-MAP=")){g=!1,e.slice(16).split(",").forEach(e=>{yr(e,"LOCAL:")?u=e.slice(6):yr(e,"MPEGTS:")&&(f=parseInt(e.slice(7)))});try{m=function(e){let t=parseInt(e.slice(-3));const n=parseInt(e.slice(-6,-4)),i=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!(p(t)&&p(n)&&p(i)&&p(r)))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+e);return t+=1e3*n,t+=6e4*i,t+=36e5*r,t}(u)/1e3}catch(e){h=e}return}""===e&&(g=!1)}o.parse(e+"\n")}),o.flush()}(null!=(t=n.initSegment)&&t.data?xe(n.initSegment.data,new Uint8Array(i)):i,this.initPTS[n.cc],this.vttCCs,n.cc,n.start,e=>{this._appendCues(e,n.level),o.trigger(v.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:n})},t=>{const r="Missing initPTS for VTT MPEGTS"===t.message;r?s.push(e):this._fallbackToIMSC1(n,i),I.log("Failed to parse VTT cue: "+t),r&&a>n.cc||o.trigger(v.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:t})})}_fallbackToIMSC1(e,t){const n=this.tracks[e.level];n.textCodec||Lr(t,this.initPTS[e.cc],()=>{n.textCodec="stpp.ttml.im1t",this._parseIMSC1(e,t)},()=>{n.textCodec="wvtt"})}_appendCues(e,t){const n=this.hls;if(this.config.renderTextTracksNatively){const n=this.textTracks[t];if(!n||"disabled"===n.mode)return;e.forEach(e=>Et(n,e))}else{const i=this.tracks[t];if(!i)return;const r=i.default?"default":"subtitles"+t;n.trigger(v.CUES_PARSED,{type:"subtitles",cues:e,track:r})}}onFragDecrypted(e,t){const{frag:n}=t;n.type===mt.SUBTITLE&&this.onFragLoaded(v.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){this.initCea608Parsers();const{cea608Parser1:n,cea608Parser2:i}=this;if(!this.enabled||!n||!i)return;const{frag:r,samples:s}=t;if(r.type!==mt.MAIN||"NONE"!==this.closedCaptionsForLevel(r))for(let e=0;e<s.length;e++){const t=s[e].bytes;if(t){const r=this.extractCea608Data(t);n.addData(s[e].pts,r[0]),i.addData(s[e].pts,r[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:n,endOffsetSubtitles:i,type:r}){const{media:s}=this;if(s&&!(s.currentTime<n)){if(!r||"video"===r){const{captionsTracks:e}=this;Object.keys(e).forEach(i=>St(e[i],t,n))}if(this.config.renderTextTracksNatively&&0===t&&void 0!==i){const{textTracks:e}=this;Object.keys(e).forEach(n=>St(e[n],t,i))}}}extractCea608Data(e){const t=[[],[]],n=31&e[0];let i=2;for(let r=0;r<n;r++){const n=e[i++],r=127&e[i++],s=127&e[i++];if((0!==r||0!==s)&&0!=(4&n)){const e=3&n;0!==e&&1!==e||(t[e].push(r),t[e].push(s))}}return t}constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(v.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(v.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(v.FRAG_LOADING,this.onFragLoading,this),e.on(v.FRAG_LOADED,this.onFragLoaded,this),e.on(v.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(v.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(v.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(v.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(v.BUFFER_FLUSHING,this.onBufferFlushing,this)}}function Vr(e){return e.characteristics&&/transcribes-spoken-dialog/gi.test(e.characteristics)&&/describes-music-and-sound/gi.test(e.characteristics)?"captions":"subtitles"}function Gr(e,t){return!!e&&e.kind===Vr(t)&&Wi(t,e)}class Hr{setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(v.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(v.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(v.MANIFEST_PARSED,this.onManifestParsed,this),e.on(v.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(v.BUFFER_CODECS,this.onBufferCodecs,this),e.on(v.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(v.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(v.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(v.MANIFEST_PARSED,this.onManifestParsed,this),e.off(v.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(v.BUFFER_CODECS,this.onBufferCodecs,this),e.off(v.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const n=this.hls.levels[t.droppedLevel];this.isLevelAllowed(n)&&this.restrictedLevels.push({bitrate:n.bitrate,height:n.height,width:n.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const n=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,n.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&p(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0)return void(this.clientRect=null);const e=this.hls.levels;if(e.length){const t=this.hls,n=this.getMaxLevel(e.length-1);n!==this.autoLevelCapping&&I.log(`Setting autoLevelCapping to ${n}: ${e[n].height}p@${e[n].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=n,t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const n=t.filter((t,n)=>this.isLevelAllowed(t)&&n<=e);return this.clientRect=null,Hr.getMaxLevelByMediaSize(n,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const n=e.getBoundingClientRect();t.width=n.width,t.height=n.height,t.width||t.height||(t.width=n.right-n.left||e.width||0,t.height=n.bottom-n.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch(e){}return e}isLevelAllowed(e){return!this.restrictedLevels.some(t=>e.bitrate===t.bitrate&&e.width===t.width&&e.height===t.height)}static getMaxLevelByMediaSize(e,t,n){if(null==e||!e.length)return-1;let i=e.length-1;const r=Math.max(t,n);for(let t=0;t<e.length;t+=1){const n=e[t];if((n.width>=r||n.height>=r)&&(s=n,!(a=e[t+1])||s.width!==a.width||s.height!==a.height)){i=t;break}}var s,a;return i}constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}}class Wr{setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(v.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(v.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const n=this.hls.config;if(n.capLevelOnFPSDrop){const e=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=e,e&&"function"==typeof e.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),n.fpsDroppedMonitoringPeriod)}}checkFPS(e,t,n){const i=performance.now();if(t){if(this.lastTime){const e=i-this.lastTime,r=n-this.lastDroppedFrames,s=t-this.lastDecodedFrames,a=1e3*r/e,o=this.hls;if(o.trigger(v.FPS_DROP,{currentDropped:r,currentDecoded:s,totalDroppedFrames:n}),a>0&&r>o.config.fpsDroppedMonitoringThreshold*s){let e=o.currentLevel;I.warn("drop FPS ratio greater than max allowed value for currentLevel: "+e),e>0&&(-1===o.autoLevelCapping||o.autoLevelCapping>=e)&&(e-=1,o.trigger(v.FPS_DROP_LEVEL_CAPPING,{level:e,droppedLevel:o.currentLevel}),o.autoLevelCapping=e,this.streamController.nextLevelSwitch())}}this.lastTime=i,this.lastDroppedFrames=n,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}}class Xr{destroy(){this.unregisterListeners(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(v.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(v.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(v.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(v.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(v.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(v.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(v.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(v.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:n}=this.config,i=t[e];return i?i.licenseUrl:e===B.WIDEVINE&&n?n:void 0}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(void 0===t)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,n=t[e];if(n)return n.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,n=(e,t,n)=>!!e&&n.indexOf(e)===t,i=t.map(e=>e.audioCodec).filter(n),r=t.map(e=>e.videoCodec).filter(n);return i.length+r.length===0&&r.push("avc1.42e01e"),new Promise((t,n)=>{const s=e=>{const a=e.shift();this.getMediaKeysPromise(a,i,r).then(e=>t({keySystem:a,mediaKeys:e})).catch(t=>{e.length?s(e):n(t instanceof jr?t:new jr({type:E.KEY_SYSTEM_ERROR,details:T.KEY_SYSTEM_NO_ACCESS,error:t,fatal:!0},t.message))})};s(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:n}=this.config;if("function"!=typeof n){let e="Configured requestMediaKeySystemAccess is not a function "+n;return null===X&&"http:"===self.location.protocol&&(e="navigator.requestMediaKeySystemAccess is not available over insecure protocol "+location.protocol),Promise.reject(new Error(e))}return n(e,t)}getMediaKeysPromise(e,t,n){const i=function(e,t,n,i){let r;switch(e){case B.FAIRPLAY:r=["cenc","sinf"];break;case B.WIDEVINE:case B.PLAYREADY:r=["cenc"];break;case B.CLEARKEY:r=["cenc","keyids"];break;default:throw new Error("Unknown key-system: "+e)}return function(e,t,n,i){return[{initDataTypes:e,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:t.map(e=>({contentType:`audio/mp4; codecs="${e}"`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:n.map(e=>({contentType:`video/mp4; codecs="${e}"`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}(r,t,n,i)}(e,t,n,this.config.drmSystemOptions),r=this.keySystemAccessPromises[e];let s=null==r?void 0:r.keySystemAccess;if(!s){this.log(`Requesting encrypted media "${e}" key-system access with config: ${JSON.stringify(i)}`),s=this.requestMediaKeySystemAccess(e,i);const t=this.keySystemAccessPromises[e]={keySystemAccess:s};return s.catch(t=>{this.log(`Failed to obtain access to key-system "${e}": ${t}`)}),s.then(n=>{this.log(`Access for key-system "${n.keySystem}" obtained`);const i=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),t.mediaKeys=n.createMediaKeys().then(t=>(this.log(`Media-keys created for "${e}"`),i.then(n=>n?this.setMediaKeysServerCertificate(t,e,n):t))),t.mediaKeys.catch(t=>{this.error(`Failed to create media-keys for "${e}"}: ${t}`)}),t.mediaKeys})}return s.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:n}){this.log(`Creating key-system session "${t}" keyId: ${he(e.keyId||[])}`);const i=n.createSession(),r={decryptdata:e,keySystem:t,mediaKeys:n,mediaKeysSession:i,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const n=this.createMediaKeySessionContext(e),i=this.getKeyIdString(t),r="cenc";this.keyIdToKeySessionPromise[i]=this.generateRequestWithPreferredKeySession(n,r,t.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(null===e.keyId)throw new Error("keyId is null");return he(e.keyId)}updateKeySession(e,t){var n;const i=e.mediaKeysSession;return this.log(`Updating key-session "${i.sessionId}" for keyID ${he((null==(n=e.decryptdata)?void 0:n.keyId)||[])}\n      } (data length: ${t?t.byteLength:t})`),i.update(t)}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise((t,n)=>{const i=W(this.config),r=e.map(V).filter(e=>!!e&&-1!==i.indexOf(e));return this.getKeySystemSelectionPromise(r).then(({keySystem:e})=>{const i=H(e);i?t(i):n(new Error(`Unable to find format for key-system "${e}"`))}).catch(n)})}loadKey(e){const t=e.keyInfo.decryptdata,n=this.getKeyIdString(t),i=`(keyId: ${n} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log("Starting session for key "+i);let r=this.keyIdToKeySessionPromise[n];return r||(r=this.keyIdToKeySessionPromise[n]=this.getKeySystemForKeyPromise(t).then(({keySystem:n,mediaKeys:r})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${i}`),this.attemptSetMediaKeys(n,r).then(()=>{this.throwIfDestroyed();const e=this.createMediaKeySessionContext({keySystem:n,mediaKeys:r,decryptdata:t});return this.generateRequestWithPreferredKeySession(e,"cenc",t.pssh,"playlist-key")}))),r.catch(e=>this.handleError(e))),r}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof jr?this.hls.trigger(v.ERROR,e.data):this.hls.trigger(v.ERROR,{type:E.KEY_SYSTEM_ERROR,details:T.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),n=this.keyIdToKeySessionPromise[t];if(!n){const t=V(e.keyFormat),n=t?[t]:W(this.config);return this.attemptKeySystemAccess(n)}return n}getKeySystemSelectionPromise(e){if(e.length||(e=W(this.config)),0===e.length)throw new jr({type:E.KEY_SYSTEM_ERROR,details:T.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},"Missing key-system license configuration options "+JSON.stringify({drmSystems:this.config.drmSystems}));return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){const n=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const i=Promise.all(n).then(()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.setMediaKeysQueue.push(i),i.then(()=>{this.log(`Media-keys set for "${e}"`),n.push(i),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(e=>-1===n.indexOf(e))})}generateRequestWithPreferredKeySession(e,t,n,i){var r,s;const a=null==(r=this.config.drmSystems)||null==(s=r[e.keySystem])?void 0:s.generateRequest;if(a)try{const i=a.call(this.hls,t,n,e);if(!i)throw new Error("Invalid response from configured generateRequest filter");t=i.initDataType,n=e.decryptdata.pssh=i.initData?new Uint8Array(i.initData):null}catch(e){var o;if(this.warn(e.message),null!=(o=this.hls)&&o.config.debug)throw e}if(null===n)return this.log(`Skipping key-session request for "${i}" (no initData)`),Promise.resolve(e);const l=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${i}": ${l} (init data type: ${t} length: ${n?n.byteLength:null})`);const c=new Bi,d=e._onmessage=t=>{const n=e.mediaKeysSession;if(!n)return void c.emit("error",new Error("invalid state"));const{messageType:i,message:r}=t;this.log(`"${i}" message event for session "${n.sessionId}" message size: ${r.byteLength}`),"license-request"===i||"license-renewal"===i?this.renewLicense(e,r).catch(e=>{this.handleError(e),c.emit("error",e)}):"license-release"===i?e.keySystem===B.FAIRPLAY&&(this.updateKeySession(e,w("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${i}"`)},h=e._onkeystatuseschange=t=>{if(!e.mediaKeysSession)return void c.emit("error",new Error("invalid state"));this.onKeyStatusChange(e);const n=e.keyStatus;c.emit("keyStatus",n),"expired"===n&&(this.warn(`${e.keySystem} expired for key ${l}`),this.renewKeySession(e))};e.mediaKeysSession.addEventListener("message",d),e.mediaKeysSession.addEventListener("keystatuseschange",h);const u=new Promise((e,t)=>{c.on("error",t),c.on("keyStatus",n=>{n.startsWith("usable")?e():"output-restricted"===n?t(new jr({type:E.KEY_SYSTEM_ERROR,details:T.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===n?t(new jr({type:E.KEY_SYSTEM_ERROR,details:T.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${n}"`)):"expired"===n?t(new Error("key expired while generating request")):this.warn(`unhandled key status change "${n}"`)})});return e.mediaKeysSession.generateRequest(t,n).then(()=>{var t;this.log(`Request generated for key-session "${null==(t=e.mediaKeysSession)?void 0:t.sessionId}" keyId: ${l}`)}).catch(e=>{throw new jr({type:E.KEY_SYSTEM_ERROR,details:T.KEY_SYSTEM_NO_SESSION,error:e,fatal:!1},"Error generating key-session request: "+e)}).then(()=>u).catch(t=>{throw c.removeAllListeners(),this.removeSession(e),t}).then(()=>(c.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,n)=>{this.log(`key status change "${t}" for keyStatuses keyId: ${he("buffer"in n?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n))} session keyId: ${he(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,n=new(0,t.loader)(t),i=this.getServerCertificateUrl(e);return i?(this.log(`Fetching server certificate for "${e}"`),new Promise((r,s)=>{const a={responseType:"arraybuffer",url:i},o=t.certLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},c={onSuccess:(e,t,n,i)=>{r(e.data)},onError:(t,n,r,o)=>{s(new jr({type:E.KEY_SYSTEM_ERROR,details:T.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:r,response:u({url:a.url,data:void 0},t)},`"${e}" certificate request failed (${i}). Status: ${t.code} (${t.text})`))},onTimeout:(t,n,r)=>{s(new jr({type:E.KEY_SYSTEM_ERROR,details:T.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:r,response:{url:a.url,data:void 0}},`"${e}" certificate request timed out (${i})`))},onAbort:(e,t,n)=>{s(new Error("aborted"))}};n.load(a,l,c)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,n){return new Promise((i,r)=>{e.setServerCertificate(n).then(r=>{this.log(`setServerCertificate ${r?"success":"not supported by CDM"} (${null==n?void 0:n.byteLength}) on "${t}"`),i(e)}).catch(e=>{r(new jr({type:E.KEY_SYSTEM_ERROR,details:T.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:e,fatal:!0},e.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(t=>this.updateKeySession(e,new Uint8Array(t)).catch(e=>{throw new jr({type:E.KEY_SYSTEM_ERROR,details:T.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:e,fatal:!0},e.message)}))}unpackPlayReadyKeyMessage(e,t){const n=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!n.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const i=(new DOMParser).parseFromString(n,"application/xml"),r=i.querySelectorAll("HttpHeader");if(r.length>0){let t;for(let n=0,i=r.length;n<i;n++){var s,a;t=r[n];const i=null==(s=t.querySelector("name"))?void 0:s.textContent,o=null==(a=t.querySelector("value"))?void 0:a.textContent;i&&o&&e.setRequestHeader(i,o)}}const o=i.querySelector("Challenge"),l=null==o?void 0:o.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return w(atob(l))}setupLicenseXHR(e,t,n,i){const r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!n.decryptdata)throw new Error("Key removed");return r.call(this.hls,e,t,n,i)}).catch(s=>{if(!n.decryptdata)throw s;return e.open("POST",t,!0),r.call(this.hls,e,t,n,i)}).then(n=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:n||i})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:i}))}requestLicense(e,t){const n=this.config.keyLoadPolicy.default;return new Promise((i,r)=>{const s=this.getLicenseServerUrlOrThrow(e.keySystem);this.log("Sending license request to URL: "+s);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return r(new Error("invalid state"));if(4===a.readyState)if(200===a.status){this._requestLicenseFailureCount=0;let t=a.response;this.log("License received "+(t instanceof ArrayBuffer?t.byteLength:t));const n=this.config.licenseResponseCallback;if(n)try{t=n.call(this.hls,a,s,e)}catch(e){this.error(e)}i(t)}else{const o=n.errorRetry,l=o?o.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)r(new jr({type:E.KEY_SYSTEM_ERROR,details:T.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:a,response:{url:s,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${s}). Status: ${a.status} (${a.statusText})`));else{const n=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${n} attempts left`),this.requestLicense(e,t).then(i,r)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,s,e,t).then(({xhr:t,licenseChallenge:n})=>{e.keySystem==B.PLAYREADY&&(n=this.unpackPlayReadyKeyMessage(t,n)),t.send(n)})})}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const n=t.media;this.media=n,n.removeEventListener("encrypted",this.onMediaEncrypted),n.removeEventListener("waitingforkey",this.onWaitingForKey),n.addEventListener("encrypted",this.onMediaEncrypted),n.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media,t=this.mediaKeySessions;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},Ue.clearKeyUriToKeyIdMap();const n=t.length;Xr.CDMCleanupPromise=Promise.all(t.map(e=>this.removeSession(e)).concat(null==e?void 0:e.setMediaKeys(null).catch(e=>{this.log("Could not clear media keys: "+e)}))).then(()=>{n&&(this.log("finished closing key sessions and clearing media keys"),t.length=0)}).catch(e=>{this.log("Could not close sessions and clear media keys: "+e)})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(t&&this.config.emeEnabled&&!this.keyFormatPromise){const e=t.reduce((e,t)=>(-1===e.indexOf(t.keyFormat)&&e.push(t.keyFormat),e),[]);this.log("Selecting key-system from session-keys "+e.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(e)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:n}=e;if(t){this.log("Remove licenses and keys and close session "+t.sessionId),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),n&&n.readyState!==XMLHttpRequest.DONE&&n.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const i=this.mediaKeySessions.indexOf(e);return i>-1&&this.mediaKeySessions.splice(i,1),t.remove().catch(e=>{this.log("Could not remove session: "+e)}).then(()=>t.close()).catch(e=>{this.log("Could not close session: "+e)})}}constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=Xr.CDMCleanupPromise?[Xr.CDMCleanupPromise]:[],this.debug=I.debug.bind(I,"[eme]"),this.log=I.log.bind(I,"[eme]"),this.warn=I.warn.bind(I,"[eme]"),this.error=I.error.bind(I,"[eme]"),this.onMediaEncrypted=e=>{const{initDataType:t,initData:n}=e,i=`"${e.type}" event: init data type: "${t}"`;if(this.debug(i),null!==n){if(!this.keyFormatPromise){let e=Object.keys(this.keySystemAccessPromises);e.length||(e=W(this.config));const t=e.map(H).filter(e=>!!e);this.keyFormatPromise=this.getKeyFormatPromise(t)}this.keyFormatPromise.then(r=>{const s=V(r);let a,o;if("sinf"===t){if(s!==B.FAIRPLAY)return void this.warn(`Ignoring unexpected "${e.type}" event with init data type: "${t}" for selected key-system ${s}`);const r=pe(new Uint8Array(n));try{const e=Me(F(JSON.parse(r).sinf));if(!e)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");a=e.subarray(8,24),o=B.FAIRPLAY}catch(e){return void this.warn(`${i} Failed to parse sinf: ${e}`)}}else{if(s!==B.WIDEVINE&&s!==B.PLAYREADY)return void this.warn(`Ignoring unexpected "${e.type}" event with init data type: "${t}" for selected key-system ${s}`);const r=function(e){const t=[];if(e instanceof ArrayBuffer){const n=e.byteLength;let i=0;for(;i+32<n;){const n=Fe(new DataView(e,i));t.push(n),i+=n.size}}return t}(n),l=r.filter(e=>!!e.systemId&&G(e.systemId)===s);l.length>1&&this.warn(`${i} Using first of ${l.length} pssh found for selected key-system ${s}`);const c=l[0];if(!c)return void(0===r.length||r.some(e=>!e.systemId)?this.warn(i+" contains incomplete or invalid pssh data"):this.log(`ignoring ${i} for ${r.map(e=>G(e.systemId)).join(",")} pssh data in favor of playlist keys`));if(o=G(c.systemId),0===c.version&&c.data)if(o===B.WIDEVINE){const e=c.data.length-22;a=c.data.subarray(e,e+16)}else o===B.PLAYREADY&&(a=z(c.data))}if(!o||!a)return void this.log(`Unable to handle ${i} with key-system ${s}`);const l=he(a),{keyIdToKeySessionPromise:c,mediaKeySessions:d}=this;let h=c[l];for(let e=0;e<d.length;e++){const i=d[e],r=i.decryptdata;if(!r.keyId)continue;const s=he(r.keyId);if(l===s||-1!==r.uri.replace(/-/g,"").indexOf(l)){if(h=c[s],r.pssh)break;delete c[s],r.pssh=new Uint8Array(n),r.keyId=a,h=c[l]=h.then(()=>this.generateRequestWithPreferredKeySession(i,t,n,"encrypted-event-key-match")),h.catch(e=>this.handleError(e));break}}if(!h){if(o!==s)return void this.log(`Ignoring "${i}" with ${o} init data for selected key-system ${s}`);h=c[l]=this.getKeySystemSelectionPromise([o]).then(({keySystem:e,mediaKeys:i})=>{var r;this.throwIfDestroyed();const s=new Ue("ISO-23001-7",l,null!=(r=H(e))?r:"");return s.pssh=new Uint8Array(n),s.keyId=a,this.attemptSetMediaKeys(e,i).then(()=>{this.throwIfDestroyed();const r=this.createMediaKeySessionContext({decryptdata:s,keySystem:e,mediaKeys:i});return this.generateRequestWithPreferredKeySession(r,t,n,"encrypted-event-no-match")})}),h.catch(e=>this.handleError(e))}})}},this.onWaitingForKey=e=>{this.log(`"${e.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}}Xr.CDMCleanupPromise=void 0;class jr extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}var zr,Kr,Yr;!function(e){e.MANIFEST="m",e.AUDIO="a",e.VIDEO="v",e.MUXED="av",e.INIT="i",e.CAPTION="c",e.TIMED_TEXT="tt",e.KEY="k",e.OTHER="o"}(zr||(zr={})),function(e){e.DASH="d",e.HLS="h",e.SMOOTH="s",e.OTHER="o"}(Kr||(Kr={})),function(e){e.OBJECT="CMCD-Object",e.REQUEST="CMCD-Request",e.SESSION="CMCD-Session",e.STATUS="CMCD-Status"}(Yr||(Yr={}));const qr={[Yr.OBJECT]:["br","d","ot","tb"],[Yr.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[Yr.SESSION]:["cid","pr","sf","sid","st","v"],[Yr.STATUS]:["bs","rtp"]};class Qr{constructor(e,t){this.value=void 0,this.params=void 0,Array.isArray(e)&&(e=e.map(e=>e instanceof Qr?e:new Qr(e))),this.value=e,this.params=t}}class Zr{constructor(e){this.description=void 0,this.description=e}}const $r=/[\x00-\x1f\x7f]+/;function Jr(e,t,n){return function(e,t,n,i){return new Error(`failed to ${e} "${r=t,Array.isArray(r)?JSON.stringify(r):r instanceof Map?"Map{}":r instanceof Set?"Set{}":"object"==typeof r?JSON.stringify(r):String(r)}" as ${n}`,{cause:i});var r}("serialize",e,t,n)}function es(e){if(function(e){return e<-999999999999999||999999999999999<e}(e))throw Jr(e,"Integer");return e.toString()}function ts(e){const t=(n=e).description||n.toString().slice(7,-1);var n;if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t))throw Jr(t,"Token");return t}function ns(e){switch(typeof e){case"number":if(!p(e))throw Jr(e,"Bare Item");return Number.isInteger(e)?es(e):function(e){const t=function e(t,n){if(t<0)return-e(-t,n);const i=Math.pow(10,n);if(Math.abs(t*i%1-.5)<Number.EPSILON){const e=Math.floor(t*i);return(e%2==0?e:e+1)/i}return Math.round(t*i)/i}(e,3);if(Math.floor(Math.abs(t)).toString().length>12)throw Jr(e,"Decimal");const n=t.toString();return n.includes(".")?n:n+".0"}(e);case"string":return function(e){if($r.test(e))throw Jr(e,"String");return`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}(e);case"symbol":return ts(e);case"boolean":return function(e){if("boolean"!=typeof e)throw Jr(e,"Boolean");return e?"?1":"?0"}(e);case"object":if(e instanceof Date)return function(e){return"@"+es(e.getTime()/1e3)}(e);if(e instanceof Uint8Array)return function(e){if(!1===ArrayBuffer.isView(e))throw Jr(e,"Byte Sequence");return`:${t=e,btoa(String.fromCharCode(...t))}:`;var t}(e);if(e instanceof Zr)return ts(e);default:throw Jr(e,"Bare Item")}}function is(e){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(e))throw Jr(e,"Key");return e}function rs(e){return null==e?"":Object.entries(e).map(([e,t])=>!0===t?";"+is(e):`;${is(e)}=${ns(t)}`).join("")}function ss(e){return e instanceof Qr?`${ns(e.value)}${rs(e.params)}`:ns(e)}const as=e=>Math.round(e),os=e=>100*as(e/100),ls={br:as,d:as,bl:os,dl:os,mtp:os,nor:(e,t)=>(null!=t&&t.baseUrl&&(e=function(e,t){const n=new URL(e),i=new URL(t);if(n.origin!==i.origin)return e;const r=n.pathname.split("/").slice(1),s=i.pathname.split("/").slice(1,-1);for(;r[0]===s[0];)r.shift(),s.shift();for(;s.length;)s.shift(),r.unshift("..");return r.join("/")}(e,t.baseUrl)),encodeURIComponent(e)),rtp:os,tb:as};function cs(e,t={}){return e?function(e,t){return function(e,t={whitespace:!0}){if("object"!=typeof e)throw Jr(e,"Dict");const n=e instanceof Map?e.entries():Object.entries(e),i=null!=t&&t.whitespace?" ":"";return Array.from(n).map(([e,t])=>{t instanceof Qr==0&&(t=new Qr(t));let n=is(e);var i;return!0===t.value?n+=rs(t.params):(n+="=",Array.isArray(t.value)?n+=`(${(i=t).value.map(ss).join(" ")})${rs(i.params)}`:n+=ss(t)),n}).join(","+i)}(e,t)}(function(e,t){const n={};if(null==e||"object"!=typeof e)return n;const i=Object.keys(e).sort(),r=m({},ls,null==t?void 0:t.formatters),s=null==t?void 0:t.filter;return i.forEach(i=>{if(null!=s&&s(i))return;let a=e[i];const o=r[i];o&&(a=o(a,t)),"v"===i&&1===a||"pr"==i&&1===a||(e=>"number"==typeof e?p(e):null!=e&&""!==e&&!1!==e)(a)&&((e=>"ot"===e||"sf"===e||"st"===e)(i)&&"string"==typeof a&&(a=new Zr(a)),n[i]=a)}),n}(e,t),m({whitespace:!1},t)):""}const ds=/CMCD=[^&#]+/;class hs{registerListeners(){const e=this.hls;e.on(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(v.MEDIA_DETACHED,this.onMediaDetached,this),e.on(v.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(v.MEDIA_DETACHED,this.onMediaDetached,this),e.off(v.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var n,i;this.audioBuffer=null==(n=t.tracks.audio)?void 0:n.buffer,this.videoBuffer=null==(i=t.tracks.video)?void 0:i.buffer}createData(){var e;return{v:1,sf:Kr.HLS,sid:this.sid,cid:this.cid,pr:null==(e=this.media)?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){m(t,this.createData());const n=t.ot===zr.INIT||t.ot===zr.VIDEO||t.ot===zr.MUXED;this.starved&&n&&(t.bs=!0,t.su=!0,this.starved=!1),null==t.su&&(t.su=this.buffering);const{includeKeys:i}=this;var r;i&&(t=Object.keys(t).reduce((e,n)=>(i.includes(n)&&(e[n]=t[n]),e),{})),this.useHeaders?(e.headers||(e.headers={}),m(e.headers,function(e,t={}){if(!e)return{};const n=Object.entries(e),i=Object.entries(qr).concat(Object.entries((null==t?void 0:t.customHeaderMap)||{})),r=n.reduce((e,t)=>{var n;const[r,s]=t,a=(null==(n=i.find(e=>e[1].includes(r)))?void 0:n[0])||Yr.REQUEST;return null!=e[a]||(e[a]={}),e[a][r]=s,e},{});return Object.entries(r).reduce((e,[n,i])=>(e[n]=cs(i,t),e),{})}(t,r))):e.url=function(e,t,n){const i=function(e,t={}){if(!e)return"";const n=cs(e,t);return"CMCD="+encodeURIComponent(n)}(t,n);if(!i)return e;if(ds.test(e))return e.replace(ds,i);const r=e.includes("?")?"&":"?";return`${e}${r}${i}`}(e.url,t)}getObjectType(e){const{type:t}=e;return"subtitle"===t?zr.TIMED_TEXT:"initSegment"===e.sn?zr.INIT:"audio"===t?zr.AUDIO:"main"===t?this.hls.audioTracks.length?zr.VIDEO:zr.MUXED:void 0}getTopBandwidth(e){let t,n=0;const i=this.hls;if(e===zr.AUDIO)t=i.audioTracks;else{const e=i.maxAutoLevel,n=e>-1?e+1:i.levels.length;t=i.levels.slice(0,n)}for(const e of t)e.bitrate>n&&(n=e.bitrate);return n>0?n:NaN}getBufferLength(e){const t=this.hls.media,n=e===zr.AUDIO?this.audioBuffer:this.videoBuffer;return n&&t?1e3*Tn.bufferInfo(n,t.currentTime,this.config.maxBufferHole).len:NaN}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,n=e||this.config.loader;return class{get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,n,i){t(e),this.loader.load(e,n,i)}constructor(e){this.loader=void 0,this.loader=new n(e)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,n=e||this.config.loader;return class{get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,n,i){t(e),this.loader.load(e,n,i)}constructor(e){this.loader=void 0,this.loader=new n(e)}}}constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=e=>{try{this.apply(e,{ot:zr.MANIFEST,su:!this.initialized})}catch(e){I.warn("Could not generate manifest CMCD data.",e)}},this.applyFragmentData=e=>{try{const t=e.frag,n=this.hls.levels[t.level],i=this.getObjectType(t),r={d:1e3*t.duration,ot:i};i!==zr.VIDEO&&i!==zr.AUDIO&&i!=zr.MUXED||(r.br=n.bitrate/1e3,r.tb=this.getTopBandwidth(i)/1e3,r.bl=this.getBufferLength(i)),this.apply(e,r)}catch(e){I.warn("Could not generate segment CMCD data.",e)}},this.hls=e;const t=this.config=e.config,{cmcd:n}=t;null!=n&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=n.sessionId||function(){try{return crypto.randomUUID()}catch(e){try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch(e){let t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?n:3&n|8).toString(16)})}}}(),this.cid=n.contentId,this.useHeaders=!0===n.useHeaders,this.includeKeys=n.includeKeys,this.registerListeners())}}class us{registerListeners(){const e=this.hls;e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(v.MANIFEST_PARSED,this.onManifestParsed,this),e.on(v.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(v.MANIFEST_PARSED,this.onManifestParsed,this),e.off(v.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=1e3*this.timeToLoad-(performance.now()-this.updated);if(e>0)return void this.scheduleRefresh(this.uri,e)}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(t=>t!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:n}=t;null!==n&&(this.pathwayId=n.pathwayId,this.uri=n.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:n}=t;if((null==n?void 0:n.action)===Jt.SendAlternateToPenaltyBox&&n.flags===en.MoveAllAlternatesMatchingHost){const e=this.levels;let i=this.pathwayPriority,r=this.pathwayId;if(t.context){const{groupId:n,pathwayId:i,type:s}=t.context;n&&e?r=this.getPathwayForGroupId(n,s,r):i&&(r=i)}r in this.penalizedPathways||(this.penalizedPathways[r]=performance.now()),!i&&e&&(i=e.reduce((e,t)=>(-1===e.indexOf(t.pathwayId)&&e.push(t.pathwayId),e),[])),i&&i.length>1&&(this.updatePathwayPriority(i),n.resolved=this.pathwayId!==r),n.resolved||I.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${r} levels: ${e?e.length:e} priorities: ${JSON.stringify(i)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(0===t.length){const n=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${n}"`),t=this.getLevelsForPathway(n),this.pathwayId=n}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return null===this.levels?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){let t;this.pathwayPriority=e;const n=this.penalizedPathways,i=performance.now();Object.keys(n).forEach(e=>{i-n[e]>3e5&&delete n[e]});for(let i=0;i<e.length;i++){const r=e[i];if(r in n)continue;if(r===this.pathwayId)return;const s=this.hls.nextLoadLevel,a=this.hls.levels[s];if(t=this.getLevelsForPathway(r),t.length>0){this.log(`Setting Pathway to "${r}"`),this.pathwayId=r,Wt(t),this.hls.trigger(v.LEVELS_UPDATED,{levels:t});const e=this.hls.levels[s];a&&e&&this.levels&&(e.attrs["STABLE-VARIANT-ID"]!==a.attrs["STABLE-VARIANT-ID"]&&e.bitrate!==a.bitrate&&this.log(`Unstable Pathways change from bitrate ${a.bitrate} to ${e.bitrate}`),this.hls.nextLoadLevel=s);break}}}getPathwayForGroupId(e,t,n){const i=this.getLevelsForPathway(n).concat(this.levels||[]);for(let n=0;n<i.length;n++)if("audioTrack"===t&&i[n].hasAudioGroup(e)||"subtitleTrack"===t&&i[n].hasSubtitleGroup(e))return i[n].pathwayId;return n}clonePathways(e){const t=this.levels;if(!t)return;const n={},i={};e.forEach(e=>{const{ID:r,"BASE-ID":s,"URI-REPLACEMENT":a}=e;if(t.some(e=>e.pathwayId===r))return;const o=this.getLevelsForPathway(s).map(e=>{const t=new y(e.attrs);t["PATHWAY-ID"]=r;const s=t.AUDIO&&`${t.AUDIO}_clone_${r}`,o=t.SUBTITLES&&`${t.SUBTITLES}_clone_${r}`;s&&(n[t.AUDIO]=s,t.AUDIO=s),o&&(i[t.SUBTITLES]=o,t.SUBTITLES=o);const l=ms(e.uri,t["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",a),c=new Ft({attrs:t,audioCodec:e.audioCodec,bitrate:e.bitrate,height:e.height,name:e.name,url:l,videoCodec:e.videoCodec,width:e.width});if(e.audioGroups)for(let t=1;t<e.audioGroups.length;t++)c.addGroupId("audio",`${e.audioGroups[t]}_clone_${r}`);if(e.subtitleGroups)for(let t=1;t<e.subtitleGroups.length;t++)c.addGroupId("text",`${e.subtitleGroups[t]}_clone_${r}`);return c});t.push(...o),fs(this.audioTracks,n,a,r),fs(this.subtitleTracks,i,a,r)})}loadSteeringManifest(e){const t=this.hls.config,n=t.loader;let i;this.loader&&this.loader.destroy(),this.loader=new n(t);try{i=new self.URL(e)}catch(t){return this.enabled=!1,void this.log("Failed to parse Steering Manifest URI: "+e)}if("data:"!==i.protocol){const e=0|(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate);i.searchParams.set("_HLS_pathway",this.pathwayId),i.searchParams.set("_HLS_throughput",""+e)}const r={responseType:"json",url:i.href},s=t.steeringManifestLoadPolicy.default,a=s.errorRetry||s.timeoutRetry||{},o={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(e,t,n,r)=>{this.log(`Loaded steering manifest: "${i}"`);const s=e.data;if(1!==s.VERSION)return void this.log(`Steering VERSION ${s.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=s.TTL;const{"RELOAD-URI":a,"PATHWAY-CLONES":o,"PATHWAY-PRIORITY":l}=s;if(a)try{this.uri=new self.URL(a,i).href}catch(e){return this.enabled=!1,void this.log("Failed to parse Steering Manifest RELOAD-URI: "+a)}this.scheduleRefresh(this.uri||n.url),o&&this.clonePathways(o);const c={steeringManifest:s,url:i.toString()};this.hls.trigger(v.STEERING_MANIFEST_LOADED,c),l&&this.updatePathwayPriority(l)},onError:(e,t,n,i)=>{if(this.log(`Error loading steering manifest: ${e.code} ${e.text} (${t.url})`),this.stopLoad(),410===e.code)return this.enabled=!1,void this.log(`Steering manifest ${t.url} no longer available`);let r=1e3*this.timeToLoad;if(429!==e.code)this.scheduleRefresh(this.uri||t.url,r);else{const e=this.loader;if("function"==typeof(null==e?void 0:e.getResponseHeader)){const t=e.getResponseHeader("Retry-After");t&&(r=1e3*parseFloat(t))}this.log(`Steering manifest ${t.url} rate limited`)}},onTimeout:(e,t,n)=>{this.log(`Timeout loading steering manifest (${t.url})`),this.scheduleRefresh(this.uri||t.url)}};this.log("Requesting steering manifest: "+i),this.loader.load(r,o,l)}scheduleRefresh(e,t=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var t;const n=null==(t=this.hls)?void 0:t.media;!n||n.ended?this.scheduleRefresh(e,1e3*this.timeToLoad):this.loadSteeringManifest(e)},t)}constructor(e){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.log=I.log.bind(I,"[content-steering]:"),this.registerListeners()}}function fs(e,t,n,i){e&&Object.keys(t).forEach(r=>{const s=e.filter(e=>e.groupId===r).map(e=>{const s=m({},e);return s.details=void 0,s.attrs=new y(s.attrs),s.url=s.attrs.URI=ms(e.url,e.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",n),s.groupId=s.attrs["GROUP-ID"]=t[r],s.attrs["PATHWAY-ID"]=i,s});e.push(...s)})}function ms(e,t,n,i){const{HOST:r,PARAMS:s,[n]:a}=i;let o;t&&(o=null==a?void 0:a[t],o&&(e=o));const l=new self.URL(e);return r&&!o&&(l.host=r),s&&Object.keys(s).sort().forEach(e=>{e&&l.searchParams.set(e,s[e])}),l.href}const ps=/^age:\s*[\d.]+\s*$/im;class gs{destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,n){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=n,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const n=this.loader=new self.XMLHttpRequest,i=this.stats;i.loading.first=0,i.loaded=0,i.aborted=!1;const r=this.xhrSetup;r?Promise.resolve().then(()=>{if(this.loader===n&&!this.stats.aborted)return r(n,t.url)}).catch(e=>{if(this.loader===n&&!this.stats.aborted)return n.open("GET",t.url,!0),r(n,t.url)}).then(()=>{this.loader!==n||this.stats.aborted||this.openAndSendXhr(n,t,e)}).catch(e=>{this.callbacks.onError({code:n.status,text:e.message},t,n,i)}):this.openAndSendXhr(n,t,e)}openAndSendXhr(e,t,n){e.readyState||e.open("GET",t.url,!0);const i=t.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:s}=n.loadPolicy;if(i)for(const t in i)e.setRequestHeader(t,i[t]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),n.timeout=r&&p(r)?r:s,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),n.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:n}=this;if(!e||!t)return;const i=t.readyState,r=this.config;if(!n.aborted&&i>=2&&(0===n.loading.first&&(n.loading.first=Math.max(self.performance.now(),n.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(n.loading.first-n.loading.start)))),4===i)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const i=t.status,s="text"===t.responseType?t.responseText:null;if(i>=200&&i<300){const r=null!=s?s:t.response;if(null!=r){n.loading.end=Math.max(self.performance.now(),n.loading.first);const s="arraybuffer"===t.responseType?r.byteLength:r.length;if(n.loaded=n.total=s,n.bwEstimate=8e3*n.total/(n.loading.end-n.loading.first),!this.callbacks)return;const a=this.callbacks.onProgress;if(a&&a(n,e,r,t),!this.callbacks)return;const o={url:t.responseURL,data:r,code:i};return void this.callbacks.onSuccess(o,n,e,t)}}const a=r.loadPolicy.errorRetry;Yt(a,n.retry,!1,{url:e.url,data:void 0,code:i})?this.retry(a):(I.error(`${i} while loading ${e.url}`),this.callbacks.onError({code:i,text:t.statusText},e,t,n))}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry;if(Yt(e,this.stats.retry,!0))this.retry(e);else{var t;I.warn("timeout while loading "+(null==(t=this.context)?void 0:t.url));const e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:n}=this;this.retryDelay=zt(e,n.retry),n.retry++,I.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==t?void 0:t.url}, retrying ${n.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&ps.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new x,this.retryDelay=0}}const _s=/(\d+)-(\d+)\/(\d+)/;class vs{destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,n){const i=this.stats;if(i.loading.start)throw new Error("Loader can only be used once.");i.loading.start=self.performance.now();const r=function(e,t){const n={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(m({},e.headers))};return e.rangeEnd&&n.headers.set("Range","bytes="+e.rangeStart+"-"+String(e.rangeEnd-1)),n}(e,this.controller.signal),s=n.onProgress,a="arraybuffer"===e.responseType,o=a?"byteLength":"length",{maxTimeToFirstByteMs:l,maxLoadTimeMs:c}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=n,this.request=this.fetchSetup(e,r),self.clearTimeout(this.requestTimeout),t.timeout=l&&p(l)?l:c,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),n.onTimeout(i,e,this.response)},t.timeout),self.fetch(this.request).then(r=>{this.response=this.loader=r;const o=Math.max(self.performance.now(),i.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=c,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),n.onTimeout(i,e,this.response)},c-(o-i.loading.start)),!r.ok){const{status:e,statusText:t}=r;throw new Ts(t||"fetch, bad network response",e,r)}return i.loading.first=o,i.total=function(e){const t=e.get("Content-Range");if(t){const e=function(e){const t=_s.exec(e);if(t)return parseInt(t[2])-parseInt(t[1])+1}(t);if(p(e))return e}const n=e.get("Content-Length");if(n)return parseInt(n)}(r.headers)||i.total,s&&p(t.highWaterMark)?this.loadProgressively(r,i,e,t.highWaterMark,s):a?r.arrayBuffer():"json"===e.responseType?r.json():r.text()}).then(r=>{const a=this.response;if(!a)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),i.loading.end=Math.max(self.performance.now(),i.loading.first);const l=r[o];l&&(i.loaded=i.total=l);const c={url:a.url,data:r,code:a.status};s&&!p(t.highWaterMark)&&s(i,e,r,a),n.onSuccess(c,i,e,a)}).catch(t=>{if(self.clearTimeout(this.requestTimeout),i.aborted)return;const r=t&&t.code||0,s=t?t.message:null;n.onError({code:r,text:s},e,t?t.details:null,i)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,n,i=0,r){const s=new wn,a=e.body.getReader(),o=()=>a.read().then(a=>{if(a.done)return s.dataLength&&r(t,n,s.flush(),e),Promise.resolve(new ArrayBuffer(0));const l=a.value,c=l.length;return t.loaded+=c,c<i||s.dataLength?(s.push(l),s.dataLength>=i&&r(t,n,s.flush(),e)):r(t,n,l,e),o()}).catch(()=>Promise.reject());return o()}constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||Es,this.controller=new self.AbortController,this.stats=new x}}function Es(e,t){return new self.Request(e.url,t)}class Ts extends Error{constructor(e,t,n){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=n}}const Ss=/\s/,As=u(u({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:gs,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:pn,bufferController:Qi,capLevelController:Hr,errorController:tn,fpsController:Wr,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:X,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:{newCue(e,t,n,i){const r=[];let s,a,o,l,c;const d=self.VTTCue||self.TextTrackCue;for(let u=0;u<i.rows.length;u++)if(s=i.rows[u],o=!0,l=0,c="",!s.isEmpty()){var h;for(let e=0;e<s.chars.length;e++)Ss.test(s.chars[e].uchar)&&o?l++:(c+=s.chars[e].uchar,o=!1);s.cueStartTime=t,t===n&&(n+=1e-4),l>=16?l--:l++;const i=Ir(c.trim()),f=Or(t,n,i);null!=e&&null!=(h=e.cues)&&h.getCueById(f)||(a=new d(t,n,i),a.id=f,a.line=u+1,a.align="left",a.position=10+Math.min(80,10*Math.floor(8*l/32)),r.push(a))}return e&&r.length&&(r.sort((e,t)=>"auto"===e.line||"auto"===t.line?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line),r.forEach(t=>Et(e,t))),r}},enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:ji,subtitleTrackController:Ki,timelineController:kr,audioStreamController:Vi,audioTrackController:Xi,emeController:Xr,cmcdController:hs,contentSteeringController:us});function bs(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(bs):Object.keys(e).reduce((t,n)=>(t[n]=bs(e[n]),t),{}):e}let Is;class Rs extends nn{_registerListeners(){const{hls:e}=this;e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(v.LEVEL_LOADED,this.onLevelLoaded,this),e.on(v.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(v.FRAG_BUFFERED,this.onFragBuffered,this),e.on(v.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(v.LEVEL_LOADED,this.onLevelLoaded,this),e.off(v.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(v.FRAG_BUFFERED,this.onFragBuffered,this),e.off(v.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(e=>{e.loadError=0,e.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const n=this.hls.config.preferManagedMediaSource,i=[],r={},s={};let a=!1,o=!1,l=!1;t.levels.forEach(e=>{var t,c;const d=e.attrs;let{audioCodec:h,videoCodec:u}=e;-1!==(null==(t=h)?void 0:t.indexOf("mp4a.40.34"))&&(Is||(Is=/chrome|firefox/i.test(navigator.userAgent)),Is&&(e.audioCodec=h=void 0)),h&&(e.audioCodec=h=Je(h,n)),0===(null==(c=u)?void 0:c.indexOf("avc1"))&&(u=e.videoCodec=function(e){const t=e.split(",");for(let e=0;e<t.length;e++){const n=t[e].split(".");if(n.length>2){let i=n.shift()+".";i+=parseInt(n.shift()).toString(16),i+=("000"+parseInt(n.shift()).toString(16)).slice(-4),t[e]=i}}return t.join(",")}(u));const{width:f,height:m,unknownCodecs:p}=e;if(a||(a=!(!f||!m)),o||(o=!!u),l||(l=!!h),null!=p&&p.length||h&&!ze(h,"audio",n)||u&&!ze(u,"video",n))return;const{CODECS:g,"FRAME-RATE":_,"HDCP-LEVEL":v,"PATHWAY-ID":E,RESOLUTION:T,"VIDEO-RANGE":S}=d,A=`${(E||".")+"-"}${e.bitrate}-${T}-${_}-${g}-${S}-${v}`;if(r[A])if(r[A].uri===e.url||e.attrs["PATHWAY-ID"])r[A].addGroupId("audio",d.AUDIO),r[A].addGroupId("text",d.SUBTITLES);else{const t=s[A]+=1;e.attrs["PATHWAY-ID"]=new Array(t+1).join(".");const n=new Ft(e);r[A]=n,i.push(n)}else{const t=new Ft(e);r[A]=t,s[A]=1,i.push(t)}}),this.filterAndSortMediaOptions(i,t,a,o,l)}filterAndSortMediaOptions(e,t,n,i,r){let s=[],a=[],o=e;if((n||i)&&r&&(o=o.filter(({videoCodec:e,videoRange:t,width:n,height:i})=>{return(!!e||!(!n||!i))&&!!(r=t)&&Dt.indexOf(r)>-1;var r})),0===o.length)return void Promise.resolve().then(()=>{if(this.hls){t.levels.length&&this.warn("One or more CODECS in variant not supported: "+JSON.stringify(t.levels[0].attrs));const e=new Error("no level with compatible codecs found in manifest");this.hls.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:e,reason:e.message})}});if(t.audioTracks){const{preferManagedMediaSource:e}=this.hls.config;s=t.audioTracks.filter(t=>!t.audioCodec||ze(t.audioCodec,"audio",e)),Cs(s)}t.subtitles&&(a=t.subtitles,Cs(a));const l=o.slice(0);o.sort((e,t)=>{if(e.attrs["HDCP-LEVEL"]!==t.attrs["HDCP-LEVEL"])return(e.attrs["HDCP-LEVEL"]||"")>(t.attrs["HDCP-LEVEL"]||"")?1:-1;if(n&&e.height!==t.height)return e.height-t.height;if(e.frameRate!==t.frameRate)return e.frameRate-t.frameRate;if(e.videoRange!==t.videoRange)return Dt.indexOf(e.videoRange)-Dt.indexOf(t.videoRange);if(e.videoCodec!==t.videoCodec){const n=qe(e.videoCodec),i=qe(t.videoCodec);if(n!==i)return i-n}if(e.uri===t.uri&&e.codecSet!==t.codecSet){const n=Qe(e.codecSet),i=Qe(t.codecSet);if(n!==i)return i-n}return e.averageBitrate!==t.averageBitrate?e.averageBitrate-t.averageBitrate:0});let c=l[0];if(this.steering&&(o=this.steering.filterParsedLevels(o),o.length!==l.length))for(let e=0;e<l.length;e++)if(l[e].pathwayId===o[0].pathwayId){c=l[e];break}this._levels=o;for(let e=0;e<o.length;e++)if(o[e]===c){var d;this._firstLevel=e;const t=c.bitrate,n=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${o.length} level(s) found, first bitrate: ${t}`),void 0===(null==(d=this.hls.userConfig)?void 0:d.abrEwmaDefaultEstimate)){const e=Math.min(t,this.hls.config.abrEwmaDefaultEstimateMax);e>n&&n===As.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=e)}break}const h=r&&!i,u={levels:o,audioTracks:s,subtitleTracks:a,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:r,video:i,altAudio:!h&&s.some(e=>!!e.url)};this.hls.trigger(v.MANIFEST_PARSED,u),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(0===t.length)return;if(e<0||e>=t.length){const n=new Error("invalid level idx"),i=e<0;if(this.hls.trigger(v.ERROR,{type:E.OTHER_ERROR,details:T.LEVEL_SWITCH_ERROR,level:e,fatal:i,error:n,reason:n.message}),i)return;e=Math.min(e,t.length-1)}const n=this.currentLevelIndex,i=this.currentLevel,r=i?i.attrs["PATHWAY-ID"]:void 0,s=t[e],a=s.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=s,n===e&&s.details&&i&&r===a)return;this.log(`Switching to level ${e} (${s.height?s.height+"p ":""}${s.videoRange?s.videoRange+" ":""}${s.codecSet?s.codecSet+" ":""}@${s.bitrate})${a?" with Pathway "+a:""} from level ${n}${r?" with Pathway "+r:""}`);const o={level:e,attrs:s.attrs,details:s.details,bitrate:s.bitrate,averageBitrate:s.averageBitrate,maxBitrate:s.maxBitrate,realBitrate:s.realBitrate,width:s.width,height:s.height,codecSet:s.codecSet,audioCodec:s.audioCodec,videoCodec:s.videoCodec,audioGroups:s.audioGroups,subtitleGroups:s.subtitleGroups,loaded:s.loaded,loadError:s.loadError,fragmentError:s.fragmentError,name:s.name,id:s.id,uri:s.uri,url:s.url,urlId:0,audioGroupIds:s.audioGroupIds,textGroupIds:s.textGroupIds};this.hls.trigger(v.LEVEL_SWITCHING,o);const l=s.details;if(!l||l.live){const e=this.switchParams(s.uri,null==i?void 0:i.details,l);this.loadPlaylist(e)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(void 0===this._startLevel){const e=this.hls.config.startLevel;return void 0!==e?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}onError(e,t){!t.fatal&&t.context&&"level"===t.context.type&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(void 0!==t&&t.type===mt.MAIN){const e=t.elementaryStreams;if(!Object.keys(e).some(t=>!!e[t]))return;const n=this._levels[t.level];null!=n&&n.loadError&&(this.log(`Resetting level error count of ${n.loadError} on frag buffered`),n.loadError=0)}}onLevelLoaded(e,t){var n;const{level:i,details:r}=t,s=this._levels[i];var a;if(!s)return this.warn("Invalid level index "+i),void(null!=(a=t.deliveryDirectives)&&a.skip&&(r.deltaUpdateFailed=!0));i===this.currentLevelIndex?(0===s.fragmentError&&(s.loadError=0),this.playlistLoaded(i,t,s.details)):null!=(n=t.deliveryDirectives)&&n.skip&&(r.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist();const t=this.currentLevelIndex,n=this.currentLevel;if(n&&this.shouldLoadPlaylist(n)){let i=n.uri;if(e)try{i=e.addDirectives(i)}catch(e){this.warn("Could not construct new URL with HLS Delivery Directives: "+e)}const r=n.attrs["PATHWAY-ID"];this.log(`Loading level index ${t}${void 0!==(null==e?void 0:e.msn)?" at sn "+e.msn+" part "+e.part:""} with${r?" Pathway "+r:""} ${i}`),this.clearTimer(),this.hls.trigger(v.LEVEL_LOADING,{url:i,level:t,pathwayId:n.attrs["PATHWAY-ID"],id:0,deliveryDirectives:e||null})}}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;const n=this._levels.filter((t,n)=>n!==e||(this.steering&&this.steering.removeLevel(t),t===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,t.details&&t.details.fragments.forEach(e=>e.level=-1)),!1));Wt(n),this._levels=n,this.currentLevelIndex>-1&&null!=(t=this.currentLevel)&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(v.LEVELS_UPDATED,{levels:n})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:n}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(v.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:n}))}constructor(e,t){super(e,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}}function Cs(e){const t={};e.forEach(e=>{const n=e.groupId||"";e.id=t[n]=t[n]||0,t[n]++})}class ys{abort(e){for(const n in this.keyUriToKeyInfo){const i=this.keyUriToKeyInfo[n].loader;if(i){var t;if(e&&e!==(null==(t=i.context)?void 0:t.frag.type))return;i.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=T.KEY_LOAD_ERROR,n,i,r){return new xn({type:E.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:r,error:n,networkDetails:i})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled){const{sn:n,cc:i}=e;for(let e=0;e<t.length;e++){const r=t[e];if(i<=r.cc&&("initSegment"===n||"initSegment"===r.sn||n<r.sn)){this.emeController.selectKeySystemFormat(r).then(e=>{r.setKeyFormat(e)});break}}}}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var n,i;t&&e.setKeyFormat(t);const r=e.decryptdata;if(!r){const n=new Error(t?"Expected frag.decryptdata to be defined after setting format "+t:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,T.KEY_LOAD_ERROR,n))}const s=r.uri;if(!s)return Promise.reject(this.createKeyLoadError(e,T.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${s}"`)));let a=this.keyUriToKeyInfo[s];if(null!=(n=a)&&n.decryptdata.key)return r.key=a.decryptdata.key,Promise.resolve({frag:e,keyInfo:a});var o;if(null!=(i=a)&&i.keyLoadPromise)switch(null==(o=a.mediaKeySessionContext)?void 0:o.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then(t=>(r.key=t.keyInfo.decryptdata.key,{frag:e,keyInfo:a}))}switch(a=this.keyUriToKeyInfo[s]={decryptdata:r,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},r.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===r.keyFormat?this.loadKeyHTTP(a,e):this.loadKeyEME(a,e);case"AES-128":return this.loadKeyHTTP(a,e);default:return Promise.reject(this.createKeyLoadError(e,T.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${r.method}"`)))}}loadKeyEME(e,t){const n={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const t=this.emeController.loadKey(n);if(t)return(e.keyLoadPromise=t.then(t=>(e.mediaKeySessionContext=t,n))).catch(t=>{throw e.keyLoadPromise=null,t})}return Promise.resolve(n)}loadKeyHTTP(e,t){const n=this.config,i=new(0,n.loader)(n);return t.keyLoader=e.loader=i,e.keyLoadPromise=new Promise((r,s)=>{const a={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},o=n.keyLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},c={onSuccess:(e,t,n,i)=>{const{frag:a,keyInfo:o,url:l}=n;if(!a.decryptdata||o!==this.keyUriToKeyInfo[l])return s(this.createKeyLoadError(a,T.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),i));o.decryptdata.key=a.decryptdata.key=new Uint8Array(e.data),a.keyLoader=null,o.loader=null,r({frag:a,keyInfo:o})},onError:(e,n,i,r)=>{this.resetLoader(n),s(this.createKeyLoadError(t,T.KEY_LOAD_ERROR,new Error(`HTTP Error ${e.code} loading key ${e.text}`),i,u({url:a.url,data:void 0},e)))},onTimeout:(e,n,i)=>{this.resetLoader(n),s(this.createKeyLoadError(t,T.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),i))},onAbort:(e,n,i)=>{this.resetLoader(n),s(this.createKeyLoadError(t,T.INTERNAL_ABORTED,new Error("key loading aborted"),i))}};i.load(a,l,c)})}resetLoader(e){const{frag:t,keyInfo:n,url:i}=e,r=n.loader;t.keyLoader===r&&(t.keyLoader=null,n.loader=null),delete this.keyUriToKeyInfo[i],r&&r.destroy()}constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}}function Ms(){return self.SourceBuffer||self.WebKitSourceBuffer}function Os(){if(!Xe())return!1;const e=Ms();return!e||e.prototype&&"function"==typeof e.prototype.appendBuffer&&"function"==typeof e.prototype.remove}function xs(){if(!Os())return!1;const e=Xe();return"function"==typeof(null==e?void 0:e.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(t=>e.isTypeSupported(Ye(t,"video")))||["mp4a.40.2","fLaC"].some(t=>e.isTypeSupported(Ye(t,"audio"))))}class Ds{destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(e,t){const{config:n,media:i,stalled:r}=this;if(null===i)return;const{currentTime:s,seeking:a}=i,o=this.seeking&&!a,l=!this.seeking&&a;if(this.seeking=a,s!==e){if(this.moved=!0,a||(this.nudgeRetry=0),null!==r){if(this.stallReported){const e=self.performance.now()-r;I.warn(`playback not stuck anymore @${s}, after ${Math.round(e)}ms`),this.stallReported=!1}this.stalled=null}return}if(l||o)return void(this.stalled=null);if(i.paused&&!a||i.ended||0===i.playbackRate||!Tn.getBuffered(i).length)return void(this.nudgeRetry=0);const c=Tn.bufferInfo(i,s,0),d=c.nextStart||0;if(a){const e=c.len>2,n=!d||t&&t.start<=s||d-s>2&&!this.fragmentTracker.getPartialFragment(s);if(e||n)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var h;if(!(c.len>0||d))return;const e=Math.max(d,c.start||0)-s,t=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,n=(null==t||null==(h=t.details)?void 0:h.live)?2*t.details.targetduration:2,r=this.fragmentTracker.getPartialFragment(s);if(e>0&&(e<=n||r))return void(i.paused||this._trySkipBufferHole(r))}const u=self.performance.now();if(null===r)return void(this.stalled=u);const f=u-r;if(!a&&f>=250&&(this._reportStall(c),!this.media))return;const m=Tn.bufferInfo(i,s,n.maxBufferHole);this._tryFixBufferStall(m,f)}_tryFixBufferStall(e,t){const{config:n,fragmentTracker:i,media:r}=this;if(null===r)return;const s=r.currentTime,a=i.getPartialFragment(s);(!a||!this._trySkipBufferHole(a)&&this.media)&&(e.len>n.maxBufferHole||e.nextStart&&e.nextStart-s<n.maxBufferHole)&&t>1e3*n.highBufferWatchdogPeriod&&(I.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(e){const{hls:t,media:n,stallReported:i}=this;if(!i&&n){this.stallReported=!0;const i=new Error(`Playback stalling at @${n.currentTime} due to low buffer (${JSON.stringify(e)})`);I.warn(i.message),t.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.BUFFER_STALLED_ERROR,fatal:!1,error:i,buffer:e.len})}}_trySkipBufferHole(e){const{config:t,hls:n,media:i}=this;if(null===i)return 0;const r=i.currentTime,s=Tn.bufferInfo(i,r,0),a=r<s.start?s.start:s.nextStart;if(a){const o=s.len<=t.maxBufferHole,l=s.len>0&&s.len<1&&i.readyState<3,c=a-r;if(c>0&&(o||l)){if(c>t.maxBufferHole){const{fragmentTracker:t}=this;let n=!1;if(0===r){const e=t.getAppendedFrag(0,mt.MAIN);e&&a<e.end&&(n=!0)}if(!n){const n=e||t.getAppendedFrag(r,mt.MAIN);if(n){let e=!1,i=n.end;for(;i<a;){const n=t.getPartialFragment(i);if(!n){e=!0;break}i+=n.duration}if(e)return 0}}}const s=Math.max(a+.05,r+.1);if(I.warn(`skipping hole, adjusting currentTime from ${r} to ${s}`),this.moved=!0,this.stalled=null,i.currentTime=s,e&&!e.gap){const t=new Error(`fragment loaded with buffer holes, seeking from ${r} to ${s}`);n.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:t,reason:t.message,frag:e})}return s}}return 0}_tryNudgeBuffer(){const{config:e,hls:t,media:n,nudgeRetry:i}=this;if(null===n)return;const r=n.currentTime;if(this.nudgeRetry++,i<e.nudgeMaxRetry){const s=r+(i+1)*e.nudgeOffset,a=new Error(`Nudging 'currentTime' from ${r} to ${s}`);I.warn(a.message),n.currentTime=s,t.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.BUFFER_NUDGE_ON_STALL,error:a,fatal:!1})}else{const n=new Error(`Playhead still not moving while enough data buffered @${r} after ${e.nudgeMaxRetry} nudges`);I.error(n.message),t.trigger(v.ERROR,{type:E.MEDIA_ERROR,details:T.BUFFER_STALLED_ERROR,error:n,fatal:!0})}}constructor(e,t,n,i){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=n,this.hls=i}}class Ps extends Fn{_registerListeners(){const{hls:e}=this;e.on(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(v.MANIFEST_LOADING,this.onManifestLoading,this),e.on(v.MANIFEST_PARSED,this.onManifestParsed,this),e.on(v.LEVEL_LOADING,this.onLevelLoading,this),e.on(v.LEVEL_LOADED,this.onLevelLoaded,this),e.on(v.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(v.ERROR,this.onError,this),e.on(v.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(v.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(v.BUFFER_CREATED,this.onBufferCreated,this),e.on(v.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(v.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(v.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(v.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(v.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(v.MANIFEST_LOADING,this.onManifestLoading,this),e.off(v.MANIFEST_PARSED,this.onManifestParsed,this),e.off(v.LEVEL_LOADED,this.onLevelLoaded,this),e.off(v.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(v.ERROR,this.onError,this),e.off(v.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(v.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(v.BUFFER_CREATED,this.onBufferCreated,this),e.off(v.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(v.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(v.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(e){if(this.levels){const{lastCurrentTime:t,hls:n}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let e=n.startLevel;-1===e&&(n.config.testBandwidth&&this.levels.length>1?(e=0,this.bitrateTest=!0):e=n.firstAutoLevel),n.nextLoadLevel=e,this.level=n.loadLevel,this.loadedmetadata=!1}t>0&&-1===e&&(this.log("Override startPosition with lastCurrentTime @"+t.toFixed(3)),e=t),this.state="IDLE",this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state="STOPPED"}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case"WAITING_LEVEL":{const{levels:e,level:t}=this,n=null==e?void 0:e[t],i=null==n?void 0:n.details;if(i&&(!i.live||this.levelLastLoaded===n)){if(this.waitForCdnTuneIn(i))break;this.state="IDLE";break}if(this.hls.nextLoadLevel!==this.level){this.state="IDLE";break}break}case"FRAG_LOADING_WAITING_RETRY":{var e;const t=self.performance.now(),n=this.retryDate;if(!n||t>=n||null!=(e=this.media)&&e.seeking){const{levels:e,level:t}=this,n=null==e?void 0:e[t];this.resetStartWhenNotLoaded(n||null),this.state="IDLE"}}}"IDLE"===this.state&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:n,media:i}=this;if(null===t||!i&&(this.startFragRequested||!e.config.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;const r=this.buffering?e.nextLoadLevel:e.loadLevel;if(null==n||!n[r])return;const s=n[r],a=this.getMainFwdBufferInfo();if(null===a)return;const o=this.getLevelDetails();if(o&&this._streamEnded(a,o)){const e={};return this.altAudio&&(e.type="video"),this.hls.trigger(v.BUFFER_EOS,e),void(this.state="ENDED")}if(!this.buffering)return;e.loadLevel!==r&&-1===e.manualLevel&&this.log(`Adapting to level ${r} from level ${this.level}`),this.level=e.nextLoadLevel=r;const l=s.details;if(!l||"WAITING_LEVEL"===this.state||l.live&&this.levelLastLoaded!==s)return this.level=r,void(this.state="WAITING_LEVEL");const c=a.len,d=this.getMaxBufferLength(s.maxBitrate);if(c>=d)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const h=this.backtrackFragment?this.backtrackFragment.start:a.end;let u=this.getNextFragment(h,l);if(this.couldBacktrack&&!this.fragPrevious&&u&&"initSegment"!==u.sn&&"OK"!==this.fragmentTracker.getState(u)){var f;const e=(null!=(f=this.backtrackFragment)?f:u).sn-l.startSN,t=l.fragments[e-1];t&&u.cc===t.cc&&(u=t,this.fragmentTracker.removeFragment(t))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(u&&this.isLoopLoading(u,h)){if(!u.gap){const e=this.audioOnly&&!this.altAudio?"audio":"video",t=("video"===e?this.videoBuffer:this.mediaBuffer)||this.media;t&&this.afterBufferFlushed(t,e,mt.MAIN)}u=this.getNextFragmentLoopLoading(u,l,a,mt.MAIN,d)}u&&(!u.initSegment||u.initSegment.data||this.bitrateTest||(u=u.initSegment),this.loadFragment(u,s,h))}loadFragment(e,t,n){const i=this.fragmentTracker.getState(e);this.fragCurrent=e,"NOT_LOADED"===i||"PARTIAL"===i?"initSegment"===e.sn?this._loadInitSegment(e,t):this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):(this.startFragRequested=!0,super.loadFragment(e,t,n)):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,mt.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(null!=t&&t.readyState){let n;const i=this.getAppendedFrag(t.currentTime);i&&i.start>1&&this.flushMainBuffer(0,i.start-1);const r=this.getLevelDetails();if(null!=r&&r.live){const e=this.getMainFwdBufferInfo();if(!e||e.len<2*r.targetduration)return}if(!t.paused&&e){const t=e[this.hls.nextLoadLevel],i=this.fragLastKbps;n=i&&this.fragCurrent?this.fragCurrent.duration*t.maxBitrate/(1e3*i)+1:0}else n=0;const s=this.getBufferedFrag(t.currentTime+n);if(s){const e=this.followingBufferedFrag(s);if(e){this.abortCurrentFrag();const t=e.maxStartPTS?e.maxStartPTS:e.start,n=e.duration,i=Math.max(s.end,t+Math.min(Math.max(n-this.config.maxFragLookUpTolerance,n*(this.couldBacktrack?.5:.125)),n*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(i,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case"KEY_LOADING":case"FRAG_LOADING":case"FRAG_LOADING_WAITING_RETRY":case"PARSING":case"PARSED":this.state="IDLE"}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const n=t.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),n.addEventListener("playing",this.onvplaying),n.addEventListener("seeked",this.onvseeked),this.gapController=new Ds(this.config,n,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:e}=this;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const e=this.media,t=e?e.currentTime:null;p(t)&&this.log("Media seeked to "+t.toFixed(3));const n=this.getMainFwdBufferInfo();null!==n&&0!==n.len?this.tick():this.warn(`Main forward buffer length on "seeked" event ${n?n.len:"empty"})`)}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(v.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(e,t){let n=!1,i=!1;t.levels.forEach(e=>{const t=e.audioCodec;t&&(n=n||-1!==t.indexOf("mp4a.40.2"),i=i||-1!==t.indexOf("mp4a.40.5"))}),this.audioCodecSwitch=n&&i&&!function(){var e;const t=Ms();return"function"==typeof(null==t||null==(e=t.prototype)?void 0:e.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:n}=this;if(!n||"IDLE"!==this.state)return;const i=n[t.level];(!i.details||i.details.live&&this.levelLastLoaded!==i||this.waitForCdnTuneIn(i.details))&&(this.state="WAITING_LEVEL")}onLevelLoaded(e,t){var n;const{levels:i}=this,r=t.level,s=t.details,a=s.totalduration;if(!i)return void this.warn("Levels were reset while loading level "+r);this.log(`Level ${r} loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""}, cc [${s.startCC}, ${s.endCC}] duration:${a}`);const o=i[r],l=this.fragCurrent;!l||"FRAG_LOADING"!==this.state&&"FRAG_LOADING_WAITING_RETRY"!==this.state||l.level!==t.level&&l.loader&&this.abortCurrentFrag();let c=0;if(s.live||null!=(n=o.details)&&n.live){var d;if(this.checkLiveUpdate(s),s.deltaUpdateFailed)return;c=this.alignPlaylists(s,o.details,null==(d=this.levelLastLoaded)?void 0:d.details)}if(o.details=s,this.levelLastLoaded=o,this.hls.trigger(v.LEVEL_UPDATED,{details:s,level:r}),"WAITING_LEVEL"===this.state){if(this.waitForCdnTuneIn(s))return;this.state="IDLE"}this.startFragRequested?s.live&&this.synchronizeToLiveEdge(s):this.setStartPosition(s,c),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:n,part:i,payload:r}=e,{levels:s}=this;if(!s)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${n.sn} of level ${n.level} will not be buffered`);const a=s[n.level],o=a.details;if(!o)return this.warn(`Dropping fragment ${n.sn} of level ${n.level} after level details were reset`),void this.fragmentTracker.removeFragment(n);const l=a.videoCodec,c=o.PTSKnown||!o.live,d=null==(t=n.initSegment)?void 0:t.data,h=this._getAudioCodec(a),u=this.transmuxer=this.transmuxer||new ki(this.hls,mt.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=i?i.index:-1,m=-1!==f,p=new Sn(n.level,n.sn,n.stats.chunkCount,r.byteLength,f,m),g=this.initPTS[n.cc];u.push(r,d,h,l,n,i,o.totalduration,c,p,g)}onAudioTrackSwitching(e,t){const n=this.altAudio;if(!t.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const e=this.fragCurrent;e&&(this.log("Switching to main audio track, cancel main fragment load"),e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const e=this.hls;n&&(e.trigger(v.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),e.trigger(v.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const n=t.id,i=!!this.hls.audioTracks[n].url;if(i){const e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=e)}this.altAudio=i,this.tick()}onBufferCreated(e,t){const n=t.tracks;let i,r,s=!1;for(const e in n){const t=n[e];if("main"===t.id){if(r=e,i=t,"video"===e){const t=n[e];t&&(this.videoBuffer=t.buffer)}}else s=!0}s&&i?(this.log(`Alternate track found, use ${r}.buffered to schedule main fragment loading`),this.mediaBuffer=i.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:n,part:i}=t;if(n&&n.type!==mt.MAIN)return;if(this.fragContextChanged(n))return this.warn(`Fragment ${n.sn}${i?" p: "+i.index:""} of level ${n.level} finished buffering, but was aborted. state: ${this.state}`),void("PARSED"===this.state&&(this.state="IDLE"));const r=i?i.stats:n.stats;this.fragLastKbps=Math.round(8*r.total/(r.buffering.end-r.loading.first)),"initSegment"!==n.sn&&(this.fragPrevious=n),this.fragBufferedComplete(n,i)}onError(e,t){var n;if(t.fatal)this.state="ERROR";else switch(t.details){case T.FRAG_GAP:case T.FRAG_PARSING_ERROR:case T.FRAG_DECRYPT_ERROR:case T.FRAG_LOAD_ERROR:case T.FRAG_LOAD_TIMEOUT:case T.KEY_LOAD_ERROR:case T.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(mt.MAIN,t);break;case T.LEVEL_LOAD_ERROR:case T.LEVEL_LOAD_TIMEOUT:case T.LEVEL_PARSING_ERROR:t.levelRetry||"WAITING_LEVEL"!==this.state||"level"!==(null==(n=t.context)?void 0:n.type)||(this.state="IDLE");break;case T.BUFFER_APPEND_ERROR:case T.BUFFER_FULL_ERROR:if(!t.parent||"main"!==t.parent)return;if(t.details===T.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case T.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}checkBuffer(){const{media:e,gapController:t}=this;if(e&&t&&e.readyState){if(this.loadedmetadata||!Tn.getBuffered(e).length){const e="IDLE"!==this.state?this.fragCurrent:null;t.poll(this.lastCurrentTime,e)}this.lastCurrentTime=e.currentTime}}onFragLoadEmergencyAborted(){this.state="IDLE",this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(e,{type:t}){if("audio"!==t||this.audioOnly&&!this.altAudio){const e=("video"===t?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(e,t,mt.MAIN),this.tick()}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let n=this.startPosition;if(n>=0&&t<n){if(e.seeking)return void this.log(`could not seek to ${n}, already seeking at ${t}`);const i=Tn.getBuffered(e),r=(i.length?i.start(0):0)-n;r>0&&(r<this.config.maxBufferHole||r<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${r} to match buffer start`),n+=r,this.startPosition=n),this.log(`seek to target start position ${n} from current time ${t}`),e.currentTime=n}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(n=>{const{hls:i}=this;if(!n||this.fragContextChanged(e))return;t.fragmentError=0,this.state="IDLE",this.startFragRequested=!1,this.bitrateTest=!1;const r=e.stats;r.parsing.start=r.parsing.end=r.buffering.start=r.buffering.end=self.performance.now(),i.trigger(v.FRAG_LOADED,n),e.bitrateTest=!1})}_handleTransmuxComplete(e){var t;const n="main",{hls:i}=this,{remuxResult:r,chunkMeta:s}=e,a=this.getCurrentContext(s);if(!a)return void this.resetWhenMissingContext(s);const{frag:o,part:l,level:c}=a,{video:d,text:h,id3:u,initSegment:f}=r,{details:m}=c,g=this.altAudio?void 0:r.audio;if(this.fragContextChanged(o))this.fragmentTracker.removeFragment(o);else{if(this.state="PARSING",f){if(null!=f&&f.tracks){const e=o.initSegment||o;this._bufferInitSegment(c,f.tracks,e,s),i.trigger(v.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:n,tracks:f.tracks})}const e=f.initPTS,t=f.timescale;p(e)&&(this.initPTS[o.cc]={baseTime:e,timescale:t},i.trigger(v.INIT_PTS_FOUND,{frag:o,id:n,initPTS:e,timescale:t}))}if(d&&m&&"initSegment"!==o.sn){const e=m.fragments[o.sn-1-m.startSN],t=o.sn===m.startSN,n=!e||o.cc>e.cc;if(!1!==r.independent){const{startPTS:e,endPTS:i,startDTS:r,endDTS:a}=d;if(l)l.elementaryStreams[d.type]={startPTS:e,endPTS:i,startDTS:r,endDTS:a};else if(d.firstKeyFrame&&d.independent&&1===s.id&&!n&&(this.couldBacktrack=!0),d.dropped&&d.independent){const r=this.getMainFwdBufferInfo(),s=(r?r.end:this.getLoadPosition())+this.config.maxBufferHole,l=d.firstKeyFramePTS?d.firstKeyFramePTS:e;if(!t&&s<l-this.config.maxBufferHole&&!n)return void this.backtrack(o);n&&(o.gap=!0),o.setElementaryStreamInfo(d.type,o.start,i,o.start,a,!0)}else t&&e>2&&(o.gap=!0);o.setElementaryStreamInfo(d.type,e,i,r,a),this.backtrackFragment&&(this.backtrackFragment=o),this.bufferFragmentData(d,o,l,s,t||n)}else{if(!t&&!n)return void this.backtrack(o);o.gap=!0}}if(g){const{startPTS:e,endPTS:t,startDTS:n,endDTS:i}=g;l&&(l.elementaryStreams.audio={startPTS:e,endPTS:t,startDTS:n,endDTS:i}),o.setElementaryStreamInfo("audio",e,t,n,i),this.bufferFragmentData(g,o,l,s)}if(m&&null!=u&&null!=(t=u.samples)&&t.length){const e={id:n,frag:o,details:m,samples:u.samples};i.trigger(v.FRAG_PARSING_METADATA,e)}if(m&&h){const e={id:n,frag:o,details:m,samples:h.samples};i.trigger(v.FRAG_PARSING_USERDATA,e)}}}_bufferInitSegment(e,t,n,i){if("PARSING"!==this.state)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;const{audio:r,video:s,audiovideo:a}=t;if(r){let t=e.audioCodec;const n=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){t&&(t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5");const e=r.metadata;e&&"channelCount"in e&&1!==(e.channelCount||1)&&-1===n.indexOf("firefox")&&(t="mp4a.40.5")}t&&-1!==t.indexOf("mp4a.40.5")&&-1!==n.indexOf("android")&&"audio/mpeg"!==r.container&&(t="mp4a.40.2",this.log("Android: force audio codec to "+t)),e.audioCodec&&e.audioCodec!==t&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${t}"`),r.levelCodec=t,r.id="main",this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${t||""}/${e.audioCodec||""}/${r.codec}]`)}s&&(s.levelCodec=e.videoCodec,s.id="main",this.log(`Init video buffer, container:${s.container}, codecs[level/parsed]=[${e.videoCodec||""}/${s.codec}]`)),a&&this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),this.hls.trigger(v.BUFFER_CODECS,t),Object.keys(t).forEach(e=>{const r=t[e].initSegment;null!=r&&r.byteLength&&this.hls.trigger(v.BUFFER_APPENDING,{type:e,data:r,frag:n,part:null,chunkMeta:i,parent:n.type})}),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,mt.MAIN)}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state="IDLE"}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&!1===e.seeking){const n=e.currentTime;if(Tn.isBuffered(e,n)?t=this.getAppendedFrag(n):Tn.isBuffered(e,n+.1)&&(t=this.getAppendedFrag(n+.1)),t){this.backtrackFragment=null;const e=this.fragPlaying,n=t.level;e&&t.sn===e.sn&&e.level===n||(this.fragPlaying=t,this.hls.trigger(v.FRAG_CHANGED,{frag:t}),e&&e.level===n||this.hls.trigger(v.LEVEL_SWITCHED,{level:n}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){const e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}get currentProgramDateTime(){const e=this.media;if(e){const t=e.currentTime,n=this.currentFrag;if(n&&p(t)&&p(n.programDateTime)){const e=n.programDateTime+1e3*(t-n.start);return new Date(e)}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}constructor(e,t,n){super(e,t,n,"[stream-controller]",mt.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}}class Ls{static get version(){return"1.5.20"}static isMSESupported(){return Os()}static isSupported(){return xs()}static getMediaSource(){return Xe()}static get Events(){return v}static get ErrorTypes(){return E}static get ErrorDetails(){return T}static get DefaultConfig(){return Ls.defaultConfig?Ls.defaultConfig:As}static set DefaultConfig(e){Ls.defaultConfig=e}createController(e,t){if(e){const n=new e(this);return t&&t.push(n),n}return null}on(e,t,n=this){this._emitter.on(e,t,n)}once(e,t,n=this){this._emitter.once(e,t,n)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,n=this,i){this._emitter.off(e,t,n,i)}listeners(e){return this._emitter.listeners(e)}emit(e,t,n){return this._emitter.emit(e,t,n)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(t){if(I.error("An internal error happened while handling event "+e+'. Error message: "'+t.message+'". Here is a stacktrace:',t),!this.triggeringException){this.triggeringException=!0;const n=e===v.ERROR;this.trigger(v.ERROR,{type:E.OTHER_ERROR,details:T.INTERNAL_EXCEPTION,fatal:n,event:e,error:t}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){I.log("destroy"),this.trigger(v.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(e=>e.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(e=>e.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){I.log("attachMedia"),this._media=e,this.trigger(v.MEDIA_ATTACHING,{media:e})}detachMedia(){I.log("detachMedia"),this.trigger(v.MEDIA_DETACHING,void 0),this._media=null}loadSource(e){this.stopLoad();const t=this.media,n=this.url,i=this.url=d.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,I.log("loadSource:"+i),t&&n&&(n!==i||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(v.MANIFEST_LOADING,{url:e})}startLoad(e=-1){I.log(`startLoad(${e})`),this.started=!0,this.resumeBuffering();for(let t=0;t<this.networkControllers.length&&(this.networkControllers[t].startLoad(e),this.started&&this.networkControllers);t++);}stopLoad(){I.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!this.started&&this.networkControllers);e++);}resumeBuffering(){I.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()})}pauseBuffering(){I.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()})}swapAudioCodec(){I.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){I.log("recoverMediaError");const e=this._media;this.detachMedia(),e&&this.attachMedia(e)}removeLevel(e){this.levelController.removeLevel(e)}get levels(){return this.levelController.levels||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){I.log("set currentLevel:"+e),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){I.log("set nextLevel:"+e),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){I.log("set loadLevel:"+e),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){I.log("set firstLevel:"+e),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return-1===e&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){I.log("set startLevel:"+e),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(I.log("set autoLevelCapping:"+e),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){(function(e){return xt.indexOf(e)>-1})(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const n=e.length;for(let i=0;i<n;i++)if(e[i].maxBitrate>=t)return i;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:n}=this;let i;if(i=-1===t&&null!=e&&e.length?e.length-1:t,n)for(let t=i;t--;){const i=e[t].attrs["HDCP-LEVEL"];if(i&&i<=n)return t}return i}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(e){var t;return null==(t=this.audioTrackController)?void 0:t.setAudioOption(e)}setSubtitleOption(e){var t;return null==(t=this.subtitleTrackController)||t.setSubtitleOption(e),null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new Bi,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,function(e,t){if("object"==typeof console&&!0===e||"object"==typeof e){!function(e,...t){t.forEach((function(t){b[t]=e[t]?e[t].bind(e):function(e){const t=self.console[e];return t?t.bind(self.console,`[${e}] >`):S}(t)}))}(e,"debug","log","info","warn","error");try{b.log('Debug logs enabled for "Hls instance" in hls.js version 1.5.20')}catch(e){b=A}}else b=A}(e.debug||!1);const t=this.config=function(e,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const n=bs(e),i=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach(e=>{const r=("level"===e?"playlist":e)+"LoadPolicy",s=void 0===t[r],a=[];i.forEach(i=>{const o=`${e}Loading${i}`,l=t[o];if(void 0!==l&&s){a.push(o);const e=n[r].default;switch(t[r]={default:e},i){case"TimeOut":e.maxLoadTimeMs=l,e.maxTimeToFirstByteMs=l;break;case"MaxRetry":e.errorRetry.maxNumRetry=l,e.timeoutRetry.maxNumRetry=l;break;case"RetryDelay":e.errorRetry.retryDelayMs=l,e.timeoutRetry.retryDelayMs=l;break;case"MaxRetryTimeout":e.errorRetry.maxRetryDelayMs=l,e.timeoutRetry.maxRetryDelayMs=l}}}),a.length&&I.warn(`hls.js config: "${a.join('", "')}" setting(s) are deprecated, use "${r}": ${JSON.stringify(t[r])}`)}),u(u({},n),t)}(Ls.DefaultConfig,e);this.userConfig=e,t.progressive&&function(e){const t=e.loader;t!==vs&&t!==gs?(I.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1):function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1}()&&(e.loader=vs,e.progressive=!0,e.enableSoftwareAES=!0,I.log("[config]: Progressive streaming enabled, using FetchLoader"))}(t);const{abrController:n,bufferController:i,capLevelController:r,errorController:s,fpsController:a}=t,o=new s(this),l=this.abrController=new n(this),c=this.bufferController=new i(this),d=this.capLevelController=new r(this),h=new a(this),f=new _t(this),m=new Mt(this),p=t.contentSteeringController,g=p?new p(this):null,_=this.levelController=new Rs(this,g),E=new gn(this),T=new ys(this.config),R=this.streamController=new Ps(this,E,T);d.setStreamController(R),h.setStreamController(R);const C=[f,_,R];g&&C.splice(1,0,g),this.networkControllers=C;const y=[l,c,d,h,m,E];this.audioTrackController=this.createController(t.audioTrackController,C);const M=t.audioStreamController;M&&C.push(new M(this,E,T)),this.subtitleTrackController=this.createController(t.subtitleTrackController,C);const O=t.subtitleStreamController;O&&C.push(new O(this,E,T)),this.createController(t.timelineController,y),T.emeController=this.emeController=this.createController(t.emeController,y),this.cmcdController=this.createController(t.cmcdController,y),this.latencyController=this.createController(Ot,y),this.coreComponents=y,C.push(o);const x=o.onErrorOut;"function"==typeof x&&this.on(v.ERROR,x,o)}}Ls.defaultConfig=void 0},function(e,t,n){"use strict";n.r(t),n.d(t,"lodCubePixelShader",(function(){return s}));const i="lodCubePixelShader",r="precision highp float;const float GammaEncodePowerApprox=1.0/2.2;varying vec2 vUV;uniform samplerCube textureSampler;uniform float lod;uniform int gamma;void main(void)\n{vec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x),lod);\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x),lod);\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x),lod);\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x),lod);\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001),lod);\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001),lod);\n#endif\nif (gamma==0) {gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(GammaEncodePowerApprox));}}\n";n(66).a.ShadersStore[i]=r;const s={name:i,shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"lodPixelShader",(function(){return r}));const i="#extension GL_EXT_shader_texture_lod : enable\nprecision highp float;const float GammaEncodePowerApprox=1.0/2.2;varying vec2 vUV;uniform sampler2D textureSampler;uniform float lod;uniform vec2 texSize;uniform int gamma;void main(void)\n{gl_FragColor=texture2DLodEXT(textureSampler,vUV,lod);if (gamma==0) {gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(GammaEncodePowerApprox));}}\n";n(66).a.ShadersStore.lodPixelShader=i;const r={name:"lodPixelShader",shader:i}},function(e,t,n){"use strict";n.r(t),n.d(t,"lodCubePixelShaderWGSL",(function(){return s}));const i="lodCubePixelShader",r="const GammaEncodePowerApprox=1.0/2.2;varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;uniform lod: f32;uniform gamma: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {let uv=fragmentInputs.vUV*2.0-1.0;\n#ifdef POSITIVEX\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x),uniforms.lod);\n#endif\n#ifdef NEGATIVEX\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x),uniforms.lod);\n#endif\n#ifdef POSITIVEY\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x),uniforms.lod);\n#endif\n#ifdef NEGATIVEY\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x),uniforms.lod);\n#endif\n#ifdef POSITIVEZ\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv,1.001),uniforms.lod);\n#endif\n#ifdef NEGATIVEZ\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv,-1.001),uniforms.lod);\n#endif\nif (uniforms.gamma==0) {fragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb,vec3f(GammaEncodePowerApprox)),fragmentOutputs.color.a);}}\n";n(66).a.ShadersStoreWGSL[i]=r;const s={name:i,shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"lodPixelShaderWGSL",(function(){return r}));const i="const GammaEncodePowerApprox=1.0/2.2;varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform lod: f32;uniform gamma: i32;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,fragmentInputs.vUV,uniforms.lod);if (uniforms.gamma==0) {fragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb,vec3f(GammaEncodePowerApprox)),fragmentOutputs.color.a);}}\n";n(66).a.ShadersStoreWGSL.lodPixelShader=i;const r={name:"lodPixelShader",shader:i}},function(e,t,n){"use strict";n.r(t),n.d(t,"passPixelShaderWGSL",(function(){return r}));const i="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);}";n(66).a.ShadersStoreWGSL.passPixelShader=i;const r={name:"passPixelShader",shader:i}},function(e,t,n){"use strict";n.r(t),n.d(t,"passCubePixelShaderWGSL",(function(){return s}));const i="passCubePixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f=input.vUV*2.0-1.0;\n#ifdef POSITIVEX\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,-1.001));\n#endif\n}";n(66).a.ShadersStoreWGSL[i]=r;const s={name:i,shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"passCubePixelShader",(function(){return s}));const i="passCubePixelShader",r="varying vec2 vUV;uniform samplerCube textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));\n#endif\n}";n(66).a.ShadersStore[i]=r;const s={name:i,shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"depthBoxBlurPixelShaderWGSL",(function(){return s}));const i="depthBoxBlurPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var colorDepth: vec4f=vec4f(0.0);for (var x: i32=-OFFSET; x<=OFFSET; x++) {for (var y: i32=-OFFSET; y<=OFFSET; y++) {colorDepth+=textureSample(textureSampler,textureSamplerSampler,input.vUV+ vec2f(f32(x),f32(y))/uniforms.screenSize);}}\nfragmentOutputs.color=(colorDepth/ f32((OFFSET*2+1)*(OFFSET*2+1)));}";n(66).a.ShadersStoreWGSL[i]=r;const s={name:i,shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"shadowMapFragmentSoftTransparentShadowWGSL",(function(){return s}));const i="shadowMapFragmentSoftTransparentShadow",r="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alpha) {discard;}\n#endif\n";n(66).a.IncludesShadersStoreWGSL[i]=r;const s={name:i,shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"depthBoxBlurPixelShader",(function(){return s}));const i="depthBoxBlurPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 colorDepth=vec4(0.0);for (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));}";n(66).a.ShadersStore[i]=r;const s={name:i,shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"shadowMapFragmentSoftTransparentShadow",(function(){return s}));const i="shadowMapFragmentSoftTransparentShadow",r="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alpha) discard;\n#endif\n";n(66).a.IncludesShadersStore[i]=r;const s={name:i,shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"TargetedAnimation",(function(){return o})),n.d(t,"AnimationGroup",(function(){return l}));var i=n(321),r=n(43),s=n(62),a=n(325);n(486);class o{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class l{get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this.syncWithMask(!0))}syncWithMask(e=!1){if(this.mask||e){this._numActiveAnimatables=0;for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];!this.mask||this.mask.disabled||this.mask.retainsTarget(t.target.name)?(this._numActiveAnimatables++,t.paused&&t.restart()):t.paused||t.pause()}}else this._numActiveAnimatables=this._targetedAnimations.length}removeUnmaskedAnimations(){if(this.mask&&!this.mask.disabled){for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){const t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}set from(e){if(this._from!==e){this._from=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].fromFrame=this._from}}get to(){return this._to}set to(e){if(this._to!==e){this._to=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].toFrame=this._to}}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].speedRatio=this._speedRatio}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].loopAnimation=this._loopAnimation}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].isAdditive=this._isAdditive}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let e=0;e<this._animatables.length;e++)this._animatables[e].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){var n,i;return e=null!==(n=e)&&void 0!==n?n:this._from,((t=null!==(i=t)&&void 0!==i?i:this._to)-e)/(this.targetedAnimations[0].animation.framePerSecond*this._speedRatio)}static MergeAnimationGroups(e,t=!0,n=!1,i){var r;if(0===e.length)return null;i=null!==(r=i)&&void 0!==r?r:e[0].weight;let s=Number.MAX_VALUE,a=-Number.MAX_VALUE;if(n)for(const t of e)t.from<s&&(s=t.from),t.to>a&&(a=t.to);const o=new l(e[0].name+"_merged",e[0]._scene,i);for(const i of e){n&&i.normalize(s,a);for(const e of i.targetedAnimations)o.addTargetedAnimation(e.animation,e.target);t&&i.dispose()}return o}addTargetedAnimation(e,t){const n=new o;n.animation=e,n.target=t;const i=e.getKeys();return this._from>i[0].frame&&(this._from=i[0].frame),this._to<i[i.length-1].frame&&(this._to=i[i.length-1].frame),null!==this._enableBlending&&(e.enableBlending=this._enableBlending),null!==this._blendingSpeed&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(n),this._shouldStart=!0,n}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){null==e&&(e=this._from),null==t&&(t=this._to);for(let n=0;n<this._targetedAnimations.length;n++){const i=this._targetedAnimations[n].animation.getKeys(),r=i[0],s=i[i.length-1];if(r.frame>e){const t={frame:e,value:r.value,inTangent:r.inTangent,outTangent:r.outTangent,interpolation:r.interpolation};i.splice(0,0,t)}if(s.frame<t){const e={frame:t,value:s.value,inTangent:s.inTangent,outTangent:s.outTangent,interpolation:s.interpolation};i.push(e)}}return this._from=e,this._to=t,this}_processLoop(e,t,n){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),this._animationLoopFlags[n]||(this._animationLoopFlags[n]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,n,i,r){if(this._isStarted||0===this._targetedAnimations.length)return this;this._loopAnimation=e,this._shouldStart=!1,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let s=0;s<this._targetedAnimations.length;s++){const a=this._targetedAnimations[s],o=this._scene.beginDirectAnimation(a.target,[a.animation],void 0!==n?n:this._from,void 0!==i?i:this._to,e,t,void 0,void 0,void 0!==r?r:this._isAdditive);o.weight=this._weight,o.playOrder=this._playOrder,o.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(a),this._checkAnimationGroupEnded(o)},this._processLoop(o,a,s),this._animatables.push(o)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length&&!this._shouldStart?(void 0!==e&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(!0),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.syncWithMask(),this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(e=!1){if(!this._isStarted)return this;const t=this._animatables.slice();for(let n=0;n<t.length;n++)t[n].stop(void 0,void 0,!0,e);let n=0;for(let t=0;t<this._scene._activeAnimatables.length;t++){const i=this._scene._activeAnimatables[t];i._runtimeAnimations.length>0?this._scene._activeAnimatables[n++]=i:e&&this._checkAnimationGroupEnded(i,e)}return this._scene._activeAnimatables.length=n,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].weight=e;return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e,t=!1){if(!this._isStarted)return this;for(let n=0;n<this._animatables.length;n++)this._animatables[n].goToFrame(e,t);return this}getCurrentFrame(){var e;return(null===(e=this.animatables[0])||void 0===e?void 0:e.masterFrame)||0}dispose(){this.isStarted&&this.stop(),this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const e=this._parentContainer.animationGroups.indexOf(this);e>-1&&this._parentContainer.animationGroups.splice(e,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e,t=!1){const n=this._animatables.indexOf(e);n>-1&&this._animatables.splice(n,1),this._animatables.length===this._targetedAnimations.length-this._numActiveAnimatables&&(this._isStarted=!1,t||this.onAnimationGroupEndObservable.notifyObservers(this),this._animatables.length=0)}clone(e,t,n=!1){const i=new l(e||this.name,this._scene,this._weight,this._playOrder);i._from=this.from,i._to=this.to,i._speedRatio=this.speedRatio,i._loopAnimation=this.loopAnimation,i._isAdditive=this.isAdditive,i._enableBlending=this.enableBlending,i._blendingSpeed=this.blendingSpeed,i.metadata=this.metadata,i.mask=this.mask;for(const e of this._targetedAnimations)i.addTargetedAnimation(n?e.animation.clone():e.animation,t?t(e.target):e.target);return i}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const n=this.targetedAnimations[t];e.targetedAnimations[t]=n.serialize()}return a.a&&a.a.HasTags(this)&&(e.tags=a.a.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const n=new l(e.name,t,e.weight,e.playOrder);for(let r=0;r<e.targetedAnimations.length;r++){const s=e.targetedAnimations[r],a=i.a.Parse(s.animation),o=s.targetId;if("influence"===s.animation.property){const e=t.getMorphTargetById(o);e&&n.addTargetedAnimation(a,e)}else{const e=t.getNodeById(o);null!=e&&n.addTargetedAnimation(a,e)}}return a.a&&a.a.AddTagsTo(n,e.tags),null!==e.from&&null!==e.to&&n.normalize(e.from,e.to),void 0!==e.speedRatio&&(n._speedRatio=e.speedRatio),void 0!==e.loopAnimation&&(n._loopAnimation=e.loopAnimation),void 0!==e.isAdditive&&(n._isAdditive=e.isAdditive),void 0!==e.weight&&(n._weight=e.weight),void 0!==e.playOrder&&(n._playOrder=e.playOrder),void 0!==e.enableBlending&&(n._enableBlending=e.enableBlending),void 0!==e.blendingSpeed&&(n._blendingSpeed=e.blendingSpeed),void 0!==e.metadata&&(n.metadata=e.metadata),n}static MakeAnimationAdditive(e,t,n,r=!1,s){let a;a="object"==typeof t?t:{referenceFrame:t,range:n,cloneOriginalAnimationGroup:r,clonedAnimationName:s};let o=e;a.cloneOriginalAnimationGroup&&(o=e.clone(a.clonedAnimationGroupName||o.name));const l=o.targetedAnimations;for(let e=0;e<l.length;e++){const t=l[e];t.animation=i.a.MakeAnimationAdditive(t.animation,a)}if(o.isAdditive=!0,a.clipKeys){let e=Number.MAX_VALUE,t=-Number.MAX_VALUE;const n=o.targetedAnimations;for(let i=0;i<n.length;i++){const r=n[i].animation.getKeys();e>r[0].frame&&(e=r[0].frame),t<r[r.length-1].frame&&(t=r[r.length-1].frame)}o._from=e,o._to=t}return o}static ClipKeys(e,t,n,i,r){const s=e.clone(i||e.name);return l.ClipKeysInPlace(s,t,n,r)}static ClipKeysInPlace(e,t,n,i){return l.ClipInPlace(e,t,n,i,!1)}static ClipFrames(e,t,n,i,r){const s=e.clone(i||e.name);return l.ClipFramesInPlace(s,t,n,r)}static ClipFramesInPlace(e,t,n,i){return l.ClipInPlace(e,t,n,i,!0)}static ClipInPlace(e,t,n,i,r=!1){let s=Number.MAX_VALUE,a=-Number.MAX_VALUE;const o=e.targetedAnimations;for(let e=0;e<o.length;e++){const l=o[e],c=i?l.animation:l.animation.clone();r&&(c.createKeyForFrame(t),c.createKeyForFrame(n));const d=c.getKeys(),h=[];let u=Number.MAX_VALUE;for(let e=0;e<d.length;e++){const i=d[e];if(!r&&e>=t&&e<=n||r&&i.frame>=t&&i.frame<=n){const e={frame:i.frame,value:i.value.clone?i.value.clone():i.value,inTangent:i.inTangent,outTangent:i.outTangent,interpolation:i.interpolation,lockedTangent:i.lockedTangent};u===Number.MAX_VALUE&&(u=e.frame),e.frame-=u,h.push(e)}}0!==h.length?(s>h[0].frame&&(s=h[0].frame),a<h[h.length-1].frame&&(a=h[h.length-1].frame),c.setKeys(h,!0),l.animation=c):(o.splice(e,1),e--)}return e._from=s,e._to=a,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}constructor(e,t=null,n=-1,i=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._shouldStart=!0,this._parentContainer=null,this.onAnimationEndObservable=new r.a,this.onAnimationLoopObservable=new r.a,this.onAnimationGroupLoopObservable=new r.a,this.onAnimationGroupEndObservable=new r.a,this.onAnimationGroupPauseObservable=new r.a,this.onAnimationGroupPlayObservable=new r.a,this.metadata=null,this._mask=null,this._animationLoopFlags=[],this._scene=t||s.a.LastCreatedScene,this._weight=n,this._playOrder=i,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}}},function(e,t,n){"use strict";n.r(t),n.d(t,"pbrVertexShaderWGSL",(function(){return s}));var i=n(66);n(481),n(412),n(368),n(322),n(357),n(358),n(385),n(413),n(414),n(482),n(415),n(361),n(416),n(417),n(359),n(360),n(369),n(362),n(363),n(364),n(365),n(366),n(418),n(419),n(420),n(421),n(367),n(422),n(423),n(424),n(425);const r="#include<pbrUboDeclaration>\n#define CUSTOM_VERTEX_BEGIN\nattribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#ifdef TANGENT\nattribute tangent: vec4f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute color: vec4f;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)\n#endif\nvarying vPositionW: vec3f;\n#if DEBUGMODE>0\nvarying vClipSpacePosition: vec4f;\n#endif\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vEnvironmentIrradiance: vec3f;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<lightVxUboDeclaration>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar positionUpdated: vec3f=vertexInputs.position;\n#ifdef NORMAL\nvar normalUpdated: vec3f=vertexInputs.normal;\n#endif\n#ifdef TANGENT\nvar tangentUpdated: vec4f=vertexInputs.tangent;\n#endif\n#ifdef UV1\nvar uvUpdated: vec2f=vertexInputs.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=vertexInputs.uv2;\n#endif\n#ifdef VERTEXCOLOR\nvar colorUpdated: vec4f=vertexInputs.color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvertexOutputs.vPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPositionW= worldPos.xyz;\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#ifdef NORMAL\nvar normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvar reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(vertexOutputs.vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvertexOutputs.vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}\n#else\nvertexOutputs.position=scene.viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvertexOutputs.vClipSpacePosition=vertexOutputs.position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvertexOutputs.vDirectionW=normalize((finalWorld*vec4f(positionUpdated,0.0)).xyz);\n#endif\n#ifndef UV1\nvar uvUpdated: vec2f= vec2f(0.,0.);\n#endif\n#ifdef MAINUV1\nvertexOutputs.vMainUV1=uvUpdated;\n#endif\n#ifndef UV2\nvar uv2Updated: vec2f= vec2f(0.,0.);\n#endif\n#ifdef MAINUV2\nvertexOutputs.vMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";i.a.ShadersStoreWGSL.pbrVertexShader=r;const s={name:"pbrVertexShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"depthVertexShaderWGSL",(function(){return a}));var i=n(66);n(357),n(358),n(359),n(360),n(361),n(385),n(362),n(363),n(364),n(365),n(366),n(367);const r="depthVertexShader",s="attribute position: vec3f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;uniform depthValues: vec2f;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vUV: vec2f;uniform diffuseMatrix: mat4x4f;\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform view: mat4x4f;varying vViewPos: vec4f;\n#endif\nvarying vDepthMetric: f32;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=input.uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);\n#include<clipPlaneVertex>\nvertexOutputs.position=uniforms.viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvertexOutputs.vViewPos=uniforms.view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric=((-vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));\n#else\nvertexOutputs.vDepthMetric=((vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef UV2\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n}\n";i.a.ShadersStoreWGSL[r]=s;const a={name:r,shader:s}},function(e,t,n){"use strict";n.r(t),n.d(t,"depthPixelShaderWGSL",(function(){return a}));var i=n(66);n(355),n(380),n(356);const r="depthPixelShader",s="#ifdef ALPHATEST\nvarying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying vDepthMetric: f32;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vViewPos: vec4f;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\nfragmentOutputs.color=pack(input.vViewPos.z);\n#else\nfragmentOutputs.color= vec4f(input.vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\nfragmentOutputs.color=pack(input.position.z);\n#else\nfragmentOutputs.color= vec4f(input.position.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\nfragmentOutputs.color=pack(input.vDepthMetric);\n#else\nfragmentOutputs.color= vec4f(input.vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";i.a.ShadersStoreWGSL[r]=s;const a={name:r,shader:s}},function(e,t,n){"use strict";n.r(t),n.d(t,"Model3DInstance",(function(){return El}));var i=n(327),r=n(84),s=n(174),a=n(9),o=n(3),l=n(7),c=n(105),d=n(0),h=n(12),u=n(28),f=n(2),m=n(372),p=n(44),g=n(312),_=n(43),v=n(318),E=n(62),T=n(36);class S{static get ForceFullSceneLoadingForIncremental(){return S._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){S._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return S._ShowLoadingScreen}static set ShowLoadingScreen(e){S._ShowLoadingScreen=e}static get loggingLevel(){return S._LoggingLevel}static set loggingLevel(e){S._LoggingLevel=e}static get CleanBoneMatrixWeights(){return S._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){S._CleanBoneMatrixWeights=e}}S._ForceFullSceneLoadingForIncremental=!1,S._ShowLoadingScreen=!0,S._CleanBoneMatrixWeights=!1,S._LoggingLevel=0;var A,b=n(324),I=n(335),R=n(317),C=n(100),y=n(329);!function(e){e[e.Clean=0]="Clean",e[e.Stop=1]="Stop",e[e.Sync=2]="Sync",e[e.NoSync=3]="NoSync"}(A||(A={}));const M=new _.a,O={};let x=!1;function D(){return O[".babylon"]}function P(e,t){return O[e]||(T.a.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),t?D():void 0)}function L(e,t,n){let i="Unable to load from "+(e.rawData?"binary data":e.url);return t?i+=": "+t:n&&(i+=": "+n),i}async function N(e,t,n,i,r,s,a,o,l){var c;const d="data:"===(h=e.url).substring(0,5)?h.substring(5):null;var h;if(e.rawData&&!a)throw"When using ArrayBufferView to load data the file extension must be provided.";const u=d||a?"":function(e){const t=e.indexOf("?");-1!==t&&(e=e.substring(0,t));const n=e.lastIndexOf(".");return e.substring(n,e.length).toLowerCase()}(e.url);let f=a?P(a,!0):d?function(e){for(const t in O){const n=O[t].plugin;if(n.canDirectLoad&&n.canDirectLoad(e))return O[t]}return D()}(e.url):P(u,!1);if(!f&&u){if(e.url&&!e.url.startsWith("blob:")){const t=await function(e,t){const n=t.method||"GET";return new Promise((i,r)=>{const s=new y.a;s.addEventListener("readystatechange",()=>{if(4==s.readyState)if(200==s.status){const e={};if(t.responseHeaders)for(const n of t.responseHeaders)e[n]=s.getResponseHeader(n)||"";i({response:s.response,headerValues:e})}else r(`Unable to fetch data from ${e}. Error code: ${s.status}`)}),s.open(n,e),s.send()})}(e.url,{method:"HEAD",responseHeaders:["Content-Type"]}),n=t.headerValues?t.headerValues["Content-Type"]:"";n&&(f=function(e){for(const t in O){const n=O[t];if(n.mimeType===e)return n}}(n))}f||(f=D())}if(!f)throw new Error("No plugin or fallback for "+(null!=a?a:e.url));if(!1===(null==l||null===(c=l[f.plugin.name])||void 0===c?void 0:c.enabled))throw new Error(`The '${f.plugin.name}' plugin is disabled via the loader options passed to the loading operation.`);if(e.rawData&&!f.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";return(e=>{if(f.plugin.createPlugin){const t=f.plugin.createPlugin(null!=l?l:{});return t instanceof Promise?(t.then(e).catch(e=>{r("Error instantiating plugin.",e)}),null):(e(t),t)}return e(f.plugin),f.plugin})(l=>{var c;if(!l)throw`The loader plugin corresponding to the '${a}' file type has not been found. If using es6, please import the plugin you wish to use before.`;if(M.notifyObservers(l),d&&(l.canDirectLoad&&l.canDirectLoad(e.url)||!Object(b.c)(e.url))){if(l.directLoad){const e=l.directLoad(t,d);e instanceof Promise?e.then(e=>{n(l,e)}).catch(e=>{r("Error in directLoad of _loadData: "+e,e)}):n(l,e)}else n(l,d);return}const h=f.isBinary,u=(e,i)=>{t.isDisposed?r("Scene has been disposed"):n(l,e,i)};let m=null,p=!1;null===(c=l.onDisposeObservable)||void 0===c||c.add(()=>{p=!0,m&&(m.abort(),m=null),s()});const g=()=>{if(p)return;const n=(e,t)=>{r(null==e?void 0:e.statusText,t)};if(!l.loadFile&&e.rawData)throw"Plugin does not support loading ArrayBufferView.";m=l.loadFile?l.loadFile(t,e.rawData||e.file||e.url,e.rootUrl,u,i,h,n,o):t._loadFile(e.file||e.url,u,i,!0,h,n)},_=t.getEngine();let v=_.enableOfflineSupport;if(v){let n=!1;for(const i of t.disableOfflineSupportExceptionRules)if(i.test(e.url)){n=!0;break}v=!n}v&&C.a.OfflineProviderFactory?t.offlineProvider=C.a.OfflineProviderFactory(e.url,g,_.disableManifestCheck):g()})}function F(e,t){let n,i,r=null,s=null;if(t)if(t.name)n="file:"+t.name,i=t.name,r=t;else if(ArrayBuffer.isView(t))n="",i=Object(R.a)(),s=t;else if(t.startsWith("data:"))n=t,i="";else if(e){const r=t;if("/"===r.substring(0,1))return g.b.Error("Wrong sceneFilename parameter"),null;n=e+r,i=r}else n=t,i=g.b.GetFilename(t),e=g.b.GetFolderPath(t);else n=e,i=g.b.GetFilename(e),e=g.b.GetFolderPath(e);return{url:n,rootUrl:e,name:i,file:r,rawData:s}}function w(e){if("string"==typeof e.extensions){const t=e.extensions;O[t.toLowerCase()]={plugin:e,isBinary:!1}}else{const t=e.extensions;Object.keys(t).forEach(n=>{O[n.toLowerCase()]={plugin:e,isBinary:t[n].isBinary,mimeType:t[n].mimeType}})}}async function U(e,t,n="",i=E.a.LastCreatedScene,r=null,s=null,a=null,o=null,l="",c={}){if(!i)return T.a.Error("No scene available to import mesh to"),null;const d=F(t,n);if(!d)return null;const h={};i.addPendingData(h);const u=()=>{i.removePendingData(h)},f=(e,t)=>{const n=L(d,e,t);a?a(i,n,new I.c(n,I.b.SceneLoaderError,t)):T.a.Error(n),u()},m=s?e=>{try{s(e)}catch(e){f("Error in onProgress callback: "+e,e)}}:void 0,p=(e,t,n,s,a,o,l,c)=>{if(i.importedMeshesFiles.push(d.url),r)try{r(e,t,n,s,a,o,l,c)}catch(e){f("Error in onSuccess callback: "+e,e)}i.removePendingData(h)};return await N(d,i,(t,n,r)=>{if(t.rewriteRootURL&&(d.rootUrl=t.rewriteRootURL(d.rootUrl,r)),t.importMesh){const r=[],s=[],a=[];if(!t.importMesh(e,i,n,d.rootUrl,r,s,a,f))return;i.loadingPluginName=t.name,p(r,s,a,[],[],[],[],[])}else t.importMeshAsync(e,i,n,d.rootUrl,m,d.name).then(e=>{i.loadingPluginName=t.name,p(e.meshes,e.particleSystems,e.skeletons,e.animationGroups,e.transformNodes,e.geometries,e.lights,e.spriteManagers)}).catch(e=>{f(e.message,e)})},m,f,u,o,l,c)}async function B(e,t="",n=E.a.LastCreatedEngine,i=null,r=null,s=null,a=null,o="",l={}){n?await k(e,t,new v.a(n),i,r,s,a,o,l):g.b.Error("No engine available")}async function k(e,t="",n=E.a.LastCreatedScene,i=null,r=null,s=null,a=null,o="",l={}){if(!n)return T.a.Error("No scene available to append to"),null;const c=F(e,t);if(!c)return null;const d={};n.addPendingData(d);const h=()=>{n.removePendingData(d)};S.ShowLoadingScreen&&!x&&(x=!0,n.getEngine().displayLoadingUI(),n.executeWhenReady(()=>{n.getEngine().hideLoadingUI(),x=!1}));const u=(e,t)=>{const i=L(c,e,t);s?s(n,i,new I.c(i,I.b.SceneLoaderError,t)):T.a.Error(i),h()},f=r?e=>{try{r(e)}catch(e){u("Error in onProgress callback",e)}}:void 0,m=()=>{if(i)try{i(n)}catch(e){u("Error in onSuccess callback",e)}n.removePendingData(d)};return await N(c,n,(e,t)=>{if(e.load){if(!e.load(n,t,c.rootUrl,u))return;n.loadingPluginName=e.name,m()}else e.loadAsync(n,t,c.rootUrl,f,c.name).then(()=>{n.loadingPluginName=e.name,m()}).catch(e=>{u(e.message,e)})},f,u,h,a,o,l)}async function V(e,t="",n=E.a.LastCreatedScene,i=null,r=null,s=null,a=null,o="",l={}){if(!n)return T.a.Error("No scene available to load asset container to"),null;const c=F(e,t);if(!c)return null;const d={};n.addPendingData(d);const h=()=>{n.removePendingData(d)},u=(e,t)=>{const i=L(c,e,t);s?s(n,i,new I.c(i,I.b.SceneLoaderError,t)):T.a.Error(i),h()},f=r?e=>{try{r(e)}catch(e){u("Error in onProgress callback",e)}}:void 0,m=e=>{if(i)try{i(e)}catch(e){u("Error in onSuccess callback",e)}n.removePendingData(d)};return await N(c,n,(e,t)=>{if(e.loadAssetContainer){const i=e.loadAssetContainer(n,t,c.rootUrl,u);if(!i)return;i.populateRootNodes(),n.loadingPluginName=e.name,m(i)}else e.loadAssetContainerAsync?e.loadAssetContainerAsync(n,t,c.rootUrl,f,c.name).then(t=>{t.populateRootNodes(),n.loadingPluginName=e.name,m(t)}).catch(e=>{u(e.message,e)}):u("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},f,u,h,a,o,l)}async function G(e,t="",n=E.a.LastCreatedScene,i=!0,r=0,s=null,a=null,o=null,l=null,c=null,d="",h={}){if(!n)return void T.a.Error("No scene available to load animations to");if(i){for(const e of n.animatables)e.reset();n.stopAllAnimations(),n.animationGroups.slice().forEach(e=>{e.dispose()}),n.getNodes().forEach(e=>{e.animations&&(e.animations=[])})}else switch(r){case 0:n.animationGroups.slice().forEach(e=>{e.dispose()});break;case 1:n.animationGroups.forEach(e=>{e.stop()});break;case 2:n.animationGroups.forEach(e=>{e.reset(),e.restart()});break;case 3:break;default:return void T.a.Error("Unknown animation group loading mode value '"+r+"'")}const u=n.animatables.length;await V(e,t,n,e=>{e.mergeAnimationsTo(n,n.animatables.slice(u),s),e.dispose(),n.onAnimationFileImportedObservable.notifyObservers(n),a&&a(n)},o,l,c,d,h)}class H{static get ForceFullSceneLoadingForIncremental(){return S.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){S.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return S.ShowLoadingScreen}static set ShowLoadingScreen(e){S.ShowLoadingScreen=e}static get loggingLevel(){return S.loggingLevel}static set loggingLevel(e){S.loggingLevel=e}static get CleanBoneMatrixWeights(){return S.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){S.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return D()}static GetPluginForExtension(e){var t;return null===(t=P(e,!0))||void 0===t?void 0:t.plugin}static IsPluginForExtensionAvailable(e){return function(e){return!!O[e]}(e)}static RegisterPlugin(e){w(e)}static ImportMesh(e,t,n,i,r,s,a,o,l){U(e,t,n,i,r,s,a,o,l).catch(e=>null==a?void 0:a(E.a.LastCreatedScene,null==e?void 0:e.message,e))}static ImportMeshAsync(e,t,n,i,r,s,a){return function(e,t,n,i,r,s,a,o){return new Promise((o,l)=>{try{U(e,t,n,i,(e,t,n,i,r,s,a,l)=>{o({meshes:e,particleSystems:t,skeletons:n,animationGroups:i,transformNodes:r,geometries:s,lights:a,spriteManagers:l})},r,(e,t,n)=>{l(n||new Error(t))},s,a,void 0).catch(l)}catch(e){l(e)}})}(e,t,n,i,r,s,a)}static Load(e,t,n,i,r,s,a,o){B(e,t,n,i,r,s,a,o).catch(e=>null==s?void 0:s(E.a.LastCreatedScene,null==e?void 0:e.message,e))}static LoadAsync(e,t,n,i,r,s){return function(e,t,n,i,r,s,a){return new Promise((o,l)=>{B(e,t,n,e=>{o(e)},i,(e,t,n)=>{l(n||new Error(t))},r,s,a)})}(e,t,n,i,r,s)}static Append(e,t,n,i,r,s,a,o){k(e,t,n,i,r,s,a,o).catch(e=>null==s?void 0:s(null!=n?n:E.a.LastCreatedScene,null==e?void 0:e.message,e))}static AppendAsync(e,t,n,i,r,s){return function(e,t,n,i,r,s,a){return new Promise((o,l)=>{try{k(e,t,n,e=>{o(e)},i,(e,t,n)=>{l(n||new Error(t))},r,s,a).catch(l)}catch(e){l(e)}})}(e,t,n,i,r,s)}static LoadAssetContainer(e,t,n,i,r,s,a,o){V(e,t,n,i,r,s,a,o).catch(e=>null==s?void 0:s(null!=n?n:E.a.LastCreatedScene,null==e?void 0:e.message,e))}static LoadAssetContainerAsync(e,t,n,i,r,s){return function(e,t,n,i,r,s,a){return new Promise((o,l)=>{try{V(e,t,n,e=>{o(e)},i,(e,t,n)=>{l(n||new Error(t))},r,s,a).catch(l)}catch(e){l(e)}})}(e,t,n,i,r,s)}static ImportAnimations(e,t,n,i,r,s,a,o,l,c,d){G(e,t,n,i,r,s,a,o,l,c,d).catch(e=>null==l?void 0:l(null!=n?n:E.a.LastCreatedScene,null==e?void 0:e.message,e))}static ImportAnimationsAsync(e,t,n,i,r,s,a,o,l,c,d){return function(e,t,n,i,r,s,a,o,l,c){return new Promise((d,h)=>{try{G(e,t,n,i,r,s,e=>{d(e)},a,(e,t,n)=>{h(n||new Error(t))},o,l,c).catch(h)}catch(e){h(e)}})}(e,t,n,i,r,s,o,c,d)}}H.NO_LOGGING=0,H.MINIMAL_LOGGING=1,H.SUMMARY_LOGGING=2,H.DETAILED_LOGGING=3,H.OnPluginActivatedObservable=M;var W=n(309),X=n(310);class j{get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!1,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))"_"!==e[0]&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)-1===this._keys.indexOf(e)&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const n=this._keys[t];if(this[n]!==e[n])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const n=this._keys[t];e[n]=this[n]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){var t,n,i;const r=null!==(t=null===(n=this._externalProperties)||void 0===n||null===(n=n[e])||void 0===n?void 0:n.type)&&void 0!==t?t:typeof this[e],s=null===(i=this._externalProperties)||void 0===i||null===(i=i[e])||void 0===i?void 0:i.default;switch(r){case"number":this[e]=null!=s?s:0;break;case"string":this[e]=null!=s?s:"";break;default:this[e]=null!=s&&s}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const n=this._keys[t],i=this[n];switch(typeof i){case"number":case"string":e+="#define "+n+" "+i+"\n";break;default:i&&(e+="#define "+n+"\n")}}return e}constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}}var z=n(165);class K{constructor(e,t,n){this.bu=e,this.bv=t,this.distance=n,this.faceId=0,this.subMeshId=0}}var Y=n(87),q=n(69);class Q{reConstruct(e,t,n){const i=e.x,s=e.y,a=e.z,o=t.x,l=t.y,c=t.z,d=this.vectors;this.minimum.copyFromFloats(i,s,a),this.maximum.copyFromFloats(o,l,c),d[0].copyFromFloats(i,s,a),d[1].copyFromFloats(o,l,c),d[2].copyFromFloats(o,s,a),d[3].copyFromFloats(i,l,a),d[4].copyFromFloats(i,s,c),d[5].copyFromFloats(o,l,a),d[6].copyFromFloats(i,l,c),d[7].copyFromFloats(o,s,c),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=n||r.a.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=Q._TmpVector3,n=this.maximum.subtractToRef(this.minimum,t[0]),i=n.length();n.normalizeFromLength(i);const r=i*e,s=n.scaleInPlace(.5*r),a=this.center.subtractToRef(s,t[1]),o=this.center.addToRef(s,t[2]);return this.reConstruct(a,o,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,n=this.maximumWorld,i=this.directions,s=this.vectorsWorld,a=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),n.copyFrom(this.maximum);for(let e=0;e<8;++e)s[e].copyFrom(a[e]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),n.setAll(-Number.MAX_VALUE);for(let i=0;i<8;++i){const o=s[i];r.e.TransformCoordinatesToRef(a[i],e,o),t.minimizeInPlace(o),n.maximizeInPlace(o)}n.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),n.addToRef(t,this.centerWorld).scaleInPlace(.5)}r.e.FromArrayToRef(e.m,0,i[0]),r.e.FromArrayToRef(e.m,4,i[1]),r.e.FromArrayToRef(e.m,8,i[2]),this._worldMatrix=e}isInFrustum(e){return Q.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return Q.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,n=this.maximumWorld,i=t.x,r=t.y,s=t.z,a=n.x,o=n.y,l=n.z,c=e.x,d=e.y,h=e.z,u=-q.a;return!(a-c<u||u>c-i||o-d<u||u>d-r||l-h<u||u>h-s)}intersectsSphere(e){return Q.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const n=this.minimumWorld,i=this.maximumWorld,r=n.x,s=n.y,a=n.z,o=i.x,l=i.y,c=i.z,d=e.x,h=e.y,u=e.z,f=t.x,m=t.y,p=t.z;return!(o<d||r>f||l<h||s>m||c<u||a>p)}dispose(){var e,t;null===(e=this._drawWrapperFront)||void 0===e||e.dispose(),null===(t=this._drawWrapperBack)||void 0===t||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,n,i){const s=Q._TmpVector3[0];return r.e.ClampToRef(n,e,t,s),r.e.DistanceSquared(n,s)<=i*i}static IsCompletelyInFrustum(e,t){for(let n=0;n<6;++n){const i=t[n];for(let t=0;t<8;++t)if(i.dotCoordinate(e[t])<0)return!1}return!0}static IsInFrustum(e,t){for(let n=0;n<6;++n){let i=!0;const r=t[n];for(let t=0;t<8;++t)if(r.dotCoordinate(e[t])>=0){i=!1;break}if(i)return!1}return!0}constructor(e,t,n){this.vectors=Object(Y.a)(8,r.e.Zero),this.center=r.e.Zero(),this.centerWorld=r.e.Zero(),this.extendSize=r.e.Zero(),this.extendSizeWorld=r.e.Zero(),this.directions=Object(Y.a)(3,r.e.Zero),this.vectorsWorld=Object(Y.a)(8,r.e.Zero),this.minimumWorld=r.e.Zero(),this.maximumWorld=r.e.Zero(),this.minimum=r.e.Zero(),this.maximum=r.e.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,n)}}Q._TmpVector3=Object(Y.a)(3,r.e.Zero);class Z{reConstruct(e,t,n){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const i=r.e.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=.5*i,this._update(n||r.a.IdentityReadOnly)}scale(e){const t=this.radius*e,n=Z._TmpVector3,i=n[0].setAll(t),r=this.center.subtractToRef(i,n[1]),s=this.center.addToRef(i,n[2]);return this.reConstruct(r,s,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{r.e.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=Z._TmpVector3[0];r.e.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,n=this.radiusWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<=-n)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let n=0;n<6;n++)if(e[n].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=r.e.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const n=r.e.DistanceSquared(e.centerWorld,t.centerWorld),i=e.radiusWorld+t.radiusWorld;return!(i*i<n)}static CreateFromCenterAndRadius(e,t,n){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const i=new Z(this._TmpVector3[0],this._TmpVector3[2]);return i._worldMatrix=n||r.a.Identity(),i}constructor(e,t,n){this.center=r.e.Zero(),this.centerWorld=r.e.Zero(),this.minimum=r.e.Zero(),this.maximum=r.e.Zero(),this.reConstruct(e,t,n)}}Z._TmpVector3=Object(Y.a)(3,r.e.Zero);const $={min:0,max:0},J={min:0,max:0},ee=(e,t,n)=>{const i=r.e.Dot(t.centerWorld,e),s=Math.abs(r.e.Dot(t.directions[0],e))*t.extendSize.x+Math.abs(r.e.Dot(t.directions[1],e))*t.extendSize.y+Math.abs(r.e.Dot(t.directions[2],e))*t.extendSize.z;n.min=i-s,n.max=i+s},te=(e,t,n)=>(ee(e,t,$),ee(e,n,J),!($.min>J.max||J.min>$.max));class ne{reConstruct(e,t,n){this.boundingBox.reConstruct(e,t,n),this.boundingSphere.reConstruct(e,t,n)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const n=ne._TmpVector3[0].copyFrom(e).subtractInPlace(t),i=ne._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(n,i,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(n,i,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=r.e.Minimize(this.minimum,e),n=r.e.Maximize(this.maximum,e);return this.reConstruct(t,n,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const t=r.c.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);const n=r.c.Vector3[0];return r.e.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,n),this.encapsulate(n),r.e.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,n),this.encapsulate(n),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return!(2!==t&&3!==t||!this.boundingSphere.isCenterInFrustum(e))||!!this.boundingSphere.isInFrustum(e)&&(!(1!==t&&3!==t)||this.boundingBox.isInFrustum(e))}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,ne._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!!this.boundingSphere.centerWorld&&!!this.boundingSphere.intersectsPoint(e)&&!!this.boundingBox.intersectsPoint(e)}intersects(e,t){if(!Z.Intersects(this.boundingSphere,e.boundingSphere))return!1;if(!Q.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const n=this.boundingBox,i=e.boundingBox;return!!(te(n.directions[0],n,i)&&te(n.directions[1],n,i)&&te(n.directions[2],n,i)&&te(i.directions[0],n,i)&&te(i.directions[1],n,i)&&te(i.directions[2],n,i)&&te(r.e.Cross(n.directions[0],i.directions[0]),n,i)&&te(r.e.Cross(n.directions[0],i.directions[1]),n,i)&&te(r.e.Cross(n.directions[0],i.directions[2]),n,i)&&te(r.e.Cross(n.directions[1],i.directions[0]),n,i)&&te(r.e.Cross(n.directions[1],i.directions[1]),n,i)&&te(r.e.Cross(n.directions[1],i.directions[2]),n,i)&&te(r.e.Cross(n.directions[2],i.directions[0]),n,i)&&te(r.e.Cross(n.directions[2],i.directions[1]),n,i)&&te(r.e.Cross(n.directions[2],i.directions[2]),n,i))}constructor(e,t,n){this._isLocked=!1,this.boundingBox=new Q(e,t,n),this.boundingSphere=new Z(e,t,n)}}ne._TmpVector3=Object(Y.a)(2,r.e.Zero);class ie{static extractMinAndMaxIndexed(e,t,n,i,r,s){for(let a=n;a<n+i;a++){const n=3*t[a],i=e[n],o=e[n+1],l=e[n+2];r.minimizeInPlaceFromFloats(i,o,l),s.maximizeInPlaceFromFloats(i,o,l)}}static extractMinAndMax(e,t,n,i,r,s){for(let a=t,o=t*i;a<t+n;a++,o+=i){const t=e[o],n=e[o+1],i=e[o+2];r.minimizeInPlaceFromFloats(t,n,i),s.maximizeInPlaceFromFloats(t,n,i)}}}function re(e,t,n,i=null,s){const a=new r.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new r.e(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return s||(s=3),ie.extractMinAndMax(e,t,n,s,a,o),i&&(a.x-=a.x*i.x+i.y,a.y-=a.y*i.x+i.y,a.z-=a.z*i.x+i.y,o.x+=o.x*i.x+i.y,o.y+=o.y*i.x+i.y,o.z+=o.z*i.x+i.y),{minimum:a,maximum:o}}Object(W.a)([X.b.filter((...[e,t])=>!Array.isArray(e)&&!Array.isArray(t))],ie,"extractMinAndMaxIndexed",null),Object(W.a)([X.b.filter((...[e])=>!Array.isArray(e))],ie,"extractMinAndMax",null);var se=n(337);class ae{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:null===(e=this._getDrawWrapper())||void 0===e?void 0:e.defines}set materialDefines(e){var t;(null!==(t=this._mainDrawWrapperOverride)&&void 0!==t?t:this._getDrawWrapper(void 0,!0)).defines=e}_getDrawWrapper(e,t=!1){var n;e=null!==(n=e)&&void 0!==n?n:this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new se.a(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0,n=!1){var i;t&&(null===(i=this._drawWrappers[e])||void 0===i||i.dispose(n)),this._drawWrappers[e]=void 0}get effect(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:null!==(e=null===(t=this._getDrawWrapper())||void 0===t?void 0:t.effect)&&void 0!==e?e:null}get _drawWrapper(){var e;return null!==(e=this._mainDrawWrapperOverride)&&void 0!==e?e:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,n,i=!0){const r=this._drawWrapper;r.setEffect(e,t,i),void 0!==n&&(r.materialContext=n),e||(r.defines=null,r.materialContext=void 0)}resetDrawCache(e,t=!1){if(this._drawWrappers){if(void 0!==e)return void this._removeDrawWrapper(e,!0,t);for(const e of this._drawWrappers)null==e||e.dispose(t)}this._drawWrappers=[]}static AddToMesh(e,t,n,i,r,s,a,o=!0){return new ae(e,t,n,i,r,s,a,o)}get IsGlobal(){return 0===this.verticesStart&&this.verticesCount===this._mesh.getTotalVertices()&&0===this.indexStart&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){return(this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null)||this._renderingMesh}getMaterial(e=!0){var t;const n=null!==(t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))&&void 0!==t?t:this._renderingMesh.material;if(!n)return e?this._mesh.getScene().defaultMaterial:null;if(this._isMultiMaterial(n)){const e=n.getSubMaterial(this.materialIndex);return this._currentMaterial!==e&&(this._currentMaterial=e,this.resetDrawCache()),e}return n}_isMultiMaterial(e){return void 0!==e.getSubMaterial}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(z.b.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let n;if(0===this.indexStart&&this.indexCount===t.length){const e=this._renderingMesh.getBoundingInfo();n={minimum:e.minimum.clone(),maximum:e.maximum.clone()}}else n=function(e,t,n,i,s=null){const a=new r.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new r.e(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return ie.extractMinAndMaxIndexed(e,t,n,i,a,o),s&&(a.x-=a.x*s.x+s.y,a.y-=a.y*s.x+s.y,a.z-=a.z*s.x+s.y,o.x+=o.x*s.x+s.y,o.y+=o.y*s.x+s.y,o.z+=o.z*s.x+s.y),{minimum:a,maximum:o}}(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(n.minimum,n.maximum):this._boundingInfo=new ne(n.minimum,n.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isInFrustum(e,this._mesh.cullingStrategy)}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isCompletelyInFrustum(e)}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const n=6*Math.floor(this.indexCount/3),i=this.verticesStart+this.verticesCount>65535?new Uint32Array(n):new Uint16Array(n);let r=0;if(0===e.length)for(let e=this.indexStart;e<this.indexStart+this.indexCount;e+=3)i[r++]=e,i[r++]=e+1,i[r++]=e+1,i[r++]=e+2,i[r++]=e+2,i[r++]=e;else for(let t=this.indexStart;t<this.indexStart+this.indexCount;t+=3)i[r++]=e[t],i[r++]=e[t+1],i[r++]=e[t+1],i[r++]=e[t+2],i[r++]=e[t+2],i[r++]=e[t];this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return!!t&&e.intersectsBox(t.boundingBox)}intersects(e,t,n,i,r){const s=this.getMaterial();if(!s)return null;let a=3,o=!1;switch(s.fillMode){case 3:case 5:case 6:case 8:return null;case 7:a=1,o=!0}return 4===s.fillMode?n.length?this._intersectLines(e,t,n,this._mesh.intersectionThreshold,i):this._intersectUnIndexedLines(e,t,n,this._mesh.intersectionThreshold,i):!n.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,n,i,r):this._intersectTriangles(e,t,n,a,o,i,r)}_intersectLines(e,t,n,i,r){let s=null;for(let a=this.indexStart;a<this.indexStart+this.indexCount;a+=2){const o=t[n[a]],l=t[n[a+1]],c=e.intersectionSegment(o,l,i);if(!(c<0)&&(r||!s||c<s.distance)&&(s=new K(null,null,c),s.faceId=a/2,r))break}return s}_intersectUnIndexedLines(e,t,n,i,r){let s=null;for(let n=this.verticesStart;n<this.verticesStart+this.verticesCount;n+=2){const a=t[n],o=t[n+1],l=e.intersectionSegment(a,o,i);if(!(l<0)&&(r||!s||l<s.distance)&&(s=new K(null,null,l),s.faceId=n/2,r))break}return s}_intersectTriangles(e,t,n,i,r,s,a){let o=null,l=-1;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-i);c+=i){l++;const i=n[c],d=n[c+1],h=n[c+2];if(r&&4294967295===h){c+=2;continue}const u=t[i],f=t[d],m=t[h];if(!u||!f||!m)continue;if(a&&!a(u,f,m,e,i,d,h))continue;const p=e.intersectsTriangle(u,f,m);if(p){if(p.distance<0)continue;if((s||!o||p.distance<o.distance)&&(o=p,o.faceId=l,s))break}}return o}_intersectUnIndexedTriangles(e,t,n,i,r){let s=null;for(let n=this.verticesStart;n<this.verticesStart+this.verticesCount;n+=3){const a=t[n],o=t[n+1],l=t[n+2];if(r&&!r(a,o,l,e,-1,-1,-1))continue;const c=e.intersectsTriangle(a,o,l);if(c){if(c.distance<0)continue;if((i||!s||c.distance<s.distance)&&(s=c,s.faceId=n/3,i))break}}return s}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const n=new ae(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const e=this.getBoundingInfo();if(!e)return n;n._boundingInfo=new ne(e.minimum,e.maximum)}return n}dispose(e=!1){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const t=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(t,1),this.resetDrawCache(void 0,e)}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,n,i,r,s=!0){let a=Number.MAX_VALUE,o=-Number.MAX_VALUE;const l=(r||i).getIndices();for(let e=t;e<t+n;e++){const t=l[e];t<a&&(a=t),t>o&&(o=t)}return new ae(e,a,o-a+1,t,n,i,r,s)}constructor(e,t,n,i,r,s,a,o=!0,l=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=n,this.indexStart=i,this.indexCount=r,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=s,this._renderingMesh=a||s,l&&s.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=s.subMeshes.length-1,o&&(this.refreshBoundingInfo(),s.computeWorldMatrix(!0))}}var oe=n(339),le=n(328),ce=n(313);class de{reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){ce.a.Clone(()=>e,this)}serialize(){return ce.a.Serialize(this)}parse(e,t,n){ce.a.Parse(()=>this,e,t,n)}constructor(){this.reset()}}Object(W.a)([Object(X.c)()],de.prototype,"func",null),Object(W.a)([Object(X.c)()],de.prototype,"funcRef",null),Object(W.a)([Object(X.c)()],de.prototype,"funcMask",null),Object(W.a)([Object(X.c)()],de.prototype,"opStencilFail",null),Object(W.a)([Object(X.c)()],de.prototype,"opDepthFail",null),Object(W.a)([Object(X.c)()],de.prototype,"opStencilDepthPass",null),Object(W.a)([Object(X.c)()],de.prototype,"mask",null),Object(W.a)([Object(X.c)()],de.prototype,"enabled",null);var he=n(311),ue=n(377);function fe(e){-1===e.indexOf("vClipPlane")&&e.push("vClipPlane"),-1===e.indexOf("vClipPlane2")&&e.push("vClipPlane2"),-1===e.indexOf("vClipPlane3")&&e.push("vClipPlane3"),-1===e.indexOf("vClipPlane4")&&e.push("vClipPlane4"),-1===e.indexOf("vClipPlane5")&&e.push("vClipPlane5"),-1===e.indexOf("vClipPlane6")&&e.push("vClipPlane6")}function me(e,t,n){var i,r,s,a,o,l;const c=!!(null!==(i=e.clipPlane)&&void 0!==i?i:t.clipPlane),d=!!(null!==(r=e.clipPlane2)&&void 0!==r?r:t.clipPlane2),h=!!(null!==(s=e.clipPlane3)&&void 0!==s?s:t.clipPlane3),u=!!(null!==(a=e.clipPlane4)&&void 0!==a?a:t.clipPlane4),f=!!(null!==(o=e.clipPlane5)&&void 0!==o?o:t.clipPlane5),m=!!(null!==(l=e.clipPlane6)&&void 0!==l?l:t.clipPlane6);c&&n.push("#define CLIPPLANE"),d&&n.push("#define CLIPPLANE2"),h&&n.push("#define CLIPPLANE3"),u&&n.push("#define CLIPPLANE4"),f&&n.push("#define CLIPPLANE5"),m&&n.push("#define CLIPPLANE6")}function pe(e,t,n){var i,r,s,a,o,l;let c=null!==(i=t.clipPlane)&&void 0!==i?i:n.clipPlane;ge(e,"vClipPlane",c),c=null!==(r=t.clipPlane2)&&void 0!==r?r:n.clipPlane2,ge(e,"vClipPlane2",c),c=null!==(s=t.clipPlane3)&&void 0!==s?s:n.clipPlane3,ge(e,"vClipPlane3",c),c=null!==(a=t.clipPlane4)&&void 0!==a?a:n.clipPlane4,ge(e,"vClipPlane4",c),c=null!==(o=t.clipPlane5)&&void 0!==o?o:n.clipPlane5,ge(e,"vClipPlane5",c),c=null!==(l=t.clipPlane6)&&void 0!==l?l:n.clipPlane6,ge(e,"vClipPlane6",c)}function ge(e,t,n){n&&e.setFloat4(t,n.normal.x,n.normal.y,n.normal.z,n.d)}const _e=he.a.Black(),ve={NUM_MORPH_INFLUENCERS:0,NORMAL:!1,TANGENT:!1,UV:!1,UV2:!1,COLOR:!1};function Ee(e,t,n){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const e=n.activeCamera;1===e.mode&&T.a.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(e.maxZ+1)/Math.LN2))}}function Te(e,t,n,i=!1){n&&e.fogEnabled&&(!t||t.applyFog)&&0!==e.fogMode&&(n.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),i?(e.fogColor.toLinearSpaceToRef(_e,e.getEngine().useExactSrgbConversions),n.setColor3("vFogColor",_e)):n.setColor3("vFogColor",e.fogColor))}function Se(e,t,n,i,r,s,a,o,l,c){const d=e.numMaxInfluencers||e.numInfluencers;return d<=0?0:(t.push("#define MORPHTARGETS"),e.hasPositions&&t.push("#define MORPHTARGETTEXTURE_HASPOSITIONS"),e.hasNormals&&t.push("#define MORPHTARGETTEXTURE_HASNORMALS"),e.hasTangents&&t.push("#define MORPHTARGETTEXTURE_HASTANGENTS"),e.hasUVs&&t.push("#define MORPHTARGETTEXTURE_HASUVS"),e.hasUV2s&&t.push("#define MORPHTARGETTEXTURE_HASUV2S"),e.hasColors&&t.push("#define MORPHTARGETTEXTURE_HASCOLORS"),e.supportsPositions&&r&&t.push("#define MORPHTARGETS_POSITION"),e.supportsNormals&&s&&t.push("#define MORPHTARGETS_NORMAL"),e.supportsTangents&&a&&t.push("#define MORPHTARGETS_TANGENT"),e.supportsUVs&&o&&t.push("#define MORPHTARGETS_UV"),e.supportsUV2s&&l&&t.push("#define MORPHTARGETS_UV2"),e.supportsColors&&c&&t.push("#define MORPHTARGETS_COLOR"),t.push("#define NUM_MORPH_INFLUENCERS "+d),e.isUsingTextureForTargets&&t.push("#define MORPHTARGETS_TEXTURE"),ve.NUM_MORPH_INFLUENCERS=d,ve.NORMAL=s,ve.TANGENT=a,ve.UV=o,ve.UV2=l,ve.COLOR=c,Ae(n,i,ve,r),d)}function Ae(e,t,n,i=!0){const r=n.NUM_MORPH_INFLUENCERS;if(r>0&&E.a.LastCreatedEngine){const s=E.a.LastCreatedEngine.getCaps().maxVertexAttribs,a=t.morphTargetManager;if(null!=a&&a.isUsingTextureForTargets)return;const o=a&&a.supportsPositions&&i,l=a&&a.supportsNormals&&n.NORMAL,c=a&&a.supportsTangents&&n.TANGENT,d=a&&a.supportsUVs&&n.UV1,h=a&&a.supportsUV2s&&n.UV2,u=a&&a.supportsColors&&n.COLOR;for(let n=0;n<r;n++)o&&e.push("position"+n),l&&e.push("normal"+n),c&&e.push("tangent"+n),d&&e.push("uv_"+n),h&&e.push("uv2_"+n),u&&e.push("color"+n),e.length>s&&T.a.Error("Cannot add more vertex attributes for mesh "+t.name)}}function be(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}function Ie(e,t){const n=e.morphTargetManager;e&&n&&t.setFloatArray("morphTargetInfluences",n.influences)}function Re(e,t){t.bindToEffect(e,"Scene")}function Ce(e,t,n){t._needUVs=!0,t[n]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[n+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[n+"DIRECTUV"]=0}function ye(e,t,n){const i=e.getTextureMatrix();t.updateMatrix(n+"Matrix",i)}function Me(e,t,n){n.BAKED_VERTEX_ANIMATION_TEXTURE&&n.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}function Oe(e,t,n){var i;if(t&&e&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const r=e.skeleton;if(r.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const n=r.getTransformMatrixTexture(e);t.setTexture("boneSampler",n),t.setFloat("boneTextureWidth",4*(r.bones.length+1))}else{const s=r.getTransformMatrices(e);s&&(t.setMatrices("mBones",s),n&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(n.previousBones[e.uniqueId]||(n.previousBones[e.uniqueId]=s.slice()),t.setMatrices("mPreviousBones",n.previousBones[e.uniqueId]),i=s,n.previousBones[e.uniqueId].set(i)))}}}function xe(e,t,n,i,r,s=!0){e._bindLight(t,n,i,r,s)}function De(e,t,n,i,r=4){const s=Math.min(t.lightSources.length,r);for(let r=0;r<s;r++)xe(t.lightSources[r],r,e,n,"boolean"==typeof i?i:i.SPECULARTERM,t.receiveShadows)}function Pe(e,t,n,i){n.NUM_BONE_INFLUENCERS>0&&(i.addCPUSkinningFallback(0,t),e.push("matricesIndices"),e.push("matricesWeights"),n.NUM_BONE_INFLUENCERS>4&&(e.push("matricesIndicesExtra"),e.push("matricesWeightsExtra")))}function Le(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&be(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push("instanceColor")}function Ne(e,t,n=4,i=0){let r=0;for(let s=0;s<n&&e["LIGHT"+s];s++)s>0&&(r=i+s,t.addFallback(r,"LIGHT"+s)),e.SHADOWS||(e["SHADOW"+s]&&t.addFallback(i,"SHADOW"+s),e["SHADOWPCF"+s]&&t.addFallback(i,"SHADOWPCF"+s),e["SHADOWPCSS"+s]&&t.addFallback(i,"SHADOWPCSS"+s),e["SHADOWPOISSON"+s]&&t.addFallback(i,"SHADOWPOISSON"+s),e["SHADOWESM"+s]&&t.addFallback(i,"SHADOWESM"+s),e["SHADOWCLOSEESM"+s]&&t.addFallback(i,"SHADOWCLOSEESM"+s));return r++}function Fe(e,t,n,i,r,s,a,o=!1){a._areMiscDirty&&(a.LOGARITHMICDEPTH=n,a.POINTSIZE=i,a.FOG=r&&function(e,t){return t.fogEnabled&&e.applyFog&&0!==t.fogMode}(e,t),a.NONUNIFORMSCALING=e.nonUniformScaling,a.ALPHATEST=s,a.DECAL_AFTER_DETAIL=o)}function we(e,t,n,i,r=4,s=!1){if(!n._areLightsDirty)return n._needNormals;let a=0;const o={needNormals:n._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!s)for(const s of t.lightSources)if(Ue(e,t,s,a,n,i,o),a++,a===r)break;n.SPECULARTERM=o.specularEnabled,n.SHADOWS=o.shadowEnabled;for(let e=a;e<r;e++)void 0!==n["LIGHT"+e]&&(n["LIGHT"+e]=!1,n["HEMILIGHT"+e]=!1,n["POINTLIGHT"+e]=!1,n["DIRLIGHT"+e]=!1,n["SPOTLIGHT"+e]=!1,n["AREALIGHT"+e]=!1,n["SHADOW"+e]=!1,n["SHADOWCSM"+e]=!1,n["SHADOWCSMDEBUG"+e]=!1,n["SHADOWCSMNUM_CASCADES"+e]=!1,n["SHADOWCSMUSESHADOWMAXZ"+e]=!1,n["SHADOWCSMNOBLEND"+e]=!1,n["SHADOWCSM_RIGHTHANDED"+e]=!1,n["SHADOWPCF"+e]=!1,n["SHADOWPCSS"+e]=!1,n["SHADOWPOISSON"+e]=!1,n["SHADOWESM"+e]=!1,n["SHADOWCLOSEESM"+e]=!1,n["SHADOWCUBE"+e]=!1,n["SHADOWLOWQUALITY"+e]=!1,n["SHADOWMEDIUMQUALITY"+e]=!1);const l=e.getEngine().getCaps();return void 0===n.SHADOWFLOAT&&(o.needRebuild=!0),n.SHADOWFLOAT=o.shadowEnabled&&(l.textureFloatRender&&l.textureFloatLinearFiltering||l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering),n.LIGHTMAPEXCLUDED=o.lightmapMode,o.needRebuild&&n.rebuild(),o.needNormals}function Ue(e,t,n,i,r,s,a){switch(a.needNormals=!0,void 0===r["LIGHT"+i]&&(a.needRebuild=!0),r["LIGHT"+i]=!0,r["SPOTLIGHT"+i]=!1,r["HEMILIGHT"+i]=!1,r["POINTLIGHT"+i]=!1,r["DIRLIGHT"+i]=!1,r["AREALIGHT"+i]=!1,n.prepareLightSpecificDefines(r,i),r["LIGHT_FALLOFF_PHYSICAL"+i]=!1,r["LIGHT_FALLOFF_GLTF"+i]=!1,r["LIGHT_FALLOFF_STANDARD"+i]=!1,n.falloffType){case ue.a.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+i]=!0;break;case ue.a.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+i]=!0;break;case ue.a.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+i]=!0}if(s&&!n.specular.equalsFloats(0,0,0)&&(a.specularEnabled=!0),r["SHADOW"+i]=!1,r["SHADOWCSM"+i]=!1,r["SHADOWCSMDEBUG"+i]=!1,r["SHADOWCSMNUM_CASCADES"+i]=!1,r["SHADOWCSMUSESHADOWMAXZ"+i]=!1,r["SHADOWCSMNOBLEND"+i]=!1,r["SHADOWCSM_RIGHTHANDED"+i]=!1,r["SHADOWPCF"+i]=!1,r["SHADOWPCSS"+i]=!1,r["SHADOWPOISSON"+i]=!1,r["SHADOWESM"+i]=!1,r["SHADOWCLOSEESM"+i]=!1,r["SHADOWCUBE"+i]=!1,r["SHADOWLOWQUALITY"+i]=!1,r["SHADOWMEDIUMQUALITY"+i]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&n.shadowEnabled){var o;const t=null!==(o=n.getShadowGenerator(e.activeCamera))&&void 0!==o?o:n.getShadowGenerator();if(t){const e=t.getShadowMap();e&&e.renderList&&e.renderList.length>0&&(a.shadowEnabled=!0,t.prepareDefines(r,i))}}n.lightmapMode!=ue.a.LIGHTMAP_DEFAULT?(a.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+i]=!0,r["LIGHTMAPNOSPECULAR"+i]=n.lightmapMode==ue.a.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+i]=!1,r["LIGHTMAPNOSPECULAR"+i]=!1)}function Be(e,t,n,i,r,s=null,a=!1){let o=function(e,t){let n=!1;if(e.activeCamera){const i=t.CAMERA_ORTHOGRAPHIC?1:0,r=t.CAMERA_PERSPECTIVE?1:0,s=1===e.activeCamera.mode?1:0,a=0===e.activeCamera.mode?1:0;(i^s||r^a)&&(t.CAMERA_ORTHOGRAPHIC=1===s,t.CAMERA_PERSPECTIVE=1===a,n=!0)}return n}(e,i);!1!==s&&(o=function(e,t,n){var i,r,s,a,o,l;let c=!1;const d=!!(null!==(i=e.clipPlane)&&void 0!==i?i:t.clipPlane),h=!!(null!==(r=e.clipPlane2)&&void 0!==r?r:t.clipPlane2),u=!!(null!==(s=e.clipPlane3)&&void 0!==s?s:t.clipPlane3),f=!!(null!==(a=e.clipPlane4)&&void 0!==a?a:t.clipPlane4),m=!!(null!==(o=e.clipPlane5)&&void 0!==o?o:t.clipPlane5),p=!!(null!==(l=e.clipPlane6)&&void 0!==l?l:t.clipPlane6);return n.CLIPPLANE!==d&&(n.CLIPPLANE=d,c=!0),n.CLIPPLANE2!==h&&(n.CLIPPLANE2=h,c=!0),n.CLIPPLANE3!==u&&(n.CLIPPLANE3=u,c=!0),n.CLIPPLANE4!==f&&(n.CLIPPLANE4=f,c=!0),n.CLIPPLANE5!==m&&(n.CLIPPLANE5=m,c=!0),n.CLIPPLANE6!==p&&(n.CLIPPLANE6=p,c=!0),c}(n,e,i)),i.DEPTHPREPASS!==!t.getColorWrite()&&(i.DEPTHPREPASS=!i.DEPTHPREPASS,o=!0),i.INSTANCES!==r&&(i.INSTANCES=r,o=!0),i.THIN_INSTANCES!==a&&(i.THIN_INSTANCES=a,o=!0),o&&i.markAsUnprocessed()}function ke(e,t,n,i,r=!1,s=!0,a=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent("normal"),t._needNormals&&e.isVerticesDataPresent("tangent")&&(t.TANGENT=!0);for(let n=1;n<=6;++n)t["UV"+n]=!!t._needUVs&&e.isVerticesDataPresent("uv"+(1===n?"":n));if(n){const n=e.useVertexColors&&e.isVerticesDataPresent("color");t.VERTEXCOLOR=n,t.VERTEXALPHA=e.hasVertexAlpha&&n&&s}return e.isVerticesDataPresent("instanceColor")&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),i&&function(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const n=void 0!==t.BONETEXTURE;if(e.skeleton.isUsingTextureForMatrices&&n)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=!n&&void 0;const i=e.getScene().prePassRenderer;if(i&&i.enabled){const n=-1===i.excludedSkinnedMesh.indexOf(e);t.BONES_VELOCITY_ENABLED=n}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,void 0!==t.BONETEXTURE&&(t.BONETEXTURE=!1)}(e,t),r&&function(e,t){const n=e.morphTargetManager;n?(t.MORPHTARGETS_UV=n.supportsUVs&&t.UV1,t.MORPHTARGETS_UV2=n.supportsUV2s&&t.UV2,t.MORPHTARGETS_TANGENT=n.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=n.supportsNormals&&t.NORMAL,t.MORPHTARGETS_POSITION=n.supportsPositions,t.MORPHTARGETS_COLOR=n.supportsColors,t.MORPHTARGETTEXTURE_HASUVS=n.hasUVs,t.MORPHTARGETTEXTURE_HASUV2S=n.hasUV2s,t.MORPHTARGETTEXTURE_HASTANGENTS=n.hasTangents,t.MORPHTARGETTEXTURE_HASNORMALS=n.hasNormals,t.MORPHTARGETTEXTURE_HASPOSITIONS=n.hasPositions,t.MORPHTARGETTEXTURE_HASCOLORS=n.hasColors,t.NUM_MORPH_INFLUENCERS=n.numMaxInfluencers||n.numInfluencers,t.MORPHTARGETS=t.NUM_MORPH_INFLUENCERS>0,t.MORPHTARGETS_TEXTURE=n.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_UV2=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS_POSITION=!1,t.MORPHTARGETS_COLOR=!1,t.MORPHTARGETTEXTURE_HASUVS=!1,t.MORPHTARGETTEXTURE_HASUV2S=!1,t.MORPHTARGETTEXTURE_HASTANGENTS=!1,t.MORPHTARGETTEXTURE_HASNORMALS=!1,t.MORPHTARGETTEXTURE_HASPOSITIONS=!1,t.MORPHTARGETTEXTURE_HAS_COLORS=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}(e,t),a&&function(e,t){const n=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!(!n||!n.isEnabled)}(e,t),!0}function Ve(e,t){if(e.activeCamera){const n=t.MULTIVIEW;t.MULTIVIEW=null!==e.activeCamera.outputRenderTarget&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=n&&t.markAsUnprocessed()}}function Ge(e,t,n){const i=t.ORDER_INDEPENDENT_TRANSPARENCY,r=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&n,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,i===t.ORDER_INDEPENDENT_TRANSPARENCY&&r===t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS||t.markAsUnprocessed()}function He(e,t,n){const i=t.PREPASS;if(!t._arePrePassDirty)return;const r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:9,define:"PREPASS_LOCAL_POSITION",index:"PREPASS_LOCAL_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:11,define:"PREPASS_VELOCITY_LINEAR",index:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:10,define:"PREPASS_SCREENSPACE_DEPTH",index:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"},{type:8,define:"PREPASS_WORLD_NORMAL",index:"PREPASS_WORLD_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&n){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount,t.PREPASS_NORMAL_WORLDSPACE=e.prePassRenderer.generateNormalsInWorldSpace,t.PREPASS_COLOR=!0,t.PREPASS_COLOR_INDEX=0;for(let n=0;n<r.length;n++){const i=e.prePassRenderer.getIndex(r[n].type);-1!==i?(t[r[n].define]=!0,t[r[n].index]=i):t[r[n].define]=!1}}else{t.PREPASS=!1;for(let e=0;e<r.length;e++)t[r[e].define]=!1}t.PREPASS!=i&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}function We(e,t,n,i,r=null,s=!1,a=!1){r&&r.push("Light"+e),s||(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightWidth"+e,"vLightHeight"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),n.push("shadowTexture"+e),n.push("depthTexture"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),i&&(n.push("projectionLightTexture"+e),t.push("textureProjectionMatrix"+e)),a&&n.push("iesLightTexture"+e))}function Xe(e,t,n,i=4){let r,s;if(e.uniformsNames){const a=e;r=a.uniformsNames,s=a.uniformBuffersNames,t=a.samplers,n=a.defines,i=a.maxSimultaneousLights||0}else r=e,t||(t=[]);for(let e=0;e<i&&n["LIGHT"+e];e++)We(e,r,t,n["PROJECTEDLIGHTTEXTURE"+e],s,!1,n["IESLIGHTTEXTURE"+e]);n.NUM_MORPH_INFLUENCERS&&(r.push("morphTargetInfluences"),r.push("morphTargetCount")),n.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}class je{get _supportGlowLayer(){return!1}set _glowModeEnabled(e){}get shaderLanguage(){return this._shaderLanguage}get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,1!==t&&1!==e||this.markAsDirty(je.MiscDirtyFlag+je.PrePassDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(je.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(je.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new _.a),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new _.a),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new _.a),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(je.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(je.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case je.WireFrameFillMode:case je.LineListDrawMode:case je.LineLoopDrawMode:case je.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?je.WireFrameFillMode:je.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case je.PointFillMode:case je.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?je.PointFillMode:je.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(je.MiscDirtyFlag))}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=this.getScene().getEngine().getCaps().fragmentDepthSupported;e&&!t&&T.a.Warn("Logarithmic depth has been requested for a material on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._markAllSubMeshesAsMiscDirty()}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}_createUniformBuffer(){var e;const t=this.getScene().getEngine();null===(e=this._uniformBuffer)||void 0===e||e.dispose(),t.isWebGPU&&!this._forceGLSL?(this._uniformBuffer=new oe.a(t,void 0,void 0,this.name,!0),this._shaderLanguage=1):this._uniformBuffer=new oe.a(this._scene.getEngine(),void 0,void 0,this.name),this._uniformBufferLayoutBuilt=!1}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,n){const i=t.materialDefines;return!!i&&(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=i,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh)}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}_getEffectiveOrientation(e){return null!==this.sideOrientation?this.sideOrientation:e.sideOrientation}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _hasTransparencyMode(){return null!=this._transparencyMode}get _transparencyModeIsBlend(){return this._transparencyMode===je.MATERIAL_ALPHABLEND||this._transparencyMode===je.MATERIAL_ALPHATESTANDBLEND}get _transparencyModeIsTest(){return this._transparencyMode===je.MATERIAL_ALPHATEST||this._transparencyMode===je.MATERIAL_ALPHATESTANDBLEND}get _disableAlphaBlending(){return this._transparencyMode===je.MATERIAL_OPAQUE||this._transparencyMode===je.MATERIAL_ALPHATEST}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:!this._disableAlphaBlending&&this.alpha<1}needAlphaBlendingForMesh(e){return this._hasTransparencyMode?this._transparencyModeIsBlend:e.visibility<1||!this._disableAlphaBlending&&(e.hasVertexAlpha||this.needAlphaBlending())}needAlphaTesting(){return!!this._hasTransparencyMode&&this._transparencyModeIsTest}needAlphaTestingForMesh(e){return this._hasTransparencyMode?this._transparencyModeIsTest:!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const n of t)if(n.subMeshes)for(const t of n.subMeshes)if(t.getMaterial()===this)for(const n of t._drawWrappers)n&&this._materialContext===n.materialContext&&(n._wasPreviouslyReady=!1,n._wasPreviouslyUsingInstances=null,n._forceRebindOnNextCall=e);e&&this.markAsDirty(je.AllDirtyFlag)}_preBind(e,t=null){const n=this._scene.getEngine(),i=(null==t?this.sideOrientation:t)===je.ClockWiseSideOrientation;return n.enableEffect(e||this._getDrawWrapper()),n.setState(this.backFaceCulling,this.zOffset,!1,i,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),i}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(8,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,n){const i=n._drawWrapper;this._eventInfo.subMesh=n,this._callbackPluginEventBindForSubMesh(this._eventInfo),i._forceRebindOnNextCall=!1}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null,n){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,Re(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),this._scene._cachedVisibility=e?e.visibility:1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const e=this._scene.getEngine();this._cachedDepthWriteState=e.getDepthWrite(),e.setDepthWrite(!1)}if(this.disableColorWrite){const e=this._scene.getEngine();this._cachedColorWriteState=e.getColorWrite(),e.setColorWrite(!1)}if(0!==this.depthFunction){const e=this._scene.getEngine();this._cachedDepthFunctionState=e.getDepthFunction()||0,e.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),0!==this.depthFunction&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(256,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(512,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(1024,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){const n={};if(this._serializePlugins(n),je._ParsePlugins(n,e,this._scene,t),this.pluginManager)for(const t of this.pluginManager._plugins){const n=e.pluginManager.getPlugin(t.name);n&&t.copyTo(n)}}getBindedMeshes(){if(this.meshMap){const e=[];for(const t in this.meshMap){const n=this.meshMap[t];n&&e.push(n)}return e}return this._scene.meshes.filter(e=>e.material===this)}forceCompilation(e,t,n,i){const r={clipPlane:!1,useInstances:!1,...n},s=this.getScene(),a=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const o=()=>{if(!this._scene||!this._scene.getEngine())return;const n=s.clipPlane;if(r.clipPlane&&(s.clipPlane=new le.a(0,0,0,1)),this._storeEffectOnSubMeshes){let n=!0,s=null;if(e.subMeshes){const t=new ae(0,0,0,0,0,e,void 0,!1,!1);t.materialDefines&&(t.materialDefines._renderId=-1),this.isReadyForSubMesh(e,t,r.useInstances)||(t.effect&&t.effect.getCompilationError()&&t.effect.allFallbacksProcessed()?s=t.effect.getCompilationError():(n=!1,setTimeout(o,16)))}n&&(this.allowShaderHotSwapping=a,s&&i&&i(s),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=a,t&&t(this)):setTimeout(o,16);r.clipPlane&&(s.clipPlane=n)};o()}forceCompilationAsync(e,t){return new Promise((n,i)=>{this.forceCompilation(e,()=>{n()},t,e=>{i(e)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(je._DirtyCallbackArray.length=0,e&je.TextureDirtyFlag&&je._DirtyCallbackArray.push(je._TextureDirtyCallBack),e&je.LightDirtyFlag&&je._DirtyCallbackArray.push(je._LightsDirtyCallBack),e&je.FresnelDirtyFlag&&je._DirtyCallbackArray.push(je._FresnelDirtyCallBack),e&je.AttributesDirtyFlag&&je._DirtyCallbackArray.push(je._AttributeDirtyCallBack),e&je.MiscDirtyFlag&&je._DirtyCallbackArray.push(je._MiscDirtyCallBack),e&je.PrePassDirtyFlag&&je._DirtyCallbackArray.push(je._PrePassDirtyCallBack),je._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(je._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const e of t.subMeshes)e.getMaterial()===this&&e.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const n of t)if(n.subMeshes)for(const t of n.subMeshes)if(t.getMaterial(!1)===this)for(const n of t._drawWrappers)n&&n.defines&&n.defines.markAllAsDirty&&this._materialContext===n.materialContext&&e(n.defines)}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(je._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(je._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(je._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(je._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(je._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(je._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(je._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(je._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(je._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(je._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(0!==this._scene.performancePriority){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,t,n){const i=this.getScene();if(i.stopAnimation(this),i.freeProcessedMaterials(),i.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(2,this._eventInfo),this._parentContainer){const e=this._parentContainer.materials.indexOf(this);e>-1&&this._parentContainer.materials.splice(e,1),this._parentContainer=null}if(!0!==n)if(this.meshMap)for(const e in this.meshMap){const t=this.meshMap[e];this._disposeMeshResources(t)}else{const e=i.meshes;for(const t of e)this._disposeMeshResources(t)}this._uniformBuffer.dispose(),this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}_disposeMeshResources(e){if(!e)return;const t=e.geometry,n=e._internalAbstractMeshDataInfo._materialForRenderPass;if(this._storeEffectOnSubMeshes){if(e.subMeshes&&n)for(const r of e.subMeshes){const e=r._drawWrappers;for(let s=0;s<e.length;s++){var i;const a=null===(i=e[s])||void 0===i?void 0:i.effect;a&&(n[s]===this&&(null==t||t._releaseVertexArrayObject(a),r._removeDrawWrapper(s,!0,!0)))}}}else null==t||t._releaseVertexArrayObject(this._drawWrapper.effect);e.material!==this||e.sourceMesh||(e.material=null)}serialize(){const e=ce.a.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(const t of this.pluginManager._plugins)t.doNotSerialize||(e.plugins[t.getClassName()]=t.serialize())}static Parse(e,t,n){if(e.customType){if("BABYLON.PBRMaterial"===e.customType&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return T.a.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null}else e.customType="BABYLON.StandardMaterial";const i=g.b.Instantiate(e.customType).Parse(e,t,n);return i._loadedUniqueId=e.uniqueId,i}static _ParsePlugins(e,t,n,i){if(e.plugins)for(const a in e.plugins){var r,s;const o=e.plugins[a];let l=null===(r=t.pluginManager)||void 0===r?void 0:r.getPlugin(o.name);if(!l){const e=g.b.Instantiate("BABYLON."+a);e&&(l=new e(t))}null===(s=l)||void 0===s||s.parse(o,n,i)}}constructor(e,t,n,i=!1){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this._shaderLanguage=0,this._forceGLSL=!1,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.sideOrientation=null,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new _.a,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new de,this._useUBO=!1,this._fillMode=je.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._transparencyMode=null,this.name=e;const r=t||E.a.LastCreatedScene;r&&(this._scene=r,this._dirtyCallbacks={},this._forceGLSL=i,this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||g.b.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new se.a(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._uniformBuffer=new oe.a(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,this._createUniformBuffer(),n||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),je.OnEventObservable.notifyObservers(this,1))}}je.TriangleFillMode=0,je.WireFrameFillMode=1,je.PointFillMode=2,je.PointListDrawMode=3,je.LineListDrawMode=4,je.LineLoopDrawMode=5,je.LineStripDrawMode=6,je.TriangleStripDrawMode=7,je.TriangleFanDrawMode=8,je.ClockWiseSideOrientation=0,je.CounterClockWiseSideOrientation=1,je.TextureDirtyFlag=1,je.LightDirtyFlag=2,je.FresnelDirtyFlag=4,je.AttributesDirtyFlag=8,je.MiscDirtyFlag=16,je.PrePassDirtyFlag=32,je.AllDirtyFlag=63,je.MATERIAL_OPAQUE=0,je.MATERIAL_ALPHATEST=1,je.MATERIAL_ALPHABLEND=2,je.MATERIAL_ALPHATESTANDBLEND=3,je.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,je.MATERIAL_NORMALBLENDMETHOD_RNM=1,je.OnEventObservable=new _.a,je._AllDirtyCallBack=e=>e.markAllAsDirty(),je._ImageProcessingDirtyCallBack=e=>e.markAsImageProcessingDirty(),je._TextureDirtyCallBack=e=>e.markAsTexturesDirty(),je._FresnelDirtyCallBack=e=>e.markAsFresnelDirty(),je._MiscDirtyCallBack=e=>e.markAsMiscDirty(),je._PrePassDirtyCallBack=e=>e.markAsPrePassDirty(),je._LightsDirtyCallBack=e=>e.markAsLightDirty(),je._AttributeDirtyCallBack=e=>e.markAsAttributesDirty(),je._FresnelAndMiscDirtyCallBack=e=>{je._FresnelDirtyCallBack(e),je._MiscDirtyCallBack(e)},je._TextureAndMiscDirtyCallBack=e=>{je._TextureDirtyCallBack(e),je._MiscDirtyCallBack(e)},je._DirtyCallbackArray=[],je._RunDirtyCallBacks=e=>{for(const t of je._DirtyCallbackArray)t(e)},Object(W.a)([Object(X.c)()],je.prototype,"id",void 0),Object(W.a)([Object(X.c)()],je.prototype,"uniqueId",void 0),Object(W.a)([Object(X.c)()],je.prototype,"name",void 0),Object(W.a)([Object(X.c)()],je.prototype,"metadata",void 0),Object(W.a)([Object(X.c)()],je.prototype,"checkReadyOnEveryCall",void 0),Object(W.a)([Object(X.c)()],je.prototype,"checkReadyOnlyOnce",void 0),Object(W.a)([Object(X.c)()],je.prototype,"state",void 0),Object(W.a)([Object(X.c)("alpha")],je.prototype,"_alpha",void 0),Object(W.a)([Object(X.c)("backFaceCulling")],je.prototype,"_backFaceCulling",void 0),Object(W.a)([Object(X.c)("cullBackFaces")],je.prototype,"_cullBackFaces",void 0),Object(W.a)([Object(X.c)()],je.prototype,"sideOrientation",void 0),Object(W.a)([Object(X.c)("alphaMode")],je.prototype,"_alphaMode",void 0),Object(W.a)([Object(X.c)()],je.prototype,"_needDepthPrePass",void 0),Object(W.a)([Object(X.c)()],je.prototype,"disableDepthWrite",void 0),Object(W.a)([Object(X.c)()],je.prototype,"disableColorWrite",void 0),Object(W.a)([Object(X.c)()],je.prototype,"forceDepthWrite",void 0),Object(W.a)([Object(X.c)()],je.prototype,"depthFunction",void 0),Object(W.a)([Object(X.c)()],je.prototype,"separateCullingPass",void 0),Object(W.a)([Object(X.c)("fogEnabled")],je.prototype,"_fogEnabled",void 0),Object(W.a)([Object(X.c)()],je.prototype,"pointSize",void 0),Object(W.a)([Object(X.c)()],je.prototype,"zOffset",void 0),Object(W.a)([Object(X.c)()],je.prototype,"zOffsetUnits",void 0),Object(W.a)([Object(X.c)()],je.prototype,"pointsCloud",null),Object(W.a)([Object(X.c)()],je.prototype,"fillMode",null),Object(W.a)([Object(X.c)()],je.prototype,"useLogarithmicDepth",null),Object(W.a)([Object(X.c)()],je.prototype,"transparencyMode",null);var ze=n(110),Ke=n(66);const Ye=new RegExp("^([gimus]+)!");class qe{_addPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e.name)return!1;if(this._material._uniformBufferLayoutBuilt&&(this._material.resetDrawCache(),this._material._createUniformBuffer()),!e.isCompatible(this._material.shaderLanguage))throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because the plugin is not compatible with the shader language of the material.`;const t=e.getClassName();qe._MaterialPluginClassToMainDefine[t]||(qe._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++qe._MaterialPluginCounter),this._material._callbackPluginEventGeneric=(e,t)=>this._handlePluginEvent(e,t),this._plugins.push(e),this._plugins.sort((e,t)=>e.priority-t.priority),this._codeInjectionPoints={};const n={};n[qe._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const e of this._plugins)e.collectDefines(n),this._collectPointNames("vertex",e.getCustomCode("vertex",this._material.shaderLanguage)),this._collectPointNames("fragment",e.getCustomCode("fragment",this._material.shaderLanguage));return this._defineNamesFromPlugins=n,!0}_activatePlugin(e){-1===this._activePlugins.indexOf(e)&&(this._activePlugins.push(e),this._activePlugins.sort((e,t)=>e.priority-t.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((e,t)=>e.priority-t.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const n of this._activePlugins)t=t&&n.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const e of this._activePluginsForExtraEvents)if(t=e.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){switch(e){case 512:{const e=t;for(const t of this._activePlugins)t.getActiveTextures(e.activeTextures);break}case 256:{const e=t;for(const t of this._activePlugins)t.getAnimatables(e.animatables);break}case 1024:{const e=t;let n=!1;for(const t of this._activePlugins)if(n=t.hasTexture(e.texture),n)break;e.hasTexture=n;break}case 2:{const e=t;for(const t of this._plugins)t.dispose(e.forceDisposeTextures);break}case 4:t.defineNames=this._defineNamesFromPlugins;break;case 128:{const e=t;for(const t of this._activePlugins)e.fallbackRank=t.addFallbacks(e.defines,e.fallbacks,e.fallbackRank),t.getAttributes(e.attributes,this._scene,e.mesh);this._uniformList.length>0&&e.uniforms.push(...this._uniformList),this._samplerList.length>0&&e.samplers.push(...this._samplerList),this._uboList.length>0&&e.uniformBuffersNames.push(...this._uboList),e.customCode=this._injectCustomCode(e,e.customCode);break}case 8:{const e=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];const i=1===this._material.shaderLanguage;for(const t of this._plugins){const r=t.getUniforms(this._material.shaderLanguage);if(r){if(r.ubo)for(const t of r.ubo){if(t.size&&t.type){var n;const r=null!==(n=t.arraySize)&&void 0!==n?n:0;if(e.ubo.addUniform(t.name,t.size,r),i){let e;switch(t.type){case"mat4":e="mat4x4f";break;case"float":e="f32";break;default:e=t.type+"f"}this._uboDeclaration+=`uniform ${t.name}: ${e}${r>0?`[${r}]`:""};\n`}else this._uboDeclaration+=`${t.type} ${t.name}${r>0?`[${r}]`:""};\n`}this._uniformList.push(t.name)}r.vertex&&(this._vertexDeclaration+=r.vertex+"\n"),r.fragment&&(this._fragmentDeclaration+=r.fragment+"\n")}t.getSamplers(this._samplerList),t.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(const n in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][n]=!0}_injectCustomCode(e,t){return(n,i)=>{var r;t&&(i=t(n,i)),this._uboDeclaration&&(i=i.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(i=i.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(i=i.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const s=null===(r=this._codeInjectionPoints)||void 0===r?void 0:r[n];if(!s)return i;let a=null;for(let t in s){let r="";for(const i of this._activePlugins){var o;let s=null===(o=i.getCustomCode(n,this._material.shaderLanguage))||void 0===o?void 0:o[t];if(s){if(i.resolveIncludes){if(null===a){const t=0;a={defines:[],indexParameters:e.indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:Ke.a.GetShadersRepository(t),includesShadersStore:Ke.a.GetIncludesShadersStore(t),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0}}a.isFragment="fragment"===n,Object(ze.d)(s,a,e=>s=e)}r+=s+"\n"}}if(r.length>0)if("!"===t.charAt(0)){t=t.substring(1);let e="g";if("!"===t.charAt(0))e="",t=t.substring(1);else{const n=Ye.exec(t);n&&n.length>=2&&(e=n[1],t=t.substring(e.length+1))}e.indexOf("g")<0&&(e+="g");const n=i,s=new RegExp(t,e);let a=s.exec(n);for(;null!==a;){let e=r;for(let t=0;t<a.length;++t)e=e.replace("$"+t,a[t]);i=i.replace(a[0],e),a=s.exec(n)}}else{const e="#define "+t;i=i.replace(e,"\n"+r+"\n"+e)}}return i}}constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}}qe._MaterialPluginClassToMainDefine={},qe._MaterialPluginCounter=0,E.a.OnEnginesDisposedObservable.add(()=>{Qe.length=0,Ze=!1,je.OnEventObservable.remove($e),$e=null});const Qe=[];let Ze=!1,$e=null;var Je=n(108);class et{isCompatible(e){switch(e){case 0:return!0;default:return!1}}_enable(e){e&&this._pluginManager._activatePlugin(this)}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,n,i){return!0}hardBindForSubMesh(e,t,n,i){}bindForSubMesh(e,t,n,i){}dispose(e){}getCustomCode(e,t=0){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if("_"===t[0])continue;const n=typeof this._pluginDefineNames[t];e[t]={type:"number"===n?"number":"string"===n?"string":"boolean"===n?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,n){}prepareDefines(e,t,n){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,n){return n}getSamplers(e){}getAttributes(e,t,n){}getUniformBuffersNames(e){}getUniforms(e=0){return{}}copyTo(e){ce.a.Clone(()=>e,this)}serialize(){return ce.a.Serialize(this)}parse(e,t,n){ce.a.Parse(()=>this,e,t,n)}constructor(e,t,n,i,r=!0,s=!1,a=!1){this.priority=500,this.resolveIncludes=!1,this.registerForExtraEvents=!1,this.doNotSerialize=!1,this._material=e,this.name=t,this.priority=n,this.resolveIncludes=a,e.pluginManager||(e.pluginManager=new qe(e),e.onDisposeObservable.add(()=>{e.pluginManager=void 0})),this._pluginDefineNames=i,this._pluginManager=e.pluginManager,r&&this._pluginManager._addPlugin(this),s&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}}Object(W.a)([Object(X.c)()],et.prototype,"name",void 0),Object(W.a)([Object(X.c)()],et.prototype,"priority",void 0),Object(W.a)([Object(X.c)()],et.prototype,"resolveIncludes",void 0),Object(W.a)([Object(X.c)()],et.prototype,"registerForExtraEvents",void 0),Object(Je.b)("BABYLON.MaterialPluginBase",et);class tt extends j{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1,this.MIX_IBL_RADIANCE_WITH_IRRADIANCE=!0}}class nt extends et{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation,e.MIX_IBL_RADIANCE_WITH_IRRADIANCE=this._mixIblRadianceWithIrradiance}getClassName(){return"PBRBRDFConfiguration"}constructor(e,t=!0){super(e,"PBRBRDF",90,new tt,t),this._useEnergyConservation=nt.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=nt.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=nt.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=nt.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=nt.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=nt.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=nt.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=nt.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._mixIblRadianceWithIrradiance=nt.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE,this.mixIblRadianceWithIrradiance=nt.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}}nt.DEFAULT_USE_ENERGY_CONSERVATION=!0,nt.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,nt.DEFAULT_USE_SPHERICAL_HARMONICS=!0,nt.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,nt.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE=!0,Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsMiscDirty")],nt.prototype,"useEnergyConservation",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsMiscDirty")],nt.prototype,"useSmithVisibilityHeightCorrelated",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsMiscDirty")],nt.prototype,"useSphericalHarmonics",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsMiscDirty")],nt.prototype,"useSpecularGlossinessInputEnergyConservation",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsMiscDirty")],nt.prototype,"mixIblRadianceWithIrradiance",void 0);var it=n(395),rt=n(4);const st={preserveDrawingBuffer:!0,stencil:!1};let at;var ot=n(40),lt=n(175),ct=n(319),dt=n(316),ht=n(75),ut=n(333);class ft extends dt.a{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){let e=0,t=0;if(this.mode===ft.PERSPECTIVE_CAMERA)this.fovMode===ft.FOVMODE_VERTICAL_FIXED?(t=2*this.minZ*Math.tan(this.fov/2),e=this.getEngine().getAspectRatio(this)*t):(e=2*this.minZ*Math.tan(this.fov/2),t=e/this.getEngine().getAspectRatio(this));else{var n,i,r,s;const a=this.getEngine().getRenderWidth()/2,o=this.getEngine().getRenderHeight()/2;e=(null!==(n=this.orthoRight)&&void 0!==n?n:a)-(null!==(i=this.orthoLeft)&&void 0!==i?i:-a),t=(null!==(r=this.orthoTop)&&void 0!==r?r:o)-(null!==(s=this.orthoBottom)&&void 0!==s?s:-o)}return e*t}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}get hasMoved(){return this._hasMoved}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}hasStateStored(){return!!this._stateStored}_restoreStateValues(){return!!this._stateStored&&(this.fov=this._storedFov,!0)}restoreState(){return!!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),!0)}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let n=0;n<this.animations.length;n++)t+=", animation[0]: "+this.animations[n].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}isReady(e=!1){if(e)for(const e of this._postProcesses)if(e&&!e.isReady())return!1;return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new r.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new r.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return!!super._isSynchronized()&&this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===ft.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._hasMoved=!1,this._checkInputs(),this.cameraRigMode!==ft.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(null!==this._postProcesses[e])return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let e=0,t=this._rigCameras.length;e<t;e++){const t=this._rigCameras[e],n=t._rigPostProcess;n?("pass"===n.getEffectName()&&(t.isIntermediate=0===this._postProcesses.length),t._postProcesses=this._postProcesses.slice(0).concat(n),n.markTextureDirty()):t._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(T.a.Error("You're trying to reuse a post process not defined as reusable."),0):(null==t||t<0?this._postProcesses.push(e):null===this._postProcesses[t]?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()||this.getViewMatrix(),this._worldMatrix}_getViewMatrix(){return r.a.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()||(this._hasMoved=!0,this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix)),this._computedViewMatrix}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,void 0!==e&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const t=this.getEngine(),n=this.getScene(),i=t.useReverseDepthBuffer;if(this.mode===ft.PERSPECTIVE_CAMERA){let e;this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=t.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1),e=n.useRightHandedSystem?r.a.PerspectiveFovRHToRef:r.a.PerspectiveFovLHToRef,e(this.fov,t.getAspectRatio(this),i?this.maxZ:this.minZ,i?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===ft.FOVMODE_VERTICAL_FIXED,t.isNDCHalfZRange,this.projectionPlaneTilt,i)}else{var s,a,o;const e=t.getRenderWidth()/2,I=t.getRenderHeight()/2;var l,c,d,h,u,f,m,p,g,_,v,E,T,S,A,b;n.useRightHandedSystem?this.oblique?r.a.ObliqueOffCenterRHToRef(null!==(l=this.orthoLeft)&&void 0!==l?l:-e,null!==(c=this.orthoRight)&&void 0!==c?c:e,null!==(d=this.orthoBottom)&&void 0!==d?d:-I,null!==(h=this.orthoTop)&&void 0!==h?h:I,i?this.maxZ:this.minZ,i?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):r.a.OrthoOffCenterRHToRef(null!==(u=this.orthoLeft)&&void 0!==u?u:-e,null!==(f=this.orthoRight)&&void 0!==f?f:e,null!==(m=this.orthoBottom)&&void 0!==m?m:-I,null!==(p=this.orthoTop)&&void 0!==p?p:I,i?this.maxZ:this.minZ,i?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange):this.oblique?r.a.ObliqueOffCenterLHToRef(null!==(g=this.orthoLeft)&&void 0!==g?g:-e,null!==(_=this.orthoRight)&&void 0!==_?_:e,null!==(v=this.orthoBottom)&&void 0!==v?v:-I,null!==(E=this.orthoTop)&&void 0!==E?E:I,i?this.maxZ:this.minZ,i?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):r.a.OrthoOffCenterLHToRef(null!==(T=this.orthoLeft)&&void 0!==T?T:-e,null!==(S=this.orthoRight)&&void 0!==S?S:e,null!==(A=this.orthoBottom)&&void 0!==A?A:-I,null!==(b=this.orthoTop)&&void 0!==b?b:I,i?this.maxZ:this.minZ,i?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=null===(s=this.oblique)||void 0===s?void 0:s.angle,this._cache.obliqueLength=null===(a=this.oblique)||void 0===a?void 0:a.length,this._cache.obliqueOffset=null===(o=this.oblique)||void 0===o?void 0:o.offset,this._cache.renderWidth=t.getRenderWidth(),this._cache.renderHeight=t.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){return(this.radius||(this.target?r.e.Distance(this.position,this.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?ut.a.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=ut.a.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let t=!1;return this.rigCameras.forEach(n=>{n._updateFrustumPlanes(),t=t||e.isInFrustum(n._frustumPlanes)}),t}return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,n){throw Object(ht.a)("Ray")}getForwardRayToRef(e,t=100,n,i){throw Object(ht.a)("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose()}if(this._parentContainer){const e=this._parentContainer.cameras.indexOf(this);e>-1&&this._parentContainer.cameras.splice(e,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==ft.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let e=this._postProcesses.length;for(;--e>=0;){const t=this._postProcesses[e];t&&t.dispose(this)}}let n=this.customRenderTargets.length;for(;--n>=0;)this.customRenderTargets[n].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=g.b.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==ft.RIG_MODE_NONE){const e=this.createRigCamera(this.name+"_L",0);e&&(e._isLeftCamera=!0);const t=this.createRigCamera(this.name+"_R",1);t&&(t._isRightCamera=!0),e&&t&&(this._rigCameras.push(e),this._rigCameras.push(t))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return r.a.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,"interaxialDistance"===e&&(this._cameraRigParams.stereoHalfAngle=g.b.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===ft.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=ce.a.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),ce.a.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const n=ce.a.Clone(ft.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return n.name=e,n.parent=t,this.onClonedObservable.notifyObservers(n),n}getDirection(e){const t=r.e.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){r.e.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,n,i=0,r=!0){return dt.a.Construct(e,t,n,{interaxial_distance:i,isStereoscopicSideBySide:r})||(()=>ft._CreateDefaultParsedCamera(t,n))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const n=e.type,i=ft.GetConstructorFromName(n,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),s=ce.a.Parse(i,e,t);if(void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s.inputs&&(s.inputs.parse(e),s._setupInputs()),e.upVector&&(s.upVector=r.e.FromArray(e.upVector)),s.setPosition&&(s.position.copyFromFloats(0,0,0),s.setPosition(r.e.FromArray(e.position))),e.target&&s.setTarget&&s.setTarget(r.e.FromArray(e.target)),e.cameraRigMode){const t=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};s.setCameraRigMode(e.cameraRigMode,t)}if(e.animations){for(let t=0;t<e.animations.length;t++){const n=e.animations[t],i=Object(Je.a)("BABYLON.Animation");i&&s.animations.push(i.Parse(n))}dt.a.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&s.setEnabled(e.isEnabled),s}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}constructor(e,t,n,i=!0){super(e,n,!1),this._position=r.e.Zero(),this._upVector=r.e.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=ft.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new s.a(0,0,1,1),this.layerMask=268435455,this.fovMode=ft.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=ft.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new _.a,this.onProjectionMatrixChangedObservable=new _.a,this.onAfterCheckInputsObservable=new _.a,this.onRestoreStateObservable=new _.a,this.isRigCamera=!1,this._hasMoved=!1,this._rigCameras=new Array,this._skipRendering=!1,this._projectionMatrix=new r.a,this._postProcesses=new Array,this._activeMeshes=new ct.a(256),this._globalPosition=r.e.Zero(),this._computedViewMatrix=r.a.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=r.a.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=r.b.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),i&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId("Camera "+e)}}ft._CreateDefaultParsedCamera=(e,t)=>{throw Object(ht.a)("UniversalCamera")},ft.PERSPECTIVE_CAMERA=0,ft.ORTHOGRAPHIC_CAMERA=1,ft.FOVMODE_VERTICAL_FIXED=0,ft.FOVMODE_HORIZONTAL_FIXED=1,ft.RIG_MODE_NONE=0,ft.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,ft.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,ft.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,ft.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,ft.RIG_MODE_STEREOSCOPIC_INTERLACED=14,ft.RIG_MODE_VR=20,ft.RIG_MODE_CUSTOM=22,ft.ForceAttachControlToAlwaysPreventDefault=!1,Object(W.a)([Object(X.n)("position")],ft.prototype,"_position",void 0),Object(W.a)([Object(X.n)("upVector")],ft.prototype,"_upVector",void 0),Object(W.a)([Object(X.c)()],ft.prototype,"orthoLeft",null),Object(W.a)([Object(X.c)()],ft.prototype,"orthoRight",null),Object(W.a)([Object(X.c)()],ft.prototype,"orthoBottom",null),Object(W.a)([Object(X.c)()],ft.prototype,"orthoTop",null),Object(W.a)([Object(X.c)()],ft.prototype,"fov",void 0),Object(W.a)([Object(X.c)()],ft.prototype,"projectionPlaneTilt",void 0),Object(W.a)([Object(X.c)()],ft.prototype,"minZ",void 0),Object(W.a)([Object(X.c)()],ft.prototype,"maxZ",void 0),Object(W.a)([Object(X.c)()],ft.prototype,"inertia",void 0),Object(W.a)([Object(X.c)()],ft.prototype,"mode",null),Object(W.a)([Object(X.c)()],ft.prototype,"layerMask",void 0),Object(W.a)([Object(X.c)()],ft.prototype,"fovMode",void 0),Object(W.a)([Object(X.c)()],ft.prototype,"cameraRigMode",void 0),Object(W.a)([Object(X.c)()],ft.prototype,"interaxialDistance",void 0),Object(W.a)([Object(X.c)()],ft.prototype,"isStereoscopicSideBySide",void 0);var mt=n(326);dt.a.AddNodeConstructor("TargetCamera",(e,t)=>()=>new pt(e,r.e.Zero(),t));class pt extends ft{getFrontPosition(e){this.getWorldMatrix();const t=r.c.Vector3[0],n=r.c.Vector3[1];return n.set(0,0,this._scene.useRightHandedSystem?-1:1),this.getDirectionToRef(n,t),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0)}_initCache(){super._initCache(),this._cache.lockedTarget=new r.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new r.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new r.b(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(100*e.getFps()))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=q.a),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),r.a.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&r.b.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent)return this.parent.getWorldMatrix().invertToRef(r.c.Matrix[0]),r.e.TransformNormalToRef(this.cameraDirection,r.c.Matrix[0],r.c.Vector3[0]),this._deferredPositionUpdate.addInPlace(r.c.Vector3[0]),void(this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate));this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),n=this.cameraRotation.x||this.cameraRotation.y;if(this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),n){if(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,!this.noRotationConstraint){const e=1.570796;this._deferredRotationUpdate.x>e&&(this._deferredRotationUpdate.x=e),this._deferredRotationUpdate.x<-e&&(this._deferredRotationUpdate.x=-e)}this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(r.b.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate))}t&&(Math.abs(this.cameraDirection.x)<this.speed*q.a&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*q.a&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*q.a&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),n&&(Math.abs(this.cameraRotation.x)<this.speed*q.a&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*q.a&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):r.a.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return r.e.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),r.e.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?mt.a.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(r.b.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),mt.a.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,n){if(this.ignoreParentScaling){if(this.parent){const i=this.parent.getWorldMatrix();r.e.TransformCoordinatesToRef(e,i,this._globalPosition),r.e.TransformCoordinatesToRef(t,i,this._tmpTargetVector),r.e.TransformNormalToRef(n,i,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(n);this.getScene().useRightHandedSystem?r.a.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):r.a.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix)}else if(this.getScene().useRightHandedSystem?r.a.LookAtRHToRef(e,t,n,this._viewMatrix):r.a.LookAtLHToRef(e,t,n,this._viewMatrix),this.parent){const e=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(e,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==ft.RIG_MODE_NONE){const t=new pt(e,this.position.clone(),this.getScene());return t.isRigCamera=!0,t.rigParent=this,this.cameraRigMode===ft.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new r.b),t._cameraRigParams={},t.rotationQuaternion=new r.b),t.mode=this.mode,t.orthoLeft=this.orthoLeft,t.orthoRight=this.orthoRight,t.orthoTop=this.orthoTop,t.orthoBottom=this.orthoBottom,t}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case ft.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ft.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ft.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case ft.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ft.RIG_MODE_STEREOSCOPIC_INTERLACED:{const n=this.cameraRigMode===ft.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,i=this.cameraRigMode===ft.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*n,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,t);break}case ft.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position)}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,pt._TargetFocalPoint),pt._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const n=pt._TargetFocalPoint.addInPlace(this.position);r.a.TranslationToRef(-n.x,-n.y,-n.z,pt._TargetTransformMatrix),pt._TargetTransformMatrix.multiplyToRef(r.a.RotationAxis(t.upVector,e),pt._RigCamTransformMatrix),r.a.TranslationToRef(n.x,n.y,n.z,pt._TargetTransformMatrix),pt._RigCamTransformMatrix.multiplyToRef(pt._TargetTransformMatrix,pt._RigCamTransformMatrix),r.e.TransformCoordinatesToRef(this.position,pt._RigCamTransformMatrix,t.position),t.setTarget(n)}getClassName(){return"TargetCamera"}constructor(e,t,n,i=!0){super(e,t,n,i),this._tmpUpVector=r.e.Zero(),this._tmpTargetVector=r.e.Zero(),this.cameraDirection=new r.e(0,0,0),this.cameraRotation=new r.d(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new r.b,this.rotation=new r.e(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=r.e.Zero(),this._initialFocalDistance=1,this._viewMatrix=r.a.Zero(),this._camMatrix=r.a.Zero(),this._cameraTransformMatrix=r.a.Zero(),this._cameraRotationMatrix=r.a.Zero(),this._referencePoint=new r.e(0,0,1),this._transformedReferencePoint=r.e.Zero(),this._deferredPositionUpdate=new r.e,this._deferredRotationQuaternionUpdate=new r.b,this._deferredRotationUpdate=new r.e,this._deferredUpdated=!1,this._deferOnly=!1,this._defaultUp=r.e.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}}pt._RigCamTransformMatrix=new r.a,pt._TargetTransformMatrix=new r.a,pt._TargetFocalPoint=new r.e,Object(W.a)([Object(X.c)()],pt.prototype,"ignoreParentScaling",void 0),Object(W.a)([Object(X.c)()],pt.prototype,"updateUpVectorFromRotation",void 0),Object(W.a)([Object(X.n)()],pt.prototype,"rotation",void 0),Object(W.a)([Object(X.c)()],pt.prototype,"speed",void 0),Object(W.a)([Object(X.j)("lockedTargetId")],pt.prototype,"lockedTarget",void 0);class gt extends dt.a{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}transferTexturesToEffect(e,t){return this}_bindLight(e,t,n,i,r=!0){const s=e.toString();let a=!1;if(this._uniformBuffer.bindToEffect(n,"Light"+s),this._renderId!==t.getRenderId()||this._lastUseSpecular!==i||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=i;const e=this.getScaledIntensity();this.transferToEffect(n,s),this.diffuse.scaleToRef(e,he.c.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",he.c.Color3[0],this.range,s),i&&(this.specular.scaleToRef(e,he.c.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",he.c.Color3[1],this.radius,s)),a=!0}if(this.transferTexturesToEffect(n,s),t.shadowsEnabled&&this.shadowEnabled&&r){var o;const e=null!==(o=this.getShadowGenerator(t.activeCamera))&&void 0!==o?o:this.getShadowGenerator();e&&(e.bindShadowLight(s,n),a=!0)}a?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let n=0;n<this.animations.length;n++)t+=", animation[0]: "+this.animations[n].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){var t;return null===this._shadowGenerators?null:null!==(t=this._shadowGenerators.get(e))&&void 0!==t?t:null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return r.e.Zero()}canAffectMesh(e){return!(e&&(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&-1===this.includedOnlyMeshes.indexOf(e)||this.excludedMeshes&&this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)||0!==this.includeOnlyWithLayerMask&&0==(this.includeOnlyWithLayerMask&e.layerMask)||0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&e.layerMask))}dispose(e,t=!1){if(this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const e=this._parentContainer.lights.indexOf(this);e>-1&&this._parentContainer.lights.splice(e,1),this._parentContainer=null}for(const e of this.getScene().meshes)e._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const n=gt.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!n)return null;const i=ce.a.Clone(n,this);return e&&(i.name=e),t&&(i.parent=t),i.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(i),i}serialize(){const e=ce.a.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(t=>{e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(t=>{e.includedOnlyMeshesIds.push(t.id)})),ce.a.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,n){return dt.a.Construct("Light_Type_"+e,t,n)||null}static Parse(e,t){const n=gt.GetConstructorFromName(e.type,e.name,t);if(!n)return null;const i=ce.a.Parse(n,e,t);if(e.excludedMeshesIds&&(i._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(i._includedOnlyMeshesIds=e.includedOnlyMeshesIds),void 0!==e.parentId&&(i._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(i._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.falloffType&&(i.falloffType=e.falloffType),void 0!==e.lightmapMode&&(i.lightmapMode=e.lightmapMode),e.animations){for(let t=0;t<e.animations.length;t++){const n=e.animations[t],r=Object(Je.a)("BABYLON.Animation");r&&i.animations.push(r.Parse(n))}dt.a.ParseAnimationRanges(i,e,t)}return e.autoAnimate&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&i.setEnabled(e.isEnabled),i}_hookArrayForExcluded(e){const t=e.push;e.push=(...n)=>{const i=t.apply(e,n);for(const e of n)e._resyncLightSource(this);return i};const n=e.splice;e.splice=(t,i)=>{const r=n.apply(e,[t,i]);for(const e of r)e._resyncLightSource(this);return r};for(const t of e)t._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...n)=>{const i=t.apply(e,n);return this._resyncMeshes(),i};const n=e.splice;e.splice=(t,i)=>{const r=n.apply(e,[t,i]);return this._resyncMeshes(),r},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)-1!==e.lightSources.indexOf(this)&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let n=this.intensityMode;switch(n===gt.INTENSITYMODE_AUTOMATIC&&(n=t===gt.LIGHTTYPEID_DIRECTIONALLIGHT?gt.INTENSITYMODE_ILLUMINANCE:gt.INTENSITYMODE_LUMINOUSINTENSITY),t){case gt.LIGHTTYPEID_POINTLIGHT:case gt.LIGHTTYPEID_SPOTLIGHT:switch(n){case gt.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case gt.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case gt.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius}break;case gt.LIGHTTYPEID_DIRECTIONALLIGHT:switch(n){case gt.INTENSITYMODE_ILLUMINANCE:e=1;break;case gt.INTENSITYMODE_LUMINANCE:{let t=this.radius;t=Math.max(t,.001),e=2*Math.PI*(1-Math.cos(t));break}}break;case gt.LIGHTTYPEID_HEMISPHERICLIGHT:e=1}return e}_reorderLightsInScene(){const e=this.getScene();0!=this._renderPriority&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}_isReady(){return!0}constructor(e,t){super(e,t,!1),this.diffuse=new he.a(1,1,1),this.specular=new he.a(1,1,1),this.falloffType=gt.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=gt.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new oe.a(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}}gt.FALLOFF_DEFAULT=ue.a.FALLOFF_DEFAULT,gt.FALLOFF_PHYSICAL=ue.a.FALLOFF_PHYSICAL,gt.FALLOFF_GLTF=ue.a.FALLOFF_GLTF,gt.FALLOFF_STANDARD=ue.a.FALLOFF_STANDARD,gt.LIGHTMAP_DEFAULT=ue.a.LIGHTMAP_DEFAULT,gt.LIGHTMAP_SPECULAR=ue.a.LIGHTMAP_SPECULAR,gt.LIGHTMAP_SHADOWSONLY=ue.a.LIGHTMAP_SHADOWSONLY,gt.INTENSITYMODE_AUTOMATIC=ue.a.INTENSITYMODE_AUTOMATIC,gt.INTENSITYMODE_LUMINOUSPOWER=ue.a.INTENSITYMODE_LUMINOUSPOWER,gt.INTENSITYMODE_LUMINOUSINTENSITY=ue.a.INTENSITYMODE_LUMINOUSINTENSITY,gt.INTENSITYMODE_ILLUMINANCE=ue.a.INTENSITYMODE_ILLUMINANCE,gt.INTENSITYMODE_LUMINANCE=ue.a.INTENSITYMODE_LUMINANCE,gt.LIGHTTYPEID_POINTLIGHT=ue.a.LIGHTTYPEID_POINTLIGHT,gt.LIGHTTYPEID_DIRECTIONALLIGHT=ue.a.LIGHTTYPEID_DIRECTIONALLIGHT,gt.LIGHTTYPEID_SPOTLIGHT=ue.a.LIGHTTYPEID_SPOTLIGHT,gt.LIGHTTYPEID_HEMISPHERICLIGHT=ue.a.LIGHTTYPEID_HEMISPHERICLIGHT,gt.LIGHTTYPEID_RECT_AREALIGHT=ue.a.LIGHTTYPEID_RECT_AREALIGHT,Object(W.a)([Object(X.d)()],gt.prototype,"diffuse",void 0),Object(W.a)([Object(X.d)()],gt.prototype,"specular",void 0),Object(W.a)([Object(X.c)()],gt.prototype,"falloffType",void 0),Object(W.a)([Object(X.c)()],gt.prototype,"intensity",void 0),Object(W.a)([Object(X.c)()],gt.prototype,"range",null),Object(W.a)([Object(X.c)()],gt.prototype,"intensityMode",null),Object(W.a)([Object(X.c)()],gt.prototype,"radius",null),Object(W.a)([Object(X.c)()],gt.prototype,"_renderPriority",void 0),Object(W.a)([Object(X.a)("_reorderLightsInScene")],gt.prototype,"renderPriority",void 0),Object(W.a)([Object(X.c)("shadowEnabled")],gt.prototype,"_shadowEnabled",void 0),Object(W.a)([Object(X.c)("excludeWithLayerMask")],gt.prototype,"_excludeWithLayerMask",void 0),Object(W.a)([Object(X.c)("includeOnlyWithLayerMask")],gt.prototype,"_includeOnlyWithLayerMask",void 0),Object(W.a)([Object(X.c)("lightmapMode")],gt.prototype,"_lightmapMode",void 0);class _t extends gt{_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return!(!this.parent||!this.parent.getWorldMatrix||(this.transformedPosition||(this.transformedPosition=r.e.Zero()),r.e.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=r.e.Zero()),r.e.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),0))}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=r.e.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=r.e.Cross(this.direction,mt.a.Y),t=r.e.Cross(e,this.direction);return r.e.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=r.e.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=r.a.Identity()),r.a.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return void 0!==this.shadowMinZ?this.shadowMinZ:(null==e?void 0:e.minZ)||0}getDepthMaxZ(e){return void 0!==this.shadowMaxZ?this.shadowMaxZ:(null==e?void 0:e.maxZ)||1e4}setShadowProjectionMatrix(e,t,n){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,n,e):this._setDefaultShadowProjectionMatrix(e,t,n),this}_syncParentEnabledState(){super._syncParentEnabledState(),this.parent&&this.parent.getWorldMatrix||(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){const t=r.c.Vector3[0];let n=this.position;this.computeTransformedInformation()&&(n=this.transformedPosition),r.e.NormalizeToRef(this.getShadowDirection(e),t),1===Math.abs(r.e.Dot(t,r.e.Up()))&&(t.z=1e-13);const i=r.c.Vector3[1];return n.addToRef(t,i),r.a.LookAtLHToRef(n,i,r.e.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,null!=e?e:this._viewMatrix,null!=t?t:[]),this._projectionMatrix}constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=r.a.Identity(),this._projectionMatrix=r.a.Identity()}}Object(W.a)([Object(X.n)()],_t.prototype,"position",null),Object(W.a)([Object(X.n)()],_t.prototype,"direction",null),Object(W.a)([Object(X.c)()],_t.prototype,"shadowMinZ",null),Object(W.a)([Object(X.c)()],_t.prototype,"shadowMaxZ",null),dt.a.AddNodeConstructor("Light_Type_0",(e,t)=>()=>new vt(e,r.e.Zero(),t));class vt extends _t{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.recreateShadowMap()}}getClassName(){return"PointLight"}getTypeID(){return gt.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new r.e(1,0,0);case 1:return new r.e(-1,0,0);case 2:return new r.e(0,-1,0);case 3:return new r.e(0,1,0);case 4:return new r.e(0,0,1);case 5:return new r.e(0,0,-1)}return r.e.Zero()}_setDefaultShadowProjectionMatrix(e,t,n){const i=this.getScene().activeCamera;if(!i)return;const s=void 0!==this.shadowMinZ?this.shadowMinZ:i.minZ,a=void 0!==this.shadowMaxZ?this.shadowMaxZ:i.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;r.a.PerspectiveFovLHToRef(this.shadowAngle,1,o?a:s,o?s:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,o)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}constructor(e,t,n){super(e,n),this._shadowAngle=Math.PI/2,this.position=t}}Object(W.a)([Object(X.c)()],vt.prototype,"shadowAngle",null),Object(Je.b)("BABYLON.PointLight",vt);var Et=n(314),Tt=n(320),St=n(336);class At extends St.b{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([n.e(0).then(n.bind(null,523)),n.e(0).then(n.bind(null,528))]))):t.push(Promise.all([n.e(0).then(n.bind(null,524)),n.e(0).then(n.bind(null,529))]))}set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this.options.blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this.options.blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}bind(){super.bind(),this._drawWrapper.effect.setFloat2("delta",1/this.textureWidth*this.direction.x,1/this.textureHeight*this.direction.y)}_updateParameters(e,t){const n=this._kernel,i=(n-1)/2;let r=[],s=[],a=0;for(let e=0;e<n;e++){const t=e/(n-1),o=this._gaussianWeight(2*t-1);r[e]=e-i,s[e]=o,a+=o}for(let e=0;e<s.length;e++)s[e]/=a;const o=[],l=[],c=[];for(let e=0;e<=i;e+=2){const t=Math.min(e+1,Math.floor(i));if(e===t)c.push({o:r[e],w:s[e]});else{const n=t===i,a=s[e]+s[t]*(n?.5:1),o=r[e]+1/(1+s[e]/s[t]);0===o?(c.push({o:r[e],w:s[e]}),c.push({o:r[e+1],w:s[e+1]})):(c.push({o:o,w:a}),c.push({o:-o,w:a}))}}for(let e=0;e<c.length;e++)l[e]=c[e].o,o[e]=c[e].w;r=l,s=o;const d=this.options.engine.getCaps().maxVaryingVectors-(1===this.options.shaderLanguage?1:0),h=Math.max(d,0)-1;let u=Math.min(r.length,h),f="";f+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(f+=`#define CENTER_WEIGHT ${this._glslFloat(s[u-1])}\n`,u--);for(let e=0;e<u;e++)f+=`#define KERNEL_OFFSET${e} ${this._glslFloat(r[e])}\n`,f+=`#define KERNEL_WEIGHT${e} ${this._glslFloat(s[e])}\n`;let m=0;for(let e=h;e<r.length;e++)f+=`#define KERNEL_DEP_OFFSET${m} ${this._glslFloat(r[e])}\n`,f+=`#define KERNEL_DEP_WEIGHT${m} ${this._glslFloat(s[e])}\n`,m++;this.packedFloat&&(f+="#define PACKEDFLOAT 1"),this.options.blockCompilation=!1,this.updateEffect(f,null,null,{varyingCount:u,depCount:m},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const e of[t,t-1,t+1,t-2,t+2])if(e%2!=0&&Math.floor(e/2)%2==0&&e>0)return Math.max(e,3);return Math.max(t,3)}_gaussianWeight(e){const t=-e*e/(1/3*2*(1/3));return 1/(Math.sqrt(2*Math.PI)*(1/3))*Math.exp(t)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}constructor(e,t=null,n,i,r){const s=!(null==r||!r.blockCompilation);super({...r,name:e,engine:t||m.a.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:At.FragmentUrl,uniforms:At.Uniforms,samplers:At.Samplers,vertexUrl:At.VertexUrl,blockCompilation:!0}),this._packedFloat=!1,this._staticDefines="",this.textureWidth=0,this.textureHeight=0,this.options.blockCompilation=s,void 0!==n&&(this.direction=n),void 0!==i&&(this.kernel=i)}}At.VertexUrl="kernelBlur",At.FragmentUrl="kernelBlur",At.Uniforms=["delta","direction"],At.Samplers=["circleOfConfusionSampler"];class bt extends Tt.a{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}set kernel(e){this._effectWrapper.kernel=e}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return"BlurPostProcess"}updateEffect(e=null,t=null,n=null,i,r,s){this._effectWrapper._updateParameters(r,s)}static _Parse(e,t,n,i){return ce.a.Parse(()=>new bt(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,n.getEngine(),e.reusable,e.textureType,void 0,!1),e,n,i)}constructor(e,t,n,i,r=null,s=Et.a.BILINEAR_SAMPLINGMODE,a,o,l=0,c="",d=!1,h=5){const u="number"==typeof i?d:!!i.blockCompilation,f={uniforms:At.Uniforms,samplers:At.Samplers,size:"number"==typeof i?i:void 0,camera:r,samplingMode:s,engine:a,reusable:o,textureType:l,vertexUrl:At.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:h,defines:c,...i,blockCompilation:!0};super(e,At.FragmentUrl,{effectWrapper:"number"!=typeof i&&i.effectWrapper?void 0:new At(e,a,void 0,void 0,f),...f}),this._effectWrapper.options.blockCompilation=u,this.direction=t,this.onApplyObservable.add(()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height}),this.kernel=n}}Object(W.a)([Object(X.m)()],bt.prototype,"direction",null),Object(W.a)([Object(X.c)()],bt.prototype,"kernel",null),Object(W.a)([Object(X.c)()],bt.prototype,"packedFloat",null),Object(Je.b)("BABYLON.BlurPostProcess",bt);class It{unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const n=this._mesh.getScene();for(let e=0;e<n.meshes.length;e++){const i=n.meshes[e];if(i.material){if(i.computeBonesUsingShaders&&0!==i.numBoneInfluencers)if(i.material.getEffect()===t)i.computeBonesUsingShaders=!1;else if(i.subMeshes)for(const e of i.subMeshes)if(e.effect===t){i.computeBonesUsingShaders=!1;break}}else!this._mesh.material&&i.computeBonesUsingShaders&&i.numBoneInfluencers>0&&(i.computeBonesUsingShaders=!1)}}else{const t=this._defines[this._currentRank];if(t)for(let n=0;n<t.length;n++)e=e.replace("#define "+t[n],"");this._currentRank++}return e}constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}}var Rt=n(389);class Ct{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===Ct.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(e===Ct.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(e===Ct.FILTER_PCF||e===Ct.FILTER_PCSS)return void(this.usePoissonSampling=!0)}e!==Ct.FILTER_PCF&&e!==Ct.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0}get usePoissonSampling(){return this.filter===Ct.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(Ct.FILTER_POISSONSAMPLING);(e||this.filter===Ct.FILTER_POISSONSAMPLING)&&(this.filter=e?t:Ct.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===Ct.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(Ct.FILTER_EXPONENTIALSHADOWMAP);(e||this.filter===Ct.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=e?t:Ct.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===Ct.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(Ct.FILTER_BLUREXPONENTIALSHADOWMAP);(e||this.filter===Ct.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=e?t:Ct.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===Ct.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(Ct.FILTER_CLOSEEXPONENTIALSHADOWMAP);(e||this.filter===Ct.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:Ct.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===Ct.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(Ct.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(e||this.filter===Ct.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:Ct.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===Ct.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(Ct.FILTER_PCF);(e||this.filter===Ct.FILTER_PCF)&&(this.filter=e?t:Ct.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===Ct.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(Ct.FILTER_PCSS);(e||this.filter===Ct.FILTER_PCSS)&&(this.filter=e?t:Ct.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return this._darkness=e>=1?1:e<=0?0:e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return Ct.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t)for(const t of e.getChildMeshes())-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const n=this._shadowMap.renderList.indexOf(e);if(-1!==n&&this._shadowMap.renderList.splice(n,1),t)for(const t of e.getChildren())this.removeShadowCaster(t);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){var e;return null!==(e=this._camera)&&void 0!==e?e:this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new i.a(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,"DepthStencilForShadowGenerator-"+this._light.name)):this._shadowMap=new i.a(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=Et.a.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=Et.a.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(Et.a.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(e,t,n,i)=>this._renderForShadowMap(e,t,n,i),this._shadowMap.customIsReadyFunction=(e,t,n)=>{if(!n||!e.subMeshes)return!0;let i=!0;for(const t of e.subMeshes){const e=t.getRenderingMesh(),n=this._scene.getEngine(),r=t.getMaterial();if(!r||0===t.verticesCount||this.customAllowRendering&&!this.customAllowRendering(t))continue;const s=e._getInstancesRenderList(t._id,!!t.getReplacementMesh());if(s.mustReturn)continue;const a=n.getCaps().instancedArrays&&(null!==s.visibleInstances[t._id]&&void 0!==s.visibleInstances[t._id]||e.hasThinInstances),o=r.needAlphaBlendingForMesh(e);i=this.isReady(t,a,o)&&i}return i};const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),null===(t=e._debugPushGroup)||void 0===t||t.call(e,"shadow map generation for pass id "+e.currentRenderPassId,1)}),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=t,this._filter===Ct.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{var t,n;if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===Ct.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void(null===(n=e._debugPopGroup)||void 0===n||n.call(e,1));const i=this.getShadowMapForRendering();i&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,i.renderTarget,!0),e.unBindFramebuffer(i.renderTarget,!0)),null===(t=e._debugPopGroup)||void 0===t||t.call(e,1)});const t=new he.b(0,0,0,0),n=new he.b(1,1,1,1);this._shadowMap.onClearObservable.add(e=>{this._filter===Ct.FILTER_PCF?e.clear(n,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e.clear(t,!0,!0,!1):e.clear(n,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(e=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=e.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let e=Rt.a.MIN_RENDERINGGROUPS;e<Rt.a.MAX_RENDERINGGROUPS;e++)this._shadowMap.setRenderingAutoClearDepthStencil(e,!1)}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||Ct.ForceGLSL?await Promise.all([n.e(0).then(n.bind(null,521)),n.e(0).then(n.bind(null,518)),n.e(0).then(n.bind(null,508)),n.e(0).then(n.bind(null,509))]):(this._shaderLanguage=1,await Promise.all([n.e(0).then(n.bind(null,519)),n.e(0).then(n.bind(null,520)),n.e(0).then(n.bind(null,506)),n.e(0).then(n.bind(null,507))])),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new i.a(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=Et.a.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=Et.a.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(Et.a.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new bt(this._light.name+"KernelBlurX",new r.d(1,0),this.blurKernel,1,null,Et.a.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(e=>{e.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new bt(this._light.name+"KernelBlurY",new r.d(0,1),this.blurKernel,1,null,Et.a.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new Tt.a(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,Et.a.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(e=>{e.setFloat2("screenSize",t,t),e.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,n,i){let r;if(i.length)for(r=0;r<i.length;r++)this._renderSubMeshForShadowMap(i.data[r]);for(r=0;r<e.length;r++)this._renderSubMeshForShadowMap(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMeshForShadowMap(t.data[r]);if(this._transparencyShadow)for(r=0;r<n.length;r++)this._renderSubMeshForShadowMap(n.data[r],!0);else for(r=0;r<n.length;r++)n.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,n){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){const n=e.getRenderingMesh(),i=e.getEffectiveMesh(),r=this._scene,s=r.getEngine(),a=e.getMaterial();if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!a||0===e.verticesCount||e._renderId===r.getRenderId())return;const o=r.useRightHandedSystem,l=i._getWorldMatrixDeterminant()<0;let c=a._getEffectiveOrientation(n);(l&&!o||!l&&o)&&(c=0===c?1:0);const d=0===c;s.setState(a.backFaceCulling,void 0,void 0,d,a.cullBackFaces);const h=n._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(h.mustReturn)return;const u=s.getCaps().instancedArrays&&(null!==h.visibleInstances[e._id]&&void 0!==h.visibleInstances[e._id]||n.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e))if(this.isReady(e,u,t)){var f;e._renderId=r.getRenderId();const o=a.shadowDepthWrapper,l=null!==(f=null==o?void 0:o.getEffect(e,this,s.currentRenderPassId))&&void 0!==f?f:e._getDrawWrapper(),c=se.a.GetEffect(l);s.enableEffect(l),u||n._bind(e,c,a.fillMode),this.getTransformMatrix(),c.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===gt.LIGHTTYPEID_DIRECTIONALLIGHT?c.setVector3("lightDataSM",this._cachedDirection):c.setVector3("lightDataSM",this._cachedPosition);const d=this._getCamera();var m;if(c.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(d),this.getLight().getDepthMinZ(d)+this.getLight().getDepthMaxZ(d)),t&&this.enableSoftTransparentShadow&&c.setFloat2("softTransparentShadowSM",i.visibility*a.alpha,null!==(m=this._opacityTexture)&&void 0!==m&&m.getAlphaFromRGB?1:0),o)e._setMainDrawWrapperOverride(l),o.standalone?o.baseMaterial.bindForSubMesh(i.getWorldMatrix(),n,e):a.bindForSubMesh(i.getWorldMatrix(),n,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(c.setTexture("diffuseSampler",this._opacityTexture),c.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),n.useBones&&n.computeBonesUsingShaders&&n.skeleton){const e=n.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(n);if(!t)return;c.setTexture("boneSampler",t),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",e.getTransformMatrices(n))}Ie(n,c),n.morphTargetManager&&n.morphTargetManager.isUsingTextureForTargets&&n.morphTargetManager._bind(c);const t=e.getMesh().bakedVertexAnimationManager;t&&t.isEnabled&&t.bind(c,u),pe(c,a,r)}this._useUBO||o||this._bindCustomEffectForRenderSubMeshForShadowMap(e,c,i),Re(c,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const p=i.getWorldMatrix();u&&(i.getMeshUniformBuffer().bindToEffect(c,"Mesh"),i.transferToEffect(p)),this.forceBackFacesOnly&&s.setState(!0,0,!1,!0,a.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(n),this.onBeforeShadowMapRenderObservable.notifyObservers(c),n._processRendering(i,e,c,a.fillMode,h,u,(e,t)=>{i===n||e?(i.getMeshUniformBuffer().bindToEffect(c,"Mesh"),i.transferToEffect(e?t:p)):(n.getMeshUniformBuffer().bindToEffect(c,"Mesh"),n.transferToEffect(t))}),this.forceBackFacesOnly&&s.setState(!0,0,!1,!1,a.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(c),this.onAfterShadowMapRenderMeshObservable.notifyObservers(n)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===Ct.FILTER_NONE||this.filter===Ct.FILTER_PCSS?this._shadowMap.updateSamplingMode(Et.a.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(Et.a.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const n={useInstances:!1,...t},i=this.getShadowMap();if(!i)return void(e&&e(this));const r=i.renderList;if(!r)return void(e&&e(this));const s=[];for(const e of r)s.push(...e.subMeshes);if(0===s.length)return void(e&&e(this));let a=0;const o=()=>{if(this._scene&&this._scene.getEngine()){for(;this.isReady(s[a],n.useInstances,null!==(t=null===(i=s[a].getMaterial())||void 0===i?void 0:i.needAlphaBlendingForMesh(s[a].getMesh()))&&void 0!==t&&t);){var t,i;if(a++,a>=s.length)return void(e&&e(this))}setTimeout(o,16)}};o()}forceCompilationAsync(e){return new Promise(t=>{this.forceCompilation(()=>{t()},e)})}_isReadyCustomDefines(e,t,n){}_prepareShadowDefines(e,t,n,i){n.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),n.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),n.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),n.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const r=e.getMesh();return n.push("#define SM_NORMALBIAS "+(this.normalBias&&r.isVerticesDataPresent(z.b.NormalKind)?"1":"0")),n.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===gt.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),n.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),n.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&i?"1":"0")),this._isReadyCustomDefines(n,e,t),n}isReady(e,t,n){if(!this._shadersLoaded)return!1;const i=e.getMaterial(),r=null==i?void 0:i.shadowDepthWrapper;if(this._opacityTexture=null,!i)return!1;const s=[];if(this._prepareShadowDefines(e,t,s,n),r){if(!r.isReadyForSubMesh(e,s,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const n=e._getDrawWrapper(void 0,!0);let r=n.effect,o=n.defines;const l=[z.b.PositionKind],c=e.getMesh();let d=!1,h=!1,u=!1;const f=!1;this.normalBias&&c.isVerticesDataPresent(z.b.NormalKind)&&(l.push(z.b.NormalKind),s.push("#define NORMAL"),d=!0,c.nonUniformScaling&&s.push("#define NONUNIFORMSCALING"));const m=i.needAlphaTestingForMesh(c);if((m||i.needAlphaBlendingForMesh(c))&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=i.opacityTexture:this._opacityTexture=i.getAlphaTestTexture(),this._opacityTexture)){var a;if(!this._opacityTexture.isReady())return!1;const e=null!==(a=i.alphaCutOff)&&void 0!==a?a:Ct.DEFAULT_ALPHA_CUTOFF;s.push("#define ALPHATEXTURE"),m&&s.push(`#define ALPHATESTVALUE ${e}${e%1==0?".":""}`),c.isVerticesDataPresent(z.b.UVKind)&&(l.push(z.b.UVKind),s.push("#define UV1"),h=!0),c.isVerticesDataPresent(z.b.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(l.push(z.b.UV2Kind),s.push("#define UV2"),u=!0)}const p=new It;if(c.useBones&&c.computeBonesUsingShaders&&c.skeleton){l.push(z.b.MatricesIndicesKind),l.push(z.b.MatricesWeightsKind),c.numBoneInfluencers>4&&(l.push(z.b.MatricesIndicesExtraKind),l.push(z.b.MatricesWeightsExtraKind));const e=c.skeleton;s.push("#define NUM_BONE_INFLUENCERS "+c.numBoneInfluencers),c.numBoneInfluencers>0&&p.addCPUSkinningFallback(0,c),e.isUsingTextureForMatrices?s.push("#define BONETEXTURE"):s.push("#define BonesPerMesh "+(e.bones.length+1))}else s.push("#define NUM_BONE_INFLUENCERS 0");const g=c.morphTargetManager?Se(c.morphTargetManager,s,l,c,!0,d,!1,h,u,f):0;if(me(i,this._scene,s),t&&(s.push("#define INSTANCES"),be(l),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const e of this.customShaderOptions.defines)-1===s.indexOf(e)&&s.push(e);const _=c.bakedVertexAnimationManager;_&&_.isEnabled&&(s.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&l.push("bakedVertexAnimationSettingsInstanced"));const v=s.join("\n");if(o!==v){o=v;let e="shadowMap";const t=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],i=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],s=["Scene","Mesh"];if(fe(t),this.customShaderOptions){if(e=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const e of this.customShaderOptions.attributes)-1===l.indexOf(e)&&l.push(e);if(this.customShaderOptions.uniforms)for(const e of this.customShaderOptions.uniforms)-1===t.indexOf(e)&&t.push(e);if(this.customShaderOptions.samplers)for(const e of this.customShaderOptions.samplers)-1===i.indexOf(e)&&i.push(e)}const a=this._scene.getEngine();r=a.createEffect(e,{attributes:l,uniformsNames:t,uniformBuffersNames:s,samplers:i,defines:v,fallbacks:p,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:g},shaderLanguage:this._shaderLanguage},a),n.setEffect(r,o)}if(!r.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(this._blurPostProcesses&&this._blurPostProcesses.length||this._initializeBlurRTTAndPostProcesses()),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){const n=this._scene,i=this._light;n.shadowsEnabled&&i.shadowEnabled&&(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===Ct.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===Ct.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===Ct.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===Ct.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),i.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const n=this._light;if(!this._scene.shadowsEnabled||!n.shadowEnabled)return;const i=this._getCamera(),r=this.getShadowMap();if(!r)return;n.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix());const s=this.getShadowMapForRendering();this._filter===Ct.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,s),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),r.getSize().width,1/r.getSize().width,this.frustumEdgeFalloff,e)):this._filter===Ct.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,s),t.setTexture("depthTexture"+e,s),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/r.getSize().width,this._contactHardeningLightSizeUVRatio*r.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,s),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/r.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),n._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(i),this.getLight().getDepthMinZ(i)+this.getLight().getDepthMaxZ(i),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),r.e.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(r.e.Dot(this._lightDirection,r.e.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),r.a.LookAtLHToRef(t,t.add(this._lightDirection),r.e.Up(),this._viewMatrix);const e=this.getShadowMap();if(e){const t=e.renderList;t&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,t)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const e of t)this._shadowMap.renderList.push(e)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();!0!==t.done;t=e.next()){const[e,n]=t.value;n===this&&this._light._shadowGenerators.delete(e)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){var e;const t={},n=this.getShadowMap();if(!n)return t;if(t.className=this.getClassName(),t.lightId=this._light.id,t.cameraId=null===(e=this._camera)||void 0===e?void 0:e.id,t.id=this.id,t.mapSize=n.getRenderSize(),t.forceBackFacesOnly=this.forceBackFacesOnly,t.darkness=this.getDarkness(),t.transparencyShadow=this._transparencyShadow,t.frustumEdgeFalloff=this.frustumEdgeFalloff,t.bias=this.bias,t.normalBias=this.normalBias,t.usePercentageCloserFiltering=this.usePercentageCloserFiltering,t.useContactHardeningShadow=this.useContactHardeningShadow,t.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,t.filteringQuality=this.filteringQuality,t.useExponentialShadowMap=this.useExponentialShadowMap,t.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,t.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.usePoissonSampling=this.usePoissonSampling,t.depthScale=this.depthScale,t.blurBoxOffset=this.blurBoxOffset,t.blurKernel=this.blurKernel,t.blurScale=this.blurScale,t.useKernelBlur=this.useKernelBlur,t.renderList=[],n.renderList)for(let e=0;e<n.renderList.length;e++){const i=n.renderList[e];t.renderList.push(i.id)}return t}static Parse(e,t,n){const i=t.getLightById(e.lightId),r=void 0!==e.cameraId?t.getCameraById(e.cameraId):null,s=n?n(e.mapSize,i,r):new Ct(e.mapSize,i,void 0,r),a=s.getShadowMap();for(let n=0;n<e.renderList.length;n++)t.getMeshesById(e.renderList[n]).forEach((function(e){a&&(a.renderList||(a.renderList=[]),a.renderList.push(e))}));return void 0!==e.id&&(s.id=e.id),s.forceBackFacesOnly=!!e.forceBackFacesOnly,void 0!==e.darkness&&s.setDarkness(e.darkness),e.transparencyShadow&&s.setTransparencyShadow(!0),void 0!==e.frustumEdgeFalloff&&(s.frustumEdgeFalloff=e.frustumEdgeFalloff),void 0!==e.bias&&(s.bias=e.bias),void 0!==e.normalBias&&(s.normalBias=e.normalBias),e.usePercentageCloserFiltering?s.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?s.useContactHardeningShadow=!0:e.usePoissonSampling?s.usePoissonSampling=!0:e.useExponentialShadowMap?s.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?s.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?s.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?s.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?s.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(s.useBlurExponentialShadowMap=!0),void 0!==e.contactHardeningLightSizeUVRatio&&(s.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),void 0!==e.filteringQuality&&(s.filteringQuality=e.filteringQuality),e.depthScale&&(s.depthScale=e.depthScale),e.blurScale&&(s.blurScale=e.blurScale),e.blurBoxOffset&&(s.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(s.useKernelBlur=e.useKernelBlur),e.blurKernel&&(s.blurKernel=e.blurKernel),s}constructor(e,t,n,i,s,a=!1){this.onBeforeShadowMapRenderObservable=new _.a,this.onAfterShadowMapRenderObservable=new _.a,this.onBeforeShadowMapRenderMeshObservable=new _.a,this.onAfterShadowMapRenderMeshObservable=new _.a,this.doNotSerialize=!1,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=Ct.FILTER_NONE,this._filteringQuality=Ct.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=r.e.Zero(),this._viewMatrix=r.a.Zero(),this._projectionMatrix=r.a.Zero(),this._transformMatrix=r.a.Zero(),this._cachedPosition=new r.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new r.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=r.a.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=null!=i?i:null,this._useRedTextureType=!!s,this._initShaderSourceAsync(a);let o=t._shadowGenerators;o||(o=t._shadowGenerators=new Map),o.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),Ct._SceneComponentInitialization(this._scene);const l=this._scene.getEngine().getCaps();n?l.textureFloatRender&&l.textureFloatLinearFiltering?this._textureType=1:l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering?this._textureType=2:l.textureFloatRender&&l.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}}Ct.CLASSNAME="ShadowGenerator",Ct.ForceGLSL=!1,Ct.FILTER_NONE=0,Ct.FILTER_EXPONENTIALSHADOWMAP=1,Ct.FILTER_POISSONSAMPLING=2,Ct.FILTER_BLUREXPONENTIALSHADOWMAP=3,Ct.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,Ct.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,Ct.FILTER_PCF=6,Ct.FILTER_PCSS=7,Ct.QUALITY_HIGH=0,Ct.QUALITY_MEDIUM=1,Ct.QUALITY_LOW=2,Ct.DEFAULT_ALPHA_CUTOFF=.5,Ct._SceneComponentInitialization=e=>{throw Object(ht.a)("ShadowGeneratorSceneComponent")};var yt=n(332);n(487);class Mt extends yt.a{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(r.a.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,n){let i="";return e.forEach(e=>i+=e),new Mt(i,t,null,n,e)}static CreateFromPrefilteredData(e,t,n=null,i=!0){const r=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const s=new Mt(e,t,null,!1,null,null,null,void 0,!0,n,i);return t.useDelayedTextureLoading=r,s}getClassName(){return"CubeTexture"}updateURL(e,t=null,n=null,i=!1,r=null,s=null,a=!1,o=null,l=null){this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,t&&(this._forcedExtension=t);const c=e.lastIndexOf("."),d=t||(c>-1?e.substring(c).toLowerCase():""),h=0===d.indexOf(".dds"),u=0===d.indexOf(".env"),f=0===d.indexOf(".basis");if(u?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=i,i&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),o)this._files=o;else if(f||u||h||s||(s=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,s){for(let t=0;t<s.length;t++)this._files.push(e+s[t]);this._extensions=s}this._buffer=l,a?(this.delayLoadState=4,this._delayedOnLoad=n,this._delayedOnError=r):this._loadTexture(n,r)}delayLoad(e){4===this.delayLoadState&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t,n;if(e.updateFlag===this._textureMatrix.updateFlag)return;if(e.isIdentity()!==this._textureMatrix.isIdentity()&&(null===(n=this.getScene())||void 0===n||n.markAllMaterialsAsDirty(1,e=>-1!==e.getActiveTextures().indexOf(this))),this._textureMatrix=e,null===(t=this.getScene())||void 0===t||!t.useRightHandedSystem)return;const i=r.c.Vector3[0],s=r.c.Quaternion[0],a=r.c.Vector3[1];this._textureMatrix.decompose(i,s,a),s.z*=-1,s.w*=-1,r.a.ComposeToRef(i,s,a,this._textureMatrixRefraction)}getRefractionTextureMatrix(){var e;return null!==(e=this.getScene())&&void 0!==e&&e.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){const n=this.getScene(),i=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const r=()=>{var t;this.onLoadObservable.notifyObservers(this),i&&(i.dispose(),null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1)),e&&e()},s=(e,n)=>{this._loadingError=!0,this._errorObject={message:e,exception:n},t&&t(e,n),Et.a.OnTextureLoadErrorObservable.notifyObservers(this)};var a;this._texture?this._texture.isReady?g.b.SetImmediate(()=>r()):this._texture.onLoadedObservable.add(()=>r()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,n,this._lodScale,this._lodOffset,e,s,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,n,this._files,this._noMipmap,e,s,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),null===(a=this._texture)||void 0===a||a.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,n){const i=ce.a.Parse(()=>{var i;let r=!1;return e.prefiltered&&(r=e.prefiltered),new Mt(n+(null!==(i=e.url)&&void 0!==i?i:e.name),t,e.extensions,!1,e.files||null,null,null,void 0,r,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(i.boundingBoxPosition=r.e.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(i.boundingBoxSize=r.e.FromArray(e.boundingBoxSize)),e.animations)for(let t=0;t<e.animations.length;t++){const n=e.animations[t],r=Object(Je.a)("BABYLON.Animation");r&&i.animations.push(r.Parse(n))}return i}clone(){let e=0;const t=ce.a.Clone(()=>{const t=new Mt(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=t.uniqueId,t},this);return t.uniqueId=e,t}constructor(e,t,n=null,i=!1,s=null,a=null,o=null,l=5,c=!1,d=null,h=!1,u=.8,f=0,m,p){var g;super(t),this.onLoadObservable=new _.a,this.boundingBoxPosition=r.e.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new r.a,this._buffer=null,this.name=e,this.url=e,this._noMipmap=i,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=r.a.Identity(),this.coordinatesMode=Et.a.CUBIC_MODE;let v=null,E=null;var T,S,A,b,I,R,C,y,M,O,x,D;null===n||Array.isArray(n)?(this._noMipmap=i,this._format=l,this._createPolynomials=h,v=n,this._loaderOptions=m,this._useSRGBBuffer=p,this._lodScale=u,this._lodOffset=f):(v=null!==(T=n.extensions)&&void 0!==T?T:null,this._noMipmap=null!==(S=n.noMipmap)&&void 0!==S&&S,s=null!==(A=n.files)&&void 0!==A?A:null,E=null!==(b=n.buffer)&&void 0!==b?b:null,this._format=null!==(I=n.format)&&void 0!==I?I:5,c=null!==(R=n.prefiltered)&&void 0!==R&&R,d=null!==(C=n.forcedExtension)&&void 0!==C?C:null,this._createPolynomials=null!==(y=n.createPolynomials)&&void 0!==y&&y,this._lodScale=null!==(M=n.lodScale)&&void 0!==M?M:.8,this._lodOffset=null!==(O=n.lodOffset)&&void 0!==O?O:0,this._loaderOptions=n.loaderOptions,this._useSRGBBuffer=n.useSRGBBuffer,a=null!==(x=n.onLoad)&&void 0!==x?x:null,o=null!==(D=n.onError)&&void 0!==D?D:null),(e||s)&&this.updateURL(e,d,a,c,o,v,null===(g=this.getScene())||void 0===g?void 0:g.useDelayedTextureLoading,s,E)}}Object(W.a)([Object(X.c)()],Mt.prototype,"url",void 0),Object(W.a)([Object(X.n)()],Mt.prototype,"boundingBoxPosition",void 0),Object(W.a)([Object(X.n)()],Mt.prototype,"boundingBoxSize",null),Object(W.a)([Object(X.c)("rotationY")],Mt.prototype,"rotationY",null),Object(W.a)([Object(X.c)("files")],Mt.prototype,"_files",void 0),Object(W.a)([Object(X.c)("forcedExtension")],Mt.prototype,"_forcedExtension",void 0),Object(W.a)([Object(X.c)("extensions")],Mt.prototype,"_extensions",void 0),Object(W.a)([Object(X.i)("textureMatrix")],Mt.prototype,"_textureMatrix",void 0),Object(W.a)([Object(X.i)("textureMatrixRefraction")],Mt.prototype,"_textureMatrixRefraction",void 0),Et.a._CubeTextureParser=Mt.Parse,Object(Je.b)("BABYLON.CubeTexture",Mt);var Ot=n(338),xt=n(325);function Dt(e,t,n){try{const i=e.next();i.done?t(i):i.value?i.value.then(()=>{i.value=void 0,t(i)},n):t(i)}catch(e){n(e)}}function Pt(e,t,n,i,r){const s=()=>{let a;const o=e=>{e.done?n(e.value):void 0===a?a=!0:s()};do{a=void 0,r&&r.aborted?i(new Error("Aborted")):t(e,o,i),void 0===a&&(a=!1)}while(a)};s()}function Lt(e,t){let n;return Pt(e,Dt,e=>n=e,e=>{throw e},t),n}class Nt{}class Ft{set(e,t){switch(e.length||T.a.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case z.b.PositionKind:this.positions=e;break;case z.b.NormalKind:this.normals=e;break;case z.b.TangentKind:this.tangents=e;break;case z.b.UVKind:this.uvs=e;break;case z.b.UV2Kind:this.uvs2=e;break;case z.b.UV3Kind:this.uvs3=e;break;case z.b.UV4Kind:this.uvs4=e;break;case z.b.UV5Kind:this.uvs5=e;break;case z.b.UV6Kind:this.uvs6=e;break;case z.b.ColorKind:this.colors=e;break;case z.b.MatricesIndicesKind:this.matricesIndices=e;break;case z.b.MatricesWeightsKind:this.matricesWeights=e;break;case z.b.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case z.b.MatricesWeightsExtraKind:this.matricesWeightsExtra=e}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,n){if(this.positions&&(e.setVerticesData(z.b.PositionKind,this.positions,t),n&&(yield)),this.normals&&(e.setVerticesData(z.b.NormalKind,this.normals,t),n&&(yield)),this.tangents&&(e.setVerticesData(z.b.TangentKind,this.tangents,t),n&&(yield)),this.uvs&&(e.setVerticesData(z.b.UVKind,this.uvs,t),n&&(yield)),this.uvs2&&(e.setVerticesData(z.b.UV2Kind,this.uvs2,t),n&&(yield)),this.uvs3&&(e.setVerticesData(z.b.UV3Kind,this.uvs3,t),n&&(yield)),this.uvs4&&(e.setVerticesData(z.b.UV4Kind,this.uvs4,t),n&&(yield)),this.uvs5&&(e.setVerticesData(z.b.UV5Kind,this.uvs5,t),n&&(yield)),this.uvs6&&(e.setVerticesData(z.b.UV6Kind,this.uvs6,t),n&&(yield)),this.colors&&(e.setVerticesData(z.b.ColorKind,this.colors,t),this.hasVertexAlpha&&void 0!==e.hasVertexAlpha&&(e.hasVertexAlpha=!0),n&&(yield)),this.matricesIndices&&(e.setVerticesData(z.b.MatricesIndicesKind,this.matricesIndices,t),n&&(yield)),this.matricesWeights&&(e.setVerticesData(z.b.MatricesWeightsKind,this.matricesWeights,t),n&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(z.b.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),n&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(z.b.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),n&&(yield)),this.indices?(e.setIndices(this.indices,null,t),n&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){const t=e;t.subMeshes=[];for(const e of this.materialInfos)new ae(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,t)}return this}_update(e,t,n){return this.positions&&e.updateVerticesData(z.b.PositionKind,this.positions,t,n),this.normals&&e.updateVerticesData(z.b.NormalKind,this.normals,t,n),this.tangents&&e.updateVerticesData(z.b.TangentKind,this.tangents,t,n),this.uvs&&e.updateVerticesData(z.b.UVKind,this.uvs,t,n),this.uvs2&&e.updateVerticesData(z.b.UV2Kind,this.uvs2,t,n),this.uvs3&&e.updateVerticesData(z.b.UV3Kind,this.uvs3,t,n),this.uvs4&&e.updateVerticesData(z.b.UV4Kind,this.uvs4,t,n),this.uvs5&&e.updateVerticesData(z.b.UV5Kind,this.uvs5,t,n),this.uvs6&&e.updateVerticesData(z.b.UV6Kind,this.uvs6,t,n),this.colors&&e.updateVerticesData(z.b.ColorKind,this.colors,t,n),this.matricesIndices&&e.updateVerticesData(z.b.MatricesIndicesKind,this.matricesIndices,t,n),this.matricesWeights&&e.updateVerticesData(z.b.MatricesWeightsKind,this.matricesWeights,t,n),this.matricesIndicesExtra&&e.updateVerticesData(z.b.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,n),this.matricesWeightsExtra&&e.updateVerticesData(z.b.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,n),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,n=0,i=e.length){const s=r.c.Vector3[0],a=r.c.Vector3[1];for(let o=n;o<n+i;o+=3)r.e.FromArrayToRef(e,o,s),r.e.TransformCoordinatesToRef(s,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector3Normals(e,t,n=0,i=e.length){const s=r.c.Vector3[0],a=r.c.Vector3[1];for(let o=n;o<n+i;o+=3)r.e.FromArrayToRef(e,o,s),r.e.TransformNormalToRef(s,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector4Normals(e,t,n=0,i=e.length){const s=r.c.Vector4[0],a=r.c.Vector4[1];for(let o=n;o<n+i;o+=4)r.f.FromArrayToRef(e,o,s),r.f.TransformNormalToRef(s,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z,e[o+3]=a.w}static _FlipFaces(e,t=0,n=e.length){for(let i=t;i<t+n;i+=3){const t=e[i+1];e[i+1]=e[i+2],e[i+2]=t}}transform(e){const t=e.determinant()<0;return this.positions&&Ft._TransformVector3Coordinates(this.positions,e),this.normals&&Ft._TransformVector3Normals(this.normals,e),this.tangents&&Ft._TransformVector4Normals(this.tangents,e),t&&this.indices&&Ft._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];const e=[];for(const t of this.materialInfos){const n=new Ft;if(this.positions&&(n.positions=this.positions.slice(3*t.verticesStart,3*(t.verticesCount+t.verticesStart))),this.normals&&(n.normals=this.normals.slice(3*t.verticesStart,3*(t.verticesCount+t.verticesStart))),this.tangents&&(n.tangents=this.tangents.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.colors&&(n.colors=this.colors.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.uvs&&(n.uvs=this.uvs.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs2&&(n.uvs2=this.uvs2.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs3&&(n.uvs3=this.uvs3.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs4&&(n.uvs4=this.uvs4.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs5&&(n.uvs5=this.uvs5.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs6&&(n.uvs6=this.uvs6.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.matricesIndices&&(n.matricesIndices=this.matricesIndices.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesIndicesExtra&&(n.matricesIndicesExtra=this.matricesIndicesExtra.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesWeights&&(n.matricesWeights=this.matricesWeights.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesWeightsExtra&&(n.matricesWeightsExtra=this.matricesWeightsExtra.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.indices){n.indices=[];for(let e=t.indexStart;e<t.indexStart+t.indexCount;e++)n.indices.push(this.indices[e]-t.verticesStart)}const i=new Nt;i.indexStart=0,i.indexCount=n.indices?n.indices.length:0,i.materialIndex=t.materialIndex,i.verticesStart=0,i.verticesCount=(n.positions?n.positions.length:0)/3,n.materialInfos=[i],e.push(n)}return e}merge(e,t=!1,n=!1,i=!1,r=!1){const s=Array.isArray(e)?e.map(e=>({vertexData:e})):[{vertexData:e}];return Lt(this._mergeCoroutine(void 0,s,t,!1,n,i,r))}*_mergeCoroutine(e,t,n=!1,i,r,s=!1,a=!1){var o,l,c;this._validate();let d=t.map(e=>e.vertexData),h=this;if(a)for(const e of d)e&&(e._validate(),!this.normals&&e.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&e.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&e.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&e.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&e.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&e.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&e.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&e.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&e.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&e.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&e.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&e.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&e.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(const e of d)if(e)if(a)this.normals&&!e.normals&&(e.normals=new Float32Array(e.positions.length)),this.tangents&&!e.tangents&&(e.tangents=new Float32Array(e.positions.length/3*4)),this.uvs&&!e.uvs&&(e.uvs=new Float32Array(e.positions.length/3*2)),this.uvs2&&!e.uvs2&&(e.uvs2=new Float32Array(e.positions.length/3*2)),this.uvs3&&!e.uvs3&&(e.uvs3=new Float32Array(e.positions.length/3*2)),this.uvs4&&!e.uvs4&&(e.uvs4=new Float32Array(e.positions.length/3*2)),this.uvs5&&!e.uvs5&&(e.uvs5=new Float32Array(e.positions.length/3*2)),this.uvs6&&!e.uvs6&&(e.uvs6=new Float32Array(e.positions.length/3*2)),this.colors&&!e.colors&&(e.colors=new Float32Array(e.positions.length/3*4),e.colors.fill(1)),this.matricesIndices&&!e.matricesIndices&&(e.matricesIndices=new Float32Array(e.positions.length/3*4)),this.matricesWeights&&!e.matricesWeights&&(e.matricesWeights=new Float32Array(e.positions.length/3*4)),this.matricesIndicesExtra&&!e.matricesIndicesExtra&&(e.matricesIndicesExtra=new Float32Array(e.positions.length/3*4)),this.matricesWeightsExtra&&!e.matricesWeightsExtra&&(e.matricesWeightsExtra=new Float32Array(e.positions.length/3*4));else if(e._validate(),!this.normals!=!e.normals||!this.tangents!=!e.tangents||!this.uvs!=!e.uvs||!this.uvs2!=!e.uvs2||!this.uvs3!=!e.uvs3||!this.uvs4!=!e.uvs4||!this.uvs5!=!e.uvs5||!this.uvs6!=!e.uvs6||!this.colors!=!e.colors||!this.matricesIndices!=!e.matricesIndices||!this.matricesWeights!=!e.matricesWeights||!this.matricesIndicesExtra!=!e.matricesIndicesExtra||!this.matricesWeightsExtra!=!e.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");if(s){let n=0,i=0,r=0;const s=[];let a=null;const o=[];for(const t of this.splitBasedOnMaterialID())o.push({vertexData:t,transform:e});for(const e of t)if(e.vertexData)for(const t of e.vertexData.splitBasedOnMaterialID())o.push({vertexData:t,transform:e.transform});o.sort((e,t)=>{const n=e.vertexData.materialInfos?e.vertexData.materialInfos[0].materialIndex:0,i=t.vertexData.materialInfos?t.vertexData.materialInfos[0].materialIndex:0;return n>i?1:n===i?0:-1});for(const e of o){const t=e.vertexData;if(n=t.materialInfos?t.materialInfos[0].materialIndex:0,a&&a.materialIndex===n)a.indexCount+=t.indices.length,a.verticesCount+=t.positions.length/3;else{const e=new Nt;e.materialIndex=n,e.indexStart=i,e.indexCount=t.indices.length,e.verticesStart=r,e.verticesCount=t.positions.length/3,s.push(e),a=e}i+=t.indices.length,r+=t.positions.length/3}const l=o.splice(0,1)[0];h=l.vertexData,e=l.transform,d=o.map(e=>e.vertexData),t=o,this.materialInfos=s}const u=d.reduce((e,t)=>{var n,i;return e+(null!==(n=null===(i=t.indices)||void 0===i?void 0:i.length)&&void 0!==n?n:0)},null!==(o=null===(l=h.indices)||void 0===l?void 0:l.length)&&void 0!==o?o:0);let f=r||d.some(e=>e.indices===h.indices)?null===(c=h.indices)||void 0===c?void 0:c.slice():h.indices;if(u>0){var m,p;let r=null!==(m=null===(p=f)||void 0===p?void 0:p.length)&&void 0!==m?m:0;if(f||(f=new Array(u)),f.length!==u){if(Array.isArray(f))f.length=u;else{const e=n||f instanceof Uint32Array?new Uint32Array(u):new Uint16Array(u);e.set(f),f=e}e&&e.determinant()<0&&Ft._FlipFaces(f,0,r)}let s=h.positions?h.positions.length/3:0;for(const{vertexData:e,transform:n}of t)if(e.indices){for(let t=0;t<e.indices.length;t++)f[r+t]=e.indices[t]+s;n&&n.determinant()<0&&Ft._FlipFaces(f,r,e.indices.length),s+=e.positions.length/3,r+=e.indices.length,i&&(yield)}}return this.indices=f,this.positions=Ft._MergeElement(z.b.PositionKind,h.positions,e,t.map(e=>[e.vertexData.positions,e.transform])),i&&(yield),h.normals&&(this.normals=Ft._MergeElement(z.b.NormalKind,h.normals,e,t.map(e=>[e.vertexData.normals,e.transform])),i&&(yield)),h.tangents&&(this.tangents=Ft._MergeElement(z.b.TangentKind,h.tangents,e,t.map(e=>[e.vertexData.tangents,e.transform])),i&&(yield)),h.uvs&&(this.uvs=Ft._MergeElement(z.b.UVKind,h.uvs,e,t.map(e=>[e.vertexData.uvs,e.transform])),i&&(yield)),h.uvs2&&(this.uvs2=Ft._MergeElement(z.b.UV2Kind,h.uvs2,e,t.map(e=>[e.vertexData.uvs2,e.transform])),i&&(yield)),h.uvs3&&(this.uvs3=Ft._MergeElement(z.b.UV3Kind,h.uvs3,e,t.map(e=>[e.vertexData.uvs3,e.transform])),i&&(yield)),h.uvs4&&(this.uvs4=Ft._MergeElement(z.b.UV4Kind,h.uvs4,e,t.map(e=>[e.vertexData.uvs4,e.transform])),i&&(yield)),h.uvs5&&(this.uvs5=Ft._MergeElement(z.b.UV5Kind,h.uvs5,e,t.map(e=>[e.vertexData.uvs5,e.transform])),i&&(yield)),h.uvs6&&(this.uvs6=Ft._MergeElement(z.b.UV6Kind,h.uvs6,e,t.map(e=>[e.vertexData.uvs6,e.transform])),i&&(yield)),h.colors&&(this.colors=Ft._MergeElement(z.b.ColorKind,h.colors,e,t.map(e=>[e.vertexData.colors,e.transform])),(void 0!==h.hasVertexAlpha||t.some(e=>void 0!==e.vertexData.hasVertexAlpha))&&(this.hasVertexAlpha=h.hasVertexAlpha||t.some(e=>e.vertexData.hasVertexAlpha)),i&&(yield)),h.matricesIndices&&(this.matricesIndices=Ft._MergeElement(z.b.MatricesIndicesKind,h.matricesIndices,e,t.map(e=>[e.vertexData.matricesIndices,e.transform])),i&&(yield)),h.matricesWeights&&(this.matricesWeights=Ft._MergeElement(z.b.MatricesWeightsKind,h.matricesWeights,e,t.map(e=>[e.vertexData.matricesWeights,e.transform])),i&&(yield)),h.matricesIndicesExtra&&(this.matricesIndicesExtra=Ft._MergeElement(z.b.MatricesIndicesExtraKind,h.matricesIndicesExtra,e,t.map(e=>[e.vertexData.matricesIndicesExtra,e.transform])),i&&(yield)),h.matricesWeightsExtra&&(this.matricesWeightsExtra=Ft._MergeElement(z.b.MatricesWeightsExtraKind,h.matricesWeightsExtra,e,t.map(e=>[e.vertexData.matricesWeightsExtra,e.transform]))),this}static _MergeElement(e,t,n,i){const r=i.filter(e=>null!==e[0]&&void 0!==e[0]);if(!t&&0==r.length)return t;if(!t)return this._MergeElement(e,r[0][0],r[0][1],r.slice(1));const s=r.reduce((e,t)=>e+t[0].length,t.length),a=e===z.b.PositionKind?Ft._TransformVector3Coordinates:e===z.b.NormalKind?Ft._TransformVector3Normals:e===z.b.TangentKind?Ft._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const e=new Float32Array(s);e.set(t),n&&a(e,n,0,t.length);let i=t.length;for(const[t,n]of r)e.set(t,i),n&&a(e,n,i,t.length),i+=t.length;return e}{const e=new Array(s);for(let n=0;n<t.length;n++)e[n]=t[n];n&&a(e,n,0,t.length);let i=t.length;for(const[t,n]of r){for(let n=0;n<t.length;n++)e[i+n]=t[n];n&&a(e,n,i,t.length),i+=t.length}return e}}_validate(){if(!this.positions)throw new I.c("Positions are required",I.b.MeshInvalidPositionsError);const e=(e,t)=>{const n=z.b.DeduceStride(e);if(t.length%n!=0)throw new Error("The "+e+"s array count must be a multiple of "+n);return t.length/n},t=e(z.b.PositionKind,this.positions),n=(n,i)=>{const r=e(n,i);if(r!==t)throw new Error("The "+n+"s element count ("+r+") does not match the positions count ("+t+")")};this.normals&&n(z.b.NormalKind,this.normals),this.tangents&&n(z.b.TangentKind,this.tangents),this.uvs&&n(z.b.UVKind,this.uvs),this.uvs2&&n(z.b.UV2Kind,this.uvs2),this.uvs3&&n(z.b.UV3Kind,this.uvs3),this.uvs4&&n(z.b.UV4Kind,this.uvs4),this.uvs5&&n(z.b.UV5Kind,this.uvs5),this.uvs6&&n(z.b.UV6Kind,this.uvs6),this.colors&&n(z.b.ColorKind,this.colors),this.matricesIndices&&n(z.b.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&n(z.b.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&n(z.b.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&n(z.b.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){const e=this.serialize();return Ft.Parse(e)}serialize(){const e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors),e.hasVertexAlpha=this.hasVertexAlpha),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=this.indices?Array.from(this.indices):[],this.materialInfos){e.materialInfos=[];for(const t of this.materialInfos){const n={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(n)}}return e}static ExtractFromMesh(e,t,n){return Ft._ExtractFrom(e,t,n)}static ExtractFromGeometry(e,t,n){return Ft._ExtractFrom(e,t,n)}static _ExtractFrom(e,t,n){const i=new Ft;if(e.isVerticesDataPresent(z.b.PositionKind)&&(i.positions=e.getVerticesData(z.b.PositionKind,t,n)),e.isVerticesDataPresent(z.b.NormalKind)&&(i.normals=e.getVerticesData(z.b.NormalKind,t,n)),e.isVerticesDataPresent(z.b.TangentKind)&&(i.tangents=e.getVerticesData(z.b.TangentKind,t,n)),e.isVerticesDataPresent(z.b.UVKind)&&(i.uvs=e.getVerticesData(z.b.UVKind,t,n)),e.isVerticesDataPresent(z.b.UV2Kind)&&(i.uvs2=e.getVerticesData(z.b.UV2Kind,t,n)),e.isVerticesDataPresent(z.b.UV3Kind)&&(i.uvs3=e.getVerticesData(z.b.UV3Kind,t,n)),e.isVerticesDataPresent(z.b.UV4Kind)&&(i.uvs4=e.getVerticesData(z.b.UV4Kind,t,n)),e.isVerticesDataPresent(z.b.UV5Kind)&&(i.uvs5=e.getVerticesData(z.b.UV5Kind,t,n)),e.isVerticesDataPresent(z.b.UV6Kind)&&(i.uvs6=e.getVerticesData(z.b.UV6Kind,t,n)),e.isVerticesDataPresent(z.b.ColorKind)){const r=e.geometry||e,s=r.getVertexBuffer(z.b.ColorKind),a=r.getVerticesData(z.b.ColorKind,t,n);if(3===s.getSize()){const e=new Float32Array(4*a.length/3);for(let t=0,n=0;t<a.length;t+=3,n+=4)e[n]=a[t],e[n+1]=a[t+1],e[n+2]=a[t+2],e[n+3]=1;i.colors=e}else{if(4!==s.getSize())throw new Error("Unexpected number of color components: "+s.getSize());i.colors=a}}return e.isVerticesDataPresent(z.b.MatricesIndicesKind)&&(i.matricesIndices=e.getVerticesData(z.b.MatricesIndicesKind,t,n)),e.isVerticesDataPresent(z.b.MatricesWeightsKind)&&(i.matricesWeights=e.getVerticesData(z.b.MatricesWeightsKind,t,n)),e.isVerticesDataPresent(z.b.MatricesIndicesExtraKind)&&(i.matricesIndicesExtra=e.getVerticesData(z.b.MatricesIndicesExtraKind,t,n)),e.isVerticesDataPresent(z.b.MatricesWeightsExtraKind)&&(i.matricesWeightsExtra=e.getVerticesData(z.b.MatricesWeightsExtraKind,t,n)),i.indices=e.getIndices(t,n),i}static CreateRibbon(e){throw Object(ht.a)("ribbonBuilder")}static CreateBox(e){throw Object(ht.a)("boxBuilder")}static CreateTiledBox(e){throw Object(ht.a)("tiledBoxBuilder")}static CreateTiledPlane(e){throw Object(ht.a)("tiledPlaneBuilder")}static CreateSphere(e){throw Object(ht.a)("sphereBuilder")}static CreateCylinder(e){throw Object(ht.a)("cylinderBuilder")}static CreateTorus(e){throw Object(ht.a)("torusBuilder")}static CreateLineSystem(e){throw Object(ht.a)("linesBuilder")}static CreateDashedLines(e){throw Object(ht.a)("linesBuilder")}static CreateGround(e){throw Object(ht.a)("groundBuilder")}static CreateTiledGround(e){throw Object(ht.a)("groundBuilder")}static CreateGroundFromHeightMap(e){throw Object(ht.a)("groundBuilder")}static CreatePlane(e){throw Object(ht.a)("planeBuilder")}static CreateDisc(e){throw Object(ht.a)("discBuilder")}static CreatePolygon(e,t,n,i,r,s,a){throw Object(ht.a)("polygonBuilder")}static CreateIcoSphere(e){throw Object(ht.a)("icoSphereBuilder")}static CreatePolyhedron(e){throw Object(ht.a)("polyhedronBuilder")}static CreateCapsule(e={orientation:r.e.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw Object(ht.a)("capsuleBuilder")}static CreateTorusKnot(e){throw Object(ht.a)("torusKnotBuilder")}static ComputeNormals(e,t,n,i){let s=0,a=0,o=0,l=0,c=0,d=0,h=0,u=0,f=0,m=0,p=0,g=0,_=0,v=0,E=0,T=0,S=0,A=0,b=0,I=0,R=!1,C=!1,y=!1,M=!1,O=1,x=0,D=null;i&&(R=!!i.facetNormals,C=!!i.facetPositions,y=!!i.facetPartitioning,O=!0===i.useRightHandedSystem?-1:1,x=i.ratio||0,M=!!i.depthSort,D=i.distanceTo,M&&void 0===D&&(D=r.e.Zero()));let P=0,L=0,N=0,F=0;for(y&&i&&i.bbSize&&(P=i.subDiv.X*x/i.bbSize.x,L=i.subDiv.Y*x/i.bbSize.y,N=i.subDiv.Z*x/i.bbSize.z,F=i.subDiv.max*i.subDiv.max,i.facetPartitioning.length=0),s=0;s<e.length;s++)n[s]=0;const w=t.length/3|0;for(s=0;s<w;s++){if(g=3*t[3*s],_=g+1,v=g+2,E=3*t[3*s+1],T=E+1,S=E+2,A=3*t[3*s+2],b=A+1,I=A+2,a=e[g]-e[E],o=e[_]-e[T],l=e[v]-e[S],c=e[A]-e[E],d=e[b]-e[T],h=e[I]-e[S],u=O*(o*h-l*d),f=O*(l*c-a*h),m=O*(a*d-o*c),p=Math.sqrt(u*u+f*f+m*m),p=0===p?1:p,u/=p,f/=p,m/=p,R&&i&&(i.facetNormals[s].x=u,i.facetNormals[s].y=f,i.facetNormals[s].z=m),C&&i&&(i.facetPositions[s].x=(e[g]+e[E]+e[A])/3,i.facetPositions[s].y=(e[_]+e[T]+e[b])/3,i.facetPositions[s].z=(e[v]+e[S]+e[I])/3),y&&i){const t=Math.floor((i.facetPositions[s].x-i.bInfo.minimum.x*x)*P),n=Math.floor((i.facetPositions[s].y-i.bInfo.minimum.y*x)*L),r=Math.floor((i.facetPositions[s].z-i.bInfo.minimum.z*x)*N),a=Math.floor((e[g]-i.bInfo.minimum.x*x)*P),o=Math.floor((e[_]-i.bInfo.minimum.y*x)*L),l=Math.floor((e[v]-i.bInfo.minimum.z*x)*N),c=Math.floor((e[E]-i.bInfo.minimum.x*x)*P),d=Math.floor((e[T]-i.bInfo.minimum.y*x)*L),h=Math.floor((e[S]-i.bInfo.minimum.z*x)*N),u=Math.floor((e[A]-i.bInfo.minimum.x*x)*P),f=Math.floor((e[b]-i.bInfo.minimum.y*x)*L),m=Math.floor((e[I]-i.bInfo.minimum.z*x)*N),p=a+i.subDiv.max*o+F*l,R=c+i.subDiv.max*d+F*h,C=u+i.subDiv.max*f+F*m,y=t+i.subDiv.max*n+F*r;i.facetPartitioning[y]=i.facetPartitioning[y]?i.facetPartitioning[y]:new Array,i.facetPartitioning[p]=i.facetPartitioning[p]?i.facetPartitioning[p]:new Array,i.facetPartitioning[R]=i.facetPartitioning[R]?i.facetPartitioning[R]:new Array,i.facetPartitioning[C]=i.facetPartitioning[C]?i.facetPartitioning[C]:new Array,i.facetPartitioning[p].push(s),R!=p&&i.facetPartitioning[R].push(s),C!=R&&C!=p&&i.facetPartitioning[C].push(s),y!=p&&y!=R&&y!=C&&i.facetPartitioning[y].push(s)}if(M&&i&&i.facetPositions){const e=i.depthSortedFacets[s];e.ind=3*s,e.sqDistance=r.e.DistanceSquared(i.facetPositions[s],D)}n[g]+=u,n[_]+=f,n[v]+=m,n[E]+=u,n[T]+=f,n[S]+=m,n[A]+=u,n[b]+=f,n[I]+=m}for(s=0;s<n.length/3;s++)u=n[3*s],f=n[3*s+1],m=n[3*s+2],p=Math.sqrt(u*u+f*f+m*m),p=0===p?1:p,u/=p,f/=p,m/=p,n[3*s]=u,n[3*s+1]=f,n[3*s+2]=m}static _ComputeSides(e,t,n,i,s,a,o){const l=n.length,c=i.length;let d,h;switch(e=e||Ft.DEFAULTSIDE){case Ft.FRONTSIDE:break;case Ft.BACKSIDE:for(d=0;d<l;d+=3){const e=n[d];n[d]=n[d+2],n[d+2]=e}for(h=0;h<c;h++)i[h]=-i[h];break;case Ft.DOUBLESIDE:{const e=t.length,u=e/3;for(let n=0;n<e;n++)t[e+n]=t[n];for(d=0;d<l;d+=3)n[d+l]=n[d+2]+u,n[d+1+l]=n[d+1]+u,n[d+2+l]=n[d]+u;for(h=0;h<c;h++)i[c+h]=-i[h];const f=s.length;let m=0;for(m=0;m<f;m++)s[m+f]=s[m];for(a=a||new r.f(0,0,1,1),o=o||new r.f(0,0,1,1),m=0,d=0;d<f/2;d++)s[m]=a.x+(a.z-a.x)*s[m],s[m+1]=a.y+(a.w-a.y)*s[m+1],s[m+f]=o.x+(o.z-o.x)*s[m+f],s[m+f+1]=o.y+(o.w-o.y)*s[m+f+1],m+=2;break}}}static Parse(e){const t=new Ft,n=e.positions;n&&t.set(n,z.b.PositionKind);const i=e.normals;i&&t.set(i,z.b.NormalKind);const r=e.tangents;r&&t.set(r,z.b.TangentKind);const s=e.uvs;s&&t.set(s,z.b.UVKind);const a=e.uvs2;a&&t.set(a,z.b.UV2Kind);const o=e.uvs3;o&&t.set(o,z.b.UV3Kind);const l=e.uvs4;l&&t.set(l,z.b.UV4Kind);const c=e.uvs5;c&&t.set(c,z.b.UV5Kind);const d=e.uvs6;d&&t.set(d,z.b.UV6Kind);const h=e.colors;h&&(t.set(he.b.CheckColors4(h,n.length/3),z.b.ColorKind),void 0!==e.hasVertexAlpha&&(t.hasVertexAlpha=e.hasVertexAlpha));const u=e.matricesIndices;u&&t.set(u,z.b.MatricesIndicesKind);const f=e.matricesWeights;f&&t.set(f,z.b.MatricesWeightsKind);const m=e.indices;m&&(t.indices=m);const p=e.materialInfos;if(p){t.materialInfos=[];for(const e of p){const n=new Nt;n.indexCount=e.indexCount,n.indexStart=e.indexStart,n.verticesCount=e.verticesCount,n.verticesStart=e.verticesStart,n.materialIndex=e.materialIndex,t.materialInfos.push(n)}}return t}static ImportVertexData(e,t){const n=Ft.Parse(e);t.setAllVerticesData(n,e.updatable)}constructor(){var e;this.uniqueId=0,this.metadata={},this._applyTo=(e=this._applyToCoroutine.bind(this),(...t)=>Lt(e(...t),void 0)),this.uniqueId=Ft._UniqueIDGenerator,Ft._UniqueIDGenerator++}}Ft.FRONTSIDE=0,Ft.BACKSIDE=1,Ft.DOUBLESIDE=2,Ft.DEFAULTSIDE=0,Ft._UniqueIDGenerator=0,Object(W.a)([X.b.filter((...[e])=>!Array.isArray(e))],Ft,"_TransformVector3Coordinates",null),Object(W.a)([X.b.filter((...[e])=>!Array.isArray(e))],Ft,"_TransformVector3Normals",null),Object(W.a)([X.b.filter((...[e])=>!Array.isArray(e))],Ft,"_TransformVector4Normals",null),Object(W.a)([X.b.filter((...[e])=>!Array.isArray(e))],Ft,"_FlipFaces",null);var wt=n(394),Ut=n(82);class Bt{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new Bt(Bt.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return 1===this.delayLoadState||0===this.delayLoadState}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer"));const e=new Set;for(const t in this._vertexBuffers)e.add(this._vertexBuffers[t].getWrapperBuffer());e.forEach(e=>{e._rebuild()})}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,n=!1,i){n&&Array.isArray(t)&&(t=new Float32Array(t));const r=new z.b(this._engine,t,e,{updatable:n,postponeInternalCreation:0===this._meshes.length,stride:i,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(r)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,n=!0){const i=e.getKind();this._vertexBuffers[i]&&n&&this._vertexBuffers[i].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[i]=e;const s=this._meshes,a=s.length;if(i===z.b.PositionKind){this._totalVertices=null!=t?t:e._maxVerticesCount,this._updateExtend(e.getFloatData(this._totalVertices)),this._resetPointsArrayCache();const n=this._extend&&this._extend.minimum||new r.e(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i=this._extend&&this._extend.maximum||new r.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let e=0;e<a;e++){const t=s[e];t.buildBoundingInfo(n,i),t._createGlobalSubMesh(t.isUnIndexed),t.computeWorldMatrix(!0),t.synchronizeInstances()}}this._notifyUpdate(i)}updateVerticesDataDirectly(e,t,n,i=!1){const r=this.getVertexBuffer(e);r&&(r.updateDirectly(t,n,i),this._notifyUpdate(e))}updateVerticesData(e,t,n=!1){const i=this.getVertexBuffer(e);i&&(i.update(t),e===z.b.PositionKind&&(this._totalVertices=i._maxVerticesCount,this._updateBoundingInfo(n,t)),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const e=this._meshes;for(const t of e){t.hasBoundingInfo?t.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):t.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const e=t.subMeshes;for(const t of e)t.refreshBoundingInfo()}}}_bind(e,t,n,i){if(!e)return;void 0===t&&(t=this._indexBuffer);const r=this.getVertexBuffers();if(!r)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!i)return void this._engine.bindBuffers(r,t,e,n);const s=i||this._vertexArrayObjects,a=this._engine;s[e.key]||(s[e.key]=a.recordVertexArrayObject(r,t,e,n)),a.bindVertexArrayObject(s[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,n){const i=this.getVertexBuffer(e);return i?i.getFloatData(this._totalVertices,n||t&&1!==this._meshes.length):null}copyVerticesData(e,t){const n=this.getVertexBuffer(e);if(!n)return;t[e]||(t[e]=new Float32Array(this._totalVertices*n.getSize()));const i=n.getData();i&&Object(Ut.a)(i,n.getSize(),n.type,n.byteOffset,n.byteStride,n.normalized,this._totalVertices,t[e])}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return!!t&&t.isUpdatable()}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?void 0!==this._vertexBuffers[e]:!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,n=!1){if(this._indexBuffer)if(this._indexBufferIsUpdatable){const i=e.length!==this._indices.length;if(n||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),i)for(const e of this._meshes)e._createGlobalSubMesh(!0)}else this.setIndices(e,null,!0)}setIndexBuffer(e,t,n){this._indices=[],this._indexBufferIsUpdatable=!1,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=n,e.is32Bits||(e.is32Bits=this._totalIndices>65535);for(const e of this._meshes)e._createGlobalSubMesh(!0),e.synchronizeInstances();this._notifyUpdate()}setIndices(e,t=null,n=!1,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=n,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,n,"Geometry_"+this.id+"_IndexBuffer")),null!=t&&(this._totalVertices=t);for(const e of this._meshes)e._createGlobalSubMesh(!i),e.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?void 0!==this._totalIndices?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const n=this._indices;return t||e&&1!==this._meshes.length?n.slice():n}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){e&&this._vertexArrayObjects&&this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const n=this._meshes,i=n.indexOf(e);-1!==i&&(n.splice(i,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,0===n.length&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const n=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),n.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&!(e=this.getVerticesData(z.b.PositionKind)))return;this._extend=re(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const n in this._vertexBuffers)1===t&&this._vertexBuffers[n].create(),n===z.b.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());1===t&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer")),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const e of this._meshes)e._markSubMeshesAsAttributesDirty()}load(e,t){2!==this.delayLoadState&&(this.isReady()?t&&t():(this.delayLoadState=2,this._queueLoad(e,t)))}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,n=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(n),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const i=this._meshes,r=i.length;for(let e=0;e<r;e++)this._applyToMesh(i[e]);t&&t()},void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(null!=e&&e.length>0){for(let t=0;t<e.length;t+=3){const n=e[t+0];e[t+0]=e[t+2],e[t+2]=n}this.setIndices(e)}const t=this.getVerticesData(z.b.PositionKind,!1);if(null!=t&&t.length>0){for(let e=0;e<t.length;e+=3)t[e+2]=-t[e+2];this.setVerticesData(z.b.PositionKind,t,!1)}const n=this.getVerticesData(z.b.NormalKind,!1);if(null!=n&&n.length>0){for(let e=0;e<n.length;e+=3)n[e+2]=-n[e+2];this.setVerticesData(z.b.NormalKind,n,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(z.b.PositionKind);if(!e||0===e.length)return!1;for(let t=3*this._positionsCache.length,n=this._positionsCache.length;t<e.length;t+=3,++n)this._positionsCache[n]=r.e.FromArray(e,t);for(let t=0,n=0;t<e.length;t+=3,++n)this._positionsCache[n].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const e in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let n=0;n<t;n++)e[n]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let n;for(n=0;n<t;n++)this.releaseForMesh(e[n]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const e in this._vertexBuffers)this._vertexBuffers[e].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const e=this._parentContainer.geometries.indexOf(this);e>-1&&this._parentContainer.geometries.splice(e,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new Ft;t.indices=[];const n=this.getIndices();if(n)for(let e=0;e<n.length;e++)t.indices.push(n[e]);let i,r=!1,s=!1;for(i in this._vertexBuffers){const e=this.getVerticesData(i);if(e&&(e instanceof Float32Array?t.set(new Float32Array(e),i):t.set(e.slice(0),i),!s)){const e=this.getVertexBuffer(i);e&&(r=e.isUpdatable(),s=!r)}}const a=new Bt(e,this._scene,t,r);for(i in a.delayLoadState=this.delayLoadState,a.delayLoadingFile=this.delayLoadingFile,a._delayLoadingFunction=this._delayLoadingFunction,this._delayInfo)a._delayInfo=a._delayInfo||[],a._delayInfo.push(i);return a._boundingInfo=new ne(this._extend.minimum,this._extend.maximum),a}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,xt.a&&xt.a.HasTags(this)&&(e.tags=xt.a.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(z.b.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(z.b.PositionKind)),this.isVertexBufferUpdatable(z.b.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(z.b.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(z.b.NormalKind)),this.isVertexBufferUpdatable(z.b.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(z.b.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(z.b.TangentKind)),this.isVertexBufferUpdatable(z.b.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(z.b.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(z.b.UVKind)),this.isVertexBufferUpdatable(z.b.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(z.b.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(z.b.UV2Kind)),this.isVertexBufferUpdatable(z.b.UV2Kind)&&(e.uvs2._updatable=!0)),this.isVerticesDataPresent(z.b.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(z.b.UV3Kind)),this.isVertexBufferUpdatable(z.b.UV3Kind)&&(e.uvs3._updatable=!0)),this.isVerticesDataPresent(z.b.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(z.b.UV4Kind)),this.isVertexBufferUpdatable(z.b.UV4Kind)&&(e.uvs4._updatable=!0)),this.isVerticesDataPresent(z.b.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(z.b.UV5Kind)),this.isVertexBufferUpdatable(z.b.UV5Kind)&&(e.uvs5._updatable=!0)),this.isVerticesDataPresent(z.b.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(z.b.UV6Kind)),this.isVertexBufferUpdatable(z.b.UV6Kind)&&(e.uvs6._updatable=!0)),this.isVerticesDataPresent(z.b.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(z.b.ColorKind)),this.isVertexBufferUpdatable(z.b.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(z.b.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(z.b.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(z.b.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(z.b.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(z.b.MatricesWeightsKind)),this.isVertexBufferUpdatable(z.b.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const n=e._geometry;return n?n.copy(t):null}static RandomId(){return g.b.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let n=0;n<t.geometries.length;n++)if(t.geometries[n]._loadedUniqueId===e)return t.geometries[n];return null}static _ImportGeometry(e,t){const n=t.getScene(),i=e.geometryUniqueId,r=e.geometryId;if(i||r){const e=i?this._GetGeometryByLoadedUniqueId(i,n):n.getGeometryById(r);e&&e.applyToMesh(t)}else if(e instanceof ArrayBuffer){const n=t._binaryInfo;if(n.positionsAttrDesc&&n.positionsAttrDesc.count>0){const i=new Float32Array(e,n.positionsAttrDesc.offset,n.positionsAttrDesc.count);t.setVerticesData(z.b.PositionKind,i,!1)}if(n.normalsAttrDesc&&n.normalsAttrDesc.count>0){const i=new Float32Array(e,n.normalsAttrDesc.offset,n.normalsAttrDesc.count);t.setVerticesData(z.b.NormalKind,i,!1)}if(n.tangetsAttrDesc&&n.tangetsAttrDesc.count>0){const i=new Float32Array(e,n.tangetsAttrDesc.offset,n.tangetsAttrDesc.count);t.setVerticesData(z.b.TangentKind,i,!1)}if(n.uvsAttrDesc&&n.uvsAttrDesc.count>0){const i=new Float32Array(e,n.uvsAttrDesc.offset,n.uvsAttrDesc.count);if(wt.a)for(let e=1;e<i.length;e+=2)i[e]=1-i[e];t.setVerticesData(z.b.UVKind,i,!1)}if(n.uvs2AttrDesc&&n.uvs2AttrDesc.count>0){const i=new Float32Array(e,n.uvs2AttrDesc.offset,n.uvs2AttrDesc.count);if(wt.a)for(let e=1;e<i.length;e+=2)i[e]=1-i[e];t.setVerticesData(z.b.UV2Kind,i,!1)}if(n.uvs3AttrDesc&&n.uvs3AttrDesc.count>0){const i=new Float32Array(e,n.uvs3AttrDesc.offset,n.uvs3AttrDesc.count);if(wt.a)for(let e=1;e<i.length;e+=2)i[e]=1-i[e];t.setVerticesData(z.b.UV3Kind,i,!1)}if(n.uvs4AttrDesc&&n.uvs4AttrDesc.count>0){const i=new Float32Array(e,n.uvs4AttrDesc.offset,n.uvs4AttrDesc.count);if(wt.a)for(let e=1;e<i.length;e+=2)i[e]=1-i[e];t.setVerticesData(z.b.UV4Kind,i,!1)}if(n.uvs5AttrDesc&&n.uvs5AttrDesc.count>0){const i=new Float32Array(e,n.uvs5AttrDesc.offset,n.uvs5AttrDesc.count);if(wt.a)for(let e=1;e<i.length;e+=2)i[e]=1-i[e];t.setVerticesData(z.b.UV5Kind,i,!1)}if(n.uvs6AttrDesc&&n.uvs6AttrDesc.count>0){const i=new Float32Array(e,n.uvs6AttrDesc.offset,n.uvs6AttrDesc.count);if(wt.a)for(let e=1;e<i.length;e+=2)i[e]=1-i[e];t.setVerticesData(z.b.UV6Kind,i,!1)}if(n.colorsAttrDesc&&n.colorsAttrDesc.count>0){const i=new Float32Array(e,n.colorsAttrDesc.offset,n.colorsAttrDesc.count);t.setVerticesData(z.b.ColorKind,i,!1,n.colorsAttrDesc.stride)}if(n.matricesIndicesAttrDesc&&n.matricesIndicesAttrDesc.count>0){const i=new Int32Array(e,n.matricesIndicesAttrDesc.offset,n.matricesIndicesAttrDesc.count),r=[];for(let e=0;e<i.length;e++){const t=i[e];r.push(255&t),r.push((65280&t)>>8),r.push((16711680&t)>>16),r.push(t>>24&255)}t.setVerticesData(z.b.MatricesIndicesKind,r,!1)}if(n.matricesIndicesExtraAttrDesc&&n.matricesIndicesExtraAttrDesc.count>0){const i=new Int32Array(e,n.matricesIndicesExtraAttrDesc.offset,n.matricesIndicesExtraAttrDesc.count),r=[];for(let e=0;e<i.length;e++){const t=i[e];r.push(255&t),r.push((65280&t)>>8),r.push((16711680&t)>>16),r.push(t>>24&255)}t.setVerticesData(z.b.MatricesIndicesExtraKind,r,!1)}if(n.matricesWeightsAttrDesc&&n.matricesWeightsAttrDesc.count>0){const i=new Float32Array(e,n.matricesWeightsAttrDesc.offset,n.matricesWeightsAttrDesc.count);t.setVerticesData(z.b.MatricesWeightsKind,i,!1)}if(n.indicesAttrDesc&&n.indicesAttrDesc.count>0){const i=new Int32Array(e,n.indicesAttrDesc.offset,n.indicesAttrDesc.count);t.setIndices(i,null)}if(n.subMeshesAttrDesc&&n.subMeshesAttrDesc.count>0){const i=new Int32Array(e,n.subMeshesAttrDesc.offset,5*n.subMeshesAttrDesc.count);t.subMeshes=[];for(let e=0;e<n.subMeshesAttrDesc.count;e++){const n=i[5*e+0],r=i[5*e+1],s=i[5*e+2],a=i[5*e+3],o=i[5*e+4];ae.AddToMesh(n,r,s,a,o,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(z.b.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(z.b.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(z.b.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(z.b.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(z.b.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(z.b.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(z.b.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(z.b.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(z.b.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(z.b.ColorKind,he.b.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(z.b.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const n=[];for(let t=0;t<e.matricesIndices.length;t++){const i=e.matricesIndices[t];n.push(255&i),n.push((65280&i)>>8),n.push((16711680&i)>>16),n.push(i>>24&255)}t.setVerticesData(z.b.MatricesIndicesKind,n,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(z.b.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const n=[];for(let t=0;t<e.matricesIndicesExtra.length;t++){const i=e.matricesIndicesExtra[t];n.push(255&i),n.push((65280&i)>>8),n.push((16711680&i)>>16),n.push(i>>24&255)}t.setVerticesData(z.b.MatricesIndicesExtraKind,n,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(Bt._CleanMatricesWeights(e,t),t.setVerticesData(z.b.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(z.b.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let n=0;n<e.subMeshes.length;n++){const i=e.subMeshes[n];ae.AddToMesh(i.materialIndex,i.verticesStart,i.verticesCount,i.indexStart,i.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),n.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!S.CleanBoneMatrixWeights)return;let n=0;if(!(e.skeletonId>-1))return;{const i=t.getScene().getLastSkeletonById(e.skeletonId);if(!i)return;n=i.bones.length}const i=t.getVerticesData(z.b.MatricesIndicesKind),r=t.getVerticesData(z.b.MatricesIndicesExtraKind),s=e.matricesWeights,a=e.matricesWeightsExtra,o=e.numBoneInfluencer,l=s.length;for(let e=0;e<l;e+=4){let t=0,l=-1;for(let n=0;n<4;n++){const i=s[e+n];t+=i,i<.001&&l<0&&(l=n)}if(a)for(let n=0;n<4;n++){const i=a[e+n];t+=i,i<.001&&l<0&&(l=n+4)}if((l<0||l>o-1)&&(l=o-1),t>.001){const n=1/t;for(let t=0;t<4;t++)s[e+t]*=n;if(a)for(let t=0;t<4;t++)a[e+t]*=n}else l>=4?(a[e+l-4]=1-t,r[e+l-4]=n):(s[e+l]=1-t,i[e+l]=n)}t.setVerticesData(z.b.MatricesIndicesKind,i),e.matricesWeightsExtra&&t.setVerticesData(z.b.MatricesIndicesExtraKind,r)}static Parse(e,t,n){const i=new Bt(e.id,t,void 0,e.updatable);return i._loadedUniqueId=e.uniqueId,xt.a&&xt.a.AddTagsTo(i,e.tags),e.delayLoadingFile?(i.delayLoadState=4,i.delayLoadingFile=n+e.delayLoadingFile,i._boundingInfo=new ne(r.e.FromArray(e.boundingBoxMinimum),r.e.FromArray(e.boundingBoxMaximum)),i._delayInfo=[],e.hasUVs&&i._delayInfo.push(z.b.UVKind),e.hasUVs2&&i._delayInfo.push(z.b.UV2Kind),e.hasUVs3&&i._delayInfo.push(z.b.UV3Kind),e.hasUVs4&&i._delayInfo.push(z.b.UV4Kind),e.hasUVs5&&i._delayInfo.push(z.b.UV5Kind),e.hasUVs6&&i._delayInfo.push(z.b.UV6Kind),e.hasColors&&i._delayInfo.push(z.b.ColorKind),e.hasMatricesIndices&&i._delayInfo.push(z.b.MatricesIndicesKind),e.hasMatricesWeights&&i._delayInfo.push(z.b.MatricesWeightsKind),i._delayLoadingFunction=Ft.ImportVertexData):Ft.ImportVertexData(e,i),t.pushGeometry(i,!0),i}constructor(e,t,n,i=!1,r=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||E.a.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=i,n?this.setAllVerticesData(n,i):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),r&&(this.applyToMesh(r),r.computeWorldMatrix(!0)))}}const kt=r.a.Compose(r.e.One(),r.b.FromEulerAngles(0,Math.PI,0),r.e.Zero());class Vt extends dt.a{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=0!=(this._billboardMode&Vt.BILLBOARDMODE_USE_POSITION),this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==Vt.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._markAsDirtyInternal()}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._markAsDirtyInternal()}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._markAsDirtyInternal()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._markAsDirtyInternal()}_markAsDirtyInternal(){this._isDirty||(this._isDirty=!0,this.customMarkAsDirty&&this.customMarkAsDirty())}get forward(){return r.e.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return r.e.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return r.e.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=r.a.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==Vt.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=r.a.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,n){const i=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);i&&n&&n(this,i);for(const e of this.getChildTransformNodes(!0))e.instantiateHierarchy(i,t,n);return i}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||r.b.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,n,i;if(void 0===e.x){if(arguments.length<3)return this;t=arguments[0],n=arguments[1],i=arguments[2]}else t=e.x,n=e.y,i=e.z;if(this.parent){const e=r.c.Matrix[0];this.parent.getWorldMatrix().invertToRef(e),r.e.TransformCoordinatesFromFloatsToRef(t,n,i,e,this.position)}else this.position.x=t,this.position.y=n,this.position.z=i;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=r.e.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=r.c.Matrix[0];return this._localMatrix.invertToRef(e),r.e.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=r.e.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,n=0,i=0,s=0){const a=Vt._LookAtVectorCache,o=0===s?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,a),this.setDirection(a,t,n,i),1===s&&this.parent)if(this.rotationQuaternion){const e=r.c.Matrix[0];this.rotationQuaternion.toRotationMatrix(e);const t=r.c.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(t),t.invert(),e.multiplyToRef(t,e),this.rotationQuaternion.fromRotationMatrix(e)}else{const e=r.c.Quaternion[0];r.b.FromEulerVectorToRef(this.rotation,e);const t=r.c.Matrix[0];e.toRotationMatrix(t);const n=r.c.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(n),n.invert(),t.multiplyToRef(n,t),e.fromRotationMatrix(t),e.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=r.e.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return r.e.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,n=0,i=0){const s=-Math.atan2(e.z,e.x)+Math.PI/2,a=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,a);return this.rotationQuaternion?r.b.RotationYawPitchRollToRef(s+t,o+n,i,this.rotationQuaternion):(this.rotation.x=o+n,this.rotation.y=s+t,this.rotation.z=i),this}setPivotPoint(e,t=0){0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);const n=this.getWorldMatrix();if(1==t){const t=r.c.Matrix[0];n.invertToRef(t),e=r.e.TransformCoordinates(e,t)}return this.setPivotMatrix(r.a.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=r.e.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=r.e.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),r.e.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,n=!1){if(!e&&!this.parent)return this;const i=r.c.Quaternion[0],s=r.c.Vector3[0],a=r.c.Vector3[1],o=r.c.Matrix[1];r.a.IdentityToRef(o);const l=r.c.Matrix[0];this.computeWorldMatrix(!0);let c=this.rotationQuaternion;return c||(c=Vt._TmpRotation,r.b.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),r.a.ComposeToRef(this.scaling,c,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(o),l.multiplyToRef(o,l)),l.decompose(a,i,s,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(i):i.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(a),this.position.copyFrom(s),this.parent=e,n&&this.setPivotMatrix(r.a.Identity()),this}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.parent!==this||e.setParent(null,t),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling!==e&&(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,this.parent=e?this._currentParentWhenAttachingToBone:null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,n){let i;if(e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0)),n&&0!==n){if(this.parent){const n=this.parent.getWorldMatrix(),i=r.c.Matrix[0];n.invertToRef(i),e=r.e.TransformNormal(e,i),n.determinant()<0&&(t*=-1)}i=r.b.RotationAxisToRef(e,t,Vt._RotationAxisCache),i.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else i=r.b.RotationAxisToRef(e,t,Vt._RotationAxisCache),this.rotationQuaternion.multiplyToRef(i,this.rotationQuaternion);return this}rotateAround(e,t,n){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=r.b.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const i=r.c.Vector3[0],s=r.c.Vector3[1],a=r.c.Vector3[2],o=r.c.Quaternion[0],l=r.c.Matrix[0],c=r.c.Matrix[1],d=r.c.Matrix[2],h=r.c.Matrix[3];return e.subtractToRef(this.position,i),r.a.TranslationToRef(i.x,i.y,i.z,l),r.a.TranslationToRef(-i.x,-i.y,-i.z,c),r.a.RotationAxisToRef(t,n,d),c.multiplyToRef(d,h),h.multiplyToRef(l,h),h.decompose(s,o,a),this.position.addInPlace(a),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,n){const i=e.scale(t);if(n&&0!==n)this.setAbsolutePosition(this.getAbsolutePosition().add(i));else{const e=this.getPositionExpressedInLocalSpace().add(i);this.setPositionWithLocalVector(e)}return this}addRotation(e,t,n){let i;this.rotationQuaternion?i=this.rotationQuaternion:(i=r.c.Quaternion[1],r.b.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,i));const s=r.c.Quaternion[0];return r.b.RotationYawPitchRollToRef(t,e,n,s),i.multiplyInPlace(s),this.rotationQuaternion||i.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==Vt.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const n=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===n||this.isSynchronized()))return this._currentRenderId=n,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const i=this._cache;i.pivotMatrixUpdated=!1,i.billboardMode=this.billboardMode,i.infiniteDistance=this.infiniteDistance,i.parent=this._parentNode,this._currentRenderId=n,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const s=this._getEffectiveParent(),a=Vt._TmpScaling;let o,l=this._position;if(this._infiniteDistance&&!this.parent&&t){const e=t.getWorldMatrix(),n=new r.e(e.m[12],e.m[13],e.m[14]);l=Vt._TmpTranslation,l.copyFromFloats(this._position.x+n.x,this._position.y+n.y,this._position.z+n.z)}if(a.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant),this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,o=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(r.b.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(o=Vt._TmpRotation,r.b.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,o)),this._usePivotMatrix){const e=r.c.Matrix[1];r.a.ScalingToRef(a.x,a.y,a.z,e);const t=r.c.Matrix[0];o.toRotationMatrix(t),this._pivotMatrix.multiplyToRef(e,r.c.Matrix[4]),r.c.Matrix[4].multiplyToRef(t,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(l.x,l.y,l.z)}else r.a.ComposeToRef(a,o,l,this._localMatrix);if(s&&s.getWorldMatrix){if(e&&s.computeWorldMatrix(e),i.useBillboardPath){if(this._transformToBoneReferal){const e=this.parent;e.getSkeleton().prepare(),e.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),r.c.Matrix[7])}else r.c.Matrix[7].copyFrom(s.getWorldMatrix());const e=r.c.Vector3[5],t=r.c.Vector3[6],n=r.c.Quaternion[0];r.c.Matrix[7].decompose(t,n,e),r.a.ScalingToRef(t.x,t.y,t.z,r.c.Matrix[7]),r.c.Matrix[7].setTranslation(e),Vt.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(n,e),this._localMatrix.setTranslation(e)),this._localMatrix.multiplyToRef(r.c.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){const e=this.parent;e.getSkeleton().prepare(),this._localMatrix.multiplyToRef(e.getFinalMatrix(),r.c.Matrix[6]),r.c.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(s.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(i.useBillboardPath&&t&&this.billboardMode&&!i.useBillboardPosition){const e=r.c.Vector3[0];if(this._worldMatrix.getTranslationToRef(e),r.c.Matrix[1].copyFrom(t.getViewMatrix()),this._scene.useRightHandedSystem&&r.c.Matrix[1].multiplyToRef(kt,r.c.Matrix[1]),r.c.Matrix[1].setTranslationFromFloats(0,0,0),r.c.Matrix[1].invertToRef(r.c.Matrix[0]),(this.billboardMode&Vt.BILLBOARDMODE_ALL)!==Vt.BILLBOARDMODE_ALL){r.c.Matrix[0].decompose(void 0,r.c.Quaternion[0],void 0);const e=r.c.Vector3[1];r.c.Quaternion[0].toEulerAnglesToRef(e),(this.billboardMode&Vt.BILLBOARDMODE_X)!==Vt.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&Vt.BILLBOARDMODE_Y)!==Vt.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&Vt.BILLBOARDMODE_Z)!==Vt.BILLBOARDMODE_Z&&(e.z=0),r.a.RotationYawPitchRollToRef(e.y,e.x,e.z,r.c.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(r.c.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(r.c.Vector3[0])}else if(i.useBillboardPath&&t&&i.useBillboardPosition){const e=r.c.Vector3[0];this._worldMatrix.getTranslationToRef(e);const n=t.globalPosition;this._worldMatrix.invertToRef(r.c.Matrix[1]);const i=r.c.Vector3[1];r.e.TransformCoordinatesToRef(n,r.c.Matrix[1],i),i.normalize();const s=-Math.atan2(i.z,i.x)+Math.PI/2,a=Math.sqrt(i.x*i.x+i.z*i.z),o=-Math.atan2(i.y,a);if(r.b.RotationYawPitchRollToRef(s,o,0,r.c.Quaternion[0]),(this.billboardMode&Vt.BILLBOARDMODE_ALL)!==Vt.BILLBOARDMODE_ALL){const e=r.c.Vector3[1];r.c.Quaternion[0].toEulerAnglesToRef(e),(this.billboardMode&Vt.BILLBOARDMODE_X)!==Vt.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&Vt.BILLBOARDMODE_Y)!==Vt.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&Vt.BILLBOARDMODE_Z)!==Vt.BILLBOARDMODE_Z&&(e.z=0),r.a.RotationYawPitchRollToRef(e.y,e.x,e.z,r.c.Matrix[0])}else r.a.FromQuaternionToRef(r.c.Quaternion[0],r.c.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(r.c.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(r.c.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):s&&s._nonUniformScaling?this._updateNonUniformScalingState(s._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=r.a.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const e=this.getChildren();for(let t=0;t<e.length;++t){const n=e[t];if(n){n.computeWorldMatrix();const e=r.c.Matrix[0];n._localMatrix.multiplyToRef(this._localMatrix,e);const t=r.c.Quaternion[0];e.decompose(n.scaling,t,n.position),n.rotationQuaternion?n.rotationQuaternion.copyFrom(t):t.toEulerAnglesToRef(n.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=r.b.Identity()),this._worldMatrix=r.a.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),r.e.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,n){const i=ce.a.Clone(()=>new Vt(e,this.getScene()),this);if(i.name=e,i.id=e,t&&(i.parent=t),!n){const t=this.getDescendants(!0);for(let n=0;n<t.length;n++){const r=t[n];r.clone&&r.clone(e+"."+r.name,i)}}return i}serialize(e){const t=ce.a.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),ce.a.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t}static Parse(e,t,n){const i=ce.a.Parse(()=>new Vt(e.name,t),e,t,n);if(e.localMatrix?i.setPreTransformMatrix(r.a.FromArray(e.localMatrix)):e.pivotMatrix&&i.setPivotMatrix(r.a.FromArray(e.pivotMatrix)),i.setEnabled(e.isEnabled),i._waitingParsedUniqueId=e.uniqueId,void 0!==e.parentId&&(i._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(i._waitingParentInstanceIndex=e.parentInstanceIndex),e.animations){for(let t=0;t<e.animations.length;t++){const n=e.animations[t],r=Object(Je.a)("BABYLON.Animation");r&&i.animations.push(r.Parse(n))}dt.a.ParseAnimationRanges(i,e,t)}return e.autoAnimate&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),i}getChildTransformNodes(e,t){const n=[];return this._getDescendants(n,e,e=>(!t||t(e))&&e instanceof Vt),n}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const e=this._parentContainer.transformNodes.indexOf(this);e>-1&&this._parentContainer.transformNodes.splice(e,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const e=this.getChildTransformNodes(!0);for(const t of e)t.parent=null,t.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,n){let i=null,r=null;t&&(this.rotationQuaternion?(r=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(i=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const s=this.getHierarchyBoundingVectors(e,n),a=s.max.subtract(s.min),o=Math.max(a.x,a.y,a.z);if(0===o)return this;const l=1/o;return this.scaling.scaleInPlace(l),t&&(this.rotationQuaternion&&r?this.rotationQuaternion.copyFrom(r):this.rotation&&i&&this.rotation.copyFrom(i)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}constructor(e,t=null,n=!0){super(e,t,!1),this._forward=new r.e(0,0,1),this._up=new r.e(0,1,0),this._right=new r.e(1,0,0),this._position=r.e.Zero(),this._rotation=r.e.Zero(),this._rotationQuaternion=null,this._scaling=r.e.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=Vt.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=r.a.Zero(),this._usePivotMatrix=!1,this._absolutePosition=r.e.Zero(),this._absoluteScaling=r.e.Zero(),this._absoluteRotationQuaternion=r.b.Identity(),this._pivotMatrix=r.a.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new _.a,this._nonUniformScaling=!1,n&&this.getScene().addTransformNode(this)}}Vt.BILLBOARDMODE_NONE=0,Vt.BILLBOARDMODE_X=1,Vt.BILLBOARDMODE_Y=2,Vt.BILLBOARDMODE_Z=4,Vt.BILLBOARDMODE_ALL=7,Vt.BILLBOARDMODE_USE_POSITION=128,Vt.BillboardUseParentOrientation=!1,Vt._TmpRotation=r.b.Zero(),Vt._TmpScaling=r.e.Zero(),Vt._TmpTranslation=r.e.Zero(),Vt._LookAtVectorCache=new r.e(0,0,0),Vt._RotationAxisCache=new r.b,Object(W.a)([Object(X.n)("position")],Vt.prototype,"_position",void 0),Object(W.a)([Object(X.n)("rotation")],Vt.prototype,"_rotation",void 0),Object(W.a)([Object(X.k)("rotationQuaternion")],Vt.prototype,"_rotationQuaternion",void 0),Object(W.a)([Object(X.n)("scaling")],Vt.prototype,"_scaling",void 0),Object(W.a)([Object(X.c)("billboardMode")],Vt.prototype,"_billboardMode",void 0),Object(W.a)([Object(X.c)()],Vt.prototype,"scalingDeterminant",void 0),Object(W.a)([Object(X.c)("infiniteDistance")],Vt.prototype,"_infiniteDistance",void 0),Object(W.a)([Object(X.c)()],Vt.prototype,"ignoreNonUniformScaling",void 0),Object(W.a)([Object(X.c)()],Vt.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);var Gt=n(376);class Ht{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new r.e(0,0,0),this._diffPositionForCollisions=new r.e(0,0,0),this._collisionResponse=!0}}class Wt{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=r.e.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class Xt{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new Wt,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=new Map,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new Ht,this._enableDistantPicking=!1,this._rawBoundingInfo=null,this._sideOrientationHint=!1,this._inheritVisibility=!1}}class jt extends Vt{static get BILLBOARDMODE_NONE(){return Vt.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return Vt.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return Vt.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return Vt.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return Vt.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return Vt.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return!!super._updateNonUniformScalingState(e)&&(this._markSubMeshesAsMiscDirty(),!0)}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(1===t&&1!==e||1!==t&&1===e)&&this._markSubMeshesAsDirty(e=>{e.markAsMiscDirty(),e.markAsPrePassDirty()})}get inheritVisibility(){return this._internalAbstractMeshDataInfo._inheritVisibility}set inheritVisibility(e){this._internalAbstractMeshDataInfo._inheritVisibility=e}get isVisible(){if(!this._isVisible||!this.inheritVisibility||!this._parentNode)return this._isVisible;if(this._isVisible){let e=this._parentNode;for(;e;){const t=e.isVisible;if(void 0!==t)return t;e=e.parent}}return this._isVisible}set isVisible(e){this._isVisible=e}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._setMaterial(e)}_setMaterial(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(void 0,null==e),this._unBindEffect()))}getMaterialForRenderPass(e){var t;return null===(t=this._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===t?void 0:t[e]}setMaterialForRenderPass(e,t){var n;this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]);const i=this._internalAbstractMeshDataInfo._materialForRenderPass[e];null!=i&&null!==(n=i.meshMap)&&void 0!==n&&n[this.uniqueId]&&(i.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this)}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+("InstancedMesh"!==this.getClassName()?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const n=this._internalAbstractMeshDataInfo._skeleton;return n&&(t+=", skeleton: "+n.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==Vt.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive)){if(!e)return this.actionManager;if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),null!==this._occlusionQuery&&(this._occlusionQuery=null),this.subMeshes){for(const e of this.subMeshes)e._rebuild();this.resetDrawCache()}}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),n=this._lightSources.indexOf(e);let i=!1;if(-1===n){if(!t)return;this._lightSources.push(e)}else{if(t)return;i=!0,this._lightSources.splice(n,1)}this._markSubMeshesAsLightDirty(i)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){const n=this._lightSources.indexOf(e);-1!==n&&(this._lightSources.splice(n,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(const t of this.subMeshes)for(let n=0;n<t._drawWrappers.length;++n){const i=t._drawWrappers[n];i&&i.defines&&i.defines.markAllAsDirty&&e(i.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(t=>t.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,super.markAsDirty(e),this._isDirty=!0,this}resetDrawCache(e,t=!1){if(this.subMeshes)for(const n of this.subMeshes)n.resetDrawCache(e,t)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,n,i){return this}updateVerticesData(e,t,n,i){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){var e;return null!==(e=this.rawBoundingInfo)&&void 0!==e?e:this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return null!==this._boundingInfo}buildBoundingInfo(e,t,n){return this._boundingInfo=new ne(e,t,n),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,n){return super.normalizeToUnitCube(e,t,n)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(z.b.MatricesIndicesKind)&&this.isVerticesDataPresent(z.b.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===Vt.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,n){return this.position.addInPlace(this.calcMovePOV(e,t,n)),this}calcMovePOV(e,t,n){const i=new r.a;(this.rotationQuaternion?this.rotationQuaternion:r.b.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(i);const s=r.e.Zero(),a=this.definedFacingForward?-1:1;return r.e.TransformCoordinatesFromFloatsToRef(e*a,t,n*a,i,s),s}rotatePOV(e,t,n){return this.rotation.addInPlace(this.calcRotatePOV(e,t,n)),this}calcRotatePOV(e,t,n){const i=this.definedFacingForward?1:-1;return new r.e(e*i,t,n*i)}_refreshBoundingInfo(e,t){if(e){const n=re(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(n.minimum,n.maximum):this._boundingInfo=new ne(n.minimum,n.maximum)}if(this.subMeshes)for(let t=0;t<this.subMeshes.length;t++)this.subMeshes[t].refreshBoundingInfo(e);this._updateBoundingInfo()}_refreshBoundingInfoDirect(e){if(this._boundingInfo?this._boundingInfo.reConstruct(e.minimum,e.maximum):this._boundingInfo=new ne(e.minimum,e.maximum),this.subMeshes)for(let e=0;e<this.subMeshes.length;e++)this.subMeshes[e].refreshBoundingInfo(null);this._updateBoundingInfo()}static _ApplySkeleton(e,t,n,i,s,a,o){!function(e,t,n,i,s,a,o){const l=r.c.Vector3[0],c=r.c.Matrix[0],d=r.c.Matrix[1],h=t===z.b.NormalKind?r.e.TransformNormalFromFloatsToRef:r.e.TransformCoordinatesFromFloatsToRef;for(let t=0,u=0;t<e.length;t+=3,u+=4){let f,m;for(c.reset(),f=0;f<4;f++)m=s[u+f],m>0&&(r.a.FromFloat32ArrayToRefScaled(n,Math.floor(16*i[u+f]),m,d),c.addToSelf(d));if(a&&o)for(f=0;f<4;f++)m=o[u+f],m>0&&(r.a.FromFloat32ArrayToRefScaled(n,Math.floor(16*a[u+f]),m,d),c.addToSelf(d));h(e[t],e[t+1],e[t+2],c,l),l.toArray(e,t)}}(e,t,n,i,s,a,o)}_getData(e,t,n=z.b.PositionKind){const i=e.cache,s=e=>{if(i){const t=i._vertexData||(i._vertexData={});return t[e]||this.copyVerticesData(e,t),t[e]}return this.getVerticesData(e)};if(t||(t=s(n)),!t)return null;if(i?(i._outputData?i._outputData.set(t):i._outputData=new Float32Array(t),t=i._outputData):(e.applyMorph&&this.morphTargetManager||e.applySkeleton&&this.skeleton)&&(t=t.slice()),e.applyMorph&&this.morphTargetManager&&function(e,t,n){let i=null;switch(t){case z.b.PositionKind:i=e=>e.getPositions();break;case z.b.NormalKind:i=e=>e.getNormals();break;case z.b.TangentKind:i=e=>e.getTangents();break;case z.b.UVKind:i=e=>e.getUVs();break;case z.b.UV2Kind:i=e=>e.getUV2s();break;case z.b.ColorKind:i=e=>e.getColors();break;default:return}for(let t=0;t<e.length;t++){let r=e[t];for(let s=0;s<n.numTargets;s++){const a=n.getTarget(s),o=a.influence;if(0!==o){const n=i(a);n&&(r+=(n[t]-e[t])*o)}}e[t]=r}}(t,n,this.morphTargetManager),e.applySkeleton&&this.skeleton){const e=s(z.b.MatricesIndicesKind),i=s(z.b.MatricesWeightsKind);if(i&&e){const r=this.numBoneInfluencers>4,a=r?s(z.b.MatricesIndicesExtraKind):null,o=r?s(z.b.MatricesWeightsExtraKind):null,l=this.skeleton.getTransformMatrices(this);jt._ApplySkeleton(t,n,l,e,i,a,o)}}if(!1!==e.updatePositionsArray&&n===z.b.PositionKind){const e=this._internalAbstractMeshDataInfo._positions||[],n=e.length;if(e.length=t.length/3,n<e.length)for(let t=n;t<e.length;t++)e[t]=new r.e;for(let n=0,i=0;n<e.length;n++,i+=3)e[n].copyFromFloats(t[i],t[i+1],t[i+2]);this._internalAbstractMeshDataInfo._positions=e}return t}getNormalsData(e=!1,t=!1){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},null,z.b.NormalKind)}getPositionData(e=!1,t=!1,n=null){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},n,z.b.PositionKind)}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new ne(r.e.Zero(),r.e.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let n=0;n<t;n++){const i=this.subMeshes[n];(t>1||!i.IsGlobal)&&i.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,n){const i=this.getBoundingInfo(),r=e.getBoundingInfo();if(i.intersects(r,t))return!0;if(n)for(const n of this.getChildMeshes())if(n.intersectsMesh(e,t,!0))return!0;return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const t=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=t.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,t.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,n){var i;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const n=e.verticesStart,i=e.verticesStart+e.verticesCount;for(let s=n;s<i;s++)e._lastColliderWorldVertices.push(r.e.TransformCoordinates(this._positions[s],t))}return n._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),7===(null===(i=e.getMaterial())||void 0===i?void 0:i.fillMode)),this}_processCollisionsForSubMeshes(e,t){const n=this._scene.getCollidingSubMeshCandidates(this,e),i=n.length;for(let r=0;r<i;r++){const s=n.data[r];i>1&&!s._checkCollision(e)||this._collideForSubMesh(s,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=r.c.Matrix[0],n=r.c.Matrix[1];return r.a.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,n),this._processCollisionsForSubMeshes(e,n),this}_generatePointsArray(){return!1}intersects(e,t,n,i=!1,s,a=!1){const o=new Gt.a,l=this.getClassName(),c="InstancedLinesMesh"===l||"LinesMesh"===l||"GreasedLineMesh"===l?this.intersectionThreshold:0,d=this.getBoundingInfo();if(!this.subMeshes)return o;if(!(a||e.intersectsSphere(d.boundingSphere,c)&&e.intersectsBox(d.boundingBox,c)))return o;if(i)return o.hit=!a,o.pickedMesh=a?null:this,o.distance=a?0:r.e.Distance(e.origin,d.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let h=null;const u=this._scene.getIntersectingSubMeshCandidates(this,e),f=u.length;let m=!1;for(let e=0;e<f;e++){const t=u.data[e].getMaterial();if(t&&(7==t.fillMode||0==t.fillMode||1==t.fillMode||2==t.fillMode||4==t.fillMode)){m=!0;break}}if(!m)return o.hit=!0,o.pickedMesh=this,o.distance=r.e.Distance(e.origin,d.boundingSphere.center),o.subMeshId=-1,o;for(let i=0;i<f;i++){const r=u.data[i];if(f>1&&!a&&!r.canIntersects(e))continue;const s=r.intersects(e,this._positions,this.getIndices(),t,n);if(s&&(t||!h||s.distance<h.distance)&&(h=s,h.subMeshId=i,t))break}if(h){const t=null!=s?s:this.getWorldMatrix(),n=r.c.Vector3[0],i=r.c.Vector3[1];r.e.TransformCoordinatesToRef(e.origin,t,n),e.direction.scaleToRef(h.distance,i);const a=r.e.TransformNormal(i,t).addInPlace(n);return o.hit=!0,o.distance=r.e.Distance(n,a),o.pickedPoint=a,o.pickedMesh=this,o.bu=h.bu||0,o.bv=h.bv||0,o.subMeshFaceId=h.faceId,o.faceId=h.faceId+u.data[h.subMeshId].indexStart/(-1!==this.getClassName().indexOf("LinesMesh")?2:3),o.subMeshId=h.subMeshId,o}return o}clone(e,t,n){return null}releaseSubMeshes(e=!1){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose(e);else this.subMeshes=[];return this}dispose(e,t=!1){let n;const i=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),i.freeActiveMeshes(),i.freeRenderingGroups(),i.renderingManager.maintainStateBetweenFrames&&i.renderingManager.restoreDispachedFlags(),void 0!==this.actionManager&&null!==this.actionManager&&(this.actionManager.disposeWhenUnowned&&!this._scene.meshes.some(e=>e!==this&&e.actionManager===this.actionManager)&&this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),n=0;n<this._intersectionsInProgress.length;n++){const e=this._intersectionsInProgress[n],t=e._intersectionsInProgress.indexOf(this);e._intersectionsInProgress.splice(t,1)}this._intersectionsInProgress.length=0,i.lights.forEach(e=>{let t=e.includedOnlyMeshes.indexOf(this);-1!==t&&e.includedOnlyMeshes.splice(t,1),t=e.excludedMeshes.indexOf(this),-1!==t&&e.excludedMeshes.splice(t,1);const n=e.getShadowGenerators();if(n){const e=n.values();for(let n=e.next();!0!==n.done;n=e.next()){const e=n.value.getShadowMap();e&&e.renderList&&(t=e.renderList.indexOf(this),-1!==t&&e.renderList.splice(t,1))}}}),"InstancedMesh"===this.getClassName()&&"InstancedLinesMesh"===this.getClassName()||this.releaseSubMeshes(!0);const r=i.getEngine();if(null!==this._occlusionQuery&&(this.isOcclusionQueryInProgress=!1,r.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),r.wipeCaches(),i.removeMesh(this),this._parentContainer){const e=this._parentContainer.meshes.indexOf(this);e>-1&&this._parentContainer.meshes.splice(e,1),this._parentContainer=null}if(t&&this.material&&("MultiMaterial"===this.material.getClassName()?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(n=0;n<i.particleSystems.length;n++)i.particleSystems[n].emitter===this&&(i.particleSystems[n].dispose(),n--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=[]),e.facetPositions||(e.facetPositions=[]),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=r.e.Zero(),e.facetPositions[t]=r.e.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(z.b.PositionKind),n=this.getIndices(),i=this.getVerticesData(z.b.NormalKind),s=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,n instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(n);else if(n instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(n);else{let t=!1;for(let e=0;e<n.length;e++)if(n[e]>65535){t=!0;break}e.depthSortedIndices=t?new Uint32Array(n):new Uint16Array(n)}if(e.facetDepthSortFunction=function(e,t){return t.sqDistance-e.sqDistance},!e.facetDepthSortFrom){const t=this.getScene().activeCamera;e.facetDepthSortFrom=t?t.position:r.e.Zero()}e.depthSortedFacets=[];for(let t=0;t<e.facetNb;t++){const n={ind:3*t,sqDistance:0};e.depthSortedFacets.push(n)}e.invertedMatrix=r.a.Identity(),e.facetDepthSortOrigin=r.e.Zero()}e.bbSize.x=s.maximum.x-s.minimum.x>q.a?s.maximum.x-s.minimum.x:q.a,e.bbSize.y=s.maximum.y-s.minimum.y>q.a?s.maximum.y-s.minimum.y:q.a,e.bbSize.z=s.maximum.z-s.minimum.z>q.a?s.maximum.z-s.minimum.z:q.a;let a=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(a=a>e.bbSize.z?a:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/a),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/a),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/a),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=s,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),r.e.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,i&&Ft.ComputeNormals(t,n,i,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const t=e.depthSortedIndices.length/3|0;for(let i=0;i<t;i++){const t=e.depthSortedFacets[i].ind;e.depthSortedIndices[3*i]=n[t],e.depthSortedIndices[3*i+1]=n[t+1],e.depthSortedIndices[3*i+2]=n[t+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=r.e.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const n=this.getFacetLocalPositions()[e],i=this.getWorldMatrix();return r.e.TransformCoordinatesToRef(n,i,t),this}getFacetNormal(e){const t=r.e.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const n=this.getFacetLocalNormals()[e];return r.e.TransformNormalToRef(n,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,n){const i=this.getBoundingInfo(),r=this._internalAbstractMeshDataInfo._facetData,s=Math.floor((e-i.minimum.x*r.partitioningBBoxRatio)*r.subDiv.X*r.partitioningBBoxRatio/r.bbSize.x),a=Math.floor((t-i.minimum.y*r.partitioningBBoxRatio)*r.subDiv.Y*r.partitioningBBoxRatio/r.bbSize.y),o=Math.floor((n-i.minimum.z*r.partitioningBBoxRatio)*r.subDiv.Z*r.partitioningBBoxRatio/r.bbSize.z);return s<0||s>r.subDiv.max||a<0||a>r.subDiv.max||o<0||o>r.subDiv.max?null:r.facetPartitioning[s+r.subDiv.max*a+r.subDiv.max*r.subDiv.max*o]}getClosestFacetAtCoordinates(e,t,n,i,s=!1,a=!0){const o=this.getWorldMatrix(),l=r.c.Matrix[5];o.invertToRef(l);const c=r.c.Vector3[8];r.e.TransformCoordinatesFromFloatsToRef(e,t,n,l,c);const d=this.getClosestFacetAtLocalCoordinates(c.x,c.y,c.z,i,s,a);return i&&r.e.TransformCoordinatesFromFloatsToRef(i.x,i.y,i.z,o,i),d}getClosestFacetAtLocalCoordinates(e,t,n,i,r=!1,s=!0){let a=null,o=0,l=0,c=0,d=0,h=0,u=0,f=0,m=0;const p=this.getFacetLocalPositions(),g=this.getFacetLocalNormals(),_=this.getFacetsAtLocalCoordinates(e,t,n);if(!_)return null;let v,E,T,S=Number.MAX_VALUE,A=S;for(let b=0;b<_.length;b++)v=_[b],E=g[v],T=p[v],d=(e-T.x)*E.x+(t-T.y)*E.y+(n-T.z)*E.z,(!r||r&&s&&d>=0||r&&!s&&d<=0)&&(d=E.x*T.x+E.y*T.y+E.z*T.z,h=-(E.x*e+E.y*t+E.z*n-d)/(E.x*E.x+E.y*E.y+E.z*E.z),u=e+E.x*h,f=t+E.y*h,m=n+E.z*h,o=u-e,l=f-t,c=m-n,A=o*o+l*l+c*c,A<S&&(S=A,a=v,i&&(i.x=u,i.y=f,i.z=m)));return a}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=[],e.facetNormals=[],e.facetPartitioning=new Array,e.facetParameters={},e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,n=!1){return this}createNormals(e){const t=this.getVerticesData(z.b.PositionKind),n=this.getIndices();let i;return i=this.isVerticesDataPresent(z.b.NormalKind)?this.getVerticesData(z.b.NormalKind):[],Ft.ComputeNormals(t,n,i,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(z.b.NormalKind,i,e),this}async optimizeIndicesAsync(){const e=this.getIndices();if(!e)return this;const{OptimizeIndices:t}=await n.e(0).then(n.bind(null,526));return t(e),this.setIndices(e,this.getTotalVertices()),this}alignWithNormal(e,t){t||(t=mt.a.Y);const n=r.c.Vector3[0],i=r.c.Vector3[1];return r.e.CrossToRef(t,e,i),r.e.CrossToRef(e,i,n),this.rotationQuaternion?r.b.RotationQuaternionFromAxisToRef(n,e,i,this.rotationQuaternion):r.e.RotationFromAxisToRef(n,e,i,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw Object(ht.a)("EdgesRenderer")}enableEdgesRendering(e,t,n){throw Object(ht.a)("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new Xt,this._waitingMaterialId=null,this._waitingMorphTargetManagerId=null,this.cullingStrategy=jt.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new _.a,this.onCollisionPositionChangeObservable=new _.a,this.onMaterialChangedObservable=new _.a,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this._isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=he.a.Red(),this.outlineWidth=.02,this.overlayColor=he.a.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new r.e(.5,1,.5),this.ellipsoidOffset=new r.e(0,0,0),this.edgesWidth=1,this.edgesColor=new he.b(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new _.a,this._onCollisionPositionChange=(e,t,n=null)=>{t.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>C.a.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),n&&this.onCollideObservable.notifyObservers(n),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},(t=this.getScene()).addMesh(this),this._resyncLightSources(),this._uniformBuffer=new oe.a(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case 2:this.doNotSyncBoundingInfo=!0;case 1:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1}}}jt.OCCLUSION_TYPE_NONE=0,jt.OCCLUSION_TYPE_OPTIMISTIC=1,jt.OCCLUSION_TYPE_STRICT=2,jt.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,jt.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,jt.CULLINGSTRATEGY_STANDARD=0,jt.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,jt.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,jt.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,Object(W.a)([X.b.filter((...[e,t,n,i,r])=>!(Array.isArray(e)||Array.isArray(t)||Array.isArray(n)||Array.isArray(i)||Array.isArray(r)))],jt,"_ApplySkeleton",null),Object(Je.b)("BABYLON.AbstractMesh",jt);class zt extends je{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}_hookArray(e){const t=e.push;e.push=(...n)=>{const i=t.apply(e,n);return this._markAllSubMeshesAsTexturesDirty(),i};const n=e.splice;e.splice=(t,i)=>{const r=n.apply(e,[t,i]);return this._markAllSubMeshesAsTexturesDirty(),r}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){if(super.hasTexture(e))return!0;for(let n=0;n<this.subMaterials.length;n++){var t;if(null!==(t=this.subMaterials[n])&&void 0!==t&&t.hasTexture(e))return!0}return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,n){for(let i=0;i<this.subMaterials.length;i++){const r=this.subMaterials[i];if(r){if(r._storeEffectOnSubMeshes){if(!r.isReadyForSubMesh(e,t,n))return!1;continue}if(!r.isReady(e))return!1}}return!0}clone(e,t){const n=new zt(e,this.getScene());for(let i=0;i<this.subMaterials.length;i++){let r=null;const s=this.subMaterials[i];r=t&&s?s.clone(e+"-"+s.name):this.subMaterials[i],n.subMaterials.push(r)}return n}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,xt.a&&(e.tags=xt.a.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const n=this.subMaterials[t];n?(e.materialsUniqueIds.push(n.uniqueId),e.materials.push(n.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,n){const i=this.getScene();if(!i)return;if(n)for(let n=0;n<this.subMaterials.length;n++){const i=this.subMaterials[n];i&&i.dispose(e,t)}const r=i.multiMaterials.indexOf(this);r>=0&&i.multiMaterials.splice(r,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const n=new zt(e.name,t);return n.id=e.id,n._loadedUniqueId=e.uniqueId,xt.a&&xt.a.AddTagsTo(n,e.tags),e.materialsUniqueIds?n._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(e=>n.subMaterials.push(t.getLastMaterialById(e))),n}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}}Object(Je.b)("BABYLON.MultiMaterial",zt);var Kt=n(340);class Yt{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class qt{constructor(){this.visibleInstances={},this.batchCache=new Qt,this.batchCacheReplacementModeInFrozenMode=new Qt,this.instancesBufferSize=2048}}class Qt{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[]}}class Zt{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class $t{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}const Jt={source:null,parent:null,doNotCloneChildren:!1,clonePhysicsImpostor:!0,cloneThinInstances:!1};class en extends jt{static _GetDefaultSideOrientation(e){return e||en.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(z.b.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(z.b.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new _.a),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new _.a),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new _.a),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new _.a),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new _.a),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get sideOrientation(){return this._internalMeshDataInfo._sideOrientation}set sideOrientation(e){this._internalMeshDataInfo._sideOrientation=e,this._internalAbstractMeshDataInfo._sideOrientationHint=this._scene.useRightHandedSystem&&1===e||!this._scene.useRightHandedSystem&&0===e}get overrideMaterialSideOrientation(){return this.sideOrientation}set overrideMaterialSideOrientation(e){this.sideOrientation=e,this.material&&(this.material.sideOrientation=null)}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){e&&(this.material&&null===this.material.sideOrientation||this._internalAbstractMeshDataInfo._sideOrientationHint)&&(e.sideOrientation=null),this._setMaterial(e)}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}_copySource(e,t,n=!0,i=!1){const r=this.getScene();if(e._geometry&&e._geometry.applyToMesh(this),Ot.a.DeepCopy(e,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=e,r.useClonedMeshMap&&(e._internalMeshDataInfo.meshMap||(e._internalMeshDataInfo.meshMap={}),e._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=e._originalBuilderSideOrientation,this._creationDataStorage=e._creationDataStorage,e._ranges){const t=e._ranges;for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&t[e]&&this.createAnimationRange(e,t[e].from,t[e].to)}if(e.metadata&&e.metadata.clone?this.metadata=e.metadata.clone():this.metadata=e.metadata,this._internalMetadata=e._internalMetadata,xt.a&&xt.a.HasTags(e)&&xt.a.AddTagsTo(this,xt.a.GetTags(e,!0)),this.setEnabled(e.isEnabled(!1)),this.parent=e.parent,this.setPivotMatrix(e.getPivotMatrix(),this._postMultiplyPivotMatrix),this.id=this.name+"."+e.id,this.material=e.material,!t){const r=e.getDescendants(!0);for(let e=0;e<r.length;e++){const s=r[e];s._isMesh?(Jt.parent=this,Jt.doNotCloneChildren=t,Jt.clonePhysicsImpostor=n,Jt.cloneThinInstances=i,s.clone(this.name+"."+s.name,Jt)):s.clone&&s.clone(this.name+"."+s.name,this)}}if(e.morphTargetManager&&(this.morphTargetManager=e.morphTargetManager),r.getPhysicsEngine){const t=r.getPhysicsEngine();if(n&&t)if(1===t.getPluginVersion()){const n=t.getImpostorForPhysicsObject(e);n&&(this.physicsImpostor=n.clone(this))}else 2===t.getPluginVersion()&&e.physicsBody&&e.physicsBody.clone(this)}for(let t=0;t<r.particleSystems.length;t++){const n=r.particleSystems[t];n.emitter===e&&n.clone(n.name,this)}if(this.skeleton=e.skeleton,i&&(e._thinInstanceDataStorage.matrixData?(this.thinInstanceSetBuffer("matrix",new Float32Array(e._thinInstanceDataStorage.matrixData),16,!e._thinInstanceDataStorage.matrixBuffer.isUpdatable()),this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,this._thinInstanceDataStorage.instancesCount=e._thinInstanceDataStorage.instancesCount):this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,e._userThinInstanceBuffersStorage)){const t=e._userThinInstanceBuffersStorage;for(const e in t.data){var s;this.thinInstanceSetBuffer(e,new Float32Array(t.data[e]),t.strides[e],!(null!==(s=t.vertexBuffers)&&void 0!==s&&null!==(s=s[e])&&void 0!==s&&s.isUpdatable())),this._userThinInstanceBuffersStorage.sizes[e]=t.sizes[e]}}this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}instantiateHierarchy(e=null,t,n){const i=0===this.getTotalVertices()||t&&t.doNotInstantiate&&(!0===t.doNotInstantiate||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));i.parent=e||this.parent,i.position=this.position.clone(),i.scaling=this.scaling.clone(),this.rotationQuaternion?i.rotationQuaternion=this.rotationQuaternion.clone():i.rotation=this.rotation.clone(),n&&n(this,i);for(const e of this.getChildTransformNodes(!0))"InstancedMesh"===e.getClassName()&&"Mesh"===i.getClassName()&&e.sourceMesh===this?e.instantiateHierarchy(i,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:i},n):e.instantiateHierarchy(i,t,n);return i}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let n=0;n<this.animations.length;n++)t+=", animation[0]: "+this.animations[n].toString(e);if(e)if(this._geometry){const e=this.getIndices(),n=this.getVerticesData(z.b.PositionKind);n&&e&&(t+=", flat shading: "+(n.length/3===e.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,n)=>t.distanceOrScreenCoverage<n.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>n.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return T.a.Warn("You cannot use a mesh as LOD level twice"),this;const n=new Yt(e,t);return this._internalMeshDataInfo._LODLevels.push(n),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let n=0;n<t._LODLevels.length;n++){const i=t._LODLevels[n];if(i.distanceOrScreenCoverage===e)return i.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let n=0;n<t._LODLevels.length;n++)t._LODLevels[n].mesh===e&&(t._LODLevels.splice(n,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const n=this._internalMeshDataInfo;if(!n._LODLevels||0===n._LODLevels.length)return this;const i=t||this.getBoundingInfo().boundingSphere,r=e.mode===ft.ORTHOGRAPHIC_CAMERA?e.minZ:i.centerWorld.subtract(e.globalPosition).length();let s=r,a=1;if(n._useLODScreenCoverage){const t=e.screenArea;let n=i.radiusWorld*e.minZ/r;n=n*n*Math.PI,s=n/t,a=-1}if(a*n._LODLevels[n._LODLevels.length-1].distanceOrScreenCoverage>a*s)return this.onLODLevelSelection&&this.onLODLevelSelection(s,this,this),this;for(let e=0;e<n._LODLevels.length;e++){const t=n._LODLevels[e];if(a*t.distanceOrScreenCoverage<a*s){if(t.mesh){if(4===t.mesh.delayLoadState)return t.mesh._checkDelayState(),this;if(2===t.mesh.delayLoadState)return this;t.mesh._preActivate(),t.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(s,this,t.mesh),t.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(s,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return null===this._geometry||void 0===this._geometry?0:this._geometry.getTotalVertices()}getVerticesData(e,t,n,i){var r;if(!this._geometry)return null;let s=i||null===(r=this._userInstancedBuffersStorage)||void 0===r||null===(r=r.vertexBuffers[e])||void 0===r?void 0:r.getFloatData(this.instances.length+1,n||t&&1!==this._geometry.meshes.length);return s||(s=this._geometry.getVerticesData(e,t,n)),s}copyVerticesData(e,t){this._geometry&&this._geometry.copyVerticesData(e,t)}getVertexBuffer(e,t){var n,i;return this._geometry?null!==(n=t||null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])&&void 0!==n?n:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){var n;return this._geometry?!t&&void 0!==(null===(n=this._userInstancedBuffersStorage)||void 0===n?void 0:n.vertexBuffers[e])||this._geometry.isVerticesDataPresent(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}isVertexBufferUpdatable(e,t){if(!this._geometry)return!!this._delayInfo&&-1!==this._delayInfo.indexOf(e);if(!t){var n;const t=null===(n=this._userInstancedBuffersStorage)||void 0===n?void 0:n.vertexBuffers[e];if(t)return t.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const e=[];return this._delayInfo&&this._delayInfo.forEach((function(t){e.push(t)})),e}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const e in this._userInstancedBuffersStorage.vertexBuffers)-1===t.indexOf(e)&&t.push(e);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return null!==this._masterMesh&&void 0!==this._masterMesh}isReady(e=!1,t=!1){if(2===this.delayLoadState)return!1;if(!super.isReady(e))return!1;if(!this.subMeshes||0===this.subMeshes.length)return!0;if(!e)return!0;const n=this.getEngine(),i=this.getScene(),r=t||n.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const s=this.material||i.defaultMaterial;if(s)if(s._storeEffectOnSubMeshes)for(const e of this.subMeshes){const t=e.getMaterial();if(t)if(t._storeEffectOnSubMeshes){if(!t.isReadyForSubMesh(this,e,r))return!1}else if(!t.isReady(this,r))return!1}else if(!s.isReady(this,r))return!1;const a=n.currentRenderPassId;for(const e of this.lightSources){const t=e.getShadowGenerators();if(!t)continue;const i=t.values();for(let e=i.next();!0!==e.done;e=i.next()){var o,l,c;const t=e.value;if(t&&(null===(o=t.getShadowMap())||void 0===o||!o.renderList||null!==(l=t.getShadowMap())&&void 0!==l&&l.renderList&&-1!==(null===(c=t.getShadowMap())||void 0===c||null===(c=c.renderList)||void 0===c?void 0:c.indexOf(this)))){var d;const e=null!==(d=t.getShadowMap().renderPassIds)&&void 0!==d?d:[n.currentRenderPassId];for(let i=0;i<e.length;++i){n.currentRenderPassId=e[i];for(const e of this.subMeshes){var h,u;if(!t.isReady(e,r,null!==(h=null===(u=e.getMaterial())||void 0===u?void 0:u.needAlphaBlendingForMesh(this))&&void 0!==h&&h))return n.currentRenderPassId=a,!1}}n.currentRenderPassId=a}}}for(const e of this._internalMeshDataInfo._LODLevels)if(e.mesh&&!e.mesh.isReady(r))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t||(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null),this}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(void 0!==this._instanceDataStorage.previousRenderId&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let n;n="object"==typeof e?e:{applySkeleton:e,applyMorph:t};const i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getData(n,null,z.b.PositionKind),i),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const n=this.getIndices();if(!n)return null;const i=n.length;let r=!1;if(e)r=!0;else for(const e of this.subMeshes){if(e.indexStart+e.indexCount>i){r=!0;break}if(e.verticesStart+e.verticesCount>t){r=!0;break}}if(!r)return this.subMeshes[0]}return this.releaseSubMeshes(),new ae(0,0,t,0,this.getTotalIndices()||t,this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let n=t/e|0,i=0;for(;n%3!=0;)n++;this.releaseSubMeshes();for(let r=0;r<e&&!(i>=t);r++)ae.CreateFromIndices(0,i,r===e-1?t-i:n,this,void 0,!1),i+=n;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,n=!1,i){if(this._geometry)this._geometry.setVerticesData(e,t,n,i);else{const i=new Ft;i.set(t,e);const r=this.getScene();new Bt(Bt.RandomId(),r,i,n,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const n=this.getVertexBuffer(e);n&&n.isUpdatable()!==t&&this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=Bt.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,n,i){return this._geometry?(i?(this.makeGeometryUnique(),this.updateVerticesData(e,t,n,!1)):this._geometry.updateVerticesData(e,t,n),this):this}updateMeshPositions(e,t=!0){const n=this.getVerticesData(z.b.PositionKind);if(!n)return this;if(e(n),this.updateVerticesData(z.b.PositionKind,n,!1,!1),t){const e=this.getIndices(),t=this.getVerticesData(z.b.NormalKind);if(!t)return this;Ft.ComputeNormals(n,e,t),this.updateVerticesData(z.b.NormalKind,t,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(1===this._geometry.meshes.length)return this;const e=this._geometry,t=this._geometry.copy(Bt.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndexBuffer(e,t,n){let i=this._geometry;i||(i=new Bt(Bt.RandomId(),this.getScene(),void 0,void 0,this)),i.setIndexBuffer(e,t,n)}setIndices(e,t=null,n=!1,i=!1){if(this._geometry)this._geometry.setIndices(e,t,n,i);else{const t=new Ft;t.indices=e;const i=this.getScene();new Bt(Bt.RandomId(),i,t,n,this)}return this}updateIndices(e,t,n=!1){return this._geometry?(this._geometry.updateIndices(e,t,n),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,n,i=!0){if(!this._geometry)return this;const r=this.getScene().getEngine();let s;if(this._unIndexed)switch(this._getRenderingFillMode(n)){case je.WireFrameFillMode:s=e._getLinesIndexBuffer(this.getIndices(),r);break;default:s=null}else switch(this._getRenderingFillMode(n)){case je.PointFillMode:s=null;break;case je.WireFrameFillMode:s=e._getLinesIndexBuffer(this.getIndices(),r);break;default:case je.TriangleFillMode:s=this._geometry.getIndexBuffer()}return this._bindDirect(t,s,i)}_bindDirect(e,t,n=!0){return this._geometry?(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(e),n&&this._userInstancedBuffersStorage&&!this.hasThinInstances?this._geometry._bind(e,t,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(e,t),this):this}_draw(e,t,n){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const i=this.getScene().getEngine();return this._unIndexed&&t!==je.WireFrameFillMode||t==je.PointFillMode?i.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||n):t==je.WireFrameFillMode?i.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||n):i.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||n),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const n=this.getScene(),i=n._isInIntermediateRendering(),r=i?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,s=this._instanceDataStorage.batchCache;if(s.mustReturn=!1,s.renderSelf[e]=t||!r&&this.isEnabled()&&this.isVisible,s.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const t=this._instanceDataStorage.visibleInstances,r=n.getRenderId(),a=i?t.intermediateDefaultRenderId:t.defaultRenderId;s.visibleInstances[e]=t[r],!s.visibleInstances[e]&&a&&(s.visibleInstances[e]=t[a])}return s.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&null!==s.visibleInstances[e]&&void 0!==s.visibleInstances[e],this._instanceDataStorage.previousBatch=s,s}_updateInstancedBuffers(e,t,n,i,s,a){const o=t.visibleInstances[e._id],l=o?o.length:0,c=this._instanceDataStorage;let d=c.instancesBuffer,h=c.instancesPreviousBuffer,u=0,f=0;const m=t.renderSelf[e._id],p=!d||n!==c.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousBuffer;if(this._instanceDataStorage.manualUpdate||c.isFrozen&&!p)f=(m?1:0)+l;else{const t=this.getWorldMatrix();if(m&&(this._scene.needsPreviousWorldMatrices&&(c.masterMeshPreviousWorldMatrix?(c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,u),c.masterMeshPreviousWorldMatrix.copyFrom(t)):(c.masterMeshPreviousWorldMatrix=t.clone(),c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,u))),t.copyToArray(c.instancesData,u),u+=16,f++),o){var g;if(en.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&null!==(g=e.getMaterial())&&void 0!==g&&g.needAlphaBlendingForMesh(e.getRenderingMesh())){const e=this._scene.activeCamera.globalPosition;for(let t=0;t<o.length;t++){const n=o[t];n._distanceToCamera=r.e.Distance(n.getBoundingInfo().boundingSphere.centerWorld,e)}o.sort((e,t)=>e._distanceToCamera>t._distanceToCamera?-1:e._distanceToCamera<t._distanceToCamera?1:0)}for(let e=0;e<o.length;e++){const t=o[e],n=t.getWorldMatrix();n.copyToArray(c.instancesData,u),this._scene.needsPreviousWorldMatrices&&(t._previousWorldMatrix?(t._previousWorldMatrix.copyToArray(c.instancesPreviousData,u),t._previousWorldMatrix.copyFrom(n)):(t._previousWorldMatrix=n.clone(),t._previousWorldMatrix.copyToArray(c.instancesPreviousData,u))),u+=16,f++}}}p?(d&&d.dispose(),h&&h.dispose(),d=new z.a(i,c.instancesData,!0,16,!1,!0),c.instancesBuffer=d,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=d.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=d.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=d.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=d.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(h=new z.a(i,c.instancesPreviousData,!0,16,!1,!0),c.instancesPreviousBuffer=h,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=h.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=h.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=h.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=h.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||(d.updateDirectly(c.instancesData,0,f),!this._scene.needsPreviousWorldMatrices||this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.previousManualUpdate||h.updateDirectly(c.instancesPreviousData,0,f)),this._processInstancedBuffers(o,m),a&&void 0!==s&&(this.getScene()._activeIndices.addCount(e.indexCount*f,!1),i._currentDrawContext&&(i._currentDrawContext.useInstancing=!0),this._bind(e,a,s),this._draw(e,s,f)),!this._scene.needsPreviousWorldMatrices||p||!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||this._instanceDataStorage.previousManualUpdate||h.updateDirectly(c.instancesData,0,f)}_renderWithInstances(e,t,n,i,r){const s=n.visibleInstances[e._id],a=s?s.length:0,o=this._instanceDataStorage,l=o.instancesBufferSize,c=16*(a+1)*4;for(;o.instancesBufferSize<c;)o.instancesBufferSize*=2;return o.instancesData&&l==o.instancesBufferSize||(o.instancesData=new Float32Array(o.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!o.instancesPreviousData||l!=o.instancesBufferSize)&&(o.instancesPreviousData=new Float32Array(o.instancesBufferSize/4)),this._updateInstancedBuffers(e,n,l,r,t,i),r.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,n,i){var r,s;const a=null!==(r=null===(s=this._thinInstanceDataStorage)||void 0===s?void 0:s.instancesCount)&&void 0!==r?r:0;this.getScene()._activeIndices.addCount(e.indexCount*a,!1),i._currentDrawContext&&(i._currentDrawContext.useInstancing=!0),this._bind(e,n,t),this._draw(e,t,a),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,a):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),i.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,n,i,r,s,a,o){const l=this.getScene(),c=l.getEngine();if(i=this._getRenderingFillMode(i),s&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,i,n,c),this;if(s)this._renderWithInstances(t,i,r,n,c);else{c._currentDrawContext&&(c._currentDrawContext.useInstancing=!1);let n=0;r.renderSelf[t._id]&&(a&&a(!1,e.getWorldMatrix(),o),n++,this._draw(t,i,this._instanceDataStorage.overridenInstanceCount));const s=r.visibleInstances[t._id];if(s){const e=s.length;n+=e;for(let n=0;n<e;n++){const e=s[n].getWorldMatrix();a&&a(!0,e,o),this._draw(t,i)}}l._activeIndices.addCount(t.indexCount*n,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const n=this._userInstancedBuffersStorage.vertexBuffers[t];n&&(e&&n.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}renderWithRenderPassId(e,t,n,i,r=!0){const s=this._scene.getEngine(),a=s.currentRenderPassId;if(void 0!==e&&(s.currentRenderPassId=e),i)(!r||r&&i.isInFrustum(this._scene._frustumPlanes))&&this.render(i,!!t,n);else for(let e=0;e<this.subMeshes.length;e++){const i=this.subMeshes[e];(!r||r&&i.isInFrustum(this._scene._frustumPlanes))&&this.render(i,!!t,n)}return void 0!==e&&(s.currentRenderPassId=a),this}directRender(){if(!this.subMeshes)return this;for(const e of this.subMeshes)this.render(e,!1);return this}render(e,t,n){var i,r,s,a,o;const l=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1;const c=null!==(i=null===(r=l.activeCameras)||void 0===r?void 0:r.length)&&void 0!==i?i:0;if((c>1&&l.activeCamera===l.activeCameras[0]||c<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const d=this._getInstancesRenderList(e._id,!!n);if(d.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const h=l.getEngine();let u=0,f=null;this.ignoreCameraMaxZ&&l.activeCamera&&!l._isInIntermediateRendering()&&(u=l.activeCamera.maxZ,f=l.activeCamera,l.activeCamera.maxZ=0,l.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const m=e.getRenderingMesh(),p=d.hardwareInstancedRendering[e._id]||m.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,g=this._instanceDataStorage,_=e.getMaterial();if(!_)return f&&(f.maxZ=u,l.updateTransformMatrix(!0)),this;if(g.isFrozen&&this._internalMeshDataInfo._effectiveMaterial&&this._internalMeshDataInfo._effectiveMaterial===_){if(_._storeEffectOnSubMeshes&&(null===(s=e._drawWrapper)||void 0===s||!s._wasPreviouslyReady)||!_._storeEffectOnSubMeshes&&!_._getDrawWrapper()._wasPreviouslyReady)return f&&(f.maxZ=u,l.updateTransformMatrix(!0)),this}else{if(_._storeEffectOnSubMeshes){if(!_.isReadyForSubMesh(this,e,p))return f&&(f.maxZ=u,l.updateTransformMatrix(!0)),this}else if(!_.isReady(this,p))return f&&(f.maxZ=u,l.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=_}let v;t&&h.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode),v=this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?e._drawWrapper:this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const E=null!==(a=null===(o=v)||void 0===o?void 0:o.effect)&&void 0!==a?a:null;for(const t of l._beforeRenderingMeshStage)t.action(this,e,d,E);if(!v||!E)return f&&(f.maxZ=u,l.updateTransformMatrix(!0)),this;const T=n||this;let S;if(g.isFrozen||!this._internalMeshDataInfo._effectiveMaterial.backFaceCulling&&null===this._internalMeshDataInfo._effectiveMaterial.sideOrientation&&!this._internalMeshDataInfo._effectiveMaterial.twoSidedLighting)S=g.sideOrientation;else{const e=T._getWorldMatrixDeterminant();S=this._internalMeshDataInfo._effectiveMaterial._getEffectiveOrientation(this),e<0&&(S=S===je.ClockWiseSideOrientation?je.CounterClockWiseSideOrientation:je.ClockWiseSideOrientation),g.sideOrientation=S}const A=this._internalMeshDataInfo._effectiveMaterial._preBind(v,S);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&h.setDepthWrite(!0);const b=this._internalMeshDataInfo._effectiveMaterial,I=b.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),p||this._bind(e,E,I,!1);const R=T.getWorldMatrix();b._storeEffectOnSubMeshes?b.bindForSubMesh(R,this,e):b.bind(R,this),!b.backFaceCulling&&b.separateCullingPass&&(h.setState(!0,b.zOffset,!1,!A,b.cullBackFaces,b.stencil,b.zOffsetUnits),this._processRendering(this,e,E,I,d,p,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),h.setState(!0,b.zOffset,!1,A,b.cullBackFaces,b.stencil,b.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,E,I,d,p,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const t of l._afterRenderingMeshStage)t.action(this,e,d,E);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),f&&(f.maxZ=u,l.updateTransformMatrix(!0)),2!==l.performancePriority||g.isFrozen||this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(z.b.MatricesWeightsKind)&&(this.isVerticesDataPresent(z.b.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(z.b.MatricesWeightsKind),t=e.length;for(let n=0;n<t;n+=4){const t=e[n]+e[n+1]+e[n+2]+e[n+3];if(0===t)e[n]=1;else{const i=1/t;e[n]*=i,e[n+1]*=i,e[n+2]*=i,e[n+3]*=i}}this.setVerticesData(z.b.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(z.b.MatricesWeightsExtraKind),t=this.getVerticesData(z.b.MatricesWeightsKind),n=t.length;for(let i=0;i<n;i+=4){let n=t[i]+t[i+1]+t[i+2]+t[i+3];if(n+=e[i]+e[i+1]+e[i+2]+e[i+3],0===n)t[i]=1;else{const r=1/n;t[i]*=r,t[i+1]*=r,t[i+2]*=r,t[i+3]*=r,e[i]*=r,e[i+1]*=r,e[i+2]*=r,e[i+3]*=r}}this.setVerticesData(z.b.MatricesWeightsKind,t),this.setVerticesData(z.b.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(z.b.MatricesWeightsExtraKind),t=this.getVerticesData(z.b.MatricesWeightsKind);if(null===t||null==this.skeleton)return{skinned:!1,valid:!0,report:"not skinned"};const n=t.length;let i=0,r=0,s=0,a=0;const o=null===e?4:8,l=[];for(let e=0;e<=o;e++)l[e]=0;for(let c=0;c<n;c+=4){let n=t[c],d=n,h=0===d?0:1;for(let r=1;r<o;r++){const s=r<4?t[c+r]:e[c+r-4];s>n&&i++,0!==s&&h++,d+=s,n=s}if(l[h]++,h>s&&(s=h),0===d)r++;else{const n=1/d;let i=0;for(let r=0;r<o;r++)i+=r<4?Math.abs(t[c+r]-t[c+r]*n):Math.abs(e[c+r-4]-e[c+r-4]*n);i>.001&&a++}}const c=this.skeleton.bones.length,d=this.getVerticesData(z.b.MatricesIndicesKind),h=this.getVerticesData(z.b.MatricesIndicesExtraKind);let u=0;for(let e=0;e<n;e+=4)for(let t=0;t<o;t++){const n=t<4?d[e+t]:h[e+t-4];(n>=c||n<0)&&u++}return{skinned:!0,valid:0===r&&0===a&&0===u,report:"Number of Weights = "+n/4+"\nMaximum influences = "+s+"\nMissing Weights = "+r+"\nNot Sorted = "+i+"\nNot Normalized = "+a+"\nWeightCounts = ["+l+"]\nNumber of bones = "+c+"\nBad Bone Indices = "+u}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):4===this.delayLoadState&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return g.b.LoadFile(this.delayLoadingFile,t=>{t instanceof ArrayBuffer?this._delayLoadingFunction(t,this):this._delayLoadingFunction(JSON.parse(t),this),this.instances.forEach(e=>{e.refreshBoundingInfo(),e._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return 2!==this.delayLoadState&&!!super.isInFrustum(e)&&(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let n;for(n=t.length-1;n>-1;n--)if(t[n].id===e)return this.material=t[n],this;const i=this.getScene().multiMaterials;for(n=i.length-1;n>-1;n--)if(i[n].id===e)return this.material=i[n],this;return this}getAnimatables(){const e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(z.b.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let n=this.getVerticesData(z.b.PositionKind);const i=r.e.Zero();let s;for(s=0;s<n.length;s+=3)r.e.TransformCoordinatesFromFloatsToRef(n[s],n[s+1],n[s+2],e,i).toArray(n,s);if(this.setVerticesData(z.b.PositionKind,n,this.getVertexBuffer(z.b.PositionKind).isUpdatable()),this.isVerticesDataPresent(z.b.NormalKind)){for(n=this.getVerticesData(z.b.NormalKind),s=0;s<n.length;s+=3)r.e.TransformNormalFromFloatsToRef(n[s],n[s+1],n[s+2],e,i).normalize().toArray(n,s);this.setVerticesData(z.b.NormalKind,n,this.getVertexBuffer(z.b.NormalKind).isUpdatable())}if(this.isVerticesDataPresent(z.b.TangentKind)){for(n=this.getVerticesData(z.b.TangentKind),s=0;s<n.length;s+=4)r.e.TransformNormalFromFloatsToRef(n[s],n[s+1],n[s+2],e,i).normalize().toArray(n,s);this.setVerticesData(z.b.TangentKind,n,this.getVertexBuffer(z.b.TangentKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0,t=!1){return t&&this.makeGeometryUnique(),this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions||this._geometry&&this._geometry._positions||null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return!!this._geometry&&this._geometry._generatePointsArray()}clone(e="",t=null,n,i=!0){if(t&&void 0===t._addToSceneRootNodes){const n=t;return Jt.source=this,Jt.doNotCloneChildren=n.doNotCloneChildren,Jt.clonePhysicsImpostor=n.clonePhysicsImpostor,Jt.cloneThinInstances=n.cloneThinInstances,new en(e,this.getScene(),Jt)}return new en(e,this.getScene(),t,this,n,i)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const n=this._internalMeshDataInfo;if(n._onBeforeDrawObservable&&n._onBeforeDrawObservable.clear(),n._onBeforeBindObservable&&n._onBeforeBindObservable.clear(),n._onBeforeRenderObservable&&n._onBeforeRenderObservable.clear(),n._onAfterRenderObservable&&n._onAfterRenderObservable.clear(),n._onBetweenPassObservable&&n._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(n.meshMap)for(const e in n.meshMap){const t=n.meshMap[e];t&&(t._internalMeshDataInfo._source=null,n.meshMap[e]=void 0)}n._source&&n._source._internalMeshDataInfo.meshMap&&(n._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const e=this.getScene().meshes;for(const t of e){const e=t;e._internalMeshDataInfo&&e._internalMeshDataInfo._source&&e._internalMeshDataInfo._source===this&&(e._internalMeshDataInfo._source=null)}}n._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,n,i,r,s,a=!1,o){const l=this.getScene();return g.b.LoadImage(e,e=>{const o=e.width,l=e.height,c=this.getEngine().createCanvas(o,l).getContext("2d");c.drawImage(e,0,0);const d=c.getImageData(0,0,o,l).data;this.applyDisplacementMapFromBuffer(d,o,l,t,n,r,s,a),i&&i(this)},o||(()=>{}),l.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,n,i,s,a,o,l=!1){if(!this.isVerticesDataPresent(z.b.PositionKind)||!this.isVerticesDataPresent(z.b.NormalKind)||!this.isVerticesDataPresent(z.b.UVKind))return T.a.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const c=this.getVerticesData(z.b.PositionKind,!0,!0),d=this.getVerticesData(z.b.NormalKind),h=this.getVerticesData(z.b.UVKind);let u=r.e.Zero();const f=r.e.Zero(),m=r.d.Zero();a=a||r.d.Zero(),o=o||new r.d(1,1);for(let l=0;l<c.length;l+=3){r.e.FromArrayToRef(c,l,u),r.e.FromArrayToRef(d,l,f),r.d.FromArrayToRef(h,l/3*2,m);const p=4*((Math.abs(m.x*o.x+a.x%1)*(t-1)%t|0)+(Math.abs(m.y*o.y+a.y%1)*(n-1)%n|0)*t),g=e[p]/255*.3+e[p+1]/255*.59+e[p+2]/255*.11;f.normalize(),f.scaleInPlace(i+(s-i)*g),u=u.add(f),u.toArray(c,l)}return Ft.ComputeNormals(c,this.getIndices(),d),l?(this.setVerticesData(z.b.PositionKind,c),this.setVerticesData(z.b.NormalKind,d),this.setVerticesData(z.b.UVKind,h)):(this.updateVerticesData(z.b.PositionKind,c),this.updateVerticesData(z.b.NormalKind,d)),this}_getFlattenedNormals(e,t){const n=new Float32Array(3*e.length);let i=0;const s=this.sideOrientation===(this._scene.useRightHandedSystem?1:0);for(let a=0;a<e.length;a+=3){const o=r.e.FromArray(t,3*e[a]),l=r.e.FromArray(t,3*e[a+1]),c=r.e.FromArray(t,3*e[a+2]),d=o.subtract(l),h=c.subtract(l),u=r.e.Normalize(r.e.Cross(d,h));s&&u.scaleInPlace(-1);for(let e=0;e<3;e++)n[i++]=u.x,n[i++]=u.y,n[i++]=u.z}return n}_convertToUnIndexedMesh(e=!1){const t=this.getVerticesDataKinds().filter(e=>{var t;return!(null!==(t=this.getVertexBuffer(e))&&void 0!==t&&t.getIsInstanced())}),n=this.getIndices(),i={},r=(e,t)=>{const i=new Float32Array(n.length*t);let r=0;for(let s=0;s<n.length;s++)for(let a=0;a<t;a++)i[r++]=e[n[s]*t+a];return i},s=this.getBoundingInfo(),a=this.geometry?this.subMeshes.slice(0):[];for(const e of t)i[e]=this.getVerticesData(e);for(const s of t){const t=this.getVertexBuffer(s),a=t.getSize();if(e&&s===z.b.NormalKind){const e=this._getFlattenedNormals(n,i[z.b.PositionKind]);this.setVerticesData(z.b.NormalKind,e,t.isUpdatable(),a)}else this.setVerticesData(s,r(i[s],a),t.isUpdatable(),a)}if(this.morphTargetManager){for(let t=0;t<this.morphTargetManager.numTargets;t++){const i=this.morphTargetManager.getTarget(t),s=i.getPositions();i.setPositions(r(s,3));const a=i.getNormals();a&&i.setNormals(e?this._getFlattenedNormals(n,s):r(a,3));const o=i.getTangents();o&&i.setTangents(r(o,3));const l=i.getUVs();l&&i.setUVs(r(l,2));const c=i.getColors();c&&i.setColors(r(c,4))}this.morphTargetManager.synchronize()}for(let e=0;e<n.length;e++)n[e]=e;this.setIndices(n),this._unIndexed=!0,this.releaseSubMeshes();for(const e of a){const t=e.getBoundingInfo();ae.AddToMesh(e.materialIndex,e.indexStart,e.indexCount,e.indexStart,e.indexCount,this).setBoundingInfo(t)}return this.setBoundingInfo(s),this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){const t=Ft.ExtractFromMesh(this);let n;if(e&&this.isVerticesDataPresent(z.b.NormalKind)&&t.normals){for(n=0;n<t.normals.length;n++)t.normals[n]*=-1;this.setVerticesData(z.b.NormalKind,t.normals,this.isVertexBufferUpdatable(z.b.NormalKind))}if(t.indices){let e;for(n=0;n<t.indices.length;n+=3)e=t.indices[n+1],t.indices[n+1]=t.indices[n+2],t.indices[n+2]=e;this.setIndices(t.indices,null,this.isVertexBufferUpdatable(z.b.PositionKind),!0)}return this}increaseVertices(e=1){const t=Ft.ExtractFromMesh(this),n=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,i=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,s=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,a=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(n&&i){t.indices=n,t.positions=i,s&&(t.uvs=s),a&&(t.normals=a);const o=e+1,l=new Array;for(let e=0;e<o+1;e++)l[e]=new Array;let c,d;const h=new r.e(0,0,0),u=new r.e(0,0,0),f=new r.d(0,0),m=new Array,p=new Array,g=new Array;let _,v,E,T=i.length;s&&(v=s.length),a&&(E=a.length);for(let e=0;e<n.length;e+=3){p[0]=n[e],p[1]=n[e+1],p[2]=n[e+2];for(let e=0;e<3;e++)if(c=p[e],d=p[(e+1)%3],void 0===g[c]&&void 0===g[d]?(g[c]=new Array,g[d]=new Array):(void 0===g[c]&&(g[c]=new Array),void 0===g[d]&&(g[d]=new Array)),void 0===g[c][d]&&void 0===g[d][c]){g[c][d]=[],h.x=(i[3*d]-i[3*c])/o,h.y=(i[3*d+1]-i[3*c+1])/o,h.z=(i[3*d+2]-i[3*c+2])/o,a&&(u.x=(a[3*d]-a[3*c])/o,u.y=(a[3*d+1]-a[3*c+1])/o,u.z=(a[3*d+2]-a[3*c+2])/o),s&&(f.x=(s[2*d]-s[2*c])/o,f.y=(s[2*d+1]-s[2*c+1])/o),g[c][d].push(c);for(let e=1;e<o;e++)g[c][d].push(i.length/3),i[T++]=i[3*c]+e*h.x,i[T++]=i[3*c+1]+e*h.y,i[T++]=i[3*c+2]+e*h.z,a&&(a[E++]=a[3*c]+e*u.x,a[E++]=a[3*c+1]+e*u.y,a[E++]=a[3*c+2]+e*u.z),s&&(s[v++]=s[2*c]+e*f.x,s[v++]=s[2*c+1]+e*f.y);g[c][d].push(d),g[d][c]=new Array,_=g[c][d].length;for(let e=0;e<_;e++)g[d][c][e]=g[c][d][_-1-e]}l[0][0]=n[e],l[1][0]=g[n[e]][n[e+1]][1],l[1][1]=g[n[e]][n[e+2]][1];for(let t=2;t<o;t++){l[t][0]=g[n[e]][n[e+1]][t],l[t][t]=g[n[e]][n[e+2]][t],h.x=(i[3*l[t][t]]-i[3*l[t][0]])/t,h.y=(i[3*l[t][t]+1]-i[3*l[t][0]+1])/t,h.z=(i[3*l[t][t]+2]-i[3*l[t][0]+2])/t,a&&(u.x=(a[3*l[t][t]]-a[3*l[t][0]])/t,u.y=(a[3*l[t][t]+1]-a[3*l[t][0]+1])/t,u.z=(a[3*l[t][t]+2]-a[3*l[t][0]+2])/t),s&&(f.x=(s[2*l[t][t]]-s[2*l[t][0]])/t,f.y=(s[2*l[t][t]+1]-s[2*l[t][0]+1])/t);for(let e=1;e<t;e++)l[t][e]=i.length/3,i[T++]=i[3*l[t][0]]+e*h.x,i[T++]=i[3*l[t][0]+1]+e*h.y,i[T++]=i[3*l[t][0]+2]+e*h.z,a&&(a[E++]=a[3*l[t][0]]+e*u.x,a[E++]=a[3*l[t][0]+1]+e*u.y,a[E++]=a[3*l[t][0]+2]+e*u.z),s&&(s[v++]=s[2*l[t][0]]+e*f.x,s[v++]=s[2*l[t][0]+1]+e*f.y)}l[o]=g[n[e+1]][n[e+2]],m.push(l[0][0],l[1][0],l[1][1]);for(let e=1;e<o;e++){let t;for(t=0;t<e;t++)m.push(l[e][t],l[e+1][t],l[e+1][t+1]),m.push(l[e][t],l[e+1][t+1],l[e][t+1]);m.push(l[e][t],l[e+1][t],l[e+1][t+1])}}t.indices=m,t.applyToMesh(this,this.isVertexBufferUpdatable(z.b.PositionKind))}else T.a.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions")}forceSharedVertices(){const e=Ft.ExtractFromMesh(this),t=e.uvs,n=e.indices,i=e.positions,r=e.colors,s=e.matricesIndices,a=e.matricesWeights,o=e.matricesIndicesExtra,l=e.matricesWeightsExtra;if(void 0===n||void 0===i||null===n||null===i)T.a.Warn("VertexData contains empty entries");else{const c=new Array,d=new Array,h=new Array,u=new Array,f=new Array,m=new Array,p=new Array,g=new Array;let _=new Array,v=0;const E={};let T,S;for(let e=0;e<n.length;e+=3){S=[n[e],n[e+1],n[e+2]],_=[];for(let e=0;e<3;e++){_[e]="";for(let t=0;t<3;t++)Math.abs(i[3*S[e]+t])<1e-8&&(i[3*S[e]+t]=0),_[e]+=i[3*S[e]+t]+"|"}if(_[0]!=_[1]&&_[0]!=_[2]&&_[1]!=_[2])for(let e=0;e<3;e++){if(T=E[_[e]],void 0===T){E[_[e]]=v,T=v++;for(let t=0;t<3;t++)c.push(i[3*S[e]+t]);if(null!=r)for(let t=0;t<4;t++)u.push(r[4*S[e]+t]);if(null!=t)for(let n=0;n<2;n++)h.push(t[2*S[e]+n]);if(null!=s)for(let t=0;t<4;t++)f.push(s[4*S[e]+t]);if(null!=a)for(let t=0;t<4;t++)m.push(a[4*S[e]+t]);if(null!=o)for(let t=0;t<4;t++)p.push(o[4*S[e]+t]);if(null!=l)for(let t=0;t<4;t++)g.push(l[4*S[e]+t])}d.push(T)}}const A=new Array;Ft.ComputeNormals(c,d,A),e.positions=c,e.indices=d,e.normals=A,null!=t&&(e.uvs=h),null!=r&&(e.colors=u),null!=s&&(e.matricesIndices=f),null!=a&&(e.matricesWeights=m),null!=o&&(e.matricesIndicesExtra=p),null!=a&&(e.matricesWeightsExtra=g),e.applyToMesh(this,this.isVertexBufferUpdatable(z.b.PositionKind))}}static _instancedMeshFactory(e,t){throw Object(ht.a)("InstancedMesh")}static _PhysicsImpostorParser(e,t,n){throw Object(ht.a)("PhysicsImpostor")}createInstance(e){const t=en._instancedMeshFactory(e,this);return t.parent=this.parent,t}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),n=this.getVerticesData(z.b.PositionKind);if(!n||!t)return this;const i=[];for(let e=0;e<n.length;e+=3)i.push(r.e.FromArray(n,e));const s=[];return g.a.SyncAsyncForLoop(i.length,40,e=>{const t=i.length-1-e,n=i[t];for(let e=0;e<t;++e){const r=i[e];if(n.equals(r)){s[t]=e;break}}},()=>{for(let e=0;e<t.length;++e)t[e]=s[t[e]]||t[e];const n=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=n,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),xt.a&&xt.a.HasTags(this)&&(e.tags=xt.a.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.alwaysSelectAsActiveMesh=this.alwaysSelectAsActiveMesh,e.checkCollisions=this.checkCollisions,e.ellipsoid=this.ellipsoid.asArray(),e.ellipsoidOffset=this.ellipsoidOffset.asArray(),e.doNotSyncBoundingInfo=this.doNotSyncBoundingInfo,e.isBlocker=this.isBlocker,e.sideOrientation=this.sideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let t=0;t<this.subMeshes.length;t++){const n=this.subMeshes[t];e.subMeshes.push({materialIndex:n.materialIndex,verticesStart:n.verticesStart,verticesCount:n.verticesCount,indexStart:n.indexStart,indexCount:n.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(Kt.a.NAME_PHYSICSENGINE)){const t=this.getPhysicsImpostor();t&&(e.physicsMass=t.getParam("mass"),e.physicsFriction=t.getParam("friction"),e.physicsRestitution=t.getParam("mass"),e.physicsImpostor=t.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let t=0;t<this.instances.length;t++){const n=this.instances[t];if(n.doNotSerialize)continue;const i={name:n.name,id:n.id,isEnabled:n.isEnabled(!1),isVisible:n.isVisible,isPickable:n.isPickable,checkCollisions:n.checkCollisions,position:n.position.asArray(),scaling:n.scaling.asArray()};if(n.parent&&n.parent._serializeAsParent(i),n.rotationQuaternion?i.rotationQuaternion=n.rotationQuaternion.asArray():n.rotation&&(i.rotation=n.rotation.asArray()),this.getScene()._getComponent(Kt.a.NAME_PHYSICSENGINE)){const e=n.getPhysicsImpostor();e&&(i.physicsMass=e.getParam("mass"),i.physicsFriction=e.getParam("friction"),i.physicsRestitution=e.getParam("mass"),i.physicsImpostor=e.type)}n.metadata&&(i.metadata=n.metadata),n.actionManager&&(i.actions=n.actionManager.serialize(n.name)),e.instances.push(i),ce.a.AppendSerializedAnimations(n,i),i.ranges=n.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const t={data:{},sizes:{},strides:{}};for(const e in this._userThinInstanceBuffersStorage.data)t.data[e]=Array.from(this._userThinInstanceBuffersStorage.data[e]),t.sizes[e]=this._userThinInstanceBuffersStorage.sizes[e],t.strides[e]=this._userThinInstanceBuffersStorage.strides[e];e.thinInstances.userThinInstance=t}return ce.a.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices())return T.a.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const n=e.getActiveTarget(t),i=n.getPositions();if(!i)return void T.a.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(z.b.PositionKind+t,i,!1,3);const r=n.getNormals();r&&this.geometry.setVerticesData(z.b.NormalKind+t,r,!1,3);const s=n.getTangents();s&&this.geometry.setVerticesData(z.b.TangentKind+t,s,!1,3);const a=n.getUVs();a&&this.geometry.setVerticesData(z.b.UVKind+"_"+t,a,!1,2);const o=n.getUV2s();o&&this.geometry.setVerticesData(z.b.UV2Kind+"_"+t,o,!1,2);const l=n.getColors();l&&this.geometry.setVerticesData(z.b.ColorKind+t,l,!1,4)}}else{let e=0;for(;this.geometry.isVerticesDataPresent(z.b.PositionKind+e);)this.geometry.removeVerticesData(z.b.PositionKind+e),this.geometry.isVerticesDataPresent(z.b.NormalKind+e)&&this.geometry.removeVerticesData(z.b.NormalKind+e),this.geometry.isVerticesDataPresent(z.b.TangentKind+e)&&this.geometry.removeVerticesData(z.b.TangentKind+e),this.geometry.isVerticesDataPresent(z.b.UVKind+e)&&this.geometry.removeVerticesData(z.b.UVKind+"_"+e),this.geometry.isVerticesDataPresent(z.b.UV2Kind+e)&&this.geometry.removeVerticesData(z.b.UV2Kind+"_"+e),this.geometry.isVerticesDataPresent(z.b.ColorKind+e)&&this.geometry.removeVerticesData(z.b.ColorKind+e),e++}}static Parse(e,t,n){let i;if(i=e.type&&"LinesMesh"===e.type?en._LinesMeshParser(e,t):e.type&&"GroundMesh"===e.type?en._GroundMeshParser(e,t):e.type&&"GoldbergMesh"===e.type?en._GoldbergMeshParser(e,t):e.type&&"GreasedLineMesh"===e.type?en._GreasedLineMeshParser(e,t):e.type&&"TrailMesh"===e.type?en._TrailMeshParser(e,t):new en(e.name,t),i.id=e.id,i._waitingParsedUniqueId=e.uniqueId,xt.a&&xt.a.AddTagsTo(i,e.tags),i.position=r.e.FromArray(e.position),void 0!==e.metadata&&(i.metadata=e.metadata),e.rotationQuaternion?i.rotationQuaternion=r.b.FromArray(e.rotationQuaternion):e.rotation&&(i.rotation=r.e.FromArray(e.rotation)),i.scaling=r.e.FromArray(e.scaling),e.localMatrix?i.setPreTransformMatrix(r.a.FromArray(e.localMatrix)):e.pivotMatrix&&i.setPivotMatrix(r.a.FromArray(e.pivotMatrix)),i.setEnabled(e.isEnabled),i.isVisible=e.isVisible,i.infiniteDistance=e.infiniteDistance,i.alwaysSelectAsActiveMesh=!!e.alwaysSelectAsActiveMesh,i.showBoundingBox=e.showBoundingBox,i.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(i.applyFog=e.applyFog),void 0!==e.pickable&&(i.isPickable=e.pickable),void 0!==e.alphaIndex&&(i.alphaIndex=e.alphaIndex),i.receiveShadows=e.receiveShadows,void 0!==e.billboardMode&&(i.billboardMode=e.billboardMode),void 0!==e.visibility&&(i.visibility=e.visibility),i.checkCollisions=e.checkCollisions,i.doNotSyncBoundingInfo=!!e.doNotSyncBoundingInfo,e.ellipsoid&&(i.ellipsoid=r.e.FromArray(e.ellipsoid)),e.ellipsoidOffset&&(i.ellipsoidOffset=r.e.FromArray(e.ellipsoidOffset)),null!=e.overrideMaterialSideOrientation&&(i.sideOrientation=e.overrideMaterialSideOrientation),void 0!==e.sideOrientation&&(i.sideOrientation=e.sideOrientation),void 0!==e.isBlocker&&(i.isBlocker=e.isBlocker),i._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(i._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),void 0!==e.parentId&&(i._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(i._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.actions&&(i._waitingData.actions=e.actions),void 0!==e.overlayAlpha&&(i.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(i.overlayColor=he.a.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(i.renderOverlay=e.renderOverlay),i.isUnIndexed=!!e.isUnIndexed,i.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(i.delayLoadState=4,i.delayLoadingFile=n+e.delayLoadingFile,i.buildBoundingInfo(r.e.FromArray(e.boundingBoxMinimum),r.e.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(i._binaryInfo=e._binaryInfo),i._delayInfo=[],e.hasUVs&&i._delayInfo.push(z.b.UVKind),e.hasUVs2&&i._delayInfo.push(z.b.UV2Kind),e.hasUVs3&&i._delayInfo.push(z.b.UV3Kind),e.hasUVs4&&i._delayInfo.push(z.b.UV4Kind),e.hasUVs5&&i._delayInfo.push(z.b.UV5Kind),e.hasUVs6&&i._delayInfo.push(z.b.UV6Kind),e.hasColors&&i._delayInfo.push(z.b.ColorKind),e.hasMatricesIndices&&i._delayInfo.push(z.b.MatricesIndicesKind),e.hasMatricesWeights&&i._delayInfo.push(z.b.MatricesWeightsKind),i._delayLoadingFunction=Bt._ImportGeometry,S.ForceFullSceneLoadingForIncremental&&i._checkDelayState()):Bt._ImportGeometry(e,i),e.materialUniqueId?i._waitingMaterialId=e.materialUniqueId:e.materialId&&(i._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(i._waitingMorphTargetManagerId=e.morphTargetManagerId),void 0!==e.skeletonId&&null!==e.skeletonId&&(i.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(i.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let t=0;t<e.animations.length;t++){const n=e.animations[t],r=Object(Je.a)("BABYLON.Animation");r&&i.animations.push(r.Parse(n))}dt.a.ParseAnimationRanges(i,e,t)}if(e.autoAnimate&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?i.layerMask=Math.abs(parseInt(e.layerMask)):i.layerMask=268435455,e.physicsImpostor&&(i.physicsImpostor=en._PhysicsImpostorParser(t,i,e)),e.lodMeshIds&&(i._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let n=0;n<e.instances.length;n++){const s=e.instances[n],a=i.createInstance(s.name);if(s.id&&(a.id=s.id),xt.a&&(s.tags?xt.a.AddTagsTo(a,s.tags):xt.a.AddTagsTo(a,e.tags)),a.position=r.e.FromArray(s.position),void 0!==s.metadata&&(a.metadata=s.metadata),void 0!==s.parentId&&(a._waitingParentId=s.parentId),void 0!==s.parentInstanceIndex&&(a._waitingParentInstanceIndex=s.parentInstanceIndex),void 0!==s.isEnabled&&null!==s.isEnabled&&a.setEnabled(s.isEnabled),void 0!==s.isVisible&&null!==s.isVisible&&(a.isVisible=s.isVisible),void 0!==s.isPickable&&null!==s.isPickable&&(a.isPickable=s.isPickable),s.rotationQuaternion?a.rotationQuaternion=r.b.FromArray(s.rotationQuaternion):s.rotation&&(a.rotation=r.e.FromArray(s.rotation)),a.scaling=r.e.FromArray(s.scaling),null!=s.checkCollisions&&null!=s.checkCollisions&&(a.checkCollisions=s.checkCollisions),null!=s.pickable&&null!=s.pickable&&(a.isPickable=s.pickable),null!=s.showBoundingBox&&null!=s.showBoundingBox&&(a.showBoundingBox=s.showBoundingBox),null!=s.showSubMeshesBoundingBox&&null!=s.showSubMeshesBoundingBox&&(a.showSubMeshesBoundingBox=s.showSubMeshesBoundingBox),null!=s.alphaIndex&&null!=s.showSubMeshesBoundingBox&&(a.alphaIndex=s.alphaIndex),s.physicsImpostor&&(a.physicsImpostor=en._PhysicsImpostorParser(t,a,s)),void 0!==s.actions&&(a._waitingData.actions=s.actions),s.animations){for(let e=0;e<s.animations.length;e++){const t=s.animations[e],n=Object(Je.a)("BABYLON.Animation");n&&a.animations.push(n.Parse(t))}dt.a.ParseAnimationRanges(a,s,t),s.autoAnimate&&t.beginAnimation(a,s.autoAnimateFrom,s.autoAnimateTo,s.autoAnimateLoop,s.autoAnimateSpeed||1)}}if(e.thinInstances){const t=e.thinInstances;if(i.thinInstanceEnablePicking=!!t.enablePicking,t.matrixData?(i.thinInstanceSetBuffer("matrix",new Float32Array(t.matrixData),16,!1),i._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,i._thinInstanceDataStorage.instancesCount=t.instancesCount):i._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,e.thinInstances.userThinInstance){const t=e.thinInstances.userThinInstance;for(const e in t.data)i.thinInstanceSetBuffer(e,new Float32Array(t.data[e]),t.strides[e],!1),i._userThinInstanceBuffersStorage.sizes[e]=t.sizes[e]}}return i}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(z.b.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(z.b.PositionKind)||this.setVerticesData(z.b.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(z.b.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(z.b.NormalKind)||this.setVerticesData(z.b.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(z.b.PositionKind))return this;if(!this.isVerticesDataPresent(z.b.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(z.b.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(z.b.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!n._sourceNormals&&this.setNormalsForCPUSkinning();let i=this.getVerticesData(z.b.PositionKind);if(!i)return this;i instanceof Float32Array||(i=new Float32Array(i));let s=this.getVerticesData(z.b.NormalKind);if(t){if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s))}const a=this.getVerticesData(z.b.MatricesIndicesKind),o=this.getVerticesData(z.b.MatricesWeightsKind);if(!o||!a)return this;const l=this.numBoneInfluencers>4,c=l?this.getVerticesData(z.b.MatricesIndicesExtraKind):null,d=l?this.getVerticesData(z.b.MatricesWeightsExtraKind):null,h=e.getTransformMatrices(this),u=r.e.Zero(),f=new r.a,m=new r.a;let p,g=0;for(let e=0;e<i.length;e+=3,g+=4){let _;for(p=0;p<4;p++)_=o[g+p],_>0&&(r.a.FromFloat32ArrayToRefScaled(h,Math.floor(16*a[g+p]),_,m),f.addToSelf(m));if(l)for(p=0;p<4;p++)_=d[g+p],_>0&&(r.a.FromFloat32ArrayToRefScaled(h,Math.floor(16*c[g+p]),_,m),f.addToSelf(m));r.e.TransformCoordinatesFromFloatsToRef(n._sourcePositions[e],n._sourcePositions[e+1],n._sourcePositions[e+2],f,u),u.toArray(i,e),t&&(r.e.TransformNormalFromFloatsToRef(n._sourceNormals[e],n._sourceNormals[e+1],n._sourceNormals[e+2],f,u),u.toArray(s,e)),f.reset()}return this.updateVerticesData(z.b.PositionKind,i),t&&this.updateVerticesData(z.b.NormalKind,s),this}static MinMax(e){let t=null,n=null;return e.forEach((function(e){const i=e.getBoundingInfo().boundingBox;t&&n?(t.minimizeInPlace(i.minimumWorld),n.maximizeInPlace(i.maximumWorld)):(t=i.minimumWorld,n=i.maximumWorld)})),t&&n?{min:t,max:n}:{min:r.e.Zero(),max:r.e.Zero()}}static Center(e){const t=e instanceof Array?en.MinMax(e):e;return r.e.Center(t.min,t.max)}static MergeMeshes(e,t=!0,n,i,r,s){return Lt(en._MergeMeshesCoroutine(e,t,n,i,r,s,!1))}static MergeMeshesAsync(e,t=!0,n,i,r,s){return a=en._MergeMeshesCoroutine(e,t,n,i,r,s,!0),o=function(e=25){let t;return(n,i,r)=>{const s=performance.now();void 0===t||s-t>e?(t=s,setTimeout(()=>{Dt(n,i,r)},0)):Dt(n,i,r)}}(),new Promise((e,t)=>{Pt(a,o,e,t,l)});var a,o,l}static*_MergeMeshesCoroutine(e,t=!0,n,i,r,s,a){if(0===(e=e.filter(Boolean)).length)return null;let o;if(!n){let t=0;for(o=0;o<e.length;o++)if(t+=e[o].getTotalVertices(),t>=65536)return T.a.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}s&&(r=!1);const l=new Array,c=new Array,d=new Array,h=e[0].sideOrientation;for(o=0;o<e.length;o++){const t=e[o];if(t.isAnInstance)return T.a.Warn("Cannot merge instance meshes."),null;if(h!==t.sideOrientation)return T.a.Warn("Cannot merge meshes with different sideOrientation values."),null;if(r&&d.push(t.getTotalIndices()),s)if(t.material){const e=t.material;if(e instanceof zt){for(let t=0;t<e.subMaterials.length;t++)l.indexOf(e.subMaterials[t])<0&&l.push(e.subMaterials[t]);for(let n=0;n<t.subMeshes.length;n++)c.push(l.indexOf(e.subMaterials[t.subMeshes[n].materialIndex])),d.push(t.subMeshes[n].indexCount)}else{l.indexOf(e)<0&&l.push(e);for(let n=0;n<t.subMeshes.length;n++)c.push(l.indexOf(e)),d.push(t.subMeshes[n].indexCount)}}else for(let e=0;e<t.subMeshes.length;e++)c.push(0),d.push(t.subMeshes[e].indexCount)}const u=e[0],f=e=>{const t=e.computeWorldMatrix(!0);return{vertexData:Ft.ExtractFromMesh(e,!1,!1),transform:t}},{vertexData:m,transform:p}=f(u);a&&(yield);const g=new Array(e.length-1);for(let t=1;t<e.length;t++)g[t-1]=f(e[t]),a&&(yield);const _=m._mergeCoroutine(p,g,n,a,!t);let v=_.next();for(;!v.done;)a&&(yield),v=_.next();const E=v.value;i||(i=new en(u.name+"_merged",u.getScene()));const S=E._applyToCoroutine(i,void 0,a);let A=S.next();for(;!A.done;)a&&(yield),A=S.next();if(i.checkCollisions=u.checkCollisions,i.sideOrientation=u.sideOrientation,t)for(o=0;o<e.length;o++)e[o].dispose();if(r||s){i.releaseSubMeshes(),o=0;let e=0;for(;o<d.length;)ae.CreateFromIndices(0,e,d[o],i,void 0,!1),e+=d[o],o++;for(const e of i.subMeshes)e.refreshBoundingInfo();i.computeWorldMatrix(!0)}if(s){const e=new zt(u.name+"_merged",u.getScene());e.subMaterials=l;for(let e=0;e<i.subMeshes.length;e++)i.subMeshes[e].materialIndex=c[e];i.material=e}else i.material=u.material;return i}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(-1!=t){if(t!==this.instances.length-1){const e=this.instances[this.instances.length-1];this.instances[t]=e,e._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this._scene.useRightHandedSystem&&this.sideOrientation===je.CounterClockWiseSideOrientation}_getRenderingFillMode(e){var t;const n=this.getScene();return n.forcePointsCloud?je.PointFillMode:n.forceWireframe?je.WireFrameFillMode:null!==(t=this.overrideRenderingFillMode)&&void 0!==t?t:e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,n,i,r,s,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,n,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,n,i,r){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,n,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,n,i){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,n,i,r,s,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,n,i,r,s,a){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,n,i,r,s,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,n,i,r){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,n,i,r,s,a,o){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,n,i,r,s,a){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,n,i,r,s,a,o){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,n,i,r,s,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,n,i,r,s,a,o,l,c,d,h){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,n,i,r,s,a){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,n,i,r){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,n,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,n,i,r,s,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,n,i,r,s,a,o,l,c,d){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,n,i,r,s,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,n){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,n){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,n,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,n){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}constructor(e,t=null,n=null,i=null,r,s=!0){super(e,t),this._internalMeshDataInfo=new $t,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new qt,this._thinInstanceDataStorage=new Zt,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=en.DEFAULTSIDE,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._scene.useRightHandedSystem?this.sideOrientation=0:this.sideOrientation=1,this._onBeforeDraw=(e,t,n)=>{e&&n&&(this._uniformBuffer?this.transferToEffect(t):n.bindOnlyWorldMatrix(t))};let a=null,o=!1;if(n&&void 0===n._addToSceneRootNodes){var l,c,d,h,u;const e=n;a=null!==(l=e.parent)&&void 0!==l?l:null,i=null!==(c=e.source)&&void 0!==c?c:null,r=null!==(d=e.doNotCloneChildren)&&void 0!==d&&d,s=null===(h=e.clonePhysicsImpostor)||void 0===h||h,o=null!==(u=e.cloneThinInstances)&&void 0!==u&&u}else a=n;i&&this._copySource(i,r,s,o),null!==a&&(this.parent=a),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=e=>{e.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new _.a(this._internalMeshDataInfo._onMeshReadyObserverAdded),i&&i.onClonedObservable.notifyObservers(this)}}en.FRONTSIDE=Ft.FRONTSIDE,en.BACKSIDE=Ft.BACKSIDE,en.DOUBLESIDE=Ft.DOUBLESIDE,en.DEFAULTSIDE=Ft.DEFAULTSIDE,en.NO_CAP=0,en.CAP_START=1,en.CAP_END=2,en.CAP_ALL=3,en.NO_FLIP=0,en.FLIP_TILE=1,en.ROTATE_TILE=2,en.FLIP_ROW=3,en.ROTATE_ROW=4,en.FLIP_N_ROTATE_TILE=5,en.FLIP_N_ROTATE_ROW=6,en.CENTER=0,en.LEFT=1,en.RIGHT=2,en.TOP=3,en.BOTTOM=4,en.INSTANCEDMESH_SORT_TRANSPARENT=!1,en._GroundMeshParser=(e,t)=>{throw Object(ht.a)("GroundMesh")},en._GoldbergMeshParser=(e,t)=>{throw Object(ht.a)("GoldbergMesh")},en._LinesMeshParser=(e,t)=>{throw Object(ht.a)("LinesMesh")},en._GreasedLineMeshParser=(e,t)=>{throw Object(ht.a)("GreasedLineMesh")},en._GreasedLineRibbonMeshParser=(e,t)=>{throw Object(ht.a)("GreasedLineRibbonMesh")},en._TrailMeshParser=(e,t)=>{throw Object(ht.a)("TrailMesh")},Object(Je.b)("BABYLON.Mesh",en),en._instancedMeshFactory=(e,t)=>{const n=new tn(e,t);if(t.instancedBuffers){n.instancedBuffers={};for(const e in t.instancedBuffers)n.instancedBuffers[e]=t.instancedBuffers[e]}return n};class tn extends jt{getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.receiveShadows)!==e&&g.b.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.material)!==e&&g.b.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.visibility)!==e&&g.b.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.skeleton)!==e&&g.b.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){this._sourceMesh&&e!==this._sourceMesh.renderingGroupId&&T.a.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,n){return this._sourceMesh.getVerticesData(e,t,n)}copyVerticesData(e,t){this._sourceMesh.copyVerticesData(e,t)}setVerticesData(e,t,n,i){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,n,i),this.sourceMesh}updateVerticesData(e,t,n,i){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,n,i),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let n;n="object"==typeof e?e:{applySkeleton:e,applyMorph:t};const i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getData(n,null,z.b.PositionKind),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||T.a.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==Vt.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new r.a);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,r.c.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(r.c.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(t&&0!==t.length){const t=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,t.boundingSphere)}else this._currentLOD=this.sourceMesh;return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,n,i){const r=(i||this._sourceMesh).createInstance(e);if(Ot.a.DeepCopy(this,r,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(r.parent=t),!n)for(let e=0;e<this.getScene().meshes.length;e++){const t=this.getScene().meshes[e];t.parent===this&&t.clone(t.name,r)}return r.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(r),r}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,n){const i=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);i&&n&&n(this,i);for(const e of this.getChildTransformNodes(!0))e.instantiateHierarchy(i,t,n);return i}constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const e of t.getAnimationRanges())null!=e&&this.createAnimationRange(e.name,e.from,e.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}}en.prototype.registerInstancedBuffer=function(e,t){var n;if(null===(n=this._userInstancedBuffersStorage)||void 0===n||null===(n=n.vertexBuffers[e])||void 0===n||n.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const e of this.instances)e.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[e]=null,this._userInstancedBuffersStorage.strides[e]=t,this._userInstancedBuffersStorage.sizes[e]=32*t,this._userInstancedBuffersStorage.data[e]=new Float32Array(this._userInstancedBuffersStorage.sizes[e]),this._userInstancedBuffersStorage.vertexBuffers[e]=new z.b(this.getEngine(),this._userInstancedBuffersStorage.data[e],e,!0,!1,t,!0);for(const t of this.instances)t.instancedBuffers[e]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()},en.prototype._processInstancedBuffers=function(e,t){const n=e?e.length:0;for(const i in this.instancedBuffers){let r=this._userInstancedBuffersStorage.sizes[i];const s=this._userInstancedBuffersStorage.strides[i],a=(n+1)*s;for(;r<a;)r*=2;this._userInstancedBuffersStorage.data[i].length!=r&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[i]=r,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));const o=this._userInstancedBuffersStorage.data[i];let l=0;if(t){const e=this.instancedBuffers[i];e.toArray?e.toArray(o,l):e.copyToArray?e.copyToArray(o,l):o[l]=e,l+=s}for(let t=0;t<n;t++){const n=e[t].instancedBuffers[i];n.toArray?n.toArray(o,l):n.copyToArray?n.copyToArray(o,l):o[l]=n,l+=s}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new z.b(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,s,!0),this._invalidateInstanceVertexArrayObject())}},en.prototype._invalidateInstanceVertexArrayObject=function(){if(this._userInstancedBuffersStorage&&void 0!==this._userInstancedBuffersStorage.vertexArrayObjects){for(const e in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[e]);this._userInstancedBuffersStorage.vertexArrayObjects={}}},en.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const e in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[e]&&this._userInstancedBuffersStorage.vertexBuffers[e].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}},Object(Je.b)("BABYLON.InstancedMesh",tn);class nn{get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[]}}class rn extends nn{}class sn{dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}}class an extends nn{_topologicalSort(e){const t=new Map;for(const n of e)t.set(n.uniqueId,n);const n={dependsOn:new Map,dependedBy:new Map};for(const t of e){const e=t.uniqueId;n.dependsOn.set(e,new Set),n.dependedBy.set(e,new Set)}for(const i of e){const e=i.uniqueId,r=n.dependsOn.get(e);if(i instanceof tn){const s=i.sourceMesh;t.has(s.uniqueId)&&(r.add(s.uniqueId),n.dependedBy.get(s.uniqueId).add(e))}const s=n.dependedBy.get(e);for(const r of i.getDescendants()){const i=r.uniqueId;t.has(i)&&(s.add(i),n.dependsOn.get(i).add(e))}}const i=[],r=[];for(const i of e){const e=i.uniqueId;0===n.dependsOn.get(e).size&&(r.push(i),t.delete(e))}const s=r;for(;s.length>0;){const e=s.shift();i.push(e);const r=n.dependedBy.get(e.uniqueId);for(const i of Array.from(r.values())){const r=n.dependsOn.get(i);r.delete(e.uniqueId),0===r.size&&t.get(i)&&(s.push(t.get(i)),t.delete(i))}}return t.size>0&&(T.a.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(e=>T.a.Error(e.name))),i}_addNodeAndDescendantsToList(e,t,n,i){if(n&&(!i||i(n))&&!t.has(n.uniqueId)){e.push(n),t.add(n.uniqueId);for(const r of n.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,r,i)}}_isNodeInContainer(e){return e instanceof jt&&-1!==this.meshes.indexOf(e)||e instanceof Vt&&-1!==this.transformNodes.indexOf(e)||e instanceof gt&&-1!==this.lights.indexOf(e)||e instanceof ft&&-1!==this.cameras.indexOf(e)}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return T.a.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return T.a.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return T.a.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return T.a.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,n){this._isValidHierarchy()||g.b.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const i={},r={},s=new sn,a=[],o=[],l={doNotInstantiate:!0,...n},c=[],d=new Set;for(const e of this.transformNodes)null===e.parent&&this._addNodeAndDescendantsToList(c,d,e,l.predicate);for(const e of this.meshes)null===e.parent&&this._addNodeAndDescendantsToList(c,d,e,l.predicate);const h=this._topologicalSort(c),u=(n,a)=>{if(((t,n)=>{if(i[t.uniqueId]=n.uniqueId,r[n.uniqueId]=n,e&&(n.name=e(t.name)),n instanceof en){const e=n;if(e.morphTargetManager){const n=t.morphTargetManager;e.morphTargetManager=n.clone();for(let t=0;t<n.numTargets;t++){const s=n.getTarget(t),a=e.morphTargetManager.getTarget(t);i[s.uniqueId]=a.uniqueId,r[a.uniqueId]=a}}}})(n,a),n.parent){const e=i[n.parent.uniqueId],t=r[e];a.parent=t||n.parent}if(a.position&&n.position&&a.position.copyFrom(n.position),a.rotationQuaternion&&n.rotationQuaternion&&a.rotationQuaternion.copyFrom(n.rotationQuaternion),a.rotation&&n.rotation&&a.rotation.copyFrom(n.rotation),a.scaling&&n.scaling&&a.scaling.copyFrom(n.scaling),a.material){const s=a;if(s.material)if(t){const t=n.material;if(-1===o.indexOf(t)){let n=t.clone(e?e(t.name):"Clone of "+t.name);if(o.push(t),i[t.uniqueId]=n.uniqueId,r[n.uniqueId]=n,"MultiMaterial"===t.getClassName()){const s=t;for(const t of s.subMaterials)t&&(n=t.clone(e?e(t.name):"Clone of "+t.name),o.push(t),i[t.uniqueId]=n.uniqueId,r[n.uniqueId]=n);s.subMaterials=s.subMaterials.map(e=>e&&r[i[e.uniqueId]])}}"InstancedMesh"!==s.getClassName()&&(s.material=r[i[t.uniqueId]])}else"MultiMaterial"===s.material.getClassName()?-1===this.scene.multiMaterials.indexOf(s.material)&&this.scene.addMultiMaterial(s.material):-1===this.scene.materials.indexOf(s.material)&&this.scene.addMaterial(s.material)}null===a.parent&&s.rootNodes.push(a)};return h.forEach(e=>{if("InstancedMesh"===e.getClassName()){const t=e,n=t.sourceMesh,s=i[n.uniqueId],a=("number"==typeof s?r[s]:n).createInstance(t.name);u(t,a)}else{let t=!0;"TransformNode"===e.getClassName()||"Node"===e.getClassName()||e.skeleton||!e.getTotalVertices||0===e.getTotalVertices()?t=!1:l.doNotInstantiate&&(t="function"==typeof l.doNotInstantiate?!l.doNotInstantiate(e):!l.doNotInstantiate);const n=t?e.createInstance("instance of "+e.name):e.clone("Clone of "+e.name,null,!0);if(!n)throw new Error("Could not clone or instantiate node on Asset Container "+e.name);u(e,n)}}),this.skeletons.forEach(t=>{if(l.predicate&&!l.predicate(t))return;const n=t.clone(e?e(t.name):"Clone of "+t.name);for(const e of this.meshes)if(e.skeleton===t&&!e.isAnInstance){const t=r[i[e.uniqueId]];if(!t||t.isAnInstance)continue;if(t.skeleton=n,-1!==a.indexOf(n))continue;a.push(n);for(const e of n.bones)e._linkedTransformNode&&(e._linkedTransformNode=r[i[e._linkedTransformNode.uniqueId]])}s.skeletons.push(n)}),this.animationGroups.forEach(t=>{if(l.predicate&&!l.predicate(t))return;const n=t.clone(e?e(t.name):"Clone of "+t.name,e=>r[i[e.uniqueId]]||e);s.animationGroups.push(n)}),s}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||g.b.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const t=[];this.cameras.forEach(n=>{e&&!e(n)||(this.scene.addCamera(n),t.push(n))}),this.lights.forEach(n=>{e&&!e(n)||(this.scene.addLight(n),t.push(n))}),this.meshes.forEach(n=>{e&&!e(n)||(this.scene.addMesh(n),t.push(n))}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.addSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.addAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.addAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.addMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.addMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.addMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.addGeometry(t)}),this.transformNodes.forEach(n=>{e&&!e(n)||(this.scene.addTransformNode(n),t.push(n))}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.addActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.addTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.addReflectionProbe(t)});for(const e of t)e.parent&&-1===this.scene.getNodes().indexOf(e.parent)&&(e.setParent?e.setParent(null):e.parent=null)}removeAllFromScene(){this._isValidHierarchy()||g.b.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.removeCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.removeLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.removeMesh(t,!0)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.removeActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach(e=>{e.dispose()}),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,n){if(e&&t)for(const i of e){let e=!0;if(n)for(const t of n)if(i===t){e=!1;break}e&&(t.push(i),i._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,void 0===e&&(e=new rn);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||("_environmentTexture"===t?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new en("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=E.a.LastCreatedScene,t,n=null){if(!e)return T.a.Error("No scene available to merge animations to"),[];const i=n||(t=>{let n=null;const i=t.animations.length?t.animations[0].targetProperty:"",r=t.name.split(".").join("").split("_primitive")[0];switch(i){case"position":case"rotationQuaternion":n=e.getTransformNodeByName(t.name)||e.getTransformNodeByName(r);break;case"influence":n=e.getMorphTargetByName(t.name)||e.getMorphTargetByName(r);break;default:n=e.getNodeByName(t.name)||e.getNodeByName(r)}return n});this.getNodes().forEach(e=>{const t=i(e);if(null!==t){for(const n of e.animations){const e=t.animations.filter(e=>e.targetProperty===n.targetProperty);for(const n of e){const e=t.animations.indexOf(n,0);e>-1&&t.animations.splice(e,1)}}t.animations=t.animations.concat(e.animations)}});const r=[];return this.animationGroups.slice().forEach(e=>{r.push(e.clone(e.name,i)),e.animatables.forEach(e=>{e.stop()})}),t.forEach(t=>{const n=i(t.target);n&&(e.beginAnimation(n,t.fromFrame,t.toFrame,t.loopAnimation,t.speedRatio,t.onAnimationEnd?t.onAnimationEnd:void 0,void 0,!0,void 0,t.onAnimationLoop?t.onAnimationLoop:void 0),e.stopAnimation(t.target))}),r}populateRootNodes(){this.rootNodes.length=0,this.meshes.forEach(e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)}),this.transformNodes.forEach(e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)}),this.lights.forEach(e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)}),this.cameras.forEach(e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})}addAllAssetsToContainer(e){if(!e)return;const t=[],n=new Set;for(t.push(e);t.length>0;){const e=t.pop();if(e instanceof en?(e.geometry&&-1===this.geometries.indexOf(e.geometry)&&this.geometries.push(e.geometry),this.meshes.push(e)):e instanceof Vt?this.transformNodes.push(e):e instanceof gt?this.lights.push(e):e instanceof ft&&this.cameras.push(e),e instanceof jt){if(e.material&&-1===this.materials.indexOf(e.material)){this.materials.push(e.material);for(const t of e.material.getActiveTextures())-1===this.textures.indexOf(t)&&this.textures.push(t)}e.skeleton&&-1===this.skeletons.indexOf(e.skeleton)&&this.skeletons.push(e.skeleton),e.morphTargetManager&&-1===this.morphTargetManagers.indexOf(e.morphTargetManager)&&this.morphTargetManagers.push(e.morphTargetManager)}for(const i of e.getChildren())n.has(i)||t.push(i);n.add(e)}this.populateRootNodes()}_getByTags(e,t,n){if(void 0===t)return e;const i=[];for(const r in e){const s=e[r];xt.a&&xt.a.MatchesQuery(s,t)&&(!n||n(s))&&i.push(s)}return i}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialsByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}constructor(e){super(),this._wasAddedToScene=!1,(e=e||E.a.LastCreatedScene)&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();for(const e of this.particleSystems)e.rebuild();for(const e of this.textures)e._rebuild()}))}}var on=n(373);class ln{loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then(e=>{this._dataView=new DataView(e.buffer,e.byteOffset,e.byteLength),this._dataByteOffset=0})}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return Object(on.a)(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}constructor(e){this.byteOffset=0,this.buffer=e}}function cn(e,t,n,i){const r={externalResourceFunction:i};return n&&(r.uri="file:"===t?n:t+n),ArrayBuffer.isView(e)?GLTFValidator.validateBytes(e,r):GLTFValidator.validateString(e,r)}function dn(){const e=[];onmessage=t=>{const n=t.data;switch(n.id){case"init":importScripts(n.url);break;case"validate":cn(n.data,n.rootUrl,n.fileName,t=>new Promise((n,i)=>{const r=e.length;e.push({resolve:n,reject:i}),postMessage({id:"getExternalResource",index:r,uri:t})})).then(e=>{postMessage({id:"validate.resolve",value:e})},e=>{postMessage({id:"validate.reject",reason:e})});break;case"getExternalResource.resolve":e[n.index].resolve(n.value);break;case"getExternalResource.reject":e[n.index].reject(n.reason)}}}class hn{static ValidateAsync(e,t,n,i){return"function"==typeof Worker?new Promise((r,s)=>{const a=`${cn}(${dn})()`,o=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),l=new Worker(o),c=e=>{l.removeEventListener("error",c),l.removeEventListener("message",d),s(e)},d=e=>{const t=e.data;switch(t.id){case"getExternalResource":i(t.uri).then(e=>{l.postMessage({id:"getExternalResource.resolve",index:t.index,value:e},[e.buffer])},e=>{l.postMessage({id:"getExternalResource.reject",index:t.index,reason:e})});break;case"validate.resolve":l.removeEventListener("error",c),l.removeEventListener("message",d),r(t.value),l.terminate();break;case"validate.reject":l.removeEventListener("error",c),l.removeEventListener("message",d),s(t.reason),l.terminate()}};if(l.addEventListener("error",c),l.addEventListener("message",d),l.postMessage({id:"init",url:g.b.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){const i=e.slice();l.postMessage({id:"validate",data:i,rootUrl:t,fileName:n},[i.buffer])}else l.postMessage({id:"validate",data:e,rootUrl:t,fileName:n})}):(this._LoadScriptPromise||(this._LoadScriptPromise=g.b.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>cn(e,t,n,i)))}}hn.Configuration={url:g.b._DefaultCdnUrl+"/gltf_validator.js"};const un="gltf",fn={".gltf":{isBinary:!1,mimeType:"model/gltf+json"},".glb":{isBinary:!0,mimeType:"model/gltf-binary"}},mn=e=>-1!==e.indexOf("asset")&&-1!==e.indexOf("version")||e.startsWith("data:base64,Z2xURg")||e.startsWith("data:;base64,Z2xURg")||e.startsWith("data:application/octet-stream;base64,Z2xURg")||e.startsWith("data:model/gltf-binary;base64,Z2xURg");function pn(e,t,n){try{return Promise.resolve(new Uint8Array(e,t,n))}catch(e){return Promise.reject(e)}}var gn,_n,vn,En,Tn,Sn,An,bn,In,Rn,Cn;!function(e){e[e.AUTO=0]="AUTO",e[e.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"}(gn||(gn={})),function(e){e[e.NONE=0]="NONE",e[e.FIRST=1]="FIRST",e[e.ALL=2]="ALL"}(_n||(_n={})),function(e){e[e.LOADING=0]="LOADING",e[e.READY=1]="READY",e[e.COMPLETE=2]="COMPLETE"}(vn||(vn={}));class yn extends class{copyFrom(e){var t,n,i,r,s,a,o,l,c,d,h,u,f,m,p,g,_,v,E,T,S;e&&(this.onParsed=e.onParsed,this.coordinateSystemMode=null!==(t=e.coordinateSystemMode)&&void 0!==t?t:this.coordinateSystemMode,this.animationStartMode=null!==(n=e.animationStartMode)&&void 0!==n?n:this.animationStartMode,this.loadNodeAnimations=null!==(i=e.loadNodeAnimations)&&void 0!==i?i:this.loadNodeAnimations,this.loadSkins=null!==(r=e.loadSkins)&&void 0!==r?r:this.loadSkins,this.loadMorphTargets=null!==(s=e.loadMorphTargets)&&void 0!==s?s:this.loadMorphTargets,this.compileMaterials=null!==(a=e.compileMaterials)&&void 0!==a?a:this.compileMaterials,this.useClipPlane=null!==(o=e.useClipPlane)&&void 0!==o?o:this.useClipPlane,this.compileShadowGenerators=null!==(l=e.compileShadowGenerators)&&void 0!==l?l:this.compileShadowGenerators,this.transparencyAsCoverage=null!==(c=e.transparencyAsCoverage)&&void 0!==c?c:this.transparencyAsCoverage,this.useRangeRequests=null!==(d=e.useRangeRequests)&&void 0!==d?d:this.useRangeRequests,this.createInstances=null!==(h=e.createInstances)&&void 0!==h?h:this.createInstances,this.alwaysComputeBoundingBox=null!==(u=e.alwaysComputeBoundingBox)&&void 0!==u?u:this.alwaysComputeBoundingBox,this.loadAllMaterials=null!==(f=e.loadAllMaterials)&&void 0!==f?f:this.loadAllMaterials,this.loadOnlyMaterials=null!==(m=e.loadOnlyMaterials)&&void 0!==m?m:this.loadOnlyMaterials,this.skipMaterials=null!==(p=e.skipMaterials)&&void 0!==p?p:this.skipMaterials,this.useSRGBBuffers=null!==(g=e.useSRGBBuffers)&&void 0!==g?g:this.useSRGBBuffers,this.targetFps=null!==(_=e.targetFps)&&void 0!==_?_:this.targetFps,this.alwaysComputeSkeletonRootNode=null!==(v=e.alwaysComputeSkeletonRootNode)&&void 0!==v?v:this.alwaysComputeSkeletonRootNode,this.useGltfTextureNames=null!==(E=e.useGltfTextureNames)&&void 0!==E?E:this.useGltfTextureNames,this.preprocessUrlAsync=null!==(T=e.preprocessUrlAsync)&&void 0!==T?T:this.preprocessUrlAsync,this.customRootNode=e.customRootNode,this.onMeshLoaded=e.onMeshLoaded,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onCameraLoaded=e.onCameraLoaded,this.extensionOptions=null!==(S=e.extensionOptions)&&void 0!==S?S:this.extensionOptions)}constructor(){this.coordinateSystemMode=gn.AUTO,this.animationStartMode=_n.FIRST,this.loadNodeAnimations=!0,this.loadSkins=!0,this.loadMorphTargets=!0,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.useGltfTextureNames=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.extensionOptions={}}}{set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),e&&(this._onParsedObserver=this.onParsedObservable.add(e))}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),e&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e))}set onSkinLoaded(e){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),e&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add(t=>e(t.node,t.skinnedNode)))}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),e&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e))}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),e&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e))}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),e&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e))}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,n,i,r,s,a,o){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,n,i,a,o),null;this._progressCallback=r;const l=t.name||g.b.GetFilename(t);if(s){if(this.useRangeRequests){this.validate&&T.a.Warn("glTF validation is not supported when range requests are enabled");const n={abort:()=>{},onCompleteObservable:new _.a},r={readAsync:(n,i)=>new Promise((r,s)=>{this._loadFile(e,t,e=>{r(new Uint8Array(e))},!0,e=>{s(e)},e=>{e.setRequestHeader("Range",`bytes=${n}-${n+i-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new ln(r)).then(e=>{n.onCompleteObservable.notifyObservers(n),i(e)},a?e=>a(void 0,e):void 0),n}return this._loadFile(e,t,t=>{this._validate(e,new Uint8Array(t,0,t.byteLength),n,l),this._unpackBinaryAsync(new ln({readAsync:(e,n)=>pn(t,e,n),byteLength:t.byteLength})).then(e=>{i(e)},a?e=>a(void 0,e):void 0)},!0,a)}return this._loadFile(e,t,t=>{try{this._validate(e,t,n,l),i({json:this._parseJson(t)})}catch{a&&a()}},!1,a)}_loadBinary(e,t,n,i,r,s){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n,s),this._unpackBinaryAsync(new ln({readAsync:(e,n)=>function(e,t,n){try{if(t<0||t>=e.byteLength)throw new RangeError("Offset is out of range.");if(t+n>e.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(e.buffer,e.byteOffset+t,n))}catch(e){return Promise.reject(e)}}(t,e,n),byteLength:t.byteLength})).then(e=>{i(e)},r?e=>r(void 0,e):void 0)}importMeshAsync(e,t,n,i,r,s){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(n),this.onParsedObservable.clear(),this._log("Loading "+(s||"")),this._loader=this._getLoader(n),this._loader.importMeshAsync(e,t,null,n,i,r,s)))}loadAsync(e,t,n,i,r){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log("Loading "+(r||"")),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,n,i,r)))}loadAssetContainerAsync(e,t,n,i,r){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log("Loading "+(r||"")),this._loader=this._getLoader(t);const s=new an(e),a=[];this.onMaterialLoadedObservable.add(e=>{a.push(e)});const o=[];this.onTextureLoadedObservable.add(e=>{o.push(e)});const l=[];this.onCameraLoadedObservable.add(e=>{l.push(e)});const c=[];return this.onMeshLoadedObservable.add(e=>{e.morphTargetManager&&c.push(e.morphTargetManager)}),this._loader.importMeshAsync(null,e,s,t,n,i,r).then(e=>(Array.prototype.push.apply(s.geometries,e.geometries),Array.prototype.push.apply(s.meshes,e.meshes),Array.prototype.push.apply(s.particleSystems,e.particleSystems),Array.prototype.push.apply(s.skeletons,e.skeletons),Array.prototype.push.apply(s.animationGroups,e.animationGroups),Array.prototype.push.apply(s.materials,a),Array.prototype.push.apply(s.textures,o),Array.prototype.push.apply(s.lights,e.lights),Array.prototype.push.apply(s.transformNodes,e.transformNodes),Array.prototype.push.apply(s.cameras,l),Array.prototype.push.apply(s.morphTargetManagers,c),s))})}canDirectLoad(e){return mn(e)}directLoad(e,t){if(t.startsWith("base64,Z2xURg")||t.startsWith(";base64,Z2xURg")||t.startsWith("application/octet-stream;base64,Z2xURg")||t.startsWith("model/gltf-binary;base64,Z2xURg")){const n=Object(b.a)(t);return this._validate(e,new Uint8Array(n,0,n.byteLength)),this._unpackBinaryAsync(new ln({readAsync:(e,t)=>pn(n,e,t),byteLength:n.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(e){return new yn(e[un])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(e=>{t(e)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(vn[this._state]))}_loadFile(e,t,n,i,r,s){const a=e._loadFile(t,n,e=>{this._onProgress(e,a)},!0,i,r,s);return a.onCompleteObservable.add(()=>{a._lengthComputable=!0,a._total=a._loaded}),this._requests.push(a),a}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let n=!0,i=0,r=0;for(const e of this._requests){if(void 0===e._lengthComputable||void 0===e._loaded||void 0===e._total)return;n=n&&e._lengthComputable,i+=e._loaded,r+=e._total}this._progressCallback({lengthComputable:n,loaded:i,total:n?r:0})}_validate(e,t,n="",i=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),hn.ValidateAsync(t,n,i,t=>this.preprocessUrlAsync(n+t).then(t=>e._loadFileAsync(t,void 0,!0,!0).then(e=>new Uint8Array(e,0,e.byteLength)))).then(e=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(e),this.onValidatedObservable.clear()},e=>{this._endPerformanceCounter("Validate JSON"),g.b.Warn("Failed to validate: "+e.message),this.onValidatedObservable.clear()}))}_getLoader(e){const t=e.json.asset||{};this._log("Asset version: "+t.version),t.minVersion&&this._log("Asset minimum version: "+t.minVersion),t.generator&&this._log("Asset generator: "+t.generator);const n=yn._parseVersion(t.version);if(!n)throw new Error("Invalid version: "+t.version);if(void 0!==t.minVersion){const e=yn._parseVersion(t.minVersion);if(!e)throw new Error("Invalid minimum version: "+t.minVersion);if(yn._compareVersion(e,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const i={1:yn._CreateGLTF1Loader,2:yn._CreateGLTF2Loader}[n.major];if(!i)throw new Error("Unsupported version: "+t.version);return i(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log("JSON length: "+e.length);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const t=e.readUint32();if(1179937895!==t)throw new I.c("Unexpected magic: "+t,I.b.GLTFLoaderUnexpectedMagicError);const n=e.readUint32();this.loggingEnabled&&this._log("Binary version: "+n);const i=e.readUint32();let r;switch(this.useRangeRequests||i===e.buffer.byteLength||T.a.Warn(`Length in header does not match actual data length: ${i} != ${e.buffer.byteLength}`),n){case 1:r=this._unpackBinaryV1Async(e,i);break;case 2:r=this._unpackBinaryV2Async(e,i);break;default:throw new Error("Unsupported version: "+n)}return this._endPerformanceCounter("Unpack Binary"),r})}_unpackBinaryV1Async(e,t){const n=e.readUint32(),i=e.readUint32();if(0!==i)throw new Error("Unexpected content format: "+i);const r=t-e.byteOffset,s={json:this._parseJson(e.readString(n)),bin:null};if(0!==r){const t=e.byteOffset;s.bin={readAsync:(n,i)=>e.buffer.readAsync(t+n,i),byteLength:r}}return Promise.resolve(s)}_unpackBinaryV2Async(e,t){const n=e.readUint32();if(1313821514!==e.readUint32())throw new Error("First chunk format is not JSON");return e.byteOffset+n===t?e.loadAsync(n).then(()=>({json:this._parseJson(e.readString(n)),bin:null})):e.loadAsync(n+8).then(()=>{const i={json:this._parseJson(e.readString(n)),bin:null},r=()=>{const n=e.readUint32();switch(e.readUint32()){case 1313821514:throw new Error("Unexpected JSON chunk");case 5130562:{const t=e.byteOffset;i.bin={readAsync:(n,i)=>e.buffer.readAsync(t+n,i),byteLength:n},e.skipBytes(n);break}default:e.skipBytes(n)}return e.byteOffset!==t?e.loadAsync(8).then(r):Promise.resolve(i)};return r()})}static _parseVersion(e){if("1.0"===e||"1.0.1"===e)return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=yn._logSpaces.substring(0,2*this._logIndentLevel);T.a.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){g.b.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){g.b.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}constructor(e){super(),this.onParsedObservable=new _.a,this.onMeshLoadedObservable=new _.a,this.onSkinLoadedObservable=new _.a,this.onTextureLoadedObservable=new _.a,this.onMaterialLoadedObservable=new _.a,this.onCameraLoadedObservable=new _.a,this.onCompleteObservable=new _.a,this.onErrorObservable=new _.a,this.onDisposeObservable=new _.a,this.onExtensionLoadedObservable=new _.a,this.validate=!1,this.onValidatedObservable=new _.a,this._loader=null,this._state=null,this._requests=new Array,this.name=un,this.extensions=fn,this.onLoaderStateChangedObservable=new _.a,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(e)}}yn.IncrementalLoading=!0,yn.HomogeneousCoordinates=!1,yn._logSpaces="                                ",w(new yn),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.FLOAT=5126]="FLOAT"}(En||(En={})),function(e){e[e.FRAGMENT=35632]="FRAGMENT",e[e.VERTEX=35633]="VERTEX"}(Tn||(Tn={})),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D"}(Sn||(Sn={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.REPEAT=10497]="REPEAT"}(An||(An={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9728]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(bn||(bn={})),function(e){e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"}(In||(In={})),function(e){e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK"}(Rn||(Rn={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.CONSTANT_COLOR=32769]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"}(Cn||(Cn={}));var Mn={},On=n(399);class xn{attachControl(e){e=g.b.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const n=t.event;if(!n.metaKey)if(t.type===On.a.KEYDOWN)-1===this.keysUp.indexOf(n.keyCode)&&-1===this.keysDown.indexOf(n.keyCode)&&-1===this.keysLeft.indexOf(n.keyCode)&&-1===this.keysRight.indexOf(n.keyCode)&&-1===this.keysUpward.indexOf(n.keyCode)&&-1===this.keysDownward.indexOf(n.keyCode)&&-1===this.keysRotateLeft.indexOf(n.keyCode)&&-1===this.keysRotateRight.indexOf(n.keyCode)&&-1===this.keysRotateUp.indexOf(n.keyCode)&&-1===this.keysRotateDown.indexOf(n.keyCode)||(-1===this._keys.indexOf(n.keyCode)&&this._keys.push(n.keyCode),e||n.preventDefault());else if(-1!==this.keysUp.indexOf(n.keyCode)||-1!==this.keysDown.indexOf(n.keyCode)||-1!==this.keysLeft.indexOf(n.keyCode)||-1!==this.keysRight.indexOf(n.keyCode)||-1!==this.keysUpward.indexOf(n.keyCode)||-1!==this.keysDownward.indexOf(n.keyCode)||-1!==this.keysRotateLeft.indexOf(n.keyCode)||-1!==this.keysRotateRight.indexOf(n.keyCode)||-1!==this.keysRotateUp.indexOf(n.keyCode)||-1!==this.keysRotateDown.indexOf(n.keyCode)){const t=this._keys.indexOf(n.keyCode);t>=0&&this._keys.splice(t,1),e||n.preventDefault()}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const n=this._keys[t],i=e._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(n)?e._localDirection.copyFromFloats(-i,0,0):-1!==this.keysUp.indexOf(n)?e._localDirection.copyFromFloats(0,0,i):-1!==this.keysRight.indexOf(n)?e._localDirection.copyFromFloats(i,0,0):-1!==this.keysDown.indexOf(n)?e._localDirection.copyFromFloats(0,0,-i):-1!==this.keysUpward.indexOf(n)?e._localDirection.copyFromFloats(0,i,0):-1!==this.keysDownward.indexOf(n)?e._localDirection.copyFromFloats(0,-i,0):-1!==this.keysRotateLeft.indexOf(n)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):-1!==this.keysRotateRight.indexOf(n)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):-1!==this.keysRotateUp.indexOf(n)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):-1!==this.keysRotateDown.indexOf(n)&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),r.e.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}}Object(W.a)([Object(X.c)()],xn.prototype,"keysUp",void 0),Object(W.a)([Object(X.c)()],xn.prototype,"keysUpward",void 0),Object(W.a)([Object(X.c)()],xn.prototype,"keysDown",void 0),Object(W.a)([Object(X.c)()],xn.prototype,"keysDownward",void 0),Object(W.a)([Object(X.c)()],xn.prototype,"keysLeft",void 0),Object(W.a)([Object(X.c)()],xn.prototype,"keysRight",void 0),Object(W.a)([Object(X.c)()],xn.prototype,"rotationSpeed",void 0),Object(W.a)([Object(X.c)()],xn.prototype,"keysRotateLeft",void 0),Object(W.a)([Object(X.c)()],xn.prototype,"keysRotateRight",void 0),Object(W.a)([Object(X.c)()],xn.prototype,"keysRotateUp",void 0),Object(W.a)([Object(X.c)()],xn.prototype,"keysRotateDown",void 0),Mn.FreeCameraKeyboardMoveInput=xn;var Dn=n(330);class Pn{attachControl(e){e=g.b.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),n=t.getInputElement();this._pointerInput||(this._pointerInput=i=>{const r=i.event,s="touch"===r.pointerType;if(!this.touchEnabled&&s)return;if(i.type!==Dn.a.POINTERMOVE&&-1===this.buttons.indexOf(r.button))return;const a=r.target;if(i.type===Dn.a.POINTERDOWN){if(s&&-1!==this._activePointerId||!s&&-1!==this._currentActiveButton)return;this._activePointerId=r.pointerId;try{null==a||a.setPointerCapture(r.pointerId)}catch(e){}-1===this._currentActiveButton&&(this._currentActiveButton=r.button),this._previousPosition={x:r.clientX,y:r.clientY},e||(r.preventDefault(),n&&n.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(i.event)}else if(i.type===Dn.a.POINTERUP){if(s&&this._activePointerId!==r.pointerId||!s&&this._currentActiveButton!==r.button)return;try{null==a||a.releasePointerCapture(r.pointerId)}catch(e){}this._currentActiveButton=-1,this._previousPosition=null,e||r.preventDefault(),this._activePointerId=-1}else if(i.type===Dn.a.POINTERMOVE&&(this._activePointerId===r.pointerId||!s))if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(i.event);else if(this._previousPosition){const t=this.camera._calculateHandednessMultiplier(),n=(r.clientX-this._previousPosition.x)*t,i=r.clientY-this._previousPosition.y;this._allowCameraRotation&&(this.camera.cameraRotation.y+=n/this.angularSensibility,this.camera.cameraRotation.x+=i/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:n,offsetY:i}),this._previousPosition={x:r.clientX,y:r.clientY},e||r.preventDefault()}}),this._onMouseMove=n=>{if(!t.isPointerLock)return;const i=this.camera._calculateHandednessMultiplier(),r=n.movementX*i;this.camera.cameraRotation.y+=r/this.angularSensibility;const s=n.movementY;this.camera.cameraRotation.x+=s/this.angularSensibility,this._previousPosition=null,e||n.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Dn.a.POINTERDOWN|Dn.a.POINTERUP|Dn.a.POINTERMOVE),n&&(this._contextMenuBind=e=>this.onContextMenu(e),n.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new _.a,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}}Object(W.a)([Object(X.c)()],Pn.prototype,"buttons",void 0),Object(W.a)([Object(X.c)()],Pn.prototype,"angularSensibility",void 0),Mn.FreeCameraMouseInput=Pn;var Ln,Nn=n(400);class Fn{attachControl(e){e=g.b.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Dn.a.POINTERWHEEL)return;const n=t.event,i=n.deltaMode===Nn.a.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*i*n.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*i*n.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*i*n.deltaZ/this._normalize,n.preventDefault&&(e||n.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Dn.a.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new _.a,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}}Object(W.a)([Object(X.c)()],Fn.prototype,"wheelPrecisionX",void 0),Object(W.a)([Object(X.c)()],Fn.prototype,"wheelPrecisionY",void 0),Object(W.a)([Object(X.c)()],Fn.prototype,"wheelPrecisionZ",void 0),function(e){e[e.MoveRelative=0]="MoveRelative",e[e.RotateRelative=1]="RotateRelative",e[e.MoveScene=2]="MoveScene"}(Ln||(Ln={}));class wn extends Fn{getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){null===e&&this._wheelXAction!==Ln.MoveRelative||(this._wheelXAction=Ln.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==Ln.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){null===e&&this._wheelYAction!==Ln.MoveRelative||(this._wheelYAction=Ln.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==Ln.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){null===e&&this._wheelZAction!==Ln.MoveRelative||(this._wheelZAction=Ln.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==Ln.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){null===e&&this._wheelXAction!==Ln.RotateRelative||(this._wheelXAction=Ln.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==Ln.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){null===e&&this._wheelYAction!==Ln.RotateRelative||(this._wheelYAction=Ln.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==Ln.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){null===e&&this._wheelZAction!==Ln.RotateRelative||(this._wheelZAction=Ln.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==Ln.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){null===e&&this._wheelXAction!==Ln.MoveScene||(this._wheelXAction=Ln.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==Ln.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){null===e&&this._wheelYAction!==Ln.MoveScene||(this._wheelYAction=Ln.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==Ln.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){null===e&&this._wheelZAction!==Ln.MoveScene||(this._wheelZAction=Ln.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==Ln.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(0===this._wheelDeltaX&&0===this._wheelDeltaY&&0==this._wheelDeltaZ)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=r.a.Zero();this.camera.getViewMatrix().invertToRef(e);const t=r.e.Zero();r.e.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,n){if(0===e)return;if(null===t||null===n)return;let i=null;switch(t){case Ln.MoveRelative:i=this._moveRelative;break;case Ln.RotateRelative:i=this._rotateRelative;break;case Ln.MoveScene:i=this._moveScene}switch(n){case 0:i.set(e,0,0);break;case 1:i.set(0,e,0);break;case 2:i.set(0,0,e)}}constructor(){super(...arguments),this._moveRelative=r.e.Zero(),this._rotateRelative=r.e.Zero(),this._moveScene=r.e.Zero(),this._wheelXAction=Ln.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=Ln.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null}}Object(W.a)([Object(X.c)()],wn.prototype,"wheelXMoveRelative",null),Object(W.a)([Object(X.c)()],wn.prototype,"wheelYMoveRelative",null),Object(W.a)([Object(X.c)()],wn.prototype,"wheelZMoveRelative",null),Object(W.a)([Object(X.c)()],wn.prototype,"wheelXRotateRelative",null),Object(W.a)([Object(X.c)()],wn.prototype,"wheelYRotateRelative",null),Object(W.a)([Object(X.c)()],wn.prototype,"wheelZRotateRelative",null),Object(W.a)([Object(X.c)()],wn.prototype,"wheelXMoveScene",null),Object(W.a)([Object(X.c)()],wn.prototype,"wheelYMoveScene",null),Object(W.a)([Object(X.c)()],wn.prototype,"wheelZMoveScene",null),Mn.FreeCameraMouseWheelInput=wn;class Un{attachControl(e){e=g.b.BackCompatCameraNoPreventDefault(arguments);let t=null;if(void 0===this._pointerInput&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=n=>{const i=n.event,r="mouse"===i.pointerType||this._isSafari&&void 0===i.pointerType;if(this.allowMouse||!r)if(n.type===Dn.a.POINTERDOWN){if(e||i.preventDefault(),this._pointerPressed.push(i.pointerId),1!==this._pointerPressed.length)return;t={x:i.clientX,y:i.clientY}}else if(n.type===Dn.a.POINTERUP){e||i.preventDefault();const n=this._pointerPressed.indexOf(i.pointerId);if(-1===n)return;if(this._pointerPressed.splice(n,1),0!=n)return;t=null,this._offsetX=null,this._offsetY=null}else if(n.type===Dn.a.POINTERMOVE){if(e||i.preventDefault(),!t)return;if(0!=this._pointerPressed.indexOf(i.pointerId))return;this._offsetX=i.clientX-t.x,this._offsetY=-(i.clientY-t.y)}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Dn.a.POINTERDOWN|Dn.a.POINTERUP|Dn.a.POINTERMOVE),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(null===this._offsetX||null===this._offsetY)return;if(0===this._offsetX&&0===this._offsetY)return;const e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=t*this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&1===this._pointerPressed.length||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const t=e._computeLocalCameraSpeed(),n=new r.e(0,0,0!==this.touchMoveSensibility?t*this._offsetY/this.touchMoveSensibility:0);r.a.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(r.e.TransformCoordinates(n,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=g.b.IsSafari()}}Object(W.a)([Object(X.c)()],Un.prototype,"touchAngularSensibility",void 0),Object(W.a)([Object(X.c)()],Un.prototype,"touchMoveSensibility",void 0),Mn.FreeCameraTouchInput=Un;class Bn extends class{add(e){const t=e.getSimpleName();this.attached[t]?T.a.Warn("camera input of type "+t+" already exists on camera"):(this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault))}remove(e){for(const t in this.attached){const n=this.attached[t];if(n===e)return n.detachControl(),n.camera=null,delete this.attached[t],void this.rebuildInputCheck()}}removeByType(e){for(const t in this.attached){const n=this.attached[t];n.getClassName()===e&&(n.detachControl(),n.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=!ft.ForceAttachControlToAlwaysPreventDefault&&e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const e in this.attached){const n=this.attached[e],i=ce.a.Serialize(n);t[n.getClassName()]=i}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const e in t){const n=Mn[e];if(n){const i=t[e],r=ce.a.Parse(()=>new n,i,null);this.add(r)}}}else for(const t in this.attached){const n=Mn[this.attached[t].getClassName()];if(n){const i=ce.a.Parse(()=>new n,e,null);this.remove(this.attached[t]),this.add(i)}}}constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}}{addKeyboard(){return this.add(new xn),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new Pn(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new wn,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new Un),this}clear(){super.clear(),this._mouseInput=null}constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}}class kn extends pt{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}attachControl(e,t){t=g.b.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new r.e(0,0,0),this.cameraRotation=new r.d(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?r.e.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const n=this.getScene().collisionCoordinator;this._collider||(this._collider=n.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let i=e;this.applyGravity&&(i=e.add(this.getScene().gravity)),n.getNewPosition(this._oldPosition,i,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=r.e.Zero(),this._transformedDirection=r.e.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}constructor(e,t,n,i=!0){super(e,t,n,i),this.ellipsoid=new r.e(.5,1,.5),this.ellipsoidOffset=new r.e(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=r.e.Zero(),this._diffPosition=r.e.Zero(),this._newPosition=r.e.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,n=null)=>{this._newPosition.copyFrom(t),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>C.a.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&n&&this.onCollide(n))},this.inputs=new Bn(this),this.inputs.addKeyboard().addMouse()}}Object(W.a)([Object(X.n)()],kn.prototype,"ellipsoid",void 0),Object(W.a)([Object(X.n)()],kn.prototype,"ellipsoidOffset",void 0),Object(W.a)([Object(X.c)()],kn.prototype,"checkCollisions",void 0),Object(W.a)([Object(X.c)()],kn.prototype,"applyGravity",void 0),Object(Je.b)("BABYLON.FreeCamera",kn);var Vn=n(321),Gn=n(341);class Hn extends Et.a{update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer),this._waitingForData=!1}clone(){if(!this._texture)return super.clone();const e=new Hn(null,this.getSize().width,this.getSize().height,this.format,this.getScene(),this._texture.generateMipMaps,this._invertY,this.samplingMode,this._texture.type,this._texture._creationFlags,this._useSRGBBuffer);return e._texture=this._texture,this._texture.incrementReferences(),e}isReady(){return super.isReady()&&!this._waitingForData}static CreateLuminanceTexture(e,t,n,i,r=!0,s=!1,a=3){return new Hn(e,t,n,1,i,r,s,a)}static CreateLuminanceAlphaTexture(e,t,n,i,r=!0,s=!1,a=3){return new Hn(e,t,n,2,i,r,s,a)}static CreateAlphaTexture(e,t,n,i,r=!0,s=!1,a=3){return new Hn(e,t,n,0,i,r,s,a)}static CreateRGBTexture(e,t,n,i,r=!0,s=!1,a=3,o=0,l=0,c=!1){return new Hn(e,t,n,4,i,r,s,a,o,l,c)}static CreateRGBATexture(e,t,n,i,r=!0,s=!1,a=3,o=0,l=0,c=!1,d=!1){return new Hn(e,t,n,5,i,r,s,a,o,l,c,d)}static CreateRGBAStorageTexture(e,t,n,i,r=!0,s=!1,a=3,o=0,l=!1){return new Hn(e,t,n,5,i,r,s,a,o,1,l)}static CreateRTexture(e,t,n,i,r=!0,s=!1,a=Et.a.TRILINEAR_SAMPLINGMODE,o=1){return new Hn(e,t,n,6,i,r,s,a,o)}static CreateRStorageTexture(e,t,n,i,r=!0,s=!1,a=Et.a.TRILINEAR_SAMPLINGMODE,o=1){return new Hn(e,t,n,6,i,r,s,a,o,1)}constructor(e,t,n,i,r,s=!0,a=!1,o=3,l=0,c,d,h){super(null,r,!s,a,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,c),this.format=i,this._engine&&(this._engine._caps.textureFloatLinearFiltering||1!==l||(o=1),this._engine._caps.textureHalfFloatLinearFiltering||2!==l||(o=1),this._texture=this._engine.createRawTexture(e,t,n,i,s,a,o,null,l,null!=c?c:0,null!=d&&d),this.wrapU=Et.a.CLAMP_ADDRESSMODE,this.wrapV=Et.a.CLAMP_ADDRESSMODE,this._waitingForData=!!h&&!e)}}var Wn=n(404);class Xn{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return this._transformMatrices&&!this._isDirty||this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=", nAnimationRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let e=!0;for(const n in this._ranges)e&&(t+=", ",e=!1),t+=n;t+="}"}return t}getBoneIndexByName(e){for(let t=0,n=this.bones.length;t<n;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,n){if(!this._ranges[e]){this._ranges[e]=new Wn.a(e,t,n);for(let i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].createRange(e,t,n)}}deleteAnimationRange(e,t=!0){for(let n=0,i=this.bones.length;n<i;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,n=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let i=!0;const r=this._getHighestAnimationFrame()+1,s={},a=e.bones;let o,l;for(l=0,o=a.length;l<o;l++)s[a[l].name]=a[l];this.bones.length!==a.length&&(T.a.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${a.length}`),i=!1);const c=n&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(l=0,o=this.bones.length;l<o;l++){const e=this.bones[l].name,a=s[e];a?i=i&&this.bones[l].copyAnimationRange(a,t,r,n,c):(T.a.Warn("copyAnimationRange: not same rig, missing source bone "+e),i=!1)}const d=e.getAnimationRange(t);return d&&(this._ranges[t]=new Wn.a(t,d.from+r,d.to+r)),i}returnToRest(){for(const e of this.bones)-1!==e._index&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,n=this.bones.length;t<n;t++)if(this.bones[t].animations[0]){const n=this.bones[t].animations[0].getHighestFrame();e<n&&(e=n)}return e}beginAnimation(e,t,n,i){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,n,i):null}static MakeAnimationAdditive(e,t=0,n){const i=e.getAnimationRange(n);if(!i)return null;const r=e._scene.getAllAnimatablesByTarget(e);let s=null;for(let e=0;e<r.length;e++){const t=r[e];if(t.fromFrame===(null==i?void 0:i.from)&&t.toFrame===(null==i?void 0:i.to)){s=t;break}}const a=e.getAnimatables();for(let e=0;e<a.length;e++){const i=a[e].animations;if(i)for(let e=0;e<i.length;e++)Vn.a.MakeAnimationAdditive(i[e],t,n)}return s&&(s.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let n=0;n<this.bones.length;n++){const i=this.bones[n];i._childUpdateId++;const r=i.getParent();if(r?i.getLocalMatrix().multiplyToRef(r.getFinalMatrix(),i.getFinalMatrix()):t?i.getLocalMatrix().multiplyToRef(t,i.getFinalMatrix()):i.getFinalMatrix().copyFrom(i.getLocalMatrix()),-1!==i._index){const t=null===i._index?n:i._index;i.getAbsoluteInverseBindMatrix().multiplyToArray(i.getFinalMatrix(),e,16*t)}}this._identity.copyToArray(e,16*this.bones.length)}prepare(e=!1){if(!e){const e=this.getScene().getRenderId();if(this._currentRenderId===e)return;this._currentRenderId=e}if(this._numBonesWithLinkedTransformNode>0)for(const e of this.bones)if(e._linkedTransformNode){const t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const t=e.getPoseMatrix();let n=this._isDirty;if(e._bonesTransformMatrices&&e._bonesTransformMatrices.length===16*(this.bones.length+1)||(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),n=!0),n){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const e of this.bones)e.getParent()||(e.getBindMatrix().multiplyToRef(t,r.c.Matrix[1]),e._updateAbsoluteBindMatrices(r.c.Matrix[1]));if(this.isUsingTextureForMatrices){const t=4*(this.bones.length+1);e._transformMatrixTexture&&e._transformMatrixTexture.getSize().width===t||(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=Hn.CreateRGBATexture(e._bonesTransformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=Hn.CreateRGBATexture(this._transformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const n=new Xn(e,t||e,this._scene);n.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let e=0;e<this.bones.length;e++){const t=this.bones[e];let i=null;const r=t.getParent();if(r){const e=this.bones.indexOf(r);i=n.bones[e]}const s=new Gn.a(t.name,n,i,t.getBindMatrix().clone(),t.getRestMatrix().clone());s._index=t._index,t._linkedTransformNode&&s.linkTransformNode(t._linkedTransformNode),Ot.a.DeepCopy(t.animations,s.animations)}if(this._ranges){n._ranges={};for(const e in this._ranges){const t=this._ranges[e];t&&(n._ranges[e]=t.clone())}}return this._isDirty=!0,n.prepare(!0),n}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(t=>{t.enableBlending=!0,t.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){const e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let n=0;n<this.bones.length;n++){var t;const i=this.bones[n],r=i.getParent(),s={parentBoneIndex:r?this.bones.indexOf(r):-1,index:i.getIndex(),name:i.name,id:i.id,matrix:i.getBindMatrix().asArray(),rest:i.getRestMatrix().asArray(),linkedTransformNodeId:null===(t=i.getTransformNode())||void 0===t?void 0:t.id};e.bones.push(s),i.length&&(s.length=i.length),i.metadata&&(s.metadata=i.metadata),i.animations&&i.animations.length>0&&(s.animation=i.animations[0].serialize()),e.ranges=[];for(const t in this._ranges){const n=this._ranges[t];if(!n)continue;const i={};i.name=t,i.from=n.from,i.to=n.to,e.ranges.push(i)}}return e}static Parse(e,t){const n=new Xn(e.name,e.id,t);let i;for(e.dimensionsAtRest&&(n.dimensionsAtRest=r.e.FromArray(e.dimensionsAtRest)),n.needInitialSkinMatrix=e.needInitialSkinMatrix,i=0;i<e.bones.length;i++){const t=e.bones[i],s=e.bones[i].index;let a=null;t.parentBoneIndex>-1&&(a=n.bones[t.parentBoneIndex]);const o=t.rest?r.a.FromArray(t.rest):null,l=new Gn.a(t.name,n,a,r.a.FromArray(t.matrix),o,null,s);void 0!==t.id&&null!==t.id&&(l.id=t.id),t.length&&(l.length=t.length),t.metadata&&(l.metadata=t.metadata),t.animation&&l.animations.push(Vn.a.Parse(t.animation)),void 0!==t.linkedTransformNodeId&&null!==t.linkedTransformNodeId&&(n._hasWaitingData=!0,l._waitingTransformNodeId=t.linkedTransformNodeId)}if(e.ranges)for(i=0;i<e.ranges.length;i++){const t=e.ranges[i];n.createAnimationRange(t.name,t.from,t.to)}return n}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=[],t=new Array(this.bones.length);for(let n=0;n<this.bones.length;n++)this._sortBones(n,e,t);this.bones=e}_sortBones(e,t,n){if(n[e])return;n[e]=!0;const i=this.bones[e];if(!i)return;void 0===i._index&&(i._index=e);const r=i.getParent();r&&this._sortBones(this.bones.indexOf(r),t,n),t.push(i)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}constructor(e,t,n){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=r.a.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new _.a,this.bones=[],this._scene=n||E.a.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const i=this._scene.getEngine().getCaps();this._canUseTextureForBones=i.textureFloat&&i.maxVertexTextureImageUnits>0}}var jn=n(76);class zn{static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,n,i,r){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&(-1!==t.prePassRenderer.getIndex(2)||-1!==t.prePassRenderer.getIndex(11))){this.previousWorldMatrices[n.uniqueId]||(this.previousWorldMatrices[n.uniqueId]=i.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const r=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=r.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==r.frameId&&(this._lastUpdateFrameId=r.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[n.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[n.uniqueId]=i.clone()}}constructor(){this.previousWorldMatrices={},this.previousBones={}}}var Kn,Yn=n(388);class qn extends je{getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return!!e&&(!this._storeEffectOnSubMeshes||!e.subMeshes||0===e.subMeshes.length||this.isReadyForSubMesh(e,e.subMeshes[0],t))}_isReadyForSubMesh(e){const t=e.materialDefines;return!(this.checkReadyOnEveryCall||!e.effect||!t||t._renderId!==this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null,n){super._afterBind(e,t,n),this.getScene()._cachedEffect=t,n?n._drawWrapper._forceRebindOnNextCall=!1:this._drawWrapper._forceRebindOnNextCall=!1}_mustRebind(e,t,n,i=1){return n._drawWrapper._forceRebindOnNextCall||e.isCachedMaterialInvalid(this,t,i)}dispose(e,t,n){this._activeEffect=void 0,super.dispose(e,t,n)}constructor(e,t,n=!0,i=!1){super(e,t,void 0,i),this._normalMatrix=new r.a,this._storeEffectOnSubMeshes=n}}class Qn{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get BaseWeightTextureEnabled(){return this._BaseWeightTextureEnabled}static set BaseWeightTextureEnabled(e){this._BaseWeightTextureEnabled!==e&&(this._BaseWeightTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,C.a.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._TranslucencyIntensityTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get TranslucencyColorTextureEnabled(){return this._TranslucencyColorTextureEnabled}static set TranslucencyColorTextureEnabled(e){this._TranslucencyColorTextureEnabled!==e&&(this._TranslucencyColorTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,C.a.MarkAllMaterialsAsDirty(1))}}Qn._DiffuseTextureEnabled=!0,Qn._BaseWeightTextureEnabled=!0,Qn._DetailTextureEnabled=!0,Qn._DecalMapEnabled=!0,Qn._AmbientTextureEnabled=!0,Qn._OpacityTextureEnabled=!0,Qn._ReflectionTextureEnabled=!0,Qn._EmissiveTextureEnabled=!0,Qn._SpecularTextureEnabled=!0,Qn._BumpTextureEnabled=!0,Qn._LightmapTextureEnabled=!0,Qn._RefractionTextureEnabled=!0,Qn._ColorGradingTextureEnabled=!0,Qn._FresnelEnabled=!0,Qn._ClearCoatTextureEnabled=!0,Qn._ClearCoatBumpTextureEnabled=!0,Qn._ClearCoatTintTextureEnabled=!0,Qn._SheenTextureEnabled=!0,Qn._AnisotropicTextureEnabled=!0,Qn._ThicknessTextureEnabled=!0,Qn._RefractionIntensityTextureEnabled=!0,Qn._TranslucencyIntensityTextureEnabled=!0,Qn._TranslucencyColorTextureEnabled=!0,Qn._IridescenceTextureEnabled=!0;class Zn extends j{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class $n extends et{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}isReadyForSubMesh(e,t,n){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&n.getCaps().standardDerivatives&&this._texture&&Qn.DetailTextureEnabled&&!this._texture.isReady())}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const n=t.getEngine();e._areTexturesDirty&&(n.getCaps().standardDerivatives&&this._texture&&Qn.DetailTextureEnabled&&this._isEnabled?(Ce(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const n=this._material.isFrozen;e.useUbo&&n&&e.isSync||this._texture&&Qn.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),ye(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&Qn.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&(null===(t=this._texture)||void 0===t||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}constructor(e,t=!0){super(e,"DetailMap",140,new Zn,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=je.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}}Object(W.a)([Object(X.l)("detailTexture"),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],$n.prototype,"texture",void 0),Object(W.a)([Object(X.c)()],$n.prototype,"diffuseBlendLevel",void 0),Object(W.a)([Object(X.c)()],$n.prototype,"roughnessBlendLevel",void 0),Object(W.a)([Object(X.c)()],$n.prototype,"bumpLevel",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],$n.prototype,"normalBlendMethod",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],$n.prototype,"isEnabled",void 0),function(e){e[e.Zero=0]="Zero",e[e.One=1]="One",e[e.MaxViewZ=2]="MaxViewZ"}(Kn||(Kn={}));class Jn{static CreateConfiguration(e){return Jn._Configurations[e]={defines:{},previousWorldMatrices:{},previousViewProjection:r.a.Zero(),currentViewProjection:r.a.Zero(),previousBones:{},lastUpdateFrameId:-1,excludedSkinnedMesh:[]},Jn._Configurations[e]}static DeleteConfiguration(e){delete Jn._Configurations[e]}static GetConfiguration(e){return Jn._Configurations[e]}static AddUniformsAndSamplers(e,t){e.push("previousWorld","previousViewProjection","mPreviousBones")}static MarkAsDirty(e,t){for(const n of t)if(n.subMeshes)for(const t of n.subMeshes)t._removeDrawWrapper(e)}static PrepareDefines(e,t,n){if(!n._arePrePassDirty)return;const i=Jn._Configurations[e];if(!i)return;n.PREPASS=!0,n.PREPASS_COLOR=!1,n.PREPASS_COLOR_INDEX=-1;let r=0;for(let e=0;e<Jn.GeometryTextureDescriptions.length;e++){const t=Jn.GeometryTextureDescriptions[e],s=t.define,a=t.defineIndex,o=i.defines[a];void 0!==o?(n[s]=!0,n[a]=o,r++):(n[s]=!1,delete n[a])}n.SCENE_MRT_COUNT=r,n.BONES_VELOCITY_ENABLED=t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&!t.skeleton.isUsingTextureForMatrices&&-1===i.excludedSkinnedMesh.indexOf(t)}static Bind(e,t,n,i){const r=Jn._Configurations[e];if(r&&(void 0!==r.defines.PREPASS_VELOCITY_INDEX||void 0!==r.defines.PREPASS_VELOCITY_LINEAR_INDEX)){r.previousWorldMatrices[n.uniqueId]||(r.previousWorldMatrices[n.uniqueId]=i.clone());const e=n.getScene();r.previousViewProjection||(r.previousViewProjection=e.getTransformMatrix().clone(),r.currentViewProjection=e.getTransformMatrix().clone());const s=e.getEngine();if(r.currentViewProjection.updateFlag!==e.getTransformMatrix().updateFlag?(r.lastUpdateFrameId=s.frameId,r.previousViewProjection.copyFrom(r.currentViewProjection),r.currentViewProjection.copyFrom(e.getTransformMatrix())):r.lastUpdateFrameId!==s.frameId&&(r.lastUpdateFrameId=s.frameId,r.previousViewProjection.copyFrom(r.currentViewProjection)),t.setMatrix("previousWorld",r.previousWorldMatrices[n.uniqueId]),t.setMatrix("previousViewProjection",r.previousViewProjection),r.previousWorldMatrices[n.uniqueId]=i.clone(),n.useBones&&n.computeBonesUsingShaders&&n.skeleton){const e=n.skeleton;if(!e.isUsingTextureForMatrices||-1===t.getUniformIndex("boneTextureWidth")){const i=e.getTransformMatrices(n);i&&(r.previousBones[n.uniqueId]||(r.previousBones[n.uniqueId]=i.slice()),t.setMatrices("mPreviousBones",r.previousBones[n.uniqueId]),r.previousBones[n.uniqueId].set(i))}}}}}Jn.GeometryTextureDescriptions=[{type:0,name:"Irradiance",clearType:0,define:"PREPASS_IRRADIANCE",defineIndex:"PREPASS_IRRADIANCE_INDEX"},{type:1,name:"WorldPosition",clearType:0,define:"PREPASS_POSITION",defineIndex:"PREPASS_POSITION_INDEX"},{type:2,name:"Velocity",clearType:0,define:"PREPASS_VELOCITY",defineIndex:"PREPASS_VELOCITY_INDEX"},{type:3,name:"Reflectivity",clearType:0,define:"PREPASS_REFLECTIVITY",defineIndex:"PREPASS_REFLECTIVITY_INDEX"},{type:5,name:"ViewDepth",clearType:2,define:"PREPASS_DEPTH",defineIndex:"PREPASS_DEPTH_INDEX"},{type:6,name:"ViewNormal",clearType:0,define:"PREPASS_NORMAL",defineIndex:"PREPASS_NORMAL_INDEX"},{type:7,name:"AlbedoSqrt",clearType:0,define:"PREPASS_ALBEDO_SQRT",defineIndex:"PREPASS_ALBEDO_SQRT_INDEX"},{type:8,name:"WorldNormal",clearType:0,define:"PREPASS_WORLD_NORMAL",defineIndex:"PREPASS_WORLD_NORMAL_INDEX"},{type:9,name:"LocalPosition",clearType:0,define:"PREPASS_LOCAL_POSITION",defineIndex:"PREPASS_LOCAL_POSITION_INDEX"},{type:10,name:"ScreenDepth",clearType:1,define:"PREPASS_SCREENSPACE_DEPTH",defineIndex:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:11,name:"LinearVelocity",clearType:0,define:"PREPASS_VELOCITY_LINEAR",defineIndex:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:12,name:"Albedo",clearType:0,define:"PREPASS_ALBEDO",defineIndex:"PREPASS_ALBEDO_INDEX"}],Jn._Configurations={};const ei={effect:null,subMesh:null};class ti extends j{setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const n of t)this[n]=n===e}constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}}class ni extends qn{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}get hasRenderTargetTextures(){return!!(ni.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||!!(ni.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled)}needAlphaTesting(){return this._hasTransparencyMode?this._transparencyModeIsTest:this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===je.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==je.MATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){this._uniformBufferLayoutBuilt||this.buildUniformLayout();const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new ti(this._eventInfo.defineNames));const s=this.getScene(),a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=s.getEngine();a._needNormals=we(s,e,a,!0,this._maxSimultaneousLights,this._disableLighting),Ve(s,a);const l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(He(s,a,this.canRenderToMRT&&!l),Ge(s,a,l),Jn.PrepareDefines(o.currentRenderPassId,e,a),a._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a._needUVs=!1;for(let e=1;e<=6;++e)a["MAINUV"+e]=!1;if(s.texturesEnabled){if(a.DIFFUSEDIRECTUV=0,a.BUMPDIRECTUV=0,a.AMBIENTDIRECTUV=0,a.OPACITYDIRECTUV=0,a.EMISSIVEDIRECTUV=0,a.SPECULARDIRECTUV=0,a.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&ni.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;Ce(this._diffuseTexture,a,"DIFFUSE")}else a.DIFFUSE=!1;if(this._ambientTexture&&ni.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking())return!1;Ce(this._ambientTexture,a,"AMBIENT")}else a.AMBIENT=!1;if(this._opacityTexture&&ni.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking())return!1;Ce(this._opacityTexture,a,"OPACITY"),a.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else a.OPACITY=!1;if(this._reflectionTexture&&ni.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking())return!1;switch(a._needNormals=!0,a.REFLECTION=!0,a.ROUGHNESS=this._roughness>0,a.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,a.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===Et.a.INVCUBIC_MODE,a.REFLECTIONMAP_3D=this._reflectionTexture.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,a.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case Et.a.EXPLICIT_MODE:a.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case Et.a.PLANAR_MODE:a.setReflectionMode("REFLECTIONMAP_PLANAR");break;case Et.a.PROJECTION_MODE:a.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case Et.a.SKYBOX_MODE:a.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case Et.a.SPHERICAL_MODE:a.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case Et.a.EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case Et.a.FIXED_EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case Et.a.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case Et.a.CUBIC_MODE:case Et.a.INVCUBIC_MODE:default:a.setReflectionMode("REFLECTIONMAP_CUBIC")}a.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else a.REFLECTION=!1,a.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&ni.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking())return!1;Ce(this._emissiveTexture,a,"EMISSIVE")}else a.EMISSIVE=!1;if(this._lightmapTexture&&ni.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking())return!1;Ce(this._lightmapTexture,a,"LIGHTMAP"),a.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,a.RGBDLIGHTMAP=this._lightmapTexture.isRGBD}else a.LIGHTMAP=!1;if(this._specularTexture&&ni.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking())return!1;Ce(this._specularTexture,a,"SPECULAR"),a.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}else a.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&ni.BumpTextureEnabled){if(!this._bumpTexture.isReady())return!1;Ce(this._bumpTexture,a,"BUMP"),a.PARALLAX=this._useParallax,a.PARALLAX_RHS=s.useRightHandedSystem,a.PARALLAXOCCLUSION=this._useParallaxOcclusion,a.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else a.BUMP=!1,a.PARALLAX=!1,a.PARALLAX_RHS=!1,a.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&ni.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking())return!1;a._needUVs=!0,a.REFRACTION=!0,a.REFRACTIONMAP_3D=this._refractionTexture.isCube,a.RGBDREFRACTION=this._refractionTexture.isRGBD,a.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize}else a.REFRACTION=!1;a.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else a.DIFFUSE=!1,a.AMBIENT=!1,a.OPACITY=!1,a.REFLECTION=!1,a.EMISSIVE=!1,a.LIGHTMAP=!1,a.BUMP=!1,a.REFRACTION=!1;a.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),a.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,a.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,a.SPECULAROVERALPHA=this._useSpecularOverAlpha,a.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,a.ALPHATEST_AFTERALLALPHACOMPUTATIONS=null!==this.transparencyMode,a.ALPHABLEND=null===this.transparencyMode||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=a,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a),a.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,a.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}if(a._areFresnelDirty&&(ni.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(a.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,a.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,a.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,a.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,a.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,a.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,a._needNormals=!0,a.FRESNEL=!0):a.FRESNEL=!1),a.AREALIGHTUSED)for(let t=0;t<e.lightSources.length;t++)if(!e.lightSources[t]._isReady())return!1;Fe(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),a,this._applyDecalMapAfterDetailMap),Be(s,o,this,a,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=a,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),ke(e,a,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let c=!1;if(a.isDirty){const i=a._areLightsDisposed;a.markAsProcessed();const r=new It;a.REFLECTION&&r.addFallback(0,"REFLECTION"),a.SPECULAR&&r.addFallback(0,"SPECULAR"),a.BUMP&&r.addFallback(0,"BUMP"),a.PARALLAX&&r.addFallback(1,"PARALLAX"),a.PARALLAX_RHS&&r.addFallback(1,"PARALLAX_RHS"),a.PARALLAXOCCLUSION&&r.addFallback(0,"PARALLAXOCCLUSION"),a.SPECULAROVERALPHA&&r.addFallback(0,"SPECULAROVERALPHA"),a.FOG&&r.addFallback(1,"FOG"),a.POINTSIZE&&r.addFallback(0,"POINTSIZE"),a.LOGARITHMICDEPTH&&r.addFallback(0,"LOGARITHMICDEPTH"),Ne(a,r,this._maxSimultaneousLights),a.SPECULARTERM&&r.addFallback(0,"SPECULARTERM"),a.DIFFUSEFRESNEL&&r.addFallback(1,"DIFFUSEFRESNEL"),a.OPACITYFRESNEL&&r.addFallback(2,"OPACITYFRESNEL"),a.REFLECTIONFRESNEL&&r.addFallback(3,"REFLECTIONFRESNEL"),a.EMISSIVEFRESNEL&&r.addFallback(4,"EMISSIVEFRESNEL"),a.FRESNEL&&r.addFallback(4,"FRESNEL"),a.MULTIVIEW&&r.addFallback(0,"MULTIVIEW");const l=[z.b.PositionKind];a.NORMAL&&l.push(z.b.NormalKind),a.TANGENT&&l.push(z.b.TangentKind);for(let e=1;e<=6;++e)a["UV"+e]&&l.push("uv"+(1===e?"":e));a.VERTEXCOLOR&&l.push(z.b.ColorKind),Pe(l,e,a,r),Le(l,a),Ae(l,e,a),Me(l,0,a);let d="default";const h=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],u=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"],f=["Material","Scene","Mesh"],m={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:a.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=r,this._eventInfo.fallbackRank=0,this._eventInfo.defines=a,this._eventInfo.uniforms=h,this._eventInfo.attributes=l,this._eventInfo.samplers=u,this._eventInfo.uniformBuffersNames=f,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=m,this._callbackPluginEventGeneric(128,this._eventInfo),Jn.AddUniformsAndSamplers(h,u),zn.AddUniforms(h),zn.AddSamplers(u),Yn.a&&(Yn.a.PrepareUniforms(h,a),Yn.a.PrepareSamplers(u,a)),Xe({uniformsNames:h,uniformBuffersNames:f,samplers:u,defines:a,maxSimultaneousLights:this._maxSimultaneousLights}),fe(h);const p={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,h,f,u,a,l,p));const g=a.toString(),_=t.effect;let v=s.getEngine().createEffect(d,{attributes:l,uniformsNames:h,uniformBuffersNames:f,samplers:u,defines:g,fallbacks:r,onCompiled:this.onCompiled,onError:this.onError,indexParameters:m,processFinalCode:p.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:a.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this._shaderLanguage?await Promise.all([n.e(0).then(n.bind(null,530)),n.e(0).then(n.bind(null,525))]):await Promise.all([n.e(0).then(n.bind(null,531)),n.e(0).then(n.bind(null,522))]),this._shadersLoaded=!0}},o);if(this._eventInfo.customCode=void 0,v)if(this._onEffectCreatedObservable&&(ei.effect=v,ei.subMesh=t,this._onEffectCreatedObservable.notifyObservers(ei)),this.allowShaderHotSwapping&&_&&!v.isReady()){if(v=_,a.markAsUnprocessed(),c=this.isFrozen,i)return a._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(v,a,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(a._renderId=s.getRenderId(),r._wasPreviouslyReady=!c,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,n){const i=this.getScene(),r=n.materialDefines;if(!r)return;const s=n.effect;if(!s)return;this._activeEffect=s,t.getMeshUniformBuffer().bindToEffect(s,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(s,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,i,t,e,this.isFrozen),Jn.Bind(i.getEngine().currentRenderPassId,this._activeEffect,t,e),this._eventInfo.subMesh=n,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),r.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const a=this._mustRebind(i,s,n,t.visibility);Oe(t,s);const o=this._uniformBuffer;if(a){if(this.bindViewProjection(s),!o.useUbo||!this.isFrozen||!o.isSync||n._drawWrapper._forceRebindOnNextCall){if(ni.FresnelEnabled&&r.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(o.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),o.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&o.updateColor4("opacityParts",new he.a(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(o.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),o.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(o.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),o.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(o.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),o.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),i.texturesEnabled){if(this._diffuseTexture&&ni.DiffuseTextureEnabled&&(o.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),ye(this._diffuseTexture,o,"diffuse")),this._ambientTexture&&ni.AmbientTextureEnabled&&(o.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),ye(this._ambientTexture,o,"ambient")),this._opacityTexture&&ni.OpacityTextureEnabled&&(o.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),ye(this._opacityTexture,o,"opacity")),this._hasAlphaChannel()&&o.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&ni.ReflectionTextureEnabled){if(o.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),o.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize){const e=this._reflectionTexture;o.updateVector3("vReflectionPosition",e.boundingBoxPosition),o.updateVector3("vReflectionSize",e.boundingBoxSize)}}else o.updateFloat2("vReflectionInfos",0,this.roughness);if(this._emissiveTexture&&ni.EmissiveTextureEnabled&&(o.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),ye(this._emissiveTexture,o,"emissive")),this._lightmapTexture&&ni.LightmapTextureEnabled&&(o.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),ye(this._lightmapTexture,o,"lightmap")),this._specularTexture&&ni.SpecularTextureEnabled&&(o.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),ye(this._specularTexture,o,"specular")),this._bumpTexture&&i.getEngine().getCaps().standardDerivatives&&ni.BumpTextureEnabled&&(o.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),ye(this._bumpTexture,o,"bump"),i._mirroredCameraPosition?o.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):o.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&ni.RefractionTextureEnabled){let e=1;if(this._refractionTexture.isCube||(o.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(e=this._refractionTexture.depth)),o.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,e,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const e=this._refractionTexture;o.updateVector3("vRefractionPosition",e.boundingBoxPosition),o.updateVector3("vRefractionSize",e.boundingBoxSize)}}}this.pointsCloud&&o.updateFloat("pointSize",this.pointSize),o.updateColor4("vSpecularColor",this.specularColor,this.specularPower),o.updateColor3("vEmissiveColor",ni.EmissiveTextureEnabled?this.emissiveColor:he.a.BlackReadOnly),o.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),i.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),o.updateColor3("vAmbientColor",this._globalAmbientColor)}i.texturesEnabled&&(this._diffuseTexture&&ni.DiffuseTextureEnabled&&s.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&ni.AmbientTextureEnabled&&s.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&ni.OpacityTextureEnabled&&s.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&ni.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?s.setTexture("reflectionCubeSampler",this._reflectionTexture):s.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&ni.EmissiveTextureEnabled&&s.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&ni.LightmapTextureEnabled&&s.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&ni.SpecularTextureEnabled&&s.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&i.getEngine().getCaps().standardDerivatives&&ni.BumpTextureEnabled&&s.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&ni.RefractionTextureEnabled&&(this._refractionTexture.isCube?s.setTexture("refractionCubeSampler",this._refractionTexture):s.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(s),this._eventInfo.subMesh=n,this._callbackPluginEventBindForSubMesh(this._eventInfo),pe(s,this,i),this.bindEyePosition(s)}else i.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);var l;!a&&this.isFrozen||(i.lightsEnabled&&!this._disableLighting&&De(i,t,s,r,this._maxSimultaneousLights),(i.fogEnabled&&t.applyFog&&i.fogMode!==v.a.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||r.PREPASS)&&this.bindView(s),Te(i,t,s),r.NUM_MORPH_INFLUENCERS&&Ie(t,s),r.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(l=t.bakedVertexAnimationManager)||void 0===l||l.bind(s,r.INSTANCES)),this.useLogarithmicDepth&&Ee(r,s,i),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect));this._afterBind(t,this._activeEffect,n),o.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e}dispose(e,t){var n,i,r,s,a,o,l,c,d;t&&(null===(n=this._diffuseTexture)||void 0===n||n.dispose(),null===(i=this._ambientTexture)||void 0===i||i.dispose(),null===(r=this._opacityTexture)||void 0===r||r.dispose(),null===(s=this._reflectionTexture)||void 0===s||s.dispose(),null===(a=this._emissiveTexture)||void 0===a||a.dispose(),null===(o=this._specularTexture)||void 0===o||o.dispose(),null===(l=this._bumpTexture)||void 0===l||l.dispose(),null===(c=this._lightmapTexture)||void 0===c||c.dispose(),null===(d=this._refractionTexture)||void 0===d||d.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,n=""){const i=ce.a.Clone(()=>new ni(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return i.name=e,i.id=e,this.stencil.copyTo(i.stencil),this._clonePlugins(i,n),i}static Parse(e,t,n){const i=ce.a.Parse(()=>new ni(e.name,t),e,t,n);return e.stencil&&i.stencil.parse(e.stencil,t,n),je._ParsePlugins(e,i,t,n),i}static get DiffuseTextureEnabled(){return Qn.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){Qn.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return Qn.DetailTextureEnabled}static set DetailTextureEnabled(e){Qn.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return Qn.AmbientTextureEnabled}static set AmbientTextureEnabled(e){Qn.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return Qn.OpacityTextureEnabled}static set OpacityTextureEnabled(e){Qn.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return Qn.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){Qn.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return Qn.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){Qn.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return Qn.SpecularTextureEnabled}static set SpecularTextureEnabled(e){Qn.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return Qn.BumpTextureEnabled}static set BumpTextureEnabled(e){Qn.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return Qn.LightmapTextureEnabled}static set LightmapTextureEnabled(e){Qn.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return Qn.RefractionTextureEnabled}static set RefractionTextureEnabled(e){Qn.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return Qn.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){Qn.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return Qn.FresnelEnabled}static set FresnelEnabled(e){Qn.FresnelEnabled=e}constructor(e,t,n=!1){super(e,t,void 0,n||ni.ForceGLSL),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new he.a(0,0,0),this.diffuseColor=new he.a(1,1,1),this.specularColor=new he.a(1,1,1),this.emissiveColor=new he.a(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._shadersLoaded=!1,this._renderTargets=new ct.a(16),this._globalAmbientColor=new he.a(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new $n(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new zn,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),ni.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),ni.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}}ni.ForceGLSL=!1,Object(W.a)([Object(X.l)("diffuseTexture")],ni.prototype,"_diffuseTexture",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesAndMiscDirty")],ni.prototype,"diffuseTexture",void 0),Object(W.a)([Object(X.l)("ambientTexture")],ni.prototype,"_ambientTexture",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"ambientTexture",void 0),Object(W.a)([Object(X.l)("opacityTexture")],ni.prototype,"_opacityTexture",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesAndMiscDirty")],ni.prototype,"opacityTexture",void 0),Object(W.a)([Object(X.l)("reflectionTexture")],ni.prototype,"_reflectionTexture",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"reflectionTexture",void 0),Object(W.a)([Object(X.l)("emissiveTexture")],ni.prototype,"_emissiveTexture",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"emissiveTexture",void 0),Object(W.a)([Object(X.l)("specularTexture")],ni.prototype,"_specularTexture",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"specularTexture",void 0),Object(W.a)([Object(X.l)("bumpTexture")],ni.prototype,"_bumpTexture",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"bumpTexture",void 0),Object(W.a)([Object(X.l)("lightmapTexture")],ni.prototype,"_lightmapTexture",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"lightmapTexture",void 0),Object(W.a)([Object(X.l)("refractionTexture")],ni.prototype,"_refractionTexture",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"refractionTexture",void 0),Object(W.a)([Object(X.d)("ambient")],ni.prototype,"ambientColor",void 0),Object(W.a)([Object(X.d)("diffuse")],ni.prototype,"diffuseColor",void 0),Object(W.a)([Object(X.d)("specular")],ni.prototype,"specularColor",void 0),Object(W.a)([Object(X.d)("emissive")],ni.prototype,"emissiveColor",void 0),Object(W.a)([Object(X.c)()],ni.prototype,"specularPower",void 0),Object(W.a)([Object(X.c)("useAlphaFromDiffuseTexture")],ni.prototype,"_useAlphaFromDiffuseTexture",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesAndMiscDirty")],ni.prototype,"useAlphaFromDiffuseTexture",void 0),Object(W.a)([Object(X.c)("useEmissiveAsIllumination")],ni.prototype,"_useEmissiveAsIllumination",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"useEmissiveAsIllumination",void 0),Object(W.a)([Object(X.c)("linkEmissiveWithDiffuse")],ni.prototype,"_linkEmissiveWithDiffuse",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"linkEmissiveWithDiffuse",void 0),Object(W.a)([Object(X.c)("useSpecularOverAlpha")],ni.prototype,"_useSpecularOverAlpha",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"useSpecularOverAlpha",void 0),Object(W.a)([Object(X.c)("useReflectionOverAlpha")],ni.prototype,"_useReflectionOverAlpha",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"useReflectionOverAlpha",void 0),Object(W.a)([Object(X.c)("disableLighting")],ni.prototype,"_disableLighting",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsLightsDirty")],ni.prototype,"disableLighting",void 0),Object(W.a)([Object(X.c)("useObjectSpaceNormalMap")],ni.prototype,"_useObjectSpaceNormalMap",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"useObjectSpaceNormalMap",void 0),Object(W.a)([Object(X.c)("useParallax")],ni.prototype,"_useParallax",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"useParallax",void 0),Object(W.a)([Object(X.c)("useParallaxOcclusion")],ni.prototype,"_useParallaxOcclusion",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"useParallaxOcclusion",void 0),Object(W.a)([Object(X.c)()],ni.prototype,"parallaxScaleBias",void 0),Object(W.a)([Object(X.c)("roughness")],ni.prototype,"_roughness",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"roughness",void 0),Object(W.a)([Object(X.c)()],ni.prototype,"indexOfRefraction",void 0),Object(W.a)([Object(X.c)()],ni.prototype,"invertRefractionY",void 0),Object(W.a)([Object(X.c)()],ni.prototype,"alphaCutOff",void 0),Object(W.a)([Object(X.c)("useLightmapAsShadowmap")],ni.prototype,"_useLightmapAsShadowmap",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"useLightmapAsShadowmap",void 0),Object(W.a)([Object(X.g)("diffuseFresnelParameters")],ni.prototype,"_diffuseFresnelParameters",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsFresnelDirty")],ni.prototype,"diffuseFresnelParameters",void 0),Object(W.a)([Object(X.g)("opacityFresnelParameters")],ni.prototype,"_opacityFresnelParameters",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsFresnelAndMiscDirty")],ni.prototype,"opacityFresnelParameters",void 0),Object(W.a)([Object(X.g)("reflectionFresnelParameters")],ni.prototype,"_reflectionFresnelParameters",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsFresnelDirty")],ni.prototype,"reflectionFresnelParameters",void 0),Object(W.a)([Object(X.g)("refractionFresnelParameters")],ni.prototype,"_refractionFresnelParameters",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsFresnelDirty")],ni.prototype,"refractionFresnelParameters",void 0),Object(W.a)([Object(X.g)("emissiveFresnelParameters")],ni.prototype,"_emissiveFresnelParameters",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsFresnelDirty")],ni.prototype,"emissiveFresnelParameters",void 0),Object(W.a)([Object(X.c)("useReflectionFresnelFromSpecular")],ni.prototype,"_useReflectionFresnelFromSpecular",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsFresnelDirty")],ni.prototype,"useReflectionFresnelFromSpecular",void 0),Object(W.a)([Object(X.c)("useGlossinessFromSpecularMapAlpha")],ni.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"useGlossinessFromSpecularMapAlpha",void 0),Object(W.a)([Object(X.c)("maxSimultaneousLights")],ni.prototype,"_maxSimultaneousLights",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsLightsDirty")],ni.prototype,"maxSimultaneousLights",void 0),Object(W.a)([Object(X.c)("invertNormalMapX")],ni.prototype,"_invertNormalMapX",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"invertNormalMapX",void 0),Object(W.a)([Object(X.c)("invertNormalMapY")],ni.prototype,"_invertNormalMapY",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"invertNormalMapY",void 0),Object(W.a)([Object(X.c)("twoSidedLighting")],ni.prototype,"_twoSidedLighting",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ni.prototype,"twoSidedLighting",void 0),Object(W.a)([Object(X.c)("applyDecalMapAfterDetailMap")],ni.prototype,"_applyDecalMapAfterDetailMap",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsMiscDirty")],ni.prototype,"applyDecalMapAfterDetailMap",void 0),Object(Je.b)("BABYLON.StandardMaterial",ni),v.a.DefaultMaterialFactory=e=>new ni("default material",e);const ii={effect:null,subMesh:null};class ri extends qn{get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){-1===this._options.uniforms.indexOf(e)&&this._options.uniforms.push(e)}setTexture(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._textures[e]=t,this}removeTexture(e){delete this._textures[e]}setTextureArray(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return-1===this._options.externalTextures.indexOf(e)&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((e,t)=>(t.toArray(e,e.length),e),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((e,t)=>(t.toArray(e,e.length),e),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((e,t)=>(t.toArray(e,e.length),e),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const n=new Float32Array(16*t.length);for(let e=0;e<t.length;e++)t[e].copyToArray(n,16*e);return this._matrixArrays[e]=n,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return-1===this._options.uniformBuffers.indexOf(e)&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return-1===this._options.samplerObjects.indexOf(e)&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return-1===this._options.storageBuffers.indexOf(e)&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){const n=e.trimEnd()+" ",i=this.options.defines.findIndex(t=>t===e||t.startsWith(n));return i>=0&&this.options.defines.splice(i,1),("boolean"!=typeof t||t)&&this.options.defines.push(n+t),this}isReadyForSubMesh(e,t,n){return this.isReady(e,n,t)}isReady(e,t,n){var i,r,s;const a=n&&this._storeEffectOnSubMeshes;if(this.isFrozen){const e=a?n._drawWrapper:this._drawWrapper;if(e.effect&&e._wasPreviouslyReady&&e._wasPreviouslyUsingInstances===t)return!0}const o=this.getScene(),l=o.getEngine(),c=[],d=[];let h=null,u=this._shaderPath,f=this._options.uniforms,m=this._options.uniformBuffers,p=this._options.samplers;l.getCaps().multiview&&o.activeCamera&&o.activeCamera.outputRenderTarget&&o.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,c.push("#define MULTIVIEW"),-1!==f.indexOf("viewProjection")&&-1===f.indexOf("viewProjectionR")&&f.push("viewProjectionR"));for(let e=0;e<this._options.defines.length;e++){const t=0===this._options.defines[e].indexOf("#define")?this._options.defines[e]:"#define "+this._options.defines[e];c.push(t)}for(let e=0;e<this._options.attributes.length;e++)d.push(this._options.attributes[e]);if(e&&e.isVerticesDataPresent(z.b.ColorKind)&&(-1===d.indexOf(z.b.ColorKind)&&d.push(z.b.ColorKind),c.push("#define VERTEXCOLOR")),t&&(c.push("#define INSTANCES"),be(d,this._materialHelperNeedsPreviousMatrices),null!=e&&e.hasThinInstances&&(c.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(z.b.ColorInstanceKind)&&(d.push(z.b.ColorInstanceKind),c.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){d.push(z.b.MatricesIndicesKind),d.push(z.b.MatricesWeightsKind),e.numBoneInfluencers>4&&(d.push(z.b.MatricesIndicesExtraKind),d.push(z.b.MatricesWeightsExtraKind));const t=e.skeleton;c.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),h=new It,h.addCPUSkinningFallback(0,e),t.isUsingTextureForMatrices?(c.push("#define BONETEXTURE"),-1===f.indexOf("boneTextureWidth")&&f.push("boneTextureWidth"),-1===this._options.samplers.indexOf("boneSampler")&&this._options.samplers.push("boneSampler")):(c.push("#define BonesPerMesh "+(t.bones.length+1)),-1===f.indexOf("mBones")&&f.push("mBones"))}else c.push("#define NUM_BONE_INFLUENCERS 0");let g=0;const _=e?e.morphTargetManager:null;if(_){const t=-1!==c.indexOf("#define UV1"),n=-1!==c.indexOf("#define UV2"),i=-1!==c.indexOf("#define TANGENT"),r=-1!==c.indexOf("#define NORMAL"),s=-1!==c.indexOf("#define VERTEXCOLOR");g=Se(_,c,d,e,!0,r,i,t,n,s),_.isUsingTextureForTargets&&(-1===f.indexOf("morphTargetTextureIndices")&&f.push("morphTargetTextureIndices"),-1===this._options.samplers.indexOf("morphTargets")&&this._options.samplers.push("morphTargets")),g>0&&(f=f.slice(),f.push("morphTargetInfluences"),f.push("morphTargetCount"),f.push("morphTargetTextureInfo"),f.push("morphTargetTextureIndices"))}else c.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const t=e.bakedVertexAnimationManager;t&&t.isEnabled&&(c.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),-1===f.indexOf("bakedVertexAnimationSettings")&&f.push("bakedVertexAnimationSettings"),-1===f.indexOf("bakedVertexAnimationTextureSizeInverted")&&f.push("bakedVertexAnimationTextureSizeInverted"),-1===f.indexOf("bakedVertexAnimationTime")&&f.push("bakedVertexAnimationTime"),-1===this._options.samplers.indexOf("bakedVertexAnimationTexture")&&this._options.samplers.push("bakedVertexAnimationTexture")),Me(d,0,c)}for(const e in this._textures)if(!this._textures[e].isReady())return!1;e&&this.needAlphaTestingForMesh(e)&&c.push("#define ALPHATEST"),!1!==this._options.useClipPlane&&(fe(f),me(this,o,c)),o.fogEnabled&&null!=e&&e.applyFog&&o.fogMode!==v.a.FOGMODE_NONE&&(c.push("#define FOG"),-1===f.indexOf("view")&&f.push("view"),-1===f.indexOf("vFogInfos")&&f.push("vFogInfos"),-1===f.indexOf("vFogColor")&&f.push("vFogColor")),this._useLogarithmicDepth&&(c.push("#define LOGARITHMICDEPTH"),-1===f.indexOf("logarithmicDepthConstant")&&f.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(f=f.slice(),m=m.slice(),p=p.slice(),u=this.customShaderNameResolve(this.name,f,m,p,c,d));const E=a?n._getDrawWrapper(void 0,!0):this._drawWrapper,T=null!==(i=null==E?void 0:E.effect)&&void 0!==i?i:null,S=null!==(r=null==E?void 0:E.defines)&&void 0!==r?r:null,A=c.join("\n");let b=T;var I;return S!==A&&(b=l.createEffect(u,{attributes:d,uniformsNames:f,uniformBuffersNames:m,samplers:p,defines:A,fallbacks:h,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:g},shaderLanguage:this._options.shaderLanguage,extraInitializationsAsync:this._options.extraInitializationsAsync},l),a?n.setEffect(b,A,this._materialContext):E&&E.setEffect(b,A),this._onEffectCreatedObservable&&(ii.effect=b,ii.subMesh=null!==(I=null!=n?n:null==e?void 0:e.subMeshes[0])&&void 0!==I?I:null,this._onEffectCreatedObservable.notifyObservers(ii))),E._wasPreviouslyUsingInstances=!!t,!(null===(s=b)||void 0===s||!s.isReady()||(T!==b&&o.resetCachedMaterial(),E._wasPreviouslyReady=!0,0))}bindOnlyWorldMatrix(e,t){const n=null!=t?t:this.getEffect();if(!n)return;const i=this._options.uniforms;-1!==i.indexOf("world")&&n.setMatrix("world",e);const r=this.getScene();-1!==i.indexOf("worldView")&&(e.multiplyToRef(r.getViewMatrix(),this._cachedWorldViewMatrix),n.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==i.indexOf("worldViewProjection")&&(e.multiplyToRef(r.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),n.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)),-1!==i.indexOf("view")&&n.setMatrix("view",r.getViewMatrix())}bindForSubMesh(e,t,n){var i;this.bind(e,t,null===(i=n._drawWrapperOverride)||void 0===i?void 0:i.effect,n)}bind(e,t,n,i){const r=i&&this._storeEffectOnSubMeshes,s=null!=n?n:r?i.effect:this.getEffect();if(!s)return;const a=this.getScene();this._activeEffect=s,this.bindOnlyWorldMatrix(e,n);const o=this._options.uniformBuffers;let l=!1;if(s&&o&&o.length>0&&a.getEngine().supportsUniformBuffers)for(let n=0;n<o.length;++n)switch(o[n]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(s,"Mesh"),t.transferToEffect(e));break;case"Scene":Re(s,a.getSceneUniformBuffer()),a.finalizeSceneUbo(),l=!0}const c=t&&r?this._mustRebind(a,s,i,t.visibility):a.getCachedMaterial()!==this;if(s&&c){let e;for(e in l||-1===this._options.uniforms.indexOf("view")||s.setMatrix("view",a.getViewMatrix()),l||-1===this._options.uniforms.indexOf("projection")||s.setMatrix("projection",a.getProjectionMatrix()),l||-1===this._options.uniforms.indexOf("viewProjection")||(s.setMatrix("viewProjection",a.getTransformMatrix()),this._multiview&&s.setMatrix("viewProjectionR",a._transformMatrixR)),a.activeCamera&&-1!==this._options.uniforms.indexOf("cameraPosition")&&s.setVector3("cameraPosition",a.activeCamera.globalPosition),Oe(t,s),pe(s,this,a),this._useLogarithmicDepth&&Ee(r?i.materialDefines:s.defines,s,a),t&&Te(a,t,s),this._textures)s.setTexture(e,this._textures[e]);for(e in this._textureArrays)s.setTextureArray(e,this._textureArrays[e]);for(e in this._ints)s.setInt(e,this._ints[e]);for(e in this._uints)s.setUInt(e,this._uints[e]);for(e in this._floats)s.setFloat(e,this._floats[e]);for(e in this._floatsArrays)s.setArray(e,this._floatsArrays[e]);for(e in this._colors3)s.setColor3(e,this._colors3[e]);for(e in this._colors3Arrays)s.setArray3(e,this._colors3Arrays[e]);for(e in this._colors4){const t=this._colors4[e];s.setFloat4(e,t.r,t.g,t.b,t.a)}for(e in this._colors4Arrays)s.setArray4(e,this._colors4Arrays[e]);for(e in this._vectors2)s.setVector2(e,this._vectors2[e]);for(e in this._vectors3)s.setVector3(e,this._vectors3[e]);for(e in this._vectors4)s.setVector4(e,this._vectors4[e]);for(e in this._quaternions)s.setQuaternion(e,this._quaternions[e]);for(e in this._matrices)s.setMatrix(e,this._matrices[e]);for(e in this._matrixArrays)s.setMatrices(e,this._matrixArrays[e]);for(e in this._matrices3x3)s.setMatrix3x3(e,this._matrices3x3[e]);for(e in this._matrices2x2)s.setMatrix2x2(e,this._matrices2x2[e]);for(e in this._vectors2Arrays)s.setArray2(e,this._vectors2Arrays[e]);for(e in this._vectors3Arrays)s.setArray3(e,this._vectors3Arrays[e]);for(e in this._vectors4Arrays)s.setArray4(e,this._vectors4Arrays[e]);for(e in this._quaternionsArrays)s.setArray4(e,this._quaternionsArrays[e]);for(e in this._uniformBuffers){const t=this._uniformBuffers[e].getBuffer();t&&s.bindUniformBuffer(t,e)}const n=a.getEngine(),o=n.setExternalTexture;if(o)for(e in this._externalTextures)o.call(n,e,this._externalTextures[e]);const c=n.setTextureSampler;if(c)for(e in this._textureSamplers)c.call(n,e,this._textureSamplers[e]);const d=n.setStorageBuffer;if(d)for(e in this._storageBuffers)d.call(n,e,this._storageBuffers[e])}if(s&&t&&(c||!this.isFrozen)){Ie(t,s),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(s);const e=t.bakedVertexAnimationManager;if(e&&e.isEnabled){var d;const e=r?i._drawWrapper:this._drawWrapper;null===(d=t.bakedVertexAnimationManager)||void 0===d||d.bind(s,!!e._wasPreviouslyUsingInstances)}}this._afterBind(t,s,i)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const n=this._textureArrays[t];for(let t=0;t<n.length;t++)e.push(n[t])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const n=this._textureArrays[t];for(let t=0;t<n.length;t++)if(n[t]===e)return!0}return!1}clone(e){const t=ce.a.Clone(()=>new ri(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,"object"==typeof t._shaderPath&&(t._shaderPath={...t._shaderPath}),this._options={...this._options},Object.keys(this._options).forEach(e=>{const t=this._options[e];Array.isArray(t)&&(this._options[e]=t.slice(0))}),this.stencil.copyTo(t.stencil);for(const e in this._textures)t.setTexture(e,this._textures[e]);for(const e in this._textureArrays)t.setTextureArray(e,this._textureArrays[e]);for(const e in this._externalTextures)t.setExternalTexture(e,this._externalTextures[e]);for(const e in this._ints)t.setInt(e,this._ints[e]);for(const e in this._uints)t.setUInt(e,this._uints[e]);for(const e in this._floats)t.setFloat(e,this._floats[e]);for(const e in this._floatsArrays)t.setFloats(e,this._floatsArrays[e]);for(const e in this._colors3)t.setColor3(e,this._colors3[e]);for(const e in this._colors3Arrays)t._colors3Arrays[e]=this._colors3Arrays[e];for(const e in this._colors4)t.setColor4(e,this._colors4[e]);for(const e in this._colors4Arrays)t._colors4Arrays[e]=this._colors4Arrays[e];for(const e in this._vectors2)t.setVector2(e,this._vectors2[e]);for(const e in this._vectors3)t.setVector3(e,this._vectors3[e]);for(const e in this._vectors4)t.setVector4(e,this._vectors4[e]);for(const e in this._quaternions)t.setQuaternion(e,this._quaternions[e]);for(const e in this._quaternionsArrays)t._quaternionsArrays[e]=this._quaternionsArrays[e];for(const e in this._matrices)t.setMatrix(e,this._matrices[e]);for(const e in this._matrixArrays)t._matrixArrays[e]=this._matrixArrays[e].slice();for(const e in this._matrices3x3)t.setMatrix3x3(e,this._matrices3x3[e]);for(const e in this._matrices2x2)t.setMatrix2x2(e,this._matrices2x2[e]);for(const e in this._vectors2Arrays)t.setArray2(e,this._vectors2Arrays[e]);for(const e in this._vectors3Arrays)t.setArray3(e,this._vectors3Arrays[e]);for(const e in this._vectors4Arrays)t.setArray4(e,this._vectors4Arrays[e]);for(const e in this._uniformBuffers)t.setUniformBuffer(e,this._uniformBuffers[e]);for(const e in this._textureSamplers)t.setTextureSampler(e,this._textureSamplers[e]);for(const e in this._storageBuffers)t.setStorageBuffer(e,this._storageBuffers[e]);return t}dispose(e,t,n){if(t){let e;for(e in this._textures)this._textures[e].dispose();for(e in this._textureArrays){const t=this._textureArrays[e];for(let e=0;e<t.length;e++)t[e].dispose()}}this._textures={},super.dispose(e,t,n)}serialize(){const e=ce.a.Serialize(this);let t;for(t in e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes,e.stencil=this.stencil.serialize(),e.textures={},this._textures)e.textures[t]=this._textures[t].serialize();for(t in e.textureArrays={},this._textureArrays){e.textureArrays[t]=[];const n=this._textureArrays[t];for(let i=0;i<n.length;i++)e.textureArrays[t].push(n[i].serialize())}for(t in e.ints={},this._ints)e.ints[t]=this._ints[t];for(t in e.uints={},this._uints)e.uints[t]=this._uints[t];for(t in e.floats={},this._floats)e.floats[t]=this._floats[t];for(t in e.floatsArrays={},this._floatsArrays)e.floatsArrays[t]=this._floatsArrays[t];for(t in e.colors3={},this._colors3)e.colors3[t]=this._colors3[t].asArray();for(t in e.colors3Arrays={},this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];for(t in e.colors4={},this._colors4)e.colors4[t]=this._colors4[t].asArray();for(t in e.colors4Arrays={},this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];for(t in e.vectors2={},this._vectors2){const n=this._vectors2[t];e.vectors2[t]=[n.x,n.y]}for(t in e.vectors3={},this._vectors3){const n=this._vectors3[t];e.vectors3[t]=[n.x,n.y,n.z]}for(t in e.vectors4={},this._vectors4){const n=this._vectors4[t];e.vectors4[t]=[n.x,n.y,n.z,n.w]}for(t in e.quaternions={},this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();for(t in e.matrices={},this._matrices)e.matrices[t]=this._matrices[t].asArray();for(t in e.matrixArray={},this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];for(t in e.matrices3x3={},this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];for(t in e.matrices2x2={},this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];for(t in e.vectors2Arrays={},this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];for(t in e.vectors3Arrays={},this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];for(t in e.vectors4Arrays={},this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];for(t in e.quaternionsArrays={},this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,n){const i=ce.a.Parse(()=>new ri(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,n);let s;for(s in e.stencil&&i.stencil.parse(e.stencil,t,n),e.textures)i.setTexture(s,Et.a.Parse(e.textures[s],t,n));for(s in e.textureArrays){const r=e.textureArrays[s],a=[];for(let e=0;e<r.length;e++)a.push(Et.a.Parse(r[e],t,n));i.setTextureArray(s,a)}for(s in e.ints)i.setInt(s,e.ints[s]);for(s in e.uints)i.setUInt(s,e.uints[s]);for(s in e.floats)i.setFloat(s,e.floats[s]);for(s in e.floatsArrays)i.setFloats(s,e.floatsArrays[s]);for(s in e.colors3)i.setColor3(s,he.a.FromArray(e.colors3[s]));for(s in e.colors3Arrays){const t=e.colors3Arrays[s].reduce((e,t,n)=>(n%3==0?e.push([t]):e[e.length-1].push(t),e),[]).map(e=>he.a.FromArray(e));i.setColor3Array(s,t)}for(s in e.colors4)i.setColor4(s,he.b.FromArray(e.colors4[s]));for(s in e.colors4Arrays){const t=e.colors4Arrays[s].reduce((e,t,n)=>(n%4==0?e.push([t]):e[e.length-1].push(t),e),[]).map(e=>he.b.FromArray(e));i.setColor4Array(s,t)}for(s in e.vectors2)i.setVector2(s,r.d.FromArray(e.vectors2[s]));for(s in e.vectors3)i.setVector3(s,r.e.FromArray(e.vectors3[s]));for(s in e.vectors4)i.setVector4(s,r.f.FromArray(e.vectors4[s]));for(s in e.quaternions)i.setQuaternion(s,r.b.FromArray(e.quaternions[s]));for(s in e.matrices)i.setMatrix(s,r.a.FromArray(e.matrices[s]));for(s in e.matrixArray)i._matrixArrays[s]=new Float32Array(e.matrixArray[s]);for(s in e.matrices3x3)i.setMatrix3x3(s,e.matrices3x3[s]);for(s in e.matrices2x2)i.setMatrix2x2(s,e.matrices2x2[s]);for(s in e.vectors2Arrays)i.setArray2(s,e.vectors2Arrays[s]);for(s in e.vectors3Arrays)i.setArray3(s,e.vectors3Arrays[s]);for(s in e.vectors4Arrays)i.setArray4(s,e.vectors4Arrays[s]);for(s in e.quaternionsArrays)i.setArray4(s,e.quaternionsArrays[s]);return i}static ParseFromFileAsync(e,t,n,i=""){return new Promise((r,s)=>{const a=new y.a;a.addEventListener("readystatechange",()=>{if(4==a.readyState)if(200==a.status){const t=JSON.parse(a.responseText),s=this.Parse(t,n||E.a.LastCreatedScene,i);e&&(s.name=e),r(s)}else s("Unable to load the ShaderMaterial")}),a.open("GET",t),a.send()})}static ParseFromSnippetAsync(e,t,n=""){return new Promise((i,r)=>{const s=new y.a;s.addEventListener("readystatechange",()=>{if(4==s.readyState)if(200==s.status){const r=JSON.parse(JSON.parse(s.responseText).jsonPayload),a=JSON.parse(r.shaderMaterial),o=this.Parse(a,t||E.a.LastCreatedScene,n);o.snippetId=e,i(o)}else r("Unable to load the snippet "+e)}),s.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),s.send()})}constructor(e,t,n,i={},s=!0){super(e,t,s),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new r.a,this._cachedWorldViewProjectionMatrix=new r.a,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=n,this._options={needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1,...i}}}ri.SnippetUrl="https://snippet.babylonjs.com",ri.CreateFromSnippetAsync=ri.ParseFromSnippetAsync,Object(Je.b)("BABYLON.ShaderMaterial",ri),dt.a.AddNodeConstructor("Light_Type_3",(e,t)=>()=>new si(e,r.e.Zero(),t));class si extends gt{_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=r.e.Normalize(e.subtract(r.e.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const n=r.e.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",n.x,n.y,n.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const n=r.e.Normalize(this.direction);return e.setFloat3(t,n.x,n.y,n.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=r.a.Identity()),this._worldMatrix}getTypeID(){return gt.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}constructor(e,t,n){super(e,n),this.groundColor=new he.a(0,0,0),this.direction=t||r.e.Up()}}Object(W.a)([Object(X.d)()],si.prototype,"groundColor",void 0),Object(W.a)([Object(X.n)()],si.prototype,"direction",void 0),Object(Je.b)("BABYLON.HemisphericLight",si),dt.a.AddNodeConstructor("Light_Type_1",(e,t)=>()=>new ai(e,r.e.Zero(),t));class ai extends _t{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}getClassName(){return"DirectionalLight"}getTypeID(){return gt.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,n){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,n)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&r.a.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,n){const i=this.getScene().activeCamera;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const e=r.e.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let i=Number.MAX_VALUE,s=-Number.MAX_VALUE;for(let a=0;a<n.length;a++){const o=n[a];if(!o)continue;const l=o.getBoundingInfo().boundingBox;for(let n=0;n<l.vectorsWorld.length;n++)r.e.TransformCoordinatesToRef(l.vectorsWorld[n],t,e),e.x<this._orthoLeft&&(this._orthoLeft=e.x),e.y<this._orthoBottom&&(this._orthoBottom=e.y),e.x>this._orthoRight&&(this._orthoRight=e.x),e.y>this._orthoTop&&(this._orthoTop=e.y),this.autoCalcShadowZBounds&&(e.z<i&&(i=e.z),e.z>s&&(s=e.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=i,this._shadowMaxZ=s)}const s=this._orthoRight-this._orthoLeft,a=this._orthoTop-this._orthoBottom,o=void 0!==this.shadowMinZ?this.shadowMinZ:(null==i?void 0:i.minZ)||0,l=void 0!==this.shadowMaxZ?this.shadowMaxZ:(null==i?void 0:i.maxZ)||1e4,c=this.getScene().getEngine().useReverseDepthBuffer;r.a.OrthoOffCenterLHToRef(this._orthoLeft-s*this.shadowOrthoScale,this._orthoRight+s*this.shadowOrthoScale,this._orthoBottom-a*this.shadowOrthoScale,this._orthoTop+a*this.shadowOrthoScale,c?l:o,c?o:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}constructor(e,t,n){super(e,n),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}}Object(W.a)([Object(X.c)()],ai.prototype,"shadowFrustumSize",null),Object(W.a)([Object(X.c)()],ai.prototype,"shadowOrthoScale",null),Object(W.a)([Object(X.c)()],ai.prototype,"autoUpdateExtends",void 0),Object(W.a)([Object(X.c)()],ai.prototype,"autoCalcShadowZBounds",void 0),Object(W.a)([Object(X.c)("orthoLeft")],ai.prototype,"_orthoLeft",void 0),Object(W.a)([Object(X.c)("orthoRight")],ai.prototype,"_orthoRight",void 0),Object(W.a)([Object(X.c)("orthoTop")],ai.prototype,"_orthoTop",void 0),Object(W.a)([Object(X.c)("orthoBottom")],ai.prototype,"_orthoBottom",void 0),Object(Je.b)("BABYLON.DirectionalLight",ai),dt.a.AddNodeConstructor("Light_Type_2",(e,t)=>()=>new oi(e,r.e.Zero(),r.e.Zero(),0,0,t));class oi extends _t{get iesProfileTexture(){return this._iesProfileTexture}set iesProfileTexture(e){this._iesProfileTexture!==e&&(this._iesProfileTexture=e,this._iesProfileTexture&&oi._IsTexture(this._iesProfileTexture)&&this._iesProfileTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()}))}get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(.5*e),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(oi._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):oi._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return void 0!==e.onGeneratedObservable}static _IsTexture(e){return void 0!==e.onLoadObservable}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}getClassName(){return"SpotLight"}getTypeID(){return gt.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,n){const i=this.getScene().activeCamera;if(!i)return;this._shadowAngleScale=this._shadowAngleScale||1;const s=this._shadowAngleScale*this._angle,a=void 0!==this.shadowMinZ?this.shadowMinZ:i.minZ,o=void 0!==this.shadowMaxZ?this.shadowMaxZ:i.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;r.a.PerspectiveFovLHToRef(s,1,l?o:a,l?a:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.getShadowDirection(),this._projectionTextureViewTargetVector),r.a.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,n=e/(e-t),i=-n*t,s=1/Math.tan(this._angle/2);r.a.FromValuesToRef(s/1,0,0,0,0,s,0,0,0,0,n,1,0,0,i,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof Et.a){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;r.a.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(.5*this._innerAngle)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightTexture"+t,this.projectionTexture)),this._iesProfileTexture&&this._iesProfileTexture.isReady()&&e.setTexture("iesLightTexture"+t,this._iesProfileTexture),this}transferToEffect(e,t){let n;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),n=r.e.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),n=r.e.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",n.x,n.y,n.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let n;return n=this.computeTransformedInformation()?r.e.Normalize(this.transformedDirection):r.e.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-n.x,-n.y,-n.z):e.setFloat3(t,n.x,n.y,n.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose(),this._iesProfileTexture&&(this._iesProfileTexture.dispose(),this._iesProfileTexture=null)}getDepthMinZ(e){var t;const n=this._scene.getEngine(),i=void 0!==this.shadowMinZ?this.shadowMinZ:null!==(t=null==e?void 0:e.minZ)&&void 0!==t?t:0;return n.useReverseDepthBuffer&&n.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){var t;const n=this._scene.getEngine(),i=void 0!==this.shadowMaxZ?this.shadowMaxZ:null!==(t=null==e?void 0:e.maxZ)&&void 0!==t?t:1e4;return n.useReverseDepthBuffer&&n.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!(!this.projectionTexture||!this.projectionTexture.isReady()),e["IESLIGHTTEXTURE"+t]=!(!this._iesProfileTexture||!this._iesProfileTexture.isReady())}constructor(e,t,n,i,s,a){super(e,a),this._innerAngle=0,this._iesProfileTexture=null,this._projectionTextureMatrix=r.a.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=r.e.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=r.e.Zero(),this._projectionTextureViewLightMatrix=r.a.Zero(),this._projectionTextureProjectionLightMatrix=r.a.Zero(),this._projectionTextureScalingMatrix=r.a.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=n,this.angle=i,this.exponent=s}}Object(W.a)([Object(X.c)()],oi.prototype,"angle",null),Object(W.a)([Object(X.c)()],oi.prototype,"innerAngle",null),Object(W.a)([Object(X.c)()],oi.prototype,"shadowAngleScale",null),Object(W.a)([Object(X.c)()],oi.prototype,"exponent",void 0),Object(W.a)([Object(X.c)()],oi.prototype,"projectionTextureLightNear",null),Object(W.a)([Object(X.c)()],oi.prototype,"projectionTextureLightFar",null),Object(W.a)([Object(X.c)()],oi.prototype,"projectionTextureUpDirection",null),Object(W.a)([Object(X.l)("projectedLightTexture")],oi.prototype,"_projectionTexture",void 0),Object(Je.b)("BABYLON.SpotLight",oi);class li{static SetMatrix(e,t,n,i,s){let a=null;if("MODEL"===n.semantic?a=t.getWorldMatrix():"PROJECTION"===n.semantic?a=e.getProjectionMatrix():"VIEW"===n.semantic?a=e.getViewMatrix():"MODELVIEWINVERSETRANSPOSE"===n.semantic?a=r.a.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):"MODELVIEW"===n.semantic?a=t.getWorldMatrix().multiply(e.getViewMatrix()):"MODELVIEWPROJECTION"===n.semantic?a=t.getWorldMatrix().multiply(e.getTransformMatrix()):"MODELINVERSE"===n.semantic?a=t.getWorldMatrix().invert():"VIEWINVERSE"===n.semantic?a=e.getViewMatrix().invert():"PROJECTIONINVERSE"===n.semantic?a=e.getProjectionMatrix().invert():"MODELVIEWINVERSE"===n.semantic?a=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():"MODELVIEWPROJECTIONINVERSE"===n.semantic?a=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():"MODELINVERSETRANSPOSE"===n.semantic&&(a=r.a.Transpose(t.getWorldMatrix().invert())),a)switch(n.type){case Sn.FLOAT_MAT2:s.setMatrix2x2(i,r.a.GetAsMatrix2x2(a));break;case Sn.FLOAT_MAT3:s.setMatrix3x3(i,r.a.GetAsMatrix3x3(a));break;case Sn.FLOAT_MAT4:s.setMatrix(i,a)}}static SetUniform(e,t,n,i){switch(i){case Sn.FLOAT:return e.setFloat(t,n),!0;case Sn.FLOAT_VEC2:return e.setVector2(t,r.d.FromArray(n)),!0;case Sn.FLOAT_VEC3:return e.setVector3(t,r.e.FromArray(n)),!0;case Sn.FLOAT_VEC4:return e.setVector4(t,r.f.FromArray(n)),!0;default:return!1}}static GetWrapMode(e){switch(e){case An.CLAMP_TO_EDGE:return Et.a.CLAMP_ADDRESSMODE;case An.MIRRORED_REPEAT:return Et.a.MIRROR_ADDRESSMODE;case An.REPEAT:default:return Et.a.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case bn.LINEAR:case bn.LINEAR_MIPMAP_NEAREST:case bn.LINEAR_MIPMAP_LINEAR:return Et.a.TRILINEAR_SAMPLINGMODE;case bn.NEAREST:case bn.NEAREST_MIPMAP_NEAREST:return Et.a.NEAREST_SAMPLINGMODE;default:return Et.a.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,n,i,r){n=t.byteOffset+n;const s=e.loadedBufferViews[t.buffer];if(n+i>s.byteLength)throw new Error("Buffer access is out of range");const a=s.buffer;switch(n+=s.byteOffset,r){case En.BYTE:return new Int8Array(a,n,i);case En.UNSIGNED_BYTE:return new Uint8Array(a,n,i);case En.SHORT:return new Int16Array(a,n,i);case En.UNSIGNED_SHORT:return new Uint16Array(a,n,i);default:return new Float32Array(a,n,i)}}static GetBufferFromAccessor(e,t){const n=e.bufferViews[t.bufferView],i=t.count*li.GetByteStrideFromType(t);return li.GetBufferFromBufferView(e,n,t.byteOffset,i,t.componentType)}static DecodeBufferToText(e){let t="";const n=e.byteLength;for(let i=0;i<n;++i)t+=String.fromCharCode(e[i]);return t}static GetDefaultMaterial(e){if(!li._DefaultMaterial){jn.a.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join("\n"),jn.a.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join("\n");const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},n={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};li._DefaultMaterial=new ri("GLTFDefaultMaterial",e,t,n),li._DefaultMaterial.setColor4("u_emission",new he.b(.5,.5,.5,1))}return li._DefaultMaterial}}li._DefaultMaterial=null;class ci{}var di;ci.AUTOSAMPLERSUFFIX="Sampler",ci.DISABLEUA="#define DISABLE_UNIFORMITY_ANALYSIS",ci.ALPHA_DISABLE=0,ci.ALPHA_ADD=1,ci.ALPHA_COMBINE=2,ci.ALPHA_SUBTRACT=3,ci.ALPHA_MULTIPLY=4,ci.ALPHA_MAXIMIZED=5,ci.ALPHA_ONEONE=6,ci.ALPHA_PREMULTIPLIED=7,ci.ALPHA_PREMULTIPLIED_PORTERDUFF=8,ci.ALPHA_INTERPOLATE=9,ci.ALPHA_SCREENMODE=10,ci.ALPHA_ONEONE_ONEONE=11,ci.ALPHA_ALPHATOCOLOR=12,ci.ALPHA_REVERSEONEMINUS=13,ci.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,ci.ALPHA_ONEONE_ONEZERO=15,ci.ALPHA_EXCLUSION=16,ci.ALPHA_LAYER_ACCUMULATE=17,ci.ALPHA_EQUATION_ADD=0,ci.ALPHA_EQUATION_SUBSTRACT=1,ci.ALPHA_EQUATION_REVERSE_SUBTRACT=2,ci.ALPHA_EQUATION_MAX=3,ci.ALPHA_EQUATION_MIN=4,ci.ALPHA_EQUATION_DARKEN=5,ci.DELAYLOADSTATE_NONE=0,ci.DELAYLOADSTATE_LOADED=1,ci.DELAYLOADSTATE_LOADING=2,ci.DELAYLOADSTATE_NOTLOADED=4,ci.NEVER=512,ci.ALWAYS=519,ci.LESS=513,ci.EQUAL=514,ci.LEQUAL=515,ci.GREATER=516,ci.GEQUAL=518,ci.NOTEQUAL=517,ci.KEEP=7680,ci.ZERO=0,ci.REPLACE=7681,ci.INCR=7682,ci.DECR=7683,ci.INVERT=5386,ci.INCR_WRAP=34055,ci.DECR_WRAP=34056,ci.TEXTURE_CLAMP_ADDRESSMODE=0,ci.TEXTURE_WRAP_ADDRESSMODE=1,ci.TEXTURE_MIRROR_ADDRESSMODE=2,ci.TEXTURE_CREATIONFLAG_STORAGE=1,ci.TEXTUREFORMAT_ALPHA=0,ci.TEXTUREFORMAT_LUMINANCE=1,ci.TEXTUREFORMAT_LUMINANCE_ALPHA=2,ci.TEXTUREFORMAT_RGB=4,ci.TEXTUREFORMAT_RGBA=5,ci.TEXTUREFORMAT_RED=6,ci.TEXTUREFORMAT_R=6,ci.TEXTUREFORMAT_R16_UNORM=33322,ci.TEXTUREFORMAT_RG16_UNORM=33324,ci.TEXTUREFORMAT_RGB16_UNORM=32852,ci.TEXTUREFORMAT_RGBA16_UNORM=32859,ci.TEXTUREFORMAT_R16_SNORM=36760,ci.TEXTUREFORMAT_RG16_SNORM=36761,ci.TEXTUREFORMAT_RGB16_SNORM=36762,ci.TEXTUREFORMAT_RGBA16_SNORM=36763,ci.TEXTUREFORMAT_RG=7,ci.TEXTUREFORMAT_RED_INTEGER=8,ci.TEXTUREFORMAT_R_INTEGER=8,ci.TEXTUREFORMAT_RG_INTEGER=9,ci.TEXTUREFORMAT_RGB_INTEGER=10,ci.TEXTUREFORMAT_RGBA_INTEGER=11,ci.TEXTUREFORMAT_BGRA=12,ci.TEXTUREFORMAT_DEPTH24_STENCIL8=13,ci.TEXTUREFORMAT_DEPTH32_FLOAT=14,ci.TEXTUREFORMAT_DEPTH16=15,ci.TEXTUREFORMAT_DEPTH24=16,ci.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,ci.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,ci.TEXTUREFORMAT_STENCIL8=19,ci.TEXTUREFORMAT_UNDEFINED=4294967295,ci.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,ci.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,ci.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,ci.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,ci.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,ci.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,ci.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,ci.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,ci.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,ci.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,ci.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,ci.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,ci.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,ci.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,ci.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,ci.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,ci.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,ci.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,ci.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,ci.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,ci.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,ci.TEXTURETYPE_UNSIGNED_BYTE=0,ci.TEXTURETYPE_UNSIGNED_INT=0,ci.TEXTURETYPE_FLOAT=1,ci.TEXTURETYPE_HALF_FLOAT=2,ci.TEXTURETYPE_BYTE=3,ci.TEXTURETYPE_SHORT=4,ci.TEXTURETYPE_UNSIGNED_SHORT=5,ci.TEXTURETYPE_INT=6,ci.TEXTURETYPE_UNSIGNED_INTEGER=7,ci.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,ci.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,ci.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,ci.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,ci.TEXTURETYPE_UNSIGNED_INT_24_8=12,ci.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,ci.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,ci.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,ci.TEXTURETYPE_UNDEFINED=16,ci.TEXTURE_2D=3553,ci.TEXTURE_2D_ARRAY=35866,ci.TEXTURE_CUBE_MAP=34067,ci.TEXTURE_CUBE_MAP_ARRAY=3735928559,ci.TEXTURE_3D=32879,ci.TEXTURE_NEAREST_SAMPLINGMODE=1,ci.TEXTURE_NEAREST_NEAREST=1,ci.TEXTURE_BILINEAR_SAMPLINGMODE=2,ci.TEXTURE_LINEAR_LINEAR=2,ci.TEXTURE_TRILINEAR_SAMPLINGMODE=3,ci.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,ci.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,ci.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,ci.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,ci.TEXTURE_NEAREST_LINEAR=7,ci.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,ci.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,ci.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,ci.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,ci.TEXTURE_LINEAR_NEAREST=12,ci.TEXTURE_EXPLICIT_MODE=0,ci.TEXTURE_SPHERICAL_MODE=1,ci.TEXTURE_PLANAR_MODE=2,ci.TEXTURE_CUBIC_MODE=3,ci.TEXTURE_PROJECTION_MODE=4,ci.TEXTURE_SKYBOX_MODE=5,ci.TEXTURE_INVCUBIC_MODE=6,ci.TEXTURE_EQUIRECTANGULAR_MODE=7,ci.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,ci.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,ci.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,ci.TEXTURE_FILTERING_QUALITY_HIGH=64,ci.TEXTURE_FILTERING_QUALITY_MEDIUM=16,ci.TEXTURE_FILTERING_QUALITY_LOW=8,ci.SCALEMODE_FLOOR=1,ci.SCALEMODE_NEAREST=2,ci.SCALEMODE_CEILING=3,ci.MATERIAL_TextureDirtyFlag=1,ci.MATERIAL_LightDirtyFlag=2,ci.MATERIAL_FresnelDirtyFlag=4,ci.MATERIAL_AttributesDirtyFlag=8,ci.MATERIAL_MiscDirtyFlag=16,ci.MATERIAL_PrePassDirtyFlag=32,ci.MATERIAL_AllDirtyFlag=63,ci.MATERIAL_TriangleFillMode=0,ci.MATERIAL_WireFrameFillMode=1,ci.MATERIAL_PointFillMode=2,ci.MATERIAL_PointListDrawMode=3,ci.MATERIAL_LineListDrawMode=4,ci.MATERIAL_LineLoopDrawMode=5,ci.MATERIAL_LineStripDrawMode=6,ci.MATERIAL_TriangleStripDrawMode=7,ci.MATERIAL_TriangleFanDrawMode=8,ci.MATERIAL_ClockWiseSideOrientation=0,ci.MATERIAL_CounterClockWiseSideOrientation=1,ci.ACTION_NothingTrigger=0,ci.ACTION_OnPickTrigger=1,ci.ACTION_OnLeftPickTrigger=2,ci.ACTION_OnRightPickTrigger=3,ci.ACTION_OnCenterPickTrigger=4,ci.ACTION_OnPickDownTrigger=5,ci.ACTION_OnDoublePickTrigger=6,ci.ACTION_OnPickUpTrigger=7,ci.ACTION_OnPickOutTrigger=16,ci.ACTION_OnLongPressTrigger=8,ci.ACTION_OnPointerOverTrigger=9,ci.ACTION_OnPointerOutTrigger=10,ci.ACTION_OnEveryFrameTrigger=11,ci.ACTION_OnIntersectionEnterTrigger=12,ci.ACTION_OnIntersectionExitTrigger=13,ci.ACTION_OnKeyDownTrigger=14,ci.ACTION_OnKeyUpTrigger=15,ci.PARTICLES_BILLBOARDMODE_Y=2,ci.PARTICLES_BILLBOARDMODE_ALL=7,ci.PARTICLES_BILLBOARDMODE_STRETCHED=8,ci.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,ci.MESHES_CULLINGSTRATEGY_STANDARD=0,ci.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,ci.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,ci.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,ci.SCENELOADER_NO_LOGGING=0,ci.SCENELOADER_MINIMAL_LOGGING=1,ci.SCENELOADER_SUMMARY_LOGGING=2,ci.SCENELOADER_DETAILED_LOGGING=3,ci.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,ci.PREPASS_POSITION_TEXTURE_TYPE=1,ci.PREPASS_VELOCITY_TEXTURE_TYPE=2,ci.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,ci.PREPASS_COLOR_TEXTURE_TYPE=4,ci.PREPASS_DEPTH_TEXTURE_TYPE=5,ci.PREPASS_NORMAL_TEXTURE_TYPE=6,ci.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,ci.PREPASS_WORLD_NORMAL_TEXTURE_TYPE=8,ci.PREPASS_LOCAL_POSITION_TEXTURE_TYPE=9,ci.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE=10,ci.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE=11,ci.PREPASS_ALBEDO_TEXTURE_TYPE=12,ci.BUFFER_CREATIONFLAG_READ=1,ci.BUFFER_CREATIONFLAG_WRITE=2,ci.BUFFER_CREATIONFLAG_READWRITE=3,ci.BUFFER_CREATIONFLAG_UNIFORM=4,ci.BUFFER_CREATIONFLAG_VERTEX=8,ci.BUFFER_CREATIONFLAG_INDEX=16,ci.BUFFER_CREATIONFLAG_STORAGE=32,ci.BUFFER_CREATIONFLAG_INDIRECT=64,ci.RENDERPASS_MAIN=0,ci.INPUT_ALT_KEY=18,ci.INPUT_CTRL_KEY=17,ci.INPUT_META_KEY1=91,ci.INPUT_META_KEY2=92,ci.INPUT_META_KEY3=93,ci.INPUT_SHIFT_KEY=16,ci.SNAPSHOTRENDERING_STANDARD=0,ci.SNAPSHOTRENDERING_FAST=1,ci.PERSPECTIVE_CAMERA=0,ci.ORTHOGRAPHIC_CAMERA=1,ci.FOVMODE_VERTICAL_FIXED=0,ci.FOVMODE_HORIZONTAL_FIXED=1,ci.RIG_MODE_NONE=0,ci.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,ci.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,ci.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,ci.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,ci.RIG_MODE_STEREOSCOPIC_INTERLACED=14,ci.RIG_MODE_VR=20,ci.RIG_MODE_CUSTOM=22,ci.MAX_SUPPORTED_UV_SETS=6,ci.GL_ALPHA_EQUATION_ADD=32774,ci.GL_ALPHA_EQUATION_MIN=32775,ci.GL_ALPHA_EQUATION_MAX=32776,ci.GL_ALPHA_EQUATION_SUBTRACT=32778,ci.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,ci.GL_ALPHA_FUNCTION_SRC=768,ci.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,ci.GL_ALPHA_FUNCTION_SRC_ALPHA=770,ci.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,ci.GL_ALPHA_FUNCTION_DST_ALPHA=772,ci.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,ci.GL_ALPHA_FUNCTION_DST_COLOR=774,ci.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,ci.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,ci.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,ci.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,ci.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,ci.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,ci.GL_ALPHA_FUNCTION_SRC1_COLOR=35065,ci.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_COLOR=35066,ci.GL_ALPHA_FUNCTION_SRC1_ALPHA=34185,ci.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_ALPHA=35067,ci.SnippetUrl="https://snippet.babylonjs.com",ci.FOGMODE_NONE=0,ci.FOGMODE_EXP=1,ci.FOGMODE_EXP2=2,ci.FOGMODE_LINEAR=3,ci.BYTE=5120,ci.UNSIGNED_BYTE=5121,ci.SHORT=5122,ci.UNSIGNED_SHORT=5123,ci.INT=5124,ci.UNSIGNED_INT=5125,ci.FLOAT=5126,ci.PositionKind="position",ci.NormalKind="normal",ci.TangentKind="tangent",ci.UVKind="uv",ci.UV2Kind="uv2",ci.UV3Kind="uv3",ci.UV4Kind="uv4",ci.UV5Kind="uv5",ci.UV6Kind="uv6",ci.ColorKind="color",ci.ColorInstanceKind="instanceColor",ci.MatricesIndicesKind="matricesIndices",ci.MatricesWeightsKind="matricesWeights",ci.MatricesIndicesExtraKind="matricesIndicesExtra",ci.MatricesWeightsExtraKind="matricesWeightsExtra",ci.ShadowMinZ=0,ci.ShadowMaxZ=1e4,function(e){e[e.IDENTIFIER=1]="IDENTIFIER",e[e.UNKNOWN=2]="UNKNOWN",e[e.END_OF_INPUT=3]="END_OF_INPUT"}(di||(di={}));class hi{getNextToken(){if(this.isEnd())return di.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=di.UNKNOWN,"_"===this.currentString||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=di.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||"_"===this.currentString);)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}constructor(e){this._pos=0,this.currentToken=di.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}}const ui=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],fi=["world","view","projection","worldView","worldViewProjection","mBones"],mi=["translation","rotation","scale"],pi=["position","rotationQuaternion","scaling"],gi=(e,t,n)=>{for(const i in e){const r=e[i];n[t][i]=r}},_i=e=>{if(e)for(let t=0;t<e.length/2;t++)e[2*t+1]=1-e[2*t+1]},vi=e=>{if("NORMAL"===e.semantic)return"normal";if("POSITION"===e.semantic)return"position";if("JOINT"===e.semantic)return"matricesIndices";if("WEIGHT"===e.semantic)return"matricesWeights";if("COLOR"===e.semantic)return"color";if(e.semantic&&-1!==e.semantic.indexOf("TEXCOORD_")){const t=Number(e.semantic.split("_")[1]);return"uv"+(0===t?"":t+1)}return null},Ei=e=>{let t=null;if(e.translation||e.rotation||e.scale){const n=r.e.FromArray(e.scale||[1,1,1]),i=r.b.FromArray(e.rotation||[0,0,0,1]),s=r.e.FromArray(e.translation||[0,0,0]);t=r.a.Compose(n,i,s)}else t=r.a.FromArray(e.matrix);return t},Ti=(e,t,n,i)=>{for(let e=0;e<i.bones.length;e++)if(i.bones[e].name===n)return i.bones[e];const r=e.nodes;for(const s in r){const a=r[s];if(!a.jointName)continue;const o=a.children;for(let r=0;r<o.length;r++){const l=e.nodes[o[r]];if(l.jointName&&l.jointName===n){const n=Ei(a),r=new Gn.a(a.name||"",i,Ti(e,t,a.jointName,i),n);return r.id=s,r}}}return null},Si=(e,t)=>{for(let n=0;n<e.length;n++){const i=e[n];for(let e=0;e<i.node.children.length;e++)if(i.node.children[e]===t)return i.bone}return null},Ai=(e,t)=>{const n=e.nodes;let i=n[t];if(i)return{node:i,id:t};for(const e in n)if(i=n[e],i.jointName===t)return{node:i,id:e};return null},bi=(e,t)=>{for(let n=0;n<e.jointNames.length;n++)if(e.jointNames[n]===t)return!0;return!1},Ii=(e,t,n,i,r)=>{if(r||(e.scene._blockEntityCollection=!!e.assetContainer,(r=new en(t.name||"",e.scene))._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,r.id=i),!t.babylonNode)return r;const s=[];let a=null;const o=[],l=[],c=[],d=[];for(let t=0;t<n.length;t++){const i=n[t],r=e.meshes[i];if(r)for(let t=0;t<r.primitives.length;t++){const n=new Ft,i=r.primitives[t];i.mode;const h=i.attributes;let u=null,f=null;for(const t in h)if(u=e.accessors[h[t]],f=li.GetBufferFromAccessor(e,u),"NORMAL"===t)n.normals=new Float32Array(f.length),n.normals.set(f);else if("POSITION"===t){if(yn.HomogeneousCoordinates){n.positions=new Float32Array(f.length-f.length/4);for(let e=0;e<f.length;e+=4)n.positions[e]=f[e],n.positions[e+1]=f[e+1],n.positions[e+2]=f[e+2]}else n.positions=new Float32Array(f.length),n.positions.set(f);l.push(n.positions.length)}else if(-1!==t.indexOf("TEXCOORD_")){const e=Number(t.split("_")[1]),i=z.b.UVKind+(0===e?"":e+1),r=new Float32Array(f.length);r.set(f),_i(r),n.set(r,i)}else"JOINT"===t?(n.matricesIndices=new Float32Array(f.length),n.matricesIndices.set(f)):"WEIGHT"===t?(n.matricesWeights=new Float32Array(f.length),n.matricesWeights.set(f)):"COLOR"===t&&(n.colors=new Float32Array(f.length),n.colors.set(f));if(u=e.accessors[i.indices],u)f=li.GetBufferFromAccessor(e,u),n.indices=new Int32Array(f.length),n.indices.set(f),d.push(n.indices.length);else{const e=[];for(let t=0;t<n.positions.length/3;t++)e.push(t);n.indices=new Int32Array(e),d.push(n.indices.length)}a?a.merge(n):a=n;const m=e.scene.getMaterialById(i.material);s.push(null===m?li.GetDefaultMaterial(e.scene):m),o.push(0===o.length?0:o[o.length-1]+l[l.length-2]),c.push(0===c.length?0:c[c.length-1]+d[d.length-2])}}let h;e.scene._blockEntityCollection=!!e.assetContainer,s.length>1?(h=new zt("multimat"+i,e.scene),h.subMaterials=s):h=new ni("multimat"+i,e.scene),1===s.length&&(h=s[0]),h._parentContainer=e.assetContainer,r.material||(r.material=h),new Bt(i,e.scene,a,!1,r),r.computeWorldMatrix(!0),e.scene._blockEntityCollection=!1,r.subMeshes=[];let u=0;for(let t=0;t<n.length;t++){const i=n[t],s=e.meshes[i];if(s)for(let e=0;e<s.primitives.length;e++)s.primitives[e].mode,ae.AddToMesh(u,o[u],l[u],c[u],d[u],r,r,!0),u++}return r},Ri=(e,t,n,i)=>{e.position&&(e.position=t),(e.rotationQuaternion||e.rotation)&&(e.rotationQuaternion=n),e.scaling&&(e.scaling=i)},Ci=(e,t,n)=>{let i=null;if(e.importOnlyMeshes&&(t.skin||t.meshes)&&e.importMeshesNames&&e.importMeshesNames.length>0&&-1===e.importMeshesNames.indexOf(t.name||""))return null;if(t.skin){if(t.meshes){const r=e.skins[t.skin],s=Ii(e,t,t.meshes,n,t.babylonNode);s.skeleton=e.scene.getLastSkeletonById(t.skin),null===s.skeleton&&(s.skeleton=((e,t,n,i)=>{if(i||(i=new Xn(t.name||"","",e.scene)),!t.babylonSkeleton)return i;const r=[],s=[];((e,t,n,i)=>{for(const r in e.nodes){const s=e.nodes[r],a=r;if(!s.jointName||bi(n,s.jointName))continue;const o=Ei(s),l=new Gn.a(s.name||"",t,null,o);l.id=a,i.push({bone:l,node:s,id:a})}for(let e=0;e<i.length;e++){const t=i[e],n=t.node.children;for(let e=0;e<n.length;e++){let r=null;for(let t=0;t<i.length;t++)if(i[t].id===n[e]){r=i[t];break}r&&(r.bone._parent=t.bone,t.bone.children.push(r.bone))}}})(e,i,t,r),i.bones=[];for(let n=0;n<t.jointNames.length;n++){const a=Ai(e,t.jointNames[n]);if(!a)continue;const o=a.node;if(!o){g.b.Warn("Joint named "+t.jointNames[n]+" does not exist");continue}const l=a.id,c=e.scene.getBoneById(l);if(c){i.bones.push(c);continue}let d=!1,h=null;for(let r=0;r<n;r++){const n=Ai(e,t.jointNames[r]);if(!n)continue;const s=n.node;if(!s){g.b.Warn("Joint named "+t.jointNames[r]+" does not exist when looking for parent");continue}const a=s.children;if(a){d=!1;for(let n=0;n<a.length;n++)if(a[n]===l){h=Ti(e,t,t.jointNames[r],i),d=!0;break}if(d)break}}const u=Ei(o);!h&&r.length>0&&(h=Si(r,l),h&&-1===s.indexOf(h)&&s.push(h)),new Gn.a(o.jointName||"",i,h,u).id=l}const a=i.bones;i.bones=[];for(let n=0;n<t.jointNames.length;n++){const r=Ai(e,t.jointNames[n]);if(r)for(let e=0;e<a.length;e++)if(a[e].id===r.id){i.bones.push(a[e]);break}}i.prepare();for(let e=0;e<s.length;e++)i.bones.push(s[e]);return i})(e,r,0,r.babylonSkeleton),r.babylonSkeleton||(r.babylonSkeleton=s.skeleton)),i=s}}else if(t.meshes)i=Ii(e,t,t.mesh?[t.mesh]:t.meshes,n,t.babylonNode);else if(!t.light||t.babylonNode||e.importOnlyMeshes){if(t.camera&&!t.babylonNode&&!e.importOnlyMeshes){const n=e.cameras[t.camera];if(n){if(e.scene._blockEntityCollection=!!e.assetContainer,"orthographic"===n.type){const n=new kn(t.camera,r.e.Zero(),e.scene,!1);n.name=t.name||"",n.mode=ft.ORTHOGRAPHIC_CAMERA,n.attachControl(),i=n,n._parentContainer=e.assetContainer}else if("perspective"===n.type){const s=n[n.type],a=new kn(t.camera,r.e.Zero(),e.scene,!1);a.name=t.name||"",a.attachControl(),s.aspectRatio||(s.aspectRatio=e.scene.getEngine().getRenderWidth()/e.scene.getEngine().getRenderHeight()),s.znear&&s.zfar&&(a.maxZ=s.zfar,a.minZ=s.znear),i=a,a._parentContainer=e.assetContainer}e.scene._blockEntityCollection=!1}}}else{const n=e.lights[t.light];if(n)if("ambient"===n.type){const s=n[n.type],a=new si(t.light,r.e.Zero(),e.scene);a.name=t.name||"",s.color&&(a.diffuse=he.a.FromArray(s.color)),i=a}else if("directional"===n.type){const s=n[n.type],a=new ai(t.light,r.e.Zero(),e.scene);a.name=t.name||"",s.color&&(a.diffuse=he.a.FromArray(s.color)),i=a}else if("point"===n.type){const s=n[n.type],a=new vt(t.light,r.e.Zero(),e.scene);a.name=t.name||"",s.color&&(a.diffuse=he.a.FromArray(s.color)),i=a}else if("spot"===n.type){const s=n[n.type],a=new oi(t.light,r.e.Zero(),r.e.Zero(),0,0,e.scene);a.name=t.name||"",s.color&&(a.diffuse=he.a.FromArray(s.color)),s.fallOfAngle&&(a.angle=s.fallOfAngle),s.fallOffExponent&&(a.exponent=s.fallOffExponent),i=a}}if(!t.jointName){if(t.babylonNode)return t.babylonNode;if(null===i){e.scene._blockEntityCollection=!!e.assetContainer;const n=new en(t.name||"",e.scene);n._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,t.babylonNode=n,i=n}}if(null!==i){if(t.matrix&&i instanceof en)((e,t)=>{if(t.matrix){const n=new r.e(0,0,0),i=new r.b,s=new r.e(0,0,0);r.a.FromArray(t.matrix).decompose(s,i,n),Ri(e,n,i,s)}else t.translation&&t.rotation&&t.scale&&Ri(e,r.e.FromArray(t.translation),r.b.FromArray(t.rotation),r.e.FromArray(t.scale));e.computeWorldMatrix(!0)})(i,t);else{const e=t.translation||[0,0,0],n=t.rotation||[0,0,0,1],s=t.scale||[1,1,1];Ri(i,r.e.FromArray(e),r.b.FromArray(n),r.e.FromArray(s))}i.updateCache(!0),t.babylonNode=i}return i},yi=(e,t,n,i=!1)=>{const r=e.nodes[t];let s=null;if(i=!(e.importOnlyMeshes&&!i&&e.importMeshesNames)||-1!==e.importMeshesNames.indexOf(r.name||"")||0===e.importMeshesNames.length,!r.jointName&&i&&(s=Ci(e,r,t),null!==s&&(s.id=t,s.parent=n)),r.children)for(let t=0;t<r.children.length;t++)yi(e,r.children[t],s,i)},Mi=e=>{let t=e.currentScene;if(t)for(let n=0;n<t.nodes.length;n++)yi(e,t.nodes[n],null);else for(const n in e.scenes){t=e.scenes[n];for(let n=0;n<t.nodes.length;n++)yi(e,t.nodes[n],null)}(e=>{for(const t in e.animations){const n=e.animations[t];if(!n.channels||!n.samplers)continue;let i=null;for(let s=0;s<n.channels.length;s++){const a=n.channels[s],o=n.samplers[a.sampler];if(!o)continue;let l=null,c=null;n.parameters?(l=n.parameters[o.input],c=n.parameters[o.output]):(l=o.input,c=o.output);const d=li.GetBufferFromAccessor(e,e.accessors[l]),h=li.GetBufferFromAccessor(e,e.accessors[c]),u=a.target.id;let f=e.scene.getNodeById(u);if(null===f&&(f=e.scene.getNodeByName(u)),null===f){g.b.Warn("Creating animation named "+t+". But cannot find node named "+u+" to attach to");continue}const m=f instanceof Gn.a;let p=a.target.path;const _=mi.indexOf(p);-1!==_&&(p=pi[_]);let v=Vn.a.ANIMATIONTYPE_MATRIX;m||("rotationQuaternion"===p?(v=Vn.a.ANIMATIONTYPE_QUATERNION,f.rotationQuaternion=new r.b):v=Vn.a.ANIMATIONTYPE_VECTOR3);let E=null;const T=[];let S=0,A=!1;m&&i&&i.getKeys().length===d.length&&(E=i,A=!0),A||(e.scene._blockEntityCollection=!!e.assetContainer,E=new Vn.a(t,m?"_matrix":p,1,v,Vn.a.ANIMATIONLOOPMODE_CYCLE),e.scene._blockEntityCollection=!1);for(let e=0;e<d.length;e++){let t=null;if("rotationQuaternion"===p?(t=r.b.FromArray([h[S],h[S+1],h[S+2],h[S+3]]),S+=4):(t=r.e.FromArray([h[S],h[S+1],h[S+2]]),S+=3),m){const n=f;let s=r.e.Zero(),a=new r.b,o=r.e.Zero(),l=n.getBaseMatrix();A&&i&&(l=i.getKeys()[e].value),l.decompose(o,a,s),"position"===p?s=t:"rotationQuaternion"===p?a=t:o=t,t=r.a.Compose(o,a,s)}A?i&&(i.getKeys()[e].value=t):T.push({frame:d[e],value:t})}!A&&E&&(E.setKeys(T),f.animations.push(E)),i=E,e.scene.stopAnimation(f),e.scene.beginAnimation(f,0,d[d.length-1],!0,1)}}})(e);for(let t=0;t<e.scene.skeletons.length;t++){const n=e.scene.skeletons[t];e.scene.beginAnimation(n,0,Number.MAX_VALUE,!0,1)}},Oi=(e,t,n)=>{for(const i in t.uniforms){const r=t.uniforms[i],s=t.parameters[r];if(e.currentIdentifier===i&&s.semantic&&!s.source&&!s.node){const e=ui.indexOf(s.semantic);if(-1!==e)return delete n[i],fi[e]}}return e.currentIdentifier},xi=e=>{for(const t in e.materials)Li.LoadMaterialAsync(e,t,()=>{},()=>{})};class Di{static CreateRuntime(e,t,n){const i={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:n,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&gi(e.extensions,"extensions",i),e.extensionsUsed&&gi(e.extensionsUsed,"extensionsUsed",i),e.buffers&&((e,t)=>{for(const n in e){const i=e[n];t.buffers[n]=i,t.buffersCount++}})(e.buffers,i),e.bufferViews&&gi(e.bufferViews,"bufferViews",i),e.accessors&&gi(e.accessors,"accessors",i),e.meshes&&gi(e.meshes,"meshes",i),e.lights&&gi(e.lights,"lights",i),e.cameras&&gi(e.cameras,"cameras",i),e.nodes&&gi(e.nodes,"nodes",i),e.images&&gi(e.images,"images",i),e.textures&&gi(e.textures,"textures",i),e.shaders&&((e,t)=>{for(const n in e){const i=e[n];t.shaders[n]=i,t.shaderscount++}})(e.shaders,i),e.programs&&gi(e.programs,"programs",i),e.samplers&&gi(e.samplers,"samplers",i),e.techniques&&gi(e.techniques,"techniques",i),e.materials&&gi(e.materials,"materials",i),e.animations&&gi(e.animations,"animations",i),e.skins&&gi(e.skins,"skins",i),e.scenes&&(i.scenes=e.scenes),e.scene&&e.scenes&&(i.currentScene=e.scenes[e.scene]),i}static LoadBufferAsync(e,t,n,i,r){const s=e.buffers[t];g.b.IsBase64(s.uri)?setTimeout(()=>n(new Uint8Array(g.b.DecodeBase64(s.uri)))):g.b.LoadFile(e.rootUrl+s.uri,e=>n(new Uint8Array(e)),r,void 0,!0,e=>{e&&i(e.status+" "+e.statusText)})}static LoadTextureBufferAsync(e,t,n,i){const r=e.textures[t];if(!r||!r.source)return void i("");if(r.babylonTexture)return void n(null);const s=e.images[r.source];g.b.IsBase64(s.uri)?setTimeout(()=>n(new Uint8Array(g.b.DecodeBase64(s.uri)))):g.b.LoadFile(e.rootUrl+s.uri,e=>n(new Uint8Array(e)),void 0,void 0,!0,e=>{e&&i(e.status+" "+e.statusText)})}static CreateTextureAsync(e,t,n,i){const r=e.textures[t];if(r.babylonTexture)return void i(r.babylonTexture);const s=e.samplers[r.sampler],a=s.minFilter===bn.NEAREST_MIPMAP_NEAREST||s.minFilter===bn.NEAREST_MIPMAP_LINEAR||s.minFilter===bn.LINEAR_MIPMAP_NEAREST||s.minFilter===bn.LINEAR_MIPMAP_LINEAR,o=Et.a.BILINEAR_SAMPLINGMODE,l=null==n?new Blob:new Blob([n]),c=URL.createObjectURL(l),d=()=>URL.revokeObjectURL(c),h=new Et.a(c,e.scene,!a,!0,o,d,d);void 0!==s.wrapS&&(h.wrapU=li.GetWrapMode(s.wrapS)),void 0!==s.wrapT&&(h.wrapV=li.GetWrapMode(s.wrapT)),h.name=t,r.babylonTexture=h,i(h)}static LoadShaderStringAsync(e,t,n,i){const r=e.shaders[t];if(g.b.IsBase64(r.uri)){const e=atob(r.uri.split(",")[1]);n&&n(e)}else g.b.LoadFile(e.rootUrl+r.uri,n,void 0,void 0,!1,e=>{e&&i&&i(e.status+" "+e.statusText)})}static LoadMaterialAsync(e,t,n,i){const r=e.materials[t];if(!r.technique)return void(i&&i("No technique found."));const s=e.techniques[r.technique];if(!s){e.scene._blockEntityCollection=!!e.assetContainer;const i=new ni(t,e.scene);return i._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,i.diffuseColor=new he.a(.5,.5,.5),i.sideOrientation=je.CounterClockWiseSideOrientation,void n(i)}const a=e.programs[s.program],o=s.states,l=jn.a.ShadersStore[a.vertexShader+"VertexShader"],c=jn.a.ShadersStore[a.fragmentShader+"PixelShader"];let d="",h="";const u=new hi(l),f=new hi(c),m={},p=[],g=[],_=[];for(const e in s.uniforms){const t=s.uniforms[e],n=s.parameters[t];if(m[e]=n,!n.semantic||n.node||n.source)n.type===Sn.SAMPLER_2D?_.push(e):p.push(e);else{const t=ui.indexOf(n.semantic);-1!==t?(p.push(fi[t]),delete m[e]):p.push(e)}}for(const e in s.attributes){const t=s.attributes[e],n=s.parameters[t];if(n.semantic){const e=vi(n);e&&g.push(e)}}for(;!u.isEnd()&&u.getNextToken();){if(u.currentToken!==di.IDENTIFIER){d+=u.currentString;continue}let e=!1;for(const t in s.attributes){const n=s.attributes[t],i=s.parameters[n];if(u.currentIdentifier===t&&i.semantic){d+=vi(i),e=!0;break}}e||(d+=Oi(u,s,m))}for(;!f.isEnd()&&f.getNextToken();)f.currentToken===di.IDENTIFIER?h+=Oi(f,s,m):h+=f.currentString;const v={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},E={attributes:g,uniforms:p,samplers:_,needAlphaBlending:o&&o.enable&&-1!==o.enable.indexOf(3042)};jn.a.ShadersStore[a.vertexShader+t+"VertexShader"]=d,jn.a.ShadersStore[a.fragmentShader+t+"PixelShader"]=h;const T=new ri(t,e.scene,v,E);if(T.onError=((e,t,n)=>(i,r)=>{t.dispose(!0),n("Cannot compile program named "+e.name+". Error: "+r+". Default material will be applied")})(a,T,i),T.onCompiled=((e,t,n,i,r,s)=>a=>{((e,t,n,i,r)=>{const s=i.values||n.parameters,a=n.uniforms;for(const n in r){const o=r[n],l=o.type;let c=s[a[n]];if(void 0===c&&(c=o.value),!c)continue;const d=e=>n=>{o.value&&e&&(t.setTexture(e,n),delete r[e])};l===Sn.SAMPLER_2D?Li.LoadTextureAsync(e,i.values?c:o.value,d(n),()=>d(null)):o.value&&li.SetUniform(t,n,i.values?c:o.value,l)&&delete r[n]}})(e,t,n,i,r),t.onBind=a=>{((e,t,n,i,r,s,a)=>{const o=s.values||r.parameters;for(const a in n){const l=n[a],c=l.type;if(c===Sn.FLOAT_MAT2||c===Sn.FLOAT_MAT3||c===Sn.FLOAT_MAT4)if(!l.semantic||l.source||l.node){if(l.semantic&&(l.source||l.node)){let e=t.scene.getNodeByName(l.source||l.node||"");if(null===e&&(e=t.scene.getNodeById(l.source||l.node||"")),null===e)continue;li.SetMatrix(t.scene,e,l,a,i.getEffect())}}else li.SetMatrix(t.scene,e,l,a,i.getEffect());else{const e=o[r.uniforms[a]];if(!e)continue;if(c===Sn.SAMPLER_2D){const n=t.textures[s.values?e:l.value].babylonTexture;if(null==n)continue;i.getEffect().setTexture(a,n)}else li.SetUniform(i.getEffect(),a,e,c)}}a(i)})(a,e,r,t,n,i,s)}})(e,T,s,r,m,n),T.sideOrientation=je.CounterClockWiseSideOrientation,o&&o.functions){const e=o.functions;e.cullFace&&e.cullFace[0]!==Rn.BACK&&(T.backFaceCulling=!1);const t=e.blendFuncSeparate;t&&(t[0]===Cn.SRC_ALPHA&&t[1]===Cn.ONE_MINUS_SRC_ALPHA&&t[2]===Cn.ONE&&t[3]===Cn.ONE?T.alphaMode=ci.ALPHA_COMBINE:t[0]===Cn.ONE&&t[1]===Cn.ONE&&t[2]===Cn.ZERO&&t[3]===Cn.ONE?T.alphaMode=ci.ALPHA_ONEONE:t[0]===Cn.SRC_ALPHA&&t[1]===Cn.ONE&&t[2]===Cn.ZERO&&t[3]===Cn.ONE?T.alphaMode=ci.ALPHA_ADD:t[0]===Cn.ZERO&&t[1]===Cn.ONE_MINUS_SRC_COLOR&&t[2]===Cn.ONE&&t[3]===Cn.ONE?T.alphaMode=ci.ALPHA_SUBTRACT:t[0]===Cn.DST_COLOR&&t[1]===Cn.ZERO&&t[2]===Cn.ONE&&t[3]===Cn.ONE?T.alphaMode=ci.ALPHA_MULTIPLY:t[0]===Cn.SRC_ALPHA&&t[1]===Cn.ONE_MINUS_SRC_COLOR&&t[2]===Cn.ONE&&t[3]===Cn.ONE&&(T.alphaMode=ci.ALPHA_MAXIMIZED))}}}class Pi{static RegisterExtension(e){Pi.Extensions[e.name]?g.b.Error('Tool with the same name "'+e.name+'" already exists'):Pi.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,n,i,r,s,a,o){return t.useRightHandedSystem=!0,Li.LoadRuntimeAsync(t,n,i,t=>{t.assetContainer=r,t.importOnlyMeshes=!0,""===e?t.importMeshesNames=[]:"string"==typeof e?t.importMeshesNames=[e]:!e||e instanceof Array?(t.importMeshesNames=[],g.b.Warn("Argument meshesNames must be of type string or string[]")):t.importMeshesNames=[e],this._createNodes(t);const n=[],i=[];for(const e in t.nodes){const i=t.nodes[e];i.babylonNode instanceof jt&&n.push(i.babylonNode)}for(const e in t.skins){const n=t.skins[e];n.babylonSkeleton instanceof Xn&&i.push(n.babylonSkeleton)}this._loadBuffersAsync(t,()=>{this._loadShadersAsync(t,()=>{xi(t),Mi(t),!yn.IncrementalLoading&&s&&s(n,i)})}),yn.IncrementalLoading&&s&&s(n,i)},o),!0}importMeshAsync(e,t,n,i,r,s){return new Promise((a,o)=>{this._importMeshAsync(e,t,i,r,n,(e,t)=>{a({meshes:e,particleSystems:[],skeletons:t,animationGroups:[],lights:[],transformNodes:[],geometries:[],spriteManagers:[]})},s,e=>{o(new Error(e))})})}_loadAsync(e,t,n,i,r,s){e.useRightHandedSystem=!0,Li.LoadRuntimeAsync(e,t,n,e=>{Li.LoadRuntimeExtensionsAsync(e,()=>{this._createNodes(e),this._loadBuffersAsync(e,()=>{this._loadShadersAsync(e,()=>{xi(e),Mi(e),yn.IncrementalLoading||i()})}),yn.IncrementalLoading&&i()},s)},s)}loadAsync(e,t,n,i){return new Promise((r,s)=>{this._loadAsync(e,t,n,()=>{r()},i,e=>{s(new Error(e))})})}_loadShadersAsync(e,t){let n=!1;const i=(n,i)=>{Li.LoadShaderStringAsync(e,n,r=>{r instanceof ArrayBuffer||(e.loadedShaderCount++,r&&(jn.a.ShadersStore[n+(i.type===Tn.VERTEX?"VertexShader":"PixelShader")]=r),e.loadedShaderCount===e.shaderscount&&t())},()=>{g.b.Error("Error when loading shader program named "+n+" located at "+i.uri)})};for(const t in e.shaders){n=!0;const r=e.shaders[t];r?i.bind(this,t,r)():g.b.Error("No shader named: "+t)}n||t()}_loadBuffersAsync(e,t){let n=!1;const i=(n,i)=>{Li.LoadBufferAsync(e,n,r=>{e.loadedBufferCount++,r&&(r.byteLength!=e.buffers[n].byteLength&&g.b.Error("Buffer named "+n+" is length "+r.byteLength+". Expected: "+i.byteLength),e.loadedBufferViews[n]=r),e.loadedBufferCount===e.buffersCount&&t()},()=>{g.b.Error("Error when loading buffer named "+n+" located at "+i.uri)})};for(const t in e.buffers){n=!0;const r=e.buffers[t];r?i.bind(this,t,r)():g.b.Error("No buffer named: "+t)}n||t()}_createNodes(e){let t=e.currentScene;if(t)for(let n=0;n<t.nodes.length;n++)yi(e,t.nodes[n],null);else for(const n in e.scenes){t=e.scenes[n];for(let n=0;n<t.nodes.length;n++)yi(e,t.nodes[n],null)}}}Pi.Extensions={};class Li{get name(){return this._name}loadRuntimeAsync(e,t,n,i,r){return!1}loadRuntimeExtensionsAsync(e,t,n){return!1}loadBufferAsync(e,t,n,i,r){return!1}loadTextureBufferAsync(e,t,n,i){return!1}createTextureAsync(e,t,n,i,r){return!1}loadShaderStringAsync(e,t,n,i){return!1}loadMaterialAsync(e,t,n,i){return!1}static LoadRuntimeAsync(e,t,n,i,r){Li._ApplyExtensions(s=>s.loadRuntimeAsync(e,t,n,i,r),()=>{setTimeout(()=>{i&&i(Di.CreateRuntime(t.json,e,n))})})}static LoadRuntimeExtensionsAsync(e,t,n){Li._ApplyExtensions(i=>i.loadRuntimeExtensionsAsync(e,t,n),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,n,i,r){Li._ApplyExtensions(s=>s.loadBufferAsync(e,t,n,i,r),()=>{Di.LoadBufferAsync(e,t,n,i,r)})}static LoadTextureAsync(e,t,n,i){Li._LoadTextureBufferAsync(e,t,r=>{r&&Li._CreateTextureAsync(e,t,r,n,i)},i)}static LoadShaderStringAsync(e,t,n,i){Li._ApplyExtensions(r=>r.loadShaderStringAsync(e,t,n,i),()=>{Di.LoadShaderStringAsync(e,t,n,i)})}static LoadMaterialAsync(e,t,n,i){Li._ApplyExtensions(r=>r.loadMaterialAsync(e,t,n,i),()=>{Di.LoadMaterialAsync(e,t,n,i)})}static _LoadTextureBufferAsync(e,t,n,i){Li._ApplyExtensions(r=>r.loadTextureBufferAsync(e,t,n,i),()=>{Di.LoadTextureBufferAsync(e,t,n,i)})}static _CreateTextureAsync(e,t,n,i,r){Li._ApplyExtensions(s=>s.createTextureAsync(e,t,n,i,r),()=>{Di.CreateTextureAsync(e,t,n,i)})}static _ApplyExtensions(e,t){for(const t in Pi.Extensions)if(e(Pi.Extensions[t]))return;t()}constructor(e){this._name=e}}yn._CreateGLTF1Loader=()=>new Pi,Pi.RegisterExtension(new class extends Li{loadRuntimeAsync(e,t,n,i){const r=t.json.extensionsUsed;return!(!r||-1===r.indexOf(this.name)||!t.bin||(this._bin=t.bin,i(Di.CreateRuntime(t.json,e,n)),0))}loadBufferAsync(e,t,n,i){return-1!==e.extensionsUsed.indexOf(this.name)&&"binary_glTF"===t&&(this._bin.readAsync(0,this._bin.byteLength).then(n,e=>i(e.message)),!0)}loadTextureBufferAsync(e,t,n){const i=e.textures[t],r=e.images[i.source];if(!r.extensions||!(this.name in r.extensions))return!1;const s=r.extensions[this.name],a=e.bufferViews[s.bufferView];return n(li.GetBufferFromBufferView(e,a,0,a.byteLength,En.UNSIGNED_BYTE)),!0}loadShaderStringAsync(e,t,n){const i=e.shaders[t];if(!i.extensions||!(this.name in i.extensions))return!1;const r=i.extensions[this.name],s=e.bufferViews[r.bufferView],a=li.GetBufferFromBufferView(e,s,0,s.byteLength,En.UNSIGNED_BYTE);return setTimeout(()=>{const e=li.DecodeBufferToText(a);n(e)}),!0}constructor(){super("KHR_binary_glTF")}}),Pi.RegisterExtension(new class extends Li{loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const n=t.lights;if(n)for(const t in n){const i=n[t];switch(i.type){case"ambient":{const t=new si(i.name,new r.e(0,1,0),e.scene),n=i.ambient;n&&(t.diffuse=he.a.FromArray(n.color||[1,1,1]));break}case"point":{const t=new vt(i.name,new r.e(10,10,10),e.scene),n=i.point;n&&(t.diffuse=he.a.FromArray(n.color||[1,1,1]));break}case"directional":{const t=new ai(i.name,new r.e(0,-1,0),e.scene),n=i.directional;n&&(t.diffuse=he.a.FromArray(n.color||[1,1,1]));break}case"spot":{const t=i.spot;t&&(new oi(i.name,new r.e(0,10,0),new r.e(0,-1,0),t.fallOffAngle||Math.PI,t.fallOffExponent||0,e.scene).diffuse=he.a.FromArray(t.color||[1,1,1]));break}default:g.b.Warn('GLTF Material Common extension: light type "'+i.type+" not supported")}}return!1}loadMaterialAsync(e,t,n,i){const r=e.materials[t];if(!r||!r.extensions)return!1;const s=r.extensions[this.name];if(!s)return!1;const a=new ni(t,e.scene);return a.sideOrientation=je.CounterClockWiseSideOrientation,"CONSTANT"===s.technique&&(a.disableLighting=!0),a.backFaceCulling=void 0!==s.doubleSided&&!s.doubleSided,a.alpha=void 0===s.values.transparency?1:s.values.transparency,a.specularPower=void 0===s.values.shininess?0:s.values.shininess,"string"==typeof s.values.ambient?this._loadTexture(e,s.values.ambient,a,"ambientTexture",i):a.ambientColor=he.a.FromArray(s.values.ambient||[0,0,0]),"string"==typeof s.values.diffuse?this._loadTexture(e,s.values.diffuse,a,"diffuseTexture",i):a.diffuseColor=he.a.FromArray(s.values.diffuse||[0,0,0]),"string"==typeof s.values.emission?this._loadTexture(e,s.values.emission,a,"emissiveTexture",i):a.emissiveColor=he.a.FromArray(s.values.emission||[0,0,0]),"string"==typeof s.values.specular?this._loadTexture(e,s.values.specular,a,"specularTexture",i):a.specularColor=he.a.FromArray(s.values.specular||[0,0,0]),!0}_loadTexture(e,t,n,i,r){Di.LoadTextureBufferAsync(e,t,r=>{Di.CreateTextureAsync(e,t,r,e=>n[i]=e)},r)}constructor(){super("KHR_materials_common")}});class Ni{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}}var Fi=n(401);let wi=0;const Ui=e=>{if(!e.environmentBRDFTexture){const t=e.useDelayedTextureLoading;e.useDelayedTextureLoading=!1;const n=e._blockEntityCollection;e._blockEntityCollection=!1;const i=Et.a.CreateFromBase64String("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==","EnvironmentBRDFTexture"+wi++,e,!0,!1,Et.a.BILINEAR_SAMPLINGMODE);e._blockEntityCollection=n;const r=e.getEngine().getLoadedTexturesCache(),s=r.indexOf(i.getInternalTexture());-1!==s&&r.splice(s,1),i.isRGBD=!0,i.wrapU=Et.a.CLAMP_ADDRESSMODE,i.wrapV=Et.a.CLAMP_ADDRESSMODE,e.environmentBRDFTexture=i,e.useDelayedTextureLoading=t,Fi.a.ExpandRGBDTexture(i);const a=e.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;const t=e.onBeforeRenderObservable.add(()=>{i.isReady()&&(e.onBeforeRenderObservable.remove(t),Fi.a.ExpandRGBDTexture(i))})});e.onDisposeObservable.add(()=>{e.getEngine().onContextRestoredObservable.remove(a)})}return e.environmentBRDFTexture};n(402);class Bi extends j{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class ki extends et{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}isReadyForSubMesh(e,t,n){if(!this._isEnabled)return!0;const i=this._material._disableBumpMap;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Qn.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&Qn.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1;if(n.getCaps().standardDerivatives&&this._bumpTexture&&Qn.ClearCoatBumpTextureEnabled&&!i&&!this._bumpTexture.isReady())return!1;if(this._isTintEnabled&&this._tintTexture&&Qn.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Qn.ClearCoatTextureEnabled?Ce(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&Qn.ClearCoatTextureEnabled?Ce(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&Qn.ClearCoatBumpTextureEnabled?Ce(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===ki._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&Qn.ClearCoatTintTextureEnabled?(Ce(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,n,i){if(!this._isEnabled)return;const r=i.materialDefines,s=this._material.isFrozen,a=this._material._disableBumpMap,o=this._material._invertNormalMapX,l=this._material._invertNormalMapY;if(!e.useUbo||!s||!e.isSync){var c,d,h,u,f,m,p,g;(this._texture||this._textureRoughness)&&Qn.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",null!==(c=null===(d=this._texture)||void 0===d?void 0:d.coordinatesIndex)&&void 0!==c?c:0,null!==(h=null===(u=this._texture)||void 0===u?void 0:u.level)&&void 0!==h?h:0,null!==(f=null===(m=this._textureRoughness)||void 0===m?void 0:m.coordinatesIndex)&&void 0!==f?f:0,null!==(p=null===(g=this._textureRoughness)||void 0===g?void 0:g.level)&&void 0!==p?p:0),this._texture&&ye(this._texture,e,"clearCoat"),this._textureRoughness&&!r.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&ye(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&n.getCaps().standardDerivatives&&Qn.ClearCoatTextureEnabled&&!a&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),ye(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",o?1:-1,l?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",o?-1:1,l?-1:1)),this._tintTexture&&Qn.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),ye(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const i=1-this._indexOfRefraction,s=1+this._indexOfRefraction,_=Math.pow(-i/s,2),v=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",_,v,i,s),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&Qn.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!r.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Qn.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&n.getCaps().standardDerivatives&&Qn.ClearCoatBumpTextureEnabled&&!a&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&Qn.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,n,i,r;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(n=this._textureRoughness)||void 0===n||n.dispose(),null===(i=this._bumpTexture)||void 0===i||i.dispose(),null===(r=this._tintTexture)||void 0===r||r.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,n){return e.CLEARCOAT_BUMP&&t.addFallback(n++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(n++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(n++,"CLEARCOAT"),n}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}constructor(e,t=!0){super(e,"PBRClearCoat",100,new Bi,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=ki._DefaultIndexOfRefraction,this.indexOfRefraction=ki._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=he.a.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}}ki._DefaultIndexOfRefraction=1.5,Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ki.prototype,"isEnabled",void 0),Object(W.a)([Object(X.c)()],ki.prototype,"intensity",void 0),Object(W.a)([Object(X.c)()],ki.prototype,"roughness",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ki.prototype,"indexOfRefraction",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ki.prototype,"texture",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ki.prototype,"useRoughnessFromMainTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ki.prototype,"textureRoughness",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ki.prototype,"remapF0OnInterfaceChange",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ki.prototype,"bumpTexture",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ki.prototype,"isTintEnabled",void 0),Object(W.a)([Object(X.d)()],ki.prototype,"tintColor",void 0),Object(W.a)([Object(X.c)()],ki.prototype,"tintColorAtDistance",void 0),Object(W.a)([Object(X.c)()],ki.prototype,"tintThickness",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ki.prototype,"tintTexture",void 0);class Vi extends j{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0}}class Gi extends et{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}isReadyForSubMesh(e,t){if(!this._isEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Qn.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._thicknessTexture&&Qn.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.IRIDESCENCE=!0,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Qn.IridescenceTextureEnabled?Ce(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,this._thicknessTexture&&Qn.IridescenceTextureEnabled?Ce(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t){if(!this._isEnabled)return;const n=this._material.isFrozen;var i,r,s,a,o,l,c,d;e.useUbo&&n&&e.isSync||((this._texture||this._thicknessTexture)&&Qn.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",null!==(i=null===(r=this._texture)||void 0===r?void 0:r.coordinatesIndex)&&void 0!==i?i:0,null!==(s=null===(a=this._texture)||void 0===a?void 0:a.level)&&void 0!==s?s:0,null!==(o=null===(l=this._thicknessTexture)||void 0===l?void 0:l.coordinatesIndex)&&void 0!==o?o:0,null!==(c=null===(d=this._thicknessTexture)||void 0===d?void 0:d.level)&&void 0!==c?c:0),this._texture&&ye(this._texture,e,"iridescence"),this._thicknessTexture&&ye(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness));t.texturesEnabled&&(this._texture&&Qn.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&Qn.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,n;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(n=this._thicknessTexture)||void 0===n||n.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,n){return e.IRIDESCENCE&&t.addFallback(n++,"IRIDESCENCE"),n}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}constructor(e,t=!0){super(e,"PBRIridescence",110,new Vi,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=Gi._DefaultMinimumThickness,this.maximumThickness=Gi._DefaultMaximumThickness,this.indexOfRefraction=Gi._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}}Gi._DefaultMinimumThickness=100,Gi._DefaultMaximumThickness=400,Gi._DefaultIndexOfRefraction=1.3,Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Gi.prototype,"isEnabled",void 0),Object(W.a)([Object(X.c)()],Gi.prototype,"intensity",void 0),Object(W.a)([Object(X.c)()],Gi.prototype,"minimumThickness",void 0),Object(W.a)([Object(X.c)()],Gi.prototype,"maximumThickness",void 0),Object(W.a)([Object(X.c)()],Gi.prototype,"indexOfRefraction",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Gi.prototype,"texture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Gi.prototype,"thicknessTexture",void 0);class Hi extends j{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}}class Wi extends et{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&Qn.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(e,t,n){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!n.isVerticesDataPresent(z.b.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Qn.AnisotropicTextureEnabled?Ce(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const n=this._material.isFrozen;e.useUbo&&n&&e.isSync||(this._texture&&Qn.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),ye(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&Qn.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,n){return e.ANISOTROPIC&&t.addFallback(n++,"ANISOTROPIC"),n}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,n){super.parse(e,t,n),void 0===e.legacy&&(this.legacy=!0)}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new Hi,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new r.d(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}}Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Wi.prototype,"isEnabled",void 0),Object(W.a)([Object(X.c)()],Wi.prototype,"intensity",void 0),Object(W.a)([Object(X.m)()],Wi.prototype,"direction",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Wi.prototype,"texture",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsMiscDirty")],Wi.prototype,"legacy",void 0);class Xi extends j{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1}}class ji extends et{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}isReadyForSubMesh(e,t){if(!this._isEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Qn.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&Qn.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=null!==this._roughness,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Qn.SheenTextureEnabled?(Ce(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&Qn.SheenTextureEnabled?Ce(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,n,i){if(!this._isEnabled)return;const r=i.materialDefines,s=this._material.isFrozen;var a,o,l,c,d,h,u,f;e.useUbo&&s&&e.isSync||((this._texture||this._textureRoughness)&&Qn.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",null!==(a=null===(o=this._texture)||void 0===o?void 0:o.coordinatesIndex)&&void 0!==a?a:0,null!==(l=null===(c=this._texture)||void 0===c?void 0:c.level)&&void 0!==l?l:0,null!==(d=null===(h=this._textureRoughness)||void 0===h?void 0:h.coordinatesIndex)&&void 0!==d?d:0,null!==(u=null===(f=this._textureRoughness)||void 0===f?void 0:f.level)&&void 0!==u?u:0),this._texture&&ye(this._texture,e,"sheen"),this._textureRoughness&&!r.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&ye(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),null!==this._roughness&&e.updateFloat("vSheenRoughness",this._roughness));t.texturesEnabled&&(this._texture&&Qn.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!r.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Qn.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,n;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(n=this._textureRoughness)||void 0===n||n.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,n){return e.SHEEN&&t.addFallback(n++,"SHEEN"),n}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}constructor(e,t=!0){super(e,"Sheen",120,new Xi,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=he.a.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}}Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ji.prototype,"isEnabled",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ji.prototype,"linkSheenWithAlbedo",void 0),Object(W.a)([Object(X.c)()],ji.prototype,"intensity",void 0),Object(W.a)([Object(X.d)()],ji.prototype,"color",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ji.prototype,"texture",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ji.prototype,"useRoughnessFromMainTexture",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ji.prototype,"roughness",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ji.prototype,"textureRoughness",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],ji.prototype,"albedoScaling",void 0);class zi extends j{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,this.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_USE_GLTF_TEXTURES=!1}}class Ki extends et{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){this._volumeIndexOfRefraction=e>=1?e:-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}isCompatible(){return!0}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&Qn.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;if(this._translucencyColorTexture&&Qn.TranslucencyColorTextureEnabled&&!this._translucencyColorTexture.isReadyOrNotBlocking())return!1;if(this._translucencyIntensityTexture&&Qn.TranslucencyIntensityTextureEnabled&&!this._translucencyIntensityTexture.isReadyOrNotBlocking())return!1;const e=this._getRefractionTexture(t);if(e&&Qn.RefractionTextureEnabled&&!e.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,void(e.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0);if(e._areTexturesDirty){if(e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&Qn.ThicknessTextureEnabled&&Ce(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&Qn.RefractionIntensityTextureEnabled&&Ce(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&Qn.TranslucencyIntensityTextureEnabled&&Ce(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE"),this._translucencyColorTexture&&Qn.TranslucencyColorTextureEnabled&&Ce(this._translucencyColorTexture,e,"SS_TRANSLUCENCYCOLOR_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!=0,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._refractionIntensityTexture,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._translucencyIntensityTexture,this._isRefractionEnabled&&t.texturesEnabled){const n=this._getRefractionTexture(t);n&&Qn.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=n.isCube,e.SS_GAMMAREFRACTION=n.gammaSpace,e.SS_RGBDREFRACTION=n.isRGBD,e.SS_LINEARSPECULARREFRACTION=n.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&n.isCube?!n.invertZ:n.invertZ,e.SS_LODINREFRACTIONALPHA=n.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=n.isCube&&n.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,n,i){if(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled)if(0===this.maximumThickness&&0===this.minimumThickness)e.updateFloat2("vThicknessParam",0,0);else{i.getRenderingMesh().getWorldMatrix().decompose(r.c.Vector3[0]);const t=Math.max(Math.abs(r.c.Vector3[0].x),Math.abs(r.c.Vector3[0].y),Math.abs(r.c.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*t,(this.maximumThickness-this.minimumThickness)*t)}}bindForSubMesh(e,t,n,i){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const r=i.materialDefines,s=this._material.isFrozen,a=this._material.realTimeFiltering,o=r.LODBASEDMICROSFURACE,l=this._getRefractionTexture(t);if(!e.useUbo||!s||!e.isSync){var c;if(this._thicknessTexture&&Qn.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),ye(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&Qn.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),ye(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyColorTexture&&Qn.TranslucencyColorTextureEnabled&&r.SS_TRANSLUCENCYCOLOR_TEXTURE&&(e.updateFloat2("vTranslucencyColorInfos",this._translucencyColorTexture.coordinatesIndex,this._translucencyColorTexture.level),ye(this._translucencyColorTexture,e,"translucencyColor")),this._translucencyIntensityTexture&&Qn.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),ye(this._translucencyIntensityTexture,e,"translucencyIntensity")),l&&Qn.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",l.getRefractionTextureMatrix());let t=1;l.isCube||l.depth&&(t=l.depth);const n=l.getSize().width,i=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",l.level,1/i,t,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",n,l.lodGenerationScale,l.lodGenerationOffset,1/this.indexOfRefraction),a&&e.updateFloat2("vRefractionFilteringInfo",n,Math.log2(n)),l.boundingBoxSize){const t=l;e.updateVector3("vRefractionPosition",t.boundingBoxPosition),e.updateVector3("vRefractionSize",t.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateColor4("vTranslucencyColor",null!==(c=this.translucencyColor)&&void 0!==c?c:this.tintColor,0),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&Qn.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&Qn.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&Qn.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),this._translucencyColorTexture&&Qn.TranslucencyColorTextureEnabled&&r.SS_TRANSLUCENCYCOLOR_TEXTURE&&e.setTexture("translucencyColorSampler",this._translucencyColorTexture),l&&Qn.RefractionTextureEnabled&&(o?e.setTexture("refractionSampler",l):(e.setTexture("refractionSampler",l._lodTextureMid||l),e.setTexture("refractionSamplerLow",l._lodTextureLow||l),e.setTexture("refractionSamplerHigh",l._lodTextureHigh||l))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){Qn.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e||this._refractionIntensityTexture===e||this._translucencyIntensityTexture===e||this._translucencyColorTexture===e}hasRenderTargetTextures(){return!!(Qn.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture),this._translucencyColorTexture&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&e.push(this._translucencyIntensityTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),this._translucencyColorTexture&&this._translucencyColorTexture.animations&&this._translucencyColorTexture.animations.length>0&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.animations&&this._translucencyIntensityTexture.animations.length>0&&e.push(this._translucencyIntensityTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose(),this._translucencyColorTexture&&this._translucencyColorTexture.dispose(),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,n){return e.SS_SCATTERING&&t.addFallback(n++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(n++,"SS_TRANSLUCENCY"),n}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","translucencyColorSampler")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"},{name:"vTranslucencyColor",size:4,type:"vec4"},{name:"vTranslucencyColorInfos",size:2,type:"vec2"},{name:"translucencyColorMatrix",size:16,type:"mat4"}]}}constructor(e,t=!0){super(e,"PBRSubSurface",130,new zi,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=he.a.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=he.a.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this.translucencyColor=null,this._translucencyColorTexture=null,this.translucencyColorTexture=null,this._useGltfStyleTextures=!0,this.useGltfStyleTextures=!0,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}}Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"isRefractionEnabled",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"isTranslucencyEnabled",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"isDispersionEnabled",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markScenePrePassDirty")],Ki.prototype,"isScatteringEnabled",void 0),Object(W.a)([Object(X.c)()],Ki.prototype,"_scatteringDiffusionProfileIndex",void 0),Object(W.a)([Object(X.c)()],Ki.prototype,"refractionIntensity",void 0),Object(W.a)([Object(X.c)()],Ki.prototype,"translucencyIntensity",void 0),Object(W.a)([Object(X.c)()],Ki.prototype,"useAlbedoToTintRefraction",void 0),Object(W.a)([Object(X.c)()],Ki.prototype,"useAlbedoToTintTranslucency",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"thicknessTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"refractionTexture",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"indexOfRefraction",void 0),Object(W.a)([Object(X.c)()],Ki.prototype,"_volumeIndexOfRefraction",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"volumeIndexOfRefraction",null),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"invertRefractionY",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"linkRefractionWithTransparency",void 0),Object(W.a)([Object(X.c)()],Ki.prototype,"minimumThickness",void 0),Object(W.a)([Object(X.c)()],Ki.prototype,"maximumThickness",void 0),Object(W.a)([Object(X.c)()],Ki.prototype,"useThicknessAsDepth",void 0),Object(W.a)([Object(X.d)()],Ki.prototype,"tintColor",void 0),Object(W.a)([Object(X.c)()],Ki.prototype,"tintColorAtDistance",void 0),Object(W.a)([Object(X.c)()],Ki.prototype,"dispersion",void 0),Object(W.a)([Object(X.d)()],Ki.prototype,"diffusionDistance",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"useMaskFromThicknessTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"refractionIntensityTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"translucencyIntensityTexture",void 0),Object(W.a)([Object(X.d)()],Ki.prototype,"translucencyColor",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"translucencyColorTexture",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Ki.prototype,"useGltfStyleTextures",void 0);const Yi={effect:null,subMesh:null};class qi extends j{reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.IBL_CDF_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BASEWEIGHT=!1,this.BASEWEIGHTDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.rebuild()}}class Qi extends qn{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get hasRenderTargetTextures(){return!!(Qn.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){var e;return this._transparencyMode===Qi.PBRMATERIAL_OPAQUE||this._transparencyMode===Qi.PBRMATERIAL_ALPHATEST||(null===(e=this.subSurface)||void 0===e?void 0:e.disableAlphaBlending)}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromAlbedoTexture())}needAlphaTesting(){var e;return this._hasTransparencyMode?this._transparencyModeIsTest:(null===(e=this.subSurface)||void 0===e||!e.disableAlphaBlending)&&this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===Qi.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==Qi.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,n){this._uniformBufferLayoutBuilt||this.buildUniformLayout();const i=t._drawWrapper;if(i.effect&&this.isFrozen&&i._wasPreviouslyReady&&i._wasPreviouslyUsingInstances===n)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new qi(this._eventInfo.defineNames));const r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const s=this.getScene(),a=s.getEngine();if(r._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,s.texturesEnabled)){if(this._albedoTexture&&Qn.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking())return!1;if(this._baseWeightTexture&&Qn.BaseWeightTextureEnabled&&!this._baseWeightTexture.isReadyOrNotBlocking())return!1;if(this._ambientTexture&&Qn.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking())return!1;if(this._opacityTexture&&Qn.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const e=this._getReflectionTexture();if(e&&Qn.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;var o;if(e.irradianceTexture){if(!e.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!e.sphericalPolynomial&&null!==(o=e.getInternalTexture())&&void 0!==o&&o._sphericalPolynomialPromise)return!1}if(this._lightmapTexture&&Qn.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking())return!1;if(this._emissiveTexture&&Qn.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(Qn.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking())return!1;if(this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking())return!1;if(this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(a.getCaps().standardDerivatives&&this._bumpTexture&&Qn.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady())return!1;if(this._environmentBRDFTexture&&Qn.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(r._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;if(r.AREALIGHTUSED)for(let t=0;t<e.lightSources.length;t++)if(!e.lightSources[t]._isReady())return!1;a.getCaps().standardDerivatives||e.isVerticesDataPresent(z.b.NormalKind)||(e.createNormals(!0),T.a.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const l=t.effect,c=r._areLightsDisposed;let d=this._prepareEffect(e,r,this.onCompiled,this.onError,n,null,t.getRenderingMesh().hasThinInstances),h=!1;if(d)if(this._onEffectCreatedObservable&&(Yi.effect=d,Yi.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Yi)),this.allowShaderHotSwapping&&l&&!d.isReady()){if(d=l,r.markAsUnprocessed(),h=this.isFrozen,c)return r._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(d,r,this._materialContext);return!(!t.effect||!t.effect.isReady()||(r._renderId=s.getRenderId(),i._wasPreviouslyReady=!h,i._wasPreviouslyUsingInstances=!!n,this._checkScenePerformancePriority(),0))}isMetallicWorkflow(){return!(null==this._metallic&&null==this._roughness&&!this._metallicTexture)}_prepareEffect(e,t,i=null,r=null,s=null,a=null,o){if(this._prepareDefines(e,t,s,a,o),!t.isDirty)return null;t.markAsProcessed();const l=this.getScene().getEngine(),c=new It;let d=0;t.USESPHERICALINVERTEX&&c.addFallback(d++,"USESPHERICALINVERTEX"),t.FOG&&c.addFallback(d,"FOG"),t.SPECULARAA&&c.addFallback(d,"SPECULARAA"),t.POINTSIZE&&c.addFallback(d,"POINTSIZE"),t.LOGARITHMICDEPTH&&c.addFallback(d,"LOGARITHMICDEPTH"),t.PARALLAX&&c.addFallback(d,"PARALLAX"),t.PARALLAX_RHS&&c.addFallback(d,"PARALLAX_RHS"),t.PARALLAXOCCLUSION&&c.addFallback(d++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&c.addFallback(d++,"ENVIRONMENTBRDF"),t.TANGENT&&c.addFallback(d++,"TANGENT"),t.BUMP&&c.addFallback(d++,"BUMP"),d=Ne(t,c,this._maxSimultaneousLights,d++),t.SPECULARTERM&&c.addFallback(d++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&c.addFallback(d++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&c.addFallback(d++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&c.addFallback(d++,"LIGHTMAP"),t.NORMAL&&c.addFallback(d++,"NORMAL"),t.AMBIENT&&c.addFallback(d++,"AMBIENT"),t.EMISSIVE&&c.addFallback(d++,"EMISSIVE"),t.VERTEXCOLOR&&c.addFallback(d++,"VERTEXCOLOR"),t.MORPHTARGETS&&c.addFallback(d++,"MORPHTARGETS"),t.MULTIVIEW&&c.addFallback(0,"MULTIVIEW");const h=[z.b.PositionKind];t.NORMAL&&h.push(z.b.NormalKind),t.TANGENT&&h.push(z.b.TangentKind);for(let e=1;e<=6;++e)t["UV"+e]&&h.push("uv"+(1===e?"":e));t.VERTEXCOLOR&&h.push(z.b.ColorKind),Pe(h,e,t,c),Le(h,t),Ae(h,e,t),Me(h,0,t);let u="pbr";const f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","baseWeight","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vBaseWeightInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","baseWeightMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],m=["albedoSampler","baseWeightSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","icdfSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"],p=["Material","Scene","Mesh"],g={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=c,this._eventInfo.fallbackRank=d,this._eventInfo.defines=t,this._eventInfo.uniforms=f,this._eventInfo.attributes=h,this._eventInfo.samplers=m,this._eventInfo.uniformBuffersNames=p,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=g,this._callbackPluginEventGeneric(128,this._eventInfo),Jn.AddUniformsAndSamplers(f,m),zn.AddUniforms(f),zn.AddSamplers(m),fe(f),Yn.a&&(Yn.a.PrepareUniforms(f,t),Yn.a.PrepareSamplers(m,t)),Xe({uniformsNames:f,uniformBuffersNames:p,samplers:m,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const _={};this.customShaderNameResolve&&(u=this.customShaderNameResolve(u,f,p,m,t,h,_));const v=t.toString(),E=l.createEffect(u,{attributes:h,uniformsNames:f,uniformBuffersNames:p,samplers:m,defines:v,fallbacks:c,onCompiled:i,onError:r,indexParameters:g,processFinalCode:_.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this.shaderLanguage?await Promise.all([n.e(0).then(n.bind(null,511)),n.e(0).then(n.bind(null,516))]):await Promise.all([n.e(0).then(n.bind(null,527)),n.e(0).then(n.bind(null,515))]),this._shadersLoaded=!0}},l);return this._eventInfo.customCode=void 0,E}_prepareDefines(e,t,n=null,i=null,r=!1){const s=this.getScene(),a=s.getEngine();we(s,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,Ve(s,t);const o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(He(s,t,this.canRenderToMRT&&!o),Ge(s,t,o),Jn.PrepareDefines(a.currentRenderPassId,e,t),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let e=1;e<=6;++e)t["MAINUV"+e]=!1;if(s.texturesEnabled){t.ALBEDODIRECTUV=0,t.BASEWEIGHTDIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,a.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&Qn.DiffuseTextureEnabled?(Ce(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._baseWeightTexture&&Qn.BaseWeightTextureEnabled?Ce(this._baseWeightTexture,t,"BASEWEIGHT"):t.BASEWEIGHT=!1,this._ambientTexture&&Qn.AmbientTextureEnabled?(Ce(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&Qn.OpacityTextureEnabled?(Ce(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const e=this._getReflectionTexture();if(e&&Qn.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=e.gammaSpace,t.RGBDREFLECTION=e.isRGBD,t.LODINREFLECTIONALPHA=e.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=e.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,a._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0,this.getScene().iblCdfGenerator&&(t.IBL_CDF_FILTERING=!0)):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=e.coordinatesMode===Et.a.INVCUBIC_MODE,t.REFLECTIONMAP_3D=e.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.coordinatesMode){case Et.a.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case Et.a.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case Et.a.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case Et.a.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case Et.a.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case Et.a.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Et.a.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Et.a.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Et.a.CUBIC_MODE:case Et.a.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!e.boundingBoxSize}e.coordinatesMode!==Et.a.SKYBOX_MODE&&(e.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USESPHERICALINVERTEX=!1):e.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||a.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;this._lightmapTexture&&Qn.LightmapTextureEnabled?(Ce(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&Qn.EmissiveTextureEnabled?(Ce(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,Qn.SpecularTextureEnabled?(this._metallicTexture?(Ce(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(Ce(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture?(t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture,this._metallicReflectanceTexture?(Ce(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(Ce(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1):(t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1),this._microSurfaceTexture?Ce(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1):(t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1),a.getCaps().standardDerivatives&&this._bumpTexture&&Qn.BumpTextureEnabled&&!this._disableBumpMap?(Ce(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&Qn.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAX_RHS=s.useRightHandedSystem,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAX_RHS=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&Qn.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===Qi.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===Qi.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=a.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1==0?".":""}`,t.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(Fe(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),t,this._applyDecalMapAfterDetailMap),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(z.b.NormalKind),t.DEBUGMODE=this._debugMode),Be(s,a,this,t,!!n,i,r),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),ke(e,t,!0,!0,!0,this._transparencyMode!==Qi.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,n){const i={clipPlane:!1,useInstances:!1,...n};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(4,this._eventInfo),(()=>{if(this._breakShaderLoadedCheck)return;const n=new qi(this._eventInfo.defineNames),r=this._prepareEffect(e,n,void 0,void 0,i.useInstances,i.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Yi.effect=r,Yi.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Yi)),r.isReady()?t&&t(this):r.onCompileObservable.add(()=>{t&&t(this)})})()}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vBaseWeightInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("baseWeightMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("baseWeight",1),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,n){const i=this.getScene(),r=n.materialDefines;if(!r)return;const s=n.effect;if(!s)return;this._activeEffect=s,t.getMeshUniformBuffer().bindToEffect(s,"Mesh"),t.transferToEffect(e);const a=i.getEngine();this._uniformBuffer.bindToEffect(s,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,i,t,e,this.isFrozen),Jn.Bind(a.currentRenderPassId,this._activeEffect,t,e),this._eventInfo.subMesh=n,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),r.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const o=this._mustRebind(i,s,n,t.visibility);Oe(t,this._activeEffect,this.prePassConfiguration);let l=null;const c=this._uniformBuffer;if(o){if(this.bindViewProjection(s),l=this._getReflectionTexture(),!c.useUbo||!this.isFrozen||!c.isSync||n._drawWrapper._forceRebindOnNextCall){var d;if(i.texturesEnabled){if(this._albedoTexture&&Qn.DiffuseTextureEnabled&&(c.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),ye(this._albedoTexture,c,"albedo")),this._baseWeightTexture&&Qn.BaseWeightTextureEnabled&&(c.updateFloat2("vBaseWeightInfos",this._baseWeightTexture.coordinatesIndex,this._baseWeightTexture.level),ye(this._baseWeightTexture,c,"baseWeight")),this._ambientTexture&&Qn.AmbientTextureEnabled&&(c.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),ye(this._ambientTexture,c,"ambient")),this._opacityTexture&&Qn.OpacityTextureEnabled&&(c.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),ye(this._opacityTexture,c,"opacity")),l&&Qn.ReflectionTextureEnabled){if(c.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),c.updateFloat2("vReflectionInfos",l.level,0),l.boundingBoxSize){const e=l;c.updateVector3("vReflectionPosition",e.boundingBoxPosition),c.updateVector3("vReflectionSize",e.boundingBoxSize)}if(this.realTimeFiltering){const e=l.getSize().width;c.updateFloat2("vReflectionFilteringInfo",e,Math.log2(e))}if(!r.USEIRRADIANCEMAP){const e=l.sphericalPolynomial;if(r.USESPHERICALFROMREFLECTIONMAP&&e)if(r.SPHERICAL_HARMONICS){const t=e.preScaledHarmonics;c.updateVector3("vSphericalL00",t.l00),c.updateVector3("vSphericalL1_1",t.l1_1),c.updateVector3("vSphericalL10",t.l10),c.updateVector3("vSphericalL11",t.l11),c.updateVector3("vSphericalL2_2",t.l2_2),c.updateVector3("vSphericalL2_1",t.l2_1),c.updateVector3("vSphericalL20",t.l20),c.updateVector3("vSphericalL21",t.l21),c.updateVector3("vSphericalL22",t.l22)}else c.updateFloat3("vSphericalX",e.x.x,e.x.y,e.x.z),c.updateFloat3("vSphericalY",e.y.x,e.y.y,e.y.z),c.updateFloat3("vSphericalZ",e.z.x,e.z.y,e.z.z),c.updateFloat3("vSphericalXX_ZZ",e.xx.x-e.zz.x,e.xx.y-e.zz.y,e.xx.z-e.zz.z),c.updateFloat3("vSphericalYY_ZZ",e.yy.x-e.zz.x,e.yy.y-e.zz.y,e.yy.z-e.zz.z),c.updateFloat3("vSphericalZZ",e.zz.x,e.zz.y,e.zz.z),c.updateFloat3("vSphericalXY",e.xy.x,e.xy.y,e.xy.z),c.updateFloat3("vSphericalYZ",e.yz.x,e.yz.y,e.yz.z),c.updateFloat3("vSphericalZX",e.zx.x,e.zx.y,e.zx.z)}c.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset)}this._emissiveTexture&&Qn.EmissiveTextureEnabled&&(c.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),ye(this._emissiveTexture,c,"emissive")),this._lightmapTexture&&Qn.LightmapTextureEnabled&&(c.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),ye(this._lightmapTexture,c,"lightmap")),Qn.SpecularTextureEnabled&&(this._metallicTexture?(c.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),ye(this._metallicTexture,c,"reflectivity")):this._reflectivityTexture&&(c.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),ye(this._reflectivityTexture,c,"reflectivity")),this._metallicReflectanceTexture&&(c.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),ye(this._metallicReflectanceTexture,c,"metallicReflectance")),this._reflectanceTexture&&r.REFLECTANCE&&(c.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),ye(this._reflectanceTexture,c,"reflectance")),this._microSurfaceTexture&&(c.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),ye(this._microSurfaceTexture,c,"microSurfaceSampler"))),this._bumpTexture&&a.getCaps().standardDerivatives&&Qn.BumpTextureEnabled&&!this._disableBumpMap&&(c.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),ye(this._bumpTexture,c,"bump"),i._mirroredCameraPosition?c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&c.updateFloat("pointSize",this.pointSize),r.METALLICWORKFLOW){var h,u;he.c.Color3[0].r=void 0===this._metallic||null===this._metallic?1:this._metallic,he.c.Color3[0].g=void 0===this._roughness||null===this._roughness?1:this._roughness,c.updateColor4("vReflectivityColor",he.c.Color3[0],1);const e=null!==(h=null===(u=this.subSurface)||void 0===u?void 0:u._indexOfRefraction)&&void 0!==h?h:1.5,t=1,n=Math.pow((e-t)/(e+t),2);this._metallicReflectanceColor.scaleToRef(n*this._metallicF0Factor,he.c.Color3[0]);const i=this._metallicF0Factor;c.updateColor4("vMetallicReflectanceFactors",he.c.Color3[0],i)}else c.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);c.updateColor3("vEmissiveColor",Qn.EmissiveTextureEnabled?this._emissiveColor:he.a.BlackReadOnly),c.updateColor3("vReflectionColor",this._reflectionColor),!r.SS_REFRACTION&&null!==(d=this.subSurface)&&void 0!==d&&d._linkRefractionWithTransparency?c.updateColor4("vAlbedoColor",this._albedoColor,1):c.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),c.updateFloat("baseWeight",this._baseWeight),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*i.environmentIntensity,this._lightingInfos.w=this._specularIntensity,c.updateVector4("vLightingIntensity",this._lightingInfos),i.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),c.updateColor3("vAmbientColor",this._globalAmbientColor),c.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}if(i.texturesEnabled){if(this._albedoTexture&&Qn.DiffuseTextureEnabled&&c.setTexture("albedoSampler",this._albedoTexture),this._baseWeightTexture&&Qn.BaseWeightTextureEnabled&&c.setTexture("baseWeightSampler",this._baseWeightTexture),this._ambientTexture&&Qn.AmbientTextureEnabled&&c.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Qn.OpacityTextureEnabled&&c.setTexture("opacitySampler",this._opacityTexture),l&&Qn.ReflectionTextureEnabled){r.LODBASEDMICROSFURACE?c.setTexture("reflectionSampler",l):(c.setTexture("reflectionSampler",l._lodTextureMid||l),c.setTexture("reflectionSamplerLow",l._lodTextureLow||l),c.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)),r.USEIRRADIANCEMAP&&c.setTexture("irradianceSampler",l.irradianceTexture);const e=this.getScene().iblCdfGenerator;this.realTimeFiltering&&e&&c.setTexture("icdfSampler",e.getIcdfTexture())}r.ENVIRONMENTBRDF&&c.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&Qn.EmissiveTextureEnabled&&c.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Qn.LightmapTextureEnabled&&c.setTexture("lightmapSampler",this._lightmapTexture),Qn.SpecularTextureEnabled&&(this._metallicTexture?c.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&c.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&c.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&r.REFLECTANCE&&c.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&c.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&a.getCaps().standardDerivatives&&Qn.BumpTextureEnabled&&!this._disableBumpMap&&c.setTexture("bumpSampler",this._bumpTexture)}this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(s),this._eventInfo.subMesh=n,this._callbackPluginEventBindForSubMesh(this._eventInfo),pe(this._activeEffect,this,i),this.bindEyePosition(s)}else i.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);var f;!o&&this.isFrozen||(i.lightsEnabled&&!this._disableLighting&&De(i,t,this._activeEffect,r,this._maxSimultaneousLights),(i.fogEnabled&&t.applyFog&&i.fogMode!==v.a.FOGMODE_NONE||l||this.subSurface.refractionTexture||t.receiveShadows||r.PREPASS)&&this.bindView(s),Te(i,t,this._activeEffect,!0),r.NUM_MORPH_INFLUENCERS&&Ie(t,this._activeEffect),r.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(f=t.bakedVertexAnimationManager)||void 0===f||f.bind(s,r.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),Ee(r,this._activeEffect,i));this._afterBind(t,this._activeEffect,n),c.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._baseWeightTexture&&this._baseWeightTexture.animations&&this._baseWeightTexture.animations.length>0&&e.push(this._baseWeightTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._baseWeightTexture&&e.push(this._baseWeightTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._albedoTexture===e||this._baseWeightTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e}setPrePassRenderer(){var e;if(null===(e=this.subSurface)||void 0===e||!e.isScatteringEnabled)return!1;const t=this.getScene().enableSubSurfaceForPrePass();return t&&(t.enabled=!0),!0}dispose(e,t){var n,i,r,s,a,o,l,c,d,h,u,f,m;this._breakShaderLoadedCheck=!0,t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),null===(n=this._albedoTexture)||void 0===n||n.dispose(),null===(i=this._baseWeightTexture)||void 0===i||i.dispose(),null===(r=this._ambientTexture)||void 0===r||r.dispose(),null===(s=this._opacityTexture)||void 0===s||s.dispose(),null===(a=this._reflectionTexture)||void 0===a||a.dispose(),null===(o=this._emissiveTexture)||void 0===o||o.dispose(),null===(l=this._metallicTexture)||void 0===l||l.dispose(),null===(c=this._reflectivityTexture)||void 0===c||c.dispose(),null===(d=this._bumpTexture)||void 0===d||d.dispose(),null===(h=this._lightmapTexture)||void 0===h||h.dispose(),null===(u=this._metallicReflectanceTexture)||void 0===u||u.dispose(),null===(f=this._reflectanceTexture)||void 0===f||f.dispose(),null===(m=this._microSurfaceTexture)||void 0===m||m.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}constructor(e,t,n=!1){super(e,t,void 0,n||Qi.ForceGLSL),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new r.f(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._baseWeightTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=Qi.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=he.a.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new he.a(0,0,0),this._albedoColor=new he.a(1,1,1),this._baseWeight=1,this._reflectivityColor=new he.a(1,1,1),this._reflectionColor=new he.a(1,1,1),this._emissiveColor=new he.a(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=Qi.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new ct.a(16),this._globalAmbientColor=new he.a(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this._shadersLoaded=!1,this._breakShaderLoadedCheck=!1,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new nt(this),this.clearCoat=new ki(this),this.iridescence=new Gi(this),this.anisotropy=new Wi(this),this.sheen=new ji(this),this.subSurface=new Ki(this),this.detailMap=new $n(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Qn.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=Ui(this.getScene()),this.prePassConfiguration=new zn}}Qi.PBRMATERIAL_OPAQUE=je.MATERIAL_OPAQUE,Qi.PBRMATERIAL_ALPHATEST=je.MATERIAL_ALPHATEST,Qi.PBRMATERIAL_ALPHABLEND=je.MATERIAL_ALPHABLEND,Qi.PBRMATERIAL_ALPHATESTANDBLEND=je.MATERIAL_ALPHATESTANDBLEND,Qi.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,Qi.LIGHTFALLOFF_PHYSICAL=0,Qi.LIGHTFALLOFF_GLTF=1,Qi.LIGHTFALLOFF_STANDARD=2,Qi.ForceGLSL=!1,Object(W.a)([Object(X.h)()],Qi.prototype,"_imageProcessingConfiguration",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsMiscDirty")],Qi.prototype,"debugMode",void 0);class Zi extends Qi{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===Qi.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?Qi.LIGHTFALLOFF_PHYSICAL:Qi.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===Qi.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?Qi.LIGHTFALLOFF_GLTF:Qi.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}getClassName(){return"PBRMaterial"}clone(e,t=!0,n=""){const i=ce.a.Clone(()=>new Zi(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return i.id=e,i.name=e,this.stencil.copyTo(i.stencil),this._clonePlugins(i,n),i}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,n){const i=ce.a.Parse(()=>new Zi(e.name,t),e,t,n);return e.stencil&&i.stencil.parse(e.stencil,t,n),je._ParsePlugins(e,i,t,n),e.clearCoat&&i.clearCoat.parse(e.clearCoat,t,n),e.anisotropy&&i.anisotropy.parse(e.anisotropy,t,n),e.brdf&&i.brdf.parse(e.brdf,t,n),e.sheen&&i.sheen.parse(e.sheen,t,n),e.subSurface&&i.subSurface.parse(e.subSurface,t,n),e.iridescence&&i.iridescence.parse(e.iridescence,t,n),i}constructor(e,t,n=!1){super(e,t,n),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=Zi.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=he.a.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new he.a(0,0,0),this.albedoColor=new he.a(1,1,1),this.baseWeight=1,this.reflectivityColor=new he.a(1,1,1),this.reflectionColor=new he.a(1,1,1),this.emissiveColor=new he.a(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=Ui(this.getScene())}}Zi.PBRMATERIAL_OPAQUE=Qi.PBRMATERIAL_OPAQUE,Zi.PBRMATERIAL_ALPHATEST=Qi.PBRMATERIAL_ALPHATEST,Zi.PBRMATERIAL_ALPHABLEND=Qi.PBRMATERIAL_ALPHABLEND,Zi.PBRMATERIAL_ALPHATESTANDBLEND=Qi.PBRMATERIAL_ALPHATESTANDBLEND,Zi.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=Qi.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"directIntensity",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"emissiveIntensity",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"environmentIntensity",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"specularIntensity",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"disableBumpMap",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"albedoTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"baseWeightTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"ambientTexture",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"ambientTextureStrength",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesAndMiscDirty")],Zi.prototype,"opacityTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"reflectionTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"emissiveTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"reflectivityTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"metallicTexture",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"metallic",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"roughness",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"metallicF0Factor",void 0),Object(W.a)([Object(X.d)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"metallicReflectanceColor",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"metallicReflectanceTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"reflectanceTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"microSurfaceTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"bumpTexture",void 0),Object(W.a)([Object(X.l)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty",null)],Zi.prototype,"lightmapTexture",void 0),Object(W.a)([Object(X.d)("ambient"),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"ambientColor",void 0),Object(W.a)([Object(X.d)("albedo"),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"albedoColor",void 0),Object(W.a)([Object(X.c)("baseWeight"),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"baseWeight",void 0),Object(W.a)([Object(X.d)("reflectivity"),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"reflectivityColor",void 0),Object(W.a)([Object(X.d)("reflection"),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"reflectionColor",void 0),Object(W.a)([Object(X.d)("emissive"),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"emissiveColor",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"microSurface",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useLightmapAsShadowmap",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesAndMiscDirty")],Zi.prototype,"useAlphaFromAlbedoTexture",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesAndMiscDirty")],Zi.prototype,"forceAlphaTest",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesAndMiscDirty")],Zi.prototype,"alphaCutOff",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useSpecularOverAlpha",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useRoughnessFromMetallicTextureGreen",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useMetallnessFromMetallicTextureBlue",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useAmbientInGrayScale",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),Object(W.a)([Object(X.c)()],Zi.prototype,"usePhysicalLightFalloff",null),Object(W.a)([Object(X.c)()],Zi.prototype,"useGLTFLightFalloff",null),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useRadianceOverAlpha",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useObjectSpaceNormalMap",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useParallax",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useParallaxOcclusion",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"parallaxScaleBias",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsLightsDirty")],Zi.prototype,"disableLighting",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"forceIrradianceInFragment",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsLightsDirty")],Zi.prototype,"maxSimultaneousLights",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"invertNormalMapX",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"invertNormalMapY",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"twoSidedLighting",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useAlphaFresnel",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useLinearAlphaFresnel",void 0),Object(W.a)([Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"environmentBRDFTexture",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"forceNormalForward",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"enableSpecularAntiAliasing",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useHorizonOcclusion",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsTexturesDirty")],Zi.prototype,"useRadianceOcclusion",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsMiscDirty")],Zi.prototype,"unlit",void 0),Object(W.a)([Object(X.c)(),Object(X.a)("_markAllSubMeshesAsMiscDirty")],Zi.prototype,"applyDecalMapAfterDetailMap",void 0),Object(Je.b)("BABYLON.PBRMaterial",Zi);class $i{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===t||0===e)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}get hasUV2s(){return!!this._uv2s}get hasColors(){return!!this._colors}get vertexCount(){return this._positions?this._positions.length/3:this._normals?this._normals.length/3:this._tangents?this._tangents.length/3:this._uvs?this._uvs.length/2:this._uv2s?this._uv2s.length/2:this._colors?this._colors.length/4:0}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}setUV2s(e){const t=this.hasUV2s;this._uv2s=e,t!==this.hasUV2s&&this._onDataLayoutChanged.notifyObservers(void 0)}getUV2s(){return this._uv2s}setColors(e){const t=this.hasColors;this._colors=e,t!==this.hasColors&&this._onDataLayoutChanged.notifyObservers(void 0)}getColors(){return this._colors}clone(){const e=ce.a.Clone(()=>new $i(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e._uv2s=this._uv2s,e._colors=this._colors,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),this.hasUV2s&&(e.uv2s=Array.prototype.slice.call(this.getUV2s())),this.hasColors&&(e.colors=Array.prototype.slice.call(this.getColors())),ce.a.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const n=new $i(e.name,e.influence);if(n.setPositions(e.positions),null!=e.id&&(n.id=e.id),e.normals&&n.setNormals(e.normals),e.tangents&&n.setTangents(e.tangents),e.uvs&&n.setUVs(e.uvs),e.uv2s&&n.setUV2s(e.uv2s),e.colors&&n.setColors(e.colors),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=Object(Je.a)("BABYLON.Animation");r&&n.animations.push(r.Parse(i))}e.autoAnimate&&t&&t.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return n}static FromMesh(e,t,n){t||(t=e.name);const i=new $i(t,n,e.getScene());return i.setPositions(e.getVerticesData(z.b.PositionKind)),e.isVerticesDataPresent(z.b.NormalKind)&&i.setNormals(e.getVerticesData(z.b.NormalKind)),e.isVerticesDataPresent(z.b.TangentKind)&&i.setTangents(e.getVerticesData(z.b.TangentKind)),e.isVerticesDataPresent(z.b.UVKind)&&i.setUVs(e.getVerticesData(z.b.UVKind)),e.isVerticesDataPresent(z.b.UV2Kind)&&i.setUV2s(e.getVerticesData(z.b.UV2Kind)),e.isVerticesDataPresent(z.b.ColorKind)&&i.setColors(e.getVerticesData(z.b.ColorKind)),i}constructor(e,t=0,n=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uv2s=null,this._colors=null,this._uniqueId=0,this.onInfluenceChanged=new _.a,this._onDataLayoutChanged=new _.a,this._animationPropertiesOverride=null,this.id=e,this._scene=n||E.a.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}}Object(W.a)([Object(X.c)()],$i.prototype,"id",void 0);class Ji extends Et.a{get depth(){return this._depth}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,n,i,r,s=!0,a=!1,o=3,l=0){return new Ji(e,t,n,i,5,r,s,a,o,l)}constructor(e,t,n,i,r,s,a=!0,o=!1,l=Et.a.TRILINEAR_SAMPLINGMODE,c=0,d){super(null,s,!a,o),this.format=r,this._texture=s.getEngine().createRawTexture2DArray(e,t,n,i,r,a,o,l,null,c,d),this._depth=i,this.is2DArray=!0}}class er{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(this._forceUpdateWhenUnfrozen),this._forceUpdateWhenUnfrozen=!1))}get areUpdatesFrozen(){return this._blockCounter>0}get numMaxInfluencers(){return this._numMaxInfluencers}set numMaxInfluencers(e){this._numMaxInfluencers!==e&&(this._numMaxInfluencers=e,this._mustSynchronize=!0,this._syncActiveTargets())}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsPositions(){return this._supportsPositions&&this.enablePositionMorphing}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get supportsUV2s(){return this._supportsUV2s&&this.enableUV2Morphing}get supportsColors(){return this._supportsColors&&this.enableColorMorphing}get hasPositions(){return this._supportsPositions}get hasNormals(){return this._supportsNormals}get hasTangents(){return this._supportsTangents}get hasUVs(){return this._supportsUVs}get hasUV2s(){return this._supportsUV2s}get hasColors(){return this._supportsColors}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets!==e&&(this._useTextureToStoreTargets=e,this._mustSynchronize=!0,this._syncActiveTargets())}get isUsingTextureForTargets(){var e;return er.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!(null!==(e=this._scene)&&void 0!==e&&e.getEngine().getCaps().disableMorphTargetTexture)}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}getTargetByName(e){for(const t of this._targets)if(t.name===e)return t;return null}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(e=>{this.areUpdatesFrozen&&e&&(this._forceUpdateWhenUnfrozen=!0),this._syncActiveTargets(e)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._mustSynchronize=!0,this._syncActiveTargets()})),this._mustSynchronize=!0,this._syncActiveTargets()}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._mustSynchronize=!0,this._syncActiveTargets()),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture),e.setInt("morphTargetCount",this.numInfluencers)}clone(){const e=new er(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enablePositionMorphing=this.enablePositionMorphing,e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e.enableUV2Morphing=this.enableUV2Morphing,e.enableColorMorphing=this.enableColorMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e=!1){if(this.areUpdatesFrozen)return;const t=!!this._targetStoreTexture,n=this.isUsingTextureForTargets;(this._mustSynchronize||t!==n)&&(this._mustSynchronize=!1,this.synchronize());let i=0;this._activeTargets.reset(),this._morphTargetTextureIndices&&this._morphTargetTextureIndices.length===this._targets.length||(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let r=-1;for(const e of this._targets)if(r++,0!==e.influence||!this.optimizeInfluencers){if(this._activeTargets.length>=er.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(e),this._morphTargetTextureIndices[i]=r,this._tempInfluences[i++]=e.influence}this._morphTargetTextureIndices.length!==i&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,i)),this._influences&&this._influences.length===i||(this._influences=new Float32Array(i));for(let e=0;e<i;e++)this._influences[e]=this._tempInfluences[e];if(e&&this._scene)for(const e of this._scene.meshes)e.morphTargetManager===this&&(n?e._markSubMeshesAsAttributesDirty():e._syncGeometryWithMorphTargetManager())}synchronize(){var e;if(!this._scene||this.areUpdatesFrozen)return;const t=this._scene.getEngine();this._supportsPositions=!0,this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._supportsUV2s=!0,this._supportsColors=!0,this._vertexCount=0,null===(e=this._targetStoreTexture)||void 0===e||e.dispose(),this._targetStoreTexture=null,this.isUsingTextureForTargets&&this._targets.length>t.getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1);for(const e of this._targets){this._supportsPositions=this._supportsPositions&&e.hasPositions,this._supportsNormals=this._supportsNormals&&e.hasNormals,this._supportsTangents=this._supportsTangents&&e.hasTangents,this._supportsUVs=this._supportsUVs&&e.hasUVs,this._supportsUV2s=this._supportsUV2s&&e.hasUV2s,this._supportsColors=this._supportsColors&&e.hasColors;const t=e.vertexCount;if(0===this._vertexCount)this._vertexCount=t;else if(this._vertexCount!==t)return void T.a.Error(`Incompatible target. Targets must all have the same vertices count. Current vertex count: ${this._vertexCount}, vertex count for target "${e.name}": ${t}`)}if(this.isUsingTextureForTargets){this._textureVertexStride=0,this._supportsPositions&&this._textureVertexStride++,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._supportsUV2s&&this._textureVertexStride++,this._supportsColors&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;const e=t.getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);const n=this._targets.length,i=new Float32Array(n*this._textureWidth*this._textureHeight*4);let r=0;for(let e=0;e<n;e++){const t=this._targets[e],n=t.getPositions(),s=t.getNormals(),a=t.getUVs(),o=t.getTangents(),l=t.getUV2s(),c=t.getColors();r=e*this._textureWidth*this._textureHeight*4;for(let e=0;e<this._vertexCount;e++)this._supportsPositions&&n&&(i[r]=n[3*e],i[r+1]=n[3*e+1],i[r+2]=n[3*e+2],r+=4),this._supportsNormals&&s&&(i[r]=s[3*e],i[r+1]=s[3*e+1],i[r+2]=s[3*e+2],r+=4),this._supportsUVs&&a&&(i[r]=a[2*e],i[r+1]=a[2*e+1],r+=4),this._supportsTangents&&o&&(i[r]=o[3*e],i[r+1]=o[3*e+1],i[r+2]=o[3*e+2],r+=4),this._supportsUV2s&&l&&(i[r]=l[2*e],i[r+1]=l[2*e+1],r+=4),this._supportsColors&&c&&(i[r]=c[4*e],i[r+1]=c[4*e+1],i[r+2]=c[4*e+2],i[r+3]=c[4*e+3],r+=4)}this._targetStoreTexture=Ji.CreateRGBATexture(i,this._textureWidth,this._textureHeight,n,this._scene,!1,!1,1,1),this._targetStoreTexture.name="Morph texture_"+this.uniqueId}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const n=new er(t);for(const i of e.targets)n.addTarget($i.Parse(i,t));return n}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new ct.a(16),this._supportsPositions=!1,this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._supportsUV2s=!1,this._supportsColors=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._mustSynchronize=!0,this._forceUpdateWhenUnfrozen=!1,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enablePositionMorphing=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this.enableUV2Morphing=!0,this.enableColorMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,e||(e=E.a.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const e=this._scene.getEngine().getCaps();this._canUseTextureForTargets=e.canUseGLVertexID&&e.textureFloat&&e.maxVertexTextureImageUnits>0&&e.texture2DArrayMaxLayerCount>1}}}function tr(e,t,n,i){return r.e.FromArray(t,n).scaleInPlace(i)}er.EnableTextureStorage=!0,er.MaxActiveMorphTargetsInVertexAttributeMode=8;class nr{_buildAnimation(e,t,n){const i=new Vn.a(e,this.name,t,this.type);return i.setKeys(n),i}constructor(e,t,n,i){this.type=e,this.name=t,this.getValue=n,this.getStride=i}}class ir extends nr{buildAnimations(e,t,n,i,r){r(e._babylonTransformNode,this._buildAnimation(t,n,i))}}const rr={translation:[new ir(Vn.a.ANIMATIONTYPE_VECTOR3,"position",tr,()=>3)],rotation:[new ir(Vn.a.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",(function(e,t,n,i){return r.b.FromArray(t,n).scaleInPlace(i)}),()=>4)],scale:[new ir(Vn.a.ANIMATIONTYPE_VECTOR3,"scaling",tr,()=>3)],weights:[new class extends nr{buildAnimations(e,t,n,i,r){if(e._numMorphTargets)for(let s=0;s<e._numMorphTargets;s++){const a=new Vn.a(`${t}_${s}`,this.name,n,this.type);if(a.setKeys(i.map(e=>({frame:e.frame,inTangent:e.inTangent?e.inTangent[s]:void 0,value:e.value[s],outTangent:e.outTangent?e.outTangent[s]:void 0,interpolation:e.interpolation}))),e._primitiveBabylonMeshes)for(const t of e._primitiveBabylonMeshes)if(t.morphTargetManager){const e=t.morphTargetManager.getTarget(s),n=a.clone();e.animations.push(n),r(e,n)}}}}(Vn.a.ANIMATIONTYPE_FLOAT,"influence",(function(e,t,n,i){const r=new Array(e._numMorphTargets);for(let e=0;e<r.length;e++)r[e]=t[n++]*i;return r}),e=>e._numMorphTargets)]},sr=new Map,ar=sr;function or(e,t,n){lr(e)&&T.a.Warn(`Extension with the name '${e}' already exists`),sr.set(e,{isGLTFExtension:t,factory:n})}function lr(e){return sr.delete(e)}class cr{static Get(e,t,n){if(!t||null==n||!t[n])throw new Error(`${e}: Failed to find index (${n})`);return t[n]}static TryGet(e,t){return e&&null!=t&&e[t]?e[t]:null}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}function dr(e){if(e.min&&e.max){const t=e.min,n=e.max,i=r.c.Vector3[0].copyFromFloats(t[0],t[1],t[2]),s=r.c.Vector3[1].copyFromFloats(n[0],n[1],n[2]);if(e.normalized&&5126!==e.componentType){let t=1;switch(e.componentType){case 5120:t=127;break;case 5121:t=255;break;case 5122:t=32767;break;case 5123:t=65535}const n=1/t;i.scaleInPlace(n),s.scaleInPlace(n)}return new ne(i,s)}return null}class hr{static RegisterExtension(e,t){or(e,!1,t)}static UnregisterExtension(e){return lr(e)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,n,i,r,s,a=""){return Promise.resolve().then(()=>{this._babylonScene=t,this._assetContainer=n,this._loadData(i);let s=null;if(e){const t={};if(this._gltf.nodes)for(const e of this._gltf.nodes)e.name&&(t[e.name]=e.index);s=(e instanceof Array?e:[e]).map(e=>{const n=t[e];if(void 0===n)throw new Error(`Failed to find node '${e}'`);return n})}return this._loadAsync(r,a,s,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]}))})}loadAsync(e,t,n,i,r=""){return Promise.resolve().then(()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(n,r,null,()=>{})))}_loadAsync(e,t,n,i){return Promise.resolve().then(async()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,await this._loadExtensionsAsync();const r=`${vn[vn.LOADING]} => ${vn[vn.READY]}`,s=`${vn[vn.LOADING]} => ${vn[vn.COMPLETE]}`;this._parent._startPerformanceCounter(r),this._parent._startPerformanceCounter(s),this._parent._setState(vn.LOADING),this._extensionsOnLoading();const a=new Array,o=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials)if(n)a.push(this.loadSceneAsync("/nodes",{nodes:n,index:-1}));else if(null!=this._gltf.scene||this._gltf.scenes&&this._gltf.scenes[0]){const e=cr.Get("/scene",this._gltf.scenes,this._gltf.scene||0);a.push(this.loadSceneAsync("/scenes/"+e.index,e))}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let e=0;e<this._gltf.materials.length;++e){const t=this._gltf.materials[e],n="/materials/"+e,i=je.TriangleFillMode;a.push(this._loadMaterialAsync(n,t,null,i,()=>{}))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=o:this._babylonScene._forceBlockMaterialDirtyMechanism(o),this._parent.compileMaterials&&a.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&a.push(this._compileShadowGeneratorsAsync()),Promise.all(a).then(()=>{this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0);for(const e of this._babylonScene.materials){const t=e;void 0!==t.maxSimultaneousLights&&(t.maxSimultaneousLights=Math.max(t.maxSimultaneousLights,this._babylonScene.lights.length))}return this._extensionsOnReady(),this._parent._setState(vn.READY),this._startAnimations(),i()}).then(e=>(this._parent._endPerformanceCounter(r),g.b.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(s),this._parent._setState(vn.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},e=>{this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()})}),e))}).catch(e=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()),e})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const n=t[0];(n.byteLength<e.bin.byteLength-3||n.byteLength>e.bin.byteLength)&&T.a.Warn(`Binary buffer length (${n.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else T.a.Warn("Unexpected BIN chunk")}}_setupData(){if(cr.Assign(this._gltf.accessors),cr.Assign(this._gltf.animations),cr.Assign(this._gltf.buffers),cr.Assign(this._gltf.bufferViews),cr.Assign(this._gltf.cameras),cr.Assign(this._gltf.images),cr.Assign(this._gltf.materials),cr.Assign(this._gltf.meshes),cr.Assign(this._gltf.nodes),cr.Assign(this._gltf.samplers),cr.Assign(this._gltf.scenes),cr.Assign(this._gltf.skins),cr.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const t of this._gltf.nodes)if(t.children)for(const n of t.children)e[n]=t.index;const t=this._createRootNode();for(const n of this._gltf.nodes){const i=e[n.index];n.parent=void 0===i?t:this._gltf.nodes[i]}}}async _loadExtensionsAsync(){const e=[];if(ar.forEach((t,n)=>{var i;!1===(null===(i=this.parent.extensionOptions[n])||void 0===i?void 0:i.enabled)?t.isGLTFExtension&&this.isExtensionUsed(n)&&T.a.Warn(`Extension ${n} is used but has been explicitly disabled.`):t.isGLTFExtension&&!this.isExtensionUsed(n)||e.push((async()=>{const e=await t.factory(this);return e.name!==n&&T.a.Warn(`The name of the glTF loader extension instance does not match the registered name: ${e.name} !== ${n}`),this._parent.onExtensionLoadedObservable.notifyObservers(e),e})())}),this._extensions.push(...await Promise.all(e)),this._extensions.sort((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired)for(const e of this._gltf.extensionsRequired)if(!this._extensions.some(t=>t.name===e&&t.enabled)){var t;if(!1===(null===(t=this.parent.extensionOptions[e])||void 0===t?void 0:t.enabled))throw new Error(`Required extension ${e} is disabled`);throw new Error(`Required extension ${e} is not available`)}}_createRootNode(){if(void 0!==this._parent.customRootNode)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:null===this._rootBabylonMesh?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;const e=new en("__root__",this._babylonScene);this._rootBabylonMesh=e,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case gn.AUTO:this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],hr._LoadTransform(t,this._rootBabylonMesh));break;case gn.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=!0;break;default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(e),t}loadSceneAsync(e,t){const n=this._extensionsLoadSceneAsync(e,t);if(n)return n;const i=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const n of t.nodes){const t=cr.Get(`${e}/nodes/${n}`,this._gltf.nodes,n);i.push(this.loadNodeAsync("/nodes/"+t.index,t,e=>{e.parent=this._rootBabylonMesh}))}for(const e of this._postSceneLoadActions)e();return i.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(i).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const n of e._primitiveBabylonMeshes)t(n)}_getGeometries(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,t=>{const n=t.geometry;n&&-1===e.indexOf(n)&&e.push(n)});return e}_getMeshes(){const e=[];this._rootBabylonMesh instanceof jt&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const n of t)this._forEachPrimitive(n,t=>{e.push(t)});return e}_getTransformNodes(){const e=[],t=this._gltf.nodes;if(t)for(const n of t)n._babylonTransformNode&&"TransformNode"===n._babylonTransformNode.getClassName()&&e.push(n._babylonTransformNode),n._babylonTransformNodeForSkin&&e.push(n._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=[],t=this._gltf.skins;if(t)for(const n of t)n._data&&e.push(n._data.babylonSkeleton);return e}_getAnimationGroups(){const e=[],t=this._gltf.animations;if(t)for(const n of t)n._babylonAnimationGroup&&e.push(n._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case _n.NONE:break;case _n.FIRST:{const e=this._getAnimationGroups();0!==e.length&&e[0].start(!0);break}case _n.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:return void T.a.Error(`Invalid animation start mode (${this._parent.animationStartMode})`)}}loadNodeAsync(e,t,n=(()=>{})){const i=this._extensionsLoadNodeAsync(e,t,n);if(i)return i;if(t._babylonTransformNode)throw new Error(e+": Invalid recursive node hierarchy");const r=new Array;this.logOpen(`${e} ${t.name||""}`);const s=i=>{if(hr.AddPointerMetadata(i,e),hr._LoadTransform(t,i),null!=t.camera){const n=cr.Get(e+"/camera",this._gltf.cameras,t.camera);r.push(this.loadCameraAsync("/cameras/"+n.index,n,e=>{e.parent=i}))}if(t.children)for(const n of t.children){const t=cr.Get(`${e}/children/${n}`,this._gltf.nodes,n);r.push(this.loadNodeAsync("/nodes/"+t.index,t,e=>{e.parent=i}))}n(i)},a=null!=t.mesh,o=this._parent.loadSkins&&null!=t.skin;if(!a||o){const e=t.name||"node"+t.index;this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new Vt(e,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,null==t.mesh?t._babylonTransformNode=n:t._babylonTransformNodeForSkin=n,s(n)}if(a)if(o){const n=cr.Get(e+"/mesh",this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync("/meshes/"+n.index,t,n,n=>{const i=t._babylonTransformNodeForSkin;n.metadata=function e(...t){const n=e=>!!e&&"object"==typeof e;return t.reduce((t,i)=>(Object.keys(i).forEach(r=>{const s=t[r],a=i[r];Array.isArray(s)&&Array.isArray(a)?t[r]=s.concat(...a):n(s)&&n(a)?t[r]=e(s,a):t[r]=a}),t),{})}(i.metadata,n.metadata||{});const s=cr.Get(e+"/skin",this._gltf.skins,t.skin);r.push(this._loadSkinAsync("/skins/"+s.index,t,s,e=>{this._forEachPrimitive(t,t=>{t.skeleton=e}),this._postSceneLoadActions.push(()=>{if(null!=s.skeleton){const e=cr.Get(`/skins/${s.index}/skeleton`,this._gltf.nodes,s.skeleton).parent;t.index===e.index?n.parent=i.parent:n.parent=e._babylonTransformNode}else n.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:i,skinnedNode:n})})}))}))}else{const n=cr.Get(e+"/mesh",this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync("/meshes/"+n.index,t,n,s))}return this.logClose(),Promise.all(r).then(()=>(this._forEachPrimitive(t,e=>{e.geometry&&e.geometry.useBoundingInfoFromGeometry?e._updateBoundingInfo():e.refreshBoundingInfo(!0,!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,n,i){const r=n.primitives;if(!r||!r.length)throw new Error(e+": Primitives are missing");null==r[0].index&&cr.Assign(r);const s=new Array;this.logOpen(`${e} ${n.name||""}`);const a=t.name||"node"+t.index;if(1===r.length){const i=n.primitives[0];s.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${i.index}`,a,t,n,i,e=>{t._babylonTransformNode=e,t._primitiveBabylonMeshes=[e]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new Vt(a,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const i of r)s.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${i.index}`,`${a}_primitive${i.index}`,t,n,i,e=>{e.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(e)}))}return i(t._babylonTransformNode),this.logClose(),Promise.all(s).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,n,i,r,s){const a=this._extensionsLoadMeshPrimitiveAsync(e,t,n,i,r,s);if(a)return a;this.logOpen(""+e);const o=0===this._disableInstancedMesh&&this._parent.createInstances&&null==n.skin&&!i.primitives[0].targets;let l,c;if(o&&r._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,l=r._instanceData.babylonSourceMesh.createInstance(t),l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,c=r._instanceData.promise;else{const s=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new en(t,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.sideOrientation=this._babylonScene.useRightHandedSystem?je.CounterClockWiseSideOrientation:je.ClockWiseSideOrientation,this._createMorphTargets(e,n,i,r,a),s.push(this._loadVertexDataAsync(e,r,a).then(t=>this._loadMorphTargetsAsync(e,r,a,t).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,t.applyToMesh(a),t._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const d=hr._GetDrawMode(e,r.mode);if(null==r.material){let e=this._defaultBabylonMaterialData[d];e||(e=this._createDefaultMaterial("__GLTFLoader._default",d),this._parent.onMaterialLoadedObservable.notifyObservers(e),this._defaultBabylonMaterialData[d]=e),a.material=e}else if(!this.parent.skipMaterials){const t=cr.Get(e+"/material",this._gltf.materials,r.material);s.push(this._loadMaterialAsync("/materials/"+t.index,t,a,d,e=>{a.material=e}))}c=Promise.all(s),o&&(r._instanceData={babylonSourceMesh:a,promise:c}),l=a}return hr.AddPointerMetadata(l,e),this._parent.onMeshLoadedObservable.notifyObservers(l),s(l),this.logClose(),c.then(()=>l)}_loadVertexDataAsync(e,t,n){const i=this._extensionsLoadVertexDataAsync(e,t,n);if(i)return i;const r=t.attributes;if(!r)throw new Error(e+": Attributes are missing");const s=new Array,a=new Bt(n.name,this._babylonScene);if(null==t.indices)n.isUnIndexed=!0;else{const n=cr.Get(e+"/indices",this._gltf.accessors,t.indices);s.push(this._loadIndicesAccessorAsync("/accessors/"+n.index,n).then(e=>{a.setIndices(e)}))}const o=(t,i,o)=>{if(null==r[t])return;n._delayInfo=n._delayInfo||[],-1===n._delayInfo.indexOf(i)&&n._delayInfo.push(i);const l=cr.Get(`${e}/attributes/${t}`,this._gltf.accessors,r[t]);s.push(this._loadVertexAccessorAsync("/accessors/"+l.index,l,i).then(e=>{if(e.getKind()===z.b.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!n.skeleton){const e=dr(l);e&&(a._boundingInfo=e,a.useBoundingInfoFromGeometry=!0)}a.setVerticesBuffer(e,l.count)})),i==z.b.MatricesIndicesExtraKind&&(n.numBoneInfluencers=8),o&&o(l)};return o("POSITION",z.b.PositionKind),o("NORMAL",z.b.NormalKind),o("TANGENT",z.b.TangentKind),o("TEXCOORD_0",z.b.UVKind),o("TEXCOORD_1",z.b.UV2Kind),o("TEXCOORD_2",z.b.UV3Kind),o("TEXCOORD_3",z.b.UV4Kind),o("TEXCOORD_4",z.b.UV5Kind),o("TEXCOORD_5",z.b.UV6Kind),o("JOINTS_0",z.b.MatricesIndicesKind),o("WEIGHTS_0",z.b.MatricesWeightsKind),o("JOINTS_1",z.b.MatricesIndicesExtraKind),o("WEIGHTS_1",z.b.MatricesWeightsExtraKind),o("COLOR_0",z.b.ColorKind,e=>{"VEC4"===e.type&&(n.hasVertexAlpha=!0)}),Promise.all(s).then(()=>a)}_createMorphTargets(e,t,n,i,r){if(!i.targets||!this._parent.loadMorphTargets)return;if(null==t._numMorphTargets)t._numMorphTargets=i.targets.length;else if(i.targets.length!==t._numMorphTargets)throw new Error(e+": Primitives do not have the same number of targets");const s=n.extras?n.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,r.morphTargetManager=new er(this._babylonScene),r.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.morphTargetManager.areUpdatesFrozen=!0;for(let e=0;e<i.targets.length;e++){const i=t.weights?t.weights[e]:n.weights?n.weights[e]:0,a=s?s[e]:"morphTarget"+e;r.morphTargetManager.addTarget(new $i(a,i,r.getScene()))}}_loadMorphTargetsAsync(e,t,n,i){if(!t.targets||!this._parent.loadMorphTargets)return Promise.resolve();const r=new Array,s=n.morphTargetManager;for(let n=0;n<s.numTargets;n++){const a=s.getTarget(n);r.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${n}`,i,t.targets[n],a))}return Promise.all(r).then(()=>{s.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(e,t,n,i){const r=new Array,s=(i,s,a)=>{if(null==n[i])return;const o=t.getVertexBuffer(s);if(!o)return;const l=cr.Get(`${e}/${i}`,this._gltf.accessors,n[i]);r.push(this._loadFloatAccessorAsync("/accessors/"+l.index,l).then(e=>{a(o,e)}))};return s("POSITION",z.b.PositionKind,(e,t)=>{const n=new Float32Array(t.length);e.forEach(t.length,(e,i)=>{n[i]=t[i]+e}),i.setPositions(n)}),s("NORMAL",z.b.NormalKind,(e,t)=>{const n=new Float32Array(t.length);e.forEach(n.length,(e,i)=>{n[i]=t[i]+e}),i.setNormals(n)}),s("TANGENT",z.b.TangentKind,(e,t)=>{const n=new Float32Array(t.length/3*4);let r=0;e.forEach(t.length/3*4,(e,i)=>{(i+1)%4!=0&&(n[r]=t[r]+e,r++)}),i.setTangents(n)}),s("TEXCOORD_0",z.b.UVKind,(e,t)=>{const n=new Float32Array(t.length);e.forEach(t.length,(e,i)=>{n[i]=t[i]+e}),i.setUVs(n)}),s("TEXCOORD_1",z.b.UV2Kind,(e,t)=>{const n=new Float32Array(t.length);e.forEach(t.length,(e,i)=>{n[i]=t[i]+e}),i.setUV2s(n)}),s("COLOR_0",z.b.ColorKind,(t,n)=>{let r=null;const s=t.getSize();if(3===s){r=new Float32Array(n.length/3*4),t.forEach(n.length,(e,t)=>{const i=Math.floor(t/3),s=t%3;r[4*i+s]=n[3*i+s]+e});for(let e=0;e<n.length/3;++e)r[4*e+3]=1}else{if(4!==s)throw new Error(`${e}: Invalid number of components (${s}) for COLOR_0 attribute`);r=new Float32Array(n.length),t.forEach(n.length,(e,t)=>{r[t]=n[t]+e})}i.setColors(r)}),Promise.all(r).then(()=>{})}static _LoadTransform(e,t){if(null!=e.skin)return;let n=r.e.Zero(),i=r.b.Identity(),s=r.e.One();e.matrix?r.a.FromArray(e.matrix).decompose(s,i,n):(e.translation&&(n=r.e.FromArray(e.translation)),e.rotation&&(i=r.b.FromArray(e.rotation)),e.scale&&(s=r.e.FromArray(e.scale))),t.position=n,t.rotationQuaternion=i,t.scaling=s}_loadSkinAsync(e,t,n,i){if(!this._parent.loadSkins)return Promise.resolve();const r=this._extensionsLoadSkinAsync(e,t,n);if(r)return r;if(n._data)return i(n._data.babylonSkeleton),n._data.promise;const s="skeleton"+n.index;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new Xn(n.name||s,s,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,n,a);const o=this._loadSkinInverseBindMatricesDataAsync(e,n).then(e=>{this._updateBoneMatrices(a,e)});return n._data={babylonSkeleton:a,promise:o},i(a),o}_loadBones(e,t,n){if(null==t.skeleton||this._parent.alwaysComputeSkeletonRootNode){const n=this._findSkeletonRootNode(e+"/joints",t.joints);if(n)if(void 0===t.skeleton)t.skeleton=n.index;else{const i=(e,t)=>{for(;t.parent;t=t.parent)if(t.parent===e)return!0;return!1},r=cr.Get(e+"/skeleton",this._gltf.nodes,t.skeleton);r===n||i(r,n)||(T.a.Warn(e+"/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root"),t.skeleton=n.index)}else T.a.Warn(e+": Failed to find common root")}const i={};for(const r of t.joints){const s=cr.Get(`${e}/joints/${r}`,this._gltf.nodes,r);this._loadBone(s,t,n,i)}}_findSkeletonRootNode(e,t){if(0===t.length)return null;const n={};for(const i of t){const t=[];let r=cr.Get(`${e}/${i}`,this._gltf.nodes,i);for(;-1!==r.index;)t.unshift(r),r=r.parent;n[i]=t}let i=null;for(let e=0;;++e){let r=n[t[0]];if(e>=r.length)return i;const s=r[e];for(let a=1;a<t.length;++a)if(r=n[t[a]],e>=r.length||s!==r[e])return i;i=s}}_loadBone(e,t,n,i){e._isJoint=!0;let r=i[e.index];if(r)return r;let s=null;e.index!==t.skeleton&&(e.parent&&-1!==e.parent.index?s=this._loadBone(e.parent,t,n,i):void 0!==t.skeleton&&T.a.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const a=t.joints.indexOf(e.index);return r=new Gn.a(e.name||"joint"+e.index,n,s,this._getNodeMatrix(e),null,null,a),i[e.index]=r,this._postSceneLoadActions.push(()=>{r.linkTransformNode(e._babylonTransformNode)}),r}_loadSkinInverseBindMatricesDataAsync(e,t){if(null==t.inverseBindMatrices)return Promise.resolve(null);const n=cr.Get(e+"/inverseBindMatrices",this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync("/accessors/"+n.index,n)}_updateBoneMatrices(e,t){for(const n of e.bones){const e=r.a.Identity(),i=n._index;t&&-1!==i&&(r.a.FromArrayToRef(t,16*i,e),e.invertToRef(e));const s=n.getParent();s&&e.multiplyToRef(s.getAbsoluteInverseBindMatrix(),e),n.updateMatrix(e,!1,!1),n._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?r.a.FromArray(e.matrix):r.a.Compose(e.scale?r.e.FromArray(e.scale):r.e.One(),e.rotation?r.b.FromArray(e.rotation):r.b.Identity(),e.translation?r.e.FromArray(e.translation):r.e.Zero())}loadCameraAsync(e,t,n=(()=>{})){const i=this._extensionsLoadCameraAsync(e,t,n);if(i)return i;const s=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new kn(t.name||"camera"+t.index,r.e.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.ignoreParentScaling=!0,t._babylonCamera=a,a.rotation.set(0,Math.PI,0),t.type){case"perspective":{const n=t.perspective;if(!n)throw new Error(e+": Camera perspective properties are missing");a.fov=n.yfov,a.minZ=n.znear,a.maxZ=n.zfar||0;break}case"orthographic":if(!t.orthographic)throw new Error(e+": Camera orthographic properties are missing");a.mode=ft.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-t.orthographic.xmag,a.orthoRight=t.orthographic.xmag,a.orthoBottom=-t.orthographic.ymag,a.orthoTop=t.orthographic.ymag,a.minZ=t.orthographic.znear,a.maxZ=t.orthographic.zfar;break;default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return hr.AddPointerMetadata(a,e),this._parent.onCameraLoadedObservable.notifyObservers(a),n(a),this.logClose(),Promise.all(s).then(()=>a)}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let n=0;n<e.length;n++){const i=e[n];t.push(this.loadAnimationAsync("/animations/"+i.index,i).then(e=>{0===e.targetedAnimations.length&&e.dispose()}))}return Promise.all(t).then(()=>{})}loadAnimationAsync(e,t){return this._extensionsLoadAnimationAsync(e,t)||n.e(0).then(n.bind(null,510)).then(({AnimationGroup:n})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;const i=new n(t.name||"animation"+t.index,this._babylonScene);i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=i;const r=new Array;cr.Assign(t.channels),cr.Assign(t.samplers);for(const n of t.channels)r.push(this._loadAnimationChannelAsync(`${e}/channels/${n.index}`,e,t,n,(e,t)=>{e.animations=e.animations||[],e.animations.push(t),i.addTargetedAnimation(t,e)}));return Promise.all(r).then(()=>(i.normalize(0),i))})}_loadAnimationChannelAsync(e,t,n,i,r){const s=this._extensionsLoadAnimationChannelAsync(e,t,n,i,r);if(s)return s;if(null==i.target.node)return Promise.resolve();const a=cr.Get(e+"/target/node",this._gltf.nodes,i.target.node),o=i.target.path,l="weights"===o;if(l&&!a._numMorphTargets||!l&&!a._babylonTransformNode)return Promise.resolve();if(!this._parent.loadNodeAnimations&&!l&&!a._isJoint)return Promise.resolve();let c;switch(o){case"translation":c=rr.translation;break;case"rotation":c=rr.rotation;break;case"scale":c=rr.scale;break;case"weights":c=rr.weights;break;default:throw new Error(`${e}/target/path: Invalid value (${i.target.path})`)}const d={object:a,info:c};return this._loadAnimationChannelFromTargetInfoAsync(e,t,n,i,d,r)}_loadAnimationChannelFromTargetInfoAsync(e,t,n,i,r,s){const a=this.parent.targetFps,o=1/a,l=cr.Get(e+"/sampler",n.samplers,i.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${i.sampler}`,l).then(e=>{let t=0;const l=r.object,c=r.info;for(const r of c){const c=r.getStride(l),d=e.input,h=e.output,u=new Array(d.length);let f=0;switch(e.interpolation){case"STEP":for(let e=0;e<d.length;e++){const t=r.getValue(l,h,f,1);f+=c,u[e]={frame:d[e]*a,value:t,interpolation:1}}break;case"CUBICSPLINE":for(let e=0;e<d.length;e++){const t=r.getValue(l,h,f,o);f+=c;const n=r.getValue(l,h,f,1);f+=c;const i=r.getValue(l,h,f,o);f+=c,u[e]={frame:d[e]*a,inTangent:t,value:n,outTangent:i}}break;case"LINEAR":for(let e=0;e<d.length;e++){const t=r.getValue(l,h,f,1);f+=c,u[e]={frame:d[e]*a,value:t}}}if(f>0){const e=`${n.name||"animation"+n.index}_channel${i.index}_${t}`;r.buildAnimations(l,e,a,u,(e,n)=>{++t,s(e,n)})}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const n=t.interpolation||"LINEAR";switch(n){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const i=cr.Get(e+"/input",this._gltf.accessors,t.input),r=cr.Get(e+"/output",this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync("/accessors/"+i.index,i),this._loadFloatAccessorAsync("/accessors/"+r.index,r)]).then(([e,t])=>({input:e,interpolation:n,output:t})),t._data}loadBufferAsync(e,t,n,i){const r=this._extensionsLoadBufferAsync(e,t,n,i);if(r)return r;if(!t._data)if(t.uri)t._data=this.loadUriAsync(e+"/uri",t,t.uri);else{if(!this._bin)throw new Error(e+": Uri is missing or the binary glTF is missing its binary chunk");t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(t=>{try{return new Uint8Array(t.buffer,t.byteOffset+n,i)}catch(t){throw new Error(`${e}: ${t.message}`)}})}loadBufferViewAsync(e,t){const n=this._extensionsLoadBufferViewAsync(e,t);if(n)return n;if(t._data)return t._data;const i=cr.Get(e+"/buffer",this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync("/buffers/"+i.index,i,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,n){if(t._data)return t._data;const i=hr._GetNumComponents(e,t.type),r=i*z.b.GetTypeByteLength(t.componentType),s=i*t.count;if(null==t.bufferView)t._data=Promise.resolve(new n(s));else{const a=cr.Get(e+"/bufferView",this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync("/bufferViews/"+a.index,a).then(o=>{if(5126!==t.componentType||t.normalized||a.byteStride&&a.byteStride!==r){const e=new n(s);return z.b.ForEach(o,t.byteOffset||0,a.byteStride||r,i,t.componentType,e.length,t.normalized||!1,(t,n)=>{e[n]=t}),e}return hr._GetTypedArray(e,t.componentType,o,t.byteOffset,s)})}if(t.sparse){const s=t.sparse;t._data=t._data.then(a=>{const o=a,l=cr.Get(e+"/sparse/indices/bufferView",this._gltf.bufferViews,s.indices.bufferView),c=cr.Get(e+"/sparse/values/bufferView",this._gltf.bufferViews,s.values.bufferView);return Promise.all([this.loadBufferViewAsync("/bufferViews/"+l.index,l),this.loadBufferViewAsync("/bufferViews/"+c.index,c)]).then(([a,l])=>{const c=hr._GetTypedArray(e+"/sparse/indices",s.indices.componentType,a,s.indices.byteOffset,s.count),d=i*s.count;let h;if(5126!==t.componentType||t.normalized){const a=hr._GetTypedArray(e+"/sparse/values",t.componentType,l,s.values.byteOffset,d);h=new n(d),z.b.ForEach(a,0,r,i,t.componentType,h.length,t.normalized||!1,(e,t)=>{h[t]=e})}else h=hr._GetTypedArray(e+"/sparse/values",t.componentType,l,s.values.byteOffset,d);let u=0;for(let e=0;e<c.length;e++){let t=c[e]*i;for(let e=0;e<i;e++)o[t++]=h[u++]}return o})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if("SCALAR"!==t.type)throw new Error(`${e}/type: Invalid value ${t.type}`);if(5121!==t.componentType&&5123!==t.componentType&&5125!==t.componentType)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const n=hr._GetTypedArrayConstructor(e+"/componentType",t.componentType);t._data=this._loadAccessorAsync(e,t,n)}else{const n=cr.Get(e+"/bufferView",this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync("/bufferViews/"+n.index,n).then(n=>hr._GetTypedArray(e,t.componentType,n,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync("/bufferViews/"+e.index,e).then(e=>new z.a(t,e,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,n){var i;if(null!==(i=t._babylonVertexBuffer)&&void 0!==i&&i[n])return t._babylonVertexBuffer[n];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const r=this._babylonScene.getEngine();if(t.sparse||null==t.bufferView)t._babylonVertexBuffer[n]=this._loadFloatAccessorAsync(e,t).then(e=>new z.b(r,e,n,!1));else{const i=cr.Get(e+"/bufferView",this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[n]=this._loadVertexBufferViewAsync(i).then(s=>{const a=hr._GetNumComponents(e,t.type);return new z.b(r,s,n,!1,void 0,i.byteStride,void 0,t.byteOffset,a,t.componentType,t.normalized,!0,void 0,!0)})}return t._babylonVertexBuffer[n]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,n){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");const i=new Array;return t&&(t.baseColorFactor?(n.albedoColor=he.a.FromArray(t.baseColorFactor),n.alpha=t.baseColorFactor[3]):n.albedoColor=he.a.White(),n.metallic=null==t.metallicFactor?1:t.metallicFactor,n.roughness=null==t.roughnessFactor?1:t.roughnessFactor,t.baseColorTexture&&i.push(this.loadTextureInfoAsync(e+"/baseColorTexture",t.baseColorTexture,e=>{e.name=n.name+" (Base Color)",n.albedoTexture=e})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,i.push(this.loadTextureInfoAsync(e+"/metallicRoughnessTexture",t.metallicRoughnessTexture,e=>{e.name=n.name+" (Metallic Roughness)",n.metallicTexture=e})),n.useMetallnessFromMetallicTextureBlue=!0,n.useRoughnessFromMetallicTextureGreen=!0,n.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(i).then(()=>{})}_loadMaterialAsync(e,t,n,i,r=(()=>{})){const s=this._extensionsLoadMaterialAsync(e,t,n,i,r);if(s)return s;t._data=t._data||{};let a=t._data[i];if(!a){this.logOpen(`${e} ${t.name||""}`);const n=this.createMaterial(e,t,i);a={babylonMaterial:n,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,n)},t._data[i]=a,hr.AddPointerMetadata(n,e),this._parent.onMaterialLoadedObservable.notifyObservers(n),this.logClose()}return n&&(a.babylonMeshes.push(n),n.onDisposeObservable.addOnce(()=>{const e=a.babylonMeshes.indexOf(n);-1!==e&&a.babylonMeshes.splice(e,1)})),r(a.babylonMaterial),a.promise.then(()=>a.babylonMaterial)}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new Zi(e,this._babylonScene);return n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.fillMode=t,n.enableSpecularAntiAliasing=!0,n.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,n.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,n.transparencyMode=Zi.PBRMATERIAL_OPAQUE,n.metallic=1,n.roughness=1,n}createMaterial(e,t,n){const i=this._extensionsCreateMaterial(e,t,n);if(i)return i;const r=t.name||"material"+t.index;return this._createDefaultMaterial(r,n)}loadMaterialPropertiesAsync(e,t,n){const i=this._extensionsLoadMaterialPropertiesAsync(e,t,n);if(i)return i;const r=new Array;return r.push(this.loadMaterialBasePropertiesAsync(e,t,n)),t.pbrMetallicRoughness&&r.push(this._loadMaterialMetallicRoughnessPropertiesAsync(e+"/pbrMetallicRoughness",t.pbrMetallicRoughness,n)),this.loadMaterialAlphaProperties(e,t,n),Promise.all(r).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,n){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");const i=new Array;return n.emissiveColor=t.emissiveFactor?he.a.FromArray(t.emissiveFactor):new he.a(0,0,0),t.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,i.push(this.loadTextureInfoAsync(e+"/normalTexture",t.normalTexture,e=>{e.name=n.name+" (Normal)",n.bumpTexture=e})),n.invertNormalMapX=!this._babylonScene.useRightHandedSystem,n.invertNormalMapY=this._babylonScene.useRightHandedSystem,null!=t.normalTexture.scale&&n.bumpTexture&&(n.bumpTexture.level=t.normalTexture.scale),n.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,i.push(this.loadTextureInfoAsync(e+"/occlusionTexture",t.occlusionTexture,e=>{e.name=n.name+" (Occlusion)",n.ambientTexture=e})),n.useAmbientInGrayScale=!0,null!=t.occlusionTexture.strength&&(n.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&i.push(this.loadTextureInfoAsync(e+"/emissiveTexture",t.emissiveTexture,e=>{e.name=n.name+" (Emissive)",n.emissiveTexture=e})),Promise.all(i).then(()=>{})}loadMaterialAlphaProperties(e,t,n){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");switch(t.alphaMode||"OPAQUE"){case"OPAQUE":n.transparencyMode=Zi.PBRMATERIAL_OPAQUE,n.alpha=1;break;case"MASK":n.transparencyMode=Zi.PBRMATERIAL_ALPHATEST,n.alphaCutOff=null==t.alphaCutoff?.5:t.alphaCutoff,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0);break;case"BLEND":n.transparencyMode=Zi.PBRMATERIAL_ALPHABLEND,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0,n.useAlphaFromAlbedoTexture=!0);break;default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,n=(()=>{})){const i=this._extensionsLoadTextureInfoAsync(e,t,n);if(i)return i;if(this.logOpen(""+e),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const r=cr.Get(e+"/index",this._gltf.textures,t.index);r._textureInfo=t;const s=this._loadTextureAsync("/textures/"+t.index,r,i=>{i.coordinatesIndex=t.texCoord||0,hr.AddPointerMetadata(i,e),this._parent.onTextureLoadedObservable.notifyObservers(i),n(i)});return this.logClose(),s}_loadTextureAsync(e,t,n=(()=>{})){const i=this._extensionsLoadTextureAsync(e,t,n);if(i)return i;this.logOpen(`${e} ${t.name||""}`);const r=null==t.sampler?hr.DefaultSampler:cr.Get(e+"/sampler",this._gltf.samplers,t.sampler),s=cr.Get(e+"/source",this._gltf.images,t.source),a=this._createTextureAsync(e,r,s,n,void 0,!t._textureInfo.nonColorData);return this.logClose(),a}_createTextureAsync(e,t,n,i=(()=>{}),r,s){const a=this._loadSampler("/samplers/"+t.index,t),o=new Array,l=new Ni;this._babylonScene._blockEntityCollection=!!this._assetContainer;const c={noMipmap:a.noMipMaps,invertY:!1,samplingMode:a.samplingMode,onLoad:()=>{this._disposed||l.resolve()},onError:(t,n)=>{this._disposed||l.reject(new Error(`${e}: ${n&&n.message?n.message:t||"Failed to load texture"}`))},mimeType:n.mimeType,loaderOptions:r,useSRGBBuffer:!!s&&this._parent.useSRGBBuffers},d=new Et.a(null,this._babylonScene,c);return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.push(l.promise),o.push(this.loadImageAsync("/images/"+n.index,n).then(e=>{const t=n.uri||`${this._fileName}#image${n.index}`,i=`data:${this._uniqueRootUrl}${t}`;d.updateURL(i,e);const r=d.getInternalTexture();r&&(r.label=n.name)})),d.wrapU=a.wrapU,d.wrapV=a.wrapV,i(d),this._parent.useGltfTextureNames&&(d.name=n.name||n.uri||"image"+n.index),Promise.all(o).then(()=>d)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:9728===t.minFilter||9729===t.minFilter,samplingMode:hr._GetTextureSamplingMode(e,t),wrapU:hr._GetTextureWrapMode(e+"/wrapS",t.wrapS),wrapV:hr._GetTextureWrapMode(e+"/wrapT",t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(e+"/uri",t,t.uri);else{const n=cr.Get(e+"/bufferView",this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync("/bufferViews/"+n.index,n)}this.logClose()}return t._data}loadUriAsync(e,t,n){const i=this._extensionsLoadUriAsync(e,t,n);if(i)return i;if(!hr._ValidateUri(n))throw new Error(`${e}: '${n}' is invalid`);if(Object(b.c)(n)){const t=new Uint8Array(Object(b.a)(n));return this.log(`${e}: Decoded ${n.substring(0,64)}... (${t.length} bytes)`),Promise.resolve(t)}return this.log(`${e}: Loading ${n}`),this._parent.preprocessUrlAsync(this._rootUrl+n).then(t=>new Promise((i,r)=>{this._parent._loadFile(this._babylonScene,t,t=>{this._disposed||(this.log(`${e}: Loaded ${n} (${t.byteLength} bytes)`),i(new Uint8Array(t)))},!0,t=>{r(new b.e(`${e}: Failed to load '${n}'${t?": "+t.status+" "+t.statusText:""}`,t))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const n=e._internalMetadata=e._internalMetadata||{},i=n.gltf=n.gltf||{};(i.pointers=i.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=null==t?10497:t){case 33071:return Et.a.CLAMP_ADDRESSMODE;case 33648:return Et.a.MIRROR_ADDRESSMODE;case 10497:return Et.a.WRAP_ADDRESSMODE;default:return T.a.Warn(`${e}: Invalid value (${t})`),Et.a.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const n=null==t.magFilter?9729:t.magFilter,i=null==t.minFilter?9987:t.minFilter;if(9729===n)switch(i){case 9728:return Et.a.LINEAR_NEAREST;case 9729:return Et.a.LINEAR_LINEAR;case 9984:return Et.a.LINEAR_NEAREST_MIPNEAREST;case 9985:return Et.a.LINEAR_LINEAR_MIPNEAREST;case 9986:return Et.a.LINEAR_NEAREST_MIPLINEAR;case 9987:return Et.a.LINEAR_LINEAR_MIPLINEAR;default:return T.a.Warn(`${e}/minFilter: Invalid value (${i})`),Et.a.LINEAR_LINEAR_MIPLINEAR}else switch(9728!==n&&T.a.Warn(`${e}/magFilter: Invalid value (${n})`),i){case 9728:return Et.a.NEAREST_NEAREST;case 9729:return Et.a.NEAREST_LINEAR;case 9984:return Et.a.NEAREST_NEAREST_MIPNEAREST;case 9985:return Et.a.NEAREST_LINEAR_MIPNEAREST;case 9986:return Et.a.NEAREST_NEAREST_MIPLINEAR;case 9987:return Et.a.NEAREST_LINEAR_MIPLINEAR;default:return T.a.Warn(`${e}/minFilter: Invalid value (${i})`),Et.a.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){try{return Object(Ut.e)(t)}catch(t){throw new Error(`${e}: ${t.message}`)}}static _GetTypedArray(e,t,n,i,r){const s=n.buffer;i=n.byteOffset+(i||0);const a=hr._GetTypedArrayConstructor(e+"/componentType",t),o=z.b.GetTypeByteLength(t);return i%o!=0?(T.a.Warn(`${e}: Copying buffer as byte offset (${i}) is not a multiple of component type byte length (${o})`),new a(s.slice(i,i+r*o),0)):new a(s,i,r)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return g.b.IsBase64(e)||-1===e.indexOf("..")}static _GetDrawMode(e,t){switch(null==t&&(t=4),t){case 0:return je.PointListDrawMode;case 1:return je.LineListDrawMode;case 2:return je.LineLoopDrawMode;case 3:return je.LineStripDrawMode;case 4:return je.TriangleFillMode;case 5:return je.TriangleStripDrawMode;case 6:return je.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials)for(const t of this._gltf.materials)if(t._data)for(const n in t._data){const i=t._data[n];for(const t of i.babylonMeshes){t.computeWorldMatrix(!0);const n=i.babylonMaterial;e.push(n.forceCompilationAsync(t)),e.push(n.forceCompilationAsync(t,{useInstances:!0})),this._parent.useClipPlane&&(e.push(n.forceCompilationAsync(t,{clipPlane:!0})),e.push(n.forceCompilationAsync(t,{clipPlane:!0,useInstances:!0})))}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const n of t){const t=n.getShadowGenerator();t&&e.push(t.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,n){for(const i of this._extensions)if(i.enabled){const r=`${i.name}.${t}`,s=e;s._activeLoaderExtensionFunctions=s._activeLoaderExtensionFunctions||{};const a=s._activeLoaderExtensionFunctions;if(!a[r]){a[r]=!0;try{const e=n(i);if(e)return e}finally{delete a[r]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",n=>n.loadSceneAsync&&n.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,n){return this._applyExtensions(t,"loadNode",i=>i.loadNodeAsync&&i.loadNodeAsync(e,t,n))}_extensionsLoadCameraAsync(e,t,n){return this._applyExtensions(t,"loadCamera",i=>i.loadCameraAsync&&i.loadCameraAsync(e,t,n))}_extensionsLoadVertexDataAsync(e,t,n){return this._applyExtensions(t,"loadVertexData",i=>i._loadVertexDataAsync&&i._loadVertexDataAsync(e,t,n))}_extensionsLoadMeshPrimitiveAsync(e,t,n,i,r,s){return this._applyExtensions(r,"loadMeshPrimitive",a=>a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,t,n,i,r,s))}_extensionsLoadMaterialAsync(e,t,n,i,r){return this._applyExtensions(t,"loadMaterial",s=>s._loadMaterialAsync&&s._loadMaterialAsync(e,t,n,i,r))}_extensionsCreateMaterial(e,t,n){return this._applyExtensions(t,"createMaterial",i=>i.createMaterial&&i.createMaterial(e,t,n))}_extensionsLoadMaterialPropertiesAsync(e,t,n){return this._applyExtensions(t,"loadMaterialProperties",i=>i.loadMaterialPropertiesAsync&&i.loadMaterialPropertiesAsync(e,t,n))}_extensionsLoadTextureInfoAsync(e,t,n){return this._applyExtensions(t,"loadTextureInfo",i=>i.loadTextureInfoAsync&&i.loadTextureInfoAsync(e,t,n))}_extensionsLoadTextureAsync(e,t,n){return this._applyExtensions(t,"loadTexture",i=>i._loadTextureAsync&&i._loadTextureAsync(e,t,n))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",n=>n.loadAnimationAsync&&n.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,n,i,r){return this._applyExtensions(n,"loadAnimationChannel",s=>s._loadAnimationChannelAsync&&s._loadAnimationChannelAsync(e,t,n,i,r))}_extensionsLoadSkinAsync(e,t,n){return this._applyExtensions(n,"loadSkin",i=>i._loadSkinAsync&&i._loadSkinAsync(e,t,n))}_extensionsLoadUriAsync(e,t,n){return this._applyExtensions(t,"loadUri",i=>i._loadUriAsync&&i._loadUriAsync(e,t,n))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",n=>n.loadBufferViewAsync&&n.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,n,i){return this._applyExtensions(t,"loadBuffer",r=>r.loadBufferAsync&&r.loadBufferAsync(e,t,n,i))}static LoadExtensionAsync(e,t,n,i){if(!t.extensions)return null;const r=t.extensions[n];return r?i(`${e}/extensions/${n}`,r):null}static LoadExtraAsync(e,t,n,i){if(!t.extras)return null;const r=t.extras[n];return r?i(`${e}/extras/${n}`,r):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&-1!==this._gltf.extensionsUsed.indexOf(e)}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}}hr.DefaultSampler={index:-1},yn._CreateGLTF2Loader=e=>new hr(e);var ur=n(331),fr=n(398);class mr extends Mt{update(e,t,n,i,r=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,n,i,r)}updateRGBDAsync(e,t=null,n=.8,i=0){return Object(fr.d)(this._texture,e,t,n,i).then(()=>{})}clone(){return ce.a.Clone(()=>{const e=this.getScene(),t=this._texture,n=new mr(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return 13===t.source&&n.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),n},this)}constructor(e,t,n,i=5,r=0,s=!1,a=!1,o=3,l=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,n,i,r,s,a,o,l)}}const pr="EXT_lights_image_based";class gr{dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return hr.LoadExtensionAsync(e,t,this.name,(n,i)=>{this._loader._allMaterialsDirtyRequired=!0;const r=new Array;r.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(""+n);const s=cr.Get(n+"/light",this._lights,i.light);return r.push(this._loadLightAsync(`/extensions/${this.name}/lights/${i.light}`,s).then(e=>{this._loader.babylonScene.environmentTexture=e})),this._loader.logClose(),Promise.all(r).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){const n=new Array;this._loader.logOpen(""+e);const i=new Array(t.specularImages.length);for(let r=0;r<t.specularImages.length;r++){const s=t.specularImages[r];i[r]=new Array(s.length);for(let t=0;t<s.length;t++){const a=`${e}/specularImages/${r}/${t}`;this._loader.logOpen(""+a);const o=s[t],l=cr.Get(a,this._loader.gltf.images,o);n.push(this._loader.loadImageAsync("/images/"+o,l).then(e=>{i[r][t]=e})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(n).then(()=>{const n=new mr(this._loader.babylonScene,null,t.specularImageSize);if(n.name=t.name||"environment",t._babylonTexture=n,null!=t.intensity&&(n.level=t.intensity),t.rotation){let e=r.b.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(e=r.b.Inverse(e)),r.a.FromQuaternionToRef(e,n.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(e+": Irradiance coefficients are missing");const s=ur.a.FromArray(t.irradianceCoefficients);s.scaleInPlace(t.intensity),s.convertIrradianceToLambertianRadiance();const a=ur.b.FromHarmonics(s),o=(i.length-1)/Math.log2(t.specularImageSize);return n.updateRGBDAsync(i,a,o)})}return t._loaded.then(()=>t._babylonTexture)}constructor(e){this.name=pr,this._loader=e,this.enabled=this._loader.isExtensionUsed(pr)}}lr(pr),or(pr,!0,e=>new gr(e)),en.prototype.thinInstanceAdd=function(e,t=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return T.a.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(e)?e.length:1);const n=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(e))for(let n=0;n<e.length;++n)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,e[n],n===e.length-1&&t);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,e,t);return n},en.prototype.thinInstanceAddSelf=function(e=!0){return this.thinInstanceAdd(r.a.IdentityReadOnly,e)},en.prototype.thinInstanceRegisterAttribute=function(e,t){e===z.b.ColorKind&&(e=z.b.ColorInstanceKind),this.removeVerticesData(e),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[e]=t,this._userThinInstanceBuffersStorage.sizes[e]=t*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[e]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[e]),this._userThinInstanceBuffersStorage.vertexBuffers[e]=new z.b(this.getEngine(),this._userThinInstanceBuffersStorage.data[e],e,!0,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e])},en.prototype.thinInstanceSetMatrixAt=function(e,t,n=!0){if(!this._thinInstanceDataStorage.matrixData||e>=this._thinInstanceDataStorage.instancesCount)return!1;const i=this._thinInstanceDataStorage.matrixData;return t.copyToArray(i,16*e),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[e]=t),n&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0},en.prototype.thinInstanceSetAttributeAt=function(e,t,n,i=!0){return e===z.b.ColorKind&&(e=z.b.ColorInstanceKind),!(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[e]||t>=this._thinInstanceDataStorage.instancesCount||(this._thinInstanceUpdateBufferSize(e,0),this._userThinInstanceBuffersStorage.data[e].set(n,t*this._userThinInstanceBuffersStorage.strides[e]),i&&this.thinInstanceBufferUpdated(e),0))},Object.defineProperty(en.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(e){var t,n;const i=null!==(t=this._thinInstanceDataStorage.matrixData)&&void 0!==t?t:null===(n=this.source)||void 0===n?void 0:n._thinInstanceDataStorage.matrixData;e<=(i?i.length/16:0)&&(this._thinInstanceDataStorage.instancesCount=e)},enumerable:!0,configurable:!0}),en.prototype._thinInstanceCreateMatrixBuffer=function(e,t,n=!0){const i=new z.a(this.getEngine(),t,!n,16,!1,!0);for(let t=0;t<4;t++)this.setVerticesBuffer(i.createVertexBuffer(e+t,4*t,4));return i},en.prototype.thinInstanceSetBuffer=function(e,t,n=0,i=!0){var r;if(n=n||16,"matrix"===e)null===(r=this._thinInstanceDataStorage.matrixBuffer)||void 0===r||r.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=t?t.length:32*n,this._thinInstanceDataStorage.matrixData=t,this._thinInstanceDataStorage.worldMatrices=null,null!==t?(this._thinInstanceDataStorage.instancesCount=t.length/n,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",t,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo());else if("previousMatrix"===e){var s;null===(s=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===s||s.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=t,null!==t&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",t,i))}else{var a;e===z.b.ColorKind&&(e=z.b.ColorInstanceKind),null===t?null!==(a=this._userThinInstanceBuffersStorage)&&void 0!==a&&a.data[e]&&(this.removeVerticesData(e),delete this._userThinInstanceBuffersStorage.data[e],delete this._userThinInstanceBuffersStorage.strides[e],delete this._userThinInstanceBuffersStorage.sizes[e],delete this._userThinInstanceBuffersStorage.vertexBuffers[e]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[e]=t,this._userThinInstanceBuffersStorage.strides[e]=n,this._userThinInstanceBuffersStorage.sizes[e]=t.length,this._userThinInstanceBuffersStorage.vertexBuffers[e]=new z.b(this.getEngine(),t,e,!i,!1,n,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e]))}},en.prototype.thinInstanceBufferUpdated=function(e){var t;if("matrix"===e)this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(e),null===(t=this._thinInstanceDataStorage.matrixBuffer)||void 0===t||t.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount);else if("previousMatrix"===e){var n;this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(e),null===(n=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===n||n.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)}else{var i;e===z.b.ColorKind&&(e=z.b.ColorInstanceKind),null!==(i=this._userThinInstanceBuffersStorage)&&void 0!==i&&i.vertexBuffers[e]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[e].isUpdatable()&&this._thinInstanceRecreateBuffer(e),this._userThinInstanceBuffersStorage.vertexBuffers[e].updateDirectly(this._userThinInstanceBuffersStorage.data[e],0))}},en.prototype.thinInstancePartialBufferUpdate=function(e,t,n){var i;"matrix"===e?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(t,n):(e===z.b.ColorKind&&(e=z.b.ColorInstanceKind),null!==(i=this._userThinInstanceBuffersStorage)&&void 0!==i&&i.vertexBuffers[e]&&this._userThinInstanceBuffersStorage.vertexBuffers[e].updateDirectly(t,n))},en.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const e=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let t=0;t<this._thinInstanceDataStorage.instancesCount;++t)this._thinInstanceDataStorage.worldMatrices[t]=r.a.FromArray(e,16*t)}return this._thinInstanceDataStorage.worldMatrices},en.prototype.thinInstanceRefreshBoundingInfo=function(e=!1,t=!1,n=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const i=this._thinInstanceDataStorage.boundingVectors;if(e||!this.rawBoundingInfo){i.length=0,this.refreshBoundingInfo(t,n);const e=this.getBoundingInfo();this.rawBoundingInfo=new ne(e.minimum,e.maximum)}const s=this.getBoundingInfo(),a=this._thinInstanceDataStorage.matrixData;if(0===i.length)for(let e=0;e<s.boundingBox.vectors.length;++e)i.push(s.boundingBox.vectors[e].clone());r.c.Vector3[0].setAll(Number.POSITIVE_INFINITY),r.c.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e){r.a.FromArrayToRef(a,16*e,r.c.Matrix[0]);for(let e=0;e<i.length;++e)r.e.TransformCoordinatesToRef(i[e],r.c.Matrix[0],r.c.Vector3[2]),r.c.Vector3[0].minimizeInPlace(r.c.Vector3[2]),r.c.Vector3[1].maximizeInPlace(r.c.Vector3[2])}s.reConstruct(r.c.Vector3[0],r.c.Vector3[1]),this._updateBoundingInfo()},en.prototype._thinInstanceRecreateBuffer=function(e,t=!0){var n;if("matrix"===e)null===(n=this._thinInstanceDataStorage.matrixBuffer)||void 0===n||n.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,t);else if("previousMatrix"===e){var i,r;this._scene.needsPreviousWorldMatrices&&(null===(i=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===i||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",null!==(r=this._thinInstanceDataStorage.previousMatrixData)&&void 0!==r?r:this._thinInstanceDataStorage.matrixData,t))}else{var s;e===z.b.ColorKind&&(e=z.b.ColorInstanceKind),null===(s=this._userThinInstanceBuffersStorage.vertexBuffers[e])||void 0===s||s.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[e]=new z.b(this.getEngine(),this._userThinInstanceBuffersStorage.data[e],e,!t,!1,this._userThinInstanceBuffersStorage.strides[e],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e])}},en.prototype._thinInstanceUpdateBufferSize=function(e,t=1){e===z.b.ColorKind&&(e=z.b.ColorInstanceKind);const n="matrix"===e;if(!(n||this._userThinInstanceBuffersStorage&&this._userThinInstanceBuffersStorage.strides[e]))return;const i=n?16:this._userThinInstanceBuffersStorage.strides[e],r=n?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[e];let s=n?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[e];const a=(this._thinInstanceDataStorage.instancesCount+t)*i;let o=r;for(;o<a;)o*=2;if(!s||r!=o){if(s){const e=new Float32Array(o);e.set(s,0),s=e}else s=new Float32Array(o);var l,c,d;n?(null===(l=this._thinInstanceDataStorage.matrixBuffer)||void 0===l||l.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",s,!1),this._thinInstanceDataStorage.matrixData=s,this._thinInstanceDataStorage.matrixBufferSize=o,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(null===(c=this._thinInstanceDataStorage.previousMatrixBuffer)||void 0===c||c.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",s,!1))):(null===(d=this._userThinInstanceBuffersStorage.vertexBuffers[e])||void 0===d||d.dispose(),this._userThinInstanceBuffersStorage.data[e]=s,this._userThinInstanceBuffersStorage.sizes[e]=o,this._userThinInstanceBuffersStorage.vertexBuffers[e]=new z.b(this.getEngine(),s,e,!0,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e]))}},en.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})},en.prototype._disposeThinInstanceSpecificData=function(){var e;null!==(e=this._thinInstanceDataStorage)&&void 0!==e&&e.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};class _r{dispose(){this._loader=null}loadNodeAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(e,i)=>{this._loader._disableInstancedMesh++;const s=this._loader.loadNodeAsync("/nodes/"+t.index,t,n);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return s;const a=new Array;let o=0;const l=t=>{if(null==i.attributes[t])return void a.push(Promise.resolve(null));const n=cr.Get(`${e}/attributes/${t}`,this._loader.gltf.accessors,i.attributes[t]);if(a.push(this._loader._loadFloatAccessorAsync("/accessors/"+n.bufferView,n)),0===o)o=n.count;else if(o!==n.count)throw new Error(e+"/attributes: Instance buffer accessors do not have the same count.")};return l("TRANSLATION"),l("ROTATION"),l("SCALE"),s.then(e=>Promise.all(a).then(([n,i,s])=>{const a=new Float32Array(16*o);r.c.Vector3[0].copyFromFloats(0,0,0),r.c.Quaternion[0].copyFromFloats(0,0,0,1),r.c.Vector3[1].copyFromFloats(1,1,1);for(let e=0;e<o;++e)n&&r.e.FromArrayToRef(n,3*e,r.c.Vector3[0]),i&&r.b.FromArrayToRef(i,4*e,r.c.Quaternion[0]),s&&r.e.FromArrayToRef(s,3*e,r.c.Vector3[1]),r.a.ComposeToRef(r.c.Vector3[1],r.c.Quaternion[0],r.c.Vector3[0],r.c.Matrix[0]),r.c.Matrix[0].copyToArray(a,16*e);for(const e of t._primitiveBabylonMeshes)e.thinInstanceSetBuffer("matrix",a,16,!0);return e}))})}constructor(e){this.name="EXT_mesh_gpu_instancing",this._loader=e,this.enabled=this._loader.isExtensionUsed("EXT_mesh_gpu_instancing")}}lr("EXT_mesh_gpu_instancing"),or("EXT_mesh_gpu_instancing",!0,e=>new _r(e));let vr=0,Er=null;class Tr{static get Default(){return Tr._Default||(Tr._Default=new Tr),Tr._Default}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,n,i,r){return this._decoderModulePromise.then(async()=>{0===vr&&(MeshoptDecoder.useWorkers(1),vr=1);const s=await MeshoptDecoder.decodeGltfBufferAsync(t,n,e,i,r);return null!==Er&&clearTimeout(Er),Er=setTimeout(()=>{MeshoptDecoder.useWorkers(0),vr=0,Er=null},1e3),s})}constructor(){const e=Tr.Configuration.decoder;this._decoderModulePromise=g.b.LoadBabylonScriptAsync(e.url).then(()=>MeshoptDecoder.ready)}}Tr.Configuration={decoder:{url:g.b._DefaultCdnUrl+"/meshopt_decoder.js"}},Tr._Default=null;class Sr{dispose(){this._loader=null}loadBufferViewAsync(e,t){return hr.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=t;if(r._meshOptData)return r._meshOptData;const s=cr.Get(e+"/buffer",this._loader.gltf.buffers,i.buffer);return r._meshOptData=this._loader.loadBufferAsync("/buffers/"+s.index,s,i.byteOffset||0,i.byteLength).then(e=>Tr.Default.decodeGltfBufferAsync(e,i.count,i.byteStride,i.mode,i.filter)),r._meshOptData})}constructor(e){this.name="EXT_meshopt_compression",this.enabled=e.isExtensionUsed("EXT_meshopt_compression"),this._loader=e}}lr("EXT_meshopt_compression"),or("EXT_meshopt_compression",!0,e=>new Sr(e));class Ar{dispose(){this._loader=null}_loadTextureAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=null==t.sampler?hr.DefaultSampler:cr.Get(e+"/sampler",this._loader.gltf.samplers,t.sampler),a=cr.Get(i+"/source",this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,s,a,e=>{n(e)},void 0,!t._textureInfo.nonColorData)})}constructor(e){this.name="EXT_texture_webp",this._loader=e,this.enabled=e.isExtensionUsed("EXT_texture_webp")}}lr("EXT_texture_webp"),or("EXT_texture_webp",!0,e=>new Ar(e));class br{dispose(){this._loader=null}_loadTextureAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=null==t.sampler?hr.DefaultSampler:cr.Get(e+"/sampler",this._loader.gltf.samplers,t.sampler),a=cr.Get(i+"/source",this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,s,a,e=>{n(e)},void 0,!t._textureInfo.nonColorData)})}constructor(e){this.name="EXT_texture_avif",this._loader=e,this.enabled=e.isExtensionUsed("EXT_texture_avif")}}lr("EXT_texture_avif"),or("EXT_texture_avif",!0,e=>new br(e));class Ir{dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,cr.Assign(this._lights)}}loadNodeAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,async(i,s)=>{let a,o;this._loader._allMaterialsDirtyRequired=!0;const l=await this._loader.loadNodeAsync(e,t,e=>{o=cr.Get(i,this._lights,s.light);const t=o.name||e.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,a=new oi(t,r.e.Zero(),r.e.Backward(),0,1,this._loader.babylonScene),a.angle=Math.PI/2,a.innerAngle=0,a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,o._babylonLight=a,a.falloffType=gt.FALLOFF_GLTF,a.diffuse=s.color?he.a.FromArray(s.color):he.a.White(),a.intensity=s.multiplier||1,a.range=Number.MAX_VALUE,a.parent=e,this._loader._babylonLights.push(a),hr.AddPointerMetadata(a,i),n(e)});let c;if(o.uri)c=await this._loader.loadUriAsync(e,o,o.uri);else{const t=cr.Get(e+"/bufferView",this._loader.gltf.bufferViews,o.bufferView);c=await this._loader.loadBufferViewAsync("/bufferViews/"+t.index,t)}return a.iesProfileTexture=new Et.a(name+"_iesProfile",this._loader.babylonScene,!0,!1,void 0,null,null,c,!0,void 0,void 0,void 0,void 0,".ies"),l})}constructor(e){this.name="EXT_lights_ies",this._loader=e,this.enabled=this._loader.isExtensionUsed("EXT_lights_ies")}}lr("EXT_lights_ies"),or("EXT_lights_ies",!0,e=>new Ir(e));var Rr=n(403);function Cr(e,t,n,i,r){const s=e;let a=null,o=null,l=null;try{let e;a=new s.Decoder,o=new s.DecoderBuffer,o.Init(t,t.byteLength);const c=a.GetEncodedGeometryType(o);switch(c){case s.TRIANGULAR_MESH:{const t=new s.Mesh;if(e=a.DecodeBufferToMesh(o,t),!e.ok()||0===t.ptr)throw new Error(e.error_msg());const n=3*t.num_faces(),r=4*n,c=s._malloc(r);try{a.GetTrianglesUInt32Array(t,r,c);const e=new Uint32Array(n);e.set(new Uint32Array(s.HEAPF32.buffer,c,n)),i(e)}finally{s._free(c)}l=t;break}case s.POINT_CLOUD:{const t=new s.PointCloud;if(e=a.DecodeBufferToPointCloud(o,t),!e.ok()||!t.ptr)throw new Error(e.error_msg());l=t;break}default:throw new Error("Invalid geometry type "+c)}const d=l.num_points(),h=(e,t,n,i)=>{const a=i.data_type(),o=i.num_components(),l=i.normalized(),c=i.byte_stride(),h=i.byte_offset(),u={[s.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:s.HEAPF32},[s.DT_INT8]:{typedArrayConstructor:Int8Array,heap:s.HEAP8},[s.DT_INT16]:{typedArrayConstructor:Int16Array,heap:s.HEAP16},[s.DT_INT32]:{typedArrayConstructor:Int32Array,heap:s.HEAP32},[s.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:s.HEAPU8},[s.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:s.HEAPU16},[s.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:s.HEAPU32}}[a];if(!u)throw new Error("Invalid data type "+a);const f=d*o,m=f*u.typedArrayConstructor.BYTES_PER_ELEMENT,p=s._malloc(m);try{e.GetAttributeDataArrayForAllPoints(t,i,a,m,p);const d=new u.typedArrayConstructor(u.heap.buffer,p,f);r(n,d.slice(),o,h,c,l)}finally{s._free(p)}};if(n)for(const e in n){const t=n[e],i=a.GetAttributeByUniqueId(l,t);h(a,l,e,i)}else{const e={position:s.POSITION,normal:s.NORMAL,color:s.COLOR,uv:s.TEX_COORD};for(const t in e){const n=a.GetAttributeId(l,e[t]);if(-1!==n){const e=a.GetAttribute(l,n);h(a,l,t,e)}}}return d}finally{l&&s.destroy(l),o&&s.destroy(o),a&&s.destroy(a)}}function yr(){let e;onmessage=t=>{const n=t.data;switch(n.id){case"init":{n.url&&importScripts(n.url);const t=n.wasmBinary?{wasmBinary:n.wasmBinary}:{};e=DracoDecoderModule(t),postMessage({id:"initDone"});break}case"decodeMesh":if(!e)throw new Error("Draco decoder module is not available");e.then(e=>{const t=Cr(e,n.dataView,n.attributes,e=>{postMessage({id:"indices",data:e},[e.buffer])},(e,t,n,i,r,s)=>{postMessage({id:"attribute",kind:e,data:t,size:n,byteOffset:i,byteStride:r,normalized:s},[t.buffer])});postMessage({id:"decodeMeshDone",totalVertices:t})})}}}class Mr extends class{async whenReadyAsync(){this._workerPoolPromise?await this._workerPoolPromise:this._modulePromise&&await this._modulePromise}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._modulePromise}constructor(e){var t;if(e.workerPool)return void(this._workerPoolPromise=Promise.resolve(e.workerPool));const n=e.wasmBinary,i=null!==(t=e.numWorkers)&&void 0!==t?t:"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1,r=i&&"function"==typeof Worker&&"function"==typeof URL,s=r||!e.jsModule,a=e.wasmUrl&&e.wasmBinaryUrl&&"object"==typeof WebAssembly?{url:s?g.b.GetBabylonScriptURL(e.wasmUrl,!0):"",wasmBinaryPromise:n?Promise.resolve(n):g.b.LoadFileAsync(g.b.GetBabylonScriptURL(e.wasmBinaryUrl,!0))}:{url:s?g.b.GetBabylonScriptURL(e.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};r?this._workerPoolPromise=a.wasmBinaryPromise.then(e=>{const t=this._getWorkerContent(),n=URL.createObjectURL(new Blob([t],{type:"application/javascript"}));return new Rr.a(i,()=>function(e,t,n){return new Promise((i,r)=>{const s=t=>{e.removeEventListener("error",s),e.removeEventListener("message",a),r(t)},a=t=>{"initDone"===t.data.id&&(e.removeEventListener("error",s),e.removeEventListener("message",a),i(e))};if(e.addEventListener("error",s),e.addEventListener("message",a),t){const i=t.slice(0);e.postMessage({id:"init",url:n,wasmBinary:i},[i])}else e.postMessage({id:"init",url:n})})}(new Worker(n),e,a.url))}):this._modulePromise=a.wasmBinaryPromise.then(async t=>{if(!this._isModuleAvailable()&&!e.jsModule){if(!a.url)throw new Error("Draco codec module is not available");await g.b.LoadBabylonScriptAsync(a.url)}return this._createModuleAsync(t,e.jsModule)})}}{static get DefaultAvailable(){return!!((e=Mr.DefaultConfiguration).wasmUrl&&(e.wasmBinary||e.wasmBinaryUrl)&&"object"==typeof WebAssembly||e.fallbackUrl);var e}static get Default(){var e;return null!==(e=Mr._Default)&&void 0!==e||(Mr._Default=new Mr),Mr._Default}static ResetDefault(e){Mr._Default&&(e||Mr._Default.dispose(),Mr._Default=null)}_isModuleAvailable(){return"undefined"!=typeof DracoDecoderModule}async _createModuleAsync(e,t){return{module:await(t||DracoDecoderModule)({wasmBinary:e})}}_getWorkerContent(){return`${Cr}(${yr})()`}decodeMeshToMeshDataAsync(e,t,n){const i=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength);if(this._workerPoolPromise)return this._workerPoolPromise.then(e=>new Promise((r,s)=>{e.push((e,a)=>{let o=null;const l=[],c=t=>{e.removeEventListener("error",c),e.removeEventListener("message",d),s(t),a()},d=t=>{const i=t.data;switch(i.id){case"indices":o=i.data;break;case"attribute":l.push({kind:i.kind,data:i.data,size:i.size,byteOffset:i.byteOffset,byteStride:i.byteStride,normalized:(s=i.kind,h=i.normalized,n&&void 0!==n[s]?(h!==n[s]&&T.a.Warn(`Normalized flag from Draco data (${h}) does not match normalized flag from glTF accessor (${n[s]}). Using flag from glTF accessor.`),n[s]):h)});break;case"decodeMeshDone":e.removeEventListener("error",c),e.removeEventListener("message",d),r({indices:o,attributes:l,totalVertices:i.totalVertices}),a()}var s,h};e.addEventListener("error",c),e.addEventListener("message",d);const h=i.slice();e.postMessage({id:"decodeMesh",dataView:h,attributes:t},[h.buffer])})}));if(this._modulePromise)return this._modulePromise.then(e=>{let n=null;const r=[],s=Cr(e.module,i,t,e=>{n=e},(e,t,n,i,s,a)=>{r.push({kind:e,data:t,size:n,byteOffset:i,byteStride:s,normalized:a})});return{indices:n,attributes:r,totalVertices:s}});throw new Error("Draco decoder module is not available")}async decodeMeshToGeometryAsync(e,t,n,i){const r=await this.decodeMeshToMeshDataAsync(n,i),s=new Bt(e,t);r.indices&&s.setIndices(r.indices);for(const e of r.attributes)s.setVerticesBuffer(new z.b(t.getEngine(),e.data,e.kind,!1,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,!0),r.totalVertices);return s}async _decodeMeshToGeometryForGltfAsync(e,t,n,i,r,s){const a=await this.decodeMeshToMeshDataAsync(n,i,r),o=new Bt(e,t);s&&(o._boundingInfo=s,o.useBoundingInfoFromGeometry=!0),a.indices&&o.setIndices(a.indices);for(const e of a.attributes)o.setVerticesBuffer(new z.b(t.getEngine(),e.data,e.kind,!1,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,!0),a.totalVertices);return o}constructor(e=Mr.DefaultConfiguration){super(e)}}Mr.DefaultConfiguration={wasmUrl:g.b._DefaultCdnUrl+"/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:g.b._DefaultCdnUrl+"/draco_decoder_gltf.wasm",fallbackUrl:g.b._DefaultCdnUrl+"/draco_decoder_gltf.js"},Mr._Default=null;class Or{dispose(){delete this.dracoDecoder,this._loader=null}_loadVertexDataAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{if(null!=t.mode&&4!==t.mode&&5!==t.mode)throw new Error(`${e}: Unsupported mode ${t.mode}`);const s={},a={},o=(e,i)=>{const o=r.attributes[e];if(null!=o&&(n._delayInfo=n._delayInfo||[],-1===n._delayInfo.indexOf(i)&&n._delayInfo.push(i),s[i]=o,this.useNormalizedFlagFromAccessor)){const n=cr.TryGet(this._loader.gltf.accessors,t.attributes[e]);n&&(a[i]=n.normalized||!1)}};o("POSITION",z.b.PositionKind),o("NORMAL",z.b.NormalKind),o("TANGENT",z.b.TangentKind),o("TEXCOORD_0",z.b.UVKind),o("TEXCOORD_1",z.b.UV2Kind),o("TEXCOORD_2",z.b.UV3Kind),o("TEXCOORD_3",z.b.UV4Kind),o("TEXCOORD_4",z.b.UV5Kind),o("TEXCOORD_5",z.b.UV6Kind),o("JOINTS_0",z.b.MatricesIndicesKind),o("WEIGHTS_0",z.b.MatricesWeightsKind),o("COLOR_0",z.b.ColorKind);const l=cr.Get(i,this._loader.gltf.bufferViews,r.bufferView);return l._dracoBabylonGeometry||(l._dracoBabylonGeometry=this._loader.loadBufferViewAsync("/bufferViews/"+l.index,l).then(i=>{const r=this.dracoDecoder||Mr.Default,o=cr.TryGet(this._loader.gltf.accessors,t.attributes.POSITION),l=this._loader.parent.alwaysComputeBoundingBox||n.skeleton||!o?null:dr(o);return r._decodeMeshToGeometryForGltfAsync(n.name,this._loader.babylonScene,i,s,a,l).catch(t=>{throw new Error(`${e}: ${t.message}`)})})),l._dracoBabylonGeometry})}constructor(e){this.name="KHR_draco_mesh_compression",this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=Mr.DefaultAvailable&&this._loader.isExtensionUsed("KHR_draco_mesh_compression")}}lr("KHR_draco_mesh_compression"),or("KHR_draco_mesh_compression",!0,e=>new Or(e));class xr{dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,cr.Assign(this._lights)}}loadNodeAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,s)=>(this._loader._allMaterialsDirtyRequired=!0,this._loader.loadNodeAsync(e,t,e=>{let t;const a=cr.Get(i,this._lights,s.light),o=a.name||e.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,a.type){case"directional":{const e=new ai(o,r.e.Backward(),this._loader.babylonScene);e.position.setAll(0),t=e;break}case"point":t=new vt(o,r.e.Zero(),this._loader.babylonScene);break;case"spot":{const e=new oi(o,r.e.Zero(),r.e.Backward(),0,1,this._loader.babylonScene);e.angle=2*(a.spot&&a.spot.outerConeAngle||Math.PI/4),e.innerAngle=2*(a.spot&&a.spot.innerConeAngle||0),t=e;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${i}: Invalid light type (${a.type})`)}t._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,a._babylonLight=t,t.falloffType=gt.FALLOFF_GLTF,t.diffuse=a.color?he.a.FromArray(a.color):he.a.White(),t.intensity=null==a.intensity?1:a.intensity,t.range=null==a.range?Number.MAX_VALUE:a.range,t.parent=e,this._loader._babylonLights.push(t),hr.AddPointerMetadata(t,i),n(e)})))}constructor(e){this.name="KHR_lights_punctual",this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_lights_punctual")}}lr("KHR_lights_punctual"),or("KHR_lights_punctual",!0,e=>new xr(e));class Dr{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;return s.push(this._loader.loadMaterialBasePropertiesAsync(e,t,n)),s.push(this._loadSpecularGlossinessPropertiesAsync(i,r,n)),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(s).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,n){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");const i=new Array;return n.metallic=null,n.roughness=null,t.diffuseFactor?(n.albedoColor=he.a.FromArray(t.diffuseFactor),n.alpha=t.diffuseFactor[3]):n.albedoColor=he.a.White(),n.reflectivityColor=t.specularFactor?he.a.FromArray(t.specularFactor):he.a.White(),n.microSurface=null==t.glossinessFactor?1:t.glossinessFactor,t.diffuseTexture&&i.push(this._loader.loadTextureInfoAsync(e+"/diffuseTexture",t.diffuseTexture,e=>{e.name=n.name+" (Diffuse)",n.albedoTexture=e})),t.specularGlossinessTexture&&(i.push(this._loader.loadTextureInfoAsync(e+"/specularGlossinessTexture",t.specularGlossinessTexture,e=>{e.name=n.name+" (Specular Glossiness)",n.reflectivityTexture=e,n.reflectivityTexture.hasAlpha=!0})),n.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(i).then(()=>{})}constructor(e){this.name="KHR_materials_pbrSpecularGlossiness",this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_pbrSpecularGlossiness")}}lr("KHR_materials_pbrSpecularGlossiness"),or("KHR_materials_pbrSpecularGlossiness",!0,e=>new Dr(e));class Pr{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,()=>this._loadUnlitPropertiesAsync(e,t,n))}_loadUnlitPropertiesAsync(e,t,n){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");const i=new Array;n.unlit=!0;const r=t.pbrMetallicRoughness;return r&&(r.baseColorFactor?(n.albedoColor=he.a.FromArray(r.baseColorFactor),n.alpha=r.baseColorFactor[3]):n.albedoColor=he.a.White(),r.baseColorTexture&&i.push(this._loader.loadTextureInfoAsync(e+"/baseColorTexture",r.baseColorTexture,e=>{e.name=n.name+" (Base Color)",n.albedoTexture=e}))),t.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(i).then(()=>{})}constructor(e){this.name="KHR_materials_unlit",this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_unlit")}}lr("KHR_materials_unlit"),or("KHR_materials_unlit",!0,e=>new Pr(e));class Lr{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadClearCoatPropertiesAsync(i,r,n)),Promise.all(s).then(()=>{})})}_loadClearCoatPropertiesAsync(e,t,n){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");const i=new Array;return n.clearCoat.isEnabled=!0,n.clearCoat.useRoughnessFromMainTexture=!1,n.clearCoat.remapF0OnInterfaceChange=!1,null!=t.clearcoatFactor?n.clearCoat.intensity=t.clearcoatFactor:n.clearCoat.intensity=0,t.clearcoatTexture&&i.push(this._loader.loadTextureInfoAsync(e+"/clearcoatTexture",t.clearcoatTexture,e=>{e.name=n.name+" (ClearCoat)",n.clearCoat.texture=e})),null!=t.clearcoatRoughnessFactor?n.clearCoat.roughness=t.clearcoatRoughnessFactor:n.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync(e+"/clearcoatRoughnessTexture",t.clearcoatRoughnessTexture,e=>{e.name=n.name+" (ClearCoat Roughness)",n.clearCoat.textureRoughness=e}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync(e+"/clearcoatNormalTexture",t.clearcoatNormalTexture,e=>{e.name=n.name+" (ClearCoat Normal)",n.clearCoat.bumpTexture=e})),n.invertNormalMapX=!n.getScene().useRightHandedSystem,n.invertNormalMapY=n.getScene().useRightHandedSystem,null!=t.clearcoatNormalTexture.scale&&(n.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(i).then(()=>{})}constructor(e){this.name="KHR_materials_clearcoat",this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_clearcoat")}}lr("KHR_materials_clearcoat"),or("KHR_materials_clearcoat",!0,e=>new Lr(e));class Nr{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadIridescencePropertiesAsync(i,r,n)),Promise.all(s).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,n){var i,r,s,a,o;if(!(n instanceof Zi))throw new Error(e+": Material type not supported");const l=new Array;return n.iridescence.isEnabled=!0,n.iridescence.intensity=null!==(i=t.iridescenceFactor)&&void 0!==i?i:0,n.iridescence.indexOfRefraction=null!==(r=null!==(s=t.iridescenceIor)&&void 0!==s?s:t.iridescenceIOR)&&void 0!==r?r:1.3,n.iridescence.minimumThickness=null!==(a=t.iridescenceThicknessMinimum)&&void 0!==a?a:100,n.iridescence.maximumThickness=null!==(o=t.iridescenceThicknessMaximum)&&void 0!==o?o:400,t.iridescenceTexture&&l.push(this._loader.loadTextureInfoAsync(e+"/iridescenceTexture",t.iridescenceTexture,e=>{e.name=n.name+" (Iridescence)",n.iridescence.texture=e})),t.iridescenceThicknessTexture&&l.push(this._loader.loadTextureInfoAsync(e+"/iridescenceThicknessTexture",t.iridescenceThicknessTexture,e=>{e.name=n.name+" (Iridescence Thickness)",n.iridescence.thicknessTexture=e})),Promise.all(l).then(()=>{})}constructor(e){this.name="KHR_materials_iridescence",this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_iridescence")}}lr("KHR_materials_iridescence"),or("KHR_materials_iridescence",!0,e=>new Nr(e));class Fr{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadIridescencePropertiesAsync(i,r,n)),Promise.all(s).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,n){var i,r;if(!(n instanceof Zi))throw new Error(e+": Material type not supported");const s=new Array;return n.anisotropy.isEnabled=!0,n.anisotropy.intensity=null!==(i=t.anisotropyStrength)&&void 0!==i?i:0,n.anisotropy.angle=null!==(r=t.anisotropyRotation)&&void 0!==r?r:0,t.anisotropyTexture&&(t.anisotropyTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(e+"/anisotropyTexture",t.anisotropyTexture,e=>{e.name=n.name+" (Anisotropy Intensity)",n.anisotropy.texture=e}))),Promise.all(s).then(()=>{})}constructor(e){this.name="KHR_materials_anisotropy",this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_anisotropy")}}lr("KHR_materials_anisotropy"),or("KHR_materials_anisotropy",!0,e=>new Fr(e));class wr{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>this._loader.loadMaterialPropertiesAsync(e,t,n).then(()=>{this._loadEmissiveProperties(i,r,n)}))}_loadEmissiveProperties(e,t,n){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");void 0!==t.emissiveStrength&&(n.emissiveIntensity=t.emissiveStrength)}constructor(e){this.name="KHR_materials_emissive_strength",this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_emissive_strength")}}lr("KHR_materials_emissive_strength"),or("KHR_materials_emissive_strength",!0,e=>new wr(e));class Ur{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadSheenPropertiesAsync(i,r,n)),Promise.all(s).then(()=>{})})}_loadSheenPropertiesAsync(e,t,n){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");const i=new Array;return n.sheen.isEnabled=!0,n.sheen.intensity=1,null!=t.sheenColorFactor?n.sheen.color=he.a.FromArray(t.sheenColorFactor):n.sheen.color=he.a.Black(),t.sheenColorTexture&&i.push(this._loader.loadTextureInfoAsync(e+"/sheenColorTexture",t.sheenColorTexture,e=>{e.name=n.name+" (Sheen Color)",n.sheen.texture=e})),void 0!==t.sheenRoughnessFactor?n.sheen.roughness=t.sheenRoughnessFactor:n.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync(e+"/sheenRoughnessTexture",t.sheenRoughnessTexture,e=>{e.name=n.name+" (Sheen Roughness)",n.sheen.textureRoughness=e}))),n.sheen.albedoScaling=!0,n.sheen.useRoughnessFromMainTexture=!1,Promise.all(i).then(()=>{})}constructor(e){this.name="KHR_materials_sheen",this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_sheen")}}lr("KHR_materials_sheen"),or("KHR_materials_sheen",!0,e=>new Ur(e));class Br{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadSpecularPropertiesAsync(i,r,n)),Promise.all(s).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,n){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");const i=new Array;return void 0!==t.specularFactor&&(n.metallicF0Factor=t.specularFactor),void 0!==t.specularColorFactor&&(n.metallicReflectanceColor=he.a.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync(e+"/specularTexture",t.specularTexture,e=>{e.name=n.name+" (Specular)",n.metallicReflectanceTexture=e,n.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),t.specularColorTexture&&i.push(this._loader.loadTextureInfoAsync(e+"/specularColorTexture",t.specularColorTexture,e=>{e.name=n.name+" (Specular Color)",n.reflectanceTexture=e})),Promise.all(i).then(()=>{})}constructor(e){this.name="KHR_materials_specular",this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_specular")}}lr("KHR_materials_specular"),or("KHR_materials_specular",!0,e=>new Br(e));class kr{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadIorPropertiesAsync(i,r,n)),Promise.all(s).then(()=>{})})}_loadIorPropertiesAsync(e,t,n){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");return void 0!==t.ior?n.indexOfRefraction=t.ior:n.indexOfRefraction=kr._DEFAULT_IOR,Promise.resolve()}constructor(e){this.name="KHR_materials_ior",this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_ior")}}kr._DEFAULT_IOR=1.5,lr("KHR_materials_ior"),or("KHR_materials_ior",!0,e=>new kr(e));class Vr{dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return Vr.GetAvailableVariants(e)}static SelectVariant(e,t){const n=this._GetExtensionMetadata(e);if(!n)throw new Error("Cannot select variant on a glTF mesh that does not have the KHR_materials_variants extension");const i=e=>{const t=n.variants[e];if(t)for(const e of t)e.mesh.material=e.material};if(t instanceof Array)for(const e of t)i(e);else i(t);n.lastSelected=t}selectVariant(e,t){Vr.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error("Cannot reset on a glTF mesh that does not have the KHR_materials_variants extension");for(const e of t.original)e.mesh.material=e.material;t.lastSelected=null}reset(e){Vr.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error("Cannot get the last selected variant on a glTF mesh that does not have the KHR_materials_variants extension");return t.lastSelected}getLastSelectedVariant(e){return Vr.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t;return(null==e||null===(t=e._internalMetadata)||void 0===t||null===(t=t.gltf)||void 0===t?void 0:t.KHR_materials_variants)||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}onReady(){const e=this._loader.rootBabylonMesh;var t,n;e&&(null===(t=this._loader.parent.extensionOptions.KHR_materials_variants)||void 0===t||null===(n=t.onLoaded)||void 0===n||n.call(t,{get variants(){return Vr.GetAvailableVariants(e)},get selectedVariant(){const t=Vr.GetLastSelectedVariant(e);return t?Array.isArray(t)?t[0]:t:Vr.GetAvailableVariants(e)[0]},set selectedVariant(t){Vr.SelectVariant(e,t)}}))}_loadMeshPrimitiveAsync(e,t,n,i,r,s){return hr.LoadExtensionAsync(e,r,this.name,(a,o)=>{const l=new Array;return l.push(this._loader._loadMeshPrimitiveAsync(e,t,n,i,r,t=>{if(s(t),t instanceof en){const n=hr._GetDrawMode(e,r.mode),i=this._loader.rootBabylonMesh,s=i?i._internalMetadata=i._internalMetadata||{}:{},c=s.gltf=s.gltf||{},d=c.KHR_materials_variants=c.KHR_materials_variants||{lastSelected:null,original:[],variants:{}};d.original.push({mesh:t,material:t.material});for(let e=0;e<o.mappings.length;++e){const r=o.mappings[e],s=cr.Get(`${a}/mappings/${e}/material`,this._loader.gltf.materials,r.material);l.push(this._loader._loadMaterialAsync("#/materials/"+r.material,s,t,n,e=>{for(let n=0;n<r.variants.length;++n){const s=r.variants[n],a=cr.Get("/extensions/KHR_materials_variants/variants/"+s,this._variants,s);d.variants[a.name]=d.variants[a.name]||[],d.variants[a.name].push({mesh:t,material:e}),t.onClonedObservable.add(e=>{const n=e;let r=null,s=n;do{if(s=s.parent,!s)return;r=Vr._GetExtensionMetadata(s)}while(null===r);if(i&&r===Vr._GetExtensionMetadata(i)){s._internalMetadata={};for(const e in i._internalMetadata)s._internalMetadata[e]=i._internalMetadata[e];s._internalMetadata.gltf=[];for(const e in i._internalMetadata.gltf)s._internalMetadata.gltf[e]=i._internalMetadata.gltf[e];s._internalMetadata.gltf.KHR_materials_variants={lastSelected:null,original:[],variants:{}};for(const e of r.original)s._internalMetadata.gltf.KHR_materials_variants.original.push({mesh:e.mesh,material:e.material});for(const e in r.variants)if(Object.prototype.hasOwnProperty.call(r.variants,e)){s._internalMetadata.gltf.KHR_materials_variants.variants[e]=[];for(const t of r.variants[e])s._internalMetadata.gltf.KHR_materials_variants.variants[e].push({mesh:t.mesh,material:t.material})}r=s._internalMetadata.gltf.KHR_materials_variants}for(const e of r.original)e.mesh===t&&(e.mesh=n);for(const e of r.variants[a.name])e.mesh===t&&(e.mesh=n)})}}))}}})),Promise.all(l).then(([e])=>e)})}constructor(e){this.name="KHR_materials_variants",this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_variants")}}lr("KHR_materials_variants"),or("KHR_materials_variants",!0,e=>new Vr(e));class Gr{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:ci.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}updateOptions(e){if(!Object.keys(e).filter(t=>this._options[t]!==e[t]).length)return;const t={...this._options,...e},n=this._options;this._options=t,t.renderSize===n.renderSize&&t.renderTargetTextureType===n.renderTargetTextureType&&t.generateMipmaps===n.generateMipmaps&&this._opaqueRenderTarget?(this._opaqueRenderTarget.samples=t.samples,this._opaqueRenderTarget.lodGenerationScale=t.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=t.lodGenerationOffset):this._setupRenderTargets()}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return!!e&&!!(e instanceof Zi&&e.subSurface.isRefractionEnabled)}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),g.b.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,-1===this._transparentMeshesCache.indexOf(e)&&this._transparentMeshesCache.push(e)):-1===this._opaqueMeshesCache.indexOf(e)&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);-1!==t&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),-1!==t&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),n=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof Zi&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),-1!==n?(this._opaqueMeshesCache.splice(n,1),this._transparentMeshesCache.push(e)):-1===t&&this._transparentMeshesCache.push(e)):-1!==t?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):-1===n&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){var e;return null!==(null===(e=this._opaqueRenderTarget)||void 0===e?void 0:e.getInternalTexture())}_setupRenderTargets(){var e,t;let n,r;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new i.a("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=null!==(e=null===(t=this._options.clearColor)||void 0===t?void 0:t.clone())&&void 0!==e?e:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0,this._opaqueRenderTarget.onBeforeBindObservable.add(e=>{r=this._scene.environmentIntensity,this._scene.environmentIntensity=1,n=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?e.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(e.clearColor,this._scene.getEngine().useExactSrgbConversions),this._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=r,this._scene.imageProcessingConfiguration._applyByPostProcess=n}),this._transparentMeshesCache.forEach(e=>{this._shouldRenderAsTransmission(e.material)&&(e.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...Gr._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new _.a,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}}class Hr{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadTransparentPropertiesAsync(i,t,n,r)),Promise.all(s).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,n,i){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");const r=n;if(r.subSurface.isRefractionEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.useAlbedoToTintRefraction=!0,void 0===i.transmissionFactor)return r.subSurface.refractionIntensity=0,r.subSurface.isRefractionEnabled=!1,Promise.resolve();{var s;r.subSurface.refractionIntensity=i.transmissionFactor;const e=r.getScene();if(r.subSurface.refractionIntensity&&!e._transmissionHelper)new Gr({},r.getScene());else if(r.subSurface.refractionIntensity&&(null===(s=e._transmissionHelper)||void 0===s||!s._isRenderTargetValid())){var a;null===(a=e._transmissionHelper)||void 0===a||a._setupRenderTargets()}}return r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,i.transmissionTexture?(i.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(e+"/transmissionTexture",i.transmissionTexture,void 0).then(e=>{e.name=n.name+" (Transmission)",r.subSurface.refractionIntensityTexture=e,r.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}constructor(e){this.name="KHR_materials_transmission",this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_transmission"),this.enabled&&(e.parent.transparencyAsCoverage=!0)}}lr("KHR_materials_transmission"),or("KHR_materials_transmission",!0,e=>new Hr(e));class Wr{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadTranslucentPropertiesAsync(i,t,n,r)),Promise.all(s).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,n,i){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");const r=n;if(r.subSurface.isTranslucencyEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,r.subSurface.useAlbedoToTintTranslucency=!1,void 0===i.diffuseTransmissionFactor)return r.subSurface.translucencyIntensity=0,r.subSurface.isTranslucencyEnabled=!1,Promise.resolve();r.subSurface.translucencyIntensity=i.diffuseTransmissionFactor;const s=new Array;return r.subSurface.useGltfStyleTextures=!0,i.diffuseTransmissionTexture&&(i.diffuseTransmissionTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(e+"/diffuseTransmissionTexture",i.diffuseTransmissionTexture).then(e=>{e.name=n.name+" (Diffuse Transmission)",r.subSurface.translucencyIntensityTexture=e}))),void 0!==i.diffuseTransmissionColorFactor?r.subSurface.translucencyColor=he.a.FromArray(i.diffuseTransmissionColorFactor):r.subSurface.translucencyColor=he.a.White(),i.diffuseTransmissionColorTexture&&s.push(this._loader.loadTextureInfoAsync(e+"/diffuseTransmissionColorTexture",i.diffuseTransmissionColorTexture).then(e=>{e.name=n.name+" (Diffuse Transmission Color)",r.subSurface.translucencyColorTexture=e})),Promise.all(s).then(()=>{})}constructor(e){this.name="KHR_materials_diffuse_transmission",this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_diffuse_transmission"),this.enabled&&(e.parent.transparencyAsCoverage=!0)}}lr("KHR_materials_diffuse_transmission"),or("KHR_materials_diffuse_transmission",!0,e=>new Wr(e));class Xr{dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadVolumePropertiesAsync(i,t,n,r)),Promise.all(s).then(()=>{})})}_loadVolumePropertiesAsync(e,t,n,i){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");if(!n.subSurface.isRefractionEnabled&&!n.subSurface.isTranslucencyEnabled||!i.thicknessFactor)return Promise.resolve();n.subSurface.volumeIndexOfRefraction=n.indexOfRefraction;const r=void 0!==i.attenuationDistance?i.attenuationDistance:Number.MAX_VALUE;return n.subSurface.tintColorAtDistance=r,void 0!==i.attenuationColor&&3==i.attenuationColor.length&&n.subSurface.tintColor.copyFromFloats(i.attenuationColor[0],i.attenuationColor[1],i.attenuationColor[2]),n.subSurface.minimumThickness=0,n.subSurface.maximumThickness=i.thicknessFactor,n.subSurface.useThicknessAsDepth=!0,i.thicknessTexture?(i.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(e+"/thicknessTexture",i.thicknessTexture).then(e=>{e.name=n.name+" (Thickness)",n.subSurface.thicknessTexture=e,n.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}constructor(e){this.name="KHR_materials_volume",this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_volume"),this.enabled&&this._loader._disableInstancedMesh++}}lr("KHR_materials_volume"),or("KHR_materials_volume",!0,e=>new Xr(e));class jr{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=new Array;return s.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),s.push(this._loadDispersionPropertiesAsync(i,t,n,r)),Promise.all(s).then(()=>{})})}_loadDispersionPropertiesAsync(e,t,n,i){if(!(n instanceof Zi))throw new Error(e+": Material type not supported");return n.subSurface.isRefractionEnabled&&i.dispersion?(n.subSurface.isDispersionEnabled=!0,n.subSurface.dispersion=i.dispersion,Promise.resolve()):Promise.resolve()}constructor(e){this.name="KHR_materials_dispersion",this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_materials_dispersion")}}lr("KHR_materials_dispersion"),or("KHR_materials_dispersion",!0,e=>new jr(e));class zr{dispose(){}constructor(e){this.name="KHR_mesh_quantization",this.enabled=e.isExtensionUsed("KHR_mesh_quantization")}}lr("KHR_mesh_quantization"),or("KHR_mesh_quantization",!0,e=>new zr(e));class Kr{dispose(){this._loader=null}_loadTextureAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>{const s=null==t.sampler?hr.DefaultSampler:cr.Get(e+"/sampler",this._loader.gltf.samplers,t.sampler),a=cr.Get(i+"/source",this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,s,a,e=>{n(e)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}constructor(e){this.name="KHR_texture_basisu",this._loader=e,this.enabled=e.isExtensionUsed("KHR_texture_basisu")}}lr("KHR_texture_basisu"),or("KHR_texture_basisu",!0,e=>new Kr(e));class Yr{dispose(){this._loader=null}loadTextureInfoAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(i,r)=>this._loader.loadTextureInfoAsync(e,t,e=>{if(!(e instanceof Et.a))throw new Error(i+": Texture type not supported");r.offset&&(e.uOffset=r.offset[0],e.vOffset=r.offset[1]),e.uRotationCenter=0,e.vRotationCenter=0,r.rotation&&(e.wAng=-r.rotation),r.scale&&(e.uScale=r.scale[0],e.vScale=r.scale[1]),null!=r.texCoord&&(e.coordinatesIndex=r.texCoord),n(e)}))}constructor(e){this.name="KHR_texture_transform",this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_texture_transform")}}lr("KHR_texture_transform"),or("KHR_texture_transform",!0,e=>new Yr(e));class qr{dispose(){this._loader=null}onLoading(){var e,t;if(null===this._loader.rootBabylonMesh)return;const n=null===(e=this._loader.gltf.extensions)||void 0===e?void 0:e.KHR_xmp_json_ld,i=null===(t=this._loader.gltf.asset)||void 0===t||null===(t=t.extensions)||void 0===t?void 0:t.KHR_xmp_json_ld;if(n&&i){const e=+i.packet;n.packets&&e<n.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=n.packets[e])}}constructor(e){this.name="KHR_xmp_json_ld",this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed("KHR_xmp_json_ld")}}function Qr(e,t,n,i){return he.a.FromArray(t,n).scale(i)}function Zr(e,t,n,i){return t[n]*i}function $r(e,t,n,i){return-t[n]*i}function Jr(e,t,n,i){return t[n+1]*i}function es(e,t,n,i){return t[n]*i*2}function ts(e){return{scale:[new is(Vn.a.ANIMATIONTYPE_FLOAT,e+".uScale",Zr,()=>2),new is(Vn.a.ANIMATIONTYPE_FLOAT,e+".vScale",Jr,()=>2)],offset:[new is(Vn.a.ANIMATIONTYPE_FLOAT,e+".uOffset",Zr,()=>2),new is(Vn.a.ANIMATIONTYPE_FLOAT,e+".vOffset",Jr,()=>2)],rotation:[new is(Vn.a.ANIMATIONTYPE_FLOAT,e+".wAng",$r,()=>1)]}}lr("KHR_xmp_json_ld"),or("KHR_xmp_json_ld",!0,e=>new qr(e));class ns extends nr{buildAnimations(e,t,n,i,r){r(e._babylonCamera,this._buildAnimation(t,n,i))}}class is extends nr{buildAnimations(e,t,n,i,r){for(const s in e._data)r(e._data[s].babylonMaterial,this._buildAnimation(t,n,i))}}class rs extends nr{buildAnimations(e,t,n,i,r){r(e._babylonLight,this._buildAnimation(t,n,i))}}const ss={__array__:{__target__:!0,...rr}},as={__array__:{__target__:!0,orthographic:{xmag:[new ns(Vn.a.ANIMATIONTYPE_FLOAT,"orthoLeft",$r,()=>1),new ns(Vn.a.ANIMATIONTYPE_FLOAT,"orthoRight",Jr,()=>1)],ymag:[new ns(Vn.a.ANIMATIONTYPE_FLOAT,"orthoBottom",$r,()=>1),new ns(Vn.a.ANIMATIONTYPE_FLOAT,"orthoTop",Jr,()=>1)],zfar:[new ns(Vn.a.ANIMATIONTYPE_FLOAT,"maxZ",Zr,()=>1)],znear:[new ns(Vn.a.ANIMATIONTYPE_FLOAT,"minZ",Zr,()=>1)]},perspective:{yfov:[new ns(Vn.a.ANIMATIONTYPE_FLOAT,"fov",Zr,()=>1)],zfar:[new ns(Vn.a.ANIMATIONTYPE_FLOAT,"maxZ",Zr,()=>1)],znear:[new ns(Vn.a.ANIMATIONTYPE_FLOAT,"minZ",Zr,()=>1)]}}},os={nodes:ss,materials:{__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new is(Vn.a.ANIMATIONTYPE_COLOR3,"albedoColor",Qr,()=>4),new is(Vn.a.ANIMATIONTYPE_FLOAT,"alpha",(function(e,t,n,i){return t[n+3]*i}),()=>4)],metallicFactor:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"metallic",Zr,()=>1)],roughnessFactor:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"roughness",Zr,()=>1)],baseColorTexture:{extensions:{KHR_texture_transform:ts("albedoTexture")}},metallicRoughnessTexture:{extensions:{KHR_texture_transform:ts("metallicTexture")}}},emissiveFactor:[new is(Vn.a.ANIMATIONTYPE_COLOR3,"emissiveColor",Qr,()=>3)],normalTexture:{scale:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"bumpTexture.level",Zr,()=>1)],extensions:{KHR_texture_transform:ts("bumpTexture")}},occlusionTexture:{strength:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",Zr,()=>1)],extensions:{KHR_texture_transform:ts("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:ts("emissiveTexture")}},extensions:{KHR_materials_anisotropy:{anisotropyStrength:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",Zr,()=>1)],anisotropyRotation:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"anisotropy.angle",Zr,()=>1)],anisotropyTexture:{extensions:{KHR_texture_transform:ts("anisotropy.texture")}}},KHR_materials_clearcoat:{clearcoatFactor:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",Zr,()=>1)],clearcoatRoughnessFactor:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",Zr,()=>1)],clearcoatTexture:{extensions:{KHR_texture_transform:ts("clearCoat.texture")}},clearcoatNormalTexture:{scale:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"clearCoat.bumpTexture.level",Zr,()=>1)],extensions:{KHR_texture_transform:ts("clearCoat.bumpTexture")}},clearcoatRoughnessTexture:{extensions:{KHR_texture_transform:ts("clearCoat.textureRoughness")}}},KHR_materials_dispersion:{dispersion:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",Zr,()=>1)]},KHR_materials_emissive_strength:{emissiveStrength:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"emissiveIntensity",Zr,()=>1)]},KHR_materials_ior:{ior:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"indexOfRefraction",Zr,()=>1)]},KHR_materials_iridescence:{iridescenceFactor:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"iridescence.intensity",Zr,()=>1)],iridescenceIor:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",Zr,()=>1)],iridescenceThicknessMinimum:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",Zr,()=>1)],iridescenceThicknessMaximum:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",Zr,()=>1)],iridescenceTexture:{extensions:{KHR_texture_transform:ts("iridescence.texture")}},iridescenceThicknessTexture:{extensions:{KHR_texture_transform:ts("iridescence.thicknessTexture")}}},KHR_materials_sheen:{sheenColorFactor:[new is(Vn.a.ANIMATIONTYPE_COLOR3,"sheen.color",Qr,()=>3)],sheenRoughnessFactor:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"sheen.roughness",Zr,()=>1)],sheenColorTexture:{extensions:{KHR_texture_transform:ts("sheen.texture")}},sheenRoughnessTexture:{extensions:{KHR_texture_transform:ts("sheen.textureRoughness")}}},KHR_materials_specular:{specularFactor:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"metallicF0Factor",Zr,()=>1)],specularColorFactor:[new is(Vn.a.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",Qr,()=>3)],specularTexture:{extensions:{KHR_texture_transform:ts("metallicReflectanceTexture")}},specularColorTexture:{extensions:{KHR_texture_transform:ts("reflectanceTexture")}}},KHR_materials_transmission:{transmissionFactor:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",Zr,()=>1)],transmissionTexture:{extensions:{KHR_texture_transform:ts("subSurface.refractionIntensityTexture")}}},KHR_materials_volume:{attenuationColor:[new is(Vn.a.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",Qr,()=>3)],attenuationDistance:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",Zr,()=>1)],thicknessFactor:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",Zr,()=>1)],thicknessTexture:{extensions:{KHR_texture_transform:ts("subSurface.thicknessTexture")}}},KHR_materials_diffuse_transmission:{diffuseTransmissionFactor:[new is(Vn.a.ANIMATIONTYPE_FLOAT,"subSurface.translucencyIntensity",Zr,()=>1)],diffuseTransmissionTexture:{extensions:{KHR_texture_transform:ts("subSurface.translucencyIntensityTexture")}},diffuseTransmissionColorFactor:[new is(Vn.a.ANIMATIONTYPE_COLOR3,"subSurface.translucencyColor",Qr,()=>3)],diffuseTransmissionColorTexture:{extensions:{KHR_texture_transform:ts("subSurface.translucencyColorTexture")}}}}}},cameras:as,extensions:{KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new rs(Vn.a.ANIMATIONTYPE_COLOR3,"diffuse",Qr,()=>3)],intensity:[new rs(Vn.a.ANIMATIONTYPE_FLOAT,"intensity",Zr,()=>1)],range:[new rs(Vn.a.ANIMATIONTYPE_FLOAT,"range",Zr,()=>1)],spot:{innerConeAngle:[new rs(Vn.a.ANIMATIONTYPE_FLOAT,"innerAngle",es,()=>1)],outerConeAngle:[new rs(Vn.a.ANIMATIONTYPE_FLOAT,"angle",es,()=>1)]}}}},EXT_lights_ies:{lights:{__array__:{__target__:!0,color:[new rs(Vn.a.ANIMATIONTYPE_COLOR3,"diffuse",Qr,()=>3)],multiplier:[new rs(Vn.a.ANIMATIONTYPE_FLOAT,"intensity",Zr,()=>1)]}}}}};class ls{convert(e){let t=this._gltf,n=this._infoTree,i=void 0;if(!e.startsWith("/"))throw new Error("Path must start with a /");const r=e.split("/");r.shift();for(const s of r){if(n.__array__)n=n.__array__;else if(n=n[s],!n)throw new Error(`Path ${e} is invalid`);if(void 0===t)throw new Error(`Path ${e} is invalid`);t=t[s],n.__target__&&(i=t)}return{object:i,info:n}}constructor(e,t){this._gltf=e,this._infoTree=t}}class cs extends ls{constructor(e){super(e,os)}}class ds{get enabled(){return this._loader.isExtensionUsed("KHR_animation_pointer")}dispose(){this._loader=null,delete this._pathToObjectConverter}_loadAnimationChannelAsync(e,t,n,i,r){var s;const a=null===(s=i.target.extensions)||void 0===s?void 0:s.KHR_animation_pointer;if(!a||!this._pathToObjectConverter)return null;"pointer"!==i.target.path&&T.a.Warn(`${e}/target/path: Value (${i.target.path}) must be (pointer) when using the ${this.name} extension`),null!=i.target.node&&T.a.Warn(`${e}/target/node: Value (${i.target.node}) must not be present when using the ${this.name} extension`);const o=`${e}/extensions/${this.name}`,l=a.pointer;if(!l)throw new Error(o+": Pointer is missing");try{const s=this._pathToObjectConverter.convert(l);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,n,i,s,r)}catch(e){return T.a.Warn(`${o}/pointer: Invalid pointer (${l}) skipped`),null}}constructor(e){this.name="KHR_animation_pointer",this._loader=e,this._pathToObjectConverter=new cs(this._loader.gltf)}}lr("KHR_animation_pointer"),or("KHR_animation_pointer",!0,e=>new ds(e));class hs{_clone(){return new hs(this.frame,this.action,this.onlyOnce)}constructor(e,t,n){this.frame=e,this.action=t,this.onlyOnce=n,this.isDone=!1}}var us=n(121);class fs{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(null!==(e=C.a.audioEngine)&&void 0!==e&&e.audioContext&&(this.isPlaying||this.isPaused)){const e=this.isPaused?0:C.a.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+e}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){if(e==this._spatialSound)return;const t=this.isPlaying;this.pause(),e?(this._spatialSound=e,this._updateSpatialParameters()):this._disableSpatialSound(),t&&this.play()}dispose(){var e;null!==(e=C.a.audioEngine)&&void 0!==e&&e.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,-1===this.soundTrackId?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement),this._htmlAudioElement=null),this._streamingSource&&(this._streamingSource.disconnect(),this._streamingSource=null),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){var t;null!==(t=C.a.audioEngine)&&void 0!==t&&t.audioContext&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){var t;null!==(t=C.a.audioEngine)&&void 0!==t&&t.audioContext&&C.a.audioEngine.audioContext.decodeAudioData(e,e=>{this._audioBufferLoaded(e)},e=>{T.a.Error("Error while decoding audio data for: "+this.name+" / Error: "+e)})}setAudioBuffer(e){var t;null!==(t=C.a.audioEngine)&&void 0!==t&&t.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){var t,n,i,r,s,a,o,l,c,d,h;e&&(this.loop=null!==(t=e.loop)&&void 0!==t?t:this.loop,this.maxDistance=null!==(n=e.maxDistance)&&void 0!==n?n:this.maxDistance,this.useCustomAttenuation=null!==(i=e.useCustomAttenuation)&&void 0!==i?i:this.useCustomAttenuation,this.rolloffFactor=null!==(r=e.rolloffFactor)&&void 0!==r?r:this.rolloffFactor,this.refDistance=null!==(s=e.refDistance)&&void 0!==s?s:this.refDistance,this.distanceModel=null!==(a=e.distanceModel)&&void 0!==a?a:this.distanceModel,this._playbackRate=null!==(o=e.playbackRate)&&void 0!==o?o:this._playbackRate,this._length=null!==(l=e.length)&&void 0!==l?l:void 0,this.spatialSound=null!==(c=e.spatialSound)&&void 0!==c?c:this._spatialSound,this._setOffset(null!==(d=e.offset)&&void 0!==d?d:void 0),this.setVolume(null!==(h=e.volume)&&void 0!==h?h:this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),void 0!==this._offset&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),void 0!==this._length&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(0|this._offset)+this._length))))}_createSpatialParameters(){var e,t;null!==(e=C.a.audioEngine)&&void 0!==e&&e.canUseWebAudio&&C.a.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=null!==(t=this._soundPanner)&&void 0!==t?t:C.a.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){var e;this._spatialSound&&(this._inputAudioNode=this._soundGain,null===(e=this._soundPanner)||void 0===e||e.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var e;null!==(e=C.a.audioEngine)&&void 0!==e&&e.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){var t;null!==(t=C.a.audioEngine)&&void 0!==t&&t.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,n){t<e?T.a.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle."):(this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=n,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length)))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!=this._coneInnerAngle){var t;if(this._coneOuterAngle<e)return void T.a.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e,null!==(t=C.a.audioEngine)&&void 0!==t&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!=this._coneOuterAngle){var t;if(e<this._coneInnerAngle)return void T.a.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=e,null!==(t=C.a.audioEngine)&&void 0!==t&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){var t;e.equals(this._position)||(this._position.copyFrom(e),null!==(t=C.a.audioEngine)&&void 0!==t&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){var t;this._localDirection=e,null!==(t=C.a.audioEngine)&&void 0!==t&&t.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=r.e.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){var e;if(null!==(e=C.a.audioEngine)&&void 0!==e&&e.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const e=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,e,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,n){var i;if(this._isReadyToPlay&&this._scene.audioEnabled&&null!==(i=C.a.audioEngine)&&void 0!==i&&i.audioContext)try{var r,s;this._clearTimeoutsAndObservers();let i=e?(null===(r=C.a.audioEngine)||void 0===r?void 0:r.audioContext.currentTime)+e:null===(s=C.a.audioEngine)||void 0===s?void 0:s.audioContext.currentTime;if(this._soundSource&&this._streamingSource||this._spatialSound&&this._soundPanner&&(isNaN(this._position.x)||isNaN(this._position.y)||isNaN(this._position.z)||(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(!this._streamingSource&&this._htmlAudioElement&&(this._streamingSource=C.a.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource&&(this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode)),this._htmlAudioElement){const e=()=>{var n;if(null!==(n=C.a.audioEngine)&&void 0!==n&&n.unlocked){if(!this._htmlAudioElement)return;this._htmlAudioElement.currentTime=null!=t?t:0;const n=this._htmlAudioElement.play();void 0!==n&&n.catch(()=>{var t,n;null===(t=C.a.audioEngine)||void 0===t||t.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=null===(n=C.a.audioEngine)||void 0===n?void 0:n.onAudioUnlockedObservable.addOnce(()=>{e()}))})}else{var i;(this.loop||this.autoplay)&&(this._audioUnlockedObserver=null===(i=C.a.audioEngine)||void 0===i?void 0:i.onAudioUnlockedObservable.addOnce(()=>{e()}))}};e()}}else{var a;const r=()=>{var r;if(null!==(r=C.a.audioEngine)&&void 0!==r&&r.audioContext){var s;if(n=n||this._length,void 0!==t&&this._setOffset(t),this._soundSource){const e=this._soundSource;e.onended=()=>{e.disconnect()}}if(this._soundSource=null===(s=C.a.audioEngine)||void 0===s?void 0:s.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){var a,o;this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,void 0!==t&&(this._soundSource.loopStart=t),void 0!==n&&(this._soundSource.loopEnd=(0|t)+n),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},i=e?(null===(a=C.a.audioEngine)||void 0===a?void 0:a.audioContext.currentTime)+e:C.a.audioEngine.audioContext.currentTime;const r=((this.isPaused?this.currentTime:0)+(null!==(o=this._offset)&&void 0!==o?o:0))%this._soundSource.buffer.duration;this._soundSource.start(i,r,this.loop?void 0:n)}}};"suspended"===(null===(a=C.a.audioEngine)||void 0===a?void 0:a.audioContext.state)?this._tryToPlayTimeout=setTimeout(()=>{var e;"suspended"===(null===(e=C.a.audioEngine)||void 0===e?void 0:e.audioContext.state)?(C.a.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=C.a.audioEngine.onAudioUnlockedObservable.addOnce(()=>{r()}))):r()},500):r()}this._startTime=i,this.isPlaying=!0,this.isPaused=!1}catch(e){T.a.Error("Error while trying to play audio: "+this.name+", "+e.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){var t;if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming){var n;this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):null===(n=this._streamingSource)||void 0===n||n.disconnect(),this.isPlaying=!1}else if(null!==(t=C.a.audioEngine)&&void 0!==t&&t.audioContext&&this._soundSource){const t=e?C.a.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(t)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){var e;if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming){var t;this._htmlAudioElement?this._htmlAudioElement.pause():null===(t=this._streamingSource)||void 0===t||t.disconnect(),this.isPlaying=!1,this.isPaused=!0}else null!==(e=C.a.audioEngine)&&void 0!==e&&e.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=C.a.audioEngine.audioContext.currentTime-this._startTime)}setVolume(e,t){var n;null!==(n=C.a.audioEngine)&&void 0!==n&&n.canUseWebAudio&&this._soundGain&&(t&&C.a.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(C.a.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,C.a.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,C.a.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=e=>this._onRegisterAfterWorldMatrixUpdate(e),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){var t;if(e.getBoundingInfo){const t=e.getBoundingInfo();this.setPosition(t.boundingSphere.centerWorld)}else this.setPosition(e.absolutePosition);null!==(t=C.a.audioEngine)&&void 0!==t&&t.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{Object(us.b)(()=>this._isReadyToPlay,()=>{n._audioBuffer=this.getAudioBuffer(),n._isReadyToPlay=!0,n.autoplay&&n.play(0,this._offset,this._length)},void 0,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},n=new fs(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&n.setAttenuationFunction(this._customAttenuationFunction),n.setPosition(this._position),n.setPlaybackRate(this._playbackRate),e(),n}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,n,i){const s=e.name;let a;a=e.url?n+e.url:n+s;const o={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let l;if(i){const e=()=>{Object(us.b)(()=>i._isReadyToPlay,()=>{l._audioBuffer=i.getAudioBuffer(),l._isReadyToPlay=!0,l.autoplay&&l.play(0,l._offset,l._length)},void 0,300)};l=new fs(s,new ArrayBuffer(0),t,null,o),e()}else l=new fs(s,a,t,()=>{t.removePendingData(l)},o),t.addPendingData(l);if(e.position){const t=r.e.FromArray(e.position);l.setPosition(t)}if(e.isDirectional&&(l.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const t=r.e.FromArray(e.localDirectionToMesh);l.setLocalDirectionToMesh(t)}if(e.connectedMeshId){const n=t.getMeshById(e.connectedMeshId);n&&l.attachToMesh(n)}return e.metadata&&(l.metadata=e.metadata),l}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}_clearTimeoutsAndObservers(){var e;this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&(null===(e=C.a.audioEngine)||void 0===e||e.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}constructor(e,t,n,i=null,s){var a,o,l,c,d;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new _.a,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=r.e.Zero(),this._localDirection=new r.e(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,n=n||E.a.LastCreatedScene)if(this._scene=n,fs._SceneComponentInitialization(n),this._readyToPlayCallback=i,this._customAttenuationFunction=(e,t,n,i,r)=>t<n?e*(1-t/n):0,s&&(this.autoplay=s.autoplay||!1,this._loop=s.loop||!1,void 0!==s.volume&&(this._volume=s.volume),this._spatialSound=null!==(o=s.spatialSound)&&void 0!==o&&o,this.maxDistance=null!==(l=s.maxDistance)&&void 0!==l?l:100,this.useCustomAttenuation=null!==(c=s.useCustomAttenuation)&&void 0!==c&&c,this.rolloffFactor=s.rolloffFactor||1,this.refDistance=s.refDistance||1,this.distanceModel=s.distanceModel||"linear",this._playbackRate=s.playbackRate||1,this._streaming=null!==(d=s.streaming)&&void 0!==d&&d,this._length=s.length,this._offset=s.offset),null!==(a=C.a.audioEngine)&&void 0!==a&&a.canUseWebAudio&&C.a.audioEngine.audioContext){this._soundGain=C.a.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let e=!0;if(t)try{"string"==typeof t?(this._urlType="String",this._url=t):t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let n=[],i=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=C.a.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=C.a.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(i=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":n.push(t);case"Array":0===n.length&&(n=t);for(let e=0;e<n.length;e++){const t=n[e];if(i=s&&s.skipCodecCheck||-1!==t.indexOf(".mp3",t.length-4)&&C.a.audioEngine.isMP3supported||-1!==t.indexOf(".ogg",t.length-4)&&C.a.audioEngine.isOGGsupported||-1!==t.indexOf(".wav",t.length-4)||-1!==t.indexOf(".m4a",t.length-4)||-1!==t.indexOf(".mp4",t.length-4)||-1!==t.indexOf("blob:"),i){this._streaming?(this._htmlAudioElement=new Audio(t),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,g.b.SetCorsBehavior(t,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()},{once:!0}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(t,e=>{this._soundLoaded(e)},void 0,!0,!0,e=>{e&&T.a.Error("XHR "+e.status+" error on: "+t+"."),T.a.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:e=!1}e?i||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):T.a.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch(e){T.a.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),C.a.audioEngine&&!C.a.audioEngine.WarnedWebAudioUnsupported&&(T.a.Error("Web Audio is not supported by your browser."),C.a.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}}fs._SceneComponentInitialization=e=>{throw Object(ht.a)("AudioSceneComponent")},Object(Je.b)("BABYLON.Sound",fs);class ms{get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e)return void T.a.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle)return void T.a.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e)}_onended(){void 0!==this._currentIndex&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPlaying&&(this.isPaused=!0,void 0!==this._currentIndex&&this._sounds[this._currentIndex].pause())}stop(){this.isPlaying=!1,void 0!==this._currentIndex&&this._sounds[this._currentIndex].stop()}play(e){var t;if(!this.isPaused){this.stop();const e=Math.random();let t=0;for(let n=0;n<this._weights.length;n++)if(t+=this._weights[n],e<=t){this._currentIndex=n;break}}const n=this._sounds[null!==(t=this._currentIndex)&&void 0!==t?t:0];n.isReady()?n.play(0,this.isPaused?void 0:e):n.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}constructor(e,t,n){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==n.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=n;let i=0;for(const e of n)i+=e;const r=i>0?1/i:0;for(let e=0;e<this._weights.length;e++)this._weights[e]*=r;this._sounds=t;for(const e of this._sounds)e.onEndedObservable.add(()=>{this._onended()})}}class ps{_initializeSoundTrackAudioGraph(){var e;null!==(e=C.a.audioEngine)&&void 0!==e&&e.canUseWebAudio&&C.a.audioEngine.audioContext&&(this._outputAudioNode=C.a.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(C.a.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(C.a.audioEngine&&C.a.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){var t;this._isInitialized||this._initializeSoundTrackAudioGraph(),null!==(t=C.a.audioEngine)&&void 0!==t&&t.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),void 0!==e.soundTrackId&&(-1===e.soundTrackId?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){const t=this.soundCollection.indexOf(e);-1!==t&&this.soundCollection.splice(t,1)}setVolume(e){var t;null!==(t=C.a.audioEngine)&&void 0!==t&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){var e;if(null!==(e=C.a.audioEngine)&&void 0!==e&&e.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){var e;if(null!==(e=C.a.audioEngine)&&void 0!==e&&e.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()}connectToAnalyser(e){var t;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,null!==(t=C.a.audioEngine)&&void 0!==t&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,C.a.audioEngine.masterGain))}constructor(e,t={}){this.id=-1,this._isInitialized=!1,(e=e||E.a.LastCreatedScene)&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}}n(397);var gs=n(173);const _s={};function vs(e,t){_s[e]=t}vs(Kt.a.NAME_AUDIO,(e,t,n,i)=>{let r,s=[];if(n.sounds=n.sounds||[],void 0!==e.sounds&&null!==e.sounds)for(let o=0,l=e.sounds.length;o<l;o++){var a;const l=e.sounds[o];null!==(a=C.a.audioEngine)&&void 0!==a&&a.canUseWebAudio?(l.url||(l.url=l.name),s[l.url]?n.sounds.push(fs.Parse(l,t,i,s[l.url])):(r=fs.Parse(l,t,i),s[l.url]=r,n.sounds.push(r))):n.sounds.push(new fs(l.name,null,t))}s=[]}),Object.defineProperty(v.a.prototype,"mainSoundTrack",{get:function(){let e=this._getComponent(Kt.a.NAME_AUDIO);return e||(e=new Es(this),this._addComponent(e)),this._mainSoundTrack||(this._mainSoundTrack=new ps(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),v.a.prototype.getSoundByName=function(e){let t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===e)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks)for(let n=0;n<this.soundTracks.length;n++)for(t=0;t<this.soundTracks[n].soundCollection.length;t++)if(this.soundTracks[n].soundCollection[t].name===e)return this.soundTracks[n].soundCollection[t];return null},Object.defineProperty(v.a.prototype,"audioEnabled",{get:function(){let e=this._getComponent(Kt.a.NAME_AUDIO);return e||(e=new Es(this),this._addComponent(e)),e.audioEnabled},set:function(e){let t=this._getComponent(Kt.a.NAME_AUDIO);t||(t=new Es(this),this._addComponent(t)),e?t.enableAudio():t.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(v.a.prototype,"headphone",{get:function(){let e=this._getComponent(Kt.a.NAME_AUDIO);return e||(e=new Es(this),this._addComponent(e)),e.headphone},set:function(e){let t=this._getComponent(Kt.a.NAME_AUDIO);t||(t=new Es(this),this._addComponent(t)),e?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(v.a.prototype,"audioListenerPositionProvider",{get:function(){let e=this._getComponent(Kt.a.NAME_AUDIO);return e||(e=new Es(this),this._addComponent(e)),e.audioListenerPositionProvider},set:function(e){let t=this._getComponent(Kt.a.NAME_AUDIO);if(t||(t=new Es(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(v.a.prototype,"audioListenerRotationProvider",{get:function(){let e=this._getComponent(Kt.a.NAME_AUDIO);return e||(e=new Es(this),this._addComponent(e)),e.audioListenerRotationProvider},set:function(e){let t=this._getComponent(Kt.a.NAME_AUDIO);if(t||(t=new Es(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");t.audioListenerRotationProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(v.a.prototype,"audioPositioningRefreshRate",{get:function(){let e=this._getComponent(Kt.a.NAME_AUDIO);return e||(e=new Es(this),this._addComponent(e)),e.audioPositioningRefreshRate},set:function(e){let t=this._getComponent(Kt.a.NAME_AUDIO);t||(t=new Es(this),this._addComponent(t)),t.audioPositioningRefreshRate=e},enumerable:!0,configurable:!0});class Es{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}register(){this.scene._afterRenderStage.registerStep(Kt.a.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const n=this.scene.soundTracks[t];for(let t=0;t<n.soundCollection.length;t++)e.sounds.push(n.soundCollection[t].serialize())}}addFromContainer(e){e.sounds&&e.sounds.forEach(e=>{e.play(),e.autoplay=!0,this.scene.mainSoundTrack.addSound(e)})}removeFromContainer(e,t=!1){e.sounds&&e.sounds.forEach(e=>{e.stop(),e.autoplay=!1,this.scene.mainSoundTrack.removeSound(e),t&&e.dispose()})}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;let t;for(this._audioEnabled=!1,C.a.audioEngine&&C.a.audioEngine.audioContext&&C.a.audioEngine.audioContext.suspend(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let n=0;n<e.soundTracks[t].soundCollection.length;n++)e.soundTracks[t].soundCollection[n].pause()}enableAudio(){const e=this.scene;let t;for(this._audioEnabled=!0,C.a.audioEngine&&C.a.audioEngine.audioContext&&C.a.audioEngine.audioContext.resume(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let n=0;n<e.soundTracks[t].soundCollection.length;n++)e.soundTracks[t].soundCollection[n].isPaused&&e.soundTracks[t].soundCollection[n].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=gs.a.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||0===t._mainSoundTrack.soundCollection.length&&1===t.soundTracks.length)return;const n=C.a.audioEngine;if(n&&n.audioContext){let e,i=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(i=t.activeCameras[0]),this.audioListenerPositionProvider){const e=this.audioListenerPositionProvider();n.audioContext.listener.setPosition(e.x||0,e.y||0,e.z||0)}else i?this._cachedCameraPosition.equals(i.globalPosition)||(this._cachedCameraPosition.copyFrom(i.globalPosition),n.audioContext.listener.setPosition(i.globalPosition.x,i.globalPosition.y,i.globalPosition.z)):n.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const e=this.audioListenerRotationProvider();n.audioContext.listener.setOrientation(e.x||0,e.y||0,e.z||0,0,1,0)}else i?(i.rigCameras&&i.rigCameras.length>0&&(i=i.rigCameras[0]),i.getViewMatrix().invertToRef(this._invertMatrixTemp),r.e.TransformNormalToRef(Es._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),isNaN(this._cameraDirectionTemp.x)||isNaN(this._cameraDirectionTemp.y)||isNaN(this._cameraDirectionTemp.z)||this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),n.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0))):n.audioContext.listener.setOrientation(0,0,0,0,1,0);for(e=0;e<t.mainSoundTrack.soundCollection.length;e++){const n=t.mainSoundTrack.soundCollection[e];n.useCustomAttenuation&&n.updateDistanceFromListener()}if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let n=0;n<t.soundTracks[e].soundCollection.length;n++){const i=t.soundTracks[e].soundCollection[n];i.useCustomAttenuation&&i.updateDistanceFromListener()}}}constructor(e){this.name=Kt.a.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new r.e,this._cachedCameraPosition=new r.e,this._lastCheck=0,this._invertMatrixTemp=new r.a,this._cameraDirectionTemp=new r.e,(e=e||E.a.LastCreatedScene)&&(this.scene=e,e.soundTracks=[],e.sounds=[])}}Es._CameraDirection=new r.e(0,0,-1),fs._SceneComponentInitialization=e=>{let t=e._getComponent(Kt.a.NAME_AUDIO);t||(t=new Es(e),e._addComponent(t))};class Ts{dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,cr.Assign(this._clips),cr.Assign(this._emitters)}}loadSceneAsync(e,t){return hr.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,t));for(const e of i.emitters){const t=cr.Get(n+"/emitters",this._emitters,e);if(null!=t.refDistance||null!=t.maxDistance||null!=t.rolloffFactor||null!=t.distanceModel||null!=t.innerAngle||null!=t.outerAngle)throw new Error(n+": Direction or Distance properties are not allowed on emitters attached to a scene");r.push(this._loadEmitterAsync(`${n}/emitters/${t.index}`,t))}return Promise.all(r).then(()=>{})})}loadNodeAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(e,i)=>{const s=new Array;return this._loader.loadNodeAsync(e,t,t=>{for(const n of i.emitters){const i=cr.Get(e+"/emitters",this._emitters,n);s.push(this._loadEmitterAsync(`${e}/emitters/${i.index}`,i).then(()=>{for(const e of i._babylonSounds)e.attachToMesh(t),null==i.innerAngle&&null==i.outerAngle||(e.setLocalDirectionToMesh(r.e.Forward()),e.setDirectionalCone(2*g.b.ToDegrees(null==i.innerAngle?Math.PI:i.innerAngle),2*g.b.ToDegrees(null==i.outerAngle?Math.PI:i.outerAngle),0))}))}n(t)}).then(e=>Promise.all(s).then(()=>e))})}loadAnimationAsync(e,t){return hr.LoadExtensionAsync(e,t,this.name,(n,i)=>this._loader.loadAnimationAsync(e,t).then(r=>{const s=new Array;cr.Assign(i.events);for(const a of i.events)s.push(this._loadAnimationEventAsync(`${n}/events/${a.index}`,e,t,a,r));return Promise.all(s).then(()=>r)}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let n;if(t.uri)n=this._loader.loadUriAsync(e,t,t.uri);else{const i=cr.Get(e+"/bufferView",this._loader.gltf.bufferViews,t.bufferView);n=this._loader.loadBufferViewAsync("/bufferViews/"+i.index,i)}return t._objectURL=n.then(e=>URL.createObjectURL(new Blob([e],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const e=new Array,n=t.name||"emitter"+t.index,i={loop:!1,autoplay:!1,volume:null==t.volume?1:t.volume};for(let r=0;r<t.clips.length;r++){const s=`/extensions/${this.name}/clips`,a=cr.Get(s,this._clips,t.clips[r].clip);e.push(this._loadClipAsync(`${s}/${t.clips[r].clip}`,a).then(e=>{const s=t._babylonSounds[r]=new fs(n,e,this._loader.babylonScene,null,i);s.refDistance=t.refDistance||1,s.maxDistance=t.maxDistance||256,s.rolloffFactor=t.rolloffFactor||1,s.distanceModel=t.distanceModel||"exponential"}))}const r=Promise.all(e).then(()=>{const e=t.clips.map(e=>e.weight||1),n=new ms(t.loop||!1,t._babylonSounds,e);t.innerAngle&&(n.directionalConeInnerAngle=2*g.b.ToDegrees(t.innerAngle)),t.outerAngle&&(n.directionalConeOuterAngle=2*g.b.ToDegrees(t.outerAngle)),t.volume&&(n.volume=t.volume),t._babylonData.sound=n});t._babylonData={loaded:r}}return t._babylonData.loaded}_getEventAction(e,t,n,i,r){switch(n){case"play":return e=>{const n=(r||0)+(e-i);t.play(n)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${n}`)}}_loadAnimationEventAsync(e,t,n,i,r){if(0==r.targetedAnimations.length)return Promise.resolve();const s=r.targetedAnimations[0],a=i.emitter,o=cr.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,o).then(()=>{const t=o._babylonData.sound;if(t){const n=new hs(i.time,this._getEventAction(e,t,i.action,i.time,i.startOffset));s.animation.addEvent(n),r.onAnimationGroupEndObservable.add(()=>{t.stop()}),r.onAnimationGroupPauseObservable.add(()=>{t.pause()})}})}constructor(e){this.name="MSFT_audio_emitter",this._loader=e,this.enabled=this._loader.isExtensionUsed("MSFT_audio_emitter")}}lr("MSFT_audio_emitter"),or("MSFT_audio_emitter",!0,e=>new Ts(e));class Ss{dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then(()=>{0!==e&&(this._loader.endPerformanceCounter("Node LOD "+e),this._loader.log("Loaded node LOD "+e)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter("Node LOD "+(e+1)),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then(()=>{0!==e&&(this._loader.endPerformanceCounter("Material LOD "+e),this._loader.log("Loaded material LOD "+e)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter("Material LOD "+(e+1)),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const n=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),n}loadNodeAsync(e,t,n){return hr.LoadExtensionAsync(e,t,this.name,(e,i)=>{let r;const s=this._getLODs(e,t,this._loader.gltf.nodes,i.ids);this._loader.logOpen(""+e);for(let e=0;e<s.length;e++){const t=s[e];0!==e&&(this._nodeIndexLOD=e,this._nodeSignalLODs[e]=this._nodeSignalLODs[e]||new Ni);const i=e=>{n(e),e.setEnabled(!1)},a=this._loader.loadNodeAsync("/nodes/"+t.index,t,i).then(t=>{if(0!==e){const t=s[e-1];t._babylonTransformNode&&(this._disposeTransformNode(t._babylonTransformNode),delete t._babylonTransformNode)}return t.setEnabled(!0),t});this._nodePromiseLODs[e]=this._nodePromiseLODs[e]||[],0===e?r=a:(this._nodeIndexLOD=null,this._nodePromiseLODs[e].push(a))}return this._loader.logClose(),r})}_loadMaterialAsync(e,t,n,i,r){return this._nodeIndexLOD?null:hr.LoadExtensionAsync(e,t,this.name,(e,s)=>{let a;const o=this._getLODs(e,t,this._loader.gltf.materials,s.ids);this._loader.logOpen(""+e);for(let e=0;e<o.length;e++){const t=o[e];0!==e&&(this._materialIndexLOD=e);const s=this._loader._loadMaterialAsync("/materials/"+t.index,t,n,i,t=>{0===e&&r(t)}).then(t=>{if(0!==e){r(t);const n=o[e-1]._data;n[i]&&(this._disposeMaterials([n[i].babylonMaterial]),delete n[i])}return t});this._materialPromiseLODs[e]=this._materialPromiseLODs[e]||[],0===e?a=s:(this._materialIndexLOD=null,this._materialPromiseLODs[e].push(s))}return this._loader.logClose(),a})}_loadUriAsync(e,t,n){if(null!==this._nodeIndexLOD){this._loader.log("deferred");const i=this._nodeIndexLOD-1;return this._nodeSignalLODs[i]=this._nodeSignalLODs[i]||new Ni,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,t,n))}if(null!==this._materialIndexLOD){this._loader.log("deferred");const i=this._materialIndexLOD-1;return this._materialSignalLODs[i]=this._materialSignalLODs[i]||new Ni,this._materialSignalLODs[i].promise.then(()=>this._loader.loadUriAsync(e,t,n))}return null}loadBufferAsync(e,t,n,i){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(e+": Uri is missing or the binary glTF is missing its binary chunk");const t=(e,t)=>{const r=n,s=r+i-1;let a=e[t];return a?(a.start=Math.min(a.start,r),a.end=Math.max(a.end,s)):(a={start:r,end:s,loaded:new Ni},e[t]=a),a.loaded.promise.then(e=>new Uint8Array(e.buffer,e.byteOffset+n-a.start,i))};return this._loader.log("deferred"),null!==this._nodeIndexLOD?t(this._nodeBufferLODs,this._nodeIndexLOD):null!==this._materialIndexLOD?t(this._materialBufferLODs,this._materialIndexLOD):t(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const n=e[t];n&&(this._loader.log(`Loading buffer range [${n.start}-${n.end}]`),this._loader.bin.readAsync(n.start,n.end-n.start+1).then(e=>{n.loaded.resolve(e)},e=>{n.loaded.reject(e)}))}_getLODs(e,t,n,i){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const r=[];for(let t=i.length-1;t>=0;t--)if(r.push(cr.Get(`${e}/ids/${i[t]}`,n,i[t])),r.length===this.maxLODsToLoad)return r;return r.push(t),r}_disposeTransformNode(e){const t=[],n=e.material;n&&t.push(n);for(const n of e.getChildMeshes())n.material&&t.push(n.material);e.dispose();const i=t.filter(e=>this._loader.babylonScene.meshes.every(t=>t.material!=e));this._disposeMaterials(i)}_disposeMaterials(e){const t={};for(const n of e){for(const e of n.getActiveTextures())t[e.uniqueId]=e;n.dispose()}for(const e in t)for(const n of this._loader.babylonScene.materials)n.hasTexture(t[e])&&delete t[e];for(const e in t)t[e].dispose()}constructor(e){var t,n;this.name="MSFT_lod",this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new _.a,this.onMaterialLODsLoadedObservable=new _.a,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.maxLODsToLoad=null!==(t=null===(n=this._loader.parent.extensionOptions.MSFT_lod)||void 0===n?void 0:n.maxLODsToLoad)&&void 0!==t?t:this.maxLODsToLoad,this.enabled=this._loader.isExtensionUsed("MSFT_lod")}}lr("MSFT_lod"),or("MSFT_lod",!0,e=>new Ss(e));class As{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtraAsync(e,t,this.name,(i,r)=>{if(r){if(!(n instanceof Zi))throw new Error(i+": Material type not supported");const r=this._loader.loadMaterialPropertiesAsync(e,t,n);return n.needAlphaBlending()&&(n.forceDepthWrite=!0,n.separateCullingPass=!0),n.backFaceCulling=n.forceDepthWrite,n.twoSidedLighting=!0,r}return null})}constructor(e){this.name="MSFT_minecraftMesh",this._loader=e,this.enabled=this._loader.isExtensionUsed("MSFT_minecraftMesh")}}lr("MSFT_minecraftMesh"),or("MSFT_minecraftMesh",!0,e=>new As(e));class bs{dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return hr.LoadExtraAsync(e,t,this.name,(i,r)=>{if(r){if(!(n instanceof Zi))throw new Error(i+": Material type not supported");const r=this._loader.loadMaterialPropertiesAsync(e,t,n),s=n.getScene().getEngine().useExactSrgbConversions;return n.albedoTexture||n.albedoColor.toLinearSpaceToRef(n.albedoColor,s),n.reflectivityTexture||n.reflectivityColor.toLinearSpaceToRef(n.reflectivityColor,s),r}return null})}constructor(e){this.name="MSFT_sRGBFactors",this._loader=e,this.enabled=this._loader.isExtensionUsed("MSFT_sRGBFactors")}}var Is;lr("MSFT_sRGBFactors"),or("MSFT_sRGBFactors",!0,e=>new bs(e)),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(Is||(Is={}));class Rs{get connectionType(){return this._connectionType}_isSingularConnection(){return!0}isConnected(){return this._connectedPoint.length>0}connectTo(e){if(this._connectionType===e._connectionType)throw new Error("Cannot connect two points of type "+this.connectionType);if(this._isSingularConnection()&&this._connectedPoint.length>0||e._isSingularConnection()&&e._connectedPoint.length>0)throw new Error("Max number of connections for point reached");this._connectedPoint.push(e),e._connectedPoint.push(this)}serialize(e={}){e.uniqueId=this.uniqueId,e.name=this.name,e._connectionType=this._connectionType,e.connectedPointIds=[],e.className=this.getClassName();for(const t of this._connectedPoint)e.connectedPointIds.push(t.uniqueId)}getClassName(){return"FGConnection"}deserialize(e){this.uniqueId=e.uniqueId,this.name=e.name,this._connectionType=e._connectionType,this.connectedPointIds=e.connectedPointIds}static Parse(e={},t){const n=new(g.b.Instantiate(e.className))(e.name,e._connectionType,t);return n.deserialize(e),n}constructor(e,t,n){this._ownerBlock=n,this._connectedPoint=[],this.uniqueId=Object(R.a)(),this.connectedPointIds=[],this.name=e,this._connectionType=t}}class Cs{_toInt(e){return 0|e}add(e){return new Cs(this.value+e.value)}subtract(e){return new Cs(this.value-e.value)}multiply(e){return new Cs(Math.imul(this.value,e.value))}divide(e){return new Cs(this.value/e.value)}getClassName(){return Cs.ClassName}equals(e){return this.value===e.value}static Parse(e){return new Cs(e.value)}constructor(e){this.value=this._toInt(e)}}Cs.ClassName="FlowGraphInteger",Object(Je.b)("FlowGraphInteger",Cs);class ys{serialize(e){e.typeName=this.typeName,e.defaultValue=this.defaultValue}static Parse(e){return new ys(e.typeName,e.defaultValue)}constructor(e,t){this.typeName=e,this.defaultValue=t}}const Ms=new ys("any",void 0),Os=(new ys("string",""),new ys("number",0)),xs=new ys("boolean",!1),Ds=new ys("Vector2",r.d.Zero()),Ps=new ys("Vector3",r.e.Zero()),Ls=(new ys("Vector4",r.f.Zero()),new ys("Matrix",r.a.Identity())),Ns=(new ys("Color3",he.a.Black()),new ys("Color4",new he.b(0,0,0,0)),new ys("Quaternion",r.b.Identity()),new ys("FlowGraphInteger",new Cs(0)));class Fs extends Rs{_isSingularConnection(){return 0===this.connectionType}setValue(e,t){t._setConnectionValue(this,e)}connectTo(e){super.connectTo(e)}_getValueOrDefault(e){return e._hasConnectionValue(this)?e._getConnectionValue(this):this.richType.defaultValue}getValue(e){return 1===this.connectionType?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._updateOutputs(e),this._getValueOrDefault(e)):this.isConnected()?this._connectedPoint[0].getValue(e):this._getValueOrDefault(e)}getClassName(){return"FGDataConnection"}serialize(e={}){super.serialize(e),e.richType={},this.richType.serialize(e.richType)}static Parse(e,t){const n=Rs.Parse(e,t);return n.richType=ys.Parse(e.richType),n}constructor(e,t,n,i){super(e,t,n),this.richType=i}}function ws(e){return"Mesh"===e||"AbstractMesh"===e||"GroundMesh"===e||"InstanceMesh"===e||"LinesMesh"===e||"GoldbergMesh"===e||"GreasedLineMesh"===e||"TrailMesh"===e}function Us(e){return"Vector2"===e||"Vector3"===e||"Vector4"===e||"Quaternion"===e||"Color3"===e||"Color4"===e}function Bs(e,t,n){var i,r;const s=null!==(i=null==t||null===(r=t.getClassName)||void 0===r?void 0:r.call(t))&&void 0!==i?i:"";ws(s)?n[e]={name:t.name,className:s}:Us(s)?n[e]={value:t.asArray(),className:s}:n[e]=t}function ks(e,t,n){const i=t[e];let s;const a=null==i?void 0:i.className;return s=ws(a)?n.getMeshByName(i.name):Us(a)?function(e,t){if("Vector2"===e)return r.d.FromArray(t);if("Vector3"===e)return r.e.FromArray(t);if("Vector4"===e)return r.f.FromArray(t);if("Quaternion"===e)return r.b.FromArray(t);if("Color3"===e)return new he.a(t[0],t[1],t[2]);if("Color4"===e)return new he.b(t[0],t[1],t[2],t[3]);throw new Error("Unknown vector class name "+e)}(a,i.value):"Matrix"===a?r.a.FromArray(i.value):a===Cs.ClassName?Cs.Parse(i):i&&void 0!==i.value?i.value:i,s}Object(Je.b)("FGDataConnection",Fs);class Vs{_updateOutputs(e){}registerDataInput(e,t){const n=new Fs(e,0,this,t);return this.dataInputs.push(n),n}registerDataOutput(e,t){const n=new Fs(e,1,this,t);return this.dataOutputs.push(n),n}getDataInput(e){return this.dataInputs.find(t=>t.name===e)}getDataOutput(e){return this.dataOutputs.find(t=>t.name===e)}serialize(e={},t=Bs){e.uniqueId=this.uniqueId,e.config={},this.config&&(e.config.name=this.config.name),e.dataInputs=[],e.dataOutputs=[],e.className=this.getClassName();for(const t of this.dataInputs){const n={};t.serialize(n),e.dataInputs.push(n)}for(const t of this.dataOutputs){const n={};t.serialize(n),e.dataOutputs.push(n)}}getClassName(){return"FGBlock"}static Parse(e,t){var n;const i=g.b.Instantiate(e.className),r={},s=null!==(n=t.valueParseFunction)&&void 0!==n?n:ks;if(e.config)for(const n in e.config)r[n]=s(n,e.config,t.scene);var a;("FGSetPropertyBlock"===(a=e.className)||"FGGetPropertyBlock"===a||"FGPlayAnimationBlock"===a||"FGMeshPickEventBlock"===a)&&(r.pathConverter=t.pathConverter);const o=new i(r);o.uniqueId=e.uniqueId;for(let t=0;t<e.dataInputs.length;t++){const n=o.getDataInput(e.dataInputs[t].name);if(!n)throw new Error("Could not find data input with name "+e.dataInputs[t].name+" in block "+e.className);n.deserialize(e.dataInputs[t])}for(let t=0;t<e.dataOutputs.length;t++){const n=o.getDataOutput(e.dataOutputs[t].name);if(!n)throw new Error("Could not find data output with name "+e.dataOutputs[t].name+" in block "+e.className);n.deserialize(e.dataOutputs[t])}return o.metadata=e.metadata,o.deserialize&&o.deserialize(e),o}constructor(e){var t,n;this.config=e,this.uniqueId=Object(R.a)(),this.name=null!==(t=null===(n=this.config)||void 0===n?void 0:n.name)&&void 0!==t?t:this.getClassName(),this.dataInputs=[],this.dataOutputs=[]}}class Gs extends Rs{_isSingularConnection(){return 1===this.connectionType}_activateSignal(e){var t;0===this.connectionType?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._execute(e,this),e._increaseExecutionId()):null===(t=this._connectedPoint[0])||void 0===t||t._activateSignal(e)}}Object(Je.b)("FlowGraphSignalConnection",Gs);class Hs extends Vs{_registerSignalInput(e){const t=new Gs(e,0,this);return this.signalInputs.push(t),t}_registerSignalOutput(e){const t=new Gs(e,1,this);return this.signalOutputs.push(t),t}getSignalInput(e){return this.signalInputs.find(t=>t.name===e)}getSignalOutput(e){return this.signalOutputs.find(t=>t.name===e)}serialize(e={}){super.serialize(e),e.signalInputs=[],e.signalOutputs=[];for(const t of this.signalInputs){const n={};t.serialize(n),e.signalInputs.push(n)}for(const t of this.signalOutputs){const n={};t.serialize(n),e.signalOutputs.push(n)}}deserialize(e){for(let t=0;t<e.signalInputs.length;t++){const n=this.getSignalInput(e.signalInputs[t].name);if(!n)throw new Error("Could not find signal input with name "+e.signalInputs[t].name+" in block "+e.className);n.deserialize(e.signalInputs[t])}for(let t=0;t<e.signalOutputs.length;t++){const n=this.getSignalOutput(e.signalOutputs[t].name);if(!n)throw new Error("Could not find signal output with name "+e.signalOutputs[t].name+" in block "+e.className);n.deserialize(e.signalOutputs[t])}}getClassName(){return"FGExecutionBlock"}constructor(e){super(e),this.signalInputs=[],this.signalOutputs=[],this.in=this._registerSignalInput("in")}}class Ws extends Hs{_startPendingTasks(e){this._preparePendingTasks(e),e._addPendingBlock(this)}constructor(e){super(e),this.out=this._registerSignalOutput("out"),this.done=this._registerSignalOutput("done")}}class Xs extends Ws{_execute(e){e._notifyExecuteNode(this),this.out._activateSignal(e)}}class js{hasVariable(e){return e in this._userVariables}setVariable(e,t){this._userVariables[e]=t}getVariable(e){return this._userVariables[e]}get userVariables(){return this._userVariables}_getUniqueIdPrefixedName(e,t){return`${e.uniqueId}_${t}`}_setExecutionVariable(e,t,n){this._executionVariables[this._getUniqueIdPrefixedName(e,t)]=n}_getExecutionVariable(e,t,n){return this._hasExecutionVariable(e,t)?this._executionVariables[this._getUniqueIdPrefixedName(e,t)]:n}_deleteExecutionVariable(e,t){delete this._executionVariables[this._getUniqueIdPrefixedName(e,t)]}_hasExecutionVariable(e,t){return this._getUniqueIdPrefixedName(e,t)in this._executionVariables}_hasConnectionValue(e){return e.uniqueId in this._connectionValues}_setConnectionValue(e,t){this._connectionValues[e.uniqueId]=t}_getConnectionValue(e){return this._connectionValues[e.uniqueId]}get configuration(){return this._configuration}_addPendingBlock(e){this._pendingBlocks.push(e)}_removePendingBlock(e){const t=this._pendingBlocks.indexOf(e);-1!==t&&this._pendingBlocks.splice(t,1)}_clearPendingBlocks(){for(const e of this._pendingBlocks)e._cancelPendingTasks(this);this._pendingBlocks.length=0}_notifyExecuteNode(e){this.onNodeExecutedObservable.notifyObservers(e)}_increaseExecutionId(){this._executionId++}get executionId(){return this._executionId}serialize(e={},t=Bs){e.uniqueId=this.uniqueId,e._userVariables={};for(const n in this._userVariables)t(n,this._userVariables[n],e._userVariables);e._connectionValues={};for(const n in this._connectionValues)t(n,this._connectionValues[n],e._connectionValues)}getClassName(){return"FGContext"}static Parse(e,t){var n;const i=t.graph.createContext(),r=null!==(n=t.valueParseFunction)&&void 0!==n?n:ks;i.uniqueId=e.uniqueId;for(const t in e._userVariables){const n=r(t,e._userVariables,i._configuration.scene);i._userVariables[t]=n}for(const t in e._connectionValues){const n=r(t,e._connectionValues,i._configuration.scene);i._connectionValues[t]=n}return i}constructor(e){this.uniqueId=Object(R.a)(),this._userVariables={},this._executionVariables={},this._connectionValues={},this._pendingBlocks=[],this._executionId=0,this.onNodeExecutedObservable=new _.a,this._configuration=e}}function zs(e,t){return!(!e.parent||e.parent!==t&&!zs(e.parent,t))}Object(W.a)([Object(X.c)()],js.prototype,"uniqueId",void 0);class Ks extends Xs{_getReferencedMesh(){const e=this.config.pathConverter.convert(this.config.path),t=e.info.getObject(e.object);if(!(t&&t instanceof jt))throw new Error("Mesh pick event block requires a valid mesh");return t}_preparePendingTasks(e){let t=e._getExecutionVariable(this,"meshPickObserver");if(!t){const n=this._getReferencedMesh();e._setExecutionVariable(this,"mesh",n),t=n.getScene().onPointerObservable.add(t=>{var i,r,s;t.type===Dn.a.POINTERPICK&&null!==(i=t.pickInfo)&&void 0!==i&&i.pickedMesh&&((null===(r=t.pickInfo)||void 0===r?void 0:r.pickedMesh)===n||zs(null===(s=t.pickInfo)||void 0===s?void 0:s.pickedMesh,n))&&this._execute(e)});const i=n.onDisposeObservable.add(()=>this._onDispose);e._setExecutionVariable(this,"meshPickObserver",t),e._setExecutionVariable(this,"meshDisposeObserver",i)}}_onDispose(e){this._cancelPendingTasks(e),e._removePendingBlock(this)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"mesh"),n=e._getExecutionVariable(this,"meshPickObserver"),i=e._getExecutionVariable(this,"meshDisposeObserver");t.getScene().onPointerObservable.remove(n),t.onDisposeObservable.remove(i),e._deleteExecutionVariable(this,"mesh"),e._deleteExecutionVariable(this,"meshPickObserver"),e._deleteExecutionVariable(this,"meshDisposeObserver")}getClassName(){return Ks.ClassName}serialize(e){super.serialize(e),e.config.path=this.config.path}constructor(e){super(e),this.config=e}}var Ys,qs;Ks.ClassName="FGMeshPickEventBlock",Object(Je.b)(Ks.ClassName,Ks),function(e){e[e.Stopped=0]="Stopped",e[e.Started=1]="Started"}(Ys||(Ys={}));class Qs{createContext(){const e=new js({scene:this._scene,coordinator:this._coordinator});return this._executionContexts.push(e),e}getContext(e){return this._executionContexts[e]}addEventBlock(e){this._eventBlocks.push(e)}start(){if(1!==this.state){this.state=1,0===this._executionContexts.length&&this.createContext();for(const e of this._executionContexts){const t=this._getContextualOrder();for(const n of t)n._startPendingTasks(e)}}}_getContextualOrder(){const e=[];for(const t of this._eventBlocks)if(t.getClassName()===Ks.ClassName){const n=t._getReferencedMesh();let i=0;for(;i<e.length;i++){const t=e[i]._getReferencedMesh();if(n&&t&&zs(n,t))break}e.splice(i,0,t)}else e.push(t);return e}dispose(){if(0!==this.state){this.state=0;for(const e of this._executionContexts)e._clearPendingBlocks();this._executionContexts.length=0,this._eventBlocks.length=0,this._scene.onDisposeObservable.remove(this._sceneDisposeObserver),this._sceneDisposeObserver=null}}visitAllBlocks(e){const t=[],n=new Set;for(const e of this._eventBlocks)t.push(e),n.add(e.uniqueId);for(;t.length>0;){const i=t.pop();e(i);for(const e of i.dataInputs)for(const i of e._connectedPoint)n.has(i._ownerBlock.uniqueId)||(t.push(i._ownerBlock),n.add(i._ownerBlock.uniqueId));if(i instanceof Hs)for(const e of i.signalOutputs)for(const i of e._connectedPoint)n.has(i._ownerBlock.uniqueId)||(t.push(i._ownerBlock),n.add(i._ownerBlock.uniqueId))}}serialize(e={},t){e.allBlocks=[],this.visitAllBlocks(t=>{const n={};t.serialize(n),e.allBlocks.push(n)}),e.executionContexts=[];for(const n of this._executionContexts){const i={};n.serialize(i,t),e.executionContexts.push(i)}}static GetDataOutConnectionByUniqueId(e,t){for(const n of e)for(const e of n.dataOutputs)if(e.uniqueId===t)return e;throw new Error("Could not find data out connection with unique id "+t)}static GetSignalInConnectionByUniqueId(e,t){for(const n of e)if(n instanceof Hs)for(const e of n.signalInputs)if(e.uniqueId===t)return e;throw new Error("Could not find signal in connection with unique id "+t)}static Parse(e,t){var n;const i=t.coordinator.createGraph(),r=[],s=null!==(n=t.valueParseFunction)&&void 0!==n?n:ks;for(const n of e.allBlocks){const e=Vs.Parse(n,{scene:t.coordinator.config.scene,pathConverter:t.pathConverter,valueParseFunction:s});r.push(e),e instanceof Xs&&i.addEventBlock(e)}for(const e of r){for(const t of e.dataInputs)for(const e of t.connectedPointIds){const n=Qs.GetDataOutConnectionByUniqueId(r,e);t.connectTo(n)}if(e instanceof Hs)for(const t of e.signalOutputs)for(const e of t.connectedPointIds){const n=Qs.GetSignalInConnectionByUniqueId(r,e);t.connectTo(n)}}for(const t of e.executionContexts)js.Parse(t,{graph:i,valueParseFunction:s});return i}constructor(e){this._eventBlocks=[],this._executionContexts=[],this.state=0,this._scene=e.scene,this._coordinator=e.coordinator,this._sceneDisposeObserver=this._scene.onDisposeObservable.add(()=>this.dispose())}}class Zs{createGraph(){const e=new Qs({scene:this.config.scene,coordinator:this});return this._flowGraphs.push(e),e}removeGraph(e){const t=this._flowGraphs.indexOf(e);-1!==t&&(e.dispose(),this._flowGraphs.splice(t,1))}start(){this._flowGraphs.forEach(e=>e.start())}dispose(){var e;this._flowGraphs.forEach(e=>e.dispose()),this._flowGraphs.length=0;const t=null!==(e=Zs.SceneCoordinators.get(this.config.scene))&&void 0!==e?e:[],n=t.indexOf(this);-1!==n&&t.splice(n,1)}serialize(e,t){e._flowGraphs=[],this._flowGraphs.forEach(n=>{const i={};n.serialize(i,t),e._flowGraphs.push(i)})}static Parse(e,t){var n,i;const r=null!==(n=t.valueParseFunction)&&void 0!==n?n:ks,s=new Zs({scene:t.scene});return null===(i=e._flowGraphs)||void 0===i||i.forEach(e=>{Qs.Parse(e,{coordinator:s,valueParseFunction:r,pathConverter:t.pathConverter})}),s}get flowGraphs(){return this._flowGraphs}getCustomEventObservable(e){let t=this._customEventsMap.get(e);return t||(t=new _.a,this._customEventsMap.set(e,t)),t}notifyCustomEvent(e,t){const n=this._customEventsMap.get(e);n&&n.notifyObservers(t)}constructor(e){var t;this.config=e,this._flowGraphs=[],this._customEventsMap=new Map,this.config.scene.onDisposeObservable.add(()=>{this.dispose()}),(null!==(t=Zs.SceneCoordinators.get(this.config.scene))&&void 0!==t?t:[]).push(this)}}Zs.SceneCoordinators=new Map;class $s extends Xs{_preparePendingTasks(e){if(!e._getExecutionVariable(this,"sceneReadyObserver")){const t=e.configuration.scene.onReadyObservable.add(()=>{this._execute(e)});e._setExecutionVariable(this,"sceneReadyObserver",t)}}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"sceneReadyObserver");e.configuration.scene.onReadyObservable.remove(t),e._deleteExecutionVariable(this,"sceneReadyObserver")}getClassName(){return $s.ClassName}}$s.ClassName="FGSceneReadyEventBlock",Object(Je.b)("FGSceneReadyEventBlock",$s);class Js extends Xs{_preparePendingTasks(e){if(!e._getExecutionVariable(this,"sceneBeforeRender")){const t=e.configuration.scene.onBeforeRenderObservable.add(()=>{this._execute(e)});e._setExecutionVariable(this,"sceneBeforeRender",t)}}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"sceneBeforeRender");e.configuration.scene.onBeforeRenderObservable.remove(t),e._deleteExecutionVariable(this,"sceneBeforeRender")}getClassName(){return Js.ClassName}}Js.ClassName="FGSceneTickEventBlock",Object(Je.b)(Js.ClassName,Js);class ea extends Hs{constructor(e){super(e),this.out=this._registerSignalOutput("out")}}class ta extends ea{_execute(e){const t=this.message.getValue(e);T.a.Log(t),this.out._activateSignal(e)}getClassName(){return ta.ClassName}constructor(e){super(e),this.message=this.registerDataInput("message",Ms)}}ta.ClassName="FGConsoleLogBlock",Object(Je.b)(ta.ClassName,ta),function(e){e[e.INIT=0]="INIT",e[e.STARTED=1]="STARTED",e[e.ENDED=2]="ENDED"}(qs||(qs={}));class na{set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(1===this._state)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(1)}stop(){1===this._state&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,t=!1){this._contextObservable.remove(this._observer),this._setState(2),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}constructor(e){var t,n;this.onEachCountObservable=new _.a,this.onTimerAbortedObservable=new _.a,this.onTimerEndedObservable=new _.a,this.onStateChangedObservable=new _.a,this._observer=null,this._breakOnNextTick=!1,this._tick=e=>{const t=Date.now();this._timer=t-this._startTime;const n={startTime:this._startTime,currentTime:t,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:e},i=this._breakOnNextTick||this._breakCondition(n);i||this._timer>=this._timeToEnd?this._stop(n,i):this.onEachCountObservable.notifyObservers(n)},this._setState(0),this._contextObservable=e.contextObservable,this._observableParameters=null!==(t=e.observableParameters)&&void 0!==t?t:{},this._breakCondition=null!==(n=e.breakCondition)&&void 0!==n?n:()=>!1,this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}}class ia extends Ws{_preparePendingTasks(e){const t=this.timeout.getValue(e);if(void 0!==t&&t>=0){const n=e._getExecutionVariable(this,"runningTimers")||[],i=e.configuration.scene,r=new na({timeout:t,contextObservable:i.onBeforeRenderObservable,onEnded:()=>this._onEnded(r,e)});r.start(),n.push(r),e._setExecutionVariable(this,"runningTimers",n)}}_execute(e){this._startPendingTasks(e),this.out._activateSignal(e)}_onEnded(e,t){const n=t._getExecutionVariable(this,"runningTimers")||[],i=n.indexOf(e);-1!==i?n.splice(i,1):g.b.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),t._removePendingBlock(this),this.done._activateSignal(t)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"runningTimers")||[];for(const e of t)e.dispose();e._deleteExecutionVariable(this,"runningTimers")}getClassName(){return ia.ClassName}constructor(e){super(e),this.timeout=this.registerDataInput("timeout",Os)}}ia.ClassName="FGTimerBlock",Object(Je.b)("FGTimerBlock",ia);class ra extends ea{_execute(e){const t=this.config.eventId,n=this.dataInputs.map(t=>t.getValue(e));e.configuration.coordinator.notifyCustomEvent(t,n),this.out._activateSignal(e)}getClassName(){return ra.ClassName}constructor(e){super(e),this.config=e;for(let e=0;e<this.config.eventData.length;e++){const t=this.config.eventData[e];this.registerDataInput(t,Ms)}}}ra.ClassName="FGSendCustomEventBlock",Object(Je.b)("FGSendCustomEventBlock",ra);class sa extends Xs{_preparePendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);this._eventObserver=t.add(t=>{for(let n=0;n<t.length;n++)this.dataOutputs[n].setValue(t[n],e);this._execute(e)})}_cancelPendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);t?t.remove(this._eventObserver):g.b.Warn("FlowGraphReceiveCustomEventBlock: Missing observable for event "+this.config.eventId)}getClassName(){return sa.ClassName}serialize(e){super.serialize(e),e.eventId=this.config.eventId,e.eventData=this.config.eventData}constructor(e){super(e),this.config=e;for(let e=0;e<this.config.eventData.length;e++){const t=this.config.eventData[e];this.registerDataOutput(t,Ms)}}}sa.ClassName="FGReceiveCustomEventBlock",Object(Je.b)(sa.ClassName,sa);class aa extends Hs{_execute(e){for(let t=0;t<this.config.numberOutputFlows;t++)this.outFlows[t]._activateSignal(e)}getClassName(){return aa.ClassName}constructor(e){super(e),this.config=e,this.outFlows=[];for(let e=0;e<this.config.numberOutputFlows;e++)this.outFlows.push(this._registerSignalOutput(""+e))}}aa.ClassName="FGSequenceBlock",Object(Je.b)(aa.ClassName,aa);const oa=new RegExp(/\{(\w+)\}/g);class la{getAccessor(e,t){let n=this.path;for(const e of this.templatedInputs){const i=e.getValue(t).value;n=n.replace(`{${e.name}}`,i.toString())}return e.convert(n)}constructor(e,t){this.path=e,this.ownerBlock=t,this.templatedInputs=[];let n=oa.exec(e);for(;n;){const[,i]=n;this.templatedInputs.push(t.registerDataInput(i,Ns)),n=oa.exec(e)}}}class ca extends Vs{_updateOutputs(e){const t=this.templateComponent.getAccessor(this.config.pathConverter,e),n=t.info.get(t.object);this.value.setValue(n,e)}getClassName(){return ca.ClassName}serialize(e={}){super.serialize(e),e.config.path=this.config.path}constructor(e){super(e),this.config=e,this.value=this.registerDataOutput("value",Ms),this.templateComponent=new la(e.path,this)}}ca.ClassName="FGGetPropertyBlock",Object(Je.b)(ca.ClassName,ca);class da extends ea{_execute(e){const t=this.a.getValue(e),n=this.templateComponent.getAccessor(this.config.pathConverter,e);n.info.set(t,n.object),this.out._activateSignal(e)}serialize(e={}){super.serialize(e),e.config.path=this.config.path}getClassName(){return da.ClassName}constructor(e){super(e),this.config=e,this.a=this.registerDataInput("a",Ms),this.templateComponent=new la(e.path,this)}}da.ClassName="FGSetPropertyBlock",Object(Je.b)("FGSetPropertyBlock",da);class ha extends Vs{_updateOutputs(e){const t=e._getExecutionVariable(this,"cachedExecutionId"),n=e._getExecutionVariable(this,"cachedOperationValue");if(void 0!==n&&t===e.executionId)this.value.setValue(n,e);else{const t=this._doOperation(e);e._setExecutionVariable(this,"cachedOperationValue",t),e._setExecutionVariable(this,"cachedExecutionId",e.executionId),this.value.setValue(t,e)}}constructor(e,t){super(t),this.value=this.registerDataOutput("value",e)}}class ua extends ha{_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e))}getClassName(){return this._className}constructor(e,t,n,i,r,s){super(n,s),this._operation=i,this._className=r,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t)}}class fa extends ha{_doOperation(e){return this._operation()}getClassName(){return this._className}constructor(e,t,n,i){super(e,i),this._operation=t,this._className=n}}class ma extends ha{_doOperation(e){return this._operation(this.a.getValue(e))}getClassName(){return this._className}constructor(e,t,n,i,r){super(t,r),this._operation=n,this._className=i,this.a=this.registerDataInput("a",e)}}class pa extends ha{_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e),this.c.getValue(e))}getClassName(){return this._className}constructor(e,t,n,i,r,s,a){super(i,a),this._operation=r,this._className=s,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t),this.c=this.registerDataInput("c",n)}}function ga(e){return e.getClassName?e.getClassName():""}function _a(e,t){return"Vector2"===e&&"Vector2"===t||"Vector3"===e&&"Vector3"===t||"Vector4"===e&&"Vector4"===t}function va(e,t){return"Matrix"===e&&"Matrix"===t}function Ea(e,t){return"FlowGraphInteger"===e&&"FlowGraphInteger"===t}class Ta extends ua{_polymorphicAdd(e,t){const n=ga(e),i=ga(t);return _a(n,i)||va(n,i)||Ea(n,i)?e.add(t):e+t}constructor(e){super(Ms,Ms,Ms,(e,t)=>this._polymorphicAdd(e,t),Ta.ClassName,e)}}Ta.ClassName="FGAddBlock",Object(Je.b)(Ta.ClassName,Ta);class Sa extends ua{_polymorphicAdd(e,t){const n=ga(e),i=ga(t);return _a(n,i)||Ea(n,i)?e.subtract(t):va(n,i)?e.add(t.scale(-1)):e-t}constructor(e){super(Ms,Ms,Ms,(e,t)=>this._polymorphicAdd(e,t),Sa.ClassName,e)}}Sa.ClassName="FGSubBlock",Object(Je.b)(Sa.ClassName,Sa);class Aa extends ua{_polymorphicMultiply(e,t){const n=ga(e),i=ga(t);return _a(n,i)||Ea(n,i)?e.multiply(t):va(n,i)?r.a.FromValues(e.m[0]*t.m[0],e.m[4]*t.m[4],e.m[8]*t.m[8],e.m[12]*t.m[12],e.m[1]*t.m[1],e.m[5]*t.m[5],e.m[9]*t.m[9],e.m[13]*t.m[13],e.m[2]*t.m[2],e.m[6]*t.m[6],e.m[10]*t.m[10],e.m[14]*t.m[14],e.m[3]*t.m[3],e.m[7]*t.m[7],e.m[11]*t.m[11],e.m[15]*t.m[15]):e*t}constructor(e){super(Ms,Ms,Ms,(e,t)=>this._polymorphicMultiply(e,t),Aa.ClassName,e)}}Aa.ClassName="FGMultiplyBlock",Object(Je.b)(Aa.ClassName,Aa);class ba extends ua{_polymorphicDivide(e,t){const n=ga(e),i=ga(t);return _a(n,i)||Ea(n,i)?e.divide(t):va(n,i)?r.a.FromValues(e.m[0]/t.m[0],e.m[4]/t.m[4],e.m[8]/t.m[8],e.m[12]/t.m[12],e.m[1]/t.m[1],e.m[5]/t.m[5],e.m[9]/t.m[9],e.m[13]/t.m[13],e.m[2]/t.m[2],e.m[6]/t.m[6],e.m[10]/t.m[10],e.m[14]/t.m[14],e.m[3]/t.m[3],e.m[7]/t.m[7],e.m[11]/t.m[11],e.m[15]/t.m[15]):e/t}constructor(e){super(Ms,Ms,Ms,(e,t)=>this._polymorphicDivide(e,t),ba.ClassName,e)}}ba.ClassName="FGDivideBlock",Object(Je.b)(ba.ClassName,ba);class Ia extends fa{constructor(e){super(Os,()=>Math.random(),Ia.ClassName,e)}}Ia.ClassName="FGRandomBlock",Object(Je.b)(Ia.ClassName,Ia);class Ra extends ua{_polymorphicDot(e,t){switch(ga(e)){case"Vector2":return r.d.Dot(e,t);case"Vector3":return r.e.Dot(e,t);case"Vector4":return r.f.Dot(e,t);default:throw new Error(`Cannot get dot product of ${e} and ${t}`)}}constructor(e){super(Ms,Ms,Os,(e,t)=>this._polymorphicDot(e,t),Ra.ClassName,e)}}Ra.ClassName="FGDotBlock",Object(Je.b)(Ra.ClassName,Ra);class Ca extends fa{constructor(e){super(Os,()=>Math.E,Ca.ClassName,e)}}Ca.ClassName="FGEBlock",Object(Je.b)(Ca.ClassName,Ca);class ya extends fa{constructor(e){super(Os,()=>Math.PI,ya.ClassName,e)}}ya.ClassName="FGPIBlock",Object(Je.b)(ya.ClassName,ya);class Ma extends fa{constructor(e){super(Os,()=>Number.POSITIVE_INFINITY,Ma.ClassName,e)}}Ma.ClassName="FGInfBlock",Object(Je.b)(Ma.ClassName,Ma);class Oa extends fa{constructor(e){super(Os,()=>Number.NaN,Oa.ClassName,e)}}function xa(e,t){switch(ga(e)){case"FlowGraphInteger":return new Cs(t(e.value));case"Vector2":return new r.d(t(e.x),t(e.y));case"Vector3":return new r.e(t(e.x),t(e.y),t(e.z));case"Vector4":return new r.f(t(e.x),t(e.y),t(e.z),t(e.w));case"Matrix":return r.a.FromValues(t(e.m[0]),t(e.m[4]),t(e.m[8]),t(e.m[12]),t(e.m[1]),t(e.m[5]),t(e.m[9]),t(e.m[13]),t(e.m[2]),t(e.m[6]),t(e.m[10]),t(e.m[14]),t(e.m[3]),t(e.m[7]),t(e.m[11]),t(e.m[15]));default:return t(e)}}Oa.ClassName="FGNaNBlock",Object(Je.b)(Oa.ClassName,Oa);class Da extends ma{_polymorphicAbs(e){return xa(e,Math.abs)}constructor(e){super(Ms,Ms,e=>this._polymorphicAbs(e),Da.ClassName,e)}}Da.ClassName="FGAbsBlock",Object(Je.b)(Da.ClassName,Da);class Pa extends ma{_polymorphicSign(e){return xa(e,Math.sign)}constructor(e){super(Ms,Ms,e=>this._polymorphicSign(e),Pa.ClassName,e)}}Pa.ClassName="FGSignBlock",Object(Je.b)(Pa.ClassName,Pa);class La extends ma{_polymorphicTrunc(e){return xa(e,Math.trunc)}constructor(e){super(Ms,Ms,e=>this._polymorphicTrunc(e),La.ClassName,e)}}La.ClassName="FGTruncBlock",Object(Je.b)(La.ClassName,La);class Na extends ma{_polymorphicFloor(e){return xa(e,Math.floor)}constructor(e){super(Ms,Ms,e=>this._polymorphicFloor(e),Na.ClassName,e)}}Na.ClassName="FGFloorBlock",Object(Je.b)(Na.ClassName,Na);class Fa extends ma{_polymorphicCeiling(e){return xa(e,Math.ceil)}constructor(e){super(Ms,Ms,e=>this._polymorphicCeiling(e),Fa.ClassName,e)}}Fa.ClassName="FGCeilBlock",Object(Je.b)(Fa.ClassName,Fa);class wa extends ma{_polymorphicFract(e){return xa(e,e=>e-Math.floor(e))}constructor(e){super(Ms,Ms,e=>this._polymorphicFract(e),wa.ClassName,e)}}wa.ClassName="FGFractBlock",Object(Je.b)(wa.ClassName,wa);class Ua extends ma{_polymorphicNeg(e){return xa(e,e=>-e)}constructor(e){super(Ms,Ms,e=>this._polymorphicNeg(e),Ua.ClassName,e)}}function Ba(e,t,n){switch(ga(e)){case"FlowGraphInteger":return new Cs(n(e.value,t.value));case"Vector2":return new r.d(n(e.x,t.x),n(e.y,t.y));case"Vector3":return new r.e(n(e.x,t.x),n(e.y,t.y),n(e.z,t.z));case"Vector4":return new r.f(n(e.x,t.x),n(e.y,t.y),n(e.z,t.z),n(e.w,t.w));case"Matrix":return r.a.FromValues(n(e.m[0],t.m[0]),n(e.m[4],t.m[4]),n(e.m[8],t.m[8]),n(e.m[12],t.m[12]),n(e.m[1],t.m[1]),n(e.m[5],t.m[5]),n(e.m[9],t.m[9]),n(e.m[13],t.m[13]),n(e.m[2],t.m[2]),n(e.m[6],t.m[6]),n(e.m[10],t.m[10]),n(e.m[14],t.m[14]),n(e.m[3],t.m[3]),n(e.m[7],t.m[7]),n(e.m[11],t.m[11]),n(e.m[15],t.m[15]));default:return n(e,t)}}Ua.ClassName="FGNegBlock",Object(Je.b)(Ua.ClassName,Ua);class ka extends ua{_polymorphicRemainder(e,t){return Ba(e,t,(e,t)=>e%t)}constructor(e){super(Ms,Ms,Ms,(e,t)=>this._polymorphicRemainder(e,t),ka.ClassName,e)}}ka.ClassName="FGRemainderBlock",Object(Je.b)(ka.ClassName,ka);class Va extends ua{_polymorphicMin(e,t){return Ba(e,t,Math.min)}constructor(e){super(Ms,Ms,Ms,(e,t)=>this._polymorphicMin(e,t),Va.ClassName,e)}}Va.ClassName="FGMinBlock",Object(Je.b)(Va.ClassName,Va);class Ga extends ua{_polymorphicMax(e,t){return Ba(e,t,Math.max)}constructor(e){super(Ms,Ms,Ms,(e,t)=>this._polymorphicMax(e,t),Ga.ClassName,e)}}function Ha(e,t,n){return Math.min(Math.max(e,Math.min(t,n)),Math.max(t,n))}function Wa(e,t,n,i){switch(ga(e)){case"FlowGraphInteger":return new Cs(i(e.value,t.value,n.value));case"Vector2":return new r.d(i(e.x,t.x,n.x),i(e.y,t.y,n.y));case"Vector3":return new r.e(i(e.x,t.x,n.x),i(e.y,t.y,n.y),i(e.z,t.z,n.z));case"Vector4":return new r.f(i(e.x,t.x,n.x),i(e.y,t.y,n.y),i(e.z,t.z,n.z),i(e.w,t.w,n.w));case"Matrix":return r.a.FromValues(i(e.m[0],t.m[0],n.m[0]),i(e.m[4],t.m[4],n.m[4]),i(e.m[8],t.m[8],n.m[8]),i(e.m[12],t.m[12],n.m[12]),i(e.m[1],t.m[1],n.m[1]),i(e.m[5],t.m[5],n.m[5]),i(e.m[9],t.m[9],n.m[9]),i(e.m[13],t.m[13],n.m[13]),i(e.m[2],t.m[2],n.m[2]),i(e.m[6],t.m[6],n.m[6]),i(e.m[10],t.m[10],n.m[10]),i(e.m[14],t.m[14],n.m[14]),i(e.m[3],t.m[3],n.m[3]),i(e.m[7],t.m[7],n.m[7]),i(e.m[11],t.m[11],n.m[11]),i(e.m[15],t.m[15],n.m[15]));default:return i(e,t,n)}}Ga.ClassName="FGMaxBlock",Object(Je.b)(Ga.ClassName,Ga);class Xa extends pa{_polymorphicClamp(e,t,n){return Wa(e,t,n,Ha)}constructor(e){super(Ms,Ms,Ms,Ms,(e,t,n)=>this._polymorphicClamp(e,t,n),Xa.ClassName,e)}}function ja(e){return Math.min(Math.max(e,0),1)}Xa.ClassName="FGClampBlock",Object(Je.b)(Xa.ClassName,Xa);class za extends ma{_polymorphicSaturate(e){return xa(e,ja)}constructor(e){super(Ms,Ms,e=>this._polymorphicSaturate(e),za.ClassName,e)}}za.ClassName="FGSaturateBlock",Object(Je.b)(za.ClassName,za);class Ka extends pa{_interpolate(e,t,n){return(1-n)*e+n*t}_polymorphicInterpolate(e,t,n){return Wa(e,t,n,this._interpolate)}constructor(e){super(Ms,Ms,Ms,Ms,(e,t,n)=>this._polymorphicInterpolate(e,t,n),Ka.ClassName,e)}}Ka.ClassName="FGInterpolateBlock",Object(Je.b)(Ka.ClassName,Ka);class Ya extends ua{_polymorphicEq(e,t){const n=ga(e),i=ga(t);return _a(n,i)||va(n,i)||Ea(n,i)?e.equals(t):e===t}constructor(e){super(Ms,Ms,xs,(e,t)=>this._polymorphicEq(e,t),Ya.ClassName,e)}}function qa(e,t,n){const i=ga(e);if(i===ga(t)){if(""===i)return n(e,t);if("FlowGraphInteger"===i)return n(e.value,t.value);throw new Error(`Cannot compare ${e} and ${t}`)}throw new Error(`${e} and ${t} are of different types.`)}Ya.ClassName="FGEqBlock",Object(Je.b)(Ya.ClassName,Ya);class Qa extends ua{_polymorphicLessThan(e,t){return qa(e,t,(e,t)=>e<t)}constructor(e){super(Ms,Ms,xs,(e,t)=>this._polymorphicLessThan(e,t),Qa.ClassName,e)}}Qa.ClassName="FGLessThanBlock",Object(Je.b)(Qa.ClassName,Qa);class Za extends ua{_polymorphicLessThanOrEqual(e,t){return qa(e,t,(e,t)=>e<=t)}constructor(e){super(Ms,Ms,xs,(e,t)=>this._polymorphicLessThanOrEqual(e,t),Za.ClassName,e)}}Za.ClassName="FGLessThanOrEqualBlock";class $a extends ua{_polymorphicGreaterThan(e,t){return qa(e,t,(e,t)=>e>t)}constructor(e){super(Ms,Ms,xs,(e,t)=>this._polymorphicGreaterThan(e,t),$a.ClassName,e)}}$a.ClassName="FGGreaterThanBlock",Object(Je.b)($a.ClassName,$a);class Ja extends ua{_polymorphicGreaterThanOrEqual(e,t){return qa(e,t,(e,t)=>e>=t)}constructor(e){super(Ms,Ms,xs,(e,t)=>this._polymorphicGreaterThanOrEqual(e,t),Ja.ClassName,e)}}Ja.ClassName="FGGreaterThanOrEqualBlock",Object(Je.b)(Ja.ClassName,Ja);class eo extends ma{_polymorphicIsNan(e){const t=ga(e);if(""===t)return isNaN(e);if("FlowGraphInteger"===t)return isNaN(e.value);throw new Error("Cannot get NaN of "+e)}constructor(e){super(Ms,xs,e=>this._polymorphicIsNan(e),eo.ClassName,e)}}eo.ClassName="FGIsNanBlock",Object(Je.b)(eo.ClassName,eo);class to extends ma{_polymorphicIsInf(e){const t=ga(e);if(""===t)return!isFinite(e);if("FlowGraphInteger"===t)return!isFinite(e.value);throw new Error("Cannot get isInf of "+e)}constructor(e){super(Ms,xs,e=>this._polymorphicIsInf(e),to.ClassName,e)}}to.ClassName="FGIsInfBlock";class no extends ma{_degToRad(e){return e*Math.PI/180}_polymorphicDegToRad(e){return xa(e,this._degToRad)}constructor(e){super(Ms,Ms,e=>this._polymorphicDegToRad(e),no.ClassName,e)}}no.ClassName="FGDegToRadBlock",Object(Je.b)(no.ClassName,no);class io extends ma{_radToDeg(e){return 180*e/Math.PI}_polymorphicRadToDeg(e){return xa(e,this._radToDeg)}constructor(e){super(Ms,Ms,e=>this._polymorphicRadToDeg(e),io.ClassName,e)}}io.ClassName="FGRadToDegBlock",Object(Je.b)(io.ClassName,io);class ro extends ma{_polymorphicSin(e){return xa(e,Math.sin)}constructor(e){super(Ms,Ms,e=>this._polymorphicSin(e),ro.ClassName,e)}}ro.ClassName="FGSinBlock",Object(Je.b)(ro.ClassName,ro);class so extends ma{_polymorphicCos(e){return xa(e,Math.cos)}constructor(e){super(Ms,Ms,e=>this._polymorphicCos(e),so.ClassName,e)}}so.ClassName="FGCosBlock",Object(Je.b)(so.ClassName,so);class ao extends ma{_polymorphicTan(e){return xa(e,Math.tan)}constructor(e){super(Ms,Ms,e=>this._polymorphicTan(e),ao.ClassName,e)}}ao.ClassName="FGTanBlock",Object(Je.b)(ao.ClassName,ao);class oo extends ma{_polymorphicAsin(e){return xa(e,Math.asin)}constructor(e){super(Ms,Ms,e=>this._polymorphicAsin(e),oo.ClassName,e)}}oo.ClassName="FGAsinBlock",Object(Je.b)(oo.ClassName,oo);class lo extends ma{_polymorphicAcos(e){return xa(e,Math.acos)}constructor(e){super(Ms,Ms,e=>this._polymorphicAcos(e),lo.ClassName,e)}}lo.ClassName="FGAcosBlock",Object(Je.b)(lo.ClassName,lo);class co extends ma{_polymorphicAtan(e){return xa(e,Math.atan)}constructor(e){super(Ms,Ms,e=>this._polymorphicAtan(e),co.ClassName,e)}}co.ClassName="FGAtanBlock",Object(Je.b)(co.ClassName,co);class ho extends ua{_polymorphicAtan2(e,t){return Ba(e,t,Math.atan2)}constructor(e){super(Ms,Ms,Ms,(e,t)=>this._polymorphicAtan2(e,t),ho.ClassName,e)}}ho.ClassName="FGAtan2Block",Object(Je.b)(ho.ClassName,ho);class uo extends ma{_polymorphicSinh(e){return xa(e,Math.sinh)}constructor(e){super(Ms,Ms,e=>this._polymorphicSinh(e),uo.ClassName,e)}}uo.ClassName="FGSinhBlock",Object(Je.b)(uo.ClassName,uo);class fo extends ma{_polymorphicCosh(e){return xa(e,Math.cosh)}constructor(e){super(Ms,Ms,e=>this._polymorphicCosh(e),fo.ClassName,e)}}fo.ClassName="FGCoshBlock",Object(Je.b)(fo.ClassName,fo);class mo extends ma{_polymorphicTanh(e){return xa(e,Math.tanh)}constructor(e){super(Ms,Ms,e=>this._polymorphicTanh(e),mo.ClassName,e)}}mo.ClassName="FGTanhBlock",Object(Je.b)(mo.ClassName,mo);class po extends ma{_polymorphicAsinh(e){return xa(e,Math.asinh)}constructor(e){super(Ms,Os,e=>this._polymorphicAsinh(e),po.ClassName,e)}}po.ClassName="FGAsinhBlock",Object(Je.b)(po.ClassName,po);class go extends ma{_polymorphicAcosh(e){return xa(e,Math.acosh)}constructor(e){super(Ms,Os,e=>this._polymorphicAcosh(e),go.ClassName,e)}}go.ClassName="FGAcoshBlock",Object(Je.b)(go.ClassName,go);class _o extends ma{_polymorphicAtanh(e){return xa(e,Math.atanh)}constructor(e){super(Ms,Os,e=>this._polymorphicAtanh(e),_o.ClassName,e)}}_o.ClassName="FGAtanhBlock",Object(Je.b)(_o.ClassName,_o);class vo extends ma{_polymorphicExp(e){return xa(e,Math.exp)}constructor(e){super(Ms,Os,e=>this._polymorphicExp(e),vo.ClassName,e)}}vo.ClassName="FGExpBlock",Object(Je.b)(vo.ClassName,vo);class Eo extends ma{_polymorphicLog(e){return xa(e,Math.log)}constructor(e){super(Ms,Os,e=>this._polymorphicLog(e),Eo.ClassName,e)}}Eo.ClassName="FGLogBlock",Object(Je.b)(Eo.ClassName,Eo);class To extends ma{_polymorphicLog2(e){return xa(e,Math.log2)}constructor(e){super(Ms,Os,e=>this._polymorphicLog2(e),To.ClassName,e)}}To.ClassName="FGLog2Block",Object(Je.b)(To.ClassName,To);class So extends ma{_polymorphicLog10(e){return xa(e,Math.log10)}constructor(e){super(Ms,Os,e=>this._polymorphicLog10(e),So.ClassName,e)}}So.ClassName="FGLog10Block",Object(Je.b)(So.ClassName,So);class Ao extends ma{_polymorphicSqrt(e){return xa(e,Math.sqrt)}constructor(e){super(Ms,Os,e=>this._polymorphicSqrt(e),Ao.ClassName,e)}}Ao.ClassName="FGSqrtBlock",Object(Je.b)(Ao.ClassName,Ao);class bo extends ma{_polymorphicCubeRoot(e){return xa(e,Math.cbrt)}constructor(e){super(Ms,Os,e=>this._polymorphicCubeRoot(e),bo.ClassName,e)}}bo.ClassName="FGCubeRootBlock",Object(Je.b)(bo.ClassName,bo);class Io extends ua{_polymorphicPow(e,t){return Ba(e,t,Math.pow)}constructor(e){super(Ms,Os,Os,(e,t)=>this._polymorphicPow(e,t),Io.ClassName,e)}}Io.ClassName="FGPowBlock",Object(Je.b)(Io.ClassName,Io);class Ro extends ma{_polymorphicLength(e){switch(ga(e)){case"Vector2":case"Vector3":case"Vector4":return e.length();default:throw new Error("Cannot compute length of value "+e)}}constructor(e){super(Ms,Os,e=>this._polymorphicLength(e),Ro.ClassName,e)}}Ro.ClassName="FGLengthBlock",Object(Je.b)(Ro.ClassName,Ro);class Co extends ma{_polymorphicNormalize(e){switch(ga(e)){case"Vector2":case"Vector3":case"Vector4":return e.normalize();default:throw new Error("Cannot normalize value "+e)}}constructor(e){super(Ms,Ms,e=>this._polymorphicNormalize(e),Co.ClassName,e)}}Co.ClassName="FGNormalizeBlock",Object(Je.b)(Co.ClassName,Co);class yo extends ua{constructor(e){super(Ps,Ps,Ps,(e,t)=>r.e.Cross(e,t),yo.ClassName,e)}}yo.ClassName="FGCrossBlock",Object(Je.b)(yo.ClassName,yo);class Mo extends ua{constructor(e){super(Ds,Os,Ds,(e,t)=>r.d.Transform(e,r.a.RotationZ(t)),Mo.ClassName,e)}}Mo.ClassName="FGRotate2DBlock",Object(Je.b)(Mo.ClassName,Mo);class Oo extends pa{constructor(e){super(Ps,Ps,Os,Ps,(e,t,n)=>r.e.TransformCoordinates(e,r.a.RotationAxis(t,n)),Oo.ClassName,e)}}Oo.ClassName="FGRotate3DBlock",Object(Je.b)(Oo.ClassName,Oo);class xo extends ma{constructor(e){super(Ls,Ls,e=>r.a.Transpose(e),xo.ClassName,e)}}xo.ClassName="FGTransposeBlock",Object(Je.b)(xo.ClassName,xo);class Do extends ma{constructor(e){super(Ls,Os,e=>e.determinant(),Do.ClassName,e)}}Do.ClassName="FGDeterminantBlock",Object(Je.b)(Do.ClassName,Do);class Po extends ma{constructor(e){super(Ls,Ls,e=>r.a.Invert(e),Po.ClassName,e)}}Po.ClassName="FGInvertMatrixBlock",Object(Je.b)(Po.ClassName,Po);class Lo extends ua{constructor(e){super(Ls,Ls,Ls,(e,t)=>t.multiply(e),Lo.ClassName,e)}}Lo.ClassName="FGMatMulBlock",Object(Je.b)(Lo.ClassName,Lo);class No extends ma{constructor(e){super(Ns,Ns,e=>new Cs(~e.value),No.ClassName,e)}}No.ClassName="FGBitwiseNotBlock",Object(Je.b)(No.ClassName,No);class Fo extends ua{constructor(e){super(Ns,Ns,Ns,(e,t)=>new Cs(e.value&t.value),Fo.ClassName,e)}}Fo.ClassName="FGBitwiseAndBlock",Object(Je.b)(Fo.ClassName,Fo);class wo extends ua{constructor(e){super(Ns,Ns,Ns,(e,t)=>new Cs(e.value|t.value),wo.ClassName,e)}}wo.ClassName="FGBitwiseOrBlock",Object(Je.b)(wo.ClassName,wo);class Uo extends ua{constructor(e){super(Ns,Ns,Ns,(e,t)=>new Cs(e.value^t.value),Uo.ClassName,e)}}Uo.ClassName="FGBitwiseXorBlock",Object(Je.b)(Uo.ClassName,Uo);class Bo extends ua{constructor(e){super(Ns,Ns,Ns,(e,t)=>new Cs(e.value<<t.value),Bo.ClassName,e)}}Bo.ClassName="FGBitwiseLeftShiftBlock",Object(Je.b)(Bo.ClassName,Bo);class ko extends ua{constructor(e){super(Ns,Ns,Ns,(e,t)=>new Cs(e.value>>t.value),ko.ClassName,e)}}ko.ClassName="FGBitwiseRightShiftBlock",Object(Je.b)(ko.ClassName,ko);class Vo extends ma{constructor(e){super(Ns,Ns,e=>new Cs(Math.clz32(e.value)),Vo.ClassName,e)}}Vo.ClassName="FGCountLeadingZerosBlock",Object(Je.b)(Vo.ClassName,Vo);class Go extends ma{constructor(e){super(Ns,Ns,e=>new Cs(e.value?31-Math.clz32(e.value&-e.value):32),Go.ClassName,e)}}Go.ClassName="FGCountTrailingZerosBlock",Object(Je.b)(Go.ClassName,Go);class Ho extends ma{constructor(e){super(Ns,Ns,e=>new Cs(function(e){let t=0;for(;e;)t+=1&e,e>>=1;return t}(e.value)),Ho.ClassName,e)}}Ho.ClassName="FGCountOneBitsBlock",Object(Je.b)(Ho.ClassName,Ho);class Wo extends ea{_execute(e,t){if(t===this.reset)this.value.setValue(this.config.startIndex,e);else{const t=this.value.getValue(e);t.value<this.n.getValue(e).value&&(this.value.setValue(new Cs(t.value+1),e),this.out._activateSignal(e))}}getClassName(){return Wo.ClassName}constructor(e={startIndex:new Cs(0)}){super(e),this.config=e,this.reset=this._registerSignalInput("reset"),this.n=this.registerDataInput("n",Ns),this.value=this.registerDataOutput("value",Ns)}}Wo.ClassName="FGDoNBlock",Object(Je.b)(Wo.ClassName,Wo);class Xo extends Vs{_updateOutputs(e){const t=this.config.variableName;e.hasVariable(t)&&this.output.setValue(e.getVariable(t),e)}getClassName(){return Xo.ClassName}serialize(e){super.serialize(e),e.config.variableName=this.config.variableName}constructor(e){super(e),this.config=e,this.output=this.registerDataOutput(e.variableName,Ms)}}Xo.ClassName="FGGetVariableBlock",Object(Je.b)(Xo.ClassName,Xo);class jo extends ea{_execute(e){const t=this.config.variableName,n=this.input.getValue(e);e.setVariable(t,n),this.out._activateSignal(e)}getClassName(){return jo.ClassName}constructor(e){super(e),this.config=e,this.input=this.registerDataInput(e.variableName,Ms)}}jo.ClassName="FGSetVariableBlock",Object(Je.b)(jo.ClassName,jo);class zo extends ea{_execute(e,t){var n;let i=this.condition.getValue(e);for(null!==(n=this.config)&&void 0!==n&&n.isDo&&!i&&this.loopBody._activateSignal(e);i;)this.loopBody._activateSignal(e),i=this.condition.getValue(e);this.out._activateSignal(e)}getClassName(){return zo.ClassName}serialize(e){var t;super.serialize(e),e.isDo=null===(t=this.config)||void 0===t?void 0:t.isDo}constructor(e){super(e),this.config=e,this.condition=this.registerDataInput("condition",xs),this.loopBody=this._registerSignalOutput("loopBody")}}zo.ClassName="FGWhileLoopBlock",Object(Je.b)(zo.ClassName,zo);const Ko={"lifecycle/onStart":$s.ClassName,"lifecycle/onTick":Js.ClassName,log:ta.ClassName,"flow/delay":ia.ClassName,"customEvent/send":ra.ClassName,"customEvent/receive":sa.ClassName,"flow/sequence":aa.ClassName,"world/get":ca.ClassName,"world/set":da.ClassName,"flow/doN":Wo.ClassName,"variable/get":Xo.ClassName,"variable/set":jo.ClassName,"flow/whileLoop":zo.ClassName,"math/random":Ia.ClassName,"math/e":Ca.ClassName,"math/pi":ya.ClassName,"math/inf":Ma.ClassName,"math/nan":Oa.ClassName,"math/abs":Da.ClassName,"math/sign":Pa.ClassName,"math/trunc":La.ClassName,"math/floor":Na.ClassName,"math/ceil":Fa.ClassName,"math/fract":wa.ClassName,"math/neg":Ua.ClassName,"math/add":Ta.ClassName,"math/sub":Sa.ClassName,"math/mul":Aa.ClassName,"math/div":ba.ClassName,"math/rem":ka.ClassName,"math/min":Va.ClassName,"math/max":Ga.ClassName,"math/clamp":Xa.ClassName,"math/saturate":za.ClassName,"math/mix":Ka.ClassName,"math/eq":Ya.ClassName,"math/lt":Qa.ClassName,"math/le":Za.ClassName,"math/gt":$a.ClassName,"math/ge":Ja.ClassName,"math/isnan":eo.ClassName,"math/isinf":to.ClassName,"math/rad":no.ClassName,"math/deg":io.ClassName,"math/sin":ro.ClassName,"math/cos":so.ClassName,"math/tan":ao.ClassName,"math/asin":oo.ClassName,"math/acos":lo.ClassName,"math/atan":co.ClassName,"math/atan2":ho.ClassName,"math/sinh":uo.ClassName,"math/cosh":fo.ClassName,"math/tanh":mo.ClassName,"math/asinh":po.ClassName,"math/acosh":go.ClassName,"math/atanh":_o.ClassName,"math/exp":vo.ClassName,"math/log":Eo.ClassName,"math/log2":To.ClassName,"math/log10":So.ClassName,"math/sqrt":Ao.ClassName,"math/cbrt":bo.ClassName,"math/pow":Io.ClassName,"math/length":Ro.ClassName,"math/normalize":Co.ClassName,"math/dot":Ra.ClassName,"math/cross":yo.ClassName,"math/rotate2d":Mo.ClassName,"math/rotate3d":Oo.ClassName,"math/transpose":xo.ClassName,"math/determinant":Do.ClassName,"math/inverse":Po.ClassName,"math/matmul":Lo.ClassName,"math/not":No.ClassName,"math/and":Fo.ClassName,"math/or":wo.ClassName,"math/xor":Uo.ClassName,"math/asr":ko.ClassName,"math/lsl":Bo.ClassName,"math/clz":Vo.ClassName,"math/ctz":Go.ClassName,"math/popcnt":Ho.ClassName},Yo={float2:"Vector2",float3:"Vector3",float4:"Vector4",float4x4:"Matrix",int:"FlowGraphInteger"};function qo(e,t,n){if(void 0!==e.type){const i=t.types&&t.types[e.type];if(!i)throw new Error(`${n}: Unknown type: ${e.type}`);const r=i.signature;if(!r)throw new Error(`${n}: Type ${e.type} has no signature`);const s=Yo[r];return{value:e.value,className:s}}return e.value}function Qo(e,t,n){const i=Ko[t.type];if(!i)throw new Error(`/extensions/KHR_interactivity/nodes/${e}: Unknown block type: ${t.type}`);const r=e.toString();return{className:i,config:function(e,t,n){var i;const r={},s=null!==(i=e.configuration)&&void 0!==i?i:[];for(const e of s)if("customEvent"===e.id){const i=t.customEvents&&t.customEvents[e.value];if(!i)throw new Error(`/extensions/KHR_interactivity/nodes/${n}: Unknown custom event: ${e.value}`);r.eventId=i.id,r.eventData=i.values.map(e=>e.id)}else if("variable"===e.id){const i=t.variables&&t.variables[e.value];if(!i)throw new Error(`/extensions/KHR_interactivity/nodes/${n}: Unknown variable: ${e.value}`);r.variableName=i.id}else if("path"===e.id){const t=e.value;r.path=t}else r[e.id]=qo(e,t,"/extensions/KHR_interactivity/nodes/"+n);return r}(t,n,r),uniqueId:r,metadata:t.metadata,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[]}}class Zo extends ls{constructor(e){super(e,$o)}}const $o={nodes:{__array__:{__target__:!0,translation:{type:"Vector3",get:e=>e._babylonTransformNode.position,set:(e,t)=>{t._babylonTransformNode.position=e},getObject:e=>e._babylonTransformNode}}}};class Jo{dispose(){this._loader=null,delete this._pathConverter}onReady(){var e;if(!this._loader.babylonScene||!this._pathConverter)return;const t=this._loader.babylonScene,n=function(e){var t;const n={uniqueId:Object(R.a)(),_userVariables:{},_connectionValues:{}},i=[n],r=[];for(let t=0;t<e.nodes.length;t++){const n=Qo(t,e.nodes[t],e);r.push(n)}for(let t=0;t<e.nodes.length;t++){var s,a;const i=e.nodes[t],o=r[t],l=null!==(s=i.flows)&&void 0!==s?s:[];for(const e of l){const n=e.id,i={uniqueId:Object(R.a)(),name:n,_connectionType:1,connectedPointIds:[]};o.signalOutputs.push(i);const s=e.node,a=e.socket,l=r[s];if(!l)throw new Error(`/extensions/KHR_interactivity/nodes/${t}: Could not find node with id ${s} that connects its input with with node ${t}'s output ${n}`);let c=l.signalInputs.find(e=>e.name===a);c||(c={uniqueId:Object(R.a)(),name:a,_connectionType:0,connectedPointIds:[]},l.signalInputs.push(c)),c.connectedPointIds.push(i.uniqueId),i.connectedPointIds.push(c.uniqueId)}const c=null!==(a=i.values)&&void 0!==a?a:[];for(const i of c){const s=i.id,a={uniqueId:Object(R.a)(),name:s,_connectionType:0,connectedPointIds:[]};if(o.dataInputs.push(a),void 0!==i.value){const r=qo(i,e,"/extensions/KHR_interactivity/nodes/"+t);n._connectionValues[a.uniqueId]=r}else{if(void 0===i.node||void 0===i.socket)throw new Error(`/extensions/KHR_interactivity/nodes/${t}: Invalid socket ${s} in node ${t}`);{const e=i.node,n=i.socket,o=r[e];if(!o)throw new Error(`/extensions/KHR_interactivity/nodes/${t}: Could not find node with id ${e} that connects its output with node${t}'s input ${s}`);let l=o.dataOutputs.find(e=>e.name===n);l||(l={uniqueId:Object(R.a)(),name:n,_connectionType:1,connectedPointIds:[]},o.dataOutputs.push(l)),a.connectedPointIds.push(l.uniqueId),l.connectedPointIds.push(a.uniqueId)}}}}const o=null!==(t=e.variables)&&void 0!==t?t:[];for(let t=0;t<o.length;t++){const i=o[t],r=i.id;n._userVariables[r]=qo(i,e,"/extensions/KHR_interactivity/variables/"+t)}return{allBlocks:r,executionContexts:i}}(null===(e=this._loader.gltf.extensions)||void 0===e?void 0:e.KHR_interactivity),i=new Zs({scene:t});Qs.Parse(n,{coordinator:i,pathConverter:this._pathConverter}),i.start()}constructor(e){this._loader=e,this.name="KHR_interactivity",this.enabled=this._loader.isExtensionUsed("KHR_interactivity"),this._pathConverter=new Zo(this._loader.gltf)}}lr("KHR_interactivity"),or("KHR_interactivity",!0,e=>new Jo(e));class el{async onReady(){var e;null===(e=this._loader.gltf.nodes)||void 0===e||e.forEach(e=>{var t,n,i,r;null===(t=e._primitiveBabylonMeshes)||void 0===t||t.forEach(e=>{e.inheritVisibility=!0}),null!==(n=e.extensions)&&void 0!==n&&n.KHR_node_visibility&&!1===(null===(i=e.extensions)||void 0===i?void 0:i.KHR_node_visibility.visible)&&(e._babylonTransformNode&&(e._babylonTransformNode.isVisible=!1),null===(r=e._primitiveBabylonMeshes)||void 0===r||r.forEach(e=>{e.isVisible=!1}))})}dispose(){this._loader=null}constructor(e){this.name="KHR_node_visibility",this._loader=e,this.enabled=e.isExtensionUsed("KHR_node_visibility")}}lr("KHR_node_visibility"),or("KHR_node_visibility",!0,e=>new el(e));class tl{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const n=e.metadata=e.metadata||{};(n.gltf=n.gltf||{}).extras=t.extras}}dispose(){this._loader=null}loadNodeAsync(e,t,n){return this._loader.loadNodeAsync(e,t,e=>{this._assignExtras(e,t),n(e)})}loadCameraAsync(e,t,n){return this._loader.loadCameraAsync(e,t,e=>{this._assignExtras(e,t),n(e)})}createMaterial(e,t,n){const i=this._loader.createMaterial(e,t,n);return this._assignExtras(i,t),i}constructor(e){this.name="ExtrasAsMetadata",this.enabled=!0,this._loader=e}}lr("ExtrasAsMetadata"),or("ExtrasAsMetadata",!1,e=>new tl(e)),n(486);const nl={},il={};class rl{get isReady(){return this.m_isReady}get scene(){return this.m_scene}get rootMesh(){return this.m_rootMesh}get renderList(){return this.m_renderList}dispose(){this.m_scene.dispose()}m_initScene(){const e=new v.a(this.m_engine),t=e.getEngine().getCaps(),n=t.textureHalfFloatRender&&t.textureHalfFloatLinearFiltering,i=il.overrideShadowGeneratorBias||n?.002:.001,s=new pt("camera1",new r.e(0,0,105636/65536),e);s.setTarget(r.e.Zero()),s.minZ=.001,e.clearColor=new he.b(0,0,0,1e-10),e.imageProcessingConfiguration.contrast=1.66,e.imageProcessingConfiguration.exposure=Math.pow(2,-.5)*Math.PI,e.imageProcessingConfiguration.toneMappingEnabled=!0,e.autoClear=!1;const a=r.a.RotationY(Math.PI),o=r.e.TransformCoordinates(new r.e(.61,1.97,-.454),a),l=new vt("light1",o,e);l.diffuse=new he.a(1,.75,.5),l.intensity=9.765625,sl(l,i);const c=r.e.TransformCoordinates(new r.e(-1.05455824,1.42028987,-1.60088825),a),d=new vt("light2",c,e);d.diffuse=new he.a(.4,.6,.95),d.intensity=12.25,sl(d,i);const h=r.e.TransformCoordinates(new r.e(-1.04830909,1.61268401,.965823412),a),u=new vt("light3",h,e);u.diffuse=new he.a(.868366683,.726999986,1),u.intensity=3.125,sl(u,i),Object(lt.a)(this.m_engine);const f=Mt.CreateFromPrefilteredData(al,e,".env");f.invertZ=!0,f.lodGenerationOffset=1,f.lodGenerationScale=.8;const m=r.b.RotationAxis(mt.a.Y,Math.PI);return r.a.FromQuaternionToRef(m,f.getReflectionTextureMatrix()),e.environmentTexture=f,e.environmentTexture.wrapU=Et.a.CLAMP_ADDRESSMODE,e.environmentTexture.wrapV=Et.a.CLAMP_ADDRESSMODE,e.environmentBRDFTexture=new Et.a(ol,e,!1,!0,Et.a.LINEAR_LINEAR),e.environmentBRDFTexture.wrapU=Et.a.CLAMP_ADDRESSMODE,e.environmentBRDFTexture.wrapV=Et.a.CLAMP_ADDRESSMODE,e.shadowsEnabled=!il.disableShadows,e}getSceneTransformMatrixFromModel3DData(e){const t=Object(ot.e)(e.untScl),n=this.m_matrixCache[2];r.a.ScalingToRef(t,t,t,n);const i=Object(ot.e)(e.scnPreTX),s=Object(ot.e)(e.scnPreTY),a=Object(ot.e)(e.scnPreTZ),o=this.m_matrixCache[3];r.a.TranslationToRef(i,s,a,o);const l=Object(ot.e)(e.scnSclX),c=Object(ot.e)(e.scnSclY),d=Object(ot.e)(e.scnSclZ),h=this.m_matrixCache[4];r.a.ScalingToRef(l,c,d,h);const u=new r.b(Object(ot.e)(e.scnRotQX),Object(ot.e)(e.scnRotQY),Object(ot.e)(e.scnRotQZ),Object(ot.e)(e.scnRotQW)),f=this.m_matrixCache[5];u.toRotationMatrix(f);const m=Object(ot.e)(e.scnPosTX),p=Object(ot.e)(e.scnPosTY),g=Object(ot.e)(e.scnPosTZ),_=this.m_matrixCache[6];return r.a.TranslationToRef(m,p,g,_),n.multiplyToRef(o,o),o.multiplyToRef(h,h),h.multiplyToRef(f,f),f.multiplyToRef(_,_),_}async loadModel(){const e=new yn;e.compileMaterials=!0,e.onMaterialLoadedObservable.add(e=>{var t;(t=e)instanceof Zi&&(t.alphaMode=m.a.ALPHA_PREMULTIPLIED_PORTERDUFF,t.useAlphaFresnel=t.needAlphaBlending(),t.useSpecularOverAlpha=!1,t.useRadianceOverAlpha=!1,t.useHorizonOcclusion=!1,t.useRadianceOcclusion=!1,t.enableSpecularAntiAliasing=!1,t.directIntensity=1,t.emissiveIntensity=1,t.disableLighting=!1,t.reflectionColor=new he.a(.5,.5,.5),t.reflectionColor=t.reflectionColor.scale(.5),t.albedoTexture?t.albedoColor=he.a.White():t.albedoColor=t.albedoColor.toLinearSpace(),t.reflectivityTexture?(t.reflectivityColor=he.a.White(),t.microSurface=1,t.reflectivityTexture.isReady()?Object(lt.c)(t.reflectivityTexture)&&(t.useMicroSurfaceFromReflectivityMapAlpha=!1,t.useAutoMicroSurfaceFromReflectivityMap=!0):t.reflectivityTexture.onLoadObservable.add(e=>{Object(lt.c)(e)&&(t.useMicroSurfaceFromReflectivityMapAlpha=!1,t.useAutoMicroSurfaceFromReflectivityMap=!0)})):t.reflectivityColor=t.reflectivityColor.toLinearSpace(),t.bumpTexture&&(t.bumpTexture.level=1,t.invertNormalMapX=!0,t.invertNormalMapY=!0),t.emissiveTexture&&(t.emissiveColor=he.a.White()),t.backFaceCulling=!1,t.twoSidedLighting=!0,t.usePhysicalLightFalloff=!0,t.forceNormalForward=!0,t.markDirty())});try{const t=await this.fetchFile();await e.importMeshAsync("",this.m_scene,t,"./",void 0,this.m_data.filename),this.m_rootMesh=this.processLoadedMeshes(this.m_scene.meshes),this.m_isReady=!0,this.onSceneReadyObservable.notifyObservers(this)}catch(e){throw a.a.sendTraceTag(506545095,o.a.msoulscat_Wac_PptSession,l.a.Error,"BabylonScene::m_loadModel: Failed to load 3D model"),e}}async fetchFile(){const e=new yn,t=await Object(ot.f)(this.m_data.url),n=await new Promise(n=>{e.loadFile(this.m_scene,t,"",e=>n(e),void 0,!0)});return Object(ot.h)(t),n}processLoadedMeshes(e){let t,n;const i=e=>{e.receiveShadows=!0,this.m_renderList.push(e)};for(const r of e)i(r),"root"===r.name&&(t=r),"__root__"===r.id&&(n=r);if(!t&&n){t=new Vt("root",this.m_scene);for(const e of n.getChildren())e.parent=t;t.parent=n}if(!t||!n||!t.parent)throw new Error("could not find the model's root mesh");return this.addModelToShadowMaps(this.m_scene,n),t}addModelToShadowMaps(e,t){for(const n of e.lights)n.getShadowGenerator().addShadowCaster(t,!0)}constructor(e,t){this.m_engine=e,this.m_data=t,this.onSceneReadyObservable=new _.a,this.m_isReady=!1,this.m_renderList=[],this.m_matrixCache=[];for(let e=0;e<8;e+=1)this.m_matrixCache[e]=r.a.Identity();this.m_scene=this.m_initScene(),this.loadModel().catch(()=>{a.a.sendTraceTag(506545096,o.a.msoulscat_Wac_PptSession,l.a.Error,"BabylonScene::m_loadModel: Failed to load 3D model")})}}function sl(e,t){if(e.radius=0,e.intensityMode=gt.INTENSITYMODE_AUTOMATIC,e.shadowMinZ=.2,e.shadowMaxZ=10,e.shadowAngle=50*Math.PI/180,e.shadowEnabled=!0,e.shadowAngle=45*Math.PI/180,e.setDirectionToTarget(new r.e(0,0,0)),!e.getShadowGenerator()){const n=512,i=function(e,t){const n=.03/e.shadowAngle,i=5/(t/256);return Math.max(t*n,i)}(e,n),r=new Ct(n,e);r.useBlurCloseExponentialShadowMap=!0,r.useKernelBlur=!0,r.blurScale=1,r.bias=t,r.blurKernel=i,r.depthScale=50*(e.shadowMaxZ-e.shadowMinZ),r.transparencyShadow=!0,r.frustumEdgeFalloff=0}}const al="https://res-1-sdf.cdn.office.net/officeonline/pods/s/161662740502_PptScripts/resources/env2.env",ol="https://res-1-sdf.cdn.office.net/officeonline/pods/s/161662740502_PptScripts/resources/brdf.png";var ll=n(19);n(491),n(495);class cl{get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||cl.ForceGLSL?await Promise.all([Promise.resolve().then(n.bind(null,495)),Promise.resolve().then(n.bind(null,491))]):(this._shaderLanguage=1,await Promise.all([n.e(0).then(n.bind(null,512)),n.e(0).then(n.bind(null,513))])),this._shadersLoaded=!0}isReady(e,t){var n;if(!this._shadersLoaded)return!1;const i=this._scene.getEngine(),r=e.getMesh(),s=r.getScene(),a=null===(n=r._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===n?void 0:n[i.currentRenderPassId];if(a)return a.isReadyForSubMesh(r,e,t);const o=e.getMaterial();if(!o||o.disableDepthWrite)return!1;const l=[],c=[z.b.PositionKind];let d=!1,h=!1;o.needAlphaTestingForMesh(r)&&o.getAlphaTestTexture()&&(l.push("#define ALPHATEST"),r.isVerticesDataPresent(z.b.UVKind)&&(c.push(z.b.UVKind),l.push("#define UV1"),d=!0),r.isVerticesDataPresent(z.b.UV2Kind)&&(c.push(z.b.UV2Kind),l.push("#define UV2"),h=!0));const u=new It;if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){c.push(z.b.MatricesIndicesKind),c.push(z.b.MatricesWeightsKind),r.numBoneInfluencers>4&&(c.push(z.b.MatricesIndicesExtraKind),c.push(z.b.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),r.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,r);const e=r.skeleton;e.isUsingTextureForMatrices?l.push("#define BONETEXTURE"):l.push("#define BonesPerMesh "+(e.bones.length+1))}else l.push("#define NUM_BONE_INFLUENCERS 0");const f=r.morphTargetManager?Se(r.morphTargetManager,l,c,r,!0,!1,!1,d,h,!1):0;o.pointsCloud&&l.push("#define POINTSIZE"),t&&(l.push("#define INSTANCES"),be(c),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES"));const m=r.bakedVertexAnimationManager;m&&m.isEnabled&&(l.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&c.push("bakedVertexAnimationSettingsInstanced")),this._storeNonLinearDepth&&l.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&l.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&l.push("#define PACKED"),me(o,s,l);const p=e._getDrawWrapper(void 0,!0),g=p.defines,_=l.join("\n");if(g!==_){const e=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"];fe(e),p.setEffect(i.createEffect("depth",{attributes:c,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:_,fallbacks:u,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:f},shaderLanguage:this._shaderLanguage},i),_)}return p.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const e=[];for(const t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0){this._depthMap.dispose();for(const t of e)delete this._scene._depthRenderer[t]}}constructor(e,t=1,n=null,r=!1,s=Et.a.TRILINEAR_SAMPLINGMODE,a=!1,o){this._shaderLanguage=0,this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._shadersLoaded=!1,this._scene=e,this._storeNonLinearDepth=r,this._storeCameraSpaceZ=a,this.isPacked=0===t,this.isPacked?this.clearColor=new he.b(1,1,1,1):this.clearColor=new he.b(a?1e8:1,0,0,1),this._initShaderSourceAsync(),cl._SceneComponentInitialization(this._scene);const l=e.getEngine();this._camera=n,s!==Et.a.NEAREST_SAMPLINGMODE&&(1!==t||l._caps.textureFloatLinearFiltering||(s=Et.a.NEAREST_SAMPLINGMODE),2!==t||l._caps.textureHalfFloatLinearFiltering||(s=Et.a.NEAREST_SAMPLINGMODE));const c=this.isPacked||!l._features.supportExtendedTextureFormats?5:6;this._depthMap=new i.a(null!=o?o:"DepthRenderer",{width:l.getRenderWidth(),height:l.getRenderHeight()},this._scene,!1,!0,t,!1,s,void 0,void 0,void 0,c),this._depthMap.wrapU=Et.a.CLAMP_ADDRESSMODE,this._depthMap.wrapV=Et.a.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(e=>{e.clear(this.clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{var e;null===(e=l._debugPushGroup)||void 0===e||e.call(l,"depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{var e;null===(e=l._debugPopGroup)||void 0===e||e.call(l,1)}),this._depthMap.customIsReadyFunction=(e,t,n)=>{if((n||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const n=e.subMeshes[t],i=n.getRenderingMesh(),r=i._getInstancesRenderList(n._id,!!n.getReplacementMesh()),s=l.getCaps().instancedArrays&&(null!==r.visibleInstances[n._id]&&void 0!==r.visibleInstances[n._id]||i.hasThinInstances);if(!this.isReady(n,s))return!1}return!0};const d=e=>{const t=e.getRenderingMesh(),n=e.getEffectiveMesh(),i=this._scene,r=i.getEngine(),s=e.getMaterial();if(n._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!s||n.infiniteDistance||s.disableDepthWrite||0===e.verticesCount||e._renderId===i.getRenderId())return;const a=n._getWorldMatrixDeterminant()<0;let o=s._getEffectiveOrientation(t);a&&(o=0===o?1:0);const l=0===o;r.setState(s.backFaceCulling,0,!1,l,this.reverseCulling?!s.cullBackFaces:s.cullBackFaces);const c=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(c.mustReturn)return;const d=r.getCaps().instancedArrays&&(null!==c.visibleInstances[e._id]&&void 0!==c.visibleInstances[e._id]||t.hasThinInstances),h=this._camera||i.activeCamera;if(this.isReady(e,d)&&h){var u;e._renderId=i.getRenderId();const a=null===(u=n._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===u?void 0:u[r.currentRenderPassId];let o=e._getDrawWrapper();!o&&a&&(o=a._getDrawWrapper());const l=h.mode===ft.ORTHOGRAPHIC_CAMERA;if(!o)return;const f=o.effect;let m,p;if(r.enableEffect(o),d||t._bind(e,f,s.fillMode),a?a.bindForSubMesh(n.getWorldMatrix(),n,e):(f.setMatrix("viewProjection",i.getTransformMatrix()),f.setMatrix("world",n.getWorldMatrix()),this._storeCameraSpaceZ&&f.setMatrix("view",i.getViewMatrix())),l?(m=!r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:1,p=r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:1):(m=r.useReverseDepthBuffer&&r.isNDCHalfZRange?h.minZ:r.isNDCHalfZRange?0:h.minZ,p=r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:h.maxZ),f.setFloat2("depthValues",m,m+p),!a){if(s.needAlphaTestingForMesh(n)){const e=s.getAlphaTestTexture();e&&(f.setTexture("diffuseSampler",e),f.setMatrix("diffuseMatrix",e.getTextureMatrix()))}Oe(t,f),pe(f,s,i),Ie(t,f),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(f);const r=e.getMesh().bakedVertexAnimationManager;r&&r.isEnabled&&r.bind(f,d),s.pointsCloud&&f.setFloat("pointSize",s.pointSize)}t._processRendering(n,e,f,s.fillMode,c,d,(e,t)=>f.setMatrix("world",t))}};this._depthMap.customRenderFunction=(e,t,n,i)=>{let r;if(i.length)for(r=0;r<i.length;r++)d(i.data[r]);for(r=0;r<e.length;r++)d(e.data[r]);for(r=0;r<t.length;r++)d(t.data[r]);if(this.forceDepthWriteTransparentMeshes)for(r=0;r<n.length;r++)d(n.data[r]);else for(r=0;r<n.length;r++)n.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}}cl.ForceGLSL=!1,cl._SceneComponentInitialization=e=>{throw Object(ht.a)("DepthRendererSceneComponent")};var dl=n(374);Ke.a.ShadersStore.minmaxReduxPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#if defined(INITIAL)\nuniform sampler2D sourceTexture;uniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(sourceTexture,coord,0).r;float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;float minz=min(min(min(f1,f2),f3),f4);\n#ifdef DEPTH_REDUX\nfloat maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#else\nfloat maxz=max(max(max(f1,f2),f3),f4);\n#endif\nglFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(MAIN)\nuniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(ONEBEFORELAST)\nuniform ivec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(f1.x,f2.x);float maxz=max(f1.y,f2.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(LAST)\nvoid main(void)\n{glFragColor=vec4(0.);if (true) { \ndiscard;}}\n#endif\n";class hl extends class{get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,n=2,i=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=i;const r=this._camera.getScene(),s=new Tt.a("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,r.getEngine(),!1,"#define INITIAL"+(t?"\n#define DEPTH_REDUX":""),n,void 0,void 0,void 0,7);s.autoClear=!1,s.forceFullscreenViewport=i;let a=this._sourceTexture.getRenderWidth(),o=this._sourceTexture.getRenderHeight();s.onApply=((e,t)=>n=>{n.setTexture("sourceTexture",this._sourceTexture),n.setFloat2("texSize",e,t)})(a,o),this._reductionSteps.push(s);let l=1;for(;a>1||o>1;){a=Math.max(Math.round(a/2),1),o=Math.max(Math.round(o/2),1);const e=new Tt.a("Reduction phase "+l,"minmaxRedux",["texSize"],null,{width:a,height:o},null,1,r.getEngine(),!1,"#define "+(1==a&&1==o?"LAST":1==a||1==o?"ONEBEFORELAST":"MAIN"),n,void 0,void 0,void 0,7);if(e.autoClear=!1,e.forceFullscreenViewport=i,e.onApply=((e,t)=>n=>{1==e||1==t?n.setInt2("texSize",e,t):n.setFloat2("texSize",e,t)})(a,o),this._reductionSteps.push(e),l++,1==a&&1==o){const t=(e,t,n)=>{const i=new Float32Array(4*e*t),s={min:0,max:0};return()=>{r.getEngine()._readTexturePixels(n.inputTexture.texture,e,t,-1,0,i,!1),s.min=i[0],s.max=i[1],this.onAfterReductionPerformed.notifyObservers(s)}};e.onAfterRenderObservable.add(t(a,o,e))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){!this._onAfterUnbindObserver&&this._sourceTexture&&(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{var e,t;const n=this._camera.getScene().getEngine();null===(e=n._debugPushGroup)||void 0===e||e.call(n,"min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),n.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),null===(t=n._debugPopGroup)||void 0===t||t.call(n,1)}),this._activated=!0)}deactivate(){this._onAfterUnbindObserver&&this._sourceTexture&&(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}constructor(e){this.onAfterReductionPerformed=new _.a,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new dl.a(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}}{get depthRenderer(){return this._depthRenderer}setDepthRenderer(e=null,t=2,n=!0){const i=this._camera.getScene();this._depthRenderer&&(delete i._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(i._depthRenderer||(i._depthRenderer={}),(e=this._depthRenderer=new cl(i,t,this._camera,!1,1)).enabled=!1,this._depthRendererId="minmax"+this._camera.id,i._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,n)}setSourceTexture(e,t,n=2,i=!0){super.setSourceTexture(e,t,n,i)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const e=this._depthRenderer.getDepthMap().getScene();e&&delete e._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}constructor(e){super(e)}}const ul=r.e.Up(),fl=r.e.Zero(),ml=new r.e,pl=new r.e,gl=new r.a;class _l extends Ct{_validateFilter(e){return e===Ct.FILTER_NONE||e===Ct.FILTER_PCF||e===Ct.FILTER_PCSS?e:(T.a.Error('Unsupported filter "'+e+'"!'),Ct.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){(e=Math.min(Math.max(e,_l.MIN_CASCADES_COUNT),_l.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._freezeShadowCastersBoundingInfoObservable||e||(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(()=>this._computeShadowCastersBoundingInfo())),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let t=0;t<e.length;t++){const n=e[t];if(!n)continue;const i=n.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(i.minimumWorld),this._scbiMax.maximizeInPlace(i.maximumWorld)}const t=this._scene.meshes;for(let e=0;e<t.length;e++){const n=t[e];if(!(n&&n.isVisible&&n.isEnabled&&n.receiveShadows))continue;const i=n.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(i.minimumWorld),this._scbiMax.maximizeInPlace(i.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return _l.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();t?this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&0!==t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0):this._shadowMaxZ=e}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e)return this._depthReducer&&this._depthReducer.deactivate(),void this.setMinMaxDistance(0,1);this._depthReducer||(this._depthReducer=new hl(t),this._depthReducer.onAfterReductionPerformed.add(e=>{let t=e.min,n=e.max;t>=n&&(t=0,n=1),t==this._minDistance&&n==this._maxDistance||this.setMinMaxDistance(t,n)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){var e,t;return null!==(e=null===(t=this._depthReducer)||void 0===t||null===(t=t.depthRenderer)||void 0===t?void 0:t.getDepthMap().refreshRate)&&void 0!==e?e:-1}set autoCalcDepthBoundsRefreshRate(e){var t;null!==(t=this._depthReducer)&&void 0!==t&&t.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,n=e.maxZ||this._shadowMaxZ,i=n-t,r=this._minDistance,s=t+r*i,a=t+(this._shadowMaxZ<n&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(n-t),this._maxDistance):this._maxDistance)*i,o=a-s,l=a/s;for(let e=0;e<this._cascades.length;++e){const n=(e+1)/this._numCascades,a=s*l**n,c=s+o*n,d=this._lambda*(a-c)+c;this._cascades[e].prevBreakDistance=0===e?r:this._cascades[e-1].breakDistance,this._cascades[e].breakDistance=(d-t)/i,this._viewSpaceFrustumsZ[e]=d,this._frustumLengths[e]=(this._cascades[e].breakDistance-this._cascades[e].prevBreakDistance)*i}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;r.e.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(r.e.Dot(this._lightDirection,r.e.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const t=e.getEngine().useReverseDepthBuffer;for(let n=0;n<this._numCascades;++n){this._computeFrustumInWorldSpace(n),this._computeCascadeFrustum(n),this._cascadeMaxExtents[n].subtractToRef(this._cascadeMinExtents[n],ml),this._frustumCenter[n].addToRef(this._lightDirection.scale(this._cascadeMinExtents[n].z),this._shadowCameraPos[n]),r.a.LookAtLHToRef(this._shadowCameraPos[n],this._frustumCenter[n],ul,this._viewMatrices[n]);let i=0,s=ml.z;const a=this._shadowCastersBoundingInfo;a.update(this._viewMatrices[n]),s=Math.min(s,a.boundingBox.maximumWorld.z),i=this._depthClamp&&this.filter!==Ct.FILTER_PCSS?Math.max(i,a.boundingBox.minimumWorld.z):Math.min(i,a.boundingBox.minimumWorld.z),r.a.OrthoOffCenterLHToRef(this._cascadeMinExtents[n].x,this._cascadeMaxExtents[n].x,this._cascadeMinExtents[n].y,this._cascadeMaxExtents[n].y,t?s:i,t?i:s,this._projectionMatrices[n],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[n].z=i,this._cascadeMaxExtents[n].z=s,this._viewMatrices[n].multiplyToRef(this._projectionMatrices[n],this._transformMatrices[n]),r.e.TransformCoordinatesToRef(fl,this._transformMatrices[n],ml),ml.scaleInPlace(this._mapSize/2),pl.copyFromFloats(Math.round(ml.x),Math.round(ml.y),Math.round(ml.z)),pl.subtractInPlace(ml).scaleInPlace(2/this._mapSize),r.a.TranslationToRef(pl.x,pl.y,0,gl),this._projectionMatrices[n].multiplyToRef(gl,this._projectionMatrices[n]),this._viewMatrices[n].multiplyToRef(this._projectionMatrices[n],this._transformMatrices[n]),this._transformMatrices[n].copyToArray(this._transformMatricesAsArray,16*n)}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const n=this._cascades[e].prevBreakDistance,i=this._cascades[e].breakDistance,s=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const a=0===t.maxZ,o=t.maxZ;a&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));const l=r.a.Invert(t.getTransformationMatrix());a&&(t.maxZ=o,t.getProjectionMatrix(!0));const c=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let t=0;t<_l._FrustumCornersNDCSpace.length;++t)ml.copyFrom(_l._FrustumCornersNDCSpace[(t+c)%_l._FrustumCornersNDCSpace.length]),s&&-1===ml.z&&(ml.z=0),r.e.TransformCoordinatesToRef(ml,l,this._frustumCornersWorldSpace[e][t]);for(let t=0;t<_l._FrustumCornersNDCSpace.length/2;++t)ml.copyFrom(this._frustumCornersWorldSpace[e][t+4]).subtractInPlace(this._frustumCornersWorldSpace[e][t]),pl.copyFrom(ml).scaleInPlace(n),ml.scaleInPlace(i),ml.addInPlace(this._frustumCornersWorldSpace[e][t]),this._frustumCornersWorldSpace[e][t+4].copyFrom(ml),this._frustumCornersWorldSpace[e][t].addInPlace(pl)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),this._getCamera()){for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][t]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let t=0;for(let n=0;n<this._frustumCornersWorldSpace[e].length;++n){const i=this._frustumCornersWorldSpace[e][n].subtractToRef(this._frustumCenter[e],ml).length();t=Math.max(t,i)}t=Math.ceil(16*t)/16,this._cascadeMaxExtents[e].copyFromFloats(t,t,t),this._cascadeMinExtents[e].copyFromFloats(-t,-t,-t)}else{const t=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,ml),r.a.LookAtLHToRef(t,ml,ul,gl);for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)r.e.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][t],gl,ml),this._cascadeMinExtents[e].minimizeInPlace(ml),this._cascadeMaxExtents[e].maximizeInPlace(ml)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=E.a.LastCreatedEngine;return!!e&&e._features.supportCSM}_initializeGenerator(){var e,t,n,i,s,a,o,l,c,d,h,u,f,m,p,g,_,v,E,T;this.penumbraDarkness=null!==(e=this.penumbraDarkness)&&void 0!==e?e:1,this._numCascades=null!==(t=this._numCascades)&&void 0!==t?t:_l.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=null!==(n=this.stabilizeCascades)&&void 0!==n&&n,this._freezeShadowCastersBoundingInfoObservable=null!==(i=this._freezeShadowCastersBoundingInfoObservable)&&void 0!==i?i:null,this.freezeShadowCastersBoundingInfo=null!==(s=this.freezeShadowCastersBoundingInfo)&&void 0!==s&&s,this._scbiMin=null!==(a=this._scbiMin)&&void 0!==a?a:new r.e(0,0,0),this._scbiMax=null!==(o=this._scbiMax)&&void 0!==o?o:new r.e(0,0,0),this._shadowCastersBoundingInfo=null!==(l=this._shadowCastersBoundingInfo)&&void 0!==l?l:new ne(new r.e(0,0,0),new r.e(0,0,0)),this._breaksAreDirty=null===(c=this._breaksAreDirty)||void 0===c||c,this._minDistance=null!==(d=this._minDistance)&&void 0!==d?d:0,this._maxDistance=null!==(h=this._maxDistance)&&void 0!==h?h:1,this._currentLayer=null!==(u=this._currentLayer)&&void 0!==u?u:0,this._shadowMaxZ=null!==(f=null!==(m=this._shadowMaxZ)&&void 0!==m?m:null===(p=this._getCamera())||void 0===p?void 0:p.maxZ)&&void 0!==f?f:1e4,this._debug=null!==(g=this._debug)&&void 0!==g&&g,this._depthClamp=null===(_=this._depthClamp)||void 0===_||_,this._cascadeBlendPercentage=null!==(v=this._cascadeBlendPercentage)&&void 0!==v?v:.1,this._lambda=null!==(E=this._lambda)&&void 0!==E?E:.5,this._autoCalcDepthBounds=null!==(T=this._autoCalcDepthBounds)&&void 0!==T&&T,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new i.a(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,"DepthStencilForCSMShadowGenerator-"+this._light.name),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),null===this._shadowMap)return;this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(2*this._numCascades),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let e=0;e<this._numCascades;++e){this._cascades[e]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[e]=r.a.Zero(),this._projectionMatrices[e]=r.a.Zero(),this._transformMatrices[e]=r.a.Zero(),this._cascadeMinExtents[e]=new r.e,this._cascadeMaxExtents[e]=new r.e,this._frustumCenter[e]=new r.e,this._shadowCameraPos[e]=new r.e,this._frustumCornersWorldSpace[e]=new Array(_l._FrustumCornersNDCSpace.length);for(let t=0;t<_l._FrustumCornersNDCSpace.length;++t)this._frustumCornersWorldSpace[e][t]=new r.e}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===Ct.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),null===(t=e._debugPushGroup)||void 0===t||t.call(e,"cascaded shadow map generation for pass id "+e.currentRenderPassId,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==Ct.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const n=this._scene,i=this._light;if(!n.shadowsEnabled||!i.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=n.useRightHandedSystem;const r=this._getCamera();r&&this._shadowMaxZ<=(r.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const n=this._light;if(!this._scene.shadowsEnabled||!n.shadowEnabled)return;const i=this._getCamera();if(!i)return;const r=this.getShadowMap();if(!r)return;const s=r.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===Ct.FILTER_PCF)t.setDepthStencilTexture("shadowTexture"+e,r),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),s,1/s,this.frustumEdgeFalloff,e);else if(this._filter===Ct.FILTER_PCSS){for(let e=0;e<this._numCascades;++e)this._lightSizeUVCorrection[2*e+0]=0===e?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[e].x-this._cascadeMinExtents[e].x),this._lightSizeUVCorrection[2*e+1]=0===e?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[e].y-this._cascadeMinExtents[e].y),this._depthCorrection[e]=0===e?1:(this._cascadeMaxExtents[e].z-this._cascadeMinExtents[e].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowTexture"+e,r),t.setTexture("depthTexture"+e,r),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/s,this._contactHardeningLightSizeUVRatio*s,this.frustumEdgeFalloff,e)}else t.setTexture("shadowTexture"+e,r),n._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),s,1/s,this.frustumEdgeFalloff,e);n._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(i),this.getLight().getDepthMinZ(i)+this.getLight().getDepthMaxZ(i),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let n=0;n<t.renderList.length;n++){const i=t.renderList[n];e.renderList.push(i.id)}return e}static Parse(e,t){const n=Ct.Parse(e,t,(e,t,n)=>new _l(e,t,void 0,n));return void 0!==e.numCascades&&(n.numCascades=e.numCascades),void 0!==e.debug&&(n.debug=e.debug),void 0!==e.stabilizeCascades&&(n.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(n.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(n.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(n.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(n.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(n.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(n.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(n.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&n.setMinMaxDistance(e.minDistance,e.maxDistance),n}constructor(e,t,n,i,r=!0){_l.IsSupported?(super(e,t,n,i,r),this.usePercentageCloserFiltering=!0):T.a.Error("CascadedShadowMap is not supported by the current engine.")}}_l._FrustumCornersNDCSpace=[new r.e(-1,1,-1),new r.e(1,1,-1),new r.e(1,-1,-1),new r.e(-1,-1,-1),new r.e(-1,1,1),new r.e(1,1,1),new r.e(1,-1,1),new r.e(-1,-1,1)],_l.CLASSNAME="CascadedShadowGenerator",_l.DEFAULT_CASCADES_COUNT=4,_l.MIN_CASCADES_COUNT=2,_l.MAX_CASCADES_COUNT=4,_l._SceneComponentInitialization=e=>{throw Object(ht.a)("ShadowGeneratorSceneComponent")},vs(Kt.a.NAME_SHADOWGENERATOR,(e,t)=>{if(void 0!==e.shadowGenerators&&null!==e.shadowGenerators)for(let n=0,i=e.shadowGenerators.length;n<i;n++){const i=e.shadowGenerators[n];i.className===_l.CLASSNAME?_l.Parse(i,t):Ct.Parse(i,t)}});class vl{register(){this.scene._gatherRenderTargetsStage.registerStep(Kt.a.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const n of t){if(n.doNotSerialize)continue;const t=n.getShadowGenerators();if(t){const n=t.values();for(let t=n.next();!0!==t.done;t=n.next()){const n=t.value;n.doNotSerialize||e.shadowGenerators.push(n.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let n=0;n<t.lights.length;n++){const i=t.lights[n],r=i.getShadowGenerators();if(i.isEnabled()&&i.shadowEnabled&&r){const n=r.values();for(let i=n.next();!0!==i.done;i=n.next()){const n=i.value.getShadowMap();-1!==t.textures.indexOf(n)&&e.push(n)}}}}constructor(e){this.name=Kt.a.NAME_SHADOWGENERATOR,this.scene=e}}Ct._SceneComponentInitialization=e=>{let t=e._getComponent(Kt.a.NAME_SHADOWGENERATOR);t||(t=new vl(e),e._addComponent(t))},n(390),n(248);class El{get isReady(){return this.m_isReady}applyAnimationState(e,t=!1){this.m_renderingCache.animationState&&this.m_renderingCache.animationState[ll.c.EmbeddedAnimProgress]===e[ll.c.EmbeddedAnimProgress]||(this.m_renderingCache.animationStateChanged=!0),this.m_renderingCache.initialAnimationState||(this.m_renderingCache.initialAnimationState=e),this.m_renderingCache.animationState=e,this.m_renderingCache.objectTransformed=t}m_createRenderTargetTexture(e){const t=this.getTextureRenderSize(e.txW,e.txH);return this.generateRenderTargetTexture(t)}getTextureRenderSize(e,t){let n;if(this.m_options.overrideTextureSize)n=Math.max(this.m_options.overrideTextureSize.x,this.m_options.overrideTextureSize.y);else{const i=Object(ot.b)(e,t);n=i>c.a?ot.a.TextureSizeMax:Object(ot.c)(i)}return n}getTargetTexture(){if(!this.m_targetTexture)throw new Error("Target texture is not initialized");return this.m_targetTexture}renderFrame(){this.m_babylonSceneForUrl.isReady&&this.renderLoop()}stopAllAnimations(){this.m_babylonSceneForUrl.scene.stopAllAnimations()}resetTransformation(e){this.m_model3d={...this.m_model3d,...e},this.m_initRenderingCache(),this.m_updateRenderingCache(!0)}release(){this.m_renderTargetTexture.dispose(),this.m_targetTexture.release()}onBeforeFirstRenderAfterNavigation(){this.resetTransformation(),this.m_renderingCache.initialAnimationState&&this.applyAnimationState(this.m_renderingCache.initialAnimationState),this.m_options.skipRenderOnReady||this.renderFrame()}m_initRenderingCache(){this.m_renderingCache={animationState:{},modelPivotMatrix:r.a.Identity(),originalBoundingVectors:{min:r.e.Zero(),max:r.e.Zero()},boundingBox:new Q(r.e.Zero(),r.e.Zero()),renderTextureSize:1024,renderScale:1,cameraState:{position:r.e.Zero(),target:r.e.Zero(),up:r.e.Zero(),fov:0,viewport:new s.a(0,0,0,0),viewMatrix:r.a.Identity(),projectionMatrix:r.a.Identity()}};const e=this.m_model3d;this.m_renderingCache.renderTextureSize=this.getTextureRenderSize(e.txW,e.txH);const t=this.m_babylonSceneForUrl.rootMesh;if(!t)return;const n=t.getHierarchyBoundingVectors(!0);this.m_renderingCache.originalBoundingVectors.min.set(n.min.x,n.min.y,n.min.z),this.m_renderingCache.originalBoundingVectors.max.set(n.max.x,n.max.y,n.max.z),this.m_babylonSceneForUrl.scene.stopAllAnimations(),this.m_renderCacheInitialized=!0}m_updateRenderingCache(e){this.m_updateObjectTransformation(e),this.m_updateCameraState(e),this.m_applyCameraState()}m_updateCameraState(e){if(!this.m_renderingCache.objectTransformed&&!e)return;const t=this.m_model3d,n=this.m_renderingCache.cameraState,i=this.m_renderingCache.renderScale,s=this.m_renderingCache.renderTextureSize;n.fov=Object(ot.d)(Object(ot.e)(t.camPrm)),n.position.set(-Object(ot.e)(t.camPX),Object(ot.e)(t.camPY),Object(ot.e)(t.camPZ)),n.target.set(-Object(ot.e)(t.camAtX),Object(ot.e)(t.camAtY),Object(ot.e)(t.camAtZ)),n.up.set(-Object(ot.e)(t.camUpX),Object(ot.e)(t.camUpY),Object(ot.e)(t.camUpZ));const a=this.m_renderingCache.boundingBox.vectors,o=1*(this.m_options.overrideTextureSize?this.m_options.overrideTextureSize.x:t.txW),l=1*(this.m_options.overrideTextureSize?this.m_options.overrideTextureSize.y:t.txH),c=(s-o*i)/(2*s),d=(s-l*i)/(2*s),h=o*i/s,u=l*i/s;n.viewport.x=c,n.viewport.y=d,n.viewport.width=h,n.viewport.height=u;const f=r.d.Zero();let m=1;if(t.fWndMd){this.m_applyCameraState();const e=this.m_babylonSceneForUrl.scene.getTransformMatrix(),t=Object(lt.b)(a,e,n.viewport),i=new r.d(s/2,s/2);let o=h;const l={min:r.d.Zero(),max:new r.d(1,1)};if(t.min.x<l.min.x||t.min.y<l.min.y||t.max.x>l.max.x||t.max.y>l.max.y){const e=Math.max(t.max.x-t.min.x,t.max.y-t.min.y);m=Math.max(1,e*o),o/=m;const n=new r.d((t.min.x+t.max.x)/2,(t.min.y+t.max.y)/2);i.x=s/2+(.5-n.x)*o*s,i.y=s/2-(.5-n.y)*o*s,f.x=s/2-i.x,f.y=i.y-s/2}const c=Math.max(Math.abs(i.x-s/2)+s/2,Math.abs(i.y-s/2)+s/2)/(s*o),d=Math.max(1,2*c);d>1&&(n.fov=2*Math.atan(d*Math.tan(n.fov/2)));const p=h*d/m,g=u*d/m;n.viewport.x=i.x/s-p/2,n.viewport.y=i.y/s-g/2,n.viewport.width=p,n.viewport.height=g}}m_applyCameraState(){const e=this.m_babylonSceneForUrl.scene,t=e.activeCamera;t.upVector.copyFrom(this.m_renderingCache.cameraState.up),t.position.copyFrom(this.m_renderingCache.cameraState.position),t.target.copyFrom(this.m_renderingCache.cameraState.target),t.fov=this.m_renderingCache.cameraState.fov,t.viewport=this.m_renderingCache.cameraState.viewport,e.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix())}m_updateObjectTransformation(e){if(!this.m_renderingCache.objectTransformed&&!e)return;const t=this.m_model3d,n=Object(ot.e)(t.untScl),i=r.e.Center(this.m_renderingCache.originalBoundingVectors.min,this.m_renderingCache.originalBoundingVectors.max);i.x*=-1;const s=this.m_matrixCache[2];r.a.TranslationToRef(-i.x,-i.y,-i.z,s),r.a.ScalingToRef(n,n,n,this.m_matrixCache[4]),s.multiplyToRef(this.m_matrixCache[4],s),r.a.RotationYawPitchRollToRef(Object(ot.d)(this.m_renderingCache.animationState[ll.c.ObjectRotationY])||0,Object(ot.d)(this.m_renderingCache.animationState[ll.c.ObjectRotationX])||0,Object(ot.d)(this.m_renderingCache.animationState[ll.c.ObjectRotationZ])||0,this.m_matrixCache[4]),s.multiplyToRef(this.m_matrixCache[4],s),r.a.ScalingToRef(this.m_renderingCache.animationState[ll.c.ObjectScaleX]||1,this.m_renderingCache.animationState[ll.c.ObjectScaleY]||1,this.m_renderingCache.animationState[ll.c.ObjectScaleZ]||1,this.m_matrixCache[4]),s.multiplyToRef(this.m_matrixCache[4],s),r.a.TranslationToRef(this.m_renderingCache.animationState[ll.c.ObjectTranslateX]||0,this.m_renderingCache.animationState[ll.c.ObjectTranslateY]||0,this.m_renderingCache.animationState[ll.c.ObjectTranslateZ]||0,this.m_matrixCache[4]),s.multiplyToRef(this.m_matrixCache[4],s),r.a.ScalingToRef(1/n,1/n,1/n,this.m_matrixCache[4]),s.multiplyToRef(this.m_matrixCache[4],s),r.a.TranslationToRef(i.x,i.y,i.z,this.m_matrixCache[4]),s.multiplyToRef(this.m_matrixCache[4],s);const a=Object(ot.e)(t.camAtX),o=Object(ot.e)(t.camAtY),l=Object(ot.e)(t.camAtZ),c=this.m_matrixCache[3];r.a.TranslationToRef(-a,-o,-l,c),r.a.RotationYawPitchRollToRef(Object(ot.d)(this.m_renderingCache.animationState[ll.c.ViewRotationY])||0,Object(ot.d)(this.m_renderingCache.animationState[ll.c.ViewRotationX])||0,Object(ot.d)(this.m_renderingCache.animationState[ll.c.ViewRotationZ])||0,this.m_matrixCache[4]),c.multiplyToRef(this.m_matrixCache[4],c),r.a.ScalingToRef(this.m_renderingCache.animationState[ll.c.ViewScaleX]||1,this.m_renderingCache.animationState[ll.c.ViewScaleY]||1,this.m_renderingCache.animationState[ll.c.ViewScaleZ]||1,this.m_matrixCache[4]),c.multiplyToRef(this.m_matrixCache[4],c),r.a.TranslationToRef(this.m_renderingCache.animationState[ll.c.ViewTranslateX]||0,this.m_renderingCache.animationState[ll.c.ViewTranslateY]||0,this.m_renderingCache.animationState[ll.c.ViewTranslateZ]||0,this.m_matrixCache[4]),c.multiplyToRef(this.m_matrixCache[4],c),r.a.TranslationToRef(a,o,l,this.m_matrixCache[4]),c.multiplyToRef(this.m_matrixCache[4],c);const d=this.m_matrixCache[1];s.multiplyToRef(this.m_babylonSceneForUrl.getSceneTransformMatrixFromModel3DData(t),d),d.multiplyToRef(c,d),this.m_renderingCache.modelPivotMatrix.copyFrom(d),this.m_renderingCache.boundingBox.reConstruct(this.m_renderingCache.originalBoundingVectors.min,this.m_renderingCache.originalBoundingVectors.max);const h=this.m_renderingCache.boundingBox.vectors;for(const e of h)e.x*=-1,r.e.TransformCoordinatesToRef(e,this.m_renderingCache.modelPivotMatrix,e),e.x*=-1}m_applyAnimationState(){if(!this.m_renderingCache.animationStateChanged)return;const e=this.m_renderingCache.animationState[ll.c.EmbeddedAnimId]||0,t=this.m_renderingCache.animationState[ll.c.EmbeddedAnimProgress]||0,n=this.m_babylonSceneForUrl.scene.animationGroups;for(const i of n)if(i.isPlaying&&i!==n[e]&&i.stop(),i===n[e]){i.isPlaying||i.play(!0);const e=(i.to-i.from)*t;i.pause(),i.goToFrame(e)}}m_applyRenderState(){this.m_renderCacheInitialized?(this.m_updateRenderingCache(),this.m_applyAnimationState()):this.resetTransformation(),this.m_babylonSceneForUrl.rootMesh.parent.setPivotMatrix(this.m_renderingCache.modelPivotMatrix,!1)}render(){this.m_applyRenderState();const e=this.m_babylonSceneForUrl.scene;if(this.m_renderTargetTexture.renderList){e.getEngine().setDepthBuffer(!0);for(const e of this.m_renderTargetTexture.renderList)e.setEnabled(!0),e.visibility=1e-6;e.render();for(const e of this.m_renderTargetTexture.renderList)e.visibility=1;this.m_renderTargetTexture.render();for(const e of this.m_renderTargetTexture.renderList)e.setEnabled(!1);this.onAfterRenderCallback()}}generateRenderTargetTexture(e){const t=this.m_babylonSceneForUrl.scene.getEngine()._gl;if(!t||t.isContextLost())throw a.a.sendTraceTag(506545097,o.a.msoulscat_Wac_PptSession,l.a.Error,"Model3DViewElement::generateTargetTexture: missing glContext."),new Error("Model3DViewElement::generateTargetTexture: missing glContext.");const n=new d.f(this.m_modelInfo.size.x,this.m_modelInfo.size.y),r=new i.a("renderTargetTexture",{width:e,height:e},this.m_babylonSceneForUrl.scene,{generateMipMaps:!1,doNotChangeAspectRatio:!1,generateStencilBuffer:!0,delayAllocation:!!this.m_options.preparedRenderTargetTexture});this.m_options.preparedRenderTargetTexture&&(r._renderTarget=this.m_options.preparedRenderTargetTexture,r._texture=this.m_options.preparedRenderTargetTexture.texture);const s=new h.c("Model3D",this.m_environment.rendererEnvironment.renderer,r.getInternalTexture(),n,u.d.RGBA,f.y.clamp,h.e.KeepUntilRelease);if(!s.graphicsProcessor)throw new Error("Model3DViewElement::generateTargetTexture: graphicsProcessor is not null.");return this.m_targetTexture=s,r}constructor(e,t,n,i,c={}){this.m_environment=t,this.m_modelInfo=n,this.m_model3d=i,this.m_options=c,this.m_matrixCache=[],this.m_renderCacheInitialized=!1,this.m_isReady=!1,this.m_renderingCache={animationState:{},modelPivotMatrix:r.a.Identity(),originalBoundingVectors:{min:r.e.Zero(),max:r.e.Zero()},boundingBox:new Q(r.e.Zero(),r.e.Zero()),renderTextureSize:1024,renderScale:1,cameraState:{position:r.e.Zero(),target:r.e.Zero(),up:r.e.Zero(),fov:0,viewport:new s.a(0,0,0,0),viewMatrix:r.a.Identity(),projectionMatrix:r.a.Identity()}},this.onAfterRenderCallback=()=>{},this.onReady=()=>{},this.m_onSceneReady=()=>{this.m_renderTargetTexture.renderList.push(...this.m_babylonSceneForUrl.renderList),window.resizeBy(1,1),this.m_isReady=!0,this.m_options.skipRenderOnReady||this.renderFrame(),this.onReady()},this.renderLoop=()=>{this.m_babylonSceneForUrl.scene.isReady()?this.render():this.m_babylonSceneForUrl.onSceneReadyObservable.addOnce(()=>{this.render()})};for(let e=0;e<8;e+=1)this.m_matrixCache[e]=r.a.Identity();(function(e,t){if("Engine"!==e.getClassName()){let n;if(nt.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!1,nt.DEFAULT_USE_SPHERICAL_HARMONICS=!1,nt.DEFAULT_USE_ENERGY_CONSERVATION=!1,nt.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!1,H.ShowLoadingScreen=!1,t){const e=document.createElement("canvas");rt.ChangeGate.isChangeGateEnabled("SVM.CanvasAriaHidden")&&e.setAttribute("aria-hidden","true"),e.width=1e3,e.height=1e3,document.body.appendChild(e),n=e}if(!function(e,t){const n=t||e.getRenderingCanvas(),i=n.width,r=n.height;at=new m.a(t||e._gl,void 0,{...e.getCreationOptions(),...st,disableWebGL2Support:1===e.version});const s=t||e.getRenderingCanvas();if(!s)return a.a.sendTraceTag(506545122,o.a.msoulscat_Wac_PptSession,l.a.Error,"augmentThinEngine: no canvas available to augment the engine"),!1;const c=at,d=at;Object.getOwnPropertyNames(m.a.prototype).forEach(e=>{"function"==typeof c[e]&&(d[e]=c[e].bind(at))});for(const t in at){const n=Object.getOwnPropertyDescriptor(p.ThinEngine.prototype,t)||Object.getOwnPropertyDescriptor(C.a.prototype,t);if(!(n&&(n.get||n.set)||void 0!==d[t]&&"function"!=typeof d[t]))try{"function"==typeof c[t]?d[t]=c[t].bind(e):d[t]=c[t]}catch(e){return a.a.sendTraceTag(506545121,o.a.msoulscat_Wac_PptSession,l.a.Error,`augmentThinEngine: could not augment property ${t} on thinEngine`),!1}}return Object(it.i)(e,s,e.getCreationOptions()),e.getClassName=()=>"Engine",e.enableUnpackFlipYCached=!1,n.width=i,n.height=r,!0}(e,n))throw new Error("Failed to augment thinEngine");at=e}})(e),this.m_babylonSceneForUrl=function(e,t){return nl[t.url]||(nl[t.url]=new rl(e,t)),nl[t.url]}(e,this.m_modelInfo),this.m_renderTargetTexture=this.m_createRenderTargetTexture(this.m_model3d),this.m_babylonSceneForUrl.isReady?this.m_onSceneReady():this.m_babylonSceneForUrl.onSceneReadyObservable.addOnce(this.m_onSceneReady)}}},function(e,t,n){"use strict";n.r(t),n.d(t,"pbrPixelShader",(function(){return s}));var i=n(66);n(462),n(463),n(461);i.a.IncludesShadersStore.pbrFragmentDeclaration="uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform float baseWeight;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef BASEWEIGHT\nuniform vec2 vBaseWeightInfos;\n#endif\n#ifdef AMBIENT\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REALTIME_FILTERING\nuniform vec2 vReflectionFilteringInfo;\n#endif\nuniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;\n#endif\n#endif\n#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)\nuniform vec3 vRefractionPosition;uniform vec3 vRefractionSize;\n#endif\n#ifdef CLEARCOAT\nuniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT\nuniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#endif\n#ifdef IRIDESCENCE\nuniform vec4 vIridescenceParams;\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\nuniform vec3 vAnisotropy;\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\nuniform vec4 vSheenColor;\n#ifdef SHEEN_ROUGHNESS\nuniform float vSheenRoughness;\n#endif\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;\n#ifdef REALTIME_FILTERING\nuniform vec2 vRefractionFilteringInfo;\n#endif\n#ifdef SS_DISPERSION\nuniform float dispersion;\n#endif\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;\n#endif\nuniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;uniform vec4 vTranslucencyColor;\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nuniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;\n#endif\n#endif\n#ifdef PREPASS\n#ifdef SS_SCATTERING\nuniform float scatteringDiffusionProfile;\n#endif\n#endif\n#if DEBUGMODE>0\nuniform vec2 vDebugMode;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#define ADDITIONAL_FRAGMENT_DECLARATION\n",n(483),n(370);i.a.IncludesShadersStore.pbrFragmentExtraDeclaration="varying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n",n(464),n(465),n(387);i.a.IncludesShadersStore.samplerFragmentAlternateDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n#endif\n";i.a.IncludesShadersStore.pbrFragmentSamplersDeclaration="#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef CLEARCOAT\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform sampler2D clearCoatRoughnessSampler;\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform sampler2D sheenRoughnessSampler;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform samplerCube irradianceSampler;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform sampler2D irradianceSampler;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nuniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;\n#endif\n#endif\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)\n#endif\n#ifdef IBL_CDF_FILTERING\nuniform sampler2D icdfSampler;\n#endif\n",n(469),n(342),n(371),n(473),n(323),i.a.IncludesShadersStore.subSurfaceScatteringFunctions="bool testLightingForSSS(float diffusionProfile)\n{return diffusionProfile<1.;}";i.a.IncludesShadersStore.importanceSampling="vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nvec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nvec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { \nfloat phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}";i.a.IncludesShadersStore.pbrHelperFunctions="#define MINIMUMVARIANCE 0.0005\nfloat convertRoughnessToAverageSlope(float roughness)\n{return square(roughness)+MINIMUMVARIANCE;}\nfloat fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}\nvec2 getAARoughnessFactors(vec3 normalVector) {\n#ifdef SPECULARAA\nvec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2(0.);\n#endif\n}\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_LEGACY\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection;if (anisotropy>=0.0) {anisotropicFrameDirection=B;} else {anisotropicFrameDirection=T;}\nvec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}\n#else\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}\n#endif\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\nvec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}\nvec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}\nvec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}\nvec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);return clearCoatAbsorption;}\n#endif\n#ifdef MICROSURFACEAUTOMATIC\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}\n#endif\n",n(470),n(467),n(484),n(466);i.a.IncludesShadersStore.pbrDirectLightingSetupFunctions="struct preLightingInfo\n{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float roughness;\n#ifdef IRIDESCENCE\nfloat iridescenceIntensity;\n#endif\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nvec3 areaLightDiffuse;\n#ifdef SPECULARTERM\nvec3 areaLightSpecular;vec4 areaLightFresnel;\n#endif\n#endif\n};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N,vec3 posW) {preLightingInfo result;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\npreLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\npreLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));\n#endif\nreturn result;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\n#include<ltcHelperFunctions>\npreLightingInfo computeAreaPreLightingInfo(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec4 lightData,vec3 halfWidth,vec3 halfHeight,float roughness ) \n{preLightingInfo result;result.lightOffset=lightData.xyz-vPosition;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightData.xyz,halfWidth,halfHeight,roughness);\n#ifdef SPECULARTERM\nresult.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular; \n#endif\nresult.areaLightDiffuse=data.Diffuse;return result;}\n#endif\n";i.a.IncludesShadersStore.pbrDirectLightingFalloffFunctions="float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)\n{return max(0.,1.0-length(lightOffset)/range);}\nfloat computeDistanceLightFalloff_Physical(float lightDistanceSquared)\n{return 1.0/maxEps(lightDistanceSquared);}\nfloat computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)\n{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfloat computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)\n{falloff=max(0.,pow(cosAngle,exponent));}\nreturn falloff;}\nfloat computeDirectionalLightFalloff_IES(vec3 lightDirection,vec3 directionToLightCenterW,sampler2D iesLightSampler)\n{float cosAngle=dot(-lightDirection,directionToLightCenterW);float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}\nfloat computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)\n{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}\nfloat computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)\n{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}";i.a.IncludesShadersStore.pbrBRDFFunctions="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}\n#endif\n#ifdef ENVIRONMENTBRDF\nvec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup.rgb=fromRGBD(brdfLookup.rgba);\n#endif\nreturn brdfLookup.rgb;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfloat getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)\n{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nvec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nvec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}\n#endif\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\nfloat fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\n#ifdef CLEARCOAT\nvec3 getR0RemappedForClearCoat(vec3 f0) {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturate(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst mat3 XYZ_TO_REC709=mat3(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}\nvec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}\nfloat getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}\nvec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}\nvec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}\nfloat cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); \nvec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)\n{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}\nreturn max(I,vec3(0.0));}\n#endif\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}\n#ifdef SHEEN\nfloat normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)\n{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}\n#endif\n#ifdef ANISOTROPIC\nfloat normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {\n#ifdef MOBILE\nfloat GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);\n#else\nfloat a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfloat smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nfloat alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfloat smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)\n{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}\n#endif\n#ifdef ANISOTROPIC\nfloat smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}\n#endif\n#ifdef CLEARCOAT\nfloat visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }\n#endif\n#ifdef SHEEN\nfloat visibility_Ashikhmin(float NdotL,float NdotV)\n{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfloat l(float x,float alphaG)\n{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}\nfloat lambdaSheen(float cosTheta,float alphaG)\n{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}\nfloat visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)\n{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}\n#endif\n*/\n#endif\nfloat diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}\n#ifdef SS_TRANSLUCENCY\nvec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}\nfloat computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}\n#endif\n";i.a.IncludesShadersStore.hdrFilteringFunctions="#ifdef NUM_SAMPLES\n#if NUM_SAMPLES>0\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfloat radicalInverse_VdC(uint bits) \n{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }\nvec2 hammersley(uint i,uint N)\n{return vec2(float(i)/float(N),radicalInverse_VdC(i));}\n#else\nfloat vanDerCorpus(int n,int base)\n{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)\n{if(n>0)\n{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}\nreturn result;}\nvec2 hammersley(int i,int N)\n{return vec2(float(i)/float(N),vanDerCorpus(i,2));}\n#endif\nfloat log4(float x) {return log2(x)/2.;}\nvec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.0*PI;float phi=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}\nconst float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;\n#define inline\nvec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo\n#ifdef IBL_CDF_FILTERING\n,sampler2D icdfSampler\n#endif\n)\n{vec3 n=normalize(inputN);vec3 result=vec3(0.0);\n#ifndef IBL_CDF_FILTERING\nvec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);\n#endif\nfloat maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{vec2 Xi=hammersley(i,NUM_SAMPLES);\n#ifdef IBL_CDF_FILTERING\nvec2 T;T.x=textureLod(icdfSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureLod(icdfSampler,vec2(T.x,Xi.y),0.0).y;vec3 Ls=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));float NoL=dot(n,Ls);\n#else\nvec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);vec3 Ns=vec3(0.,0.,1.);float NoL=dot(Ns,Ls);\n#endif\nif (NoL>0.) {\n#ifdef IBL_CDF_FILTERING\nfloat pdf=textureLod(icdfSampler,T,0.0).z;vec3 c=textureCubeLodEXT(inputTexture,Ls,0.0).rgb;\n#else\nfloat pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.0,maxLevel);vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;\n#endif\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\n#ifdef IBL_CDF_FILTERING\nvec3 light=pdf<1e-6 ? vec3(0.0) : vec3(1.0)/vec3(pdf)*c;result+=NoL*light;\n#else\nresult+=c;\n#endif\n}}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}\n#define inline\nvec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; \nif (alphaG==0.) {\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;}}\nresult=result/weight;return result;}}\n#endif\n#endif\n";i.a.IncludesShadersStore.pbrDirectLightingFunctions="#define CLEARCOATREFLECTANCE90 1.0\nstruct lightingInfo\n{vec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef CLEARCOAT\nvec4 clearCoat;\n#endif\n#ifdef SHEEN\nvec3 sheen;\n#endif\n};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\nfloat lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nvec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nvec3 computeAreaDiffuseLighting(preLightingInfo info,vec3 lightColor) {return info.areaLightDiffuse*lightColor;}\n#endif\nvec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}\n#ifdef SS_TRANSLUCENCY\nvec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance,float transmittanceIntensity,vec3 surfaceAlbedo) {vec3 transmittanceNdotL=vec3(0.);float NdotL=absEps(info.NdotLUnclamped);if (info.NdotLUnclamped<0.0) {float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);}\nfloat diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return (transmittanceNdotL/PI+(1.0-transmittanceIntensity)*diffuseTerm*surfaceAlbedo*info.NdotL)*info.attenuation*lightColor;}\n#endif\n#ifdef SPECULARTERM\nvec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nfloat smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nvec3 computeAreaSpecularLighting(preLightingInfo info,vec3 specularColor) {vec3 fresnel=( specularColor*info.areaLightFresnel.x+( vec3( 1.0 )-specularColor )*info.areaLightFresnel.y );return specularColor*fresnel*info.areaLightSpecular;}\n#endif\n#endif\n#ifdef ANISOTROPIC\nvec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef CLEARCOAT\nvec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);}\nvec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}\n#endif\n#ifdef SHEEN\nvec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER\nfloat visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);\n#else */\nfloat visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */\nfloat sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n";i.a.IncludesShadersStore.pbrIBLFunctions="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}\nfloat getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfloat environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}\n#endif\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}\n#endif\n",n(471),n(472),n(468),n(475);i.a.IncludesShadersStore.pbrBlockAlbedoOpacity="struct albedoOpacityOutParams\n{vec3 surfaceAlbedo;float alpha;};\n#define pbr_inline\nalbedoOpacityOutParams albedoOpacityBlock(\nin vec4 vAlbedoColor\n#ifdef ALBEDO\n,in vec4 albedoTexture\n,in vec2 albedoInfos\n#endif\n,in float baseWeight\n#ifdef BASEWEIGHT\n,in vec4 baseWeightTexture\n,in vec2 vBaseWeightInfos\n#endif\n#ifdef OPACITY\n,in vec4 opacityMap\n,in vec2 vOpacityInfos\n#endif\n#ifdef DETAIL\n,in vec4 detailColor\n,in vec4 vDetailInfos\n#endif\n#ifdef DECAL\n,in vec4 decalColor\n,in vec4 vDecalInfos\n#endif\n)\n{albedoOpacityOutParams outParams;vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#ifndef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nsurfaceAlbedo*=vColor.rgb;\n#endif\n#ifdef DETAIL\nfloat detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; \n#endif\n#ifdef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\nsurfaceAlbedo*=baseWeight;\n#ifdef BASEWEIGHT\nsurfaceAlbedo*=baseWeightTexture.r;\n#endif\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST\n#if DEBUGMODE != 88\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}\n";i.a.IncludesShadersStore.pbrBlockReflectivity="struct reflectivityOutParams\n{float microSurface;float roughness;vec3 surfaceReflectivityColor;\n#ifdef METALLICWORKFLOW\nvec3 surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nvec3 ambientOcclusionColor;\n#endif\n#if DEBUGMODE>0\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness;\n#ifdef REFLECTIVITY\nvec4 surfaceMetallicColorMap;\n#endif\n#ifndef FROSTBITE_REFLECTANCE\nvec3 metallicF0;\n#endif\n#else\n#ifdef REFLECTIVITY\nvec4 surfaceReflectivityColorMap;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nreflectivityOutParams reflectivityBlock(\nin vec4 vReflectivityColor\n#ifdef METALLICWORKFLOW\n,in vec3 surfaceAlbedo\n,in vec4 metallicReflectanceFactors\n#endif\n#ifdef REFLECTIVITY\n,in vec3 reflectivityInfos\n,in vec4 surfaceMetallicOrReflectivityColorMap\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,in vec3 ambientOcclusionColorIn\n#endif\n#ifdef MICROSURFACEMAP\n,in vec4 microSurfaceTexel\n#endif\n#ifdef DETAIL\n,in vec4 detailColor\n,in vec4 vDetailInfos\n#endif\n)\n{reflectivityOutParams outParams;float microSurface=vReflectivityColor.a;vec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nfloat detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#if DEBUGMODE>0\noutParams.metallicRoughness=metallicRoughness;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\nmicroSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;\n#ifdef FROSTBITE_REFLECTANCE\noutParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);\n#else\nvec3 metallicF0=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=metallicF0;\n#endif\noutParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\n#endif\nmicroSurface=saturate(microSurface);float roughness=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;return outParams;}\n";i.a.IncludesShadersStore.pbrBlockAmbientOcclusion="struct ambientOcclusionOutParams\n{vec3 ambientOcclusionColor;\n#if DEBUGMODE>0 && defined(AMBIENT)\nvec3 ambientOcclusionColorMap;\n#endif\n};ambientOcclusionOutParams ambientOcclusionBlock(\n#ifdef AMBIENT\nin vec3 ambientOcclusionColorMap_,\nin vec4 vAmbientInfos\n#endif\n)\n{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}\n";i.a.IncludesShadersStore.pbrBlockAlphaFresnel="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{float alpha;};\n#define pbr_inline\nalphaFresnelOutParams alphaFresnelBlock(\nin vec3 normalW,\nin vec3 viewDirectionW,\nin float alpha,\nin float microSurface\n)\n{alphaFresnelOutParams outParams;float opacityPerceptual=alpha;\n#ifdef LINEARALPHAFRESNEL\nfloat opacity0=opacityPerceptual;\n#else\nfloat opacity0=opacityPerceptual*opacityPerceptual;\n#endif\nfloat opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\noutParams.alpha=1.0;\n#endif\n#endif\nreturn outParams;}\n#endif\n#endif\n";i.a.IncludesShadersStore.pbrBlockAnisotropic="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;\n#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)\nvec3 anisotropyMapData;\n#endif\n};\n#define pbr_inline\nanisotropicOutParams anisotropicBlock(\nin vec3 vAnisotropy,\nin float roughness,\n#ifdef ANISOTROPIC_TEXTURE\nin vec3 anisotropyMapData,\n#endif\nin mat3 TBN,\nin vec3 normalW,\nin vec3 viewDirectionW\n)\n{anisotropicOutParams outParams;float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nanisotropy*=anisotropyMapData.b;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\nanisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;\n#ifdef ANISOTROPIC_LEGACY\nanisotropyDirection.rg*=anisotropyMapData.rg;\n#else\nanisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);\n#endif\n#endif\nmat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}\n#endif\n";i.a.IncludesShadersStore.pbrBlockReflection="#ifdef REFLECTION\nstruct reflectionOutParams\n{vec4 environmentRadiance;vec3 environmentIrradiance;\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords;\n#else\nvec2 reflectionCoords;\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nvec3 irradianceVector;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nvoid createReflectionCoords(\nin vec3 vPositionW,\nin vec3 normalW,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REFLECTIONMAP_3D\nout vec3 reflectionCoords\n#else\nout vec2 reflectionCoords\n#endif\n)\n{\n#ifdef ANISOTROPIC\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n}\n#define pbr_inline\n#define inline\nvoid sampleReflectionTexture(\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nconst vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nconst vec2 reflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout vec4 environmentRadiance\n)\n{\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nfloat reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);} else {environmentRadiance=mix(\nenvironmentMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);\n#endif\nenvironmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}\n#define pbr_inline\n#define inline\nreflectionOutParams reflectionBlock(\nin vec3 vPositionW\n,in vec3 normalW\n,in float alphaG\n,in vec3 vReflectionMicrosurfaceInfos\n,in vec2 vReflectionInfos\n,in vec3 vReflectionColor\n#ifdef ANISOTROPIC\n,in anisotropicOutParams anisotropicOut\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,in float NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,in float roughness\n#endif\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSampler\n#else\n,in sampler2D reflectionSampler\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,in vec3 vEnvironmentIrradiance\n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,in mat4 reflectionMatrix\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,in samplerCube irradianceSampler\n#else\n,in sampler2D irradianceSampler\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSamplerLow\n,in samplerCube reflectionSamplerHigh\n#else\n,in sampler2D reflectionSamplerLow\n,in sampler2D reflectionSamplerHigh\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,in sampler2D icdfSampler\n#endif\n#endif\n)\n{reflectionOutParams outParams;vec4 environmentRadiance=vec4(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=vec3(0.);\n#else\nvec2 reflectionCoords=vec2(0.);\n#endif\ncreateReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\nreflectionCoords\n);sampleReflectionTexture(\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionSampler,\nreflectionCoords,\n#else\nreflectionSampler,\nreflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentRadiance\n);vec3 environmentIrradiance=vec3(0.,0.,0.);\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n#ifdef ANISOTROPIC\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n#endif\n);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec4 environmentIrradiance4=sampleReflection(irradianceSampler,irradianceVector);\n#else\nvec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);\n#endif\nenvironmentIrradiance=environmentIrradiance4.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance.rgb=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb;\n#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE\noutParams.environmentRadiance=vec4(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);\n#else\noutParams.environmentRadiance=environmentRadiance;\n#endif\noutParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}\n#endif\n";i.a.IncludesShadersStore.pbrBlockSheen="#ifdef SHEEN\nstruct sheenOutParams\n{float sheenIntensity;vec3 sheenColor;float sheenRoughness;\n#ifdef SHEEN_LINKWITHALBEDO\nvec3 surfaceAlbedo;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfloat sheenAlbedoScaling;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 finalSheenRadianceScaled;\n#endif\n#if DEBUGMODE>0\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 sheenEnvironmentReflectance;\n#endif\n#endif\n};\n#define pbr_inline\n#define inline\nsheenOutParams sheenBlock(\nin vec4 vSheenColor\n#ifdef SHEEN_ROUGHNESS\n,in float vSheenRoughness\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,in vec4 sheenMapRoughnessData\n#endif\n#endif\n,in float roughness\n#ifdef SHEEN_TEXTURE\n,in vec4 sheenMapData\n,in float sheenMapLevel\n#endif\n,in float reflectance\n#ifdef SHEEN_LINKWITHALBEDO\n,in vec3 baseColor\n,in vec3 surfaceAlbedo\n#endif\n#ifdef ENVIRONMENTBRDF\n,in float NdotV\n,in vec3 environmentBrdf\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,in vec2 AARoughnessFactors\n,in vec3 vReflectionMicrosurfaceInfos\n,in vec2 vReflectionInfos\n,in vec3 vReflectionColor\n,in vec4 vLightingIntensity\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSampler\n,in vec3 reflectionCoords\n#else\n,in sampler2D reflectionSampler\n,in vec2 reflectionCoords\n#endif\n,in float NdotVUnclamped\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSamplerLow\n,in samplerCube reflectionSamplerHigh\n#else\n,in sampler2D reflectionSamplerLow\n,in sampler2D reflectionSamplerHigh\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,in float seo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,in float eho\n#endif\n#endif\n)\n{sheenOutParams outParams;float sheenIntensity=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nfloat sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvec3 sheenColor=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\n#ifdef SHEEN_GAMMATEXTURE\nsheenColor.rgb*=toLinearSpace(sheenMapData.rgb);\n#else\nsheenColor.rgb*=sheenMapData.rgb;\n#endif\nsheenColor.rgb*=sheenMapLevel;\n#endif\n#ifdef SHEEN_ROUGHNESS\nfloat sheenRoughness=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#else\nfloat sheenRoughness=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\nsheenColor*=sheenIntensity;\n#endif\n#ifdef ENVIRONMENTBRDF\n/*#ifdef SHEEN_SOFTER\nvec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));\n#else*/\n#ifdef SHEEN_ROUGHNESS\nvec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvec3 environmentSheenBrdf=environmentBrdf;\n#endif\n/*#endif*/\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nfloat sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(\nsheenAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nsheenRoughness,\n#endif\nreflectionSampler,\nreflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentSheenRadiance\n);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\noutParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}\n#endif\n";i.a.IncludesShadersStore.pbrBlockClearcoat="struct clearcoatOutParams\n{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;\n#ifdef REFLECTION\nvec3 finalClearCoatRadianceScaled;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nvec3 energyConservationFactorClearCoat;\n#endif\n#if DEBUGMODE>0\n#ifdef CLEARCOAT_BUMP\nmat3 TBNClearCoat;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData;\n#endif\n#ifdef REFLECTION\nvec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;\n#endif\nfloat clearCoatNdotV;\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\n#define inline\nclearcoatOutParams clearcoatBlock(\nin vec3 vPositionW\n,in vec3 geometricNormalW\n,in vec3 viewDirectionW\n,in vec2 vClearCoatParams\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,in vec4 clearCoatMapRoughnessData\n#endif\n,in vec3 specularEnvironmentR0\n#ifdef CLEARCOAT_TEXTURE\n,in vec2 clearCoatMapData\n#endif\n#ifdef CLEARCOAT_TINT\n,in vec4 vClearCoatTintParams\n,in float clearCoatColorAtDistance\n,in vec4 vClearCoatRefractionParams\n#ifdef CLEARCOAT_TINT_TEXTURE\n,in vec4 clearCoatTintMapData\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,in vec2 vClearCoatBumpInfos\n,in vec4 clearCoatBumpMapData\n,in vec2 vClearCoatBumpUV\n#if defined(TANGENT) && defined(NORMAL)\n,in mat3 vTBN\n#else\n,in vec2 vClearCoatTangentSpaceParams\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,in mat4 normalMatrix\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,in vec3 faceNormal\n#endif\n#ifdef REFLECTION\n,in vec3 vReflectionMicrosurfaceInfos\n,in vec2 vReflectionInfos\n,in vec3 vReflectionColor\n,in vec4 vLightingIntensity\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSampler\n#else\n,in sampler2D reflectionSampler\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,in samplerCube reflectionSamplerLow\n,in samplerCube reflectionSamplerHigh\n#else\n,in sampler2D reflectionSamplerLow\n,in sampler2D reflectionSamplerHigh\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vReflectionFilteringInfo\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,in float frontFacingMultiplier\n#endif\n)\n{clearcoatOutParams outParams;float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\n#ifdef CLEARCOAT_TINT_GAMMATEXTURE\nclearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);\n#else\nclearCoatColor*=clearCoatTintMapData.rgb;\n#endif\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;\n#endif\n#ifdef CLEARCOAT_REMAP_F0\nvec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvec3 specularEnvironmentR0Updated=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nfloat clearCoatNormalScale=1.0;\n#else\nfloat clearCoatNormalScale=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBNClearCoat=vTBN;\n#else\nvec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))\nvec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n#if defined(REFLECTION)\nfloat clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 clearCoatReflectionCoords=clearCoatReflectionVector;\n#else\nvec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nsampleReflectionTexture(\nclearCoatAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nclearCoatNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nclearCoatRoughness,\n#endif\nreflectionSampler,\nclearCoatReflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentClearCoatRadiance\n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\nfloat fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\nreturn outParams;}\n#endif\n";i.a.IncludesShadersStore.pbrBlockIridescence="struct iridescenceOutParams\n{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};\n#ifdef IRIDESCENCE\n#define pbr_inline\n#define inline\niridescenceOutParams iridescenceBlock(\nin vec4 vIridescenceParams\n,in float viewAngle\n,in vec3 specularEnvironmentR0\n#ifdef IRIDESCENCE_TEXTURE\n,in vec2 iridescenceMapData\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,in vec2 iridescenceThicknessMapData\n#endif\n#ifdef CLEARCOAT\n,in float NdotVUnclamped\n#ifdef CLEARCOAT_TEXTURE\n,in vec2 clearCoatMapData\n#endif\n#endif\n)\n{iridescenceOutParams outParams;float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;\n#ifdef IRIDESCENCE_TEXTURE\niridescenceIntensity*=iridescenceMapData.x;\n#endif\n#if defined(IRIDESCENCE_THICKNESS_TEXTURE)\niridescenceThicknessWeight=iridescenceThicknessMapData.g;\n#endif\nfloat iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; \n#ifdef CLEARCOAT\nfloat clearCoatIntensity=vClearCoatParams.x;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#endif\ntopIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));\n#endif\nvec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}\n#endif\n";i.a.IncludesShadersStore.pbrBlockSubSurface="struct subSurfaceOutParams\n{vec3 specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvec3 finalRefraction;vec3 surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nfloat alpha;\n#endif\n#ifdef REFLECTION\nfloat refractionFactorForIrradiance;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvec3 transmittance;float translucencyIntensity;\n#ifdef REFLECTION\nvec3 refractionIrradiance;\n#endif\n#endif\n#if DEBUGMODE>0\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction;vec3 refractionTransmittance;\n#endif\n#endif\n};\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#define pbr_inline\n#define inline\nvec4 sampleEnvironmentRefraction(\nin float ior\n,in float thickness\n,in float refractionLOD\n,in vec3 normalW\n,in vec3 vPositionW\n,in vec3 viewDirectionW\n,in mat4 view\n,in vec4 vRefractionInfos\n,in mat4 refractionMatrix\n,in vec4 vRefractionMicrosurfaceInfos\n,in float alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,in samplerCube refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in samplerCube refractionSamplerLow\n,in samplerCube refractionSamplerHigh\n#endif\n#else\n,in sampler2D refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in sampler2D refractionSamplerLow\n,in sampler2D refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,in anisotropicOutParams anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,in vec3 refractionPosition\n,in vec3 refractionSize\n#endif\n) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);\n#else\nvec3 refractionVector=refract(-viewDirectionW,normalW,ior);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n#ifdef SS_REFRACTIONMAP_3D\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\n#ifdef SS_USE_THICKNESS_AS_DEPTH\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\n#endif\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef LODBASEDMICROSFURACE\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\n#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)\nenvironmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nfloat lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);} else {environmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);}\n#endif\n#ifdef SS_RGBDREFRACTION\nenvironmentRefraction.rgb=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nenvironmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);\n#endif\nreturn environmentRefraction;}\n#endif\n#define pbr_inline\n#define inline\nsubSurfaceOutParams subSurfaceBlock(\nin vec3 vSubSurfaceIntensity\n,in vec2 vThicknessParam\n,in vec4 vTintColor\n,in vec3 normalW\n,in vec3 specularEnvironmentReflectance\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,in vec4 thicknessMap\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,in vec4 refractionIntensityMap\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,in vec4 translucencyIntensityMap\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,in mat4 reflectionMatrix\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,in vec3 irradianceVector_\n#endif\n#if defined(REALTIME_FILTERING)\n,in samplerCube reflectionSampler\n,in vec2 vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,in sampler2D icdfSampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,in samplerCube irradianceSampler\n#else\n,in sampler2D irradianceSampler\n#endif\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,in vec3 surfaceAlbedo\n#endif\n#ifdef SS_REFRACTION\n,in vec3 vPositionW\n,in vec3 viewDirectionW\n,in mat4 view\n,in vec4 vRefractionInfos\n,in mat4 refractionMatrix\n,in vec4 vRefractionMicrosurfaceInfos\n,in vec4 vLightingIntensity\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,in float alpha\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,in float NdotVUnclamped\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,in float roughness\n#endif\n,in float alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,in samplerCube refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in samplerCube refractionSamplerLow\n,in samplerCube refractionSamplerHigh\n#endif\n#else\n,in sampler2D refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in sampler2D refractionSamplerLow\n,in sampler2D refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,in anisotropicOutParams anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,in vec3 refractionPosition\n,in vec3 refractionSize\n#endif\n#ifdef SS_DISPERSION\n,in float dispersion\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,in vec3 vDiffusionDistance\n,in vec4 vTranslucencyColor\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,in vec4 translucencyColorMap\n#endif\n#endif\n)\n{subSurfaceOutParams outParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nfloat refractionIntensity=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);outParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nfloat translucencyIntensity=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#ifdef SS_USE_GLTF_TEXTURES\nfloat thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#else\nfloat thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#endif\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=thicknessMap.r;\n#else\nrefractionIntensity*=thicknessMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=thicknessMap.a;\n#else\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#endif\n#else\nfloat thickness=vThicknessParam.y;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=refractionIntensityMap.r;\n#else\nrefractionIntensity*=refractionIntensityMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=translucencyIntensityMap.a;\n#else\ntranslucencyIntensity*=translucencyIntensityMap.b;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);vec4 translucencyColor=vTranslucencyColor;\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\ntranslucencyColor*=translucencyColorMap;\n#endif\nvec3 transmittance=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef SS_HAS_THICKNESS\nfloat ior=vRefractionInfos.y;\n#else\nfloat ior=vRefractionMicrosurfaceInfos.w;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nfloat refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nfloat refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);\n#else\nfloat refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);\n#endif\nfloat refraction_ior=vRefractionInfos.y;\n#ifdef SS_DISPERSION\nfloat realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];\n#endif\nvec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#else\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition\n,refractionSize\n#endif\n);\n#ifdef SS_DISPERSION\nenvironmentRefraction[i]=envSample[i];}\n#else\nenvironmentRefraction=envSample;\n#endif\nenvironmentRefraction.rgb*=vRefractionInfos.x;\n#endif\n#ifdef SS_REFRACTION\nvec3 refractionTransmittance=vec3(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\nfloat maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;\n#else\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\nenvironmentRefraction.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);\n#ifdef REFLECTION\noutParams.refractionFactorForIrradiance=(1.-refractionIntensity);\n#endif\n#ifdef UNUSED_MULTIPLEBOUNCES\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);\n#endif\nrefractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvec3 irradianceVector=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n#endif\n);\n#else\nvec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec3 irradianceCoords=irradianceVector;\n#else\nvec2 irradianceCoords=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);\n#ifdef RGBDREFLECTION\nrefractionIrradiance.rgb=fromRGBD(refractionIrradiance);\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);\n#endif\n#else\nvec4 refractionIrradiance=vec4(0.);\n#endif\nrefractionIrradiance.rgb*=transmittance;\n#ifdef SS_ALBEDOFORTRANSLUCENCYTINT\nrefractionIrradiance.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.refractionIrradiance=refractionIrradiance.rgb;\n#endif\nreturn outParams;}\n#endif\n",n(343);i.a.IncludesShadersStore.pbrBlockNormalGeometric="vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\nvec3 geometricNormalW=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;\n#endif\n",n(474);i.a.IncludesShadersStore.pbrBlockNormalFinal="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n",n(476);i.a.IncludesShadersStore.pbrBlockLightmapInit="#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor.rgb=toLinearSpace(lightmapColor.rgb);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n";i.a.IncludesShadersStore.pbrBlockGeometryInfo="float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\nvec3 environmentBrdf=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=aoOut.ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n";i.a.IncludesShadersStore.pbrBlockReflectance0="float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);\n#else \nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);\n#endif\n#ifdef ALPHAFRESNEL\nfloat reflectance90=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n";i.a.IncludesShadersStore.pbrBlockReflectance="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);\n#ifdef RADIANCEOCCLUSION\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\nvec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\nspecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nspecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n";i.a.IncludesShadersStore.pbrBlockDirectLighting="vec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvec3 clearCoatBase=vec3(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvec3 sheenBase=vec3(0.,0.,0.);\n#endif\npreLightingInfo preInfo;lightingInfo info;float shadow=1.; \nfloat aggShadow=0.;float numLights=0.;\n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvec3 absorption=vec3(0.);\n#endif\n",n(477);i.a.IncludesShadersStore.pbrBlockFinalLitComponents="aggShadow=aggShadow/numLights;\n#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n#ifdef REFLECTION\nvec3 finalIrradiance=reflectionOut.environmentIrradiance;\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\nfinalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef REFLECTION\nvec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef SHEEN\nvec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef CLEARCOAT\nvec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n";i.a.IncludesShadersStore.pbrBlockFinalUnlitComponents="vec3 finalDiffuse=diffuseBase;\n#if !defined(SS_TRANSLUCENCY)\nfinalDiffuse*=surfaceAlbedo.rgb;\n#endif\nfinalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\n#ifdef GAMMAEMISSIVE\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\n#else\nfinalEmissive*=emissiveColorTex.rgb;\n#endif\nfinalEmissive*= vEmissiveInfos.y;\n#endif\nfinalEmissive*=vLightingIntensity.y;\n#ifdef AMBIENT\nvec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);\n#else\nvec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;\n";i.a.IncludesShadersStore.pbrBlockFinalColorComposition="vec4 finalColor=vec4(\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalAmbient +\nfinalDiffuse,\nalpha);\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor.rgb;\n#else\nfinalColor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\nfinalColor.rgb+=finalEmissive;\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,0.0);\n",n(478),n(479);i.a.IncludesShadersStore.pbrBlockImageProcessing="#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)\n#if !defined(SKIPFINALCOLORCLAMP)\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#endif\n#else\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\nfinalColor.rgb*=finalColor.a;\n#endif\n";i.a.IncludesShadersStore.pbrBlockPrePass="float writeGeometryInfo=finalColor.a>ALPHATESTVALUE ? 1.0 : 0.0;\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\ngl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);\n#endif\n#if defined(PREPASS_VELOCITY)\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\ngl_FragData[PREPASS_ALBEDO_INDEX]=vec4(surfaceAlbedo,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nvec3 sqAlbedo=sqrt(surfaceAlbedo); \n#endif\n#ifdef PREPASS_IRRADIANCE\nvec3 irradiance=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\n#ifdef SS_SCATTERING\n#ifdef PREPASS_COLOR\ngl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb-irradiance,finalColor.a); \n#endif\nirradiance/=sqAlbedo;\n#else\n#ifdef PREPASS_COLOR\ngl_FragData[PREPASS_COLOR_INDEX]=finalColor; \n#endif\nfloat scatteringDiffusionProfile=255.;\n#endif\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); \n#elif defined(PREPASS_COLOR)\ngl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\ngl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);\n#else\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\ngl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo); \n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#ifndef UNLIT\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;\n#endif\n#endif\n",n(480);i.a.IncludesShadersStore.pbrDebug="#if DEBUGMODE>0\nif (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {\n#if DEBUGMODE==1\ngl_FragColor.rgb=vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==2 && defined(NORMAL)\ngl_FragColor.rgb=vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==5\ngl_FragColor.rgb=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==6 && defined(MAINUV1)\ngl_FragColor.rgb=vec3(vMainUV1,0.0);\n#elif DEBUGMODE==7 && defined(MAINUV2)\ngl_FragColor.rgb=vec3(vMainUV2,0.0);\n#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==10 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==11 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==12 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==13 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==20 && defined(ALBEDO)\ngl_FragColor.rgb=albedoTexture.rgb;\n#ifndef GAMMAALBEDO\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==21 && defined(AMBIENT)\ngl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE==22 && defined(OPACITY)\ngl_FragColor.rgb=opacityMap.rgb;\n#elif DEBUGMODE==23 && defined(EMISSIVE)\ngl_FragColor.rgb=emissiveColorTex.rgb;\n#ifndef GAMMAEMISSIVE\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==24 && defined(LIGHTMAP)\ngl_FragColor.rgb=lightmapColor.rgb;\n#ifndef GAMMALIGHTMAP\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ngl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ngl_FragColor.rgb=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ngl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ngl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;\n#elif DEBUGMODE==32 && defined(BUMP)\ngl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;\n#elif DEBUGMODE==40 && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==41 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)\ngl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==50\ngl_FragColor.rgb=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==51 && defined(SPECULARTERM)\ngl_FragColor.rgb=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==52 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==53 && defined(SHEEN)\ngl_FragColor.rgb=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==54 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==60\ngl_FragColor.rgb=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==61\ngl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);\n#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.metallicF0;\n#elif DEBUGMODE==63\ngl_FragColor.rgb=vec3(roughness);\n#elif DEBUGMODE==64\ngl_FragColor.rgb=vec3(alphaG);\n#elif DEBUGMODE==65\ngl_FragColor.rgb=vec3(NdotV);\n#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ngl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==67 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE==68 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ngl_FragColor.rgb=subSurfaceOut.transmittance;\n#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.refractionTransmittance;\n#elif DEBUGMODE==72\ngl_FragColor.rgb=vec3(microSurface);\n#elif DEBUGMODE==73\ngl_FragColor.rgb=vAlbedoColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vReflectivityColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==75\ngl_FragColor.rgb=vEmissiveColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)\ngl_FragColor.rgb=vec3(seo);\n#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\ngl_FragColor.rgb=vec3(eho);\n#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ngl_FragColor.rgb=vec3(energyConservationFactor);\n#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=specularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)\ngl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==86 && defined(ALPHABLEND)\ngl_FragColor.rgb=vec3(luminanceOverAlpha);\n#elif DEBUGMODE==87\ngl_FragColor.rgb=vec3(alpha);\n#elif DEBUGMODE==88 && defined(ALBEDO)\ngl_FragColor.rgb=vec3(albedoTexture.a);\n#elif DEBUGMODE==89\ngl_FragColor.rgb=aoOut.ambientOcclusionColor.rgb;\n#else\nfloat stripeWidth=30.;float stripePos=floor(gl_FragCoord.x/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);\n#endif\ngl_FragColor.rgb*=vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ngl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ngl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);\n#endif\ngl_FragColor.a=1.0;\n#ifdef PREPASS\ngl_FragData[0]=toLinearSpace(gl_FragColor); \ngl_FragData[1]=vec4(0.,0.,0.,0.); \n#endif\n#ifdef DEBUGMODE_FORCERETURN\nreturn;\n#endif\n}\n#endif\n";const r="#define CUSTOM_FRAGMENT_EXTENSION\n#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\nprecision highp float;\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<__decl__pbrFragment>\n#include<pbrFragmentExtraDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockIridescence>\n#include<pbrBlockSubSurface>\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\nalbedoOpacityOutParams albedoOpacityOut;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#endif\n#ifdef BASEWEIGHT\nvec4 baseWeightTexture=texture2D(baseWeightSampler,vBaseWeightUV+uvOffset);\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#endif\nalbedoOpacityOut=albedoOpacityBlock(\nvAlbedoColor\n#ifdef ALBEDO\n,albedoTexture\n,vAlbedoInfos\n#endif\n,baseWeight\n#ifdef BASEWEIGHT\n,baseWeightTexture\n,vBaseWeightInfos\n#endif\n#ifdef OPACITY\n,opacityMap\n,vOpacityInfos\n#endif\n#ifdef DETAIL\n,detailColor\n,vDetailInfos\n#endif\n#ifdef DECAL\n,decalColor\n,vDecalInfos\n#endif\n);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nambientOcclusionOutParams aoOut;\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;\n#endif\naoOut=ambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nvAmbientInfos\n#endif\n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvec3 diffuseBase=vec3(1.,1.,1.);\n#else \nvec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;\n#if defined(REFLECTIVITY)\nvec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\n#ifdef REFLECTIVITY_GAMMA\nsurfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);\n#endif\nsurfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef METALLICWORKFLOW\nvec4 metallicReflectanceFactors=vMetallicReflectanceFactors;\n#ifdef REFLECTANCE\nvec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);\n#ifdef REFLECTANCE_GAMMA\nreflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);\n#endif\nmetallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;\n#endif\n#ifdef METALLIC_REFLECTANCE\nvec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);\n#ifdef METALLIC_REFLECTANCE_GAMMA\nmetallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);\n#endif\n#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY\nmetallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;\n#endif\nmetallicReflectanceFactors*=metallicReflectanceFactorsMap.a;\n#endif\n#endif\nreflectivityOut=reflectivityBlock(\nvReflectivityColor\n#ifdef METALLICWORKFLOW\n,surfaceAlbedo\n,metallicReflectanceFactors\n#endif\n#ifdef REFLECTIVITY\n,vReflectivityInfos\n,surfaceMetallicOrReflectivityColorMap\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,aoOut.ambientOcclusionColor\n#endif\n#ifdef MICROSURFACEMAP\n,microSurfaceTexel\n#endif\n#ifdef DETAIL\n,detailColor\n,vDetailInfos\n#endif\n);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nalphaFresnelOutParams alphaFresnelOut;alphaFresnelOut=alphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface\n);alpha=alphaFresnelOut.alpha;\n#endif\n#endif\n#include<pbrBlockGeometryInfo>\n#ifdef ANISOTROPIC\nanisotropicOutParams anisotropicOut;\n#ifdef ANISOTROPIC_TEXTURE\nvec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;\n#endif\nanisotropicOut=anisotropicBlock(\nvAnisotropy,\nroughness,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW\n);\n#endif\n#ifdef REFLECTION\nreflectionOutParams reflectionOut;\n#ifndef USE_CUSTOM_REFLECTION\nreflectionOut=reflectionBlock(\nvPositionW\n,normalW\n,alphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness\n#endif\n,reflectionSampler\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,vEnvironmentIrradiance\n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,reflectionMatrix\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n#endif\n#ifndef LODBASEDMICROSFURACE\n,reflectionSamplerLow\n,reflectionSamplerHigh\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n#endif\n#endif\n);\n#else\n#define CUSTOM_REFLECTION\n#endif\n#endif\n#include<pbrBlockReflectance0>\n#ifdef SHEEN\nsheenOutParams sheenOut;\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;\n#endif\nsheenOut=sheenBlock(\nvSheenColor\n#ifdef SHEEN_ROUGHNESS\n,vSheenRoughness\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,sheenMapRoughnessData\n#endif\n#endif\n,roughness\n#ifdef SHEEN_TEXTURE\n,sheenMapData\n,vSheenInfos.y\n#endif\n,reflectance\n#ifdef SHEEN_LINKWITHALBEDO\n,baseColor\n,surfaceAlbedo\n#endif\n#ifdef ENVIRONMENTBRDF\n,NdotV\n,environmentBrdf\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,AARoughnessFactors\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n,vLightingIntensity\n,reflectionSampler\n,reflectionOut.reflectionCoords\n,NdotVUnclamped\n#ifndef LODBASEDMICROSFURACE\n,reflectionSamplerLow\n,reflectionSamplerHigh\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,seo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,eho\n#endif\n#endif\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;\n#endif\n#endif\n#ifdef IRIDESCENCE\niridescenceOutParams iridescenceOut;\n#ifdef IRIDESCENCE_TEXTURE\nvec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nvec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;\n#endif\niridescenceOut=iridescenceBlock(\nvIridescenceParams\n,NdotV\n,specularEnvironmentR0\n#ifdef IRIDESCENCE_TEXTURE\n,iridescenceMapData\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,iridescenceThicknessMapData\n#endif\n#ifdef CLEARCOAT\n,NdotVUnclamped\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#endif\n);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;\n#endif\nclearcoatOutParams clearcoatOut;\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);\n#endif\n#ifdef CLEARCOAT_BUMP\nvec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatOut=clearcoatBlock(\nvPositionW\n,geometricNormalW\n,viewDirectionW\n,vClearCoatParams\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,clearCoatMapRoughnessData\n#endif\n,specularEnvironmentR0\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#ifdef CLEARCOAT_TINT\n,vClearCoatTintParams\n,clearCoatColorAtDistance\n,vClearCoatRefractionParams\n#ifdef CLEARCOAT_TINT_TEXTURE\n,clearCoatTintMapData\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,vClearCoatBumpInfos\n,clearCoatBumpMapData\n,vClearCoatBumpUV\n#if defined(TANGENT) && defined(NORMAL)\n,vTBN\n#else\n,vClearCoatTangentSpaceParams\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,normalMatrix\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,faceNormal\n#endif\n#ifdef REFLECTION\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n,vLightingIntensity\n,reflectionSampler\n#ifndef LODBASEDMICROSFURACE\n,reflectionSamplerLow\n,reflectionSamplerHigh\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,(gl_FrontFacing ? 1. : -1.)\n#endif\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n#include<pbrBlockReflectance>\nsubSurfaceOutParams subSurfaceOut;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nvec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nvec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nvec4 translucencyColorMap=texture2D(translucencyColorSampler,vTranslucencyColorUV+uvOffset);\n#endif\nsubSurfaceOut=subSurfaceBlock(\nvSubSurfaceIntensity\n,vThicknessParam\n,vTintColor\n,normalW\n,specularEnvironmentReflectance\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,thicknessMap\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,refractionIntensityMap\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,translucencyIntensityMap\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,reflectionMatrix\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,reflectionOut.irradianceVector\n#endif\n#if defined(REALTIME_FILTERING)\n,reflectionSampler\n,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,surfaceAlbedo\n#endif\n#ifdef SS_REFRACTION\n,vPositionW\n,viewDirectionW\n,view\n,vRefractionInfos\n,refractionMatrix\n,vRefractionMicrosurfaceInfos\n,vLightingIntensity\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,alpha\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,NdotVUnclamped\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,roughness\n#endif\n,alphaG\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,vRefractionPosition\n,vRefractionSize\n#endif\n#ifdef SS_DISPERSION\n,dispersion\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,vDiffusionDistance\n,vTranslucencyColor\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,translucencyColorMap\n#endif\n#endif\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#endif\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n#include<pbrBlockFinalLitComponents>\n#endif \n#include<pbrBlockFinalUnlitComponents>\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\n#include<pbrBlockPrePass>\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i.a.ShadersStore.pbrPixelShader=r;const s={name:"pbrPixelShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"pbrPixelShaderWGSL",(function(){return s}));var i=n(66);n(426),n(427),n(481),n(368);i.a.IncludesShadersStoreWGSL.pbrFragmentExtraDeclaration="varying vPositionW: vec3f;\n#if DEBUGMODE>0\nvarying vClipSpacePosition: vec4f;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vEnvironmentIrradiance: vec3f;\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n",n(428),n(386);i.a.IncludesShadersStoreWGSL.samplerFragmentAlternateDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying v_VARYINGNAME_UV: vec2f;\n#endif\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrFragmentSamplersDeclaration="#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef CLEARCOAT\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nvar clearCoatRoughnessSamplerSampler: sampler;var clearCoatRoughnessSampler: texture_2d<f32>;\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)\nvar sheenRoughnessSamplerSampler: sampler;var sheenRoughnessSampler: texture_2d<f32>;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;\n#endif\n#ifdef USEIRRADIANCEMAP\nvar irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;\n#endif\n#else\nvar reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;\n#endif\n#ifdef USEIRRADIANCEMAP\nvar irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nvar environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;\n#endif\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nvar areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\nvar refractionSamplerSampler: sampler;var refractionSampler: texture_cube<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_cube<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_cube<f32>;\n#endif\n#else\nvar refractionSamplerSampler: sampler;var refractionSampler: texture_2d<f32>;\n#ifdef LODBASEDMICROSFURACE\n#else\nvar refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_2d<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_2d<f32>;\n#endif\n#endif\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)\n#endif\n#ifdef IBL_CDF_FILTERING\nvar icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;\n#endif\n",n(432),n(355),n(369),n(436),n(322),i.a.IncludesShadersStoreWGSL.subSurfaceScatteringFunctions="fn testLightingForSSS(diffusionProfile: f32)->bool\n{return diffusionProfile<1.;}";i.a.IncludesShadersStoreWGSL.importanceSampling="fn hemisphereCosSample(u: vec2f)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=1.-u.y;var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nfn hemisphereImportanceSampleDggx(u: vec2f,a: f32)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nfn hemisphereImportanceSampleDCharlie(u: vec2f,a: f32)->vec3f { \nvar phi: f32=2.*PI*u.x;var sinTheta: f32=pow(u.y,a/(2.*a+1.));var cosTheta: f32=sqrt(1.-sinTheta*sinTheta);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}";i.a.IncludesShadersStoreWGSL.pbrHelperFunctions="#define MINIMUMVARIANCE 0.0005\nfn convertRoughnessToAverageSlope(roughness: f32)->f32\n{return roughness*roughness+MINIMUMVARIANCE;}\nfn fresnelGrazingReflectance(reflectance0: f32)->f32 {var reflectance90: f32=saturate(reflectance0*25.0);return reflectance90;}\nfn getAARoughnessFactors(normalVector: vec3f)->vec2f {\n#ifdef SPECULARAA\nvar nDfdx: vec3f=dpdx(normalVector.xyz);var nDfdy: vec3f=dpdy(normalVector.xyz);var slopeSquare: f32=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));var geometricRoughnessFactor: f32=pow(saturate(slopeSquare),0.333);var geometricAlphaGFactor: f32=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2f(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2f(0.);\n#endif\n}\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_LEGACY\nfn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}\nfn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var anisotropicFrameDirection: vec3f=select(T,B,anisotropy>=0.0);var anisotropicFrameTangent: vec3f=cross(normalize(anisotropicFrameDirection),V);var anisotropicFrameNormal: vec3f=cross(anisotropicFrameTangent,anisotropicFrameDirection);var anisotropicNormal: vec3f=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}\n#else\nfn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG,MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}\nfn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var bentNormal: vec3f=cross(B,V);bentNormal=normalize(cross(bentNormal,B));var sq=1.0-anisotropy*(1.0-roughness);var a: f32=sq*sq*sq*sq;bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}\n#endif\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\nfn cocaLambertVec3(alpha: vec3f,distance: f32)->vec3f {return exp(-alpha*distance);}\nfn cocaLambert(NdotVRefract: f32,NdotLRefract: f32,alpha: vec3f,thickness: f32)->vec3f {return cocaLambertVec3(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}\nfn computeColorAtDistanceInMedia(color: vec3f,distance: f32)->vec3f {return -log(color)/distance;}\nfn computeClearCoatAbsorption(NdotVRefract: f32,NdotLRefract: f32,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var clearCoatAbsorption: vec3f=mix( vec3f(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);return clearCoatAbsorption;}\n#endif\n#ifdef MICROSURFACEAUTOMATIC\nfn computeDefaultMicroSurface(microSurface: f32,reflectivityColor: vec3f)->f32\n{const kReflectivityNoAlphaWorkflow_SmoothnessMax: f32=0.95;var reflectivityLuminance: f32=getLuminance(reflectivityColor);var reflectivityLuma: f32=sqrt(reflectivityLuminance);var resultMicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return resultMicroSurface;}\n#endif\n",n(433),n(430),n(482),n(429);i.a.IncludesShadersStoreWGSL.pbrDirectLightingSetupFunctions="struct preLightingInfo\n{lightOffset: vec3f,\nlightDistanceSquared: f32,\nlightDistance: f32,\nattenuation: f32,\nL: vec3f,\nH: vec3f,\nNdotV: f32,\nNdotLUnclamped: f32,\nNdotL: f32,\nVdotH: f32,\nroughness: f32,\n#ifdef IRIDESCENCE\niridescenceIntensity: f32\n#endif\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nareaLightDiffuse: vec3f,\n#ifdef SPECULARTERM\nareaLightSpecular: vec3f,\nareaLightFresnel: vec4f\n#endif\n#endif\n};fn computePointAndSpotPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f,posW: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\nfn computeDirectionalPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\nfn computeHemisphericPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));\n#endif\nreturn result;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\n#include<ltcHelperFunctions>\nfn computeAreaPreLightingInfo(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightCenter:vec3f,halfWidth:vec3f, halfHeight:vec3f,roughness:f32)->preLightingInfo {var result: preLightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightCenter,halfWidth,halfHeight,roughness);\n#ifdef SPECULARTERM\nresult.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular;\n#endif\nresult.areaLightDiffuse+=data.Diffuse;return result;}\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrDirectLightingFalloffFunctions="fn computeDistanceLightFalloff_Standard(lightOffset: vec3f,range: f32)->f32\n{return max(0.,1.0-length(lightOffset)/range);}\nfn computeDistanceLightFalloff_Physical(lightDistanceSquared: f32)->f32\n{return 1.0/maxEps(lightDistanceSquared);}\nfn computeDistanceLightFalloff_GLTF(lightDistanceSquared: f32,inverseSquaredRange: f32)->f32\n{var lightDistanceFalloff: f32=1.0/maxEps(lightDistanceSquared);var factor: f32=lightDistanceSquared*inverseSquaredRange;var attenuation: f32=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}\nfn computeDirectionalLightFalloff_IES(lightDirection: vec3f,directionToLightCenterW: vec3f,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32\n{var cosAngle: f32=dot(-lightDirection,directionToLightCenterW);var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}\nfn computeDistanceLightFalloff(lightOffset: vec3f,lightDistanceSquared: f32,range: f32,inverseSquaredRange: f32)->f32\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfn computeDirectionalLightFalloff_Standard(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32)->f32\n{var falloff: f32=0.0;var cosAngle: f32=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)\n{falloff=max(0.,pow(cosAngle,exponent));}\nreturn falloff;}\nfn computeDirectionalLightFalloff_Physical(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32)->f32\n{const kMinusLog2ConeAngleIntensityRatio: f32=6.64385618977; \nvar concentrationKappa: f32=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);var lightDirectionSpreadSG: vec4f= vec4f(-lightDirection*concentrationKappa,-concentrationKappa);var falloff: f32=exp2(dot( vec4f(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}\nfn computeDirectionalLightFalloff_GLTF(lightDirection: vec3f,directionToLightCenterW: vec3f,lightAngleScale: f32,lightAngleOffset: f32)->f32\n{var cd: f32=dot(-lightDirection,directionToLightCenterW);var falloff: f32=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}\nfn computeDirectionalLightFalloff(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32,lightAngleScale: f32,lightAngleOffset: f32)->f32\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}";i.a.IncludesShadersStoreWGSL.pbrBRDFFunctions="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nfn getEnergyConservationFactor(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}\n#endif\n#ifdef ENVIRONMENTBRDF\nfn getBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {var UV: vec2f= vec2f(NdotV,perceptualRoughness);var brdfLookup: vec4f= textureSample(environmentBrdfSampler,environmentBrdfSamplerSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup=vec4f(fromRGBD(brdfLookup.rgba),brdfLookup.a);\n#endif\nreturn brdfLookup.rgb;}\nfn getReflectanceFromBRDFWithEnvLookup(specularEnvironmentR0: vec3f,specularEnvironmentR90: vec3f,environmentBrdf: vec3f)->vec3f {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvar reflectance: vec3f=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvar reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;}\nfn getReflectanceFromBRDFLookup(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvar reflectance: vec3f=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvar reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfn getBRDFLookupCharlieSheen(NdotV: f32,perceptualRoughness: f32)->f32\n{var c: f32=1.0-NdotV;var c3: f32=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nfn getReflectanceFromAnalyticalBRDFLookup_Jones(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f\n{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nfn getSheenReflectanceFromBRDFLookup(reflectance0: vec3f,environmentBrdf: vec3f)->vec3f {var sheenEnvironmentReflectance: vec3f=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}\n#endif\nfn fresnelSchlickGGXVec3(VdotH: f32,reflectance0: vec3f,reflectance90: vec3f)->vec3f\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\nfn fresnelSchlickGGX(VdotH: f32,reflectance0: f32,reflectance90: f32)->f32\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\n#ifdef CLEARCOAT\nfn getR0RemappedForClearCoat(f0: vec3f)->vec3f {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturateVec3(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturateVec3(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvar s: vec3f=sqrt(f0);var t: vec3f=(uniforms.vClearCoatRefractionParams.z+uniforms.vClearCoatRefractionParams.w*s)/(uniforms.vClearCoatRefractionParams.w+uniforms.vClearCoatRefractionParams.z*s);return squareVec3(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst XYZ_TO_REC709: mat3x3f= mat3x3f(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);fn getIORTfromAirToSurfaceR0(f0: vec3f)->vec3f {var sqrtF0: vec3f=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}\nfn getR0fromIORsVec3(iorT: vec3f,iorI: f32)->vec3f {return squareVec3((iorT- vec3f(iorI))/(iorT+ vec3f(iorI)));}\nfn getR0fromIORs(iorT: f32,iorI: f32)->f32 {return square((iorT-iorI)/(iorT+iorI));}\nfn evalSensitivity(opd: f32,shift: vec3f)->vec3f {var phase: f32=2.0*PI*opd*1.0e-9;const val: vec3f= vec3f(5.4856e-13,4.4201e-13,5.2481e-13);const pos: vec3f= vec3f(1.6810e+06,1.7953e+06,2.2084e+06);const vr: vec3f= vec3f(4.3278e+09,9.3046e+09,6.6121e+09);var xyz: vec3f=val*sqrt(2.0*PI*vr)*cos(pos*phase+shift)*exp(-square(phase)*vr);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;var srgb: vec3f=XYZ_TO_REC709*xyz;return srgb;}\nfn evalIridescence(outsideIOR: f32,eta2: f32,cosTheta1: f32,thinFilmThickness: f32,baseF0: vec3f)->vec3f {var I: vec3f= vec3f(1.0);var iridescenceIOR: f32=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));var sinTheta2Sq: f32=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));var cosTheta2Sq: f32=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}\nvar cosTheta2: f32=sqrt(cosTheta2Sq);var R0: f32=getR0fromIORs(iridescenceIOR,outsideIOR);var R12: f32=fresnelSchlickGGX(cosTheta1,R0,1.);var R21: f32=R12;var T121: f32=1.0-R12;var phi12: f32=0.0;if (iridescenceIOR<outsideIOR) {phi12=PI;}\nvar phi21: f32=PI-phi12;var baseIOR: vec3f=getIORTfromAirToSurfaceR0(clamp(baseF0,vec3f(0.0),vec3f(0.9999))); \nvar R1: vec3f=getR0fromIORsVec3(baseIOR,iridescenceIOR);var R23: vec3f=fresnelSchlickGGXVec3(cosTheta2,R1, vec3f(1.));var phi23: vec3f= vec3f(0.0);if (baseIOR[0]<iridescenceIOR) {phi23[0]=PI;}\nif (baseIOR[1]<iridescenceIOR) {phi23[1]=PI;}\nif (baseIOR[2]<iridescenceIOR) {phi23[2]=PI;}\nvar opd: f32=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;var phi: vec3f= vec3f(phi21)+phi23;var R123: vec3f=clamp(R12*R23,vec3f(1e-5),vec3f(0.9999));var r123: vec3f=sqrt(R123);var Rs: vec3f=(T121*T121)*R23/( vec3f(1.0)-R123);var C0: vec3f=R12+Rs;I=C0;var Cm: vec3f=Rs-T121;for (var m: i32=1; m<=2; m++)\n{Cm*=r123;var Sm: vec3f=2.0*evalSensitivity( f32(m)*opd, f32(m)*phi);I+=Cm*Sm;}\nreturn max(I, vec3f(0.0));}\n#endif\nfn normalDistributionFunction_TrowbridgeReitzGGX(NdotH: f32,alphaG: f32)->f32\n{var a2: f32=alphaG*alphaG;var d: f32=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}\n#ifdef SHEEN\nfn normalDistributionFunction_CharlieSheen(NdotH: f32,alphaG: f32)->f32\n{var invR: f32=1./alphaG;var cos2h: f32=NdotH*NdotH;var sin2h: f32=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}\n#endif\n#ifdef ANISOTROPIC\nfn normalDistributionFunction_BurleyGGX_Anisotropic(NdotH: f32,TdotH: f32,BdotH: f32,alphaTB: vec2f)->f32 {var a2: f32=alphaTB.x*alphaTB.y;var v: vec3f= vec3f(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);var v2: f32=dot(v,v);var w2: f32=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfn smithVisibility_GGXCorrelated(NdotL: f32,NdotV: f32,alphaG: f32)->f32 {\n#ifdef MOBILE\nvar GGXV: f32=NdotL*(NdotV*(1.0-alphaG)+alphaG);var GGXL: f32=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);\n#else\nvar a2: f32=alphaG*alphaG;var GGXV: f32=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);var GGXL: f32=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfn smithVisibilityG1_TrowbridgeReitzGGXFast(dot: f32,alphaG: f32)->f32\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nvar alphaSquared: f32=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfn smithVisibility_TrowbridgeReitzGGXFast(NdotL: f32,NdotV: f32,alphaG: f32)->f32\n{var visibility: f32=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}\n#endif\n#ifdef ANISOTROPIC\nfn smithVisibility_GGXCorrelated_Anisotropic(NdotL: f32,NdotV: f32,TdotV: f32,BdotV: f32,TdotL: f32,BdotL: f32,alphaTB: vec2f)->f32 {var lambdaV: f32=NdotL*length( vec3f(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));var lambdaL: f32=NdotV*length( vec3f(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));var v: f32=0.5/(lambdaV+lambdaL);return v;}\n#endif\n#ifdef CLEARCOAT\nfn visibility_Kelemen(VdotH: f32)->f32 {return 0.25/(VdotH*VdotH); }\n#endif\n#ifdef SHEEN\nfn visibility_Ashikhmin(NdotL: f32,NdotV: f32)->f32\n{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfn l(x: f32,alphaG: f32)->f32\n{var oneMinusAlphaSq: f32=(1.0-alphaG)*(1.0-alphaG);var a: f32=mix(21.5473,25.3245,oneMinusAlphaSq);var b: f32=mix(3.82987,3.32435,oneMinusAlphaSq);var c: f32=mix(0.19823,0.16801,oneMinusAlphaSq);var d: f32=mix(-1.97760,-1.27393,oneMinusAlphaSq);var e: f32=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}\nfn lambdaSheen(cosTheta: f32,alphaG: f32)->f32\n{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}\nfn visibility_CharlieSheen(NdotL: f32,NdotV: f32,alphaG: f32)->f32\n{var G: f32=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}\n#endif\n*/\n#endif\nfn diffuseBRDF_Burley(NdotL: f32,NdotV: f32,VdotH: f32,roughness: f32)->f32 {var diffuseFresnelNV: f32=pow5(saturateEps(1.0-NdotL));var diffuseFresnelNL: f32=pow5(saturateEps(1.0-NdotV));var diffuseFresnel90: f32=0.5+2.0*VdotH*VdotH*roughness;var fresnel: f32 =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}\n#ifdef SS_TRANSLUCENCY\nfn transmittanceBRDF_Burley(tintColor: vec3f,diffusionDistance: vec3f,thickness: f32)->vec3f {var S: vec3f=1./maxEpsVec3(diffusionDistance);var temp: vec3f=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}\nfn computeWrappedDiffuseNdotL(NdotL: f32,w: f32)->f32 {var t: f32=1.0+w;var invt2: f32=1.0/(t*t);return saturate((NdotL+w)*invt2);}\n#endif\n";i.a.IncludesShadersStoreWGSL.hdrFilteringFunctions="#ifdef NUM_SAMPLES\n#if NUM_SAMPLES>0\nfn radicalInverse_VdC(value: u32)->f32 \n{var bits=(value<<16u) | (value>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return f32(bits)*2.3283064365386963e-10; }\nfn hammersley(i: u32,N: u32)->vec2f\n{return vec2f( f32(i)/ f32(N),radicalInverse_VdC(i));}\nfn log4(x: f32)->f32 {return log2(x)/2.;}\nfn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}\nconst NUM_SAMPLES_FLOAT: f32= f32(NUM_SAMPLES);const NUM_SAMPLES_FLOAT_INVERSED: f32=1./NUM_SAMPLES_FLOAT;const K: f32=4.;fn irradiance(inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f\n#ifdef IBL_CDF_FILTERING\n,icdfSampler: texture_2d<f32>,icdfSamplerSampler: sampler\n#endif\n)->vec3f\n{var n: vec3f=normalize(inputN);var result: vec3f= vec3f(0.0);\n#ifndef IBL_CDF_FILTERING\nvar tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);\n#endif\nvar maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);for(var i: u32=0u; i<NUM_SAMPLES; i++)\n{var Xi: vec2f=hammersley(i,NUM_SAMPLES);\n#ifdef IBL_CDF_FILTERING\nvar T: vec2f;T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(T.x,Xi.y),0.0).y;var Ls: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));var NoL: f32=dot(n,Ls);\n#else\nvar Ls: vec3f=hemisphereCosSample(Xi);Ls=normalize(Ls);var Ns: vec3f= vec3f(0.,0.,1.);var NoL: f32=dot(Ns,Ls);\n#endif\nif (NoL>0.) {\n#ifdef IBL_CDF_FILTERING\nvar pdf: f32=textureSampleLevel(icdfSampler,icdfSamplerSampler,T,0.0).z;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,Ls,0.0).rgb;\n#else\nvar pdf_inversed: f32=PI/NoL;var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0,maxLevel);var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*Ls,mipLevel).rgb;\n#endif\n#ifdef GAMMA_INPUT\nc=toLinearSpaceVec3(c);\n#endif\n#ifdef IBL_CDF_FILTERING\nvar light: vec3f=vec3f(0.0);if (pdf>1e-6) {light=vec3f(1.0)/vec3f(pdf)*c;}\nresult+=NoL*light;\n#else\nresult+=c;\n#endif\n}}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}\nfn radiance(alphaG: f32,inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f)->vec3f\n{var n: vec3f=normalize(inputN);var c: vec3f=textureSample(inputTexture,inputSampler,n).rgb; \nif (alphaG==0.) {\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;} else {var result: vec3f= vec3f(0.);var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var weight: f32=0.;for(var i: u32=0u; i<NUM_SAMPLES; i++)\n{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var H: vec3f=hemisphereImportanceSampleDggx(Xi,alphaG);var NoV: f32=1.;var NoH: f32=H.z;var NoH2: f32=H.z*H.z;var NoL: f32=2.*NoH2-1.;var L: vec3f= vec3f(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {var pdf_inversed: f32=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp( f32(l),0.0,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*L,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;}}\nresult=result/weight;return result;}}\n#endif\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrDirectLightingFunctions="#define CLEARCOATREFLECTANCE90 1.0\nstruct lightingInfo\n{diffuse: vec3f,\n#ifdef SPECULARTERM\nspecular: vec3f,\n#endif\n#ifdef CLEARCOAT\nclearCoat: vec4f,\n#endif\n#ifdef SHEEN\nsheen: vec3f\n#endif\n};fn adjustRoughnessFromLightProperties(roughness: f32,lightRadius: f32,lightDistance: f32)->f32 {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\nvar lightRoughness: f32=lightRadius/lightDistance;var totalRoughness: f32=saturate(lightRoughness+roughness);return totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nfn computeHemisphericDiffuseLighting(info: preLightingInfo,lightColor: vec3f,groundColor: vec3f)->vec3f {return mix(groundColor,lightColor,info.NdotL);}\nfn computeDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {var diffuseTerm: f32=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}\nfn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f{var strq: vec4f=textureProjectionMatrix* vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return toLinearSpaceVec3(textureColor);}\n#ifdef SS_TRANSLUCENCY\nfn computeDiffuseAndTransmittedLighting(info: preLightingInfo,lightColor: vec3f,transmittance: vec3f,transmittanceIntensity: f32,surfaceAlbedo: vec3f)->vec3f {var transmittanceNdotL=vec3f(0.0);var NdotL: f32=absEps(info.NdotLUnclamped);if (info.NdotLUnclamped<0.0) {var wrapNdotL: f32=computeWrappedDiffuseNdotL(NdotL,0.02);var trAdapt: f32=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL, vec3f(wrapNdotL),trAdapt);}\nvar diffuseTerm: f32=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return (transmittanceNdotL/PI+(1.0-transmittanceIntensity)*diffuseTerm*surfaceAlbedo*info.NdotL)*info.attenuation*lightColor;}\n#endif\n#ifdef SPECULARTERM\nfn computeSpecularLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nvar distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvar smithVisibility: f32=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nvar smithVisibility: f32=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvar specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef ANISOTROPIC\nfn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nvar distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef CLEARCOAT\nfn computeClearCoatLighting(info: preLightingInfo,Ncc: vec3f,geometricRoughnessFactor: f32,clearCoatIntensity: f32,lightColor: vec3f)->vec4f {var NccdotL: f32=saturateEps(dot(Ncc,info.L));var NccdotH: f32=saturateEps(dot(Ncc,info.H));var clearCoatRoughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);var fresnel: f32=fresnelSchlickGGX(info.VdotH,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);var kelemenVisibility: f32=visibility_Kelemen(info.VdotH);var clearCoatTerm: f32=fresnel*distribution*kelemenVisibility;return vec4f(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);}\nfn computeClearCoatLightingAbsorption(NdotVRefract: f32,L: vec3f,Ncc: vec3f,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var LRefract: vec3f=-refract(L,Ncc,uniforms.vClearCoatRefractionParams.y);var NdotLRefract: f32=saturateEps(dot(Ncc,LRefract));var absorption: vec3f=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}\n#endif\n#ifdef SHEEN\nfn computeSheenLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: f32=1.;var distribution: f32=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER\nvar visibility: f32=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);\n#else */\nvar visibility: f32=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */\nvar sheenTerm: f32=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\nfn computeAreaDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {return info.areaLightDiffuse*lightColor;}\nfn computeAreaSpecularLighting(info: preLightingInfo,specularColor: vec3f)->vec3f {var fresnel:vec3f =( specularColor*info.areaLightFresnel.x+( vec3f( 1.0 )-specularColor )*info.areaLightFresnel.y );return specularColor*fresnel*info.areaLightSpecular;}\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrIBLFunctions="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfn getLodFromAlphaG(cubeMapDimensionPixels: f32,microsurfaceAverageSlope: f32)->f32 {var microsurfaceAverageSlopeTexels: f32=cubeMapDimensionPixels*microsurfaceAverageSlope;var lod: f32=log2(microsurfaceAverageSlopeTexels);return lod;}\nfn getLinearLodFromRoughness(cubeMapDimensionPixels: f32,roughness: f32)->f32 {var lod: f32=log2(cubeMapDimensionPixels)*roughness;return lod;}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfn environmentRadianceOcclusion(ambientOcclusion: f32,NdotVUnclamped: f32)->f32 {var temp: f32=NdotVUnclamped+ambientOcclusion;return saturate(temp*temp-1.0+ambientOcclusion);}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfn environmentHorizonOcclusion(view: vec3f,normal: vec3f,geometricNormal: vec3f)->f32 {var reflection: vec3f=reflect(view,normal);var temp: f32=saturate(1.0+1.1*dot(reflection,geometricNormal));return temp*temp;}\n#endif\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\nfn UNPACK_LOD(x: f32)->f32 {return (1.0-x)*255.0;}\nfn getLodFromAlphaGNdotV(cubeMapDimensionPixels: f32,alphaG: f32,NdotV: f32)->f32 {var microsurfaceAverageSlope: f32=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}\n#endif\n",n(434),n(435),n(431),n(438);i.a.IncludesShadersStoreWGSL.pbrBlockAlbedoOpacity="struct albedoOpacityOutParams\n{surfaceAlbedo: vec3f,\nalpha: f32};\n#define pbr_inline\nfn albedoOpacityBlock(\nvAlbedoColor: vec4f\n#ifdef ALBEDO\n,albedoTexture: vec4f\n,albedoInfos: vec2f\n#endif\n,baseWeight: f32\n#ifdef BASEWEIGHT\n,baseWeightTexture: vec4f\n,vBaseWeightInfos: vec2f\n#endif\n#ifdef OPACITY\n,opacityMap: vec4f\n,vOpacityInfos: vec2f\n#endif\n#ifdef DETAIL\n,detailColor: vec4f\n,vDetailInfos: vec4f\n#endif\n#ifdef DECAL\n,decalColor: vec4f\n,vDecalInfos: vec4f\n#endif\n)->albedoOpacityOutParams\n{var outParams: albedoOpacityOutParams;var surfaceAlbedo: vec3f=vAlbedoColor.rgb;var alpha: f32=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpaceVec3(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#ifndef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nsurfaceAlbedo*=fragmentInputs.vColor.rgb;\n#endif\n#ifdef DETAIL\nvar detailAlbedo: f32=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; \n#endif\n#ifdef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\nsurfaceAlbedo*=baseWeight;\n#ifdef BASEWEIGHT\nsurfaceAlbedo*=baseWeightTexture.r;\n#endif\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=fragmentInputs.vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST\n#if DEBUGMODE != 88\nif (alpha<ALPHATESTVALUE) {discard;}\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}\n";i.a.IncludesShadersStoreWGSL.pbrBlockReflectivity="struct reflectivityOutParams\n{microSurface: f32,\nroughness: f32,\nsurfaceReflectivityColor: vec3f,\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo: vec3f,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nambientOcclusionColor: vec3f,\n#endif\n#if DEBUGMODE>0\n#ifdef METALLICWORKFLOW\nmetallicRoughness: vec2f,\n#ifdef REFLECTIVITY\nsurfaceMetallicColorMap: vec4f,\n#endif\n#ifndef FROSTBITE_REFLECTANCE\nmetallicF0: vec3f,\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColorMap: vec4f,\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nfn reflectivityBlock(\nvReflectivityColor: vec4f\n#ifdef METALLICWORKFLOW\n,surfaceAlbedo: vec3f\n,metallicReflectanceFactors: vec4f\n#endif\n#ifdef REFLECTIVITY\n,reflectivityInfos: vec3f\n,surfaceMetallicOrReflectivityColorMap: vec4f\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,ambientOcclusionColorIn: vec3f\n#endif\n#ifdef MICROSURFACEMAP\n,microSurfaceTexel: vec4f\n#endif\n#ifdef DETAIL\n,detailColor: vec4f\n,vDetailInfos: vec4f\n#endif\n)->reflectivityOutParams\n{var outParams: reflectivityOutParams;var microSurface: f32=vReflectivityColor.a;var surfaceReflectivityColor: vec3f=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvar metallicRoughness: vec2f=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvar aoStoreInMetalMap: vec3f= vec3f(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nvar detailRoughness: f32=mix(0.5,detailColor.b,vDetailInfos.w);var loLerp: f32=mix(0.,metallicRoughness.g,detailRoughness*2.);var hiLerp: f32=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#if DEBUGMODE>0\noutParams.metallicRoughness=metallicRoughness;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\nmicroSurface=1.0-metallicRoughness.g;var baseColor: vec3f=surfaceAlbedo;\n#ifdef FROSTBITE_REFLECTANCE\noutParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);\n#else\nvar metallicF0: vec3f=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=metallicF0;\n#endif\noutParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0), vec3f(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\n#endif\nmicroSurface=saturate(microSurface);var roughness: f32=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;return outParams;}\n";i.a.IncludesShadersStoreWGSL.pbrBlockAmbientOcclusion="struct ambientOcclusionOutParams\n{ambientOcclusionColor: vec3f,\n#if DEBUGMODE>0 && defined(AMBIENT)\nambientOcclusionColorMap: vec3f\n#endif\n};\n#define pbr_inline\nfn ambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap_: vec3f,\nvAmbientInfos: vec4f\n#endif\n)->ambientOcclusionOutParams\n{ \nvar outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);\n#ifdef AMBIENT\nvar ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}\n";i.a.IncludesShadersStoreWGSL.pbrBlockAlphaFresnel="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{alpha: f32};fn faceforward(N: vec3<f32>,I: vec3<f32>,Nref: vec3<f32>)->vec3<f32> {return select(N,-N,dot(Nref,I)>0.0);}\n#define pbr_inline\nfn alphaFresnelBlock(\nnormalW: vec3f,\nviewDirectionW: vec3f,\nalpha: f32,\nmicroSurface: f32\n)->alphaFresnelOutParams\n{var outParams: alphaFresnelOutParams;var opacityPerceptual: f32=alpha;\n#ifdef LINEARALPHAFRESNEL\nvar opacity0: f32=opacityPerceptual;\n#else\nvar opacity0: f32=opacityPerceptual*opacityPerceptual;\n#endif\nvar opacity90: f32=fresnelGrazingReflectance(opacity0);var normalForward: vec3f=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)), vec3f(opacity0), vec3f(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE) {discard;}\n#ifndef ALPHABLEND\noutParams.alpha=1.0;\n#endif\n#endif\nreturn outParams;}\n#endif\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockAnisotropic="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{anisotropy: f32,\nanisotropicTangent: vec3f,\nanisotropicBitangent: vec3f,\nanisotropicNormal: vec3f,\n#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)\nanisotropyMapData: vec3f\n#endif\n};\n#define pbr_inline\nfn anisotropicBlock(\nvAnisotropy: vec3f,\nroughness: f32,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData: vec3f,\n#endif\nTBN: mat3x3f,\nnormalW: vec3f,\nviewDirectionW: vec3f\n)->anisotropicOutParams\n{ \nvar outParams: anisotropicOutParams;var anisotropy: f32=vAnisotropy.b;var anisotropyDirection: vec3f= vec3f(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nvar amd=anisotropyMapData.rg;anisotropy*=anisotropyMapData.b;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\namd=amd*2.0-1.0;\n#ifdef ANISOTROPIC_LEGACY\nanisotropyDirection=vec3f(anisotropyDirection.xy*amd,anisotropyDirection.z);\n#else\nanisotropyDirection=vec3f(mat2x2f(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(amd),anisotropyDirection.z);\n#endif\n#endif\nvar anisoTBN: mat3x3f= mat3x3f(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));var anisotropicTangent: vec3f=normalize(anisoTBN*anisotropyDirection);var anisotropicBitangent: vec3f=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockReflection="#ifdef REFLECTION\nstruct reflectionOutParams\n{environmentRadiance: vec4f\n,environmentIrradiance: vec3f\n#ifdef REFLECTIONMAP_3D\n,reflectionCoords: vec3f\n#else\n,reflectionCoords: vec2f\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,irradianceVector: vec3f\n#endif\n#endif\n#endif\n};\n#define pbr_inline\n#ifdef REFLECTIONMAP_3D\nfn createReflectionCoords(\nvPositionW: vec3f,\nnormalW: vec3f,\n#ifdef ANISOTROPIC\nanisotropicOut: anisotropicOutParams,\n#endif\n)->vec3f\n{var reflectionCoords: vec3f;\n#else\nfn createReflectionCoords(\nvPositionW: vec3f,\nnormalW: vec3f,\n#ifdef ANISOTROPIC\nanisotropicOut: anisotropicOutParams,\n#endif\n)->vec2f\n{ \nvar reflectionCoords: vec2f;\n#endif\n#ifdef ANISOTROPIC\nvar reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvar reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\nreturn reflectionCoords;}\n#define pbr_inline\nfn sampleReflectionTexture(\nalphaG: f32\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped: f32\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness: f32\n#endif\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec3f\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec2f\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler\n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler\n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler\n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler\n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#endif \n)->vec4f\n{var environmentRadiance: vec4f;\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nvar reflectionLOD: f32=getLodFromAlphaGNdotV(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nvar reflectionLOD: f32=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nvar reflectionLOD: f32=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\nvar automaticReflectionLOD: f32=UNPACK_LOD(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords).a);var requestedReflectionLOD: f32=max(automaticReflectionLOD,reflectionLOD);\n#else\nvar requestedReflectionLOD: f32=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance= vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nvar lodReflectionNormalized: f32=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var environmentMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(\ntextureSample(reflectionHighSampler,reflectionHighSamplerSampler,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);} else {environmentRadiance=mix(\nenvironmentMid,\ntextureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\nvar envRadiance=environmentRadiance.rgb;\n#ifdef RGBDREFLECTION\nenvRadiance=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvRadiance=toLinearSpaceVec3(environmentRadiance.rgb);\n#endif\nenvRadiance*=vReflectionInfos.x;envRadiance*=vReflectionColor.rgb;return vec4f(envRadiance,environmentRadiance.a);}\n#define pbr_inline\nfn reflectionBlock(\nvPositionW: vec3f\n,normalW: vec3f\n,alphaG: f32\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n#ifdef ANISOTROPIC\n,anisotropicOut: anisotropicOutParams\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped: f32\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness: f32\n#endif\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,vEnvironmentIrradiance: vec3f\n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,reflectionMatrix: mat4x4f\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,irradianceSampler: texture_cube<f32>\n,irradianceSamplerSampler: sampler \n#else\n,irradianceSampler: texture_2d<f32>\n,irradianceSamplerSampler: sampler \n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler \n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#ifdef IBL_CDF_FILTERING\n,icdfSampler: texture_2d<f32>\n,icdfSamplerSampler: sampler\n#endif\n#endif\n)->reflectionOutParams\n{var outParams: reflectionOutParams;var environmentRadiance: vec4f= vec4f(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvar reflectionCoords: vec3f= vec3f(0.);\n#else\nvar reflectionCoords: vec2f= vec2f(0.);\n#endif\nreflectionCoords=createReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif \n);environmentRadiance=sampleReflectionTexture(\nalphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness\n#endif\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionCoords\n#else\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionCoords\n#endif\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif \n);var environmentIrradiance: vec3f= vec3f(0.,0.,0.);\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n#ifdef ANISOTROPIC\nvar irradianceVector: vec3f= (reflectionMatrix* vec4f(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvar irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n,icdfSamplerSampler\n#endif\n);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvar environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,irradianceVector);\n#else\nvar environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);\n#endif\nenvironmentIrradiance=environmentIrradiance4.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance=toLinearSpaceVec3(environmentIrradiance.rgb);\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb;\n#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE\noutParams.environmentRadiance=vec4f(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);\n#else\noutParams.environmentRadiance=environmentRadiance;\n#endif\noutParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockSheen="#ifdef SHEEN\nstruct sheenOutParams\n{sheenIntensity: f32\n,sheenColor: vec3f\n,sheenRoughness: f32\n#ifdef SHEEN_LINKWITHALBEDO\n,surfaceAlbedo: vec3f\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\n,sheenAlbedoScaling: f32\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,finalSheenRadianceScaled: vec3f\n#endif\n#if DEBUGMODE>0\n#ifdef SHEEN_TEXTURE\n,sheenMapData: vec4f\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,sheenEnvironmentReflectance: vec3f\n#endif\n#endif\n};\n#define pbr_inline\nfn sheenBlock(\nvSheenColor: vec4f\n#ifdef SHEEN_ROUGHNESS\n,vSheenRoughness: f32\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,sheenMapRoughnessData: vec4f\n#endif\n#endif\n,roughness: f32\n#ifdef SHEEN_TEXTURE\n,sheenMapData: vec4f\n,sheenMapLevel: f32\n#endif\n,reflectance: f32\n#ifdef SHEEN_LINKWITHALBEDO\n,baseColor: vec3f\n,surfaceAlbedo: vec3f\n#endif\n#ifdef ENVIRONMENTBRDF\n,NdotV: f32\n,environmentBrdf: vec3f\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,AARoughnessFactors: vec2f\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n,vLightingIntensity: vec4f\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec3f\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n,reflectionCoords: vec2f\n#endif\n,NdotVUnclamped: f32\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler \n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,seo: f32\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,eho: f32\n#endif\n#endif\n)->sheenOutParams\n{var outParams: sheenOutParams;var sheenIntensity: f32=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nvar sheenFactor: f32=pow5(1.0-sheenIntensity);var sheenColor: vec3f=baseColor.rgb*(1.0-sheenFactor);var sheenRoughness: f32=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvar sheenColor: vec3f=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\n#ifdef SHEEN_GAMMATEXTURE\nsheenColor*=toLinearSpaceVec3(sheenMapData.rgb);\n#else\nsheenColor*=sheenMapData.rgb;\n#endif\nsheenColor*=sheenMapLevel;\n#endif\n#ifdef SHEEN_ROUGHNESS\nvar sheenRoughness: f32=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#else\nvar sheenRoughness: f32=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\nsheenColor*=sheenIntensity;\n#endif\n#ifdef ENVIRONMENTBRDF\n/*#ifdef SHEEN_SOFTER\nvar environmentSheenBrdf: vec3f= vec3f(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));\n#else*/\n#ifdef SHEEN_ROUGHNESS\nvar environmentSheenBrdf: vec3f=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvar environmentSheenBrdf: vec3f=environmentBrdf;\n#endif\n/*#endif*/\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvar sheenAlphaG: f32=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvar environmentSheenRadiance: vec4f= vec4f(0.,0.,0.,0.);environmentSheenRadiance=sampleReflectionTexture(\nsheenAlphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,sheenRoughness\n#endif\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionCoords\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n);var sheenEnvironmentReflectance: vec3f=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\noutParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockClearcoat="struct clearcoatOutParams\n{specularEnvironmentR0: vec3f,\nconservationFactor: f32,\nclearCoatNormalW: vec3f,\nclearCoatAARoughnessFactors: vec2f,\nclearCoatIntensity: f32,\nclearCoatRoughness: f32,\n#ifdef REFLECTION\nfinalClearCoatRadianceScaled: vec3f,\n#endif\n#ifdef CLEARCOAT_TINT\nabsorption: vec3f,\nclearCoatNdotVRefract: f32,\nclearCoatColor: vec3f,\nclearCoatThickness: f32,\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nenergyConservationFactorClearCoat: vec3f,\n#endif\n#if DEBUGMODE>0\n#ifdef CLEARCOAT_BUMP\nTBNClearCoat: mat3x3f,\n#endif\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData: vec2f,\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nclearCoatTintMapData: vec4f,\n#endif\n#ifdef REFLECTION\nenvironmentClearCoatRadiance: vec4f,\nclearCoatEnvironmentReflectance: vec3f,\n#endif\nclearCoatNdotV: f32\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\nfn clearcoatBlock(\nvPositionW: vec3f\n,geometricNormalW: vec3f\n,viewDirectionW: vec3f\n,vClearCoatParams: vec2f\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,clearCoatMapRoughnessData: vec4f\n#endif\n,specularEnvironmentR0: vec3f\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData: vec2f\n#endif\n#ifdef CLEARCOAT_TINT\n,vClearCoatTintParams: vec4f\n,clearCoatColorAtDistance: f32\n,vClearCoatRefractionParams: vec4f\n#ifdef CLEARCOAT_TINT_TEXTURE\n,clearCoatTintMapData: vec4f\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,vClearCoatBumpInfos: vec2f\n,clearCoatBumpMapData: vec4f\n,vClearCoatBumpUV: vec2f\n#if defined(TANGENT) && defined(NORMAL)\n,vTBN: mat3x3f\n#else\n,vClearCoatTangentSpaceParams: vec2f\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,normalMatrix: mat4x4f\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,faceNormal: vec3f\n#endif\n#ifdef REFLECTION\n,vReflectionMicrosurfaceInfos: vec3f\n,vReflectionInfos: vec2f\n,vReflectionColor: vec3f\n,vLightingIntensity: vec4f\n#ifdef REFLECTIONMAP_3D\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n#else\n,reflectionSampler: texture_2d<f32>\n,reflectionSamplerSampler: sampler\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\n,reflectionLowSampler: texture_cube<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_cube<f32>\n,reflectionHighSamplerSampler: sampler \n#else\n,reflectionLowSampler: texture_2d<f32>\n,reflectionLowSamplerSampler: sampler \n,reflectionHighSampler: texture_2d<f32>\n,reflectionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo: vec2f\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,frontFacingMultiplier: f32\n#endif \n)->clearcoatOutParams\n{var outParams: clearcoatOutParams;var clearCoatIntensity: f32=vClearCoatParams.x;var clearCoatRoughness: f32=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvar clearCoatColor: vec3f=vClearCoatTintParams.rgb;var clearCoatThickness: f32=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\n#ifdef CLEARCOAT_TINT_GAMMATEXTURE\nclearCoatColor*=toLinearSpaceVec3(clearCoatTintMapData.rgb);\n#else\nclearCoatColor*=clearCoatTintMapData.rgb;\n#endif\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;\n#endif\n#ifdef CLEARCOAT_REMAP_F0\nvar specularEnvironmentR0Updated: vec3f=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvar specularEnvironmentR0Updated: vec3f=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);var clearCoatNormalW: vec3f=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nvar clearCoatNormalScale: f32=1.0;\n#else\nvar clearCoatNormalScale: f32=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nvar TBNClearCoat: mat3x3f=vTBN;\n#else\nvar TBNClearCoatUV: vec2f=vClearCoatBumpUV*frontFacingMultiplier;var TBNClearCoat: mat3x3f=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize( mat3x3f(normalMatrix[0].xyz,normalMatrix[1].xyz,normalMatrix[2].xyz)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);var clearCoatNdotVUnclamped: f32=dot(clearCoatNormalW,viewDirectionW);var clearCoatNdotV: f32=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\nvar clearCoatVRefract: vec3f=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))\nvar environmentClearCoatBrdf: vec3f=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n#if defined(REFLECTION)\nvar clearCoatAlphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvar environmentClearCoatRadiance: vec4f= vec4f(0.,0.,0.,0.);var clearCoatReflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvar clearCoatReflectionCoords: vec3f=clearCoatReflectionVector;\n#else\nvar clearCoatReflectionCoords: vec2f=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nenvironmentClearCoatRadiance=sampleReflectionTexture(\nclearCoatAlphaG\n,vReflectionMicrosurfaceInfos\n,vReflectionInfos\n,vReflectionColor\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,clearCoatNdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,clearCoatRoughness\n#endif\n,reflectionSampler\n,reflectionSamplerSampler\n,clearCoatReflectionCoords\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif \n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvar clearCoatEnvironmentReflectance: vec3f=getReflectanceFromBRDFLookup(vec3f(uniforms.vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nvar clearCoatEho: f32=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\nvar clearCoatEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV, vec3f(1.), vec3f(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\nvar fresnelIBLClearCoat: f32=fresnelSchlickGGX(clearCoatNdotV,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\nreturn outParams;}\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockIridescence="struct iridescenceOutParams\n{iridescenceIntensity: f32,\niridescenceIOR: f32,\niridescenceThickness: f32,\nspecularEnvironmentR0: vec3f};\n#ifdef IRIDESCENCE\nfn iridescenceBlock(\nvIridescenceParams: vec4f\n,viewAngle: f32\n,specularEnvironmentR0: vec3f\n#ifdef IRIDESCENCE_TEXTURE\n,iridescenceMapData: vec2f\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,iridescenceThicknessMapData: vec2f\n#endif\n#ifdef CLEARCOAT\n,NdotVUnclamped: f32\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData: vec2f\n#endif\n#endif\n)->iridescenceOutParams\n{var outParams: iridescenceOutParams;var iridescenceIntensity: f32=vIridescenceParams.x;var iridescenceIOR: f32=vIridescenceParams.y;var iridescenceThicknessMin: f32=vIridescenceParams.z;var iridescenceThicknessMax: f32=vIridescenceParams.w;var iridescenceThicknessWeight: f32=1.;\n#ifdef IRIDESCENCE_TEXTURE\niridescenceIntensity*=iridescenceMapData.x;\n#endif\n#if defined(IRIDESCENCE_THICKNESS_TEXTURE)\niridescenceThicknessWeight=iridescenceThicknessMapData.g;\n#endif\nvar iridescenceThickness: f32=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);var topIor: f32=1.; \n#ifdef CLEARCOAT\nvar clearCoatIntensity: f32=vClearCoatParams.x;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#endif\ntopIor=mix(1.0,uniforms.vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+((1.0/topIor)*(1.0/topIor))*((NdotVUnclamped*NdotVUnclamped)-1.0));\n#endif\nvar iridescenceFresnel: vec3f=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockSubSurface="struct subSurfaceOutParams\n{specularEnvironmentReflectance: vec3f,\n#ifdef SS_REFRACTION\nfinalRefraction: vec3f,\nsurfaceAlbedo: vec3f,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha: f32,\n#endif\n#ifdef REFLECTION\nrefractionFactorForIrradiance: f32,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\ntransmittance: vec3f,\ntranslucencyIntensity: f32,\n#ifdef REFLECTION\nrefractionIrradiance: vec3f,\n#endif\n#endif\n#if DEBUGMODE>0\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nthicknessMap: vec4f,\n#endif\n#ifdef SS_REFRACTION\nenvironmentRefraction: vec4f,\nrefractionTransmittance: vec3f\n#endif\n#endif\n};\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#define pbr_inline\nfn sampleEnvironmentRefraction(\nior: f32\n,thickness: f32\n,refractionLOD: f32\n,normalW: vec3f\n,vPositionW: vec3f\n,viewDirectionW: vec3f\n,view: mat4x4f\n,vRefractionInfos: vec4f\n,refractionMatrix: mat4x4f\n,vRefractionMicrosurfaceInfos: vec4f\n,alphaG: f32\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler: texture_cube<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_cube<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_cube<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#else\n,refractionSampler: texture_2d<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_2d<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_2d<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut: anisotropicOutParams\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo: vec2f\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition: vec3f\n,refractionSize: vec3f\n#endif\n)->vec4f {var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvar refractionVector: vec3f=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);\n#else\nvar refractionVector: vec3f=refract(-viewDirectionW,normalW,ior);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n#ifdef SS_REFRACTIONMAP_3D\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;var refractionCoords: vec3f=refractionVector;refractionCoords= (refractionMatrix* vec4f(refractionCoords,0)).xyz;\n#else\n#ifdef SS_USE_THICKNESS_AS_DEPTH\nvar vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*thickness,1.0))).xyz;\n#else\nvar vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*vRefractionInfos.z,1.0))).xyz;\n#endif\nvar refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef LODBASEDMICROSFURACE\nvar lod=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\nvar automaticRefractionLOD: f32=UNPACK_LOD(textureSample(refractionSampler,refractionSamplerSampler,refractionCoords).a);var requestedRefractionLOD: f32=max(automaticRefractionLOD,lod);\n#else\nvar requestedRefractionLOD: f32=lod;\n#endif\n#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)\nenvironmentRefraction= vec4f(radiance(alphaG,refractionSampler,refractionSamplerSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=textureSampleLevel(refractionSampler,refractionSamplerSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nvar lodRefractionNormalized: f32=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));var lodRefractionNormalizedDoubled: f32=lodRefractionNormalized*2.0;var environmentRefractionMid: vec4f=textureSample(refractionSampler,refractionSamplerSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(\ntextureSample(refractionHighSampler,refractionHighSamplerSampler,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);} else {environmentRefraction=mix(\nenvironmentRefractionMid,\ntextureSample(refractionLowSampler,refractionLowSamplerSampler,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);}\n#endif\nvar refraction=environmentRefraction.rgb;\n#ifdef SS_RGBDREFRACTION\nrefraction=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nrefraction=toLinearSpaceVec3(environmentRefraction.rgb);\n#endif\nreturn vec4f(refraction,environmentRefraction.a);}\n#endif\n#define pbr_inline\nfn subSurfaceBlock(\nvSubSurfaceIntensity: vec3f\n,vThicknessParam: vec2f\n,vTintColor: vec4f\n,normalW: vec3f\n,specularEnvironmentReflectance: vec3f\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,thicknessMap: vec4f\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,refractionIntensityMap: vec4f\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,translucencyIntensityMap: vec4f\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,reflectionMatrix: mat4x4f\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,irradianceVector_: vec3f\n#endif\n#if defined(REALTIME_FILTERING)\n,reflectionSampler: texture_cube<f32>\n,reflectionSamplerSampler: sampler\n,vReflectionFilteringInfo: vec2f\n#ifdef IBL_CDF_FILTERING\n,icdfSampler: texture_2d<f32>\n,icdfSamplerSampler: sampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\n,irradianceSampler: texture_cube<f32>\n,irradianceSamplerSampler: sampler\n#else\n,irradianceSampler: texture_2d<f32>\n,irradianceSamplerSampler: sampler\n#endif\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,surfaceAlbedo: vec3f\n#endif\n#ifdef SS_REFRACTION\n,vPositionW: vec3f\n,viewDirectionW: vec3f\n,view: mat4x4f\n,vRefractionInfos: vec4f\n,refractionMatrix: mat4x4f\n,vRefractionMicrosurfaceInfos: vec4f\n,vLightingIntensity: vec4f\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,alpha: f32\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,NdotVUnclamped: f32\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,roughness: f32\n#endif\n,alphaG: f32\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler: texture_cube<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_cube<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_cube<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#else\n,refractionSampler: texture_2d<f32>\n,refractionSamplerSampler: sampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler: texture_2d<f32>\n,refractionLowSamplerSampler: sampler\n,refractionHighSampler: texture_2d<f32>\n,refractionHighSamplerSampler: sampler \n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut: anisotropicOutParams\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo: vec2f\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition: vec3f\n,refractionSize: vec3f\n#endif\n#ifdef SS_DISPERSION\n,dispersion: f32\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,vDiffusionDistance: vec3f\n,vTranslucencyColor: vec4f\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,translucencyColorMap: vec4f\n#endif\n#endif\n)->subSurfaceOutParams\n{var outParams: subSurfaceOutParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvar refractionIntensity: f32=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);outParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvar translucencyIntensity: f32=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#ifdef SS_USE_GLTF_TEXTURES\nvar thickness: f32=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#else\nvar thickness: f32=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#endif\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=thicknessMap.r;\n#else\nrefractionIntensity*=thicknessMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=thicknessMap.a;\n#else\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#endif\n#else\nvar thickness: f32=vThicknessParam.y;\n#endif\n#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=refractionIntensityMap.r;\n#else\nrefractionIntensity*=refractionIntensityMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)\n#ifdef SS_USE_GLTF_TEXTURES\ntranslucencyIntensity*=translucencyIntensityMap.a;\n#else\ntranslucencyIntensity*=translucencyIntensityMap.b;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);var translucencyColor: vec4f=vTranslucencyColor;\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\ntranslucencyColor*=translucencyColorMap;\n#endif\nvar transmittance: vec3f=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;\n#endif\n#ifdef SS_REFRACTION\nvar environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);\n#ifdef SS_HAS_THICKNESS\nvar ior: f32=vRefractionInfos.y;\n#else\nvar ior: f32=vRefractionMicrosurfaceInfos.w;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nvar refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaGNdotV(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nvar refractionRoughness: f32=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);\n#else\nvar refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);\n#endif\nvar refraction_ior: f32=vRefractionInfos.y;\n#ifdef SS_DISPERSION\nvar realIOR: f32=1.0/refraction_ior;var iorDispersionSpread: f32=0.04*dispersion*(realIOR-1.0);var iors: vec3f= vec3f(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (var i: i32=0; i<3; i++) {refraction_ior=iors[i];\n#endif\nvar envSample: vec4f=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler\n,refractionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler\n,refractionLowSamplerSampler\n,refractionHighSampler\n,refractionHighSamplerSampler\n#endif\n#else\n,refractionSampler\n,refractionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler\n,refractionLowSamplerSampler\n,refractionHighSampler\n,refractionHighSamplerSampler\n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition\n,refractionSize\n#endif\n);\n#ifdef SS_DISPERSION\nenvironmentRefraction[i]=envSample[i];}\n#else\nenvironmentRefraction=envSample;\n#endif\nenvironmentRefraction=vec4f(environmentRefraction.rgb*vRefractionInfos.x,environmentRefraction.a);\n#endif\n#ifdef SS_REFRACTION\nvar refractionTransmittance: vec3f= vec3f(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvar volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\nvar maxChannel: f32=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);var volumeAlbedo: vec3f=saturateVec3(maxChannel*surfaceAlbedo);environmentRefraction=vec4f(environmentRefraction.rgb*volumeAlbedo,environmentRefraction.a);\n#else\nvar volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\nenvironmentRefraction=vec4f(environmentRefraction.rgb*surfaceAlbedo.rgb,environmentRefraction.a);\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);\n#ifdef REFLECTION\noutParams.refractionFactorForIrradiance=(1.-refractionIntensity);\n#endif\n#ifdef UNUSED_MULTIPLEBOUNCES\nvar bounceSpecularEnvironmentReflectance: vec3f=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);\n#endif\nrefractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvar irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvar irradianceVector: vec3f=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvar refractionIrradiance: vec3f=irradiance(reflectionSampler,reflectionSamplerSampler,-irradianceVector,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n,icdfSamplerSampler\n#endif\n);\n#else\nvar refractionIrradiance: vec3f=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvar irradianceCoords: vec3f=irradianceVector;\n#else\nvar irradianceCoords: vec2f=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvar temp: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,-irradianceCoords);var refractionIrradiance=temp.rgb;\n#ifdef RGBDREFLECTION\nrefractionIrradiance=fromRGBD(temp).rgb;\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance=toLinearSpaceVec3(refractionIrradiance);\n#endif\n#else\nvar refractionIrradiance: vec3f= vec3f(0.);\n#endif\nrefractionIrradiance*=transmittance;\n#ifdef SS_ALBEDOFORTRANSLUCENCYTINT\nrefractionIrradiance*=surfaceAlbedo.rgb;\n#endif\noutParams.refractionIrradiance=refractionIrradiance;\n#endif\nreturn outParams;}\n#endif\n",n(356);i.a.IncludesShadersStoreWGSL.pbrBlockNormalGeometric="var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);\n#ifdef NORMAL\nvar normalW: vec3f=normalize(input.vNormalW);\n#else\nvar normalW: vec3f=normalize(cross(dpdx(input.vPositionW),dpdy(input.vPositionW)))*scene.vEyePosition.w;\n#endif\nvar geometricNormalW: vec3f=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=select(-geometricNormalW,geometricNormalW,fragmentInputs.frontFacing);\n#endif\n",n(437);i.a.IncludesShadersStoreWGSL.pbrBlockNormalFinal="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvar faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=select(-normalW,normalW,fragmentInputs.frontFacing);\n#endif\n",n(439);i.a.IncludesShadersStoreWGSL.pbrBlockLightmapInit="#ifdef LIGHTMAP\nvar lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor=vec4f(toLinearSpaceVec3(lightmapColor.rgb),lightmapColor.a);\n#endif\nlightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockGeometryInfo="var NdotVUnclamped: f32=dot(normalW,viewDirectionW);var NdotV: f32=absEps(NdotVUnclamped);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var AARoughnessFactors: vec2f=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\nvar environmentBrdf: vec3f=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nvar ambientMonochrome: f32=aoOut.ambientOcclusionColor.r;\n#else\nvar ambientMonochrome: f32=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nvar seo: f32=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nvar eho: f32=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockReflectance0="var reflectance: f32=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);var specularEnvironmentR0: vec3f=reflectivityOut.surfaceReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvar specularEnvironmentR90: vec3f= vec3f(metallicReflectanceFactors.a);\n#else \nvar specularEnvironmentR90: vec3f= vec3f(1.0,1.0,1.0);\n#endif\n#ifdef ALPHAFRESNEL\nvar reflectance90: f32=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockReflectance="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvar specularEnvironmentReflectance: vec3f=getReflectanceFromBRDFWithEnvLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);\n#ifdef RADIANCEOCCLUSION\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\nvar specularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\nspecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nspecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockDirectLighting="var diffuseBase: vec3f=vec3f(0.,0.,0.);\n#ifdef SPECULARTERM\nvar specularBase: vec3f=vec3f(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvar clearCoatBase: vec3f=vec3f(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvar sheenBase: vec3f=vec3f(0.,0.,0.);\n#endif\nvar preInfo: preLightingInfo;var info: lightingInfo;var shadow: f32=1.; \nvar aggShadow: f32=0.;var numLights: f32=0.;\n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvar absorption: vec3f=vec3f(0.);\n#endif\n",n(440);i.a.IncludesShadersStoreWGSL.pbrBlockFinalLitComponents="aggShadow=aggShadow/numLights;\n#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvar energyConservationFactor: vec3f=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo=(1.-reflectance)*surfaceAlbedo.rgb;\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n#ifdef REFLECTION\nvar finalIrradiance: vec3f=reflectionOut.environmentIrradiance;\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\nfinalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=uniforms.vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n#ifdef SPECULARTERM\nvar finalSpecular: vec3f=specularBase;finalSpecular=max(finalSpecular,vec3f(0.0));var finalSpecularScaled: vec3f=finalSpecular*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef REFLECTION\nvar finalRadiance: vec3f=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;var finalRadianceScaled: vec3f=finalRadiance*uniforms.vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef SHEEN\nvar finalSheen: vec3f=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,vec3f(0.0));var finalSheenScaled: vec3f=finalSheen*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef CLEARCOAT\nvar finalClearCoat: vec3f=clearCoatBase;finalClearCoat=max(finalClearCoat,vec3f(0.0));var finalClearCoatScaled: vec3f=finalClearCoat*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef ALPHABLEND\nvar luminanceOverAlpha: f32=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockFinalUnlitComponents="var finalDiffuse: vec3f=diffuseBase;\n#if !defined(SS_TRANSLUCENCY)\nfinalDiffuse*=surfaceAlbedo.rgb;\n#endif\nfinalDiffuse=max(finalDiffuse,vec3f(0.0));finalDiffuse*=uniforms.vLightingIntensity.x;var finalAmbient: vec3f=uniforms.vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;var finalEmissive: vec3f=uniforms.vEmissiveColor;\n#ifdef EMISSIVE\nvar emissiveColorTex: vec3f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb;\n#ifdef GAMMAEMISSIVE\nfinalEmissive*=toLinearSpaceVec3(emissiveColorTex.rgb);\n#else\nfinalEmissive*=emissiveColorTex.rgb;\n#endif\nfinalEmissive*= uniforms.vEmissiveInfos.y;\n#endif\nfinalEmissive*=uniforms.vLightingIntensity.y;\n#ifdef AMBIENT\nvar ambientOcclusionForDirectDiffuse: vec3f=mix( vec3f(1.),aoOut.ambientOcclusionColor,uniforms.vAmbientInfos.w);\n#else\nvar ambientOcclusionForDirectDiffuse: vec3f=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;\n";i.a.IncludesShadersStoreWGSL.pbrBlockFinalColorComposition="var finalColor: vec4f= vec4f(\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalAmbient +\nfinalDiffuse,\nalpha);\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor=vec4f(finalColor.rgb*lightmapColor.rgb,finalColor.a);\n#else\nfinalColor=vec4f(finalColor.rgb+lightmapColor.rgb,finalColor.a);\n#endif\n#endif\n#endif\nfinalColor=vec4f(finalColor.rgb+finalEmissive,finalColor.a);\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,vec4f(0.0));\n",n(441),n(442);i.a.IncludesShadersStoreWGSL.pbrBlockImageProcessing="#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)\n#if !defined(SKIPFINALCOLORCLAMP)\nfinalColor=vec4f(clamp(finalColor.rgb,vec3f(0.),vec3f(30.0)),finalColor.a);\n#endif\n#else\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor=vec4f(finalColor.rgb,finalColor.a*mesh.visibility);\n#ifdef PREMULTIPLYALPHA\nfinalColor=vec4f(finalColor.rgb*finalColor.a,finalColor.a);;\n#endif\n";i.a.IncludesShadersStoreWGSL.pbrBlockPrePass="var writeGeometryInfo: f32=select(0.0,1.0,finalColor.a>ALPHATESTVALUE);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;\n#ifdef PREPASS_POSITION\nfragData[PREPASS_POSITION_INDEX]= vec4f(fragmentInputs.vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\nfragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvar a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvar velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -\n(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\nfragData[PREPASS_ALBEDO_INDEX]=vec4f(surfaceAlbedo,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nvar sqAlbedo : vec3f=sqrt(surfaceAlbedo); \n#endif\n#ifdef PREPASS_IRRADIANCE\nvar irradiance : vec3f=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\n#ifdef SS_SCATTERING\n#ifdef PREPASS_COLOR\nfragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb-irradiance,finalColor.a); \n#endif\nirradiance/=sqAlbedo;fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo*uniforms.scatteringDiffusionProfile/255.); \n#else\n#ifdef PREPASS_COLOR\nfragData[PREPASS_COLOR_INDEX]=finalColor; \n#endif\nfragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo); \n#endif\n#elif defined(PREPASS_COLOR)\nfragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTH\nfragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\nfragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);\n#else\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\nfragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nfragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqAlbedo,writeGeometryInfo);\n#endif\n#ifdef PREPASS_REFLECTIVITY\n#ifndef UNLIT\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(specularEnvironmentR0,microSurface)*writeGeometryInfo;\n#else\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(0.0,0.0,0.0,1.0)*writeGeometryInfo;\n#endif\n#endif\n#if SCENE_MRT_COUNT>0\nfragmentOutputs.fragData0=fragData[0];\n#endif\n#if SCENE_MRT_COUNT>1\nfragmentOutputs.fragData1=fragData[1];\n#endif\n#if SCENE_MRT_COUNT>2\nfragmentOutputs.fragData2=fragData[2];\n#endif\n#if SCENE_MRT_COUNT>3\nfragmentOutputs.fragData3=fragData[3];\n#endif\n#if SCENE_MRT_COUNT>4\nfragmentOutputs.fragData4=fragData[4];\n#endif\n#if SCENE_MRT_COUNT>5\nfragmentOutputs.fragData5=fragData[5];\n#endif\n#if SCENE_MRT_COUNT>6\nfragmentOutputs.fragData6=fragData[6];\n#endif\n#if SCENE_MRT_COUNT>7\nfragmentOutputs.fragData7=fragData[7];\n#endif\n",n(443);i.a.IncludesShadersStoreWGSL.pbrDebug="#if DEBUGMODE>0\nif (input.vClipSpacePosition.x/input.vClipSpacePosition.w>=uniforms.vDebugMode.x) {var color: vec3f;\n#if DEBUGMODE==1\ncolor=fragmentInputs.vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==2 && defined(NORMAL)\ncolor=fragmentInputs.vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)\ncolor=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)\ncolor=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==5\ncolor=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==6 && defined(MAINUV1)\ncolor= vec3f(input.vMainUV1,0.0);\n#elif DEBUGMODE==7 && defined(MAINUV2)\ncolor= vec3f(input.vMainUV2,0.0);\n#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ncolor=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ncolor=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==10 && defined(CLEARCOAT)\ncolor=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==11 && defined(ANISOTROPIC)\ncolor=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==12 && defined(ANISOTROPIC)\ncolor=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==13 && defined(ANISOTROPIC)\ncolor=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==20 && defined(ALBEDO)\ncolor=albedoTexture.rgb;\n#ifndef GAMMAALBEDO\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==21 && defined(AMBIENT)\ncolor=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE==22 && defined(OPACITY)\ncolor=opacityMap.rgb;\n#elif DEBUGMODE==23 && defined(EMISSIVE)\ncolor=emissiveColorTex.rgb;\n#ifndef GAMMAEMISSIVE\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==24 && defined(LIGHTMAP)\ncolor=lightmapColor;\n#ifndef GAMMALIGHTMAP\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ncolor=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ncolor=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ncolor= vec3f(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ncolor=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ncolor=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ncolor=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ncolor=subSurfaceOut.thicknessMap.rgb;\n#elif DEBUGMODE==32 && defined(BUMP)\ncolor=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).rgb;\n#elif DEBUGMODE==40 && defined(SS_REFRACTION)\ncolor=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==41 && defined(REFLECTION)\ncolor=reflectionOut.environmentRadiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)\ncolor=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==50\ncolor=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==51 && defined(SPECULARTERM)\ncolor=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==52 && defined(CLEARCOAT)\ncolor=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==53 && defined(SHEEN)\ncolor=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==54 && defined(REFLECTION)\ncolor=reflectionOut.environmentIrradiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==60\ncolor=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==61\ncolor=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)\ncolor= vec3f(reflectivityOut.metallicRoughness.r);\n#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)\ncolor=reflectivityOut.metallicF0;\n#elif DEBUGMODE==63\ncolor= vec3f(roughness);\n#elif DEBUGMODE==64\ncolor= vec3f(alphaG);\n#elif DEBUGMODE==65\ncolor= vec3f(NdotV);\n#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ncolor=clearcoatOut.clearCoatColor;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==67 && defined(CLEARCOAT)\ncolor= vec3f(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE==68 && defined(CLEARCOAT)\ncolor= vec3f(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ncolor=subSurfaceOut.transmittance;\n#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ncolor=subSurfaceOut.refractionTransmittance;\n#elif DEBUGMODE==72\ncolor= vec3f(microSurface);\n#elif DEBUGMODE==73\ncolor=uniforms.vAlbedoColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)\ncolor=uniforms.vReflectivityColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==75\ncolor=uniforms.vEmissiveColor;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)\ncolor= vec3f(seo);\n#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\ncolor= vec3f(eho);\n#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ncolor= vec3f(energyConservationFactor);\n#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ncolor=specularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ncolor=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)\ncolor=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==86 && defined(ALPHABLEND)\ncolor= vec3f(luminanceOverAlpha);\n#elif DEBUGMODE==87\ncolor= vec3f(alpha);\n#elif DEBUGMODE==88 && defined(ALBEDO)\ncolor= vec3f(albedoTexture.a);\n#elif DEBUGMODE==89\ncolor=aoOut.ambientOcclusionColor;\n#else\nvar stripeWidth: f32=30.;var stripePos: f32=abs(floor(input.position.x/stripeWidth));var whichColor: f32=((stripePos)%(2.));var color1: vec3f= vec3f(.6,.2,.2);var color2: vec3f= vec3f(.3,.1,.1);color=mix(color1,color2,whichColor);\n#endif\ncolor*=uniforms.vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ncolor=normalize(color)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ncolor=toGammaSpaceVec3(color);\n#endif\nfragmentOutputs.color=vec4f(color,1.0);\n#ifdef PREPASS\nfragmentOutputs.fragData0=toLinearSpaceVec3(color); \nfragmentOutputs.fragData1=vec4f(0.,0.,0.,0.); \n#endif\n#ifdef DEBUGMODE_FORCERETURN\nreturn fragmentOutputs;\n#endif\n}\n#endif\n";const r="#define CUSTOM_FRAGMENT_BEGIN\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<pbrUboDeclaration>\n#include<pbrFragmentExtraDeclaration>\n#include<lightUboDeclaration>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockIridescence>\n#include<pbrBlockSubSurface>\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\nvar albedoOpacityOut: albedoOpacityOutParams;\n#ifdef ALBEDO\nvar albedoTexture: vec4f=textureSample(albedoSampler,albedoSamplerSampler,fragmentInputs.vAlbedoUV+uvOffset);\n#endif\n#ifdef BASEWEIGHT\nvar baseWeightTexture: vec4f=textureSample(baseWeightSampler,baseWeightSamplerSampler,fragmentInputs.vBaseWeightUV+uvOffset);\n#endif\n#ifdef OPACITY\nvar opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nvar decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);\n#endif\nalbedoOpacityOut=albedoOpacityBlock(\nuniforms.vAlbedoColor\n#ifdef ALBEDO\n,albedoTexture\n,uniforms.vAlbedoInfos\n#endif\n,uniforms.baseWeight\n#ifdef BASEWEIGHT\n,baseWeightTexture\n,uniforms.vBaseWeightInfos\n#endif\n#ifdef OPACITY\n,opacityMap\n,uniforms.vOpacityInfos\n#endif\n#ifdef DETAIL\n,detailColor\n,uniforms.vDetailInfos\n#endif\n#ifdef DECAL\n,decalColor\n,uniforms.vDecalInfos\n#endif\n);var surfaceAlbedo: vec3f=albedoOpacityOut.surfaceAlbedo;var alpha: f32=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nvar aoOut: ambientOcclusionOutParams;\n#ifdef AMBIENT\nvar ambientOcclusionColorMap: vec3f=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb;\n#endif\naoOut=ambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nuniforms.vAmbientInfos\n#endif\n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvar diffuseBase: vec3f= vec3f(1.,1.,1.);\n#else\nvar baseColor: vec3f=surfaceAlbedo;var reflectivityOut: reflectivityOutParams;\n#if defined(REFLECTIVITY)\nvar surfaceMetallicOrReflectivityColorMap: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,fragmentInputs.vReflectivityUV+uvOffset);var baseReflectivity: vec4f=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\n#ifdef REFLECTIVITY_GAMMA\nsurfaceMetallicOrReflectivityColorMap=toLinearSpaceVec4(surfaceMetallicOrReflectivityColorMap);\n#endif\nsurfaceMetallicOrReflectivityColorMap=vec4f(surfaceMetallicOrReflectivityColorMap.rgb*uniforms.vReflectivityInfos.y,surfaceMetallicOrReflectivityColorMap.a);\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvar microSurfaceTexel: vec4f=textureSample(microSurfaceSampler,microSurfaceSamplerSampler,fragmentInputs.vMicroSurfaceSamplerUV+uvOffset)*uniforms.vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef METALLICWORKFLOW\nvar metallicReflectanceFactors: vec4f=uniforms.vMetallicReflectanceFactors;\n#ifdef REFLECTANCE\nvar reflectanceFactorsMap: vec4f=textureSample(reflectanceSampler,reflectanceSamplerSampler,fragmentInputs.vReflectanceUV+uvOffset);\n#ifdef REFLECTANCE_GAMMA\nreflectanceFactorsMap=toLinearSpaceVec4(reflectanceFactorsMap);\n#endif\nmetallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*reflectanceFactorsMap.rgb,metallicReflectanceFactors.a);\n#endif\n#ifdef METALLIC_REFLECTANCE\nvar metallicReflectanceFactorsMap: vec4f=textureSample(metallicReflectanceSampler,metallicReflectanceSamplerSampler,fragmentInputs.vMetallicReflectanceUV+uvOffset);\n#ifdef METALLIC_REFLECTANCE_GAMMA\nmetallicReflectanceFactorsMap=toLinearSpaceVec4(metallicReflectanceFactorsMap);\n#endif\n#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY\nmetallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*metallicReflectanceFactorsMap.rgb,metallicReflectanceFactors.a);\n#endif\nmetallicReflectanceFactors*=metallicReflectanceFactorsMap.a;\n#endif\n#endif\nreflectivityOut=reflectivityBlock(\nuniforms.vReflectivityColor\n#ifdef METALLICWORKFLOW\n,surfaceAlbedo\n,metallicReflectanceFactors\n#endif\n#ifdef REFLECTIVITY\n,uniforms.vReflectivityInfos\n,surfaceMetallicOrReflectivityColorMap\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n,aoOut.ambientOcclusionColor\n#endif\n#ifdef MICROSURFACEMAP\n,microSurfaceTexel\n#endif\n#ifdef DETAIL\n,detailColor\n,uniforms.vDetailInfos\n#endif\n);var microSurface: f32=reflectivityOut.microSurface;var roughness: f32=reflectivityOut.roughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nvar alphaFresnelOut: alphaFresnelOutParams;alphaFresnelOut=alphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface\n);alpha=alphaFresnelOut.alpha;\n#endif\n#endif\n#include<pbrBlockGeometryInfo>\n#ifdef ANISOTROPIC\nvar anisotropicOut: anisotropicOutParams;\n#ifdef ANISOTROPIC_TEXTURE\nvar anisotropyMapData: vec3f=textureSample(anisotropySampler,anisotropySamplerSampler,fragmentInputs.vAnisotropyUV+uvOffset).rgb*uniforms.vAnisotropyInfos.y;\n#endif\nanisotropicOut=anisotropicBlock(\nuniforms.vAnisotropy,\nroughness,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW\n);\n#endif\n#ifdef REFLECTION\nvar reflectionOut: reflectionOutParams;\n#ifndef USE_CUSTOM_REFLECTION\nreflectionOut=reflectionBlock(\nfragmentInputs.vPositionW\n,normalW\n,alphaG\n,uniforms.vReflectionMicrosurfaceInfos\n,uniforms.vReflectionInfos\n,uniforms.vReflectionColor\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\n,NdotVUnclamped\n#endif\n#ifdef LINEARSPECULARREFLECTION\n,roughness\n#endif\n,reflectionSampler\n,reflectionSamplerSampler\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n,fragmentInputs.vEnvironmentIrradiance\n#endif\n#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))\n,uniforms.reflectionMatrix\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n,irradianceSamplerSampler\n#endif\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n,icdfSamplerSampler\n#endif\n#endif\n);\n#else\n#define CUSTOM_REFLECTION\n#endif\n#endif\n#include<pbrBlockReflectance0>\n#ifdef SHEEN\nvar sheenOut: sheenOutParams;\n#ifdef SHEEN_TEXTURE\nvar sheenMapData: vec4f=textureSample(sheenSampler,sheenSamplerSampler,fragmentInputs.vSheenUV+uvOffset);\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvar sheenMapRoughnessData: vec4f=textureSample(sheenRoughnessSampler,sheenRoughnessSamplerSampler,fragmentInputs.vSheenRoughnessUV+uvOffset)*uniforms.vSheenInfos.w;\n#endif\nsheenOut=sheenBlock(\nuniforms.vSheenColor\n#ifdef SHEEN_ROUGHNESS\n,uniforms.vSheenRoughness\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,sheenMapRoughnessData\n#endif\n#endif\n,roughness\n#ifdef SHEEN_TEXTURE\n,sheenMapData\n,uniforms.vSheenInfos.y\n#endif\n,reflectance\n#ifdef SHEEN_LINKWITHALBEDO\n,baseColor\n,surfaceAlbedo\n#endif\n#ifdef ENVIRONMENTBRDF\n,NdotV\n,environmentBrdf\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n,AARoughnessFactors\n,uniforms.vReflectionMicrosurfaceInfos\n,uniforms.vReflectionInfos\n,uniforms.vReflectionColor\n,uniforms.vLightingIntensity\n,reflectionSampler\n,reflectionSamplerSampler\n,reflectionOut.reflectionCoords\n,NdotVUnclamped\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,vReflectionFilteringInfo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\n,seo\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\n,eho\n#endif\n#endif\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvar clearCoatMapData: vec2f=textureSample(clearCoatSampler,clearCoatSamplerSampler,fragmentInputs.vClearCoatUV+uvOffset).rg*uniforms.vClearCoatInfos.y;\n#endif\n#endif\n#ifdef IRIDESCENCE\nvar iridescenceOut: iridescenceOutParams;\n#ifdef IRIDESCENCE_TEXTURE\nvar iridescenceMapData: vec2f=textureSample(iridescenceSampler,iridescenceSamplerSampler,fragmentInputs.vIridescenceUV+uvOffset).rg*uniforms.vIridescenceInfos.y;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nvar iridescenceThicknessMapData: vec2f=textureSample(iridescenceThicknessSampler,iridescenceThicknessSamplerSampler,fragmentInputs.vIridescenceThicknessUV+uvOffset).rg*uniforms.vIridescenceInfos.w;\n#endif\niridescenceOut=iridescenceBlock(\nuniforms.vIridescenceParams\n,NdotV\n,specularEnvironmentR0\n#ifdef IRIDESCENCE_TEXTURE\n,iridescenceMapData\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\n,iridescenceThicknessMapData\n#endif\n#ifdef CLEARCOAT\n,NdotVUnclamped\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#endif\n);var iridescenceIntensity: f32=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;\n#endif\nvar clearcoatOut: clearcoatOutParams;\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvar clearCoatMapRoughnessData: vec4f=textureSample(clearCoatRoughnessSampler,clearCoatRoughnessSamplerSampler,fragmentInputs.vClearCoatRoughnessUV+uvOffset)*uniforms.vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvar clearCoatTintMapData: vec4f=textureSample(clearCoatTintSampler,clearCoatTintSamplerSampler,fragmentInputs.vClearCoatTintUV+uvOffset);\n#endif\n#ifdef CLEARCOAT_BUMP\nvar clearCoatBumpMapData: vec4f=textureSample(clearCoatBumpSampler,clearCoatBumpSamplerSampler,fragmentInputs.vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatOut=clearcoatBlock(\nfragmentInputs.vPositionW\n,geometricNormalW\n,viewDirectionW\n,uniforms.vClearCoatParams\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n,clearCoatMapRoughnessData\n#endif\n,specularEnvironmentR0\n#ifdef CLEARCOAT_TEXTURE\n,clearCoatMapData\n#endif\n#ifdef CLEARCOAT_TINT\n,uniforms.vClearCoatTintParams\n,uniforms.clearCoatColorAtDistance\n,uniforms.vClearCoatRefractionParams\n#ifdef CLEARCOAT_TINT_TEXTURE\n,clearCoatTintMapData\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\n,uniforms.vClearCoatBumpInfos\n,clearCoatBumpMapData\n,fragmentInputs.vClearCoatBumpUV\n#if defined(TANGENT) && defined(NORMAL)\n,mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2)\n#else\n,uniforms.vClearCoatTangentSpaceParams\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\n,uniforms.normalMatrix\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\n,faceNormal\n#endif\n#ifdef REFLECTION\n,uniforms.vReflectionMicrosurfaceInfos\n,uniforms.vReflectionInfos\n,uniforms.vReflectionColor\n,uniforms.vLightingIntensity\n,reflectionSampler\n,reflectionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,reflectionLowSampler\n,reflectionLowSamplerSampler\n,reflectionHighSampler\n,reflectionHighSamplerSampler\n#endif\n#ifdef REALTIME_FILTERING\n,uniforms.vReflectionFilteringInfo\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n,select(-1.,1.,fragmentInputs.frontFacing)\n#endif\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n#include<pbrBlockReflectance>\nvar subSurfaceOut: subSurfaceOutParams;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvar thicknessMap: vec4f=textureSample(thicknessSampler,thicknessSamplerSampler,fragmentInputs.vThicknessUV+uvOffset);\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nvar refractionIntensityMap: vec4f=textureSample(refractionIntensitySampler,refractionIntensitySamplerSampler,fragmentInputs.vRefractionIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nvar translucencyIntensityMap: vec4f=textureSample(translucencyIntensitySampler,translucencyIntensitySamplerSampler,fragmentInputs.vTranslucencyIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nvar translucencyColorMap: vec4f=textureSample(translucencyColorSampler,translucencyColorSamplerSampler,fragmentInputs.vTranslucencyColorUV+uvOffset);\n#endif\nsubSurfaceOut=subSurfaceBlock(\nuniforms.vSubSurfaceIntensity\n,uniforms.vThicknessParam\n,uniforms.vTintColor\n,normalW\n,specularEnvironmentReflectance\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n,thicknessMap\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n,refractionIntensityMap\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\n,translucencyIntensityMap\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\n,uniforms.reflectionMatrix\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n,reflectionOut.irradianceVector\n#endif\n#if defined(REALTIME_FILTERING)\n,reflectionSampler\n,reflectionSamplerSampler\n,vReflectionFilteringInfo\n#ifdef IBL_CDF_FILTERING\n,icdfSampler\n,icdfSamplerSampler\n#endif\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n,irradianceSampler\n,irradianceSamplerSampler\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n,surfaceAlbedo\n#endif\n#ifdef SS_REFRACTION\n,fragmentInputs.vPositionW\n,viewDirectionW\n,scene.view\n,uniforms.vRefractionInfos\n,uniforms.refractionMatrix\n,uniforms.vRefractionMicrosurfaceInfos\n,uniforms.vLightingIntensity\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n,alpha\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\n,NdotVUnclamped\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\n,roughness\n#endif\n,alphaG\n,refractionSampler\n,refractionSamplerSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionLowSampler\n,refractionLowSamplerSampler\n,refractionHighSampler\n,refractionHighSamplerSampler\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,uniforms.vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,uniforms.vRefractionPosition\n,uniforms.vRefractionSize\n#endif\n#ifdef SS_DISPERSION\n,dispersion\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\n,uniforms.vDiffusionDistance\n,uniforms.vTranslucencyColor\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n,translucencyColorMap\n#endif\n#endif\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#endif\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n#include<pbrBlockFinalLitComponents>\n#endif \n#include<pbrBlockFinalUnlitComponents>\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\n#include<pbrBlockPrePass>\n#endif\n#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)\nfragmentOutputs.color=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+finalColor.rgb*finalColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-finalColor.a));} else {fragmentOutputs.backColor+=finalColor;}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i.a.ShadersStoreWGSL.pbrPixelShader=r;const s={name:"pbrPixelShader",shader:r}},function(e,t,n){"use strict";var i;function r(e){if(!e)return;const t={};return e.forEach((e,n)=>{n&&(t[n]=e)}),t}function s(e,t){const n=[],i=new Set;return e.concat(t).forEach(e=>i.add(e)),i.forEach(e=>n.push(e)),n}n.r(t),n.d(t,"KpiType",(function(){return h})),n.d(t,"HealthFactoryGlobal",(function(){return E})),n.d(t,"EventTypeForLoggerAndOfflineWorker",(function(){return a})),n.d(t,"HealthRequestPayloadComponent",(function(){return o})),n.d(t,"DiagnosticLogEventIds",(function(){return l})),n.d(t,"Health",(function(){return m})),n.d(t,"HealthFactory",(function(){return v})),function(e){e[e.Failure=0]="Failure",e[e.ImpliedUsageFailure=1]="ImpliedUsageFailure",e[e.ImpliedUsageSuccess=2]="ImpliedUsageSuccess",e[e.Success=3]="Success",e[e.Usage=4]="Usage"}(i||(i={}));var a,o,l,c,d,h,u=n(273),f=n(274);!function(e){e[e.BSqmError=0]="BSqmError",e[e.Kpi=1]="Kpi",e[e.QosError=2]="QosError",e[e.QosPillar=3]="QosPillar",e[e.DiagnosticLog=4]="DiagnosticLog",e[e.OfflineWorkerInit=5]="OfflineWorkerInit",e[e.OfflineWorkerFlush=6]="OfflineWorkerFlush",e[e.OfflineWorkerFailedUpload=7]="OfflineWorkerFailedUpload"}(a||(a={})),function(e){e.HealthDimensions="d",e.PartCDimensions="a",e.BSqmErrors="b",e.QosErrors="e",e.Heartbeat="h",e.QosPillars="q",e.Kpis="k",e.DiagnosticLogs="l",e.ClientSendTime="t"}(o||(o={})),function(e){e[e.AttemptToUseFunctionalityBeforeIitialization=0]="AttemptToUseFunctionalityBeforeIitialization",e[e.WorkerApiIsNotAvailable=1]="WorkerApiIsNotAvailable",e[e.InvalidWorkerUrl=2]="InvalidWorkerUrl",e[e.InstallingOfflineWorker=3]="InstallingOfflineWorker",e[e.OfflineWorkerMessage=4]="OfflineWorkerMessage",e[e.FailedToProcessMessageFromOfflineWorker=5]="FailedToProcessMessageFromOfflineWorker",e[e.FailedToInstallOfflineWorker=6]="FailedToInstallOfflineWorker",e[e.InitializedHealth=7]="InitializedHealth",e[e.BatchesOfHealthEventsInIndexedDB=8]="BatchesOfHealthEventsInIndexedDB",e[e.IndexedDbTransactionFailed=9]="IndexedDbTransactionFailed",e[e.InstalledOfflineWorker=10]="InstalledOfflineWorker",e[e.IndexedDdIsNotSupported=11]="IndexedDdIsNotSupported",e[e.GetAllKeysIsNotSupported=12]="GetAllKeysIsNotSupported",e[e.FailedToProcessMessage=13]="FailedToProcessMessage",e[e.FailedToLoadWorkerScript=14]="FailedToLoadWorkerScript",e[e.FailedToSendEventToWorker=15]="FailedToSendEventToWorker",e[e.FailedToJsonStringifyEvent=16]="FailedToJsonStringifyEvent",e[e.IndexedDbEntryIsNotAnObject=17]="IndexedDbEntryIsNotAnObject"}(l||(l={})),function(e){e[e.AttemptedToAddOrUpdatePartCDimension=0]="AttemptedToAddOrUpdatePartCDimension",e[e.AttemptedToRecordBSqmQosError=1]="AttemptedToRecordBSqmQosError",e[e.AttemptedToRecordSessionEndingQosError=2]="AttemptedToRecordSessionEndingQosError",e[e.AttemptedToSetAppOnlineStatus=3]="AttemptedToSetAppOnlineStatus",e[e.AttemptedToUpdatePartADimensions=4]="AttemptedToUpdatePartADimensions"}(c||(c={})),function(e){e[e.SendSucceeded=0]="SendSucceeded",e[e.SendFailed=1]="SendFailed",e[e.DidNotAttempt=2]="DidNotAttempt"}(d||(d={}));class m{static getInstance(e=!1){return m._instance&&!e||(m._instance=new m),this._instance}initialize(e){if(e)try{var t;return this._healthConfig=function(e){var t,n,i,r,s,a,o,l,c,d,h,u,f,m,p,g;return{_dimensions:null!==(t=e.dimensions)&&void 0!==t?t:void 0,_heartbeatIntervalMs:null!==(n=e.heartbeatIntervalMs)&&void 0!==n?n:3e5,_isHealthEnabled:null!==(i=e.isHealthEnabled)&&void 0!==i&&i,_isOfflineEnabled:null!==(r=e.isOfflineEnabled)&&void 0!==r&&r,_isErrorPartCEnabled:null!==(s=e.isErrorPartCEnabled)&&void 0!==s&&s,_isFetchApiEnabled:null!==(a=e.isFetchApiEnabled)&&void 0!==a&&a,_maxIntervalMs:null!==(o=e.loggerMaxIntervalMs)&&void 0!==o?o:3e4,_maxQueueSize:null!==(l=e.loggerMaxQueueSize)&&void 0!==l?l:25,_offlineWorkerUrl:null!==(c=e.offlineWorkerUrl)&&void 0!==c?c:"",_absoluteTelemetryUrl:null!==(d=e.absoluteRemoteTelemetryUrlForOfflineWorker)&&void 0!==d?d:"",_pillarIntervalMs:null!==(h=e.recordPillarToWarmPipelineIntervalMs)&&void 0!==h?h:864e5,_telemetryUrl:null!==(u=e.remoteTelemetryUrl)&&void 0!==u?u:"",_maxConcurrentRetries:null!==(f=e.maxConcurrentRetries)&&void 0!==f?f:3,_retryMaxAttempts:null!==(m=e.retryMaxAttempts)&&void 0!==m?m:3,_retryDelayMs:null!==(p=e.retryDelayMs)&&void 0!==p?p:15e3,_disabledHealthEvents:null!==(g=e.disabledHealthEvents)&&void 0!==g?g:new Set}}(e),this._updateMinifiedPartADimensions(),this._loggerScheduleEventUploadTimer(),this._startOfflineWorker(null!==(t=e.TrustedTypesPolicy)&&void 0!==t&&t),this._initializationCompleted=!0,void this._diagnosticLog(l.InitializedHealth)}catch(e){}this._initializationCompleted=!1}addOrUpdatePartCDimension(e,t){this._checkForInitialization(c.AttemptedToAddOrUpdatePartCDimension)&&e&&(this._additionalPartCDimensions.hasOwnProperty(e)&&this._additionalPartCDimensions[e]===t||(this._loggerSendEventsAndRequeue(!0),this._additionalPartCDimensions[e]=t,this._dimensionsVersion+=1,this._logHeartbeatEvent(),this._logAllPillars()))}addOrUpdateErrorPartCDimension(e,t){this._healthConfig._isErrorPartCEnabled&&e&&(this._additionalErrorPartCDimensions[e]=t)}addQosPillar(e){if(e){const t=0===this._sessionPillars.length;-1===this._sessionPillars.indexOf(e)&&(this._sessionPillars.push(e),this._logPillar(e,!1),this._pillarsChanged(t))}}recordBsqmQosError(e,t,n){if(this._checkForInitialization(c.AttemptedToRecordBSqmQosError)&&(this._stopAllHealthTimers(!1),this._logAllPillars(),e)){const i={b:e,v:t,d:null==n?void 0:n.durationMs,p:r(null==n?void 0:n.extendedProperties),s:this._sessionPillars,i:null==n?void 0:n.inStaging};this._loggerQueueEvent(a.BSqmError,i,e),this.shutdown(!0)}}recordKpiFailure(e,t,n,r,s){this._logKpiEvent(e,!0,i.Failure,s,t,r,n)}recordKpiImpliedFailure(e,t,n,r,s,a){this._logKpiEvent(e,!1,i.ImpliedUsageFailure,a,t,r,n,h.FailureBased,!1,s)}recordKpiImpliedSuccess(e,t,n){this._logKpiEvent(e,!1,i.ImpliedUsageSuccess,n,void 0,void 0,void 0,h.FailureBased,!1,t)}recordKpiSuccess(e,t){this._logKpiEvent(e,!0,i.Success,t)}recordKpiUsage(e,t,n,r){this._logKpiEvent(e,!1,i.Usage,{extendedProperties:r},void 0,void 0,void 0,t,!1,n)}recordKpiUsageForAlertableKpi(e,t,n){if(!e)return;let r=!0;const s=this._kpis[e];s&&(r=s.t===h.FailureBased),this._logKpiEvent(e,!1,i.Usage,{extendedProperties:n},void 0,void 0,void 0,h.FailureBased,!0,t),r&&this._startHeartbeatIfNotAlreadyStarted()}recordQosErrorForCopilot(e,t,n,i,r,s,a,o){const l=o?{...o}:{};l.extendedProperties=l.extendedProperties?{...l.extendedProperties}:new Map,l.extendedProperties.set("Copilot.InteractionId",e),this.recordQosError(t,n,i,r,s,a,l)}recordQosError(e,t,n,i,s,o,l){if((!o||this._checkForInitialization(c.AttemptedToRecordSessionEndingQosError))&&e&&t){const c={n:e,x:n,z:i,l:s,v:t,e:o,d:null==l?void 0:l.durationMs,p:r(null==l?void 0:l.extendedProperties),s:this._sessionPillars,i:null==l?void 0:l.inStaging};this._loggerQueueEvent(a.QosError,c,e),o&&(this._stopAllHealthTimers(!1),this._logAllPillars(),this.shutdown(!0))}}removeQosPillar(e){if(!e)return;const t=this._sessionPillars.indexOf(e);t>-1&&(this._sessionPillars.splice(t,1),this._pillarsChanged(!1)),0===this._sessionPillars.length&&this._stopPeriodicPillarEvents()}resumeAllHealthTimers(){if(this._heartbeatInitialStartCalled&&!this._heartbeatRunning&&this._logHeartbeatAndReQueue(),0===this._recordPillarTimerId&&0!==this._recordPillarLastTimestamp){const e=Date.now()-this._recordPillarLastTimestamp;e>=this._healthConfig._pillarIntervalMs||e<=0?this._logPillarsAndReQueue():this._queueLogPillars(this._healthConfig._pillarIntervalMs-e)}}setHandlerForIsAppShuttingDown(e){e&&(this._isAppShuttingDown=e)}setIsAppOnline(e){var t;this._checkForInitialization(c.AttemptedToSetAppOnlineStatus)&&(!this._isAppOnline&&e&&(null===(t=this._offlineWorker)||void 0===t||t.postMessage({t:a.OfflineWorkerFlush,v:this._isAppShuttingDown()})),this._isAppOnline=e)}shutdown(e=!1){var t;this._healthConfig._isHealthEnabled&&(this._loggerCancelEventUploadTimer(),this._stopAllHealthTimers(!1),this._isAppShuttingDown=()=>!0,this._loggerFlush(),(!e||e&&this._isAppOnline)&&(null===(t=this._offlineWorker)||void 0===t||t.terminate()))}stopAllHealthTimers(){this._stopAllHealthTimers(!0)}_stopAllHealthTimers(e){this._heartbeatRunning=!1,this._heartbeatOrderingNumber=-1,0!==this._heartbeatSendTimerId&&(window.clearTimeout(this._heartbeatSendTimerId),this._heartbeatSendTimerId=0),this._stopPeriodicPillarEvents(),e&&this._loggerFlush()}updatePartADimensions(e){if(!e||!this._checkForInitialization(c.AttemptedToUpdatePartADimensions))return;let t=!1;Object.keys(e).forEach(n=>{void 0!==e[n]&&null!==e[n]&&""!==e[n]&&this._healthConfig._dimensions[n]!==e[n]&&(this._healthConfig._dimensions[n]=e[n],t=!0)}),t&&(this._loggerSendEventsAndRequeue(),this._updateMinifiedPartADimensions(),this._dimensionsVersion+=1,this._logHeartbeatEvent(),this._logAllPillars())}flushAndSetNewEndpoint(e,t){var n;e.localeCompare(null!==(n=this._healthConfig._telemetryUrl)&&void 0!==n?n:"",void 0,{sensitivity:"accent"})&&(this._loggerSendEventsAndRequeue(!1),this._healthConfig._telemetryUrl=e,t&&t())}constructor(){this._additionalPartCDimensions={},this._additionalErrorPartCDimensions={},this._alertableKpiNames=[],this._dimensions={},this._dimensionsVersion=0,this._healthConfig={_heartbeatIntervalMs:3e5,_isHealthEnabled:!1,_isOfflineEnabled:!1,_isErrorPartCEnabled:!1,_maxIntervalMs:3e4,_maxQueueSize:25,_offlineWorkerUrl:"",_pillarIntervalMs:864e5,_telemetryUrl:"",_absoluteTelemetryUrl:"",_maxConcurrentRetries:3,_retryMaxAttempts:3,_retryDelayMs:15e3,_disabledHealthEvents:new Set,_isFetchApiEnabled:!1},this._heartbeatInitialStartCalled=!1,this._heartbeatOrderingNumber=-1,this._heartbeatRunning=!1,this._heartbeatSendTimerId=0,this._isAppOnline=!0,this._isAppShuttingDown=()=>!1,this._kpis={},this._loggerBSqmQosErrorQueue=[],this._loggerCurrentQueueSize=0,this._loggerNonHeartbeatDiagnosticLogsOrPillarsQueueSize=0,this._loggerQueuedHeartbeatEvent=void 0,this._loggerKpiQueue=[],this._loggerQosErrorQueue=[],this._loggerQosPillarQueue=[],this._loggerDiagnosticLogQueue=[],this._loggerSendTimerId=0,this._recordPillarLastTimestamp=0,this._recordPillarTimerId=0,this._sessionPillars=[],this._hasAtLeastOneRequestSucceeded=!1,this._currentRetriesCount=0,this.isUrlOriginPolicyEnabled=!1,this._initializationCompleted=!1,this._loggerCancelEventUploadTimer=()=>{this._loggerSendTimerId&&(window.clearTimeout(this._loggerSendTimerId),this._loggerSendTimerId=0)},this._loggerEmptyQueues=()=>{this._loggerBSqmQosErrorQueue=[],this._loggerKpiQueue=[],this._loggerQosErrorQueue=[],this._loggerQueuedHeartbeatEvent=void 0,this._loggerQosPillarQueue=[],this._loggerDiagnosticLogQueue=[],this._loggerCurrentQueueSize=0,this._loggerNonHeartbeatDiagnosticLogsOrPillarsQueueSize=0},this._loggerFlush=()=>{try{if(this._loggerCurrentQueueSize<=0)return;const e=this._loggerFormatPayload();this._healthConfig._isFetchApiEnabled?this._tryUpload_fetchApi(e,this._dimensionsVersion,this._healthConfig._retryMaxAttempts):this._tryUpload(e,this._dimensionsVersion,this._healthConfig._retryMaxAttempts),this._loggerEmptyQueues()}catch(e){}},this._loggerFormatPayload=()=>({d:this._dimensions,a:this._getMergedPartC(),b:this._loggerBSqmQosErrorQueue,e:this._loggerQosErrorQueue,h:this._loggerQueuedHeartbeatEvent,q:this._loggerQosPillarQueue,k:this._loggerKpiQueue,l:this._loggerDiagnosticLogQueue,type:"h_v2"}),this._getMergedPartC=()=>this._healthConfig._isErrorPartCEnabled&&(this._loggerBSqmQosErrorQueue&&this._loggerBSqmQosErrorQueue.length>0||this._loggerQosErrorQueue&&this._loggerQosErrorQueue.length>0)&&Object.keys(this._additionalErrorPartCDimensions).length>0?{...this._additionalPartCDimensions,...this._additionalErrorPartCDimensions}:this._additionalPartCDimensions,this._loggerQueueEvent=(e,t,n,i=!1)=>{if(t&&!this._healthConfig._disabledHealthEvents.has(n))if(this._isAppOnline){switch(e){case a.BSqmError:this._loggerBSqmQosErrorQueue.push(t);break;case a.Kpi:this._loggerKpiQueue.push(t);break;case a.QosError:this._loggerQosErrorQueue.push(t);break;case a.QosPillar:-1===this._loggerQosPillarQueue.map(e=>e.n).indexOf(t.n)&&this._loggerQosPillarQueue.push(t);break;case a.DiagnosticLog:this._loggerDiagnosticLogQueue.push(t)}if(this._loggerCurrentQueueSize+=1,e!==a.DiagnosticLog&&e!==a.QosPillar&&(this._loggerNonHeartbeatDiagnosticLogsOrPillarsQueueSize+=1),this._isAppShuttingDown()&&!i)return void this._loggerFlush();this._loggerCurrentQueueSize>=this._healthConfig._maxQueueSize&&(this._loggerCancelEventUploadTimer(),this._loggerSendEventsAndRequeue())}else{var r;t.o=(new Date).toJSON(),null===(r=this._offlineWorker)||void 0===r||r.postMessage({t:e,k:`${this._dimensions.w}.${this._dimensionsVersion}`,m:this._dimensions,c:this._getMergedPartC(),v:t})}},this._loggerScheduleEventUploadTimer=()=>{this._loggerCancelEventUploadTimer(),this._loggerSendTimerId=window.setTimeout(()=>{this._loggerSendEventsAndRequeue()},this._healthConfig._maxIntervalMs)},this._loggerSendEventsAndRequeue=(e=!1)=>{e&&this._loggerNonHeartbeatDiagnosticLogsOrPillarsQueueSize<=0||(this._loggerFlush(),this._loggerScheduleEventUploadTimer())},this._logHeartbeatEvent=()=>{if(!this._sessionPillars&&!this._kpis)return;this._loggerQueuedHeartbeatEvent&&-1!==this._heartbeatOrderingNumber||(this._heartbeatOrderingNumber=(this._heartbeatOrderingNumber+1)%1e3),this._loggerQueuedHeartbeatEvent||(this._loggerCurrentQueueSize+=1);const e={p:this._loggerQueuedHeartbeatEvent?s(this._loggerQueuedHeartbeatEvent.p,this._sessionPillars):this._sessionPillars,k:this._loggerQueuedHeartbeatEvent?s(this._loggerQueuedHeartbeatEvent.k,this._alertableKpiNames):this._alertableKpiNames,i:this._healthConfig._heartbeatIntervalMs,o:this._heartbeatOrderingNumber};this._loggerQueuedHeartbeatEvent=e},this._logKpiEvent=(e,t,n,i,s,o,l,c,d,h)=>{if(!e||t&&!this._kpis[e])return;t||this._initKpiIfNeeded(e,c,d,h);const u=this._kpis[e],f={n:u.k,e:n,t:u.t,a:u.a,f:u.o,d:null==i?void 0:i.durationMs,p:r(null==i?void 0:i.extendedProperties)};if(s){const e={n:s,x:l,z:o};f.k=e}this._loggerQueueEvent(a.Kpi,f,e)},this._updateMinifiedPartADimensions=()=>{const e=this._healthConfig._dimensions;var t,n,i,r,s,a,o,l,c,d,h,u,f,m,p,g,_,v,E,T,S,A,b,I,R,C,y,M,O,x,D,P,L,N,F,w,U;e&&(this._dimensions={a:null!==(t=e.application)&&void 0!==t?t:void 0,b:null!==(n=e.applicationLcid)&&void 0!==n?n:void 0,c:null!==(i=e.applicationMode)&&void 0!==i?i:void 0,d:null!==(r=e.applicationModeExtended)&&void 0!==r?r:void 0,e:null!==(s=e.arrVersion)&&void 0!==s?s:void 0,f:null!==(a=e.browser)&&void 0!==a?a:void 0,g:null!==(o=e.browserLcid)&&void 0!==o?o:void 0,h:null!==(l=e.browserMajorVersion)&&void 0!==l?l:void 0,i:null!==(c=e.browserVersion)&&void 0!==c?c:void 0,j:null!==(d=e.clientVersion)&&void 0!==d?d:void 0,k:null!==(h=e.datacenter)&&void 0!==h?h:void 0,l:null!==(u=e.dataCulture)&&void 0!==u?u:void 0,m:null!==(f=e.flightsImpressionId)&&void 0!==f?f:void 0,n:null!==(m=e.host)&&void 0!==m?m:void 0,o:null!==(p=e.isAnonymousUser)&&void 0!==p?p:void 0,p:null!==(g=e.isBusinessUser)&&void 0!==g?g:void 0,q:null!==(_=e.isEduUser)&&void 0!==_?_:void 0,r:null!==(v=e.isSynthetic)&&void 0!==v?v:void 0,s:null!==(E=e.loggableUserId)&&void 0!==E?E:void 0,t:null!==(T=e.loggableUserIdSpace)&&void 0!==T?T:void 0,u:null!==(S=e.ring)&&void 0!==S?S:void 0,v:null!==(A=e.serverDocId)&&void 0!==A?A:void 0,w:null!==(b=e.session_id)&&void 0!==b?b:void 0,x:null!==(I=e.sessionOrigin)&&void 0!==I?I:void 0,y:null!==(R=e.tenantId)&&void 0!==R?R:void 0,z:null!==(C=e.uiHost)&&void 0!==C?C:void 0,aa:null!==(y=e.wfeVersion)&&void 0!==y?y:void 0,ab:null!==(M=e.fileExtension)&&void 0!==M?M:void 0,ac:null!==(O=e.uiHostIntegrationType)&&void 0!==O?O:void 0,ad:null!==(x=e.osVersion)&&void 0!==x?x:void 0,af:null!==(D=e.networkDownlink)&&void 0!==D?D:void 0,ag:null!==(P=e.networkDownlinkMax)&&void 0!==P?P:void 0,ah:null!==(L=e.networkEffectiveType)&&void 0!==L?L:void 0,ai:null!==(N=e.networkRTT)&&void 0!==N?N:void 0,aj:null!==(F=e.networkSaveData)&&void 0!==F?F:void 0,ak:null!==(w=e.networkType)&&void 0!==w?w:void 0,al:null!==(U=e.userLicenseType)&&void 0!==U?U:void 0})},this._logHeartbeatAndReQueue=()=>{this._logHeartbeatEvent(),this._heartbeatSendTimerId=window.setTimeout(()=>{this._logHeartbeatAndReQueue()},this._healthConfig._heartbeatIntervalMs)},this._logAllPillars=()=>{this._sessionPillars&&this._sessionPillars.forEach(e=>{e&&this._logPillar(e,!0)})},this._logPillar=(e,t)=>{const n={};n.n=e,this._loggerQueueEvent(a.QosPillar,n,e,t)},this._logPillarsAndReQueue=()=>{this._sessionPillars&&(this._recordPillarLastTimestamp=Date.now(),this._logAllPillars()),this._queueLogPillars()},this._queueLogPillars=(e=this._healthConfig._pillarIntervalMs)=>{this._recordPillarTimerId=window.setTimeout(()=>{this._logPillarsAndReQueue()},e)},this._startHeartbeatIfNotAlreadyStarted=()=>{this._heartbeatInitialStartCalled||(this._heartbeatInitialStartCalled=!0,this._heartbeatRunning=!0,this._logHeartbeatAndReQueue())},this._stopPeriodicPillarEvents=()=>{0!==this._recordPillarTimerId&&(window.clearTimeout(this._recordPillarTimerId),this._recordPillarTimerId=0)},this._startOfflineWorker=e=>{if(this._healthConfig._isHealthEnabled&&this._healthConfig._isOfflineEnabled&&this._healthConfig._absoluteTelemetryUrl&&""!==this._healthConfig._absoluteTelemetryUrl&&this._healthConfig._offlineWorkerUrl&&""!==this._healthConfig._offlineWorkerUrl){this.isUrlOriginPolicyEnabled=e;try{if("undefined"==typeof Worker)return void this._diagnosticLog(l.WorkerApiIsNotAvailable);if(!this._healthConfig._offlineWorkerUrl)return void this._diagnosticLog(l.InvalidWorkerUrl);this._diagnosticLog(l.InstallingOfflineWorker);const e=new Blob([`try{importScripts('${encodeURI(this._healthConfig._offlineWorkerUrl)}');}catch(e){self.postMessage({i:14,l:'W',r:e.toString()})}`],{type:"application/javascript"});if(this.isUrlOriginPolicyEnabled)try{this._offlineWorker=new Worker(u.a.createScriptURL(URL.createObjectURL(e)))}catch{this._offlineWorker=new Worker(f.a.createScriptURL(""))}else this._offlineWorker=new Worker(URL.createObjectURL(e));this._offlineWorker.onmessage=e=>{try{const t=e.data;this._diagnosticLog(t.i,t.r)}catch(e){this._diagnosticLog(l.FailedToProcessMessageFromOfflineWorker,e.toString())}},this._offlineWorker.postMessage({t:a.OfflineWorkerInit,v:this._healthConfig._absoluteTelemetryUrl}),this._offlineWorker.postMessage({t:a.OfflineWorkerFlush})}catch(e){this._diagnosticLog(l.FailedToInstallOfflineWorker,e.toString())}}},this._trySendPayloadToOfflineWorker=(e,t)=>{if(e.b.length>0||e.e.length>0||e.q.length>0||e.k.length>0||e.l.length>0)try{var n;return null===(n=this._offlineWorker)||void 0===n||n.postMessage({t:a.OfflineWorkerFailedUpload,k:`${e.d.w}.${t}`,v:e}),d.SendSucceeded}catch(e){const t=this._convertExceptionToExtraRuntimeInfo(e);return this._diagnosticLog(l.FailedToSendEventToWorker,t),d.SendFailed}return d.DidNotAttempt},this._initKpiIfNeeded=(e,t,n,i)=>{e&&void 0!==t&&(this._kpis[e]||(this._kpis[e]={k:e,t:t,a:!0===n,o:null!=i?i:void 0},n&&(this._alertableKpiNames.push(e),this._logHeartbeatEvent())))},this._pillarsChanged=e=>{this._heartbeatOrderingNumber=-1,e?(this._recordPillarLastTimestamp=Date.now(),this._queueLogPillars(),this._startHeartbeatIfNotAlreadyStarted()):this._logHeartbeatEvent()},this._checkForInitialization=e=>!!this._initializationCompleted||(this._diagnosticLog(l.AttemptToUseFunctionalityBeforeIitialization,null==e?void 0:e.toString()),!1),this._tryUpload=(e,t,n)=>{if(!e)return;const i=this._healthConfig._telemetryUrl;if(""===i)return;if(this._hasAtLeastOneRequestSucceeded&&(n<=0||!this._isAppOnline)&&this._trySendPayloadToOfflineWorker(e,t)!==d.SendFailed)return;if(n<=0)return;const r=this._jsonStringifyNoThrow(e,!1);if(null===r)return;if(this._isAppShuttingDown())try{if(void 0!==navigator.sendBeacon){if(r.length>=65536&&this._healthConfig._isErrorPartCEnabled){const t={...e,a:this._additionalPartCDimensions},n=this._jsonStringifyNoThrow(t,!0);if(null===n)return;navigator.sendBeacon(i,n)}else navigator.sendBeacon(i,r);return}}catch(e){}const s=new XMLHttpRequest;s.open("POST",i,!0),s.onreadystatechange=()=>{s.readyState===XMLHttpRequest.DONE&&(200===s.status?this._hasAtLeastOneRequestSucceeded||(this._hasAtLeastOneRequestSucceeded=!0):this._currentRetriesCount<this._healthConfig._maxConcurrentRetries?(this._currentRetriesCount+=1,window.setTimeout(()=>{this._currentRetriesCount-=1,this._tryUpload(e,t,n-1)},this._healthConfig._retryDelayMs)):this._hasAtLeastOneRequestSucceeded&&this._trySendPayloadToOfflineWorker(e,t))},s.send(r)},this._diagnosticLog=(e,t)=>{const n={i:e,r:t};this._loggerQueueEvent(a.DiagnosticLog,n,e.toString())},this._convertExceptionToExtraRuntimeInfo=e=>{let t=void 0;return"string"==typeof e?t=e:e instanceof Error&&(t=e.name+" "+e.message,e.stack&&(t+=" "+e.stack)),t},this._jsonStringifyNoThrow=(e,t)=>{try{return n=e,JSON.stringify(n)}catch(e){let n=this._convertExceptionToExtraRuntimeInfo(e);return n="ModifiedPayload: "+t+" | "+n,this._diagnosticLog(l.FailedToJsonStringifyEvent,n),null}var n},this._tryUpload_fetchApi=(e,t,n)=>{if(!e)return;const i=this._healthConfig._telemetryUrl;if(""===i)return;if(this._hasAtLeastOneRequestSucceeded&&(n<=0||!this._isAppOnline)){if(this._trySendPayloadToOfflineWorker(e,t)!==d.SendFailed)return;if(n<=0)return}const r=this._jsonStringifyNoThrow(e,!1);if(null!==r){if(this._isAppShuttingDown())try{if(r.length>=65536&&this._healthConfig._isErrorPartCEnabled){const t={...e,a:this._additionalPartCDimensions},n=this._jsonStringifyNoThrow(t,!0);if(null===n)return;fetch(new Request(i,{method:"POST",body:n,keepalive:!0})).catch(()=>{})}else fetch(new Request(i,{method:"POST",body:r,keepalive:!0})).catch(()=>{});return}catch(e){}fetch(new Request(i,{method:"POST",body:r})).then(i=>{i.ok?this._hasAtLeastOneRequestSucceeded||(this._hasAtLeastOneRequestSucceeded=!0):this._currentRetriesCount<this._healthConfig._maxConcurrentRetries?(this._currentRetriesCount+=1,globalThis.setTimeout(async()=>{this._currentRetriesCount-=1,this._tryUpload_fetchApi(e,t,n-1)},this._healthConfig._retryDelayMs)):this._hasAtLeastOneRequestSucceeded&&this._trySendPayloadToOfflineWorker(e,t)}).catch(e=>{})}}}}class p{isEventBlocked(e,t){const n=this.blockedEvents.get(e);return!!n&&(Date.now()>=n?(this.unblockEvent(e),!1):(this.aggregateEventCount(e),t&&(this.eventCallbacks.set(e,t),this.scheduleAndFlushCallbacks()),!0))}scheduleAndFlushCallbacks(){void 0===this.batchTimerId&&this.eventCallbacks.size>0&&(this.batchTimerId=window.setTimeout(()=>{const e=Date.now(),t=[];this.eventCallbacks.forEach((n,i)=>{const r=this.blockedEvents.get(i);r&&e>=r&&(n(),t.push(i))});for(const e of t)this.blockedEvents.delete(e),this.eventCallbacks.delete(e);this.batchTimerId=void 0,this.scheduleAndFlushCallbacks()},1e4))}blockEvent(e,t){const n=Date.now()+t;this.blockedEvents.set(e,n),this.updateEventHitCount(e,0),this.eventDurations.delete(e),this.eventDurationsTotal.delete(e)}unblockEvent(e){this.blockedEvents.delete(e)}getEventHitCount(e){return this.eventHitCounts.get(e)}updateEventHitCount(e,t){this.eventHitCounts.set(e,t)}aggregateEventCount(e){let t=this.getEventHitCount(e);"number"==typeof t&&this.updateEventHitCount(e,++t)}getEventDurations(e){return this.eventDurations.get(e)}aggregateEventDuration(e,t){var n;const i=(null!==(n=this.getEventHitCount(e))&&void 0!==n?n:0)+1,r=this.eventDurationsTotal.get(e),s=this.eventDurations.get(e);if(void 0!==s){const n=[...s];let a;s[0]>t&&(n[0]=t),s[1]<t&&(n[1]=t),void 0!==r&&r.length<10?(r.push(t),a=r.reduce((e,t)=>e+t,0)/i):(a=s[2]+(t-s[2])/i,this.eventDurationsTotal.delete(e)),n[2]=a,this.eventDurations.set(e,n)}else this.eventDurations.set(e,[t,t,t]),this.eventDurationsTotal.set(e,[t])}constructor(){this.blockedEvents=new Map,this.eventCallbacks=new Map,this.eventHitCounts=new Map,this.eventDurations=new Map,this.eventDurationsTotal=new Map,this.batchTimerId=void 0}}class g{logKpiUsage(e,t,n,i){const r=this.getKpiKey(e+g.USAGE_KPI,null==n?void 0:n.extendedProperties),s=()=>this.recordKpiUsage(e,t,n,r);if(this.kpiUsageEventBlocker.isEventBlocked(r,s))return!1;if(this.ensureFeatureDenominatorLoggedAndVetoPillarRegistered(n),s(),0!==i){const e=null!=i?i:3e5;this.kpiUsageEventBlocker.blockEvent(r,e)}return!0}logKpiFailure(e,t,n,i,r){var s,a;const o=this.getKpiKey(e+g.FAILURE_KPI+t,null==n||null===(s=n.additionalValues)||void 0===s?void 0:s.extendedProperties);"number"==typeof(null==n||null===(a=n.additionalValues)||void 0===a?void 0:a.durationMs)&&this.kpiFailureEventBlocker.aggregateEventDuration(o,n.additionalValues.durationMs);const l=()=>this.recordKpiFailure(e,t,n,o);if(this.kpiFailureEventBlocker.isEventBlocked(o,l))return!1;var c;if(this.ensureFeatureDenominatorLoggedAndVetoPillarRegistered(),l(),i&&this.recordQosError(null!==(c=i.errorNameOverride)&&void 0!==c?c:t,i.name,i),0!==r){const e=null!=r?r:3e5;this.kpiFailureEventBlocker.blockEvent(o,e)}return!0}logKpiSuccess(e,t,n){var i,r;const s=this.getKpiKey(e+g.SUCCESS_KPI,null==t||null===(i=t.additionalValues)||void 0===i?void 0:i.extendedProperties);"number"==typeof(null==t||null===(r=t.additionalValues)||void 0===r?void 0:r.durationMs)&&this.kpiSuccessEventBlocker.aggregateEventDuration(s,t.additionalValues.durationMs);const a=()=>this.recordKpiSuccess(e,t,s);if(this.kpiSuccessEventBlocker.isEventBlocked(s,a))return!1;if(this.ensureFeatureDenominatorLoggedAndVetoPillarRegistered(),a(),0!==n){const e=null!=n?n:3e5;this.kpiSuccessEventBlocker.blockEvent(s,e)}return!0}ensureFeatureDenominatorLoggedAndVetoPillarRegistered(e){var t;const n=this.featureConfig.topLevelKpiName,i=this.getKpiKey(this.featureConfig.topLevelKpiName,null==e?void 0:e.extendedProperties);if(this.kpiUsageEventBlocker.isEventBlocked(null!=i?i:""))return;this.recordKpiUsage(n,h.FailureBased,e);const r=null!==(t=this.featureConfig.vetoPillar)&&void 0!==t?t:this.featureConfig.areaName;r&&g.QOS_PILLARS_LIST.includes(r)&&this.healthLogger.addQosPillar(r),this.kpiUsageEventBlocker.blockEvent(null!=i?i:"",864e5)}recordKpiUsage(e,t,n={},i){const{extendedProperties:r,isForAlertableKpi:s}=n||{},a=this.createExtendedPropertiesWithMoreFields(r,i);s?this.healthLogger.recordKpiUsageForAlertableKpi(e,this.featureConfig.crewAlias,a):this.healthLogger.recordKpiUsage(e,t,this.featureConfig.crewAlias,a)}getKpiKey(e,t){const n=this.getKpiAreaName(t),i=this.getKpiFeatureName(t),r=this.getKpiPivot(t);return`${n}.${i}.${null!=e?e:""}${r&&0!==r.length?"."+r:""}`}getKpiAreaName(e){var t,n,i;return null!==(t=null!==(n=null!==(i=null==e?void 0:e.get(g.AREA_NAME_COLUMN_KEY))&&void 0!==i?i:this.featureConfig.areaName)&&void 0!==n?n:this.featureConfig.vetoPillar)&&void 0!==t?t:""}getKpiFeatureName(e){var t,n;return null!==(t=null!==(n=null==e?void 0:e.get(g.FEATURE_NAME_COLUMN_KEY))&&void 0!==n?n:this.featureConfig.featureName)&&void 0!==t?t:""}getKpiPivot(e){const t=null==e?void 0:e.get(g.PIVOT_TYPE_COLUMN_KEY),n=null==e?void 0:e.get(g.PIVOT_VALUE_COLUMN_KEY);return t&&0!==t.length&&n&&0!==n.length?`${t}=${n}`:""}recordKpiFailure(e,t,n={},i){const{isIntentional:r,isInternal:s,additionalValues:a,hasImpliedUsage:o}=n||{},l=this.createAdditionalValuesWithMoreFields(a,i);!1===o?this.healthLogger.recordKpiFailure(e,t,r,s,l):this.healthLogger.recordKpiImpliedFailure(e,t,r,s,this.featureConfig.crewAlias,l)}recordKpiSuccess(e,t={},n){const{additionalValues:i,hasImpliedUsage:r}=t||{},s=this.createAdditionalValuesWithMoreFields(i,n);!1===r?this.healthLogger.recordKpiSuccess(e,s):this.healthLogger.recordKpiImpliedSuccess(e,this.featureConfig.crewAlias,s)}recordQosError(e,t,n={}){const{isIntentional:i,isInternal:r,alertOnPillar:s,isSessionEndingError:a,additionalValues:o}=n,l=this.createAdditionalValuesWithMoreFields(o);this.healthLogger.recordQosError(e,[t],i,r,s,a,l)}createExtendedPropertiesWithMoreFields(e,t){const n=new Map(e||new Map);if(n.get(g.FEATURE_NAME_COLUMN_KEY)||n.set(g.FEATURE_NAME_COLUMN_KEY,this.getKpiFeatureName(e)),n.set(g.AREA_NAME_COLUMN_KEY,this.getKpiAreaName(n)),n.has(g.SKIP_ARIA_COLUMN_KEY)||n.has("skipAria")||n.set(g.SKIP_ARIA_COLUMN_KEY,"true"),!this.featureConfig.doNotEmitAggregatedCount&&t){const e=this.getEventBlocker(t);if(e){const i=e.getEventHitCount(t);if(i){n.set(g.AGGREGATED_COUNT_COLUMN_KEY,i.toString());const r=e.getEventDurations(t);i>1&&r&&n.set(g.AGGREGATED_DURATION_COLUMN_KEY,r.map(e=>Math.round(100*e)/100).toString())}}}return n}createAdditionalValuesWithMoreFields(e,t){let n={};return n={...e},n.extendedProperties=this.createExtendedPropertiesWithMoreFields(null==e?void 0:e.extendedProperties,t),n}getEventBlocker(e){return e.includes(g.USAGE_KPI)?this.kpiUsageEventBlocker:e.includes(g.FAILURE_KPI)?this.kpiFailureEventBlocker:e.includes(g.SUCCESS_KPI)?this.kpiSuccessEventBlocker:void 0}constructor(e,t,n,i,r){this.healthLogger=e,this.featureConfig=t,this.kpiUsageEventBlocker=n,this.kpiFailureEventBlocker=i,this.kpiSuccessEventBlocker=r}}g.FEATURE_NAME_COLUMN_KEY="FeatureName",g.AREA_NAME_COLUMN_KEY="AreaName",g.AGGREGATED_COUNT_COLUMN_KEY="AggCount",g.AGGREGATED_DURATION_COLUMN_KEY="AggMs",g.SKIP_ARIA_COLUMN_KEY="SkipAria",g.PIVOT_TYPE_COLUMN_KEY="PivotType",g.PIVOT_VALUE_COLUMN_KEY="PivotValue",g.QOS_PILLARS_LIST=["Interruptions","Open","NotebookNavigation","Fidelity","AsyncCollab","Present","ContentConsumption","bSqmCompatibility","Boot"],g.USAGE_KPI=".Usage",g.SUCCESS_KPI=".Success",g.FAILURE_KPI=".Failure.";class _{static getInstance(e,t,n,i,r){return new _(e,t,n,i,r)}logKpiUsage(e){var t;return!(!e||!e.kpiName)&&this.featureUsageAndHealthLogger.logKpiUsage(e.kpiName,null!==(t=e.kpiType)&&void 0!==t?t:h.FailureBased,e.optionalProperties,e.blockFutureEmissionDurationInMs)}logKpiFailure(e){return!!(e&&e.kpiName&&e.errorName)&&this.featureUsageAndHealthLogger.logKpiFailure(e.kpiName,e.errorName,e.optionalProperties,e.optionalVeto,e.blockFutureEmissionDurationInMs)}logKpiSuccess(e){return!(!e||!e.kpiName)&&this.featureUsageAndHealthLogger.logKpiSuccess(e.kpiName,e.optionalProperties,e.blockFutureEmissionDurationInMs)}ensureFeatureDenominatorLoggedAndVetoPillarRegistered(e){this.featureUsageAndHealthLogger.ensureFeatureDenominatorLoggedAndVetoPillarRegistered(e)}constructor(e,t,n,i,r){var s,a,o;this.healthLogger=e,this.featureConfig=t,this.kpiUsageEventBlocker=n,this.kpiFailureEventBlocker=i,this.kpiSuccessEventBlocker=r,this.featureUsageAndHealthLogger=new g(this.healthLogger,this.featureConfig,null!==(s=this.kpiUsageEventBlocker)&&void 0!==s?s:_.kpiUsageBlocker,null!==(a=this.kpiSuccessEventBlocker)&&void 0!==a?a:_.kpiFailureBlocker,null!==(o=this.kpiFailureEventBlocker)&&void 0!==o?o:_.kpiSuccessBlocker),this.executeCallbackWithLogging=(e,t)=>{var n,i;const r=e=>"VetoFailureLoggingParams".includes(e);let s,a;null!=t&&t.kpiUsageLoggingParams?(s="Usage",a=null==t?void 0:t.kpiUsageLoggingParams):null!=t&&t.kpiSuccessLoggingParams?(s="UsageWithSuccess",a=null==t?void 0:t.kpiSuccessLoggingParams):null!=t&&t.kpiFailureLoggingParams?(s="UsageWithFailure",a=null==t?void 0:t.kpiFailureLoggingParams):(s="UsageWithVetoFailure",a=null==t?void 0:t.vetoFailureLoggingParams);const o=null===(n=a)||void 0===n?void 0:n.usageName,l=null===(i=a)||void 0===i?void 0:i.usageKpiType;this.logKpiUsage({kpiName:o,kpiType:null!=l?l:h.FailureBased});try{null==e||e(),"UsageWithSuccess"===s&&"KpiSuccessLoggingParams".includes(a)&&this.logKpiSuccess({kpiName:o,optionalProperties:a.successOptionalProperties})}catch(e){if("UsageWithFailure"===s&&(e=>"KpiFailureLoggingParams".includes(e))(a)||"UsageWithVetoFailure"===s&&r(a)){let e;var c;r(a)&&(e={name:null!==(c=a.vetoName)&&void 0!==c?c:"",...a.vetoOptionalProperties}),this.logKpiFailure({kpiName:a.usageName,errorName:a.failureErrorName,optionalProperties:a.failureOptionalProperties,optionalVeto:e})}throw e}}}}_.kpiUsageBlocker=new p,_.kpiFailureBlocker=new p,_.kpiSuccessBlocker=new p;class v{getHealthInstance(e){if(e)return m.getInstance().initialize(e),m.getInstance()}getExtendedHealthInstance(e,t){if(e&&t)return _.getInstance(e,t)}}!function(e){e[e.FailureBased=0]="FailureBased",e[e.SuccessBased=1]="SuccessBased"}(h||(h={}));const E=new v},function(e,t,n){"use strict";n.r(t),n.d(t,"shadowMapVertexShader",(function(){return s}));var i=n(66);n(344),n(345),n(346),n(347),n(323);i.a.IncludesShadersStore.sceneVertexDeclaration="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;\n",i.a.IncludesShadersStore.meshVertexDeclaration="uniform mat4 world;uniform float visibility;\n",i.a.IncludesShadersStore.shadowMapVertexDeclaration="#include<sceneVertexDeclaration>\n#include<meshVertexDeclaration>\n",n(383),n(384);i.a.IncludesShadersStore.shadowMapUboDeclaration="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";i.a.IncludesShadersStore.shadowMapVertexExtraDeclaration="#if SM_NORMALBIAS==1\nuniform vec3 lightDataSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nvarying vec3 vPositionWSM;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n",n(348),n(349),n(350),n(351),n(352),n(353);i.a.IncludesShadersStore.shadowMapVertexNormalBias="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvec3 worldLightDirSM=normalize(-lightDataSM.xyz);\n#else\nvec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);\n#endif\nfloat ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;\n#endif\n";i.a.IncludesShadersStore.shadowMapVertexMetric="#if SM_USEDISTANCE==1\nvPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#else\ngl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nzSM=gl_Position.z;gl_Position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\nvDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n",n(354);const r="attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#endif\n#include<helperFunctions>\n#include<__decl__shadowMapVertex>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normWorldSM=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvec3 vNormalW=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\ngl_Position=viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n}";i.a.ShadersStore.shadowMapVertexShader=r;const s={name:"shadowMapVertexShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"shadowMapPixelShaderWGSL",(function(){return s}));var i=n(66);n(380);i.a.IncludesShadersStoreWGSL.bayerDitherFunctions="fn bayerDither2(_P: vec2f)->f32 {return ((2.0*_P.y+_P.x+1.0)%(4.0));}\nfn bayerDither4(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); \nvar P2: vec2f=floor(0.5*((_P)%(4.0))); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);}\nfn bayerDither8(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); \nvar P2: vec2f=floor(0.5 *((_P)%(4.0))); \nvar P4: vec2f=floor(0.25*((_P)%(8.0))); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}\n";i.a.IncludesShadersStoreWGSL.shadowMapFragmentExtraDeclaration="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform softTransparentShadowSM: vec2f;\n#endif\nvarying vDepthMetricSM: f32;\n#if SM_USEDISTANCE==1\nuniform lightDataSM: vec3f;varying vPositionWSM: vec3f;\n#endif\nuniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying zSM: f32;\n#endif\n",n(355),n(356);i.a.IncludesShadersStoreWGSL.shadowMapFragment="var depthSM: f32=fragmentInputs.vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\ndepthSM=(fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\nfragmentOutputs.fragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\nfragmentOutputs.fragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,uniforms.biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\nfragmentOutputs.color= vec4f(depthSM,1.0,1.0,1.0);\n#else\nfragmentOutputs.color=pack(depthSM);\n#endif\n";const r="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nvar opacityMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV);var alphaFromAlphaTexture: f32=opacityMap.a;\n#if SM_SOFTTRANSPARENTSHADOW==1\nif (uniforms.softTransparentShadowSM.y==1.0) {opacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}\n#endif\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE) {discard;}\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alphaFromAlphaTexture) {discard;}\n#else\nif ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x) {discard;} \n#endif\n#endif\n#include<shadowMapFragment>\n}";i.a.ShadersStoreWGSL.shadowMapPixelShader=r;const s={name:"shadowMapPixelShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"shadowMapVertexShaderWGSL",(function(){return s}));var i=n(66);n(357),n(358),n(359),n(360),n(322),n(381),n(382);i.a.IncludesShadersStoreWGSL.shadowMapVertexExtraDeclaration="#if SM_NORMALBIAS==1\nuniform lightDataSM: vec3f;\n#endif\nuniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;varying vDepthMetricSM: f32;\n#if SM_USEDISTANCE==1\nvarying vPositionWSM: vec3f;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying zSM: f32;\n#endif\n",n(361),n(362),n(363),n(364),n(365),n(366);i.a.IncludesShadersStoreWGSL.shadowMapVertexNormalBias="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvar worldLightDirSM: vec3f=normalize(-uniforms.lightDataSM.xyz);\n#else\nvar directionToLightSM: vec3f=uniforms.lightDataSM.xyz-worldPos.xyz;var worldLightDirSM: vec3f=normalize(directionToLightSM);\n#endif\nvar ndlSM: f32=dot(vNormalW,worldLightDirSM);var sinNLSM: f32=sqrt(1.0-ndlSM*ndlSM);var normalBiasSM: f32=uniforms.biasAndScaleSM.y*sinNLSM;worldPos=vec4f(worldPos.xyz-vNormalW*normalBiasSM,worldPos.w);\n#endif\n";i.a.IncludesShadersStoreWGSL.shadowMapVertexMetric="#if SM_USEDISTANCE==1\nvertexOutputs.vPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.position.z-=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;\n#else\nvertexOutputs.position.z+=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvertexOutputs.zSM=vertexOutputs.position.z;vertexOutputs.position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetricSM=(-vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\nvertexOutputs.vDepthMetricSM=(vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#endif\n",n(367);const r="attribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute world0: vec4f;attribute world1: vec4f;attribute world2: vec4f;attribute world3: vec4f;\n#endif\n#include<helperFunctions>\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n#ifdef ALPHATEXTURE\nvarying vUV: vec2f;uniform diffuseMatrix: mat4x4f;\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=input.uv2;\n#endif\n#ifdef NORMAL\nvar normalUpdated: vec3f=input.normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);\n#ifdef NORMAL\nvar normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvar vNormalW: vec3f=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvar vNormalW: vec3f=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\nvertexOutputs.position=scene.viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef UV2\nvertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n#include<clipPlaneVertex>\n}";i.a.ShadersStoreWGSL.shadowMapVertexShader=r;const s={name:"shadowMapVertexShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"shadowMapPixelShader",(function(){return s}));var i=n(66);n(378);i.a.IncludesShadersStore.bayerDitherFunctions="float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}\nfloat bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5*mod(_P,4.0)); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);}\nfloat bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5 *mod(_P,4.0)); \nvec2 P4=floor(0.25*mod(_P,8.0)); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}\n";i.a.IncludesShadersStore.shadowMapFragmentExtraDeclaration="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform vec2 softTransparentShadowSM;\n#endif\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nuniform vec3 lightDataSM;varying vec3 vPositionWSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n",n(342),n(343);i.a.IncludesShadersStore.shadowMapFragment="float depthSM=vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\ndepthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_FragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\ngl_FragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\ngl_FragColor=vec4(depthSM,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depthSM);\n#endif\nreturn;";const r="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nvec4 opacityMap=texture2D(diffuseSampler,vUV);float alphaFromAlphaTexture=opacityMap.a;\n#if SM_SOFTTRANSPARENTSHADOW==1\nif (softTransparentShadowSM.y==1.0) {opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}\n#endif\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE)\ndiscard;\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alphaFromAlphaTexture) discard;\n#else\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x) discard;\n#endif\n#endif\n#include<shadowMapFragment>\n}";i.a.ShadersStore.shadowMapPixelShader=r;const s={name:"shadowMapPixelShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"defaultPixelShader",(function(){return s}));var i=n(66);n(461);i.a.IncludesShadersStore.defaultFragmentDeclaration="uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;uniform vec4 vSpecularColor;uniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#ifdef ALPHATEST\nuniform float alphaCutOff;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;\n#endif\n#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)\nuniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; \n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;\n#endif\n#if defined(REFLECTION) || (defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED))\nuniform vec2 vReflectionInfos;\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)\nuniform mat4 reflectionMatrix;\n#endif\n#ifndef REFLECTIONMAP_SKYBOX\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#define ADDITIONAL_FRAGMENT_DECLARATION\n",n(445),n(462),n(463),n(370),n(323),n(464),n(465),n(466);i.a.IncludesShadersStore.lightsFragmentFunctions="struct lightingInfo\n{vec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)\n{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}\nelse\n{lightVectorW=normalize(-lightData.xyz);}\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nfloat getAttenuation(float cosAngle,float exponent) {return max(0.,pow(cosAngle,exponent));}\nfloat getIESAttenuation(float cosAngle,sampler2D iesLightSampler) {float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}\nlightingInfo basicSpotLighting(vec3 viewDirectionW,vec3 lightVectorW,vec3 vNormal,float attenuation,vec3 diffuseColor,vec3 specularColor,float glossiness) {lightingInfo result; \nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nlightingInfo computeIESSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness,sampler2D iesLightSampler) { \nvec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float dotProduct=dot(lightDirection.xyz,-lightVectorW);float cosAngle=max(0.,dotProduct);if (cosAngle>=lightDirection.w)\n{ \nattenuation*=getIESAttenuation(dotProduct,iesLightSampler);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nlightingInfo result;result.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)\n{ \nattenuation*=getAttenuation(cosAngle,lightData.w);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nlightingInfo result;result.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;\n#endif\nreturn result;}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\n#include<ltcHelperFunctions>\nuniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;\n#define inline\nlightingInfo computeAreaLighting(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec3 lightPosition,vec3 halfWidth,vec3 halfHeight,vec3 diffuseColor,vec3 specularColor,float roughness) \n{lightingInfo result;areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);\n#ifdef SPECULARTERM\nvec3 fresnel=( specularColor*data.Fresnel.x+( vec3( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;\n#endif\nresult.diffuse+=diffuseColor*data.Diffuse;return result;}\n#endif\n",n(467),n(387);i.a.IncludesShadersStore.fresnelFunction="#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}\n#endif\n",n(468),n(469),n(470),n(471),n(472),n(342),n(371),n(473),n(343),n(474),n(475),n(476),n(477),n(478),n(479),n(480);const r="#define CUSTOM_FRAGMENT_EXTENSION\n#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<alphaCutOff)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor.rgb*=vColor.rgb;\n#endif\n#ifdef DETAIL\nbaseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);\n#endif\n#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nfloat glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;float aggShadow=0.;float numLights=0.;\n#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\naggShadow=aggShadow/numLights;vec4 refractionColor=vec4(0.,0.,0.,1.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor.rgb=fromRGBD(refractionColor);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor.rgb=toGammaSpace(refractionColor.rgb);\n#endif\nrefractionColor.rgb*=vRefractionInfos.x;\n#endif\nvec4 reflectionColor=vec4(0.,0.,0.,1.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor.rgb=toGammaSpace(reflectionColor.rgb);\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<alphaCutOff)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor.rgb;\n#else\ncolor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);\n#endif\n#endif\ncolor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;\n#ifdef PREPASS_COLOR\ngl_FragData[PREPASS_COLOR_INDEX]=color; \n#endif\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\ngl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);\n#endif\n#if defined(PREPASS_VELOCITY)\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\ngl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);\n#else\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\ngl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\ngl_FragData[PREPASS_ALBEDO_INDEX]=vec4(baseColor.rgb,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqrt(baseColor.rgb),writeGeometryInfo);\n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULAR)\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; \n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i.a.ShadersStore.defaultPixelShader=r;const s={name:"defaultPixelShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"kernelBlurPixelShaderWGSL",(function(){return s}));var i=n(66);n(409),n(380);i.a.IncludesShadersStoreWGSL.kernelBlurFragment="#ifdef DOF\nfactor=sampleCoC(fragmentInputs.sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X}))*computedWeight;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X})*computedWeight;\n#endif\n";i.a.IncludesShadersStoreWGSL.kernelBlurFragment2="#ifdef DOF\nfactor=sampleCoC(fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";const r="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform delta: vec2f;varying sampleCenter: vec2f;\n#ifdef DOF\nvar circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;fn sampleCoC(offset: vec2f)->f32 {var coc: f32=textureSample(circleOfConfusionSampler,circleOfConfusionSamplerSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var computedWeight: f32=0.0;\n#ifdef PACKEDFLOAT\nvar blend: f32=0.;\n#else\nvar blend: vec4f= vec4f(0.);\n#endif\n#ifdef DOF\nvar sumOfWeights: f32=CENTER_WEIGHT; \nvar factor: f32=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,input.sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,input.sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\nfragmentOutputs.color=pack(blend);\n#else\nfragmentOutputs.color=blend;\n#endif\n#ifdef DOF\nfragmentOutputs.color/=sumOfWeights;\n#endif\n}";i.a.ShadersStoreWGSL.kernelBlurPixelShader=r;const s={name:"kernelBlurPixelShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"kernelBlurPixelShader",(function(){return s}));var i=n(66);n(410),n(378);i.a.IncludesShadersStore.kernelBlurFragment="#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif\n";i.a.IncludesShadersStore.kernelBlurFragment2="#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";const r="uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float computedWeight=0.0;\n#ifdef PACKEDFLOAT\nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}";i.a.ShadersStore.kernelBlurPixelShader=r;const s={name:"kernelBlurPixelShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"defaultPixelShaderWGSL",(function(){return s}));var i=n(66);n(411),n(426),n(427),n(368),n(322),n(428),n(429);i.a.IncludesShadersStoreWGSL.lightsFragmentFunctions="struct lightingInfo\n{diffuse: vec3f,\n#ifdef SPECULARTERM\nspecular: vec3f,\n#endif\n#ifdef NDOTL\nndl: f32,\n#endif\n};fn computeLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var lightVectorW: vec3f;var attenuation: f32=1.0;if (lightData.w==0.)\n{var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var attenuation: f32=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}\nelse\n{lightVectorW=normalize(-lightData.xyz);}\nvar ndl: f32=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nfn getAttenuation(cosAngle: f32,exponent: f32)->f32 {return max(0.,pow(cosAngle,exponent));}\nfn getIESAttenuation(cosAngle: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32 {var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}\nfn computeBasicSpotLighting(viewDirectionW: vec3f,lightVectorW: vec3f,vNormal: vec3f,attenuation: f32,diffuseColor: vec3f,specularColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nfn computeIESSpotLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var dotProduct=dot(lightDirection.xyz,-lightVectorW);var cosAngle: f32=max(0.,dotProduct);if (cosAngle>=lightDirection.w)\n{attenuation*=getIESAttenuation(dotProduct,iesLightTexture,iesLightTextureSampler);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nvar result: lightingInfo;result.diffuse=vec3f(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3f(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nfn computeSpotLighting(viewDirectionW: vec3f,vNormal: vec3f ,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var cosAngle: f32=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)\n{attenuation*=getAttenuation(cosAngle,lightData.w);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}\nvar result: lightingInfo;result.diffuse=vec3f(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3f(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nfn computeHemisphericLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,groundColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightData.xyz);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;\n#endif\nreturn result;}\nfn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f {var strq: vec4f=textureProjectionMatrix*vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return textureColor;}\n#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)\n#include<ltcHelperFunctions>\nvar areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;fn computeAreaLighting(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightPosition:vec3f,halfWidth:vec3f, halfHeight:vec3f,diffuseColor:vec3f,specularColor:vec3f,roughness:f32 )->lightingInfo\n{var result: lightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);\n#ifdef SPECULARTERM\nvar fresnel:vec3f=( specularColor*data.Fresnel.x+( vec3f( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;\n#endif\nresult.diffuse+=diffuseColor*data.Diffuse;return result;}\n#endif\n",n(430),n(386);i.a.IncludesShadersStoreWGSL.fresnelFunction="#ifdef FRESNEL\nfn computeFresnelTerm(viewDirection: vec3f,worldNormal: vec3f,bias: f32,power: f32)->f32\n{let fresnelTerm: f32=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}\n#endif\n",n(431),n(432),n(433),n(434),n(435),n(355),n(369),n(436),n(356),n(437),n(438),n(439),n(440),n(441),n(442),n(443);const r="#include<defaultUboDeclaration>\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\nvarying vPositionW: vec3f;\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<lightUboDeclaration>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nvar refractionCubeSamplerSampler: sampler;var refractionCubeSampler: texture_cube<f32>;\n#else\nvar refraction2DSamplerSampler: sampler;var refraction2DSampler: texture_2d<f32>;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nvar reflectionCubeSamplerSampler: sampler;var reflectionCubeSampler: texture_cube<f32>;\n#else\nvar reflection2DSamplerSampler: sampler;var reflection2DSampler: texture_2d<f32>;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvar viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-fragmentInputs.vPositionW);var baseColor: vec4f= vec4f(1.,1.,1.,1.);var diffuseColor: vec3f=uniforms.vDiffuseColor.rgb;var alpha: f32=uniforms.vDiffuseColor.a;\n#ifdef NORMAL\nvar normalW: vec3f=normalize(fragmentInputs.vNormalW);\n#else\nvar normalW: vec3f=normalize(-cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=select(-normalW,normalW,fragmentInputs.frontFacing);\n#endif\n#ifdef DIFFUSE\nbaseColor=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<uniforms.alphaCutOff) {discard;}\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor=vec4f(baseColor.rgb*uniforms.vDiffuseInfos.y,baseColor.a);\n#endif\n#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)\nvar decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor=vec4f(baseColor.rgb*fragmentInputs.vColor.rgb,baseColor.a);\n#endif\n#ifdef DETAIL\nbaseColor=vec4f(baseColor.rgb*2.0*mix(0.5,detailColor.r,uniforms.vDetailInfos.y),baseColor.a);\n#endif\n#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)\nvar decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvar baseAmbientColor: vec3f= vec3f(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb*uniforms.vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nvar glossiness: f32=uniforms.vSpecularColor.a;var specularColor: vec3f=uniforms.vSpecularColor.rgb;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\nvar specularMapColor: vec4f=textureSample(specularSampler,specularSamplerSampler,fragmentInputs.vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#endif\nvar diffuseBase: vec3f= vec3f(0.,0.,0.);var info: lightingInfo;\n#ifdef SPECULARTERM\nvar specularBase: vec3f= vec3f(0.,0.,0.);\n#endif\nvar shadow: f32=1.;var aggShadow: f32=0.;var numLights: f32=0.;\n#ifdef LIGHTMAP\nvar lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);\n#endif\nlightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\naggShadow=aggShadow/numLights;var refractionColor: vec4f= vec4f(0.,0.,0.,1.);\n#ifdef REFRACTION\nvar refractionVector: vec3f=normalize(refract(-viewDirectionW,normalW,uniforms.vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(fragmentInputs.vPositionW,refractionVector,uniforms.vRefractionSize,uniforms.vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*uniforms.vRefractionInfos.w;var refractionLookup: vec4f=textureSample(refractionCubeSampler,refractionCubeSamplerSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}\n#else\nvar vRefractionUVW: vec3f= (uniforms.refractionMatrix*(scene.view* vec4f(fragmentInputs.vPositionW+refractionVector*uniforms.vRefractionInfos.z,1.0))).xyz;var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=textureSample(refraction2DSampler,refraction2DSamplerSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor=vec4f(fromRGBD(refractionColor),refractionColor.a);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor=vec4f(toGammaSpaceVec3(refractionColor.rgb),refractionColor.a);\n#endif\nrefractionColor=vec4f(refractionColor.rgb*uniforms.vRefractionInfos.x,refractionColor.a);\n#endif\nvar reflectionColor: vec4f= vec4f(0.,0.,0.,1.);\n#ifdef REFLECTION\nvar vReflectionUVW: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW=vec3f(vReflectionUVW.x,vReflectionUVW.y,vReflectionUVW.z*-1.0);\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nvar bias: f32=uniforms.vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureSampleLevel(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureSample(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW);\n#endif\n#else\nvar coords: vec2f=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;reflectionColor=textureSample(reflection2DSampler,reflection2DSamplerSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor=vec4f(fromRGBD(reflectionColor),reflectionColor.a);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor=vec4f(toGammaSpaceVec3(reflectionColor.rgb),reflectionColor.a);\n#endif\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);\n#ifdef REFLECTIONFRESNEL\nvar reflectionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.reflectionRightColor.a,uniforms.reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor=vec4f(reflectionColor.rgb*specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);\n#else\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);\n#endif\n#else\nreflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nvar refractionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.refractionRightColor.a,uniforms.refractionLeftColor.a);refractionColor=vec4f(refractionColor.rgb*uniforms.refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*uniforms.refractionRightColor.rgb,refractionColor.a);\n#endif\n#ifdef OPACITY\nvar opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* uniforms.vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*uniforms.vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=fragmentInputs.vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nvar opacityFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.opacityParts.z,uniforms.opacityParts.w);alpha+=uniforms.opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*uniforms.opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<uniforms.alphaCutOff) {discard;}\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvar emissiveColor: vec3f=uniforms.vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb*uniforms.vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nvar emissiveFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.emissiveRightColor.a,uniforms.emissiveLeftColor.a);emissiveColor*=uniforms.emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*uniforms.emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nvar diffuseFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.diffuseRightColor.a,uniforms.diffuseLeftColor.a);diffuseBase*=uniforms.diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*uniforms.diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvar finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvar finalDiffuse: vec3f=clamp((diffuseBase+emissiveColor)*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#else\nvar finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+emissiveColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvar finalSpecular: vec3f=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular, vec3f(0.3,0.59,0.11)),0.0,1.0);\n#endif\n#else\nvar finalSpecular: vec3f= vec3f(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb, vec3f(0.3,0.59,0.11)),0.0,1.0);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvar color: vec4f= vec4f(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvar color: vec4f= vec4f(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor=vec4f(color.rgb*lightmapColor.rgb,color.a);\n#else\ncolor=vec4f(color.rgb+lightmapColor.rgb,color.a);\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor=vec4f(max(color.rgb,vec3f(0.)),color.a);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor=vec4f(toLinearSpaceVec3(color.rgb),color.a);\n#else\n#ifdef IMAGEPROCESSING\ncolor=vec4f(toLinearSpaceVec3(color.rgb),color.a);color=applyImageProcessing(color);\n#endif\n#endif\ncolor=vec4f(color.rgb,color.a*mesh.visibility);\n#ifdef PREMULTIPLYALPHA\ncolor=vec4f(color.rgb*color.a, color.a);\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nvar writeGeometryInfo: f32=select(0.0,1.0,color.a>0.4);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;\n#ifdef PREPASS_COLOR\nfragData[PREPASS_COLOR_INDEX]=color; \n#endif\n#ifdef PREPASS_POSITION\nfragData[PREPASS_POSITION_INDEX]=vec4f(fragmentInputs.vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_LOCAL_POSITION\nfragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvar a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);\n#elif defined(PREPASS_VELOCITY_LINEAR)\nvar velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -\n(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\nfragData[PREPASS_IRRADIANCE_INDEX]=vec4f(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\nfragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_SCREENSPACE_DEPTH\nfragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);\n#else\nfragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);\n#endif\n#endif\n#ifdef PREPASS_WORLD_NORMAL\nfragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO\nfragData[PREPASS_ALBEDO_INDEX]=vec4f(baseColor.rgb,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nfragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqrt(baseColor.rgb),writeGeometryInfo);\n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULAR)\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec4(specularMapColor))*writeGeometryInfo; \n#else\nfragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec3(specularColor),1.0)*writeGeometryInfo;\n#endif\n#endif\n#if SCENE_MRT_COUNT>0\nfragmentOutputs.fragData0=fragData[0];\n#endif\n#if SCENE_MRT_COUNT>1\nfragmentOutputs.fragData1=fragData[1];\n#endif\n#if SCENE_MRT_COUNT>2\nfragmentOutputs.fragData2=fragData[2];\n#endif\n#if SCENE_MRT_COUNT>3\nfragmentOutputs.fragData3=fragData[3];\n#endif\n#if SCENE_MRT_COUNT>4\nfragmentOutputs.fragData4=fragData[4];\n#endif\n#if SCENE_MRT_COUNT>5\nfragmentOutputs.fragData5=fragData[5];\n#endif\n#if SCENE_MRT_COUNT>6\nfragmentOutputs.fragData6=fragData[6];\n#endif\n#if SCENE_MRT_COUNT>7\nfragmentOutputs.fragData7=fragData[7];\n#endif\n#endif\n#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)\nfragmentOutputs.color=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+color.rgb*color.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-color.a));} else {fragmentOutputs.backColor+=color;}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i.a.ShadersStoreWGSL.defaultPixelShader=r;const s={name:"defaultPixelShader",shader:r}},function(e,t,n){"use strict";function i(e){return Math.floor(e/8)}function r(e){return 1<<e%8}n.r(t),n.d(t,"OptimizeIndices",(function(){return a}));class s{get(e){if(e>=this.size)throw new RangeError("Bit index out of range");const t=i(e),n=r(e);return 0!=(this._byteArray[t]&n)}set(e,t){if(e>=this.size)throw new RangeError("Bit index out of range");const n=i(e),s=r(e);t?this._byteArray[n]|=s:this._byteArray[n]&=~s}constructor(e){this.size=e,this._byteArray=new Uint8Array(Math.ceil(this.size/8))}}function a(e){const t=[],n=e.length/3;for(let i=0;i<n;i++)t.push([e[3*i],e[3*i+1],e[3*i+2]]);const i=new Map;t.forEach((e,t)=>{e.forEach(e=>{let n=i.get(e);n||i.set(e,n=[]),n.push(t)})});const r=new s(n),a=[],o=e=>{const n=[e];for(;n.length>0;){const e=n.pop();r.get(e)||(r.set(e,!0),a.push(t[e]),t[e].forEach(e=>{const t=i.get(e);t&&t.forEach(e=>{r.get(e)||n.push(e)})}))}};for(let e=0;e<n;e++)r.get(e)||o(e);let l=0;a.forEach(t=>{e[l++]=t[0],e[l++]=t[1],e[l++]=t[2]})}},function(e,t,n){"use strict";n.r(t),n.d(t,"pbrVertexShader",(function(){return s}));var i=n(66);n(444);i.a.IncludesShadersStore.pbrVertexDeclaration="uniform mat4 view;uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;\n#endif\n#ifdef BASEWEIGHT\nuniform mat4 baseWeightMatrix;uniform vec2 vBaseWeightInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;\n#endif\n#ifdef METALLIC_REFLECTANCE\nuniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;\n#endif\n#ifdef REFLECTANCE\nuniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#ifdef IRIDESCENCE\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\nuniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;\n#endif\n#endif\n#ifdef NORMAL\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n",n(483),n(446),n(370),n(323),n(344),n(345),n(379),n(447),n(448),n(484),n(449),n(348),n(450),n(451),n(452),n(346),n(347),n(371),n(349),n(350),n(351),n(352),n(353),n(453),n(454),n(455),n(456),n(354),n(457),n(458),n(459),n(460);const r="#define CUSTOM_VERTEX_EXTENSION\nprecision highp float;\n#include<__decl__pbrVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)\n#endif\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#ifdef VERTEXCOLOR\nvec4 colorUpdated=color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvClipSpacePosition=gl_Position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2Updated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BASEWEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";i.a.ShadersStore.pbrVertexShader=r;const s={name:"pbrVertexShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"kernelBlurVertexShaderWGSL",(function(){return s}));var i=n(66);n(409);i.a.IncludesShadersStoreWGSL.kernelBlurVertex="vertexOutputs.sampleCoord{X}=vertexOutputs.sampleCenter+uniforms.delta*KERNEL_OFFSET{X};";const r="attribute position: vec2f;uniform delta: vec2f;varying sampleCenter: vec2f;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.sampleCenter=(input.position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\nvertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i.a.ShadersStoreWGSL.kernelBlurVertexShader=r;const s={name:"kernelBlurVertexShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"kernelBlurVertexShader",(function(){return s}));var i=n(66);n(410);i.a.IncludesShadersStore.kernelBlurVertex="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";const r="attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i.a.ShadersStore.kernelBlurVertexShader=r;const s={name:"kernelBlurVertexShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"defaultVertexShaderWGSL",(function(){return s}));var i=n(66);n(411),n(412),n(322),n(357),n(358),n(385),n(413),n(368),n(414),n(415),n(361),n(416);i.a.IncludesShadersStoreWGSL.lightVxFragmentDeclaration="#ifdef LIGHT{X}\nuniform vLightData{X}: vec4f;uniform vLightDiffuse{X}: vec4f;\n#ifdef SPECULARTERM\nuniform vLightSpecular{X}: vec4f;\n#else\nvar vLightSpecular{X}: vec4f= vec4f(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform lightMatrix{X}: mat4x4f[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromLight{X}: vec4f[SHADOWCSMNUM_CASCADES{X}];varying var vDepthMetric{X}: f32[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromCamera{X}: vec4f;\n#elif defined(SHADOWCUBE{X})\n#else\nvarying var vPositionFromLight{X}: vec4f;varying var vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;\n#endif\nuniform shadowsInfo{X}: vec4f;uniform depthValues{X}: vec2f;\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vLightDirection{X}: vec4f;uniform vLightFalloff{X}: vec4f;\n#elif defined(POINTLIGHT{X})\nuniform vLightFalloff{X}: vec4f;\n#elif defined(HEMILIGHT{X})\nuniform vLightGround{X}: vec3f;\n#endif\n#if defined(AREALIGHT{X})\nuniform vLightWidth{X}: vec4f;uniform vLightHeight{X}: vec4f;\n#endif\n#endif\n",n(417),n(359),n(360),n(369),n(362),n(363),n(364),n(365),n(366),n(418),n(419),n(420),n(421),n(367),n(422),n(423),n(424),n(425);const r="#include<defaultUboDeclaration>\n#define CUSTOM_VERTEX_BEGIN\nattribute position: vec3f;\n#ifdef NORMAL\nattribute normal: vec3f;\n#endif\n#ifdef TANGENT\nattribute tangent: vec4f;\n#endif\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute color: vec4f;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\nvarying vPositionW: vec3f;\n#ifdef NORMAL\nvarying vNormalW: vec3f;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vColor: vec4f;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vPositionUVW: vec3f;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vDirectionW: vec3f;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar positionUpdated: vec3f=vertexInputs.position;\n#ifdef NORMAL\nvar normalUpdated: vec3f=vertexInputs.normal;\n#endif\n#ifdef TANGENT\nvar tangentUpdated: vec4f=vertexInputs.tangent;\n#endif\n#ifdef UV1\nvar uvUpdated: vec2f=vertexInputs.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=vertexInputs.uv2;\n#endif\n#ifdef VERTEXCOLOR\nvar colorUpdated: vec4f=vertexInputs.color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvertexOutputs.vPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld*vec4f(positionUpdated,1.0);\n#ifdef NORMAL\nvar normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}\n#else\nvertexOutputs.position=scene.viewProjection*worldPos;\n#endif\nvertexOutputs.vPositionW= worldPos.xyz;\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvertexOutputs.vDirectionW=normalize((finalWorld* vec4f(positionUpdated,0.0)).xyz);\n#endif\n#ifndef UV1\nvar uvUpdated: vec2f=vec2f(0.,0.);\n#endif\n#ifdef MAINUV1\nvertexOutputs.vMainUV1=uvUpdated;\n#endif\n#ifndef UV2\nvar uv2Updated: vec2f=vec2f(0.,0.);\n#endif\n#ifdef MAINUV2\nvertexOutputs.vMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";i.a.ShadersStoreWGSL.defaultVertexShader=r;const s={name:"defaultVertexShader",shader:r}},function(e,t,n){"use strict";n.r(t),n.d(t,"defaultVertexShader",(function(){return s}));var i=n(66);n(444);i.a.IncludesShadersStore.defaultVertexDeclaration="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nuniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;uniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform mat4 bumpMatrix;\n#endif\n#ifdef REFLECTION\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n",n(445),n(446),n(323),n(344),n(345),n(379),n(447),n(370),n(448),n(449),n(348),n(450),n(451),n(452),n(346),n(347),n(371),n(349),n(350),n(351),n(352),n(353),n(453),n(454),n(455),n(456),n(354),n(457),n(458),n(459),n(405),n(460);const r="#define CUSTOM_VERTEX_EXTENSION\n#include<__decl__defaultVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#ifdef VERTEXCOLOR\nvec4 colorUpdated=color;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\nvPositionW=vec3(worldPos);\n#ifdef PREPASS\n#include<prePassVertex>\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2Updated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2Updated;\n#endif\n#include<uvVariableDeclaration>[3..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";i.a.ShadersStore.defaultVertexShader=r;const s={name:"defaultVertexShader",shader:r}}])]);
//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/vendors.bundle.js.map/a679dd3bcd2aad7504c8a31a92aa49a6/vendors.bundle.js.map